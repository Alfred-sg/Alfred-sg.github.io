<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.2" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.2">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.2" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.0.2',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="analyst,react," />


<meta name="description" content="思想实验在开篇之初，我们先作一番思想实验。借助于形象化思维，通过类比的方式，那样会更容易理解 mobx 的实现。 视线折回到明代，水患侵扰了淳安县境，治理地方水务的官员把这情况上报给知县海瑞，海瑞又上报总督胡宗宪，而胡宗宪呢，他派出快马，向京师呈报奏章，吁请内阁早日筹备赈灾的粮食。与此同时，东厂番子早已把眼线布满全国，不等内阁向嘉靖奏报，嘉靖早已知晓了千里之外的动向。当我们把这环节牵涉到的各级官员">
<meta name="keywords" content="analyst,react">
<meta property="og:type" content="article">
<meta property="og:title" content="mobx源码分析">
<meta property="og:url" content="http://yoursite.com/2018/07/15/react/react相关/mobx源码分析/index.html">
<meta property="og:site_name" content="修子范语">
<meta property="og:description" content="思想实验在开篇之初，我们先作一番思想实验。借助于形象化思维，通过类比的方式，那样会更容易理解 mobx 的实现。 视线折回到明代，水患侵扰了淳安县境，治理地方水务的官员把这情况上报给知县海瑞，海瑞又上报总督胡宗宪，而胡宗宪呢，他派出快马，向京师呈报奏章，吁请内阁早日筹备赈灾的粮食。与此同时，东厂番子早已把眼线布满全国，不等内阁向嘉靖奏报，嘉靖早已知晓了千里之外的动向。当我们把这环节牵涉到的各级官员">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/2018/07/15/react/react相关/mobx源码分析/monitor.png">
<meta property="og:image" content="http://yoursite.com/2018/07/15/react/react相关/mobx源码分析/mobx-monitor.png">
<meta property="og:image" content="http://yoursite.com/2018/07/15/react/react相关/mobx源码分析/observable-object-admin.png">
<meta property="og:updated_time" content="2018-07-18T16:12:57.777Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="mobx源码分析">
<meta name="twitter:description" content="思想实验在开篇之初，我们先作一番思想实验。借助于形象化思维，通过类比的方式，那样会更容易理解 mobx 的实现。 视线折回到明代，水患侵扰了淳安县境，治理地方水务的官员把这情况上报给知县海瑞，海瑞又上报总督胡宗宪，而胡宗宪呢，他派出快马，向京师呈报奏章，吁请内阁早日筹备赈灾的粮食。与此同时，东厂番子早已把眼线布满全国，不等内阁向嘉靖奏报，嘉靖早已知晓了千里之外的动向。当我们把这环节牵涉到的各级官员">
<meta name="twitter:image" content="http://yoursite.com/2018/07/15/react/react相关/mobx源码分析/monitor.png">






  <link rel="canonical" href="http://yoursite.com/2018/07/15/react/react相关/mobx源码分析/"/>


  <title>mobx源码分析 | 修子范语</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">修子范语</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Alfredo's Notes</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
        </li>
      

      
    </ul>
  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/15/react/react相关/mobx源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">mobx源码分析</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-15T00:00:00+08:00">2018-07-15</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/状态管理/" itemprop="url" rel="index"><span itemprop="name">状态管理</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/15/react/react相关/mobx源码分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/07/15/react/react相关/mobx源码分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="思想实验"><a href="#思想实验" class="headerlink" title="思想实验"></a>思想实验</h2><p>在开篇之初，我们先作一番思想实验。借助于形象化思维，通过类比的方式，那样会更容易理解 mobx 的实现。</p>
<p>视线折回到明代，水患侵扰了淳安县境，治理地方水务的官员把这情况上报给知县海瑞，海瑞又上报总督胡宗宪，而胡宗宪呢，他派出快马，向京师呈报奏章，吁请内阁早日筹备赈灾的粮食。与此同时，东厂番子早已把眼线布满全国，不等内阁向嘉靖奏报，嘉靖早已知晓了千里之外的动向。当我们把这环节牵涉到的各级官员设想为收发消息的节点，再把东厂番子设想为全局的监听器，我们就可以据此绘出一张图谱。</p>
<p><em>图 1，明代行政流程图抽象</em><br><img src="/2018/07/15/react/react相关/mobx源码分析/monitor.png"></p>
<p>即如图谱中所见，node 负责接收消息 message，触发相应的动作 listener，再把消息传递给上层节点的同时，又会把消息传递给全局监听器 monitor，由 monitor 触发 reaction 行为。reaction 行为在现实表现中，往往是命令 node 节点再执行额外的动作，因此，在 node 节点向 monitor 呈报消息的时候，也会当前 node 节点的信息。</p>
<p>由此我们类比到 mobx 的实现，绘制的图谱就要相应修正为如下形式：</p>
<p><em>图 2，mobx 工作流程</em><br><img src="/2018/07/15/react/react相关/mobx源码分析/mobx-monitor.png"></p>
<p>上图中，观察对象 observable 身兼一种能力，即在数据变更前，会触发 interceptor 拦截函数的执行；在数据变更后，会触发 listener 监听函数的执行，同时将数据变更的信息上报给全局监听器。在全局监听器中，startBatch, endBatch 用于开启、结束事务，事务执行过程中，重新计算数据变更影响了哪些观察者 observer，在事务的尾端，执行这些观察者的实际处理逻辑。</p>
<p>通过 mobx 的工作流程，我们需要探索的问题是：</p>
<ol>
<li>怎样将数据转变成 observable？当数据变更时，observable 又怎样驱动 interceptor, listener 的执行，并上报给全局监听器？</li>
<li>怎样使 observer 和 observable 相互关联，在数据变更的时候，使得相应的观察者 observer 执行其处理逻辑？</li>
</ol>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>本节将环绕上一节给出的问题，一一予以解答。</p>
<h3 id="observable"><a href="#observable" class="headerlink" title="observable"></a>observable</h3><p>如果数据赋值这一动作通过函数表达，我们可以借助 AOP 编程思想，在该函数的执行过程中，添加一些副作用操作，如上报数据的变更信息、启用回调函数、或者触发指定的事件等。正因为如此，Vue 得以通过 Object.defineProperty 方法实现双向数据绑定，该方法能将属性的赋值操作转变为 setter 函数的执行；而 React 则提供 setState 方法既负责改变组件的 state 属性，又负责引发组件的重绘机制。mobx 融合了两种处理手法，其将数据转变成 observable 实例，并通过 observable.set 方法驱动 interceptor, listener 的执行，这一过程譬如 React 中的 setState 方法；而其在对象的赋值操作中调用 observable.set，取值操作中调用 observable.get 方法以获得原始数据，这一过程也像 Vue 那样使用了 Object.defineProperty 方法。</p>
<p>mobx 能将如下几种数据类型转变为 observable 实例：ObservableValue 构造函数用于将基本数据类型转化为 observable 实例；ObservableObjectAdministration 用于处理对象；ObservableObjectAdministration 用于处理数组；ObservableMap 用于处理 map 数据结构。</p>
<h4 id="ObservableValue"><a href="#ObservableValue" class="headerlink" title="ObservableValue"></a>ObservableValue</h4><p><em>代码段 1，ObservableValue 方法</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">public set(newValue: T) &#123;</span><br><span class="line">  <span class="keyword">const</span> oldValue = <span class="keyword">this</span>.value</span><br><span class="line">  newValue = <span class="keyword">this</span>.prepareNewValue(newValue) <span class="keyword">as</span> any</span><br><span class="line">  <span class="keyword">if</span> (newValue !== UNCHANGED) &#123;</span><br><span class="line">    <span class="keyword">const</span> notifySpy = isSpyEnabled()</span><br><span class="line">    <span class="keyword">if</span> (notifySpy &amp;&amp; process.env.NODE_ENV !== <span class="string">"production"</span>) &#123;</span><br><span class="line">        spyReportStart(&#123;</span><br><span class="line">            type: <span class="string">"update"</span>,</span><br><span class="line">            name: <span class="keyword">this</span>.name,</span><br><span class="line">            newValue,</span><br><span class="line">            oldValue</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.setNewValue(newValue)</span><br><span class="line">    <span class="keyword">if</span> (notifySpy &amp;&amp; process.env.NODE_ENV !== <span class="string">"production"</span>) spyReportEnd()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private prepareNewValue(newValue): T | IUNCHANGED &#123;</span><br><span class="line">  <span class="comment">// 计算属性获取过程不允许变更响应式数据，严格模式下只能通过 action 改变响应式数据（即状态）</span></span><br><span class="line">  checkIfStateModificationsAreAllowed(<span class="keyword">this</span>)</span><br><span class="line">  <span class="keyword">if</span> (hasInterceptors(<span class="keyword">this</span>)) &#123;</span><br><span class="line">      <span class="keyword">const</span> change = interceptChange&lt;IValueWillChange&lt;T&gt;&gt;(<span class="keyword">this</span>, &#123;</span><br><span class="line">          object: <span class="keyword">this</span>,</span><br><span class="line">          type: <span class="string">"update"</span>,</span><br><span class="line">          newValue</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="keyword">if</span> (!change) <span class="keyword">return</span> UNCHANGED</span><br><span class="line">      newValue = change.newValue</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// apply modifier</span></span><br><span class="line">  newValue = <span class="keyword">this</span>.enhancer(newValue, <span class="keyword">this</span>.value, <span class="keyword">this</span>.name)</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.value !== newValue ? newValue : UNCHANGED</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setNewValue(newValue: T) &#123;</span><br><span class="line">  <span class="keyword">const</span> oldValue = <span class="keyword">this</span>.value</span><br><span class="line">  <span class="keyword">this</span>.value = newValue</span><br><span class="line">  <span class="keyword">this</span>.reportChanged()</span><br><span class="line">  <span class="keyword">if</span> (hasListeners(<span class="keyword">this</span>)) &#123;</span><br><span class="line">    notifyListeners(<span class="keyword">this</span>, &#123;</span><br><span class="line">        type: <span class="string">"update"</span>,</span><br><span class="line">        object: <span class="keyword">this</span>,</span><br><span class="line">        newValue,</span><br><span class="line">        oldValue</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public get(): T &#123;</span><br><span class="line">  <span class="keyword">this</span>.reportObserved()</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.dehanceValue(<span class="keyword">this</span>.value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从以上代码中，我们也能看出，基本数据类型经由 ObservableValue(value, enhancer, name, notifySpy) 构造函数转变成 ObservableValue 实例后，其 set 方法主要有四种职能：在数据变更前后通知 spyListener 执行（通常用于日志处理）；校验数据变更的合法性，包含计算属性内不允许作数据变更，以及globalState.allowStateChanges 为否值时，不允许在 action 外作数据变更；数据变更前，执行 interceptor 拦截器处理函数，拦截器可用于打断数据变更；在数据变更后，通过 this.reportChanged 方法将数据变更信息上报给全局监听器，并触发 listener 回调的执行。</p>
<p>其中，interceptor 拦截器、listener 监听函数均挂载为当前 observer 实例的属性，因此，在 interceptChange, notifyListeners 函数执行期间，可通过 observer 实例查找到相应的 interceptor 拦截器、listener 监听函数。</p>
<p>在 mobx 实现中，全局观察者 observer 将以引用对象形式持有其所观察的 observable 实例。这样，当 observable 实例发生数据更新时，就可以通过脏标识标记 observer 需要启动其处理逻辑。因此，this.reportChanged 方法无需像 interceptChange, notifyListeners 函数那样以 observable 实例作为入参。</p>
<p>对于 this.enhancer 方法的内部逻辑，我们将暂时不作讨论。只是我们需要设问，当被观察的数据从基本数据类型变更成对象时，如何通过其子属性的赋值操作，驱动挂载在当前 observable 实例上的 interceptor 拦截器、listener 监听函数执行呢？</p>
<h3 id="ObservableObjectAdministration"><a href="#ObservableObjectAdministration" class="headerlink" title="ObservableObjectAdministration"></a>ObservableObjectAdministration</h3><p>不同于基本数据类型的全量更新，对象一次只更新部分数据，即一个属性。因此，ObservableValue 实例与原始数据 value 关系较为直接，其 set, get 方法用于代理原始数据的赋值、取值动作。ObservableObjectAdministration 实例和原始数据 target 的关系则要复杂的多，其所提供的 read, write, addObservableProp, addComputedProp 都在属性级别。顾名思义，read, write 方法即是对属性的取值、赋值操作，addObservableProp 添加可观察属性，addComputedProp 添加计算属性。</p>
<p>与 ObservableValue 处理的另一个差别是，构造的 ObservableValue 实例并不会施影响于原始数据 value，只能通过直接调用 observableValue.set 方法唤起 interceptor, listener 的执行。但是，ObservableObjectAdministration 实例会影响原始数据 target。通过 Object.defineProperty 方法，对 target 属性的取值和赋值，都会转交给 observableObjectAdministration.read, observableObjectAdministration.write 方法去处理，从而使 target 属性的赋值动作变成响应式。</p>
<p>ObservableObjectAdministration 的实现内部，仰赖于 ObservableValue, ComputedValue 构造函数，因为其子属性既可能是 ObservableValue 可观察数据，ComputedValue 待计算数据，又可能是普通数据。ObservableObjectAdministration 实例和 ComputedValue 实例的关系，我们将在下文进行讨论。同样不作讨论的是 ObservableObjectAdministration 实例的 pendingKeys 属性。</p>
<p><em>代码段 2，ObservableObjectAdministration 方法</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line">read(key: string) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.values.get(key)!.get()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">write(key: string, newValue) &#123;</span><br><span class="line">  <span class="keyword">const</span> instance = <span class="keyword">this</span>.target</span><br><span class="line">  <span class="keyword">const</span> observable = <span class="keyword">this</span>.values.get(key)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (hasInterceptors(<span class="keyword">this</span>)) &#123;</span><br><span class="line">    <span class="keyword">const</span> change = interceptChange&lt;IObjectWillChange&gt;(<span class="keyword">this</span>, &#123;</span><br><span class="line">      type: <span class="string">"update"</span>,</span><br><span class="line">      object: <span class="keyword">this</span>.proxy || instance,</span><br><span class="line">      name: key,</span><br><span class="line">      newValue</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> (!change) <span class="keyword">return</span></span><br><span class="line">    newValue = (change <span class="keyword">as</span> any).newValue</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 触发 ObservableValue 实例的 interceptor 拦截器, enhance 获取终值</span></span><br><span class="line">  newValue = (observable <span class="keyword">as</span> any).prepareNewValue(newValue)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (newValue !== UNCHANGED) &#123;</span><br><span class="line">    <span class="keyword">const</span> notify = hasListeners(<span class="keyword">this</span>)</span><br><span class="line">    <span class="keyword">const</span> notifySpy = isSpyEnabled()</span><br><span class="line">    <span class="keyword">const</span> change =</span><br><span class="line">      notify || notifySpy</span><br><span class="line">        ? &#123;</span><br><span class="line">          type: <span class="string">"update"</span>,</span><br><span class="line">          object: <span class="keyword">this</span>.proxy || instance,</span><br><span class="line">          oldValue: (observable <span class="keyword">as</span> any).value,</span><br><span class="line">          name: key,</span><br><span class="line">          newValue</span><br><span class="line">        &#125;</span><br><span class="line">        : <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (notifySpy &amp;&amp; process.env.NODE_ENV !== <span class="string">"production"</span>)</span><br><span class="line">      spyReportStart(&#123; ...change, <span class="attr">name</span>: <span class="keyword">this</span>.name, key &#125;)</span><br><span class="line">        <span class="comment">// 触发 ObservableValue 实例的 listener 订阅函数</span></span><br><span class="line">        ; (observable <span class="keyword">as</span> ObservableValue&lt;any&gt;).setNewValue(newValue)</span><br><span class="line">    <span class="keyword">if</span> (notify) notifyListeners(<span class="keyword">this</span>, change)</span><br><span class="line">    <span class="keyword">if</span> (notifySpy &amp;&amp; process.env.NODE_ENV !== <span class="string">"production"</span>) spyReportEnd()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">addObservableProp(propName: string, newValue, <span class="attr">enhancer</span>: IEnhancer&lt;any&gt; = <span class="keyword">this</span>.defaultEnhancer) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; target &#125; = <span class="keyword">this</span></span><br><span class="line">  <span class="comment">// 校验 target 对象 propName 是否具有 configurable, writable 可能</span></span><br><span class="line">  assertPropertyConfigurable(target, propName)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (hasInterceptors(<span class="keyword">this</span>)) &#123;</span><br><span class="line">    <span class="keyword">const</span> change = interceptChange&lt;IObjectWillChange&gt;(<span class="keyword">this</span>, &#123;</span><br><span class="line">      object: <span class="keyword">this</span>.proxy || target,</span><br><span class="line">      name: propName,</span><br><span class="line">      type: <span class="string">"add"</span>,</span><br><span class="line">      newValue</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> (!change) <span class="keyword">return</span></span><br><span class="line">    newValue = (change <span class="keyword">as</span> any).newValue</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> observable = <span class="keyword">new</span> ObservableValue(</span><br><span class="line">    newValue,</span><br><span class="line">    enhancer,</span><br><span class="line">    <span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span>.<span class="subst">$&#123;propName&#125;</span>`</span>,</span><br><span class="line">    <span class="literal">false</span></span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">this</span>.values.set(propName, observable)</span><br><span class="line">  newValue = (observable <span class="keyword">as</span> any).value <span class="comment">// observableValue might have changed it</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(target, propName, generateObservablePropConfig(propName))</span><br><span class="line">  <span class="keyword">this</span>.notifyPropertyAddition(propName, newValue)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">notifyPropertyAddition(key: string, newValue) &#123;</span><br><span class="line">  <span class="keyword">const</span> notify = hasListeners(<span class="keyword">this</span>)</span><br><span class="line">  <span class="keyword">const</span> notifySpy = isSpyEnabled()</span><br><span class="line">  <span class="keyword">const</span> change =</span><br><span class="line">    notify || notifySpy</span><br><span class="line">      ? &#123;</span><br><span class="line">        type: <span class="string">"add"</span>,</span><br><span class="line">        object: <span class="keyword">this</span>.proxy || <span class="keyword">this</span>.target,</span><br><span class="line">        name: key,</span><br><span class="line">        newValue</span><br><span class="line">      &#125;</span><br><span class="line">      : <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (notifySpy &amp;&amp; process.env.NODE_ENV !== <span class="string">"production"</span>)</span><br><span class="line">    spyReportStart(&#123; ...change, <span class="attr">name</span>: <span class="keyword">this</span>.name, key &#125;)</span><br><span class="line">  <span class="keyword">if</span> (notify) notifyListeners(<span class="keyword">this</span>, change)</span><br><span class="line">  <span class="keyword">if</span> (notifySpy &amp;&amp; process.env.NODE_ENV !== <span class="string">"production"</span>) spyReportEnd()</span><br><span class="line">  <span class="keyword">this</span>.keysAtom.reportChanged()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><em>图 3，ObservableObjectAdministration 工作流程</em><br><img src="/2018/07/15/react/react相关/mobx源码分析/observable-object-admin.png"></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/analyst/" rel="tag"># analyst</a>
          
            <a href="/tags/react/" rel="tag"># react</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/07/08/react/react相关/react-redux源码分析/" rel="next" title="react-redux源码分析">
                <i class="fa fa-chevron-left"></i> react-redux源码分析
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpeg"
                alt="Alfred" />
            
              <p class="site-author-name" itemprop="name">Alfred</p>
              <p class="site-description motion-element" itemprop="description">人苦不知足，既得陇，复望蜀</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">25</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    <span class="site-state-item-count">15</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    <span class="site-state-item-count">16</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Alfred-sg" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/xiu-fan-79/activities" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-globe"></i>知乎</a>
                  </span>
                
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#思想实验"><span class="nav-number">1.</span> <span class="nav-text">思想实验</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#实现"><span class="nav-number">2.</span> <span class="nav-text">实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#observable"><span class="nav-number">2.1.</span> <span class="nav-text">observable</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#ObservableValue"><span class="nav-number">2.1.1.</span> <span class="nav-text">ObservableValue</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ObservableObjectAdministration"><span class="nav-number">2.2.</span> <span class="nav-text">ObservableObjectAdministration</span></a></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Alfred</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Pisces</a> v6.0.2</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.0.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.0.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.0.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.2"></script>



  

  
    <script id="dsq-count-scr" src="https://alfred.disqus.com/count.js" async></script>
  

  
    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = 'http://yoursite.com/2018/07/15/react/react相关/mobx源码分析/';
        this.page.identifier = '2018/07/15/react/react相关/mobx源码分析/';
        this.page.title = 'mobx源码分析';
      };
      function loadComments () {
        var d = document, s = d.createElement('script');
        s.src = 'https://alfred.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      }
      
        loadComments();
      
    </script>
  





	





  












  





  

  

  

  

  
  

  

  

  

  

</body>
</html>
