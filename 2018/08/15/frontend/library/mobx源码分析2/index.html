<!DOCTYPE html>
<html>
<head><meta name="generator" content="Hexo 3.8.0">
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="utf-8">

    

    
    <title>mobx源码分析（二） 订阅响应式数据 | 修子范语</title>
    
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    
    <meta name="keywords" content="analyst,react">
    
    <meta name="description" content="前言处理问题有两种方式，从一般到具体，或者从具体到一般。在写作这两篇文章时，我选择了后者，一是因为我在写作这篇文章的过程中才逐渐摸清 mobx 的设计和实现，二是因为我自身尚不具备足够的积淀，能站在更高的抽象维度对问题的一般面加以思索。上一篇文章对各种数据结构的处理无疑都是具体的，本文将介入如何抽象 observable，即对上一篇文章中的公有特征 reportObserved, reportCh">
<meta name="keywords" content="analyst,react">
<meta property="og:type" content="article">
<meta property="og:title" content="mobx源码分析（二） 订阅响应式数据">
<meta property="og:url" content="http://xzfyu.com/2018/08/15/frontend/library/mobx源码分析2/index.html">
<meta property="og:site_name" content="修子范语">
<meta property="og:description" content="前言处理问题有两种方式，从一般到具体，或者从具体到一般。在写作这两篇文章时，我选择了后者，一是因为我在写作这篇文章的过程中才逐渐摸清 mobx 的设计和实现，二是因为我自身尚不具备足够的积淀，能站在更高的抽象维度对问题的一般面加以思索。上一篇文章对各种数据结构的处理无疑都是具体的，本文将介入如何抽象 observable，即对上一篇文章中的公有特征 reportObserved, reportCh">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://xzfyu.com/2018/08/15/frontend/library/mobx源码分析2/core.png">
<meta property="og:updated_time" content="2020-03-08T10:45:48.826Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="mobx源码分析（二） 订阅响应式数据">
<meta name="twitter:description" content="前言处理问题有两种方式，从一般到具体，或者从具体到一般。在写作这两篇文章时，我选择了后者，一是因为我在写作这篇文章的过程中才逐渐摸清 mobx 的设计和实现，二是因为我自身尚不具备足够的积淀，能站在更高的抽象维度对问题的一般面加以思索。上一篇文章对各种数据结构的处理无疑都是具体的，本文将介入如何抽象 observable，即对上一篇文章中的公有特征 reportObserved, reportCh">
<meta name="twitter:image" content="http://xzfyu.com/2018/08/15/frontend/library/mobx源码分析2/core.png">
    

    

    

    <link rel="stylesheet" href="/libs/font-awesome/css/font-awesome.min.css">
    <link rel="stylesheet" href="/libs/titillium-web/styles.css">
    <link rel="stylesheet" href="/libs/source-code-pro/styles.css">

    <link rel="stylesheet" href="/css/style.css">

    <script src="/libs/jquery/3.4.1/jquery.min.js"></script>
    
    
        <link rel="stylesheet" href="/libs/lightgallery/css/lightgallery.min.css">
    
    
        <link rel="stylesheet" href="/libs/justified-gallery/justifiedGallery.min.css"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
    
    
    


</head>
</html>
<body>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="wrap">
        <header id="header">
    <div id="header-outer" class="outer">
        <div class="container">
            <div class="container-inner">
                <div id="header-title">
                    <h1 class="logo-wrap">
                        <a href="/" class="logo"></a>
                    </h1>
                    
                        <h2 class="subtitle-wrap">
                            <p class="subtitle">Alfredo&#39;s Notes</p>
                        </h2>
                    
                </div>
                <div id="header-inner" class="nav-container">
                    <a id="main-nav-toggle" class="nav-icon fa fa-bars"></a>
                    <div class="nav-container-inner">
                        <ul id="main-nav">
                            
                                <li class="main-nav-list-item">
                                    <a class="main-nav-list-link" href="/">主页</a>
                                </li>
                            
                                        <ul class="main-nav-list"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/backend/">backend</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/backend/java/">java</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/backend/java-工程/">java 工程</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/backend/spring/">spring</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/backend/web-服务/">web 服务</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/backend/其他/">其他</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/backend/异步消息/">异步消息</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/backend/数据库技术/">数据库技术</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/backend/架构/">架构</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/backend/缓存/">缓存</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/backend/远程通信/">远程通信</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/backend/部署/">部署</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/frontend/">frontend</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/frontend/antd/">antd</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/frontend/architecture/">architecture</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/frontend/css/">css</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/frontend/editor/">editor</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/frontend/es/">es</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/frontend/guide/">guide</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/frontend/js/">js</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/frontend/library/">library</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/frontend/react/">react</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/frontend/vue/">vue</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/frontend/webpack/">webpack</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/frontend/前端工程化/">前端工程化</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/数据技术/">数据技术</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/数据技术/sql/">sql</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/数据技术/大数据/">大数据</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/数据技术/读书笔记/">读书笔记</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/计算机科学/">计算机科学</a><ul class="main-nav-list-child"><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/计算机科学/操作系统/">操作系统</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/计算机科学/算法/">算法</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/计算机科学/设计模式/">设计模式</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/计算机科学/软件工程/">软件工程</a></li></ul></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/读书笔记/">读书笔记</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/踩坑/">踩坑</a></li><li class="main-nav-list-item"><a class="main-nav-list-link" href="/categories/随笔/">随笔</a></li></ul>
                                    
                                <li class="main-nav-list-item">
                                    <a class="main-nav-list-link" href="/about/index.html">关于</a>
                                </li>
                            
                        </ul>
                        <nav id="sub-nav">
                            <div id="search-form-wrap">

    <form class="search-form">
        <input type="text" class="ins-search-input search-form-input" placeholder="搜索">
        <button type="submit" class="search-form-submit"></button>
    </form>
    <div class="ins-search">
    <div class="ins-search-mask"></div>
    <div class="ins-search-container">
        <div class="ins-input-wrapper">
            <input type="text" class="ins-search-input" placeholder="想要查找什么...">
            <span class="ins-close ins-selectable"><i class="fa fa-times-circle"></i></span>
        </div>
        <div class="ins-section-wrapper">
            <div class="ins-section-container"></div>
        </div>
    </div>
</div>
<script>
(function (window) {
    var INSIGHT_CONFIG = {
        TRANSLATION: {
            POSTS: '文章',
            PAGES: '页面',
            CATEGORIES: '分类',
            TAGS: '标签',
            UNTITLED: '(未命名)',
        },
        ROOT_URL: '/',
        CONTENT_URL: '/content.json',
    };
    window.INSIGHT_CONFIG = INSIGHT_CONFIG;
})(window);
</script>
<script src="/js/insight.js"></script>

</div>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</header>
        <div class="container">
            <div class="main-body container-inner">
                <div class="main-body-inner">
                    <section id="main">
                        <div class="main-body-header">
    <h1 class="header">
    
    <a class="page-title-link" href="/categories/frontend/">frontend</a><i class="icon fa fa-angle-right"></i><a class="page-title-link" href="/categories/frontend/library/">library</a>
    </h1>
</div>

                        <div class="main-body-content">
                            <article id="post-frontend/library/mobx源码分析2" class="article article-single article-type-post" itemscope itemprop="blogPost">
    <div class="article-inner">
        
            <header class="article-header">
                
    
        <h1 class="article-title" itemprop="name">
        mobx源码分析（二） 订阅响应式数据
        </h1>
    

            </header>
        
        
            <div class="article-meta">
                
    <div class="article-date">
      <i class="fa fa-calendar"></i>
      <a href="/2018/08/15/frontend/library/mobx源码分析2/" class="article-date">
         <time datetime="2018-08-14T16:00:00.000Z" itemprop="datePublished">2018-08-15</time>
      </a>
    </div>


                

                
    <div class="article-tag">
        <i class="fa fa-tag"></i>
        <a class="tag-link" href="/tags/analyst/">analyst</a>, <a class="tag-link" href="/tags/react/">react</a>
    </div>

                

                

            </div>
        
        
        <div class="article-entry" itemprop="articleBody">
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>处理问题有两种方式，从一般到具体，或者从具体到一般。在写作这两篇文章时，我选择了后者，一是因为我在写作这篇文章的过程中才逐渐摸清 mobx 的设计和实现，二是因为我自身尚不具备足够的积淀，能站在更高的抽象维度对问题的一般面加以思索。上一篇文章对各种数据结构的处理无疑都是具体的，本文将介入如何抽象 observable，即对上一篇文章中的公有特征 reportObserved, reportChanged 方法加以萃取。</p>
<p>本文也将致力于解答上一篇文章遗留的问题，怎样使观察者订阅响应式数据的变更。</p>
<p>总而言之，本文将串联 mobx 的核心运作机制，从执行动作 action 促使响应式数据 observable 变更，到响应式数据变更引起衍生 derivation 执行的一整个过程。</p>
<h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>首先，我们先来看一下 mobx 设计的几种抽象概念：</p>
<ol>
<li>observable: 响应式数据，最主要的特征是将数据变更信息上报给全局监听器。mobx 使用 IObservable 接口，Atom 类加以抽象。</li>
<li>derivation: 衍生，响应式数据变更后执行的副作用函数，包含计算属性、反应。mobx 使用 IDerivation 接口，ComputedValue 类、Reaction 类加以抽象。</li>
<li>action: 动作，由其促使响应式数据发生变更。上一节已指出，使用 observableValue 实例的 set 方法，就能促使响应式数据发生变更，action 的意义在于，使用 startBatch, endBatch 事务发生执行动作，能整合一组响应式数据变更，在这一组响应式数据变更完成后，再执行 derivation 衍生。在 mobx 中，action 是很轻的一层，因为将响应式数据变更上报到全局环境由 observable 完成，action 中的逻辑处理即是在动作执行期间使用事务加以包裹，并根据配置项判断响应式数据只能在 action 中完成。在这篇文章中将不作赘述。</li>
</ol>
<p><em>图 1，observable, derivation 类图</em><br><img src="/2018/08/15/frontend/library/mobx源码分析2/core.png"></p>
<h3 id="observable"><a href="#observable" class="headerlink" title="observable"></a>observable</h3><p>对于 observable，所需考虑的是，响应式数据变更会引起指定的观察者执行其处理逻辑；当响应式数据没有指定观察者时，数据变更就不会引起衍生的执行。为此，在 mobx 抽象的 IObservable 接口中，observers 属性为 observable 绑定的观察者队列；lowestObserverState 属性为状态标识，用于标记数据是否被更新，需要执行相应的衍生；diffValue 属性用于实时更新 observable, observer 的依赖关系。</p>
<p>此外，在 IObservable 接口中，mobx 还提供了 onBecameUnobservered, onBecameObservered 钩子，分别在 observable 不被监听或被监听时得到调用；lastAcessedBy（最后消费 observable 的观察者 id）, isBeingObserved 属性用于使 onBecameObservered 钩子不被反复调用；isPendingUnobservation 属性用于使 onBecameUnobservered 钩子不被反复执行。与配置项相当，属性需要通过翻阅源码中的逻辑实现，才能确切感知到该属性存在的价值。介于部分属性与核心流程无关，在这里将只作简要讨论或不作讨论。</p>
<p>Atom 类除了实现 IObservable 接口以外，额外新增了 reportObserved, reportChanged 方法。顾名思义，当 observable 被观察时，需要显示调用 reportObserved 方法；当 observable 数据变更时，需要显示调用 reportChanged 方法。更多内容，参见前文 - <a href="http://xzfyu.com/2018/08/03/react/react%E7%9B%B8%E5%85%B3/mobx%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%901/">mobx 源码分析（一）构造响应式数据</a>。</p>
<h3 id="derivation"><a href="#derivation" class="headerlink" title="derivation"></a>derivation</h3><p>derivation 可以理解为实际消费 observable 的观察者，因此，本文中的 observer 指代的也就是 derivation。在 mobx 实现中，observable, derivation 相互持有彼此的引用。IDerivation 接口的 observing 属性本次衍生在哪些响应式数据变更时执行；dependenciesState 属性为状态标识，用于标记本次衍生观察的数据是否已经改变，是否运行期处理逻辑；onBecomeStale 方法就是当观察数据变更时，运行的处理逻辑；newObserving 属性用于变更 observable, derivation 的依赖关系（在于观察者可改变观察的数据）；unboundDepsCount 属性用于统计本次衍生所观察的数据量，同 observable.diffValue 一样，目的都在于实时更新 observable, derivation 的依赖关系。</p>
<p>除了上述属性和方法，IDerivation 接口还提供了 runId 属性，由它构成 observable.lastAcessedBy 的值；isTracing 属性标记日志级别，以便在 onBecomeStale 方法执行前打印日志。</p>
<p>IDerivation 接口有两种实现，其一是作为反应的 Reaction 类，其二是作为计算属性的 ComputedValue 类。这两个类都实现了具体的 onBecomeStale 方法。reaction.onBecomeStale 方法的表现是在所有响应式数据变更完成后，再对相关的衍生执行批处理操作，当然，在同一个批处理周期内，不会再对由 reaction 引起的衍生加以处理，这些衍生需要等待下一个批处理周期。ComputedValue 的特别之处是，它既是衍生，观察着数据变更；又是响应式数据，被其他衍生所观察。因此，computedValue.onBecomeStale 方法的处理逻辑是在其他衍生执行 onBecomeStale 过程中，重新获取计算属性的值。</p>
<h2 id="运作机制"><a href="#运作机制" class="headerlink" title="运作机制"></a>运作机制</h2><h3 id="reportObserved"><a href="#reportObserved" class="headerlink" title="reportObserved"></a>reportObserved</h3><p>当响应式数据被衍生订阅时，将会执行 obsrvable.reportObserved 方法。在该方法的执行过程中，无他，就是针对当前执行的衍生调用其观察的响应式数据的 onBecameObserved 方法；或者将该 obsrvable 实例添加到 globalState.pendingUnobservations 数组中，等待事务结束时，执行 observable.onBecomeUnobserved 与 computedValue.suspend 方法。这里不再作介绍。</p>
<h3 id="reportChanged"><a href="#reportChanged" class="headerlink" title="reportChanged"></a>reportChanged</h3><p><em>图 2，reportChanged 执行流程</em><br><img src="/2018/08/15/frontend/library/mobx源码分析2/reportChanged.png"></p>
<p>结合上图，当响应式数据发生变更时，mobx 的处理机制为：</p>
<ol>
<li>通过 observable.reportChanged 方法将响应式数据变更的信息上报到全局监听器。</li>
<li>observable.reportChanged 执行过程中，使用 startBatch, endBatch 函数将 propagateChange(observable) 包裹到事务处理流程中。mobx 中的事务通过 globalState.inBatch 计数器标识：在 startBatch 函数执行过程中，globalState.inBatch 加 1；在 endBatch 函数执行过程中，globalState.inBatch 减 1；当 globalState.inBatch 为 0 时，表示单个事务处理结束。因为事务的意义在于将并行的响应式数据变更视为一组，在一组变更完成之后，在执行相应的衍生。</li>
<li>在同一个事务处理流程中，首先通过 propagateChange(observable) 间接将 derivation 加入到 globalState.pendingReactions 队列中。该过程中通过调用 derivation.onBecameStale 方法实现。对于 reaction 反应，在事务执行期间，直接将 reaction 添加到 globalState.pendingReactions 队列；对于 computedValue 计算属性，间接将观察 computedValue 变更的 reaction 添加到 globalState.pendingReactions 队列。</li>
<li>在 endBatch 函数执行期间，通过调用 runReactions 方法遍历 globalState.pendingReactions 队列，执行 reaction.runReaction 方法。每个 reaction.runReaction 方法内部的执行逻辑中，包含 observer 依赖和状态更新，以及执行用户实际注册的监听函数。reaction.runReaction 方法的处理细节将在后文加以分析。</li>
<li>在事务处理的尾端，又将遍历 globalState.pendingUnobservations 数组，调用 observable.onBecomeUnobserved 方法。对于计算属性，额外调用 computedValue.suspend() 方法。这样的目的在于当前没有观察者监听这些 observable 或 computedValue 的变更，无需将数据变更上报到全局环境。</li>
</ol>
<p><em>代码段 1，reportChanged 处理流程</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Atom</span> <span class="title">implements</span> <span class="title">IAtom</span> </span>&#123;</span><br><span class="line">  public reportChanged() &#123;</span><br><span class="line">    startBatch()</span><br><span class="line">    propagateChanged(<span class="keyword">this</span>)</span><br><span class="line">    endBatch()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">startBatch</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  globalState.inBatch++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">endBatch</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (--globalState.inBatch === <span class="number">0</span>) &#123;</span><br><span class="line">    runReactions()</span><br><span class="line">    <span class="keyword">const</span> list = globalState.pendingUnobservations</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; list.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> observable = list[i]</span><br><span class="line">      observable.isPendingUnobservation = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">if</span> (observable.observers.size === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (observable.isBeingObserved) &#123;</span><br><span class="line">          observable.isBeingObserved = <span class="literal">false</span></span><br><span class="line">          observable.onBecomeUnobserved()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (observable <span class="keyword">instanceof</span> ComputedValue) &#123;</span><br><span class="line">          observable.suspend()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    globalState.pendingUnobservations = []</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">propagateChanged</span>(<span class="params">observable: IObservable</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (observable.lowestObserverState === IDerivationState.STALE) <span class="keyword">return</span></span><br><span class="line">  observable.lowestObserverState = IDerivationState.STALE</span><br><span class="line"></span><br><span class="line">  observable.observers.forEach(<span class="function"><span class="params">d</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (d.dependenciesState === IDerivationState.UP_TO_DATE) &#123;</span><br><span class="line">      d.onBecomeStale()</span><br><span class="line">    &#125;</span><br><span class="line">    d.dependenciesState = IDerivationState.STALE</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">propagateMaybeChanged</span>(<span class="params">observable: IObservable</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (observable.lowestObserverState !== IDerivationState.UP_TO_DATE) <span class="keyword">return</span></span><br><span class="line">  observable.lowestObserverState = IDerivationState.POSSIBLY_STALE</span><br><span class="line"></span><br><span class="line">  observable.observers.forEach(<span class="function"><span class="params">d</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (d.dependenciesState === IDerivationState.UP_TO_DATE) &#123;</span><br><span class="line">      d.dependenciesState = IDerivationState.POSSIBLY_STALE</span><br><span class="line">      d.onBecomeStale()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ComputedValue</span>&lt;<span class="title">T</span>&gt; <span class="title">implements</span> <span class="title">IObservable</span>, <span class="title">IComputedValue</span>&lt;<span class="title">T</span>&gt;, <span class="title">IDerivation</span> </span>&#123;</span><br><span class="line">  onBecomeStale() &#123;</span><br><span class="line">    propagateMaybeChanged(<span class="keyword">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Reaction</span> <span class="title">implements</span> <span class="title">IDerivation</span>, <span class="title">IReactionPublic</span> </span>&#123;</span><br><span class="line">  onBecomeStale() &#123;</span><br><span class="line">    <span class="keyword">this</span>.schedule()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  schedule() &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>._isScheduled) &#123;</span><br><span class="line">      <span class="keyword">this</span>._isScheduled = <span class="literal">true</span></span><br><span class="line">      globalState.pendingReactions.push(<span class="keyword">this</span>)</span><br><span class="line">      runReactions()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> reactionScheduler: <span class="function">(<span class="params">fn: (</span>) =&gt;</span> <span class="keyword">void</span>) =&gt; <span class="keyword">void</span> = <span class="function"><span class="params">f</span> =&gt;</span> f()</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">runReactions</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (globalState.inBatch &gt; <span class="number">0</span> || globalState.isRunningReactions) <span class="keyword">return</span></span><br><span class="line">  reactionScheduler(runReactionsHelper)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runReactionsHelper</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  globalState.isRunningReactions = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">const</span> allReactions = globalState.pendingReactions</span><br><span class="line">  <span class="keyword">let</span> iterations = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (allReactions.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> remainingReactions = allReactions.splice(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = remainingReactions.length; i &lt; l; i++)</span><br><span class="line">      remainingReactions[i].runReaction()</span><br><span class="line">  &#125;</span><br><span class="line">  globalState.isRunningReactions = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上代码不但没有看见计算属性重新取值的实现，而且高度依赖于 observable 和 observer 的依赖关系和各自的状态标识，因此，我们会持有以下两个问题：</p>
<ol>
<li>reaction.runReaction 方法到底是怎样实现的？reaction 和 computedValue 又怎样相互影响？</li>
<li>mobx 怎样更新及维护 observable 和 observer 的依赖关系和状态标识？</li>
</ol>
<h4 id="runReaction"><a href="#runReaction" class="headerlink" title="runReaction"></a>runReaction</h4><p><em>图 3，reaction.runReaction 执行流程</em><br><img src="/2018/08/15/frontend/library/mobx源码分析2/runReaction.png"></p>
<p>结合上图，reaction.runReaction 针对以下两种情况作出处理：</p>
<ol>
<li>当响应式数据引起的反应内部没有计算属性时，重新执行反应的处理逻辑。</li>
<li>当响应式数据引起的反应内部有计算属性时，且计算属性观察的数据改变时，通过 computedValue 方法重新获取计算属性的值，事务（在 reaction.runReaction 方法执行过程中，使用 startBatch 函数开启）的意义在于等待计算属性的重新计算。其他情况下使用原有的值。</li>
</ol>
<p>需要留神的是，在 reaction.runReaction 方法中使用 startBatch 开启事务时，globalState.isRunningReactions 标识仍旧为真值，也就不会造成 globalState.pendingReactions 中未作处理的 reaction 被反复执行。</p>
<p><em>代码段 2，runReaction 处理流程</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Reaction</span> <span class="title">implements</span> <span class="title">IDerivation</span>, <span class="title">IReactionPublic</span> </span>&#123;</span><br><span class="line">  runReaction() &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.isDisposed) &#123;</span><br><span class="line">      startBatch()</span><br><span class="line">      <span class="keyword">this</span>._isScheduled = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">if</span> (shouldCompute(<span class="keyword">this</span>)) &#123;</span><br><span class="line">        <span class="comment">// 用户实际注册的监听函数经包装后将以 reaction.onInvalidate 形式呈现</span></span><br><span class="line">        <span class="keyword">this</span>.onInvalidate()</span><br><span class="line">      &#125;</span><br><span class="line">      endBatch()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shouldCompute</span>(<span class="params">derivation: IDerivation</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (derivation.dependenciesState) &#123;</span><br><span class="line">    <span class="keyword">case</span> IDerivationState.UP_TO_DATE:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">case</span> IDerivationState.NOT_TRACKING:</span><br><span class="line">    <span class="keyword">case</span> IDerivationState.STALE:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    <span class="keyword">case</span> IDerivationState.POSSIBLY_STALE: &#123;</span><br><span class="line">      <span class="keyword">const</span> prevUntracked = untrackedStart()</span><br><span class="line">      <span class="keyword">const</span> obs = derivation.observing,</span><br><span class="line">        l = obs.length</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; l; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> obj = obs[i]</span><br><span class="line">        <span class="keyword">if</span> (isComputedValue(obj)) &#123;</span><br><span class="line">          obj.get()</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> ((derivation.dependenciesState <span class="keyword">as</span> any) === IDerivationState.STALE) &#123;</span><br><span class="line">            untrackedEnd(prevUntracked)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      changeDependenciesStateTo0(derivation)</span><br><span class="line">      untrackedEnd(prevUntracked)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ComputedValue</span>&lt;<span class="title">T</span>&gt; <span class="title">implements</span> <span class="title">IObservable</span>, <span class="title">IComputedValue</span>&lt;<span class="title">T</span>&gt;, <span class="title">IDerivation</span> </span>&#123;</span><br><span class="line">  public <span class="keyword">get</span>(): T &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.keepAlive &amp;&amp; <span class="keyword">this</span>.firstGet) &#123;</span><br><span class="line">      <span class="keyword">this</span>.firstGet = <span class="literal">false</span></span><br><span class="line">      autorun(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">this</span>.get())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化获取绑定计算属性的依赖关系，或者在 action 中直接获取计算属性</span></span><br><span class="line">    <span class="keyword">if</span> (globalState.inBatch === <span class="number">0</span> &amp;&amp; <span class="keyword">this</span>.observers.size === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (shouldCompute(<span class="keyword">this</span>)) &#123;</span><br><span class="line">        <span class="keyword">this</span>.warnAboutUntrackedRead()</span><br><span class="line">        startBatch()</span><br><span class="line">        <span class="keyword">this</span>.value = <span class="keyword">this</span>.computeValue(<span class="literal">false</span>)</span><br><span class="line">        endBatch()</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// reaction.runReaction 处理逻辑中，将进入第二个条件分支</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      reportObserved(<span class="keyword">this</span>)</span><br><span class="line">      <span class="keyword">if</span> (shouldCompute(<span class="keyword">this</span>)) <span class="keyword">if</span> (<span class="keyword">this</span>.trackAndCompute()) propagateChangeConfirmed(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">this</span>.value!</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  computeValue(track: boolean) &#123;</span><br><span class="line">    globalState.computationDepth++</span><br><span class="line">    <span class="keyword">let</span> res: T | CaughtException</span><br><span class="line">    <span class="keyword">if</span> (track) &#123;</span><br><span class="line">      res = trackDerivedFunction(<span class="keyword">this</span>, <span class="keyword">this</span>.derivation, <span class="keyword">this</span>.scope)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      res = <span class="keyword">this</span>.derivation.call(<span class="keyword">this</span>.scope)</span><br><span class="line">    &#125;</span><br><span class="line">    globalState.computationDepth--</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private trackAndCompute(): boolean &#123;</span><br><span class="line">    <span class="keyword">const</span> oldValue = <span class="keyword">this</span>.value</span><br><span class="line">    <span class="keyword">const</span> wasSuspended = <span class="keyword">this</span>.dependenciesState === IDerivationState.NOT_TRACKING</span><br><span class="line">    <span class="keyword">const</span> newValue = <span class="keyword">this</span>.computeValue(<span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> changed = wasSuspended || !<span class="keyword">this</span>.equals(oldValue, newValue)</span><br><span class="line">    <span class="keyword">if</span> (changed) <span class="keyword">this</span>.value = newValue</span><br><span class="line">    <span class="keyword">return</span> changed</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">propagateChangeConfirmed</span>(<span class="params">observable: IObservable</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (observable.lowestObserverState === IDerivationState.STALE) <span class="keyword">return</span></span><br><span class="line">  observable.lowestObserverState = IDerivationState.STALE</span><br><span class="line"></span><br><span class="line">  observable.observers.forEach(<span class="function"><span class="params">d</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (d.dependenciesState === IDerivationState.POSSIBLY_STALE)</span><br><span class="line">      d.dependenciesState = IDerivationState.STALE</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">      d.dependenciesState === IDerivationState.UP_TO_DATE</span><br><span class="line">    )</span><br><span class="line">      observable.lowestObserverState = IDerivationState.UP_TO_DATE</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上述代码中，对于 trackDerivedFunction 函数的处理逻辑，我将在下一小节予以分析。</p>
<h4 id="依赖更新"><a href="#依赖更新" class="headerlink" title="依赖更新"></a>依赖更新</h4><p>我们先来看一下 mobx 为 observable, observer 提供的状态值：</p>
<ol>
<li>IDerivationState.NOT_TRACKING：值为 -1，作为 derivation 的初始状态。当衍生不再订阅响应式数据时，derivation.dependenciesState 值也将被置为 NOT_TRACKING。</li>
<li>IDerivationState.UP_TO_DATE：值为 0，当响应式数据变更且衍生有执行时，derivation.dependenciesState 状态将被置为 UP_TO_DATE。</li>
<li>IDerivationState.POSSIBLY_STALE：值为 1，计算属性变更时，订阅计算属性的衍生状态将置为 POSSIBLY_STALE。若在 shouldCompute 函数执行环节，当确认计算属性的值未作变更时，derivation.dependenciesState 状态将被重置为 UP_TO_DATE；若作变更，状态将置为 STALE。</li>
<li>IDerivationState.STALE：值为 2，当衍生订阅的响应式数据或计算属性变更时，derivation.dependenciesState 状态将被置为 STALE，意味着衍生的逻辑需要重新启动。</li>
</ol>
<p><em>图 4，状态标识更新流程</em><br><img src="/2018/08/15/frontend/library/mobx源码分析2/state.png"></p>
<p>状态标识更新流程为：</p>
<ol>
<li>当初次添加 derivation 时，状态标识置为 NOT_TRACKING。</li>
<li>当响应式数据更新，监听这个响应式数据的衍生包含 reaction，则将该 reaction 的状态置为 STALE；包含 computedValue，则将该 computedValue 状态置为 STALE，并通过 computedValue.onBecameStale 方法将订阅这个计算属性的反应 reaction 的状态置为 POSSIBLY_STALE。</li>
<li>在事务 endBatch 环节，通过 reaction.runReaction 方法的执行过程刷新该 reaction 和 observable 的绑定关系，并将 reaction 的状态标识置为 NOT_TRACKING（在 reaction 用户端逻辑执行过程中，添加了新的 observable） 或 UP_TO_DATE。若 reaction 还订阅了计算属性，则调用计算属性 computedValue.get 方法，通过这个方法的执行，刷新 computedValue 和 observable 的关系，并将其状态标识置为 NOT_TRACKING 或 UP_TO_DATE。</li>
</ol>
<p>第 2 步的执行逻辑参见上文给出的 propagateChanged, propagatedMaybeChanged 函数；第 1, 3 两步均通过 trackDerivedFunction 函数实现。</p>
<p><em>代码段 3，derivation 状态更新</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trackDerivedFunction</span>&lt;<span class="title">T</span>&gt;(<span class="params">derivation: IDerivation, f: (</span>) =&gt; <span class="title">T</span>, <span class="title">context</span>: <span class="title">any</span>) </span>&#123;</span><br><span class="line">  changeDependenciesStateTo0(derivation)</span><br><span class="line">  derivation.newObserving = <span class="keyword">new</span> <span class="built_in">Array</span>(derivation.observing.length + <span class="number">100</span>)</span><br><span class="line">  derivation.unboundDepsCount = <span class="number">0</span></span><br><span class="line">  derivation.runId = ++globalState.runId</span><br><span class="line">  <span class="keyword">const</span> prevTracking = globalState.trackingDerivation</span><br><span class="line">  globalState.trackingDerivation = derivation</span><br><span class="line">  <span class="keyword">let</span> result</span><br><span class="line">  <span class="keyword">if</span> (globalState.disableErrorBoundaries === <span class="literal">true</span>) &#123;</span><br><span class="line">    result = f.call(context)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      result = f.call(context)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      result = <span class="keyword">new</span> CaughtException(e)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  globalState.trackingDerivation = prevTracking</span><br><span class="line">  bindDependencies(derivation)</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 刷新 derivation 和 observable 的依赖关系，并将 derivation 的状态标识置为 UP_TO_DATE 或 NOT_TRACKING</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindDependencies</span>(<span class="params">derivation: IDerivation</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> prevObserving = derivation.observing</span><br><span class="line">  <span class="keyword">const</span> observing = (derivation.observing = derivation.newObserving!)</span><br><span class="line">  <span class="keyword">let</span> lowestNewObservingDerivationState = IDerivationState.UP_TO_DATE</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> i0 = <span class="number">0</span>,</span><br><span class="line">    l = derivation.unboundDepsCount</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; l; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> dep = observing[i]</span><br><span class="line">    <span class="keyword">if</span> (dep.diffValue === <span class="number">0</span>) &#123;</span><br><span class="line">      dep.diffValue = <span class="number">1</span></span><br><span class="line">      <span class="keyword">if</span> (i0 !== i) observing[i0] = dep</span><br><span class="line">      i0++</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (((dep <span class="keyword">as</span> any) <span class="keyword">as</span> IDerivation).dependenciesState &gt; lowestNewObservingDerivationState) &#123;</span><br><span class="line">      lowestNewObservingDerivationState = ((dep <span class="keyword">as</span> any) <span class="keyword">as</span> IDerivation).dependenciesState</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  observing.length = i0</span><br><span class="line"></span><br><span class="line">  derivation.newObserving = <span class="literal">null</span></span><br><span class="line">  </span><br><span class="line">  l = prevObserving.length</span><br><span class="line">  <span class="keyword">while</span> (l--) &#123;</span><br><span class="line">    <span class="keyword">const</span> dep = prevObserving[l]</span><br><span class="line">    <span class="keyword">if</span> (dep.diffValue === <span class="number">0</span>) &#123;</span><br><span class="line">      removeObserver(dep, derivation)</span><br><span class="line">    &#125;</span><br><span class="line">    dep.diffValue = <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (i0--) &#123;</span><br><span class="line">    <span class="keyword">const</span> dep = observing[i0]</span><br><span class="line">    <span class="keyword">if</span> (dep.diffValue === <span class="number">1</span>) &#123;</span><br><span class="line">      dep.diffValue = <span class="number">0</span></span><br><span class="line">      addObserver(dep, derivation)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 对于新添加的观察数据，将 derivation 添加 globalState.pendingReactions 中，在当前事务周期中处理</span></span><br><span class="line">  <span class="keyword">if</span> (lowestNewObservingDerivationState !== IDerivationState.UP_TO_DATE) &#123;</span><br><span class="line">    derivation.dependenciesState = lowestNewObservingDerivationState</span><br><span class="line">    derivation.onBecomeStale()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">changeDependenciesStateTo0</span>(<span class="params">derivation: IDerivation</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (derivation.dependenciesState === IDerivationState.UP_TO_DATE) <span class="keyword">return</span></span><br><span class="line">  derivation.dependenciesState = IDerivationState.UP_TO_DATE</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> obs = derivation.observing</span><br><span class="line">  <span class="keyword">let</span> i = obs.length</span><br><span class="line">  <span class="keyword">while</span> (i--) obs[i].lowestObserverState = IDerivationState.UP_TO_DATE</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>trackDerivedFunction 函数在 mobx 中的实际调用过程：</p>
<ol>
<li>Reaction 构造函数提供了 track 实例方法。该实例方法执行过程中，将 trackDerivedFunction 函数更新 derivation 的状态和依赖关系，同时执行传参 fn 函数。实际在构造 Reaction 过程中，用户端执行逻辑将经由 autorun 函数使用 reaction.track 封装后构成 reaction.onInvalidate 方法，该方法将在 reaction.runReaction 执行过程中得到调用，而用户端执行逻辑也将作为 reaction.track 方法的参数 fn。这样就解释了响应式数据变更时，既会处理用户端执行逻辑，如使视图重绘，又会促使 reaction 的状态值得到更新。</li>
<li>ComputedValue 构造函数提供的 computeValue 实例方法，也会调用 trackDerivedFunction 函数。而 computedValue.get 实例方法将间接调用 computeValue 方法，从而使计算属性的状态得到更新。</li>
</ol>
<p><em>代码段 4，trackDerivedFunction 实际调用，只限于 reaction</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Reaction</span> <span class="title">implements</span> <span class="title">IDerivation</span>, <span class="title">IReactionPublic</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(</span><br><span class="line">    public name: string = "Reaction@" + getNextId(),</span><br><span class="line">    private onInvalidate: () =&gt; void,</span><br><span class="line">    private errorHandler?: (error: any, derivation: IDerivation) =&gt; void</span><br><span class="line">  ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  runReaction() &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.isDisposed) &#123;</span><br><span class="line">      startBatch()</span><br><span class="line">      <span class="keyword">this</span>._isScheduled = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">if</span> (shouldCompute(<span class="keyword">this</span>)) &#123;</span><br><span class="line">        <span class="comment">// 用户实际注册的监听函数经包装后将以 reaction.onInvalidate 形式呈现</span></span><br><span class="line">        <span class="keyword">this</span>.onInvalidate()</span><br><span class="line">      &#125;</span><br><span class="line">      endBatch()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  track(fn: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">void</span>) &#123;</span><br><span class="line">    startBatch()</span><br><span class="line">    <span class="keyword">this</span>._isRunning = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">const</span> result = trackDerivedFunction(<span class="keyword">this</span>, fn, <span class="literal">undefined</span>)</span><br><span class="line">    <span class="keyword">this</span>._isRunning = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">this</span>._isTrackPending = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.isDisposed) &#123;</span><br><span class="line">      clearObserving(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    endBatch()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">autorun</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  view: (r: IReactionPublic</span>) =&gt; <span class="title">any</span>,</span></span><br><span class="line"><span class="function">  <span class="title">opts</span>: <span class="title">IAutorunOptions</span> = <span class="title">EMPTY_OBJECT</span></span></span><br><span class="line"><span class="function">): <span class="title">IReactionDisposer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> name: string = (opts &amp;&amp; opts.name) || (view <span class="keyword">as</span> any).name || <span class="string">"Autorun@"</span> + getNextId()</span><br><span class="line">  <span class="keyword">let</span> reaction: Reaction</span><br><span class="line"></span><br><span class="line">  reaction = <span class="keyword">new</span> Reaction(</span><br><span class="line">    name,</span><br><span class="line">    <span class="function"><span class="keyword">function</span> (<span class="params">this: Reaction</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.track(reactionRunner)</span><br><span class="line">    &#125;,</span><br><span class="line">    opts.onError</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">reactionRunner</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    view(reaction)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化绑定 reaction 和 observable 的依赖关系，并调用用户端执行逻辑 view</span></span><br><span class="line">  reaction.schedule()</span><br><span class="line">  <span class="keyword">return</span> reaction.getDisposer()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="接口层"><a href="#接口层" class="headerlink" title="接口层"></a>接口层</h2><p>接口层的主要目的是将用户端执行逻辑在响应式数据变更后自动得到调用。</p>
<h3 id="autoRun"><a href="#autoRun" class="headerlink" title="autoRun"></a>autoRun</h3><p>autoRun 函数的处理流程为：构建 Reaction 实例；初始化调用 reaction.schedule 方法，初次调用用户端执行逻辑 ，绑定 observer 和 observable 的依赖关系；使用 reaction.track 包装用户端执行逻辑，在响应式数据变更后，既负责更新 observer 和 observable 的依赖关系，又负责调用用户端执行逻辑。用户端执行逻辑通常表现为视图变更，因此也被标识为 view 函数。</p>
<p>在调用 autoRun 时，可以通过选项 opts.delay 或 opts.scheduler 调度 view 的执行时机。</p>
<p>完整代码如下：</p>
<p><em>代码段 5，autoRun 函数</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">autorun</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  view: (r: IReactionPublic</span>) =&gt; <span class="title">any</span>,</span></span><br><span class="line"><span class="function">  <span class="title">opts</span>: <span class="title">IAutorunOptions</span> = <span class="title">EMPTY_OBJECT</span></span></span><br><span class="line"><span class="function">): <span class="title">IReactionDisposer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> name: string = (opts &amp;&amp; opts.name) || (view <span class="keyword">as</span> any).name || <span class="string">"Autorun@"</span> + getNextId()</span><br><span class="line">  <span class="keyword">const</span> runSync = !opts.scheduler &amp;&amp; !opts.delay</span><br><span class="line">  <span class="keyword">let</span> reaction: Reaction</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (runSync) &#123;</span><br><span class="line">    reaction = <span class="keyword">new</span> Reaction(</span><br><span class="line">      name,</span><br><span class="line">      <span class="function"><span class="keyword">function</span> (<span class="params">this: Reaction</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.track(reactionRunner)</span><br><span class="line">      &#125;,</span><br><span class="line">      opts.onError</span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> scheduler = createSchedulerFromOptions(opts)</span><br><span class="line">    <span class="keyword">let</span> isScheduled = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    reaction = <span class="keyword">new</span> Reaction(</span><br><span class="line">      name,</span><br><span class="line">      () =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isScheduled) &#123;</span><br><span class="line">          isScheduled = <span class="literal">true</span></span><br><span class="line">          scheduler(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            isScheduled = <span class="literal">false</span></span><br><span class="line">            <span class="keyword">if</span> (!reaction.isDisposed) reaction.track(reactionRunner)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      opts.onError</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">reactionRunner</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    view(reaction)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  reaction.schedule()</span><br><span class="line">  <span class="keyword">return</span> reaction.getDisposer()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createSchedulerFromOptions</span>(<span class="params">opts: IReactionOptions</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> opts.scheduler</span><br><span class="line">    ? opts.scheduler</span><br><span class="line">    : opts.delay</span><br><span class="line">      ? <span class="function">(<span class="params">f: Lambda</span>) =&gt;</span> setTimeout(f, opts.delay!)</span><br><span class="line">      : run</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="reaction"><a href="#reaction" class="headerlink" title="reaction"></a>reaction</h3><p>reaction 函数的处理基本同 autoRun，其主要区别是，用户端执行逻辑表现为当首参计算函数返回的终值发生改变时，执行次参副作用逻辑。</p>
<p><em>代码段 6，reaction 函数</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reaction</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  expression: (r: IReactionPublic</span>) =&gt; <span class="title">T</span>,</span></span><br><span class="line"><span class="function">  <span class="title">effect</span>: (<span class="params">arg: T, r: IReactionPublic</span>) =&gt; <span class="title">void</span>,</span></span><br><span class="line"><span class="function">  <span class="title">opts</span>: <span class="title">IReactionOptions</span> = <span class="title">EMPTY_OBJECT</span></span></span><br><span class="line"><span class="function">): <span class="title">IReactionDisposer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> name = opts.name || <span class="string">"Reaction@"</span> + getNextId()</span><br><span class="line">  <span class="keyword">const</span> effectAction = action(</span><br><span class="line">    name,</span><br><span class="line">    opts.onError ? wrapErrorHandler(opts.onError, effect) : effect</span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">const</span> runSync = !opts.scheduler &amp;&amp; !opts.delay</span><br><span class="line">  <span class="keyword">const</span> scheduler = createSchedulerFromOptions(opts)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> firstTime = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">let</span> isScheduled = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> value: T</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> equals = (opts <span class="keyword">as</span> any).compareStructural</span><br><span class="line">    ? comparer.structural</span><br><span class="line">    : opts.equals || comparer.default</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> r = <span class="keyword">new</span> Reaction(</span><br><span class="line">    name,</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (firstTime || runSync) &#123;</span><br><span class="line">        reactionRunner()</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isScheduled) &#123;</span><br><span class="line">        isScheduled = <span class="literal">true</span></span><br><span class="line">        scheduler!(reactionRunner)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    opts.onError</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">reactionRunner</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    isScheduled = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">if</span> (r.isDisposed) <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">let</span> changed = <span class="literal">false</span></span><br><span class="line">    r.track(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> nextValue = expression(r)</span><br><span class="line">      changed = firstTime || !equals(value, nextValue)</span><br><span class="line">      value = nextValue</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> (firstTime &amp;&amp; opts.fireImmediately!) effectAction(value, r)</span><br><span class="line">    <span class="keyword">if</span> (!firstTime &amp;&amp; (changed <span class="keyword">as</span> boolean) === <span class="literal">true</span>) effectAction(value, r)</span><br><span class="line">    <span class="keyword">if</span> (firstTime) firstTime = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  r.schedule()</span><br><span class="line">  <span class="keyword">return</span> r.getDisposer()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="when"><a href="#when" class="headerlink" title="when"></a>when</h3><p>when 函数的意义是在满足特定条件下，以动作 action 形式执行副作用函数，其实现内部调用了 autoRun 函数。when 函数分为同步版本和异步版本两个。并且，随着响应式数据的变更满足了特定的条件，在副作用函数执行之前，reactin 实例将被销毁，因此副作用函数将只执行一次。</p>
<p><em>代码段 7，reaction 函数</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">when</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  predicate: (</span>) =&gt; <span class="title">boolean</span>,</span></span><br><span class="line"><span class="function">  <span class="title">opts</span>?: <span class="title">IWhenOptions</span></span></span><br><span class="line"><span class="function">): <span class="title">Promise</span>&lt;<span class="title">void</span>&gt; &amp; </span>&#123; cancel(): <span class="keyword">void</span> &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">when</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  predicate: (</span>) =&gt; <span class="title">boolean</span>,</span></span><br><span class="line"><span class="function">  <span class="title">effect</span>: <span class="title">Lambda</span>,</span></span><br><span class="line"><span class="function">  <span class="title">opts</span>?: <span class="title">IWhenOptions</span></span></span><br><span class="line"><span class="function">): <span class="title">IReactionDisposer</span></span></span><br><span class="line"><span class="function"><span class="title">function</span> <span class="title">when</span>(<span class="params">predicate: any, arg1?: any, arg2?: any</span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">arguments</span>.length === <span class="number">1</span> || (arg1 &amp;&amp; <span class="keyword">typeof</span> arg1 === <span class="string">"object"</span>))</span><br><span class="line">    <span class="keyword">return</span> whenPromise(predicate, arg1)</span><br><span class="line">  <span class="keyword">return</span> _when(predicate, arg1, arg2 || &#123;&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_when</span>(<span class="params">predicate: (</span>) =&gt; <span class="title">boolean</span>, <span class="title">effect</span>: <span class="title">Lambda</span>, <span class="title">opts</span>: <span class="title">IWhenOptions</span>): <span class="title">IReactionDisposer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> timeoutHandle: any</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> opts.timeout === <span class="string">"number"</span>) &#123;</span><br><span class="line">    timeoutHandle = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!disposer[$mobx].isDisposed) &#123;</span><br><span class="line">        disposer()</span><br><span class="line">        <span class="keyword">const</span> error = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"WHEN_TIMEOUT"</span>)</span><br><span class="line">        <span class="keyword">if</span> (opts.onError) opts.onError(error)</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">throw</span> error</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, opts.timeout)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  opts.name = opts.name || <span class="string">"When@"</span> + getNextId()</span><br><span class="line">  <span class="keyword">const</span> effectAction = createAction(opts.name + <span class="string">"-effect"</span>, effect <span class="keyword">as</span> <span class="built_in">Function</span>)</span><br><span class="line">  <span class="keyword">const</span> disposer = autorun(<span class="function"><span class="params">r</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (predicate()) &#123;</span><br><span class="line">      r.dispose()</span><br><span class="line">      <span class="keyword">if</span> (timeoutHandle) clearTimeout(timeoutHandle)</span><br><span class="line">      effectAction()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, opts)</span><br><span class="line">  <span class="keyword">return</span> disposer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">whenPromise</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  predicate: (</span>) =&gt; <span class="title">boolean</span>,</span></span><br><span class="line"><span class="function">  <span class="title">opts</span>?: <span class="title">IWhenOptions</span></span></span><br><span class="line"><span class="function">): <span class="title">Promise</span>&lt;<span class="title">void</span>&gt; &amp; </span>&#123; cancel(): <span class="keyword">void</span> &#125; &#123;</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">"production"</span> &amp;&amp; opts &amp;&amp; opts.onError)</span><br><span class="line">    <span class="keyword">return</span> fail(<span class="string">`the options 'onError' and 'promise' cannot be combined`</span>)</span><br><span class="line">  <span class="keyword">let</span> cancel</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> disposer = _when(predicate, resolve, &#123; ...opts, <span class="attr">onError</span>: reject &#125;)</span><br><span class="line">    cancel = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      disposer()</span><br><span class="line">      reject(<span class="string">"WHEN_CANCELLED"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">    ; (res <span class="keyword">as</span> any).cancel = cancel</span><br><span class="line">  <span class="keyword">return</span> res <span class="keyword">as</span> any</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>mobx 是一个十分严谨的类库，这两篇文章点到的内容最多也不过十之六七。感兴趣的读者可以自行翻阅源码，想必能发现额外的矿藏，比如错误处理、信息追踪等。</p>

        </div>
        <footer class="article-footer">
            

    <div class="bdsharebuttonbox">
    <a href="#" class="bds_more" data-cmd="more">分享到：</a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间">QQ空间</a>
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博">新浪微博</a>
    <a href="#" class="bds_tqq" data-cmd="tqq" title="分享到腾讯微博">腾讯微博</a>
    <a href="#" class="bds_renren" data-cmd="renren" title="分享到人人网">人人网</a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信">微信</a>
</div>
<script>
window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"16"},"share":{"bdSize":16}};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
</script>
<style>
    .bdshare_popup_box {
        border-radius: 4px;
        border: #e1e1e1 solid 1px;
    }
    .bdshare-button-style0-16 a,
    .bdshare-button-style0-16 .bds_more {
        padding-left: 20px;
        margin: 6px 10px 6px 0;
    }
    .bdshare_dialog_list a,
    .bdshare_popup_list a,
    .bdshare_popup_bottom a {
        font-family: 'Microsoft Yahei';
    }
    .bdshare_popup_top {
        display: none;
    }
    .bdshare_popup_bottom {
        height: auto;
        padding: 5px;
    }
</style>



        </footer>
    </div>
    <script type="application/ld+json">
    {
        "@context": "https://schema.org",
        "@type": "BlogPosting",
        "author": {
            "@type": "Person",
            "name": "Alfred"
        },
        "headline": "mobx源码分析（二） 订阅响应式数据",
        "image": "http://xzfyu.com/2018/08/15/frontend/library/mobx源码分析2/core.png",
        "keywords": "analyst react",
        "genre": "frontend library",
        "datePublished": "2018-08-15",
        "dateCreated": "2018-08-15",
        "dateModified": "2020-03-08",
        "url": "http://xzfyu.com/2018/08/15/frontend/library/mobx源码分析2/",
        "description": "前言处理问题有两种方式，从一般到具体，或者从具体到一般。在写作这两篇文章时，我选择了后者，一是因为我在写作这篇文章的过程中才逐渐摸清 mobx 的设计和实现，二是因为我自身尚不具备足够的积淀，能站在更高的抽象维度对问题的一般面加以思索。上一篇文章对各种数据结构的处理无疑都是具体的，本文将介入如何抽象 observable，即对上一篇文章中的公有特征 reportObserved, reportCh",
        "wordCount": 4545
    }
</script>

</article>

    <section id="comments">
    
        
<div id="comment-container"></div>


    
    </section>



                        </div>
                    </section>
                    <aside id="sidebar">
    <a class="sidebar-toggle" title="Expand Sidebar"><i class="toggle icon"></i></a>
    <div class="sidebar-top">
        <p>关注我 :</p>
        <ul class="social-links">
            
                
                <li>
                    <a class="social-tooltip" title="github" href="https://github.com/Alfred-sg" target="_blank" rel="noopener">
                        <i class="icon fa fa-github"></i>
                    </a>
                </li>
                
            
        </ul>
    </div>
    
        
<nav id="article-nav">
    
        <a href="/2018/08/22/frontend/library/mobx使用探微/" id="article-nav-newer" class="article-nav-link-wrap">
        <strong class="article-nav-caption">下一篇</strong>
        <p class="article-nav-title">
        
            mobx使用探微
        
        </p>
        <i class="icon fa fa-chevron-right" id="icon-chevron-right"></i>
    </a>
    
    
        <a href="/2018/08/03/frontend/library/mobx源码分析1/" id="article-nav-older" class="article-nav-link-wrap">
        <strong class="article-nav-caption">上一篇</strong>
        <p class="article-nav-title">mobx源码分析（一） 构造响应式数据</p>
        <i class="icon fa fa-chevron-left" id="icon-chevron-left"></i>
        </a>
    
</nav>

    
    <div class="widgets-container">
        
            
                

            
                
    <div class="widget-wrap">
        <h3 class="widget-title">最新文章</h3>
        <div class="widget">
            <ul id="recent-post" class="no-thumbnail">
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/frontend/">frontend</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/categories/frontend/architecture/">architecture</a></p>
                            <p class="item-title"><a href="/2020/12/31/frontend/architecture/前端工程体系/" class="title">前端工程体系</a></p>
                            <p class="item-date"><time datetime="2020-12-30T16:00:00.000Z" itemprop="datePublished">2020-12-31</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/frontend/">frontend</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/categories/frontend/architecture/">architecture</a></p>
                            <p class="item-title"><a href="/2020/06/09/frontend/architecture/前端技术汇总贴/" class="title">前端技术汇总贴</a></p>
                            <p class="item-date"><time datetime="2020-06-08T16:00:00.000Z" itemprop="datePublished">2020-06-09</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/frontend/">frontend</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/categories/frontend/react/">react</a></p>
                            <p class="item-title"><a href="/2020/04/29/frontend/react16/react fiber 代码梳理篇/" class="title">react fiber 代码梳理篇</a></p>
                            <p class="item-date"><time datetime="2020-04-28T16:00:00.000Z" itemprop="datePublished">2020-04-29</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/frontend/">frontend</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/categories/frontend/architecture/">architecture</a></p>
                            <p class="item-title"><a href="/2020/04/10/frontend/architecture/模块化机制/" class="title">前端模块化机制</a></p>
                            <p class="item-date"><time datetime="2020-04-09T16:00:00.000Z" itemprop="datePublished">2020-04-10</time></p>
                        </div>
                    </li>
                
                    <li>
                        
                        <div class="item-inner">
                            <p class="item-category"><a class="article-category-link" href="/categories/frontend/">frontend</a><i class="icon fa fa-angle-right"></i><a class="article-category-link" href="/categories/frontend/前端工程化/">前端工程化</a></p>
                            <p class="item-title"><a href="/2020/04/05/frontend/工程化/命令行工具/" class="title">node 命令行工具</a></p>
                            <p class="item-date"><time datetime="2020-04-04T16:00:00.000Z" itemprop="datePublished">2020-04-05</time></p>
                        </div>
                    </li>
                
            </ul>
        </div>
    </div>

            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">分类</h3>
        <div class="widget">
            <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/backend/">backend</a><span class="category-list-count">25</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/backend/java/">java</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/backend/java-工程/">java 工程</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/backend/spring/">spring</a><span class="category-list-count">9</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/backend/web-服务/">web 服务</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/backend/其他/">其他</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/backend/异步消息/">异步消息</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/backend/数据库技术/">数据库技术</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/backend/架构/">架构</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/backend/缓存/">缓存</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/backend/远程通信/">远程通信</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/backend/部署/">部署</a><span class="category-list-count">2</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/frontend/">frontend</a><span class="category-list-count">88</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/frontend/antd/">antd</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/frontend/architecture/">architecture</a><span class="category-list-count">16</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/frontend/css/">css</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/frontend/editor/">editor</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/frontend/es/">es</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/frontend/guide/">guide</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/frontend/js/">js</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/frontend/library/">library</a><span class="category-list-count">12</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/frontend/react/">react</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/frontend/vue/">vue</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/frontend/webpack/">webpack</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/frontend/前端工程化/">前端工程化</a><span class="category-list-count">13</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据技术/">数据技术</a><span class="category-list-count">3</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/数据技术/sql/">sql</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据技术/大数据/">大数据</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/数据技术/读书笔记/">读书笔记</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机科学/">计算机科学</a><span class="category-list-count">12</span><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/计算机科学/操作系统/">操作系统</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机科学/算法/">算法</a><span class="category-list-count">4</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机科学/设计模式/">设计模式</a><span class="category-list-count">6</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/计算机科学/软件工程/">软件工程</a><span class="category-list-count">1</span></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/读书笔记/">读书笔记</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/踩坑/">踩坑</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔/">随笔</a><span class="category-list-count">3</span></li></ul>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-float">
        <h3 class="widget-title">标签云</h3>
        <div class="widget tagcloud">
            <a href="/tags/analyst/" style="font-size: 20px;">analyst</a> <a href="/tags/antd/" style="font-size: 14.44px;">antd</a> <a href="/tags/carrier/" style="font-size: 18.89px;">carrier</a> <a href="/tags/css/" style="font-size: 11.11px;">css</a> <a href="/tags/fiber-renconciler/" style="font-size: 10px;">fiber-renconciler</a> <a href="/tags/git/" style="font-size: 11.11px;">git</a> <a href="/tags/java/" style="font-size: 16.67px;">java</a> <a href="/tags/jquery/" style="font-size: 10px;">jquery</a> <a href="/tags/js/" style="font-size: 12.22px;">js</a> <a href="/tags/js设计模式/" style="font-size: 13.33px;">js设计模式</a> <a href="/tags/lint/" style="font-size: 10px;">lint</a> <a href="/tags/prettier/" style="font-size: 10px;">prettier</a> <a href="/tags/proxy/" style="font-size: 11.11px;">proxy</a> <a href="/tags/react/" style="font-size: 17.78px;">react</a> <a href="/tags/react-components/" style="font-size: 10px;">react-components</a> <a href="/tags/react16/" style="font-size: 10px;">react16</a> <a href="/tags/spring/" style="font-size: 10px;">spring</a> <a href="/tags/test/" style="font-size: 12.22px;">test</a> <a href="/tags/tools/" style="font-size: 10px;">tools</a> <a href="/tags/validate/" style="font-size: 10px;">validate</a> <a href="/tags/vue/" style="font-size: 14.44px;">vue</a> <a href="/tags/webpack/" style="font-size: 15.56px;">webpack</a> <a href="/tags/性能/" style="font-size: 10px;">性能</a> <a href="/tags/算法/" style="font-size: 12.22px;">算法</a> <a href="/tags/虚拟-dom/" style="font-size: 10px;">虚拟 dom</a>
        </div>
    </div>


            
                
    <div class="widget-wrap widget-list">
        <h3 class="widget-title">链接</h3>
        <div class="widget">
            <ul>
                
                    <li>
                        <a href="https://www.zhihu.com/people/xiu-fan-79/activities">知乎</a>
                    </li>
                
            </ul>
        </div>
    </div>


            
        
    </div>
</aside>

                </div>
            </div>
        </div>
        <footer id="footer">
    <div class="container">
        <div class="container-inner">
            <a id="back-to-top" href="javascript:;"><i class="icon fa fa-angle-up"></i></a>
            <div class="credit">
                <h1 class="logo-wrap">
                    <a href="/" class="logo"></a>
                </h1>
                <p>&copy; 2020 Alfred</p>
                
            </div>
            <div class="footer-plugins">
              
    


            </div>
        </div>
    </div>
</footer>

        
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>
<script>
    var gitalk = new Gitalk({
        clientID: 'b91413aac6da3042133d',
        clientSecret: '0ea2891e8a1163db789b8e5a4379771adb419be3',
        id: 'd5246404bdddd62aaa0fd47878ded5d0',
        repo: 'Alfred-sg.github.io',
        owner: 'Alfred-sg',
        admin: "Alfred-sg"
    })
    gitalk.render('comment-container')
</script>





    
        <script src="/libs/lightgallery/js/lightgallery.min.js"></script>
        <script src="/libs/lightgallery/js/lg-thumbnail.min.js"></script>
        <script src="/libs/lightgallery/js/lg-pager.min.js"></script>
        <script src="/libs/lightgallery/js/lg-autoplay.min.js"></script>
        <script src="/libs/lightgallery/js/lg-fullscreen.min.js"></script>
        <script src="/libs/lightgallery/js/lg-zoom.min.js"></script>
        <script src="/libs/lightgallery/js/lg-hash.min.js"></script>
        <script src="/libs/lightgallery/js/lg-share.min.js"></script>
        <script src="/libs/lightgallery/js/lg-video.min.js"></script>
    
    
        <script src="/libs/justified-gallery/jquery.justifiedGallery.min.js"></script>
    
    

    



<!-- Custom Scripts -->
<script src="/js/main.js"></script>

    </div><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</body>
</html>
