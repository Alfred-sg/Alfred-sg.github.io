<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.0.2" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.2">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.2" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.0.2',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="analyst,react,">


<meta name="description" content="前言写作这篇文章的起因是我有感于实际项目中所遇到的问题。因此，这篇文章只算是摸索的产物，远未臻于完美。在这里，我谨期望阅读这篇文章的同学能够见仁见智，各洒江海。 我所遇到的问题，总结如下：  项目采用分层设计，pages 为视图层，stores 为模型层，services 为服务层。从某种意义上讲，代码是按功能单元进行划分的，而不是业务单元。需要分别从 pages, stores, service">
<meta name="keywords" content="analyst,react">
<meta property="og:type" content="article">
<meta property="og:title" content="mobx使用探微">
<meta property="og:url" content="http://yoursite.com/2018/08/22/react/react相关/mobx使用探微/index.html">
<meta property="og:site_name" content="修子范语">
<meta property="og:description" content="前言写作这篇文章的起因是我有感于实际项目中所遇到的问题。因此，这篇文章只算是摸索的产物，远未臻于完美。在这里，我谨期望阅读这篇文章的同学能够见仁见智，各洒江海。 我所遇到的问题，总结如下：  项目采用分层设计，pages 为视图层，stores 为模型层，services 为服务层。从某种意义上讲，代码是按功能单元进行划分的，而不是业务单元。需要分别从 pages, stores, service">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/2018/08/22/react/react相关/mobx使用探微/database.png">
<meta property="og:image" content="http://yoursite.com/2018/08/22/react/react相关/mobx使用探微/architecture.png">
<meta property="og:updated_time" content="2018-09-10T12:42:58.810Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="mobx使用探微">
<meta name="twitter:description" content="前言写作这篇文章的起因是我有感于实际项目中所遇到的问题。因此，这篇文章只算是摸索的产物，远未臻于完美。在这里，我谨期望阅读这篇文章的同学能够见仁见智，各洒江海。 我所遇到的问题，总结如下：  项目采用分层设计，pages 为视图层，stores 为模型层，services 为服务层。从某种意义上讲，代码是按功能单元进行划分的，而不是业务单元。需要分别从 pages, stores, service">
<meta name="twitter:image" content="http://yoursite.com/2018/08/22/react/react相关/mobx使用探微/database.png">






  <link rel="canonical" href="http://yoursite.com/2018/08/22/react/react相关/mobx使用探微/">


  <title>mobx使用探微 | 修子范语</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">修子范语</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Alfredo's Notes</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/22/react/react相关/mobx使用探微/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">mobx使用探微</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-22T00:00:00+08:00">2018-08-22</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/状态管理/" itemprop="url" rel="index"><span itemprop="name">状态管理</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/08/22/react/react相关/mobx使用探微/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/08/22/react/react相关/mobx使用探微/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>写作这篇文章的起因是我有感于实际项目中所遇到的问题。因此，这篇文章只算是摸索的产物，远未臻于完美。在这里，我谨期望阅读这篇文章的同学能够见仁见智，各洒江海。</p>
<p>我所遇到的问题，总结如下：</p>
<ol>
<li>项目采用分层设计，pages 为视图层，stores 为模型层，services 为服务层。从某种意义上讲，代码是按功能单元进行划分的，而不是业务单元。需要分别从 pages, stores, services 层取出相应的模块，才能构成一个完整的业务单元。分层设计的优点在于代码组织的清晰性，但是降低了可移植性。当需要向第三方应用输出某个业务单元时，就不得不另起炉灶，需要重新为特定的视图组件串联 stores。</li>
<li>无论 stores 层，还是 services 层，代码设计大都以视图为出发点，比如 services 层多次对同一个后台接口实现了调用，比如 stores 混杂着特定页面的视图状态，不利于复用。通过这一点，所能感知的症结是，stores 层中的模块称不上是对数据模型的精要抽象。除此以外，这个病症所体现的另一个特征是，stores 层中的模块常常仅作为视图组件和 ajax 接口的桥接层，即简单地将接口数据灌入到视图中、或者将视图数据提交到远端。这样做的好处是 store 极为轻量，但是，其一，远没有挖掘 mobx 用于组织数据模型的价值（近于使用 redux 处理纯数据），其二，store 没法涵盖数据特征，数据在视图层消费时才能展现其意义。事实上，数据处理中的 value - text 转换也常常会落在视图层。这样，在另一张需要消费同一份数据的视图页面中，就仍需要重做一份数据转换处理。</li>
</ol>
<p>以上种种，促使我在业余时间着意摸索 mobx 的使用。很显然的，需求是技术提升的动力。离开项目环境，仅凭有限的知识和经验储备，我没办法复现实际项目的业务复杂度。相形之下，我所思忖的案例是较为简单的。因此，由这篇文章引出的种种观点无疑都是可商榷的。不过，有什么是一成不变的呢？譬如武侠小说中提到的，“剑招是死的，人是活的”。我再次期望阅读这篇文章的同学对本文所引出的命题有所意会、有所领悟，而对形式上的糟粕持宽容的态度；若是能以丰富的开发经验对我有所指教，那就再好不过了。</p>
<p>备注：示例代码通过自制的 <a href="https://github.com/Alfred-sg/plutarch" target="_blank" rel="noopener">plutarch 脚手架</a> 实现，托管仓库地址为 <a href="https://github.com/Alfred-sg/mobx-demo" target="_blank" rel="noopener">mobx-demo</a> 。</p>
<h2 id="案例前情"><a href="#案例前情" class="headerlink" title="案例前情"></a>案例前情</h2><p>案例将提取商城系统中的产品配置环节，绘制的页面仅包含产品列表页、产品编辑页和产品详情页。介于案例旨在于探讨 mobx 的使用，势必会使业务屈从于所要考量的功能点，一反业务引导开发的常态。我个人的一些看法，在开发已集大成的前提下，由开发引导业务也未尝不是一种选项；系统设计的舵手譬如指挥官，所需的是纵览全局的能力，不扭于认知、经验和职司。假使一位富于远见的开发对多个商城系统的设计和实现已经了然于胸，他又怎不能称为建站工作的主导者呢？只不过这一点对大多数人来说，都过于理想化，很能达成。毕竟职业、天赋和精力的限制，会让我们的成长道路都有所局限。当然，这是题外话。言归正传，本案例涵盖的考察要点包括：</p>
<ol>
<li>适用于多个页面的 Product 商品模型。</li>
<li>互为关联的 Product, Attribute 商品属性模型。</li>
</ol>
<p>以上两点，都是以数据模型为导向的，而不是着眼于页面绘制。从职责来看，前端的工作内容是绘制页面，页面逻辑在部分人眼里只是个子内容。但从整体来看，数据才是内容，视图只是表现。mobx 所提供的强大能力不止于像 redux 那样单纯处理数据流，而在于它通过代理提供了数据建模的可能。如果说 redux 是面向过程编程，那么 mobx 就是面向对象编程。附着的那层响应式操作不改变原有类的特征，使我们能更大程度地使用这个类。这是在响应式之外，使用 mobx 编程时尤其需要有所发现的点。下文将作深入探讨。</p>
<p>当前端的开发工作以数据模型为导向时，就更能契合后端的表结构设计、模型层实现，抽象程度也更高，自然能加深对业务的理解。另外，数据处理也不至于散落在视图层。</p>
<p>对于考察要点中的第二项，所需说明的是案例持有的业务特征。当我们访问淘宝，会发现手机从属于“家电 / 数码 / 手机”这一大类，“手机”这一小类；对于“手机”这一小类，还有诸如”机身内存ROM”，“手机类型”，“网络类型”，“附加功能”，“摄像头类型”，“分辨率”等特有属性。可以料想的是，这些特有属性和“手机”这个小类呈联动关系，即 Attribute 有单独的表设计（特征量和特征值双表）。特别说明这一点，既是为了剖析案例所有的业务特征，也是为了表明案例更大程度上植根于猜想，我并没有参与商城开发的十足经验，错谬也在所难免，期望阅读这篇文章的同学海涵。</p>
<p>简易的表结构设计如下（参考淘宝开放平台的商品接口设计）：</p>
<p><em>图 1，简要表结构</em><br><img src="/2018/08/22/react/react相关/mobx使用探微/database.png"></p>
<p>如上图所示，Product 产品表包含 cids 字段指向 Category 分类表，attrs 字段用于聚合 Attribute 属性特征量表和 Attr_Value 属性特征值表。贴图的表结构虽然难免会有差池，但不妨碍本文用于探讨 mobx 的使用。为了简化案列的复杂度，本文也约定 Category, Attribute, Attr_Value 表中的数据不需要另行制作配置页面注入数据。</p>
<p>基于以上，相应接口如下，相关代码参考托管仓库中的 plutarch.mock.js 文件：</p>
<ol>
<li>get api/category 接口用于获取产品类目，传参 level 用于区分检索大类还是小类，cid 用于锁定产品类目。</li>
<li>get api/attributes 接口用于获取与类目相关的属性，传参 cid 用于锁定产品类目。</li>
<li>post api/product 接口用于保存或更新产品。</li>
<li>get api/product 接口用于获取产品。</li>
<li>get api/products 接口用于获取产品列表。</li>
<li>delete api/product 用于删除产品。</li>
</ol>
<h2 id="案列实现"><a href="#案列实现" class="headerlink" title="案列实现"></a>案列实现</h2><p>案例仍采用分层架构（如何以业务单元形式组织代码暂留作后续的思考命题）：</p>
<p><em>图 2，整体架构</em><br><img src="/2018/08/22/react/react相关/mobx使用探微/architecture.png"></p>
<ol>
<li>requset 模块：基于 aioxs 类库处理 ajax 请求，使用拦截器诊断错误的响应，并使用 antd/message 组件在页面中显示错误内容（该组件能同时展现多个请求错误）。</li>
<li>services 层：使用 class 语法构造，便于继承，同时也继承了 Cache 类，用于缓存比较稳定的接口数据。同时，utils 工具包提供了 mixinStaticProperty 装饰器，用于将 services 层输出类的原型方法注入为 model 类的静态方法，参见 stores/models/Product 类的实现。services 层也可以用于拆分接口，如 services/category 将 getCategory 接口拆分为 getCategoryByCid, getCategoryByLevel 两个接口。这样便于更细微的控制，当然，拆分接口的稳定性另当别论。</li>
<li>stores/models 基本数据模型：数据模型分为两类，一类需要深入数据库或后台模型的数据特征，如 Product 类拥有诸多的可观察属性，便于以方法的形式操作这些属性值的变更，而列表也是由这些类自底而上构成的；另一类则采用数目不多的属性批量更新的机制实现，不需要微操数据的变更，所包含的方法通常也只跟远程请求相关，如 Category, Attribute 类。</li>
<li>stores 层其余衍生数据模型：基于 models 实现，与页面实际交互的模型，如由 Product 类衍生出 ProductInEdit, ProductInDetail, ProductList 三个类，即分别应用于编辑页、详情页和列表页。编辑页和详情页所使用的模型均可拓展 Product 类实现，案列出于职责分离的考虑，将其细分为多个子类。当然，也可以像案列中 Category 类的实现那样，在该类中聚合多种只能，比如全量拉取产品分类数据，以及只拉取针对某个产品的分类数据。同时，为了更好地实现数据处理，Category, Attribute 类均输出实例作为 Product 的实例属性，这样能聚合该产品的分类、属性数据处理操作。</li>
<li>pages 层：当 stores 层通过数据模型承担数据处理操作时，pages 理论上只承担了展示职能。介于 mobx 实现代理数组的特殊性，改变数组项的内部属性只能通过观察该数组项完成，列表操作又需要调用代理数组的方法，才能启动重绘。因此，使用 mobx 注入可观察数据时，首先，组件的颗粒度需要得到细化处理，其次，在删除某个数组项如某个产品时，不禁需要调用 product.delete 方法，也需要调用调用 products.splice 方法，使列表得到重绘。</li>
<li>locales 层：提供国际化文案，使用命名空间拆分成 action, model,text 三大类。action 包含操作类文案，model 包含数据模型相关文案，text 包含标题、消息和普通文本。国际化文案可直接注入视图层，或者经由 model 作转化处理后注入视图层，后者作为 model 的静态属性注入视图层。</li>
</ol>
<p>以下内容将通过代码展示部分实现。</p>
<h3 id="数据缓存"><a href="#数据缓存" class="headerlink" title="数据缓存"></a>数据缓存</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> caches = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 设置数据缓存</span></span><br><span class="line">  setCache(actionName, key, value)&#123;</span><br><span class="line">    <span class="keyword">if</span> ( !caches[actionName] ) caches[actionName] = &#123;&#125;;</span><br><span class="line">    caches[actionName][key] = value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取数据缓存</span></span><br><span class="line">  getCache(actionName, key)&#123;</span><br><span class="line">    <span class="keyword">const</span> cache = caches[actionName];</span><br><span class="line">    <span class="keyword">return</span> cache &amp;&amp; key !== <span class="literal">undefined</span> ? cache[key] : cache;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清除数据缓存</span></span><br><span class="line">  clearCache(actionName)&#123;</span><br><span class="line">    caches[actionName] = <span class="literal">undefined</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryService</span> <span class="keyword">extends</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> getCategory(params)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; cid, level &#125; = params;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ( level !== <span class="literal">undefined</span> ) </span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.getCategoryByLevel(level);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( cid !== <span class="literal">undefined</span> ) </span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.getCategoryByCid(cid);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 在 service 层将 getCategory 拆分成多个针对请求的微处理接口</span></span><br><span class="line">  <span class="comment">// 必要时使用缓存数据</span></span><br><span class="line">  <span class="keyword">async</span> getCategoryByLevel(level)&#123;</span><br><span class="line">    <span class="keyword">let</span> res = <span class="keyword">this</span>.getCache(<span class="string">'getCategoryByLevel'</span>, level);</span><br><span class="line">    <span class="keyword">if</span> ( res ) <span class="keyword">return</span> res;</span><br><span class="line">    </span><br><span class="line">    res = <span class="keyword">await</span> <span class="keyword">get</span>('/api/category', &#123; level &#125;);</span><br><span class="line">    <span class="keyword">this</span>.setCache(<span class="string">'getCategoryByLevel'</span>, level, res);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> getCategoryByCid(cid)&#123;</span><br><span class="line">    <span class="keyword">let</span> res = <span class="keyword">this</span>.getCache(<span class="string">'getCategoryByCid'</span>, cid);</span><br><span class="line">    <span class="keyword">if</span> ( res ) <span class="keyword">return</span> res;</span><br><span class="line"></span><br><span class="line">    res = <span class="keyword">await</span> <span class="keyword">get</span>('/api/category', &#123; cid &#125;);</span><br><span class="line">    <span class="keyword">this</span>.setCache(<span class="string">'getCategoryByCid'</span>, cid, res);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码通过 Cache 类实现数据缓存功能，CategoryService 类继承后，将根据请求内容、原型方法名缓存 ‘/api/category’ 接口的响应数据。同时，getCategory 接口也视页面中的调用情况拆分为 getCategoryByLevel, getCategoryByCid 两个原型方法，也许这是画蛇添足的一个举动，既会使代码不够简易，在后台接口变动时，又会增加额外的修改量，不过却暗含着一种可能，利弊交由阅读这篇文章的同学自行判断。</p>
<p>以上代码存在的优化点：</p>
<ol>
<li>缓存 key 键的兼容度，Cache 类实现上仅能处理有请求参数的情形，而有些可以作缓存的接口没有请求参数。</li>
<li>缓存的时效问题，Cache 类的缓存机制在当前访问过程中均有效，在该时间段无法拉取数据库中已作更改的最新值。</li>
</ol>
<h3 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可采用继承的方式将远程请求方法混入到 Product 类中，此处使用 mixinStaticProperty 装饰器混入静态方法</span></span><br><span class="line">@mixinStaticProperty(ProductService)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line">  @observable id;<span class="comment">// 商品id</span></span><br><span class="line">  @observable name;<span class="comment">// 商品名称</span></span><br><span class="line">  @observable cids;<span class="comment">// 商品分类</span></span><br><span class="line">  @observable attrValues = &#123;&#125;;<span class="comment">// 商品属性</span></span><br><span class="line">  @observable num;<span class="comment">// 库存</span></span><br><span class="line">  @observable price;<span class="comment">// 价格</span></span><br><span class="line">  @observable desc;<span class="comment">// 描述</span></span><br><span class="line">  @observable status;<span class="comment">// 状态</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(props)&#123;</span><br><span class="line">    <span class="keyword">this</span>.setValues(props);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 后台交互数据全量更新；部分更新可直接使用赋值语句；重置可传空</span></span><br><span class="line">  @action</span><br><span class="line">  setValues(data = &#123;&#125;)&#123;</span><br><span class="line">    <span class="keyword">this</span>.id = data.id;</span><br><span class="line">    <span class="keyword">this</span>.name = data.name;</span><br><span class="line">    <span class="keyword">this</span>.cids = data.cids;</span><br><span class="line">    <span class="keyword">this</span>.attrValues = data.attrValues || &#123;&#125;;</span><br><span class="line">    <span class="keyword">this</span>.num = data.num;</span><br><span class="line">    <span class="keyword">this</span>.price = data.price;</span><br><span class="line">    <span class="keyword">this</span>.desc = data.desc;</span><br><span class="line">    <span class="keyword">this</span>.status = data.status;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取后台交互数据</span></span><br><span class="line">  getValues()&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      id: <span class="keyword">this</span>.id,</span><br><span class="line">      name: <span class="keyword">this</span>.name,</span><br><span class="line">      cids: <span class="keyword">this</span>.cids,</span><br><span class="line">      attrValues: <span class="keyword">this</span>.attrValues,</span><br><span class="line">      num: <span class="keyword">this</span>.num,</span><br><span class="line">      price: <span class="keyword">this</span>.price,</span><br><span class="line">      desc: <span class="keyword">this</span>.desc,</span><br><span class="line">      status: <span class="keyword">this</span>.status</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  @action</span><br><span class="line">  <span class="keyword">async</span> getProduct(id)&#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> Product.get(&#123; id &#125;);</span><br><span class="line">    <span class="keyword">if</span> ( res ) <span class="keyword">this</span>.setValues(res);</span><br><span class="line">    <span class="keyword">return</span> res || <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  @action</span><br><span class="line">  <span class="keyword">async</span> saveProduct()&#123;</span><br><span class="line">    <span class="keyword">const</span> params = <span class="keyword">this</span>.getValues();</span><br><span class="line">    <span class="keyword">const</span> res = params.id ? <span class="keyword">await</span> Product.update(params) : <span class="keyword">await</span> Product.save(params);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  @action</span><br><span class="line">  <span class="keyword">async</span> deleteProduct()&#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> Product.del(&#123; <span class="attr">id</span>: <span class="keyword">this</span>.id &#125;);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码为 Product 基类，可以看出，实现上同后台提供的接口和数据模型均强关联，其一通过 observable 装饰器将后台提供的字段全部转化为可观察属性，并提供 setValues, getValues 批量赋值和取值（通常在提交数据前、获取数据后，需要调用这两个方法）；其二以原型方法实现 ajax 调用，这里既可以继承 services 层中的类，也可以使用 mixinStaticProperty 装饰器注入静态方法。</p>
<p>Product 基类化用了 backbone 模型特征，可以优化的点：</p>
<ol>
<li>代码自动生成。通过 Product 基类也能发现，该类数据模型拥有很高的类同点，基于后台数据模型及接口实现 mobx 数据模型基类，如果能根据 jar 包和配置文件，自动生成这些基类文件，那就再好不过了。当然，这对我来说，也是短期内没法办到的事。需要走的路还长着呢。</li>
<li>案列中没有考虑两份提交数据，多个接口调用，比如产品状态更新，就需要多一份产品状态提交数据，再调用状态更新的接口。因此，我的一些想法还没经过实践沉淀，合理性和稳定性势必存疑，比如前一条优化建议。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductInDetail</span> <span class="keyword">extends</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line">  attribute = <span class="keyword">new</span> Attribute();</span><br><span class="line">  category = <span class="keyword">new</span> Category();</span><br><span class="line"></span><br><span class="line">  @observable categories = [];<span class="comment">// 商品分类全量信息</span></span><br><span class="line">  @observable attributes = [];<span class="comment">// 商品属性全量信息</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 备注，改变单个数组项的属性不会引起视图重绘，必须在数组中改变整个数组项</span></span><br><span class="line">  <span class="comment">// 在 product 实例初始化过程中调用 getCategories 方法，不会引起 Table 视图的重绘</span></span><br><span class="line">  @action</span><br><span class="line">  <span class="keyword">async</span> getCategories(cids)&#123;</span><br><span class="line">    <span class="keyword">this</span>.categories = [];</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">this</span>.category.getCategoryByCids(cids);</span><br><span class="line">    <span class="keyword">if</span> ( res ) <span class="keyword">this</span>.categories = res;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取商品分类文案</span></span><br><span class="line">  @computed</span><br><span class="line">  <span class="keyword">get</span> categoryTexts()&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.categories.map(<span class="function"><span class="params">item</span> =&gt;</span> item.name).join(<span class="string">', '</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取属性</span></span><br><span class="line">  @action</span><br><span class="line">  <span class="keyword">async</span> getAttributes(cid)&#123;</span><br><span class="line">    <span class="keyword">this</span>.attributes = [];</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">this</span>.attribute.getAttributes(&#123; cid  &#125;);</span><br><span class="line">    <span class="keyword">if</span> ( res ) <span class="keyword">this</span>.attributes = res;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @computed</span><br><span class="line">  <span class="keyword">get</span> attributeTexts()&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; attrValues, attributes &#125; = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">Object</span>.keys(attrValues).length || !attributes.length ) <span class="keyword">return</span> [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> result = [];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Object</span>.keys(attrValues).map(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> attr = attributes.find(<span class="function"><span class="params">attr</span> =&gt;</span> attr.id == key);</span><br><span class="line">      <span class="keyword">const</span> name = attr.name;</span><br><span class="line">      <span class="keyword">let</span> value = attrValues[key].map(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> attr.options.find(<span class="function"><span class="params">item</span> =&gt;</span> item.id == val).name;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      result.push(&#123;</span><br><span class="line">        name,</span><br><span class="line">        value</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取商品状态文案</span></span><br><span class="line">  @computed</span><br><span class="line">  <span class="keyword">get</span> statusText()&#123;</span><br><span class="line">    <span class="keyword">let</span> text = StatusList.filter(<span class="function"><span class="params">item</span> =&gt;</span> item.value === <span class="keyword">this</span>.status)[<span class="number">0</span>].text;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> text;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductInEdit</span> <span class="keyword">extends</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line">  attribute = <span class="keyword">new</span> Attribute();</span><br><span class="line"></span><br><span class="line">  @observable attributes = [];<span class="comment">// 商品属性全量信息</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取属性</span></span><br><span class="line">  @action</span><br><span class="line">  <span class="keyword">async</span> getAttributes(cid)&#123;</span><br><span class="line">    <span class="keyword">this</span>.attributes = [];</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">this</span>.attribute.getAttributes(&#123; cid  &#125;);</span><br><span class="line">    <span class="keyword">if</span> ( res ) <span class="keyword">this</span>.attributes = res;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 编辑页显示数据</span></span><br><span class="line">  @computed</span><br><span class="line">  <span class="keyword">get</span> pageValues()&#123;</span><br><span class="line">    <span class="keyword">let</span> attrValues = &#123;&#125;;</span><br><span class="line">    <span class="built_in">Object</span>.keys(<span class="keyword">this</span>.attrValues).map(<span class="function"><span class="params">attrId</span> =&gt;</span> &#123;</span><br><span class="line">      attrValues[<span class="string">`attrId<span class="subst">$&#123;attrId&#125;</span>`</span>] = <span class="keyword">this</span>.attrValues[attrId];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      name: <span class="keyword">this</span>.name,</span><br><span class="line">      cids: <span class="keyword">this</span>.cids,</span><br><span class="line">      attrs: attrValues,</span><br><span class="line">      num: <span class="keyword">this</span>.num,</span><br><span class="line">      price: <span class="keyword">this</span>.price,</span><br><span class="line">      desc: <span class="keyword">this</span>.desc</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码基于 Product 类实现详情页、编辑页专用的数据模型，无非获取远程数据，进行 value - name 值转换。在获取远程数据时，可以将另一个数据模型以实例属性的方式注入到当前数据模型中，以便于在当前模型中作数据转换处理，同时增加了模型之间的耦合度。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductList</span> </span>&#123;</span><br><span class="line">  @observable products = [];</span><br><span class="line">  </span><br><span class="line">  @action</span><br><span class="line">  <span class="keyword">async</span> getProducts()&#123;</span><br><span class="line">    <span class="keyword">this</span>.products = [];</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> Product.query();</span><br><span class="line">    (res || []).map(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.products.push(<span class="keyword">new</span> Product(item));<span class="comment">// 此处 Product 为 ProductInDetail</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ProductList 类基于 ProductInDetail 实例构建数组项，以便于在视图层绘制列表时直接绘制 ProductInDetail 实例的计算属性或者调用其远程请求接口。</p>
<h3 id="并行请求"><a href="#并行请求" class="headerlink" title="并行请求"></a>并行请求</h3><p>并行请求可以在视图层通过 Promise.all 加以组织，也可以在模型层组织同一类并行请求接口，如 Category 模型中通过 getCategoryByCids 方法获取产品的多个类目信息。当然，这部分内容通常由后端同学帮忙完成，这里仅展示前端代码实现上的一种可能。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Category</span> <span class="keyword">extends</span> <span class="title">CategoryService</span> </span>&#123;</span><br><span class="line">  @observable categories = [];</span><br><span class="line"></span><br><span class="line">  @action</span><br><span class="line">  insertToCategories = <span class="function">(<span class="params">category = &#123;&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="keyword">this</span>.categories.some(<span class="function"><span class="params">item</span> =&gt;</span> item.id == category.id) )&#123;</span><br><span class="line">      <span class="keyword">this</span>.categories.push(category);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> getCategory(params)&#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">super</span>.getCategory(params);</span><br><span class="line">    <span class="keyword">if</span> ( res )&#123;</span><br><span class="line">      <span class="comment">// 将多次数据变更合成一个事务，减少重绘的次数</span></span><br><span class="line">      transaction(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        res.map(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">this</span>.insertToCategories(item);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理并行请求</span></span><br><span class="line">  getCategoryByCids(cids)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.categories = [];</span><br><span class="line">  </span><br><span class="line">      cids.map(<span class="keyword">async</span> cid =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">this</span>.getCategory(&#123; cid &#125;);</span><br><span class="line">        <span class="keyword">if</span> ( !res ) reject(res);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 最后一个请求，响应通过 insertToCategories 方法收集到 categories 属性中</span></span><br><span class="line">        <span class="keyword">if</span> ( cids.length == <span class="keyword">this</span>.categories.length ) </span><br><span class="line">          resolve(<span class="keyword">this</span>.categories);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 传入 cids，便于并行请求</span></span><br><span class="line">  getCategoryByLevels(cids)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      cids.map(<span class="keyword">async</span> (cid, index) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">this</span>.getCategory(&#123; <span class="attr">level</span>: index + <span class="number">1</span> &#125;);</span><br><span class="line">        <span class="keyword">if</span> ( !res ) reject(res);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( index + <span class="number">1</span> === cids.length ) resolve(<span class="keyword">this</span>.categories);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @computed</span><br><span class="line">  <span class="keyword">get</span> categoriesTree()&#123;</span><br><span class="line">    <span class="keyword">let</span> tree = [];</span><br><span class="line">    <span class="keyword">this</span>.categories.toJS().sort(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a.level - b.level).filter(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> ( item.level == <span class="number">1</span> )&#123;</span><br><span class="line">        tree.push(&#123;</span><br><span class="line">          value: item.id,</span><br><span class="line">          label: item.name,</span><br><span class="line">          isLeaf: <span class="literal">false</span></span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( item.level == <span class="number">2</span> )&#123;</span><br><span class="line">        <span class="keyword">let</span> parent = tree.filter(<span class="function"><span class="params">it</span> =&gt;</span> it.value == item.parentId)[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> ( !parent.children ) parent.children = [];</span><br><span class="line">        parent.children.push(&#123;</span><br><span class="line">          value: item.id,</span><br><span class="line">          label: item.name</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tree;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="视图组件"><a href="#视图组件" class="headerlink" title="视图组件"></a>视图组件</h3><p>组件层即如上文所说的，所需注意的是 mobx 中数组的特殊性，单纯赋值数组项的属性不会引起观察数组的组件重绘，而需要将组件的颗粒度锁定为观察数组项，如下方代码的 CategoryText 组件。删除数组项时，也需要调用代理数组的 splice 方法，才能引起列表组件重绘，如 ProductList 组件内 deleteProduct 方法的实现。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">@observer</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryText</span> <span class="keyword">extends</span> <span class="title">Component</span></span>&#123;</span><br><span class="line">  componentDidMount()&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; product, loadCategory &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">if</span> ( loadCategory ) product.getCategories(product.cids);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render()&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; product &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">return</span> product.categoryTexts;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">@inject(<span class="string">'productList'</span>)</span><br><span class="line">@observer</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductList</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  columns = [&#123;</span><br><span class="line">    title: $i18n(<span class="string">'model.product.id'</span>),</span><br><span class="line">    dataIndex: <span class="string">'id'</span>,</span><br><span class="line">    key: <span class="string">'id'</span></span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    title: $i18n(<span class="string">'model.product.name'</span>),</span><br><span class="line">    dataIndex: <span class="string">'name'</span>,</span><br><span class="line">    key: <span class="string">'name'</span>,</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    title: $i18n(<span class="string">'model.product.categories'</span>),</span><br><span class="line">    dataIndex: <span class="string">'categories'</span>,</span><br><span class="line">    key: <span class="string">'categories'</span>,</span><br><span class="line">    render: <span class="function">(<span class="params">categories, product</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">CategoryText</span> <span class="attr">product</span>=<span class="string">&#123;product&#125;</span> <span class="attr">loadCategory</span>=<span class="string">&#123;true&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">    &#125;</span></span><br><span class="line"><span class="xml">  &#125;, &#123;</span></span><br><span class="line"><span class="xml">    title: $i18n('model.product.price'),</span></span><br><span class="line"><span class="xml">    dataIndex: 'price',</span></span><br><span class="line"><span class="xml">    key: 'price'</span></span><br><span class="line"><span class="xml">  &#125;, &#123;</span></span><br><span class="line"><span class="xml">    title: $i18n('model.product.num'),</span></span><br><span class="line"><span class="xml">    dataIndex: 'num',</span></span><br><span class="line"><span class="xml">    key: 'num'</span></span><br><span class="line"><span class="xml">  &#125;, &#123;</span></span><br><span class="line"><span class="xml">    title: $i18n('model.product.status'),</span></span><br><span class="line"><span class="xml">    dataIndex: 'statusText',</span></span><br><span class="line"><span class="xml">    key: 'statusText'</span></span><br><span class="line"><span class="xml">  &#125;, &#123;</span></span><br><span class="line"><span class="xml">    title: $i18n('model.product.desc'),</span></span><br><span class="line"><span class="xml">    dataIndex: 'desc',</span></span><br><span class="line"><span class="xml">    key: 'desc'</span></span><br><span class="line"><span class="xml">  &#125;, &#123;</span></span><br><span class="line"><span class="xml">    title: $i18n('action.handle'),</span></span><br><span class="line"><span class="xml">    key: 'action',</span></span><br><span class="line"><span class="xml">    render: (text, product, index) =&gt; (</span></span><br><span class="line">      &lt;span&gt;</span><br><span class="line">        &lt;Link to=&#123;`/detail/$&#123;product.id&#125;`&#125; style=&#123;&#123;marginRight: '10px'&#125;&#125;&gt;&#123;$i18n('text.detail')&#125;&lt;/Link&gt;</span><br><span class="line">        &lt;Link to=&#123;`/edit/$&#123;product.id&#125;`&#125; style=&#123;&#123;marginRight: '10px'&#125;&#125;&gt;&#123;$i18n('action.edit')&#125;&lt;/Link&gt;</span><br><span class="line">        &lt;Popconfirm title=&#123;$i18n('text.product.delete_confirm')&#125; </span><br><span class="line">          onConfirm=&#123;() =&gt; &#123; this.deleteProduct(product, index) &#125;&#125; </span><br><span class="line">          okText=&#123;$i18n('action.ok')&#125; cancelText=&#123;$i18n('action.cancel')&#125;&gt;</span><br><span class="line">          &lt;a href="javascript:;"&gt;&#123;$i18n('action.delete')&#125;&lt;/a&gt;</span><br><span class="line">        &lt;/Popconfirm&gt;</span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">    ),</span></span><br><span class="line"><span class="xml">  &#125;];</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  componentDidMount()&#123;</span></span><br><span class="line"><span class="xml">    this.props.productList.getProducts();</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  // 删除商品</span></span><br><span class="line"><span class="xml">  deleteProduct = async (product, index) =&gt; &#123;</span></span><br><span class="line"><span class="xml">    const &#123; products &#125; = this.props.productList;</span></span><br><span class="line"><span class="xml">    const res = await product.deleteProduct();</span></span><br><span class="line"><span class="xml">    if ( res )&#123;</span></span><br><span class="line"><span class="xml">      products.splice(index);</span></span><br><span class="line"><span class="xml">      message.success($i18n('text.product.delete_success'));</span></span><br><span class="line"><span class="xml">    &#125;;</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  render()&#123;</span></span><br><span class="line"><span class="xml">    const &#123; products &#125; = this.props.productList;</span></span><br><span class="line"><span class="xml">    </span></span><br><span class="line"><span class="xml">    return (</span></span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Button style=&#123;&#123;marginBottom: '15px'&#125;&#125; type='primary'&gt;</span><br><span class="line">          &lt;Link to=&#123;'/create'&#125;&gt;&#123;`$&#123;$i18n('action.create')&#125;$&#123;$i18n('text.product')&#125;`&#125;&lt;/Link&gt;</span><br><span class="line">        &lt;/Button&gt;</span><br><span class="line">        &lt;Table size="small" rowKey='id' columns=&#123;this.columns&#125; dataSource=&#123;products.toJS()&#125; /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>更多代码，请参考 <a href="https://github.com/Alfred-sg/mobx-demo" target="_blank" rel="noopener">mobx-demo</a>，也许阅读这篇文章的同学能有额外的发现呢。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>《唐李问对》褒扬诸葛亮而贬低曹操，因为曹操的《孟德新书》适合于照章办事的生手，诸葛亮的《兵法二十篇》适合于独立思考的老手。其中的事理，和吴军博士在《数学之美》中论述道与术一样，浮于浅层的形式抵不过深入的理解。这是一篇富有探索气质的文章，更多地旨在于引发思考，而不是妄下定论。何况这篇文章对于 mobx 的使用及其实现内核的化用，也只是迈出了小小的一两步。要走的路还长着呢。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://open.taobao.com/doc.htm?docId=73&amp;docType=1" target="_blank" rel="noopener">淘宝开放平台 - 文档中心</a><br><a href="https://blog.csdn.net/crazzy0727/article/details/59576713" target="_blank" rel="noopener">淘宝商品数据库设计</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/analyst/" rel="tag"># analyst</a>
          
            <a href="/tags/react/" rel="tag"># react</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/08/15/react/react相关/mobx源码分析2/" rel="next" title="mobx源码分析（二） 订阅响应式数据">
                <i class="fa fa-chevron-left"></i> mobx源码分析（二） 订阅响应式数据
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/09/11/工程化/前端构建工具dawn/" rel="prev" title="前端构建工具 dawn 不完全解密">
                前端构建工具 dawn 不完全解密 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpeg" alt="Alfred">
            
              <p class="site-author-name" itemprop="name">Alfred</p>
              <p class="site-description motion-element" itemprop="description">人苦不知足，既得陇，复望蜀</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">125</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    <span class="site-state-item-count">37</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    <span class="site-state-item-count">26</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Alfred-sg" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/xiu-fan-79/activities" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-globe"></i>知乎</a>
                  </span>
                
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#案例前情"><span class="nav-number">2.</span> <span class="nav-text">案例前情</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#案列实现"><span class="nav-number">3.</span> <span class="nav-text">案列实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#数据缓存"><span class="nav-number">3.1.</span> <span class="nav-text">数据缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据模型"><span class="nav-number">3.2.</span> <span class="nav-text">数据模型</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#并行请求"><span class="nav-number">3.3.</span> <span class="nav-text">并行请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#视图组件"><span class="nav-number">3.4.</span> <span class="nav-text">视图组件</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#后记"><span class="nav-number">4.</span> <span class="nav-text">后记</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#参考"><span class="nav-number">5.</span> <span class="nav-text">参考</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Alfred</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Pisces</a> v6.0.2</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.0.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.0.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.0.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.2"></script>



  

  
    <script id="dsq-count-scr" src="https://alfred.disqus.com/count.js" async></script>
  

  
    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = 'http://yoursite.com/2018/08/22/react/react相关/mobx使用探微/';
        this.page.identifier = '2018/08/22/react/react相关/mobx使用探微/';
        this.page.title = 'mobx使用探微';
      };
      function loadComments () {
        var d = document, s = d.createElement('script');
        s.src = 'https://alfred.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      }
      
        loadComments();
      
    </script>
  





	





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->





  

  

  

  

  
  

  

  

  

  

</body>
</html>
