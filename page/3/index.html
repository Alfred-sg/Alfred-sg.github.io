<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.2" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.2">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.2" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.0.2',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="Hexo, NexT" />


<meta name="description" content="人苦不知足，既得陇，复望蜀">
<meta property="og:type" content="website">
<meta property="og:title" content="修子范语">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="修子范语">
<meta property="og:description" content="人苦不知足，既得陇，复望蜀">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="修子范语">
<meta name="twitter:description" content="人苦不知足，既得陇，复望蜀">






  <link rel="canonical" href="http://yoursite.com/page/3/"/>


  <title>修子范语</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">修子范语</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Alfredo's Notes</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
        </li>
      

      
    </ul>
  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/01/antd/react-component/rc-animate/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/01/antd/react-component/rc-animate/" itemprop="url">rc-animate</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-01T00:00:00+08:00">2019-01-01</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/antd-组件库/" itemprop="url" rel="index"><span itemprop="name">antd 组件库</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/01/01/antd/react-component/rc-animate/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2019/01/01/antd/react-component/rc-animate/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>rc-animate 同 <a href="https://github.com/reactjs/react-transition-group" target="_blank" rel="noopener">react-transition-group</a>，都用于实现元素的移入移出动效。rc-animate 提供两种动效处理方式，Animate 组件用于处理多元素的移入移出动效，包含 css 和 js 动效；CSSMotion 用于处理单元素的动效，只能处理 css 动效。本文第一部分将介绍 Animate 组件；第二部分将介绍 CSSMotion 组件。</p>
<h2 id="Animate"><a href="#Animate" class="headerlink" title="Animate"></a>Animate</h2><img src="/2019/01/01/antd/react-component/rc-animate/动效视图特征.png">
<p>上图即为多元素移入移出动效的视图特征：</p>
<ol>
<li>child1, child3 元素初始化即显现在视图中，该过程将呈现 appear 动效。</li>
<li>child2 元素在下一个渲染过程中将移入视图，该过程将呈现 enter 动效。</li>
<li>child3 元素在下一个渲染过程中将移出视图，该过程将呈现 leave 动效。</li>
</ol>
<p>因为动效有时延，我们需要致力于解决如下问题：</p>
<ol>
<li>若 child2 在 child1 元素的 appear 动效还未完成时移入，child1 需要继续执行 appear 动效。对此，我们可以用内部状态记录动效执行中的元素，从而不打断动效的执行过程。若 child2 元素的 enter 动效执行期间，视图中再添加 child4, child5，也作相同处理。</li>
<li>若 child3 即将移出视图，先将 child3 保存在内部状态中，等 leave 动效执行完成后，再移除 child3。</li>
</ol>
<p>在 rc-animate 中，上述两个状态表现为 Animate 组件的 currentlyAnimatingKeys 实例属性和 state.children。在 Animate 的 componentWillReceiveProps 生命周期中，将通过 currentlyAnimatingKeys 判断动效是否还在执行阶段，以便在 state.children 中保留该元素。当然，在 componentWillReceiveProps 生命周期，主要的处理逻辑为：根据元素移入移出视图情况更新 state.children，并使用 keysToEnter, keysToLeave 属性记录哪些元素需要执行 enter 或者 leave 动效。对问题 2 的解答也就是在动效完成后更新 state.children。</p>
<p>我们可以将 Animate 看成是动效调节器。不计 enter 动效，Animate 首先将在 componentWillReceiveProps 生命周期计算 child 元素需要执行何种动效，然后在 componentDidUpdate 生命周期执行该动效。实际执行的动效与 child 元素挂钩，那样就可以支持不同元素的展示动效多样化。在 rc-animate 中，AnimateChild 就可以理解成不同元素的动效驱动器。通过 props 定义 child 待执行的动效，由 AnimateChild 提供 componentWillAppear, componentWillEnter, componentWillLeave 方法执行具体的动效，且与 Animate 完成对接。AnimateChild 和 Animate 对接表现为，在 Animate 的 componentDidUpdate 生命周期，最终将调用 AnimateChild 的上述方法。下图是 rc-animate 动效执行的时序图。</p>
<img src="/2019/01/01/antd/react-component/rc-animate/rc-animate时序图.png">
<h3 id="Animate-1"><a href="#Animate-1" class="headerlink" title="Animate"></a>Animate</h3><p>作为动效调节器，Animate 组件用于控制全局层面的动效特征。Animate 以 currentlyAnimatingKeys 实例属性记录正在执行动效的元素；keysToEnter, keysToLeave 实例属性记录待显示隐藏的元素；并在动效执行前后通过更新 state.children 的方式控制子元素的渲染状况；在此过程中，将在动效完成后的回调中执行全局意义的绑定函数，如 props.onAppear, props.onEnter, prop.onLeave, props.onEnd 方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animate</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * didMount 生命周期执行子元素的 appear 动效</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">const</span> showProp = <span class="keyword">this</span>.props.showProp;</span><br><span class="line">    <span class="keyword">let</span> children = <span class="keyword">this</span>.state.children;</span><br><span class="line">    <span class="keyword">if</span> (showProp) &#123;</span><br><span class="line">      children = children.filter(<span class="function">(<span class="params">child</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> !!child.props[showProp];</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    children.forEach(<span class="function">(<span class="params">child</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (child) &#123;</span><br><span class="line">        <span class="keyword">this</span>.performAppear(child.key);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * componentWillReceiveProps 生命周期感知子元素的显示状态变更</span></span><br><span class="line"><span class="comment">   *  1. 更新 state.children 显示子元素以执行 enter, leave 动效</span></span><br><span class="line"><span class="comment">   *  2. 以 this.keysToEnter, this.keysToLeave 收集待执行 enter, leave 动效的元素</span></span><br><span class="line"><span class="comment">   *     以便在 componentDidUpdate 实际执行动效；在动效执行完成后，触发回调显示或移除视图上的子元素</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  componentWillReceiveProps(nextProps) &#123;</span><br><span class="line">    <span class="keyword">this</span>.nextProps = nextProps;</span><br><span class="line">    <span class="keyword">const</span> nextChildren = toArrayChildren(getChildrenFromProps(nextProps));</span><br><span class="line">    <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="comment">// exclusive needs immediate response</span></span><br><span class="line">    <span class="keyword">if</span> (props.exclusive) &#123;</span><br><span class="line">      <span class="built_in">Object</span>.keys(<span class="keyword">this</span>.currentlyAnimatingKeys).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.stop(key);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> showProp = props.showProp;</span><br><span class="line">    <span class="keyword">const</span> currentlyAnimatingKeys = <span class="keyword">this</span>.currentlyAnimatingKeys;</span><br><span class="line">    <span class="comment">// last props children if exclusive</span></span><br><span class="line">    <span class="keyword">const</span> currentChildren = props.exclusive ?</span><br><span class="line">      toArrayChildren(getChildrenFromProps(props)) :</span><br><span class="line">      <span class="keyword">this</span>.state.children;</span><br><span class="line">    <span class="comment">// in case destroy in showProp mode</span></span><br><span class="line">    <span class="keyword">let</span> newChildren = [];</span><br><span class="line">    <span class="keyword">if</span> (showProp) &#123;</span><br><span class="line">      currentChildren.forEach(<span class="function">(<span class="params">currentChild</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> nextChild = currentChild &amp;&amp; findChildInChildrenByKey(nextChildren, currentChild.key);</span><br><span class="line">        <span class="keyword">let</span> newChild;</span><br><span class="line">        <span class="keyword">if</span> ((!nextChild || !nextChild.props[showProp]) &amp;&amp; currentChild.props[showProp]) &#123;</span><br><span class="line">          newChild = React.cloneElement(nextChild || currentChild, &#123;</span><br><span class="line">            [showProp]: <span class="literal">true</span>,</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          newChild = nextChild;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (newChild) &#123;</span><br><span class="line">          newChildren.push(newChild);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      nextChildren.forEach(<span class="function">(<span class="params">nextChild</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!nextChild || !findChildInChildrenByKey(currentChildren, nextChild.key)) &#123;</span><br><span class="line">          newChildren.push(nextChild);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      newChildren = mergeChildren(</span><br><span class="line">        currentChildren,</span><br><span class="line">        nextChildren</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// need render to avoid update</span></span><br><span class="line">    <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">      children: newChildren,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    nextChildren.forEach(<span class="function">(<span class="params">child</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> key = child &amp;&amp; child.key;</span><br><span class="line">      <span class="keyword">if</span> (child &amp;&amp; currentlyAnimatingKeys[key]) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> hasPrev = child &amp;&amp; findChildInChildrenByKey(currentChildren, key);</span><br><span class="line">      <span class="keyword">if</span> (showProp) &#123;</span><br><span class="line">        <span class="keyword">const</span> showInNext = child.props[showProp];</span><br><span class="line">        <span class="keyword">if</span> (hasPrev) &#123;</span><br><span class="line">          <span class="keyword">const</span> showInNow = findShownChildInChildrenByKey(currentChildren, key, showProp);</span><br><span class="line">          <span class="keyword">if</span> (!showInNow &amp;&amp; showInNext) &#123;</span><br><span class="line">            <span class="keyword">this</span>.keysToEnter.push(key);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (showInNext) &#123;</span><br><span class="line">          <span class="keyword">this</span>.keysToEnter.push(key);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!hasPrev) &#123;</span><br><span class="line">        <span class="keyword">this</span>.keysToEnter.push(key);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    currentChildren.forEach(<span class="function">(<span class="params">child</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> key = child &amp;&amp; child.key;</span><br><span class="line">      <span class="keyword">if</span> (child &amp;&amp; currentlyAnimatingKeys[key]) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> hasNext = child &amp;&amp; findChildInChildrenByKey(nextChildren, key);</span><br><span class="line">      <span class="keyword">if</span> (showProp) &#123;</span><br><span class="line">        <span class="keyword">const</span> showInNow = child.props[showProp];</span><br><span class="line">        <span class="keyword">if</span> (hasNext) &#123;</span><br><span class="line">          <span class="keyword">const</span> showInNext = findShownChildInChildrenByKey(nextChildren, key, showProp);</span><br><span class="line">          <span class="keyword">if</span> (!showInNext &amp;&amp; showInNow) &#123;</span><br><span class="line">            <span class="keyword">this</span>.keysToLeave.push(key);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (showInNow) &#123;</span><br><span class="line">          <span class="keyword">this</span>.keysToLeave.push(key);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!hasNext) &#123;</span><br><span class="line">        <span class="keyword">this</span>.keysToLeave.push(key);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * componentDidUpdate 生命周期执行子元素的 enter, leave 动效</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  componentDidUpdate() &#123;</span><br><span class="line">    <span class="keyword">const</span> keysToEnter = <span class="keyword">this</span>.keysToEnter;</span><br><span class="line">    <span class="keyword">this</span>.keysToEnter = [];</span><br><span class="line">    keysToEnter.forEach(<span class="keyword">this</span>.performEnter);</span><br><span class="line">    <span class="keyword">const</span> keysToLeave = <span class="keyword">this</span>.keysToLeave;</span><br><span class="line">    <span class="keyword">this</span>.keysToLeave = [];</span><br><span class="line">    keysToLeave.forEach(<span class="keyword">this</span>.performLeave);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 实际调用 AnimateChild 组件的 componentWillEnter 方法执行动效</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  performEnter = <span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// may already remove by exclusive</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.childrenRefs[key]) &#123;</span><br><span class="line">      <span class="keyword">this</span>.currentlyAnimatingKeys[key] = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">this</span>.childrenRefs[key].componentWillEnter(</span><br><span class="line">        <span class="keyword">this</span>.handleDoneAdding.bind(<span class="keyword">this</span>, key, <span class="string">'enter'</span>)</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  performAppear = <span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.childrenRefs[key]) &#123;</span><br><span class="line">      <span class="keyword">this</span>.currentlyAnimatingKeys[key] = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">this</span>.childrenRefs[key].componentWillAppear(</span><br><span class="line">        <span class="keyword">this</span>.handleDoneAdding.bind(<span class="keyword">this</span>, key, <span class="string">'appear'</span>)</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * enter, appear 动效执行完成后的回调</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  handleDoneAdding = <span class="function">(<span class="params">key, type</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">delete</span> <span class="keyword">this</span>.currentlyAnimatingKeys[key];</span><br><span class="line">    <span class="comment">// if update on exclusive mode, skip check</span></span><br><span class="line">    <span class="keyword">if</span> (props.exclusive &amp;&amp; props !== <span class="keyword">this</span>.nextProps) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> currentChildren = toArrayChildren(getChildrenFromProps(props));</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.isValidChildByKey(currentChildren, key)) &#123;</span><br><span class="line">      <span class="comment">// exclusive will not need this</span></span><br><span class="line">      <span class="keyword">this</span>.performLeave(key);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">'appear'</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (animUtil.allowAppearCallback(props)) &#123;</span><br><span class="line">        props.onAppear(key);</span><br><span class="line">        props.onEnd(key, <span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (animUtil.allowEnterCallback(props)) &#123;</span><br><span class="line">      props.onEnter(key);</span><br><span class="line">      props.onEnd(key, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  performLeave = <span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// may already remove by exclusive</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.childrenRefs[key]) &#123;</span><br><span class="line">      <span class="keyword">this</span>.currentlyAnimatingKeys[key] = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">this</span>.childrenRefs[key].componentWillLeave(<span class="keyword">this</span>.handleDoneLeaving.bind(<span class="keyword">this</span>, key));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleDoneLeaving = <span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">delete</span> <span class="keyword">this</span>.currentlyAnimatingKeys[key];</span><br><span class="line">    <span class="comment">// if update on exclusive mode, skip check</span></span><br><span class="line">    <span class="keyword">if</span> (props.exclusive &amp;&amp; props !== <span class="keyword">this</span>.nextProps) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> currentChildren = toArrayChildren(getChildrenFromProps(props));</span><br><span class="line">    <span class="comment">// in case state change is too fast</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.isValidChildByKey(currentChildren, key)) &#123;</span><br><span class="line">      <span class="keyword">this</span>.performEnter(key);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> end = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (animUtil.allowLeaveCallback(props)) &#123;</span><br><span class="line">          props.onLeave(key);</span><br><span class="line">          props.onEnd(key, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">if</span> (!isSameChildren(<span class="keyword">this</span>.state.children,</span><br><span class="line">        currentChildren, props.showProp)) &#123;</span><br><span class="line">        <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">          children: currentChildren,</span><br><span class="line">        &#125;, end);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        end();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">this</span>.nextProps = props;</span><br><span class="line">    <span class="keyword">const</span> stateChildren = <span class="keyword">this</span>.state.children;</span><br><span class="line">    <span class="keyword">let</span> children = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (stateChildren) &#123;</span><br><span class="line">      children = stateChildren.map(<span class="function">(<span class="params">child</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (child === <span class="literal">null</span> || child === <span class="literal">undefined</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> child;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!child.key) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'must set key for &lt;rc-animate&gt; children'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">          &lt;AnimateChild</span><br><span class="line">            key=&#123;child.key&#125;</span><br><span class="line">            ref=&#123;node =&gt; &#123; <span class="keyword">this</span>.childrenRefs[child.key] = node &#125;&#125;</span><br><span class="line">            animation=&#123;props.animation&#125;</span><br><span class="line">            transitionName=&#123;props.transitionName&#125;</span><br><span class="line">            transitionEnter=&#123;props.transitionEnter&#125;</span><br><span class="line">            transitionAppear=&#123;props.transitionAppear&#125;</span><br><span class="line">            transitionLeave=&#123;props.transitionLeave&#125;</span><br><span class="line">          &gt;</span><br><span class="line">            &#123;child&#125;</span><br><span class="line">          &lt;<span class="regexp">/AnimateChild&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">      &#125;);</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    const Component = props.component;</span></span><br><span class="line"><span class="regexp">    if (Component) &#123;</span></span><br><span class="line"><span class="regexp">      let passedProps = props;</span></span><br><span class="line"><span class="regexp">      if (typeof Component === 'string') &#123;</span></span><br><span class="line"><span class="regexp">        passedProps = &#123;</span></span><br><span class="line"><span class="regexp">          className: props.className,</span></span><br><span class="line"><span class="regexp">          style: props.style,</span></span><br><span class="line"><span class="regexp">          ...props.componentProps,</span></span><br><span class="line"><span class="regexp">        &#125;;</span></span><br><span class="line"><span class="regexp">      &#125;</span></span><br><span class="line"><span class="regexp">      return &lt;Component &#123;...passedProps&#125;&gt;&#123;children&#125;&lt;/</span>Component&gt;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> children[<span class="number">0</span>] || <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AnimateChild"><a href="#AnimateChild" class="headerlink" title="AnimateChild"></a>AnimateChild</h3><p>如上文所说，AnimateChild 组件用于实现元素的具体动效。支持的动效包含 css3 动效和 js 动效。其中，css3 动效通过 props.transitionName, props.transitionEnter, props.transitionAppear, props.transitionLeave 属性加以配置；js 动效通过 props.animation 动效方法集 { appear?, enter?, leave? } 加以配置，动效可使用 jQuery 操作节点的方式实现。AnimateChild 组件接受的 props 属性均由用户端通过 Animate 动效调节器注入。在 AnimateChild 组件中，驱动动效的方法直接表现为 transition 实例方法，而 stop 实例方法用于中止动效。</p>
<p>通过源码，我们可以发现，当用户以字符串配置 props.transitionName 属性时，执行 appear 动效的节点将获得的样式类为 <code>${transitionName}-appear</code>, <code>${transitionName}-appear-active</code> 形式。当以对象配置 props.transitionName 属性时，节点获得的样式类前缀 <code>${transitionName}-appear</code> 将被替换为 <code>${transitionName.appear}</code>。props.transitionEnter, props.transitionAppear, props.transitionLeave 属性用于启动或关闭动效。在 css 动效的优先级后，节点将执行 props.animate.appear 动效。以下是动效的实现源码，AnimateChild 组件的 componentWillEnter, componentWillAppear, componentWillLeave 实例方法均基于 transition 方法实现。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnimateChild</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 实际执行 css 或 js 动效</span></span><br><span class="line"><span class="comment">   * @param &#123;string&#125; animationType 动效类型，值为 'appear', 'enter', 'leave' 中的一个</span></span><br><span class="line"><span class="comment">   * @param &#123;function&#125; finishCallback 回调函数，在动效完成后执行</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  transition(animationType, finishCallback) &#123;</span><br><span class="line">    <span class="keyword">const</span> node = ReactDOM.findDOMNode(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">const</span> transitionName = props.transitionName;</span><br><span class="line">    <span class="keyword">const</span> nameIsObj = <span class="keyword">typeof</span> transitionName === <span class="string">'object'</span>;</span><br><span class="line">    <span class="keyword">this</span>.stop();</span><br><span class="line">    <span class="keyword">const</span> end = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.stopper = <span class="literal">null</span>;</span><br><span class="line">      finishCallback();</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> ((isCssAnimationSupported || !props.animation[animationType]) &amp;&amp;</span><br><span class="line">      transitionName &amp;&amp; props[transitionMap[animationType]]) &#123;</span><br><span class="line">      <span class="keyword">const</span> name = nameIsObj ? transitionName[animationType] : <span class="string">`<span class="subst">$&#123;transitionName&#125;</span>-<span class="subst">$&#123;animationType&#125;</span>`</span>;</span><br><span class="line">      <span class="keyword">let</span> activeName = <span class="string">`<span class="subst">$&#123;name&#125;</span>-active`</span>;</span><br><span class="line">      <span class="keyword">if</span> (nameIsObj &amp;&amp; transitionName[<span class="string">`<span class="subst">$&#123;animationType&#125;</span>Active`</span>]) &#123;</span><br><span class="line">        activeName = transitionName[<span class="string">`<span class="subst">$&#123;animationType&#125;</span>Active`</span>];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.stopper = cssAnimate(node, &#123;</span><br><span class="line">        name,</span><br><span class="line">        active: activeName,</span><br><span class="line">      &#125;, end);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.stopper = props.animation[animationType](node, end);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 关闭动效</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  stop() &#123;</span><br><span class="line">    <span class="keyword">const</span> stopper = <span class="keyword">this</span>.stopper;</span><br><span class="line">    <span class="keyword">if</span> (stopper) &#123;</span><br><span class="line">      <span class="keyword">this</span>.stopper = <span class="literal">null</span>;</span><br><span class="line">      stopper.stop();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="css-动效"><a href="#css-动效" class="headerlink" title="css 动效"></a>css 动效</h3><p>rc-animate 库的 css 动效通过 css-animation 库实现，其直接构成 AnimateChild 组件中使用的 cssAnimate 函数。</p>
<p>css-animation 库先行侦测浏览器环境支持的 transition, animate 事件（webkit 等前缀）。若支持这两类事件，直接对节点绑定这两类事件的处理函数；若不支持，使用 setTimeout 构造虚拟事件。以下是 css-animation 库侦测浏览器支持事件的源码实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> START_EVENT_NAME_MAP = &#123;</span><br><span class="line">  transitionstart: &#123;</span><br><span class="line">    transition: <span class="string">'transitionstart'</span>,</span><br><span class="line">    WebkitTransition: <span class="string">'webkitTransitionStart'</span>,</span><br><span class="line">    MozTransition: <span class="string">'mozTransitionStart'</span>,</span><br><span class="line">    OTransition: <span class="string">'oTransitionStart'</span>,</span><br><span class="line">    msTransition: <span class="string">'MSTransitionStart'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  animationstart: &#123;</span><br><span class="line">    animation: <span class="string">'animationstart'</span>,</span><br><span class="line">    WebkitAnimation: <span class="string">'webkitAnimationStart'</span>,</span><br><span class="line">    MozAnimation: <span class="string">'mozAnimationStart'</span>,</span><br><span class="line">    OAnimation: <span class="string">'oAnimationStart'</span>,</span><br><span class="line">    msAnimation: <span class="string">'MSAnimationStart'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> END_EVENT_NAME_MAP = &#123;</span><br><span class="line">  transitionend: &#123;</span><br><span class="line">    transition: <span class="string">'transitionend'</span>,</span><br><span class="line">    WebkitTransition: <span class="string">'webkitTransitionEnd'</span>,</span><br><span class="line">    MozTransition: <span class="string">'mozTransitionEnd'</span>,</span><br><span class="line">    OTransition: <span class="string">'oTransitionEnd'</span>,</span><br><span class="line">    msTransition: <span class="string">'MSTransitionEnd'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  animationend: &#123;</span><br><span class="line">    animation: <span class="string">'animationend'</span>,</span><br><span class="line">    WebkitAnimation: <span class="string">'webkitAnimationEnd'</span>,</span><br><span class="line">    MozAnimation: <span class="string">'mozAnimationEnd'</span>,</span><br><span class="line">    OAnimation: <span class="string">'oAnimationEnd'</span>,</span><br><span class="line">    msAnimation: <span class="string">'MSAnimationEnd'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> startEvents = [];</span><br><span class="line"><span class="keyword">const</span> endEvents = [];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">detectEvents</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> testEl = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span><br><span class="line">  <span class="keyword">const</span> style = testEl.style;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!(<span class="string">'AnimationEvent'</span> <span class="keyword">in</span> <span class="built_in">window</span>)) &#123;</span><br><span class="line">    <span class="keyword">delete</span> START_EVENT_NAME_MAP.animationstart.animation;</span><br><span class="line">    <span class="keyword">delete</span> END_EVENT_NAME_MAP.animationend.animation;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!(<span class="string">'TransitionEvent'</span> <span class="keyword">in</span> <span class="built_in">window</span>)) &#123;</span><br><span class="line">    <span class="keyword">delete</span> START_EVENT_NAME_MAP.transitionstart.transition;</span><br><span class="line">    <span class="keyword">delete</span> END_EVENT_NAME_MAP.transitionend.transition;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">process</span>(<span class="params">EVENT_NAME_MAP, events</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 遍历 transition, animate 类目</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> baseEventName <span class="keyword">in</span> EVENT_NAME_MAP) &#123;</span><br><span class="line">      <span class="keyword">if</span> (EVENT_NAME_MAP.hasOwnProperty(baseEventName)) &#123;</span><br><span class="line">        <span class="keyword">const</span> baseEvents = EVENT_NAME_MAP[baseEventName];</span><br><span class="line">        <span class="comment">// 遍历特定浏览器的事件前缀名，将支持的事件存入 startEvents, endEvents 数组中</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> styleName <span class="keyword">in</span> baseEvents) &#123;</span><br><span class="line">          <span class="keyword">if</span> (styleName <span class="keyword">in</span> style) &#123;</span><br><span class="line">            events.push(baseEvents[styleName]);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  process(START_EVENT_NAME_MAP, startEvents);</span><br><span class="line">  process(END_EVENT_NAME_MAP, endEvents);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">window</span> !== <span class="string">'undefined'</span> &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">document</span> !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">  detectEvents();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同常见的 css 动效实现，css-animation 库首先为节点添加 transitionName 样式类；30 ms 后又为节点添加 <code>${transitionName}-active</code> 样式类；并在动效执行完成后，通过绑定事件为节点移除前两个样式类；若事件无效，css-animation 将使用定时器移除样式类。以下是这段逻辑的实现代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cssAnimation = <span class="function">(<span class="params">node, transitionName, endCallback</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> nameIsObj = <span class="keyword">typeof</span> transitionName === <span class="string">'object'</span>;</span><br><span class="line">  <span class="keyword">const</span> className = nameIsObj ? transitionName.name : transitionName;</span><br><span class="line">  <span class="keyword">const</span> activeClassName = nameIsObj ? transitionName.active : <span class="string">`<span class="subst">$&#123;transitionName&#125;</span>-active`</span>;</span><br><span class="line">  <span class="keyword">let</span> end = endCallback;</span><br><span class="line">  <span class="keyword">let</span> start;</span><br><span class="line">  <span class="keyword">let</span> active;</span><br><span class="line">  <span class="comment">// 函数 classes 由 component-classes 提供，针对多平台处理样式类列表</span></span><br><span class="line">  <span class="keyword">const</span> nodeClasses = classes(node);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (endCallback &amp;&amp; <span class="built_in">Object</span>.prototype.toString.call(endCallback) === <span class="string">'[object Object]'</span>) &#123;</span><br><span class="line">    end = endCallback.end;</span><br><span class="line">    start = endCallback.start;</span><br><span class="line">    active = endCallback.active;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (node.rcEndListener) &#123;</span><br><span class="line">    node.rcEndListener();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 回调中移除样式类</span></span><br><span class="line">  node.rcEndListener = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (e &amp;&amp; e.target !== node) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (node.rcAnimTimeout) &#123;</span><br><span class="line">      clearTimeout(node.rcAnimTimeout);</span><br><span class="line">      node.rcAnimTimeout = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// clearBrowserBugTimeout 函数用于清除 fixBrowserByTimeout 函数设置的定时器</span></span><br><span class="line">    clearBrowserBugTimeout(node);</span><br><span class="line"></span><br><span class="line">    nodeClasses.remove(className);</span><br><span class="line">    nodeClasses.remove(activeClassName);</span><br><span class="line"></span><br><span class="line">    Event.removeEndEventListener(node, node.rcEndListener);</span><br><span class="line">    node.rcEndListener = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (end) &#123;</span><br><span class="line">      end();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  Event.addEndEventListener(node, node.rcEndListener);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (start) &#123;</span><br><span class="line">    start();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加样式类，执行动效</span></span><br><span class="line">  nodeClasses.add(className);</span><br><span class="line"></span><br><span class="line">  node.rcAnimTimeout = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    node.rcAnimTimeout = <span class="literal">null</span>;</span><br><span class="line">    nodeClasses.add(activeClassName);</span><br><span class="line">    <span class="keyword">if</span> (active) &#123;</span><br><span class="line">      setTimeout(active, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fixBrowserByTimeout 函数使用定时器执行 node.rcEndListener 方法，以清除动效相关的样式类</span></span><br><span class="line">    <span class="comment">// 常态下使用绑定事件清除样式类，fixBrowserByTimeout 用于针对浏览器在绑定事件上的 bug</span></span><br><span class="line">    fixBrowserByTimeout(node);</span><br><span class="line">  &#125;, <span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    stop() &#123;</span><br><span class="line">      <span class="keyword">if</span> (node.rcEndListener) &#123;</span><br><span class="line">        node.rcEndListener();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="CSSMotion"><a href="#CSSMotion" class="headerlink" title="CSSMotion"></a>CSSMotion</h2><p>CSSMotion 组件实现 css 动效的处理逻辑如同上文所说，即在元素显现时添加 <code>${transitionName}-appear</code>, <code>${transitionName}-appear-active</code> 样式类，在动效完成后，再移除这两个样式类；enter, leave 动效同此。在 CSSMotion 组件中，变量 props.transitionName 实际表现为配置项 props.motionName。</p>
<p>在处理样式类变更逻辑上，CSSMotion 组件内部使用 state.status 状态表示动效的类型，state.statusActive 状态表示动效是否在执行阶段，state.newStatus 状态表示是否需要执行新的动效，state.statusStyle 状态表示动效执行期间附加的样式。父子组件交互层面，CSSMotion 组件通过接受 props 属性影响内部子组件的显示动效：初始化 props.visible 和 props.motionAppear 均为真值时执行 appear 动效；当 props.visible 由 false 转为 true 且 props.motionEnter 为真值时执行 enter 动效；当 props.visible 由 true 转为 false 且 props.motionLeave 为真值时执行 leave 动效。state.statusStyle 样式由 props.onAppearStart, props.onEnterStart, props.onLeaveStart, props.onAppearActive, props.onEnterActive, props.onLeaveActive, props.onAppearEnd, props.onEnterEnd, props.onLeaveEnd 监听函数计算获得，顾名思义，这些函数的执行时机分别为动效起始、执行和结束阶段。state.status, state.statusActive, state.statusStyle 最终将影响函数式子组件获得的 props 参数。</p>
<p>CSSMotion 组件的处理流程为：</p>
<ol>
<li>通过 getDerivedStateFromProps 静态方法计算 state.status，划定元素将执行何种动效；同时将 state.newStatus 置为真值，表示元素将执行新的动效；且将 state.statusActive 置为否值，表示动效处于等待执行状态。</li>
<li>componentDidMount, componentDidUpdate 生命周期调用 onDomUpdate 实例方法，为元素绑定动效完成后的回调函数，并启动动效的实际处理逻辑。</li>
<li>动效的实际处理逻辑通过 updateStatus 实例方法启动，以 appear 动效为例，首先调用 props.onAppearStart 方法计算元素的样式，以更新注入子组件的 state.statusStyle，将 state.newStatus 置为否值；其次在回调中调用 updateActiveStatus 实例方法，在下一帧渲染过程调用 props.onAppearActive 方法更新 state.statusStyle 样式，且将 state.statusActive 置为真值，以启动 css 动效；当动效执行完成后，通过绑定函数执行 onMotionEnd 实例方法，即通过 props.onAppearEnd 计算 state.statusStyle 样式，且重置 state.status 状态，以指示子组件动效已执行完成。</li>
<li>componentWillUnmount 生命周期解绑监听函数。</li>
</ol>
<p>以下 CSSMotion 组件的源码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CSSMotion</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 通过更新 state.status 状态指定子组件需要执行哪种动效</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> getDerivedStateFromProps(props, &#123; prevProps &#125;) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isSupportTransition(props)) <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">      visible, motionAppear, motionEnter, motionLeave,</span><br><span class="line">      motionLeaveImmediately,</span><br><span class="line">    &#125; = props;</span><br><span class="line">    <span class="keyword">const</span> newState = &#123;</span><br><span class="line">      prevProps: props,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Appear</span></span><br><span class="line">    <span class="keyword">if</span> (!prevProps &amp;&amp; visible &amp;&amp; motionAppear) &#123;</span><br><span class="line">      newState.status = STATUS_APPEAR;</span><br><span class="line">      newState.statusActive = <span class="literal">false</span>;</span><br><span class="line">      newState.newStatus = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Enter</span></span><br><span class="line">    <span class="keyword">if</span> (prevProps &amp;&amp; !prevProps.visible &amp;&amp; visible &amp;&amp; motionEnter) &#123;</span><br><span class="line">      newState.status = STATUS_ENTER;</span><br><span class="line">      newState.statusActive = <span class="literal">false</span>;</span><br><span class="line">      newState.newStatus = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Leave</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      (prevProps &amp;&amp; prevProps.visible &amp;&amp; !visible &amp;&amp; motionLeave) ||</span><br><span class="line">      (!prevProps &amp;&amp; motionLeaveImmediately &amp;&amp; !visible &amp;&amp; motionLeave)</span><br><span class="line">    ) &#123;</span><br><span class="line">      newState.status = STATUS_LEAVE;</span><br><span class="line">      newState.statusActive = <span class="literal">false</span>;</span><br><span class="line">      newState.newStatus = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> newState;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * componentDidMount, componentDidUpdate 生命周期驱动动效的实际处理逻辑</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  onDomUpdate = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; status, newStatus &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">      onAppearStart, onEnterStart, onLeaveStart,</span><br><span class="line">      onAppearActive, onEnterActive, onLeaveActive,</span><br><span class="line">      motionAppear, motionEnter, motionLeave,</span><br><span class="line">    &#125; = <span class="keyword">this</span>.props;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isSupportTransition(<span class="keyword">this</span>.props)) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绑定 onMotionEnd 回调函数；动效完成后，执行 onMotionEnd 实例方法</span></span><br><span class="line">    <span class="keyword">const</span> $ele = ReactDOM.findDOMNode(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.$ele !== $ele) &#123;</span><br><span class="line">      <span class="keyword">this</span>.removeEventListener(<span class="keyword">this</span>.$ele);</span><br><span class="line">      <span class="keyword">this</span>.addEventListener($ele);</span><br><span class="line">      <span class="keyword">this</span>.$ele = $ele;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 首次执行 updateStatus 实例方法将通过 props.onAppearStart 计算注入子元素的样式</span></span><br><span class="line">    <span class="comment">// 其次执行 updateActiveStatus 实例方法将 state.statusActive 以启动动效</span></span><br><span class="line">    <span class="keyword">if</span> (newStatus &amp;&amp; status === STATUS_APPEAR &amp;&amp; motionAppear) &#123;</span><br><span class="line">      <span class="keyword">this</span>.updateStatus(onAppearStart, <span class="literal">null</span>, <span class="literal">null</span>, () =&gt; &#123;</span><br><span class="line">        <span class="keyword">this</span>.updateActiveStatus(onAppearActive, STATUS_APPEAR);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newStatus &amp;&amp; status === STATUS_ENTER &amp;&amp; motionEnter) &#123;</span><br><span class="line">      <span class="keyword">this</span>.updateStatus(onEnterStart, <span class="literal">null</span>, <span class="literal">null</span>, () =&gt; &#123;</span><br><span class="line">        <span class="keyword">this</span>.updateActiveStatus(onEnterActive, STATUS_ENTER);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newStatus &amp;&amp; status === STATUS_LEAVE &amp;&amp; motionLeave) &#123;</span><br><span class="line">      <span class="keyword">this</span>.updateStatus(onLeaveStart, <span class="literal">null</span>, <span class="literal">null</span>, () =&gt; &#123;</span><br><span class="line">        <span class="keyword">this</span>.updateActiveStatus(onLeaveActive, STATUS_LEAVE);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 调用 props.onAppearStart 等方法计算注入子元素的样式，并在下一帧渲染时调用 callback</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  updateStatus = <span class="function">(<span class="params">styleFunc, additionalState, event, callback</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> statusStyle = styleFunc ? styleFunc(ReactDOM.findDOMNode(<span class="keyword">this</span>), event) : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (statusStyle === <span class="literal">false</span> || <span class="keyword">this</span>._destroyed) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> nextStep;</span><br><span class="line">    <span class="keyword">if</span> (callback) &#123;</span><br><span class="line">      nextStep = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.nextFrame(callback);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">      statusStyle: <span class="keyword">typeof</span> statusStyle === <span class="string">'object'</span> ? statusStyle : <span class="literal">null</span>,</span><br><span class="line">      newStatus: <span class="literal">false</span>,</span><br><span class="line">      ...additionalState,</span><br><span class="line">    &#125;, nextStep); <span class="comment">// Trigger before next frame &amp; after `componentDidMount`</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 将 state.statusActive 置为真值，以启动 css 动效</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  updateActiveStatus = <span class="function">(<span class="params">styleFunc, currentStatus</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// this.nextFrame 使用 raf 库实现下一帧渲染</span></span><br><span class="line">    <span class="keyword">this</span>.nextFrame(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; status &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">      <span class="keyword">if</span> (status !== currentStatus) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.updateStatus(styleFunc, &#123; <span class="attr">statusActive</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 动效执行完成后回调，更新 state.status 以清除注入子元素的样式</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  onMotionEnd = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; status, statusActive &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">    <span class="keyword">const</span> &#123; onAppearEnd, onEnterEnd, onLeaveEnd &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">if</span> (status === STATUS_APPEAR &amp;&amp; statusActive) &#123;</span><br><span class="line">      <span class="keyword">this</span>.updateStatus(onAppearEnd, &#123; <span class="attr">status</span>: STATUS_NONE &#125;, event);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (status === STATUS_ENTER &amp;&amp; statusActive) &#123;</span><br><span class="line">      <span class="keyword">this</span>.updateStatus(onEnterEnd, &#123; <span class="attr">status</span>: STATUS_NONE &#125;, event);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (status === STATUS_LEAVE &amp;&amp; statusActive) &#123;</span><br><span class="line">      <span class="keyword">this</span>.updateStatus(onLeaveEnd, &#123; <span class="attr">status</span>: STATUS_NONE &#125;, event);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; status, statusActive, statusStyle &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">    <span class="keyword">const</span> &#123; children, motionName, visible, removeOnLeave, leavedClassName &#125; = <span class="keyword">this</span>.props;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!children) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (status === STATUS_NONE || !isSupportTransition(<span class="keyword">this</span>.props)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (visible) &#123;</span><br><span class="line">        <span class="keyword">return</span> children(&#123;&#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!removeOnLeave) &#123;</span><br><span class="line">        <span class="keyword">return</span> children(&#123; <span class="attr">className</span>: leavedClassName &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 子组件以函数式组价形式接受样式类和样式</span></span><br><span class="line">    <span class="keyword">return</span> children(&#123;</span><br><span class="line">      className: classNames(&#123;</span><br><span class="line">        [getTransitionName(motionName, status)]: status !== STATUS_NONE,</span><br><span class="line">        [getTransitionName(motionName, <span class="string">`<span class="subst">$&#123;status&#125;</span>-active`</span>)]: status !== STATUS_NONE &amp;&amp; statusActive,</span><br><span class="line">        [motionName]: <span class="keyword">typeof</span> motionName === <span class="string">'string'</span>,</span><br><span class="line">      &#125;),</span><br><span class="line">      style: statusStyle,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/10/antd/Menu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/10/antd/Menu/" itemprop="url">Menu</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-10T00:00:00+08:00">2018-12-10</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/antd-组件库/" itemprop="url" rel="index"><span itemprop="name">antd 组件库</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/12/10/antd/Menu/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/12/10/antd/Menu/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>antd 中的 Menu 组件用于绘制菜单栏，其实现基于 <a href="https://github.com/react-component/menu" target="_blank" rel="noopener">rc-menu</a>。本文第一部分介绍菜单栏实现的整体结构；第二部分介绍 rc-menu；第三部分介绍 Menu 组件。</p>
<p>需要声明的是，本文使用 RcMenu 指代 rc-menu 输出的 Menu 组件或其实例，使用 Menu 指代 antd 输出的 Menu 组件或其实例、或抽象意义的菜单栏组件，余同。</p>
<h2 id="整体结构"><a href="#整体结构" class="headerlink" title="整体结构"></a>整体结构</h2><p>在视图上，菜单栏分为水平布局和垂直布局两种，又支持层叠嵌套（如主菜单 Menu 嵌套子菜单 SubMenu）；子菜单的展开形式分为内嵌和浮层两种。Menu 组件通过 props.mode 区分所采用的模式：vertical 为垂直模式；horizontal 为水平模式；inline 为内嵌模式。菜单栏的垂直布局和水平布局借助样式实现。在水平布局中，超出菜单栏宽度的菜单项需要合并展示，这部分处理逻辑由 rc-menu 中的 DomWrap 组件实现。</p>
<p>在内容上，主菜单和子菜单相仿，功能上有交集。在 rc-menu 中，主菜单 Menu 和子菜单 SubMenu 均通过 SubPopupMenu 组件绘制内容，SubPopupMenu 又使用 DomWrap 控制水平布局时的元素展示。SubPopupMenu 自有的处理逻辑为：控制菜单栏的激活状态（通过 componentDidUpdate, onKeyDown, onItemHover 方法达成，详见下文）。用过 antd 的同学应该了解，Menu 组件下可使用 SubMenu, MenuItem, MenuItemGroup 绘制子菜单或菜单项，父子元素之间就会有状态管理方面的通信需求。针对这个问题，SubPopupMenu 使用 React.clone 方法将父组件实现的状态管理函数或其 props 属性注入到子组件中，从而串联了主菜单与子菜单、主菜单与菜单项、以及子菜单与菜单项。</p>
<p>菜单栏的状态管理分为三种：菜单项的激活状态、菜单项的选中状态、子菜单的展开折叠状态。rc-menu 借助 <a href="https://github.com/yesmeck/mini-store" target="_blank" rel="noopener">mini-store</a> 管理这些状态：activeKey 激活的菜单项，selectedKeys 选中的菜单项，openKeys 展开的子菜单。如上文所说，activeKey 由 SubPopupMenu 处理其更新逻辑。selectedKeys, openKeys 均由 RcMenu 处理其更新逻辑。交互层面，当 props.selectedKeys, props.openKeys 变更时，RcMenu 提供的 updateMiniStore 方法将负责更新 store 中的存储数据；当用户行为发生时，RcMenu 提供的 onSelect, onDeSelect, onOpenChange 方法将负责更新 store 中的存储数据，这些方法又通过 SubPopupMenu 长传到 SubMenu, MenuItem, MenuItemGroup 中。简而言之，RcMenu 既通过 props 接受使用者传入的菜单栏整体配置数据，又集成了 selectedKeys, openKeys 的状态管理函数。</p>
<p>在 RcMenu 提供 onSelect, onDeSelect, onOpenChange 方法和 SubPopupMenu 提供的 onItemHover 方法的基础上，子菜单 RcSubMenu 既将 onSelect, onDeSelect 透传给菜单项，又使用 onOpenChange 控制展开折叠状态，onItemHover 更新激活状态。不同于主菜单，子菜单需要以内嵌或浮层形式表现内容，且需要在展开与折叠过程中显示动效。借助 <a href="https://github.com/react-component/trigger" target="_blank" rel="noopener">rc-trigger</a>、<a href="https://github.com/react-component/animate" target="_blank" rel="noopener">rc-animate</a> 库，RcSubMenu 集成了浮层显示功能和动效展示逻辑。即，通过 props.mode 判断菜单栏是否采用 inline 模式，RcSubMenu 将以浮层形式绘制子菜单内容；子菜单展开与折叠过程中所采用的动效，取决于顶层容器 Menu 主菜单接受 props 配置。</p>
<p>菜单项 RcMenuItem 通过 props 接受 RcMenu 提供的 onSelect, onDeSelect 方法和 SubPopupMenu 提供的 onItemHover 方法，以便在点击事件、鼠标移入移出时更新 store 中的状态。在 RcMenuItem 的基础上，RcMenuItemGroup 用于绘制成组的菜单项。</p>
<p>下图是 rc-menu 的整体结构:<br><img src="/2018/12/10/antd/Menu/rc-menu整体结构.png"></p>
<p>在 rc-menu 实现状态管理的基础上，antd 提供的 Menu 组件用于桥接侧边栏和菜单栏的关联性，维护内置的动效显示，以及样式处理。详见下文。</p>
<h2 id="rc-menu"><a href="#rc-menu" class="headerlink" title="rc-menu"></a>rc-menu</h2><p>rc-menu 的类图为：<br><img src="/2018/12/10/antd/Menu/rc-menu类图.png"></p>
<p>rc-menu 中的状态管理：</p>
<ol>
<li>selectedKeys 选中的菜单项：由 RcMenu 提供 onSelect, onDeselect 方法加以管理。onSelect, onDeselect 方法将长传到 RcMenuItem 组件，以便在 RcMenuItem 的 onKeyDown, onClick 行为中更新状态。同时，在 RcMenu 的 componentDidUpdate 生命周期中，也将 props.selectedKeys 更新状态值。</li>
<li>openKeys 展开的子菜单：由 RcMenu 提供 onOpenChange 方法加以管理。onOpenChange 方法将长传到 RcSubMenu 组件并封装为 RcSubMenu.triggerOpenChange 方法，以便在 RcSubMenu 的 onKeyDown, onTitleClick, onPopupVisibleChange 行为中更新状态。同时，在 RcMenu 的 componentDidUpdate 生命周期中，也将 props.openKeys 更新状态值。</li>
<li>activeKey 激活的菜单项：由辅助函数 updateActiveKey 加以管理。updateActiveKey 函数被 SubPopupMenu 的 componentDidUpdate, onItemHover 方法调用。其中，onItemHover 方法将长传到 RcSubMenu 或 RcMenuItem 组件，以便在 RcSubMenu 的 onTitleMouseEnter, onTitleMouseLeave 行为或 RcMenuItem 的 onMouseEnter, onMouseLeave 行为中更新状态。</li>
<li>defaultActiveFirst 是否激活首个菜单项，辅助计算激活的菜单项：由辅助函数 updateDefaultActiveFirst 加以管理。updateDefaultActiveFirst 函数被 RcSubMenu 的 constructor, onKeyDown, onMouseEnter, onTitleClick 方法调用。其中，constructor 将视 RcSubMenu 接受的 props.defaultActiveFirst 设置状态；onKeyDown 将状态更新为 true；onMouseEnter, onTitleClick 均更新为 false。</li>
</ol>
<p>rc-menu 中的 key 键用于辅助状态管理。key 键仅对于子菜单或菜单项才有效。在默认情况下，SubPopupMenu 会以 ‘0-menu-‘ 作为前缀，递归创建子菜单或菜单项的 key 键，并设置为该子菜单或菜单项的 props.eventKey。当菜单项作为子菜单的元素时，那么菜单项的 key 键就以子菜单的 props.eventKey 作为前缀。当使用者为子菜单或菜单项设置了 key 键时，rc-menu 将以它作为该子菜单或菜单项的 props.eventKey 键。因此，相同的 key 键是不被允许的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当 SubPopupMenu 作为 RcMenu 的直系子元素时，返回 '0-menu-'</span></span><br><span class="line"><span class="comment">// 其余情况获取子菜单或菜单项的 props.eventKey</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getEventKey</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> props.eventKey || <span class="string">'0-menu-'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自动创建 key 键并返回，或者返回使用者设置的 key 键</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getKeyFromChildrenIndex</span>(<span class="params">child, menuEventKey, index</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> prefix = menuEventKey || <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">return</span> child.key || <span class="string">`<span class="subst">$&#123;prefix&#125;</span>item_<span class="subst">$&#123;index&#125;</span>`</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 store 中，selectedKeys, openKeys 以 key 键作为数组项；activeKey, defaultActiveFirst 以 key 键作为属性名。当用户行为发生时，key 键将被封装到对象中，通过逐级调用 props 方法，冒泡给 RcMenu 实例的 onOpenChange, onSelect, onDeselect 或者 SubPopupMenu 实例的 onItemHover 方法，最终改变 store 的状态。需要说明的是，菜单项的 onClick 也会逐级调用 props 方法，以数组形式拼接子菜单的 key 键，最终冒泡给 RcMenu 接受的 props.onClick 方法。而 RcMenu 接受的 props.onDestory 方法，则是逐级向下传递，最终在每个菜单项的 componentWillUnmount 生命周期中，均执行 onDestory 方法，参数即菜单项的 key 键。特别的，RcMenu 实现的 onKeyDown 实例方法将逐级往下调用 SubPopupMenu, RcSubMenu, RcMenuItem 中的 onKeyDown 方法。在这个过程中，SubPopupMenu 构建的 onKeyDown 实例方法也将在 DomWrap 组件被绑定为视图元素 onKeyDown 事件发生时的执行函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Menu</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 以引用形式调用，可依次改变选中的菜单项</span></span><br><span class="line">  <span class="comment">// 当遇到子菜单时，先展开子菜单，再选中子菜单项</span></span><br><span class="line">  onKeyDown = <span class="function">(<span class="params">e, callback</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// this.innerMenu.getWrappedInstance 用于获得 Menu 下直系子元素 —— SubPopupMenu 实例</span></span><br><span class="line">    <span class="keyword">this</span>.innerMenu.getWrappedInstance().onKeyDown(e, callback);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubPopupMenu</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  onKeyDown = <span class="function">(<span class="params">e, callback</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> keyCode = e.keyCode;</span><br><span class="line">    <span class="keyword">let</span> handled;</span><br><span class="line">    <span class="comment">// 依次选中菜单项或展开子菜单</span></span><br><span class="line">    <span class="keyword">this</span>.getFlatInstanceArray().forEach(<span class="function">(<span class="params">obj</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (obj &amp;&amp; obj.props.active &amp;&amp; obj.onKeyDown) &#123;</span><br><span class="line">        handled = obj.onKeyDown(e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (handled) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> activeItem = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (keyCode === KeyCode.UP || keyCode === KeyCode.DOWN) &#123;</span><br><span class="line">      activeItem = <span class="keyword">this</span>.step(keyCode === KeyCode.UP ? <span class="number">-1</span> : <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (activeItem) &#123;</span><br><span class="line">      e.preventDefault();</span><br><span class="line">      updateActiveKey(<span class="keyword">this</span>.props.store, getEventKey(<span class="keyword">this</span>.props), activeItem.props.eventKey);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> callback === <span class="string">'function'</span>) &#123;</span><br><span class="line">        callback(activeItem);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubMenu</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  onKeyDown = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> keyCode = e.keyCode;</span><br><span class="line">    <span class="keyword">const</span> menu = <span class="keyword">this</span>.menuInstance;</span><br><span class="line">    <span class="keyword">const</span> &#123; isOpen, store &#125; = <span class="keyword">this</span>.props;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 展开子菜单，更新 defaultActiveFirst 状态</span></span><br><span class="line">    <span class="keyword">if</span> (keyCode === KeyCode.ENTER) &#123;</span><br><span class="line">      <span class="keyword">this</span>.onTitleClick(e);</span><br><span class="line">      updateDefaultActiveFirst(store, <span class="keyword">this</span>.props.eventKey, <span class="literal">true</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (keyCode === KeyCode.RIGHT) &#123;</span><br><span class="line">      <span class="comment">// 展开状态，选中子菜单项；menu 为 SubMenu 下直系子元素 —— SubPopupMenu 实例</span></span><br><span class="line">      <span class="keyword">if</span> (isOpen) &#123;</span><br><span class="line">        menu.onKeyDown(e);</span><br><span class="line">      <span class="comment">// 未展开状态，展开子菜单并更新 defaultActiveFirst 状态</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.triggerOpenChange(<span class="literal">true</span>);</span><br><span class="line">        updateDefaultActiveFirst(store, <span class="keyword">this</span>.props.eventKey, <span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (keyCode === KeyCode.LEFT) &#123;</span><br><span class="line">      <span class="keyword">let</span> handled;</span><br><span class="line">      <span class="keyword">if</span> (isOpen) &#123;</span><br><span class="line">        handled = menu.onKeyDown(e);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!handled) &#123;</span><br><span class="line">        <span class="keyword">this</span>.triggerOpenChange(<span class="literal">false</span>);</span><br><span class="line">        handled = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> handled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isOpen &amp;&amp; (keyCode === KeyCode.UP || keyCode === KeyCode.DOWN)) &#123;</span><br><span class="line">      <span class="keyword">return</span> menu.onKeyDown(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MenuItem</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  onKeyDown = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> keyCode = e.keyCode;</span><br><span class="line">    <span class="keyword">if</span> (keyCode === KeyCode.ENTER) &#123;</span><br><span class="line">      <span class="keyword">this</span>.onClick(e);<span class="comment">// 更新菜单的选中状态</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上介绍了 rc-menu 中的状态管理和事件处理逻辑，下面将扼要地介绍 rc-menu 中的各组件。</p>
<h3 id="SubPopupMenu"><a href="#SubPopupMenu" class="headerlink" title="SubPopupMenu"></a>SubPopupMenu</h3><p>SubPopupMenu 对激活状态的管理可参见上文，可参见上文及源码。这里只介绍 SubPopupMenu 的层级关系。</p>
<p>SubPopupMenu 可以作为 RcMenu 或 RcSubMenu 的直系子元素，其下可渲染 RcSubMenu 或 RcMenuItem 元素。在其实现中，既将 RcMenu 接受的 props 菜单栏整体配置项注入到子元素；又将 RcMenu 或 SubPopupMenu 提供的状态管理函数（均封装为 SubPopupMenu 的实例方法）注入 RcSubMenu 或 RcMenuItem。上述过程，见于 renderCommonMenuItem 方法，该方法由 renderMenuItem 直接调用。</p>
<p>renderMenuItem 方法的实现与 ref 引用处理一样，两者均让人心生纳闷：前者没有实现的必要；后者在 componentDidMount 生命周期管理实例引用，当菜单内容变化时仍会以缓存持有引用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubPopupMenu</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  renderCommonMenuItem = <span class="function">(<span class="params">child, i, extraProps</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> state = <span class="keyword">this</span>.props.store.getState();</span><br><span class="line">    <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">const</span> key = getKeyFromChildrenIndex(child, props.eventKey, i);<span class="comment">// 创建或获取 key 键</span></span><br><span class="line">    <span class="keyword">const</span> childProps = child.props;</span><br><span class="line">    <span class="keyword">const</span> isActive = key === state.activeKey;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 混入菜单栏整体配置或状态管理函数、事件绑定函数</span></span><br><span class="line">    <span class="keyword">const</span> newChildProps = &#123;</span><br><span class="line">      mode: childProps.mode || props.mode,</span><br><span class="line">      level: props.level,</span><br><span class="line">      inlineIndent: props.inlineIndent,</span><br><span class="line">      renderMenuItem: <span class="keyword">this</span>.renderMenuItem,</span><br><span class="line">      rootPrefixCls: props.prefixCls,</span><br><span class="line">      index: i,</span><br><span class="line">      parentMenu: props.parentMenu,</span><br><span class="line">      <span class="comment">// customized ref function, need to be invoked manually in child's componentDidMount</span></span><br><span class="line">      manualRef: childProps.disabled ? <span class="literal">undefined</span> :</span><br><span class="line">        createChainedFunction(child.ref, saveRef.bind(<span class="keyword">this</span>)),</span><br><span class="line">      eventKey: key,</span><br><span class="line">      active: !childProps.disabled &amp;&amp; isActive,</span><br><span class="line">      multiple: props.multiple,</span><br><span class="line">      onClick: <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">        (childProps.onClick || noop)(e);</span><br><span class="line">        <span class="keyword">this</span>.onClick(e);</span><br><span class="line">      &#125;,</span><br><span class="line">      onItemHover: <span class="keyword">this</span>.onItemHover,</span><br><span class="line">      openTransitionName: <span class="keyword">this</span>.getOpenTransitionName(),</span><br><span class="line">      openAnimation: props.openAnimation,</span><br><span class="line">      subMenuOpenDelay: props.subMenuOpenDelay,</span><br><span class="line">      subMenuCloseDelay: props.subMenuCloseDelay,</span><br><span class="line">      forceSubMenuRender: props.forceSubMenuRender,</span><br><span class="line">      onOpenChange: <span class="keyword">this</span>.onOpenChange,</span><br><span class="line">      onDeselect: <span class="keyword">this</span>.onDeselect,</span><br><span class="line">      onSelect: <span class="keyword">this</span>.onSelect,</span><br><span class="line">      builtinPlacements: props.builtinPlacements,</span><br><span class="line">      itemIcon: childProps.itemIcon || <span class="keyword">this</span>.props.itemIcon,</span><br><span class="line">      expandIcon: childProps.expandIcon || <span class="keyword">this</span>.props.expandIcon,</span><br><span class="line">      ...extraProps,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (props.mode === <span class="string">'inline'</span>) &#123;</span><br><span class="line">      newChildProps.triggerSubMenuAction = <span class="string">'click'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> React.cloneElement(child, newChildProps);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="comment">// props 处理及解构</span></span><br><span class="line">    <span class="comment">// renderMenuItem 将调用 renderCommonMenuItem 渲染子元素</span></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;DOMWrap &#123;...props&#125; prefixCls=&#123;prefixCls&#125; mode=&#123;mode&#125; tag=<span class="string">"ul"</span> level=&#123;level&#125; </span><br><span class="line">        theme=&#123;theme&#125; hiddenClassName=&#123;<span class="string">`<span class="subst">$&#123;prefixCls&#125;</span>-hidden`</span>&#125; visible=&#123;visible&#125;</span><br><span class="line">        overflowedIndicator=&#123;overflowedIndicator&#125; &#123;...domProps&#125;&gt;</span><br><span class="line">        &#123;</span><br><span class="line">          React.Children.map(props.children, (c, i) =&gt; </span><br><span class="line">            <span class="keyword">this</span>.renderMenuItem(c, i, eventKey || <span class="string">'0-menu-'</span>)</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &lt;<span class="regexp">/DOMWrap&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="DomWrap"><a href="#DomWrap" class="headerlink" title="DomWrap"></a>DomWrap</h3><p>对于水平布局的菜单栏，DOMWrap 借助 <a href="https://github.com/que-etc/resize-observer-polyfill" target="_blank" rel="noopener">resize-observer-polyfill</a>，<a href="http://javascript.ruanyifeng.com/dom/mutationobserver.html" target="_blank" rel="noopener">MutationObserver</a> ，当 DOMWrap 实例或其子元素的 dom 内容或尺寸调整时，重新加以渲染。这样，在 DOMWrap 中就可以计算最后一个待显示的菜单项，并将这个菜单项和其余菜单项以 SubMenu 形式合并展示。其处理逻辑有：</p>
<ol>
<li>在 componentDidMount 生命周期为 DOMWrap 实例及其子元素绑定 dom 变更的监听函数。</li>
<li>当 dom 变更时，由监听函数调用 setChildrenWidthAndResize 实例方法。setChildrenWidthAndResize 先计算菜单项全显示时的总宽度，再将该宽度和菜单栏实际宽度对比，由此更新 state.lastVisibleIndex（最后一个待显示的菜单项的索引）。</li>
<li>在重绘阶段，DomWrap 将在每个已显示的菜单项后插入一个不予显示的 SubMenu 组件（其样式类带有 ‘overflowed-submenu’ 后缀，eventKey 为 ‘overflowed-indicator’ 后缀）；而待合并的菜单项将会用一个显示的 SubMenu 组件包裹，这样在点击时就可以显示浮层。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DOMWrap</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">this</span>.setChildrenWidthAndResize();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.props.level === <span class="number">1</span> &amp;&amp; <span class="keyword">this</span>.props.mode === <span class="string">'horizontal'</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> menuUl = ReactDOM.findDOMNode(<span class="keyword">this</span>);</span><br><span class="line">      <span class="keyword">if</span> (!menuUl) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.resizeObserver = <span class="keyword">new</span> ResizeObserver(<span class="function"><span class="params">entries</span> =&gt;</span> &#123;</span><br><span class="line">        entries.forEach(<span class="keyword">this</span>.setChildrenWidthAndResize);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 为 DOMWrap 及其子元素绑定监听函数</span></span><br><span class="line">      [].slice.call(menuUl.children).concat(menuUl).forEach(<span class="function"><span class="params">el</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.resizeObserver.observe(el);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 当子元素列表改变时，重新为子元素绑定监听函数，避免触发不必要的回调</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> MutationObserver !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.mutationObserver = <span class="keyword">new</span> MutationObserver(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">this</span>.resizeObserver.disconnect();</span><br><span class="line">          [].slice.call(menuUl.children).concat(menuUl).forEach(<span class="function"><span class="params">el</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.resizeObserver.observe(el);</span><br><span class="line">          &#125;);</span><br><span class="line">          <span class="keyword">this</span>.setChildrenWidthAndResize();</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">this</span>.mutationObserver.observe(</span><br><span class="line">          menuUl,</span><br><span class="line">          &#123; <span class="attr">attributes</span>: <span class="literal">false</span>, <span class="attr">childList</span>: <span class="literal">true</span>, <span class="attr">subTree</span>: <span class="literal">false</span> &#125;</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getOverflowedSubMenuItem = <span class="function">(<span class="params">keyPrefix, overflowedItems, renderPlaceholder</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// this.props.overflowedIndicator 通常是 '...'</span></span><br><span class="line">    <span class="keyword">const</span> &#123; overflowedIndicator, level, mode, prefixCls, theme, <span class="attr">style</span>: propStyle &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">if</span> (level !== <span class="number">1</span> || mode !== <span class="string">'horizontal'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> copy = <span class="keyword">this</span>.props.children[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="attr">children</span>: throwAway, title, eventKey, ...rest &#125; = copy.props;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> style = &#123; ...propStyle &#125;;</span><br><span class="line">    <span class="keyword">let</span> key = <span class="string">`<span class="subst">$&#123;keyPrefix&#125;</span>-overflowed-indicator`</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (overflowedItems.length === <span class="number">0</span> &amp;&amp; renderPlaceholder !== <span class="literal">true</span>) &#123;</span><br><span class="line">      style = &#123;</span><br><span class="line">        ...style,</span><br><span class="line">        display: <span class="string">'none'</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (renderPlaceholder) &#123;</span><br><span class="line">      style = &#123;</span><br><span class="line">        ...style,</span><br><span class="line">        visibility: <span class="string">'hidden'</span>,</span><br><span class="line">        position: <span class="string">'absolute'</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">      key = <span class="string">`<span class="subst">$&#123;key&#125;</span>-placeholder`</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> popupClassName = theme ? <span class="string">`<span class="subst">$&#123;prefixCls&#125;</span>-<span class="subst">$&#123;theme&#125;</span>`</span> : <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">const</span> props = &#123;&#125;;</span><br><span class="line">    menuAllProps.forEach(<span class="function"><span class="params">k</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (rest[k] !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">        props[k] = rest[k];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;SubMenu title=&#123;overflowedIndicator&#125; className=&#123;<span class="string">`<span class="subst">$&#123;prefixCls&#125;</span>-overflowed-submenu`</span>&#125;</span><br><span class="line">        popupClassName=&#123;popupClassName&#125; &#123;...props&#125; key=&#123;key&#125;</span><br><span class="line">        eventKey=&#123;<span class="string">`<span class="subst">$&#123;keyPrefix&#125;</span>-overflowed-indicator`</span>&#125; disabled=&#123;<span class="literal">false</span>&#125; style=&#123;style&#125;&gt;</span><br><span class="line">        &#123;overflowedItems&#125;</span><br><span class="line">      &lt;<span class="regexp">/SubMenu&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  renderChildren(children) &#123;</span></span><br><span class="line"><span class="regexp">    const &#123; lastVisibleIndex &#125; = this.state;</span></span><br><span class="line"><span class="regexp">    return (children || []).reduce((acc, childNode, index) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">      let item = childNode;</span></span><br><span class="line"><span class="regexp">      if (this.props.mode === 'horizontal') &#123;</span></span><br><span class="line"><span class="regexp">        let overflowed = this.getOverflowedSubMenuItem(childNode.props.eventKey, []);</span></span><br><span class="line"><span class="regexp">        if (lastVisibleIndex !== undefined &amp;&amp;</span></span><br><span class="line"><span class="regexp">          this.props.className.indexOf(`$&#123;this.props.prefixCls&#125;-root`) !== -1</span></span><br><span class="line"><span class="regexp">        ) &#123;</span></span><br><span class="line"><span class="regexp">          if (index &gt; lastVisibleIndex) &#123;</span></span><br><span class="line"><span class="regexp">            /</span><span class="regexp">/ 修改 eventKey 是为了防止隐藏状态下还会触发 openkeys 事件</span></span><br><span class="line"><span class="regexp">            item = React.cloneElement(childNode, &#123;</span></span><br><span class="line"><span class="regexp">              style: &#123; display: 'none' &#125;,</span></span><br><span class="line"><span class="regexp">              eventKey: `$&#123;childNode.props.eventKey&#125;-hidden`,</span></span><br><span class="line"><span class="regexp">              className: `$&#123;childNode.className&#125; $&#123;MENUITEM_OVERFLOWED_CLASSNAME&#125;`</span></span><br><span class="line"><span class="regexp">            &#125;);</span></span><br><span class="line"><span class="regexp">          &#125;</span></span><br><span class="line"><span class="regexp">          if (index === lastVisibleIndex + 1) &#123;</span></span><br><span class="line"><span class="regexp">            this.overflowedItems = children.slice(lastVisibleIndex + 1).map(c =&gt; &#123;</span></span><br><span class="line"><span class="regexp">              return React.cloneElement(c, &#123; </span></span><br><span class="line"><span class="regexp">                key: c.props.eventKey, </span></span><br><span class="line"><span class="regexp">                mode: 'vertical-left' </span></span><br><span class="line"><span class="regexp">              &#125;);</span></span><br><span class="line"><span class="regexp">            &#125;);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">            overflowed = this.getOverflowedSubMenuItem(</span></span><br><span class="line"><span class="regexp">              childNode.props.eventKey,</span></span><br><span class="line"><span class="regexp">              this.overflowedItems,</span></span><br><span class="line"><span class="regexp">            );</span></span><br><span class="line"><span class="regexp">          &#125;</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">        const ret = [...acc, overflowed, item];</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">        if (index === children.length - 1) &#123;</span></span><br><span class="line"><span class="regexp">          /</span><span class="regexp">/ 设置占位符，以计算 overflowed indicator 的宽度</span></span><br><span class="line"><span class="regexp">          ret.push(this.getOverflowedSubMenuItem(childNode.props.eventKey, [], true));</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">        return ret;</span></span><br><span class="line"><span class="regexp">      &#125;</span></span><br><span class="line"><span class="regexp">      return [...acc, item];</span></span><br><span class="line"><span class="regexp">    &#125;, []);</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  render() &#123;</span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ Tag 即 this.props.tag，默认为 ul</span></span><br><span class="line"><span class="regexp">    return (</span></span><br><span class="line"><span class="regexp">      &lt;Tag &#123;...rest&#125;&gt;</span></span><br><span class="line"><span class="regexp">        &#123;this.renderChildren(this.props.children)&#125;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>Tag&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="SubMenu"><a href="#SubMenu" class="headerlink" title="SubMenu"></a>SubMenu</h3><p>除了上文提到的，SubMenu 的处理逻辑还包含：</p>
<ol>
<li>通过 store 获取 props.isOpen 子菜单是否展开, props.active 子菜单是否激活, props.selectedKeys 辅助计算子菜单或子菜单项是否被选中。三者均影响样式。</li>
<li>组件层级上，SubMenu 根据菜单栏是否采用 inline 模式，以决定使用 Trigger 组件（rc-trigger 提供）包裹子元素，或者单纯绘制子元素；继而使用 Animate 组件（rc-animate 提供）绘制子元素，子元素均统一由 SubPopupMenu 组件渲染。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Menu</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 获取传入子组件的 props.openTransitionName 属性</span></span><br><span class="line">  getOpenTransitionName = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">let</span> transitionName = props.openTransitionName;</span><br><span class="line">    <span class="keyword">const</span> animationName = props.openAnimation;</span><br><span class="line">    <span class="keyword">if</span> (!transitionName &amp;&amp; <span class="keyword">typeof</span> animationName === <span class="string">'string'</span>) &#123;</span><br><span class="line">      transitionName = <span class="string">`<span class="subst">$&#123;props.prefixCls&#125;</span>-open-<span class="subst">$&#123;animationName&#125;</span>`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> transitionName;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubMenu</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  renderChildren(children) &#123;</span><br><span class="line">    <span class="comment">// 构建 baseProps，按条件只绘制空内容...</span></span><br><span class="line">    <span class="keyword">const</span> animProps = &#123;&#125;;</span><br><span class="line">    <span class="keyword">const</span> transitionAppear = haveRendered || !baseProps.visible || !baseProps.mode === <span class="string">'inline'</span>;</span><br><span class="line">    <span class="keyword">if</span> (baseProps.openTransitionName) &#123;</span><br><span class="line">      animProps.transitionName = baseProps.openTransitionName;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> baseProps.openAnimation === <span class="string">'object'</span>) &#123;</span><br><span class="line">      animProps.animation = &#123; ...baseProps.openAnimation &#125;;</span><br><span class="line">      <span class="keyword">if</span> (!transitionAppear) &#123;</span><br><span class="line">        <span class="keyword">delete</span> animProps.animation.appear;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;Animate &#123;...animProps&#125; showProp=<span class="string">"visible"</span> component=<span class="string">""</span> transitionAppear=&#123;transitionAppear&#125;&gt;</span><br><span class="line">        &lt;SubPopupMenu &#123;...baseProps&#125; id=&#123;<span class="keyword">this</span>._menuId&#125;&gt;&#123;children&#125;&lt;<span class="regexp">/SubPopupMenu&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>Animate&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="comment">// props 处理及结构...</span></span><br><span class="line">    <span class="keyword">const</span> isOpen = props.isOpen;</span><br><span class="line">    <span class="keyword">const</span> isInlineMode = props.mode === <span class="string">'inline'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 展开按钮</span></span><br><span class="line">    <span class="keyword">let</span> icon = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (props.mode !== <span class="string">'horizontal'</span>) &#123;</span><br><span class="line">      icon = <span class="keyword">this</span>.props.expandIcon; <span class="comment">// ReactNode</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="keyword">this</span>.props.expandIcon === <span class="string">'function'</span>)</span><br><span class="line">        icon = React.createElement(<span class="keyword">this</span>.props.expandIcon, &#123; ...this.props &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> title = (</span><br><span class="line">      &lt;div ref=&#123;<span class="keyword">this</span>.saveSubMenuTitle&#125; style=&#123;style&#125; className=&#123;<span class="string">`<span class="subst">$&#123;prefixCls&#125;</span>-title`</span>&#125;</span><br><span class="line">        &#123;...titleMouseEvents&#125; &#123;...titleClickEvents&#125; aria-expanded=&#123;isOpen&#125;</span><br><span class="line">        &#123;...ariaOwns&#125; aria-haspopup=<span class="string">"true"</span></span><br><span class="line">        title=&#123;<span class="keyword">typeof</span> props.title === <span class="string">'string'</span> ? props.title : <span class="literal">undefined</span>&#125;&gt;</span><br><span class="line">        &#123;props.title&#125;</span><br><span class="line">        &#123;icon || <span class="xml"><span class="tag">&lt;<span class="name">i</span> <span class="attr">className</span>=<span class="string">&#123;</span>`$&#123;<span class="attr">prefixCls</span>&#125;<span class="attr">-arrow</span>`&#125; /&gt;</span>&#125;</span></span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span></span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">const</span> children = <span class="keyword">this</span>.renderChildren(props.children);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;li &#123;...props&#125; &#123;...mouseEvents&#125; className=&#123;className&#125; role=<span class="string">"menuitem"</span>&gt;</span><br><span class="line">        &#123;isInlineMode &amp;&amp; title&#125;</span><br><span class="line">        &#123;isInlineMode &amp;&amp; children&#125;</span><br><span class="line">        &#123;!isInlineMode &amp;&amp; (</span><br><span class="line">          &lt;Trigger prefixCls=&#123;prefixCls&#125;</span><br><span class="line">            popupClassName=&#123;<span class="string">`<span class="subst">$&#123;prefixCls&#125;</span>-popup <span class="subst">$&#123;popupClassName&#125;</span>`</span>&#125;</span><br><span class="line">            getPopupContainer=&#123;getPopupContainer&#125;</span><br><span class="line">            builtinPlacements=&#123;<span class="built_in">Object</span>.assign(&#123;&#125;, placements, builtinPlacements)&#125;</span><br><span class="line">            popupPlacement=&#123;popupPlacement&#125; popupVisible=&#123;isOpen&#125;</span><br><span class="line">            popupAlign=&#123;popupAlign&#125; popup=&#123;children&#125;</span><br><span class="line">            action=&#123;disabled ? [] : [triggerSubMenuAction]&#125;</span><br><span class="line">            mouseEnterDelay=&#123;subMenuOpenDelay&#125;</span><br><span class="line">            mouseLeaveDelay=&#123;subMenuCloseDelay&#125;</span><br><span class="line">            onPopupVisibleChange=&#123;<span class="keyword">this</span>.onPopupVisibleChange&#125;</span><br><span class="line">            forceRender=&#123;forceSubMenuRender&#125;&gt;</span><br><span class="line">            &#123;title&#125;</span><br><span class="line">          &lt;<span class="regexp">/Trigger&gt;</span></span><br><span class="line"><span class="regexp">        )&#125;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>li&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>Menu 用于绘制主菜单，参见上文或源码。</p>
<p>MenuItem 用于绘制菜单项，将根据 store 中的 activeKey, selectedKeys 渲染样式。除了常规的事件处理函数之外，当菜单项被激活时，MenuItem 将借助 <a href="http://yiminghe.me/dom-scroll-into-view/" target="_blank" rel="noopener">dom-scroll-into-view</a> 使屏幕滚动到指定区域。MenuItem 与 SubMenu 一样，也将使用 props.level 菜单项的层级计算左边距。</p>
<p>MenuItemGroup 用于绘制成组的菜单项，并且带有标题。在 MenuItemGroup 中，实际绘制菜单项所需的 props.renderMenuItem 方法由 SubPopupMenu 提供。</p>
<p>Divider 用于绘制分割线。</p>
<h2 id="Menu"><a href="#Menu" class="headerlink" title="Menu"></a>Menu</h2><h3 id="Menu-1"><a href="#Menu-1" class="headerlink" title="Menu"></a>Menu</h3><p>Menu 作为菜单的容器，其上桥接 Sider 布局组件传入的 context.siderCollapsed, context.collapsedWidth；其下为子菜单或菜单项注入 context.inlineCollapsed, context.antdMenuTheme。其中，context.siderCollapsed 表示侧边栏是否折叠；context.collapsedWidth 表示侧边栏宽度；context.inlineCollapsed 表示内嵌模式的菜单是否折叠，或者侧边栏是否折叠；context.antdMenuTheme 表示菜单所采用的样式风格。</p>
<p>组件层级上，Menu 使用 RcMenu 绘制内容。当传入 props.openKeys 时，Menu 将表现为受控组件，其内置的 state.openKeys 将根据 props.openKeys 作调整，使用者也可以通过 props.onOpenChange 实时获取到实时展开的菜单项；当没有传入 props.openKeys 时，Menu 将表现为非受控组件，state.openKeys 将根据用户行为更新。</p>
<p>在非内嵌模式下，Menu 为 RcMenu 绑定 onClick = this.handleClick 实例方法，以在当用户点击菜单栏的空白区域或子菜单项时，可隐藏弹出的浮层。</p>
<p>在动效处理上，当菜单栏由 inline 模式切换到其他模式或者在 inline 模式下收起菜单（实际菜单需要垂直布局显示）时，先需显示 inline 模式下子菜单的折叠动效，在动效执行完成后，再转换成其他模式（介于 rc-menu 没有针对动效时延的处理）。Menu 使用 switchingModeFromInline 实例属性记录模式转换及折叠状态切换。在此基础上，getRealMenuMode 用于计算菜单实际采用的显示模式，再由 getMenuOpenAnimation 获得待显示的功效。当动效执行完成时，handleTransitionEnd 实例方法将重置 switchingModeFromInline 缓存。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cssAnimation <span class="keyword">from</span> <span class="string">'css-animation'</span>;</span><br><span class="line"><span class="keyword">import</span> raf <span class="keyword">from</span> <span class="string">'raf'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">animate</span>(<span class="params">node: HTMLElement, show: boolean, done: (</span>) =&gt; <span class="title">void</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> height: number;</span><br><span class="line">  <span class="keyword">let</span> requestAnimationFrameId: number;</span><br><span class="line">  <span class="keyword">return</span> cssAnimation(node, <span class="string">'ant-motion-collapse'</span>, &#123;</span><br><span class="line">    start() &#123;</span><br><span class="line">      <span class="keyword">if</span> (!show) &#123;</span><br><span class="line">        node.style.height = <span class="string">`<span class="subst">$&#123;node.offsetHeight&#125;</span>px`</span>;</span><br><span class="line">        node.style.opacity = <span class="string">'1'</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        height = node.offsetHeight;</span><br><span class="line">        node.style.height = <span class="string">'0px'</span>;</span><br><span class="line">        node.style.opacity = <span class="string">'0'</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    active() &#123;</span><br><span class="line">      <span class="keyword">if</span> (requestAnimationFrameId) &#123;</span><br><span class="line">        raf.cancel(requestAnimationFrameId);</span><br><span class="line">      &#125;</span><br><span class="line">      requestAnimationFrameId = raf(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        node.style.height = <span class="string">`<span class="subst">$&#123;show ? height : <span class="number">0</span>&#125;</span>px`</span>;</span><br><span class="line">        node.style.opacity = show ? <span class="string">'1'</span> : <span class="string">'0'</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    end() &#123;</span><br><span class="line">      <span class="keyword">if</span> (requestAnimationFrameId) &#123;</span><br><span class="line">        raf.cancel(requestAnimationFrameId);</span><br><span class="line">      &#125;</span><br><span class="line">      node.style.height = <span class="string">''</span>;</span><br><span class="line">      node.style.opacity = <span class="string">''</span>;</span><br><span class="line">      done();</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> animation = &#123;</span><br><span class="line">  enter(node: HTMLElement, <span class="attr">done</span>: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">void</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> animate(node, <span class="literal">true</span>, done);</span><br><span class="line">  &#125;,</span><br><span class="line">  leave(node: HTMLElement, <span class="attr">done</span>: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">void</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> animate(node, <span class="literal">false</span>, done);</span><br><span class="line">  &#125;,</span><br><span class="line">  appear(node: HTMLElement, <span class="attr">done</span>: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">void</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> animate(node, <span class="literal">true</span>, done);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Menu</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span>&lt;<span class="title">MenuProps</span>, <span class="title">MenuState</span>&gt; </span>&#123;</span><br><span class="line">  componentWillReceiveProps(nextProps: MenuProps, <span class="attr">nextContext</span>: SiderContext) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.props.mode === <span class="string">'inline'</span> &amp;&amp;</span><br><span class="line">        nextProps.mode !== <span class="string">'inline'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.switchingModeFromInline = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'openKeys'</span> <span class="keyword">in</span> nextProps) &#123;</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123; <span class="attr">openKeys</span>: nextProps.openKeys! &#125;);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((nextProps.inlineCollapsed &amp;&amp; !<span class="keyword">this</span>.props.inlineCollapsed) ||</span><br><span class="line">        (nextContext.siderCollapsed &amp;&amp; !<span class="keyword">this</span>.context.siderCollapsed)) &#123;</span><br><span class="line">      <span class="keyword">this</span>.switchingModeFromInline = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">this</span>.inlineOpenKeys = <span class="keyword">this</span>.state.openKeys;<span class="comment">// 缓存 inline 模式展开的菜单项</span></span><br><span class="line">      <span class="keyword">this</span>.setState(&#123; <span class="attr">openKeys</span>: [] &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((!nextProps.inlineCollapsed &amp;&amp; <span class="keyword">this</span>.props.inlineCollapsed) ||</span><br><span class="line">        (!nextContext.siderCollapsed &amp;&amp; <span class="keyword">this</span>.context.siderCollapsed)) &#123;</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123; <span class="attr">openKeys</span>: <span class="keyword">this</span>.inlineOpenKeys &#125;);</span><br><span class="line">      <span class="keyword">this</span>.inlineOpenKeys = [];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Restore vertical mode when menu is collapsed responsively when mounted</span></span><br><span class="line">  <span class="comment">// https://github.com/ant-design/ant-design/issues/13104</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> not a perfect solution, looking a new way to avoid setting switchingModeFromInline in this situation</span></span><br><span class="line">  <span class="comment">// 折叠状态刷新页面，因为未执行动效，switchingModeFromInline 仍为真，显示为 inline 模式</span></span><br><span class="line">  handleMouseEnter = <span class="function">(<span class="params">e: MouseEvent</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.restoreModeVerticalFromInline();</span><br><span class="line">    <span class="keyword">const</span> &#123; onMouseEnter &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">if</span> (onMouseEnter) &#123;</span><br><span class="line">      onMouseEnter(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleTransitionEnd = <span class="function">(<span class="params">e: TransitionEvent</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// when inlineCollapsed menu width animation finished</span></span><br><span class="line">    <span class="comment">// https://github.com/ant-design/ant-design/issues/12864</span></span><br><span class="line">    <span class="keyword">const</span> widthCollapsed = e.propertyName === <span class="string">'width'</span> &amp;&amp; e.target === e.currentTarget;</span><br><span class="line">    <span class="comment">// Fix for &lt;Menu style=&#123;&#123; width: '100%' &#125;&#125; /&gt;, the width transition won't trigger when menu is collapsed</span></span><br><span class="line">    <span class="comment">// https://github.com/ant-design/ant-design-pro/issues/2783</span></span><br><span class="line">    <span class="keyword">const</span> iconScaled = e.propertyName === <span class="string">'font-size'</span> &amp;&amp; (e.target <span class="keyword">as</span> HTMLElement).className.indexOf(<span class="string">'anticon'</span>) &gt;= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (widthCollapsed || iconScaled) &#123;</span><br><span class="line">      <span class="keyword">this</span>.restoreModeVerticalFromInline();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 重置 switchingModeFromInline，并重绘菜单</span></span><br><span class="line">  restoreModeVerticalFromInline() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.switchingModeFromInline) &#123;</span><br><span class="line">      <span class="keyword">this</span>.switchingModeFromInline = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 是否折叠，取决于侧边栏的折叠情况、内嵌模式的折叠情况</span></span><br><span class="line">  getInlineCollapsed() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; inlineCollapsed &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.context.siderCollapsed !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.context.siderCollapsed;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> inlineCollapsed;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 由 inline 模式转换成其他模式时，首先保持 inline 模式，目的是执行子菜单折叠动效</span></span><br><span class="line">  <span class="comment">// 在 inline 模式下，收起菜单也将先保持 inline 模式</span></span><br><span class="line">  getRealMenuMode() &#123;</span><br><span class="line">    <span class="keyword">const</span> inlineCollapsed = <span class="keyword">this</span>.getInlineCollapsed();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.switchingModeFromInline &amp;&amp; inlineCollapsed) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'inline'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> &#123; mode &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">return</span> inlineCollapsed ? <span class="string">'vertical'</span> : mode;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getMenuOpenAnimation(menuMode: MenuMode) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; openAnimation, openTransitionName &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">let</span> menuOpenAnimation = openAnimation || openTransitionName;</span><br><span class="line">    <span class="keyword">if</span> (openAnimation === <span class="literal">undefined</span> &amp;&amp; openTransitionName === <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (menuMode) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'horizontal'</span>:</span><br><span class="line">          menuOpenAnimation = <span class="string">'slide-up'</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'vertical'</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'vertical-left'</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'vertical-right'</span>:</span><br><span class="line">          <span class="comment">// When mode switch from inline submenu should hide without animation</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">this</span>.switchingModeFromInline) &#123;</span><br><span class="line">            menuOpenAnimation = <span class="string">''</span>;</span><br><span class="line">            <span class="keyword">this</span>.switchingModeFromInline = <span class="literal">false</span>;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            menuOpenAnimation = <span class="string">'zoom-big'</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'inline'</span>:</span><br><span class="line">          menuOpenAnimation = animation;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> menuOpenAnimation;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="SubMenu-1"><a href="#SubMenu-1" class="headerlink" title="SubMenu"></a>SubMenu</h3><p>SubMenu 使用 RcSubMenu 绘制子菜单。逻辑上，SubMenu 通过 context.antdMenuTheme 设置子菜单的主题样式；又实现 onKeyDown 方法，以桥接 SubPopupMenu 和 RcSubMenu 中的同名方法（参见上文）。</p>
<h3 id="MenuItem"><a href="#MenuItem" class="headerlink" title="MenuItem"></a>MenuItem</h3><p>MenuItem 使用 RcMenuItem 绘制菜单项。逻辑上，MenuItem 既像 SubMenu 那样实现了 onKeyDown 方法；又使用 Tooltip 绘制气泡框。当 context.inlineCollapsed 为 true 且 props.level 为 1（菜单项层级为1）时，将使用<a href="https://ant.design/components/tooltip-cn/" target="_blank" rel="noopener">气泡框组件</a>绘制子元素。</p>
<h3 id="样式处理"><a href="#样式处理" class="headerlink" title="样式处理"></a>样式处理</h3><ol>
<li>菜单折叠前后展示样式：</li>
</ol>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.@&#123;menu-prefix-cls&#125;</span> &#123;</span><br><span class="line">  <span class="selector-tag">&amp;</span><span class="selector-tag">-item</span>,</span><br><span class="line">  <span class="selector-tag">&amp;</span><span class="selector-tag">-submenu-title</span> &#123;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span> <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">    <span class="attribute">white-space</span>: nowrap;</span><br><span class="line">    <span class="attribute">transition</span>: color .<span class="number">3s</span> <span class="variable">@ease-in-out</span>, border-color .<span class="number">3s</span> <span class="variable">@ease-in-out</span>, background .<span class="number">3s</span> <span class="variable">@ease-in-out</span>, padding .<span class="number">15s</span> <span class="variable">@ease-in-out</span>;</span><br><span class="line">    <span class="selector-class">.@&#123;iconfont-css-prefix&#125;</span> &#123;</span><br><span class="line">      <span class="attribute">min-width</span>: <span class="number">14px</span>;</span><br><span class="line">      <span class="attribute">margin-right</span>: <span class="number">10px</span>;</span><br><span class="line">      <span class="attribute">font-size</span>: <span class="variable">@font-size-base</span>;</span><br><span class="line">      <span class="attribute">transition</span>: font-size .<span class="number">15s</span> <span class="variable">@ease-out</span>, margin .<span class="number">3s</span> <span class="variable">@ease-in-out</span>;</span><br><span class="line">      + <span class="selector-tag">span</span> &#123;</span><br><span class="line">        <span class="attribute">transition</span>: opacity .<span class="number">3s</span> <span class="variable">@ease-in-out</span>, width .<span class="number">3s</span> <span class="variable">@ease-in-out</span>;</span><br><span class="line">        <span class="attribute">opacity</span>: <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-tag">&amp;</span><span class="selector-tag">-inline-collapsed</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="variable">@menu-collapsed-width</span>;</span><br><span class="line">    &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-item</span>,</span><br><span class="line">    &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-item-group</span> &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-item-group-list</span> &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-item</span>,</span><br><span class="line">    &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-item-group</span> &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-item-group-list</span> &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu</span> &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu-title</span>,</span><br><span class="line">    &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu</span> &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu-title</span> &#123;</span><br><span class="line">      <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">      <span class="attribute">text-overflow</span>: clip;<span class="comment">// 裁剪超出文本</span></span><br><span class="line">      <span class="attribute">padding</span>: <span class="number">0</span> (<span class="variable">@menu-collapsed-width</span> - <span class="number">16px</span>) / <span class="number">2</span> <span class="meta">!important</span>;</span><br><span class="line">      <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu-arrow</span> &#123;<span class="comment">// 隐藏展开折叠图标</span></span><br><span class="line">        <span class="attribute">display</span>: none;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="selector-class">.@&#123;iconfont-css-prefix&#125;</span> &#123;</span><br><span class="line">        <span class="attribute">font-size</span>: <span class="number">16px</span>;</span><br><span class="line">        <span class="attribute">line-height</span>: <span class="variable">@menu-item-height</span>;</span><br><span class="line">        <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">        + <span class="selector-tag">span</span> &#123;<span class="comment">// 隐藏文本</span></span><br><span class="line">          <span class="attribute">max-width</span>: <span class="number">0</span>;</span><br><span class="line">          <span class="attribute">display</span>: inline-block;</span><br><span class="line">          <span class="attribute">opacity</span>: <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>子菜单浮层：</li>
</ol>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.@&#123;menu-prefix-cls&#125;</span> &#123;</span><br><span class="line">  <span class="selector-tag">&amp;</span><span class="selector-tag">-submenu</span> &#123;</span><br><span class="line">    <span class="selector-tag">&amp;</span><span class="selector-tag">-popup</span> &#123;</span><br><span class="line">      <span class="attribute">position</span>: absolute;</span><br><span class="line">      <span class="attribute">border-radius</span>: <span class="variable">@border-radius-base</span>;</span><br><span class="line">      <span class="attribute">z-index</span>: <span class="variable">@zindex-dropdown</span>;</span><br><span class="line">      <span class="attribute">background</span>: <span class="variable">@menu-popup-bg</span>;</span><br><span class="line"></span><br><span class="line">      <span class="selector-class">.submenu-title-wrapper</span> &#123;</span><br><span class="line">        <span class="attribute">padding-right</span>: <span class="number">20px</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="selector-tag">&amp;</span><span class="selector-pseudo">:before</span> &#123;</span><br><span class="line">        <span class="attribute">position</span>: absolute;</span><br><span class="line">        <span class="attribute">top</span>: -<span class="number">7px</span>;</span><br><span class="line">        <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">        <span class="attribute">right</span>: <span class="number">0</span>;</span><br><span class="line">        <span class="attribute">bottom</span>: <span class="number">0</span>;</span><br><span class="line">        <span class="attribute">content</span>: <span class="string">' '</span>;</span><br><span class="line">        <span class="attribute">opacity</span>: .<span class="number">0001</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>折叠按钮旋转动效：</li>
</ol>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.@&#123;menu-prefix-cls&#125;</span> &#123;</span><br><span class="line">  <span class="selector-tag">&amp;</span><span class="selector-tag">-submenu</span> &#123;<span class="selector-tag">&amp;</span><span class="selector-tag">-vertical</span>,</span><br><span class="line">    <span class="selector-tag">&amp;</span><span class="selector-tag">-vertical-left</span>,</span><br><span class="line">    <span class="selector-tag">&amp;</span><span class="selector-tag">-vertical-right</span>,</span><br><span class="line">    <span class="selector-tag">&amp;</span><span class="selector-tag">-inline</span> &#123;</span><br><span class="line">      &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu-title</span> <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu-arrow</span> &#123;</span><br><span class="line">        <span class="attribute">transition</span>: transform .<span class="number">3s</span> <span class="variable">@ease-in-out</span>;</span><br><span class="line">        <span class="attribute">position</span>: absolute;</span><br><span class="line">        <span class="attribute">top</span>: <span class="number">50%</span>;</span><br><span class="line">        <span class="attribute">right</span>: <span class="number">16px</span>;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">10px</span>;</span><br><span class="line">        <span class="selector-tag">&amp;</span><span class="selector-pseudo">:before</span>,</span><br><span class="line">        <span class="selector-tag">&amp;</span><span class="selector-pseudo">:after</span> &#123;</span><br><span class="line">          <span class="attribute">content</span>: <span class="string">""</span>;</span><br><span class="line">          <span class="attribute">position</span>: absolute;</span><br><span class="line">          <span class="attribute">vertical-align</span>: baseline;</span><br><span class="line">          <span class="attribute">background</span>: <span class="number">#fff</span>;</span><br><span class="line">          <span class="attribute">background-image</span>: linear-gradient(to right, <span class="variable">@menu-item-color</span>, <span class="variable">@menu-item-color</span>);<span class="comment">// 渐变</span></span><br><span class="line">          <span class="attribute">width</span>: <span class="number">6px</span>;</span><br><span class="line">          <span class="attribute">height</span>: <span class="number">1.5px</span>;</span><br><span class="line">          <span class="attribute">border-radius</span>: <span class="number">2px</span>;</span><br><span class="line">          <span class="attribute">transition</span>: background .<span class="number">3s</span> <span class="variable">@ease-in-out</span>, transform .<span class="number">3s</span> <span class="variable">@ease-in-out</span>, top .<span class="number">3s</span> <span class="variable">@ease-in-out</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="selector-tag">&amp;</span><span class="selector-pseudo">:before</span> &#123;</span><br><span class="line">          <span class="attribute">transform</span>: rotate(<span class="number">45deg</span>) translateY(-<span class="number">2px</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="selector-tag">&amp;</span><span class="selector-pseudo">:after</span> &#123;</span><br><span class="line">          <span class="attribute">transform</span>: rotate(-<span class="number">45deg</span>) translateY(<span class="number">2px</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu-title</span><span class="selector-pseudo">:hover</span> <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu-arrow</span> &#123;</span><br><span class="line">        <span class="selector-tag">&amp;</span><span class="selector-pseudo">:after</span>,</span><br><span class="line">        <span class="selector-tag">&amp;</span><span class="selector-pseudo">:before</span> &#123;</span><br><span class="line">          <span class="attribute">background</span>: linear-gradient(to right, <span class="variable">@menu-highlight-color</span>, <span class="variable">@menu-highlight-color</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="selector-tag">&amp;</span><span class="selector-tag">-inline</span> &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu-title</span> <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu-arrow</span> &#123;</span><br><span class="line">      <span class="selector-tag">&amp;</span><span class="selector-pseudo">:before</span> &#123;</span><br><span class="line">        <span class="attribute">transform</span>: rotate(-<span class="number">45deg</span>) translateX(<span class="number">2px</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="selector-tag">&amp;</span><span class="selector-pseudo">:after</span> &#123;</span><br><span class="line">        <span class="attribute">transform</span>: rotate(<span class="number">45deg</span>) translateX(-<span class="number">2px</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="selector-tag">&amp;</span><span class="selector-tag">-open</span> &#123;</span><br><span class="line">      <span class="selector-tag">&amp;</span><span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu-inline</span> &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu-title</span> <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu-arrow</span> &#123;</span><br><span class="line">        <span class="attribute">transform</span>: translateY(-<span class="number">2px</span>);</span><br><span class="line">        <span class="selector-tag">&amp;</span><span class="selector-pseudo">:after</span> &#123;</span><br><span class="line">          <span class="attribute">transform</span>: rotate(-<span class="number">45deg</span>) translateX(-<span class="number">2px</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="selector-tag">&amp;</span><span class="selector-pseudo">:before</span> &#123;</span><br><span class="line">          <span class="attribute">transform</span>: rotate(<span class="number">45deg</span>) translateX(<span class="number">2px</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol>
<li>清除浮动：</li>
</ol>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.clearfix</span>() &#123;</span><br><span class="line">  <span class="attribute">zoom</span>: <span class="number">1</span>;</span><br><span class="line">  <span class="selector-tag">&amp;</span><span class="selector-pseudo">:before</span>,</span><br><span class="line">  <span class="selector-tag">&amp;</span><span class="selector-pseudo">:after</span> &#123;</span><br><span class="line">    <span class="attribute">content</span>: <span class="string">""</span>;</span><br><span class="line">    <span class="attribute">display</span>: table;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-tag">&amp;</span><span class="selector-pseudo">:after</span> &#123;</span><br><span class="line">    <span class="attribute">clear</span>: both;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.@&#123;menu-prefix-cls&#125;</span> &#123;</span><br><span class="line">  <span class="selector-class">.clearfix</span>;</span><br><span class="line"></span><br><span class="line">  <span class="selector-tag">&amp;</span><span class="selector-tag">-horizontal</span> &#123;</span><br><span class="line">    <span class="selector-tag">&amp;</span><span class="selector-pseudo">:after</span> &#123;</span><br><span class="line">      <span class="attribute">content</span>: <span class="string">"\20"</span>;</span><br><span class="line">      <span class="attribute">display</span>: block;</span><br><span class="line">      <span class="attribute">height</span>: <span class="number">0</span>;</span><br><span class="line">      <span class="attribute">clear</span>: both;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>本文对子菜单的浮层显示和菜单栏的动效处理仍有不足。关于 rc-animate, rc-trigger，笔者将在后续的文章中加以分析。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/27/antd/Radio, Checkbox/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/27/antd/Radio, Checkbox/" itemprop="url">Radio, Checkbox</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-27T00:00:00+08:00">2018-11-27</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/antd-组件库/" itemprop="url" rel="index"><span itemprop="name">antd 组件库</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/27/antd/Radio, Checkbox/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/11/27/antd/Radio, Checkbox/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>antd 中的 Radio, Checkbox 组件均基于 rc-checkbox 实现。本文第一部分将介绍 <a href="https://github.com/react-component/checkbox" target="_blank" rel="noopener">rc-checkbox</a>，余下两部分再介绍 Radio, Checkbox 组件。</p>
<h2 id="rc-checkbox"><a href="#rc-checkbox" class="headerlink" title="rc-checkbox"></a>rc-checkbox</h2><p>rc-checkbox 输出 Checkbox 组件。其处理逻辑较为简单，包含样式类转换、多余 props 剔除等。元素层级上，rc-checkbox 使用 span 包裹 input 节点和内层 span 节点（该 span 节点将绘制可见的单选框样式）。样式类转换指 span 元素的样式类包含或可能包含 props.prefixCls, props.className, <code>${props.prefixCls}-checked</code>, <code>${props.prefixCls}-disabled</code>；input 节点的样式类为 <code>${props.prefixCls}-input</code>；内层 span 节点的样式类为 <code>${props.prefixCls}-inner</code>。多余 props 剔除指 input 元素只接受 name, id, type, readOnly, disabled, tabIndex, checked, onClick, onFocus, onBlur, onChange, autoFocus, value, ‘aria-<em>‘, ‘data-</em>‘, role 属性。其中，checked 由 Checkbox 组件的 state.checked 设定；onChange 设置为 Checkbox 组件的 handleChange 方法。当 input 节点数据变更时，props.onChange 接受到的数据先经由 Checkbox 组件转换。以下是其实现。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">handleChange = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; props &#125; = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">if</span> (props.disabled) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!(<span class="string">'checked'</span> <span class="keyword">in</span> props)) &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">      checked: e.target.checked,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  props.onChange(&#123;</span><br><span class="line">    target: &#123;</span><br><span class="line">      ...props,</span><br><span class="line">      checked: e.target.checked,</span><br><span class="line">    &#125;,</span><br><span class="line">    stopPropagation() &#123;</span><br><span class="line">      e.stopPropagation();</span><br><span class="line">    &#125;,</span><br><span class="line">    preventDefault() &#123;</span><br><span class="line">      e.preventDefault();</span><br><span class="line">    &#125;,</span><br><span class="line">    nativeEvent: e.nativeEvent,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="Radio-组件"><a href="#Radio-组件" class="headerlink" title="Radio 组件"></a>Radio 组件</h2><p>antd 提供三种单选框组件：单选框 Radio, 单选框组合 RadioGroup, 单选框按钮 RadioButton。</p>
<p>Radio 组件的特殊处理逻辑为：通过 context.radioGroup = { name, onChange, value, disabled } 获得 RadioGroup 组件注入的数据，以与单选框组合完成交互。</p>
<p>Radio 组件的元素层级关系为 label 元素和 RcCheckbox 组件。以下 less 样式中，.@{radio-prefix-cls} 即 RcCheckbox 组件绘制的外层 span 元素；.@{radio-inner-prefix-cls} 即 RcCheckbox 组件绘制的内层 span 元素。Radio 组件呈现在视图上的样式以内层 span 元素及其 span:after 伪类内容绘制，选中时 span:after 设置 opacity: 1 样式。以下是 less 代码。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.@&#123;radio-prefix-cls&#125;</span> &#123;</span><br><span class="line">  <span class="selector-tag">&amp;</span><span class="selector-tag">-inner</span> &#123;</span><br><span class="line">    <span class="selector-tag">&amp;</span><span class="selector-pseudo">:after</span> &#123;</span><br><span class="line">      <span class="variable">@radio-dot-size:</span> <span class="variable">@radio-size</span> - <span class="number">8px</span>;</span><br><span class="line">      <span class="attribute">position</span>: absolute;</span><br><span class="line">      <span class="attribute">width</span>: <span class="variable">@radio-dot-size</span>;</span><br><span class="line">      <span class="attribute">height</span>: <span class="variable">@radio-dot-size</span>;</span><br><span class="line">      <span class="attribute">left</span>: (<span class="variable">@radio-size</span> - <span class="variable">@radio-dot-size</span>) / <span class="number">2</span> - <span class="number">1px</span>;</span><br><span class="line">      <span class="attribute">top</span>: (<span class="variable">@radio-size</span> - <span class="variable">@radio-dot-size</span>) / <span class="number">2</span> - <span class="number">1px</span>;</span><br><span class="line">      <span class="attribute">border-radius</span>: <span class="variable">@radio-dot-size</span>;</span><br><span class="line">      <span class="attribute">display</span>: table;</span><br><span class="line">      <span class="attribute">border-top</span>: <span class="number">0</span>;</span><br><span class="line">      <span class="attribute">border-left</span>: <span class="number">0</span>;</span><br><span class="line">      <span class="attribute">content</span>: <span class="string">' '</span>;</span><br><span class="line">      <span class="attribute">background-color</span>: <span class="variable">@radio-dot-color</span>;</span><br><span class="line">      <span class="attribute">opacity</span>: <span class="number">0</span>;</span><br><span class="line">      <span class="attribute">transform</span>: scale(<span class="number">0</span>);</span><br><span class="line">      <span class="attribute">transition</span>: all <span class="variable">@radio-duration</span> <span class="variable">@ease-in-out-circ</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">    <span class="attribute">width</span>: <span class="variable">@radio-size</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="variable">@radio-size</span>;</span><br><span class="line">    <span class="attribute">border-width</span>: <span class="number">1px</span>;</span><br><span class="line">    <span class="attribute">border-style</span>: solid;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">100px</span>;</span><br><span class="line">    <span class="attribute">border-color</span>: <span class="variable">@border-color-base</span>;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="variable">@radio-button-bg</span>;</span><br><span class="line">    <span class="attribute">transition</span>: all <span class="variable">@radio-duration</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.@&#123;radio-prefix-cls&#125;</span><span class="selector-tag">-checked</span> &#123;</span><br><span class="line">  <span class="selector-class">.@&#123;radio-inner-prefix-cls&#125;</span> &#123;</span><br><span class="line">    <span class="attribute">border-color</span>: <span class="variable">@radio-dot-color</span>;</span><br><span class="line">    <span class="selector-tag">&amp;</span><span class="selector-pseudo">:after</span> &#123;</span><br><span class="line">      <span class="attribute">transform</span>: scale(.<span class="number">875</span>);</span><br><span class="line">      <span class="attribute">opacity</span>: <span class="number">1</span>;</span><br><span class="line">      <span class="attribute">transition</span>: all <span class="variable">@radio-duration</span> <span class="variable">@ease-in-out-circ</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RadioButton 组件的渲染过程无甚特别之处，主要是默认将 props.prefixCls 设定为 ‘ant-radio-button’。</p>
<p>RadioGroup 组件接受 props.options 作为选项配置内容（props.options 数组项内容可以是字符串或对象）；并将 radioGroup 作为 context 内容传入子孙组件中。</p>
<h2 id="Checkbox"><a href="#Checkbox" class="headerlink" title="Checkbox"></a>Checkbox</h2><p>antd 提供两种复选框组件：复选框 Checkbox, 复选框组合 CheckboxGroup。</p>
<p>Checkbox 组件与 Radio 组件的实现无异，只是其接受的 context 数据内容为 checkboxGroup = { toggleOption, value, disabled } 属性。其中，toggleOption 用于影响 Checkbox 组件的 onChange 绑定函数，即改变 CheckboxGroup 组件的 state.value 状态；value 用于判断当前 Checkbox 组件是否处于选中状态。</p>
<p>CheckboxGroup 组件也与 RadioGroup 组件无异，只是其实现 toggleOption 方法，用于在复选框勾选或取消勾选时，实时更新 state.value 值，并调用 props.onChange 方法；并通过 context 注入到子孙组件中。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/25/antd/Layout/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/25/antd/Layout/" itemprop="url">Layout 布局</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-25T00:00:00+08:00">2018-11-25</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/antd-组件库/" itemprop="url" rel="index"><span itemprop="name">antd 组件库</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/25/antd/Layout/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/11/25/antd/Layout/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>antd 提供 Layout, Header, Sider, Content, Footer 组件用于划定页面布局。实现上，侧边栏 Sider 组件比较特殊，将在第一部分加以介绍；其余组件均将在第一部分加以介绍。</p>
<h2 id="Layout"><a href="#Layout" class="headerlink" title="Layout"></a>Layout</h2><p>布局容器 Layout, 顶部布局 Header, 内容部分 Content, 底部布局 Footer 在实现上大体相当：都是通过 generator(props) = BasicComponent =&gt; Adapter 创建高阶组件 Adapter，再由该高阶组件将 props.prefixCls 注入到 BasicComponent 中。</p>
<p>作为 Layout 组件的 BasicComponent，BasicLayout 组件以 state.siders 记录侧边栏的 id，并允许在子组件中使用 context.siderHook 添加或移除侧边栏，其意义是触发 BasicLayout 组件重绘并判断是否需要添加 .ant-layout-has-sider 样式类。作为 Header, Content, Footer 组件的 BasicComponent，Basic 组件只用于拼接 props.prefixCls, props.className，以构成新的样式类。</p>
<p>Header, Sider, Content, Footer 组件只能作为 Layout 的子组件这一特征，由 less 文件约定，即如果当上述组件不作为 Layout 的子组件时，其样式将得不到正常展示。</p>
<h2 id="Sider"><a href="#Sider" class="headerlink" title="Sider"></a>Sider</h2><p>侧边栏 Sider 组件用于设定布局，其内容可由 <a href="https://ant.design/components/menu-cn/" target="_blank" rel="noopener">Menu 组件</a> 绘制。在 componentDidMount, componentWillUnmount 生命周期中，侧边栏组件也将通过 context.siderHook.addSider, context.siderHook.removeSider 方法，以添加或移除 Layout 容器中记录的侧边栏 id。侧边栏组件既可以根据折叠状态切换按钮展开或折叠（通过 props.collapsible 或 props.collapsedWidth = 0 开启）；也可以根据屏幕尺寸响应式展开或折叠（通过 props.breakpoint 属性开启），其实现借助 window.matchMedia 方法。子组件可通过 context.siderCollapsed 获得侧边栏的展开和折叠状态。以下是响应式展开或折叠功能的实现。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// matchMedia polyfill for</span></span><br><span class="line"><span class="comment">// https://github.com/WickyNilliams/enquire.js/issues/82</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">window</span> !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> matchMediaPolyfill = <span class="function">(<span class="params">mediaQuery: string</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      media: mediaQuery,</span><br><span class="line">      matches: <span class="literal">false</span>,</span><br><span class="line">      addListener() &#123;</span><br><span class="line">      &#125;,</span><br><span class="line">      removeListener() &#123;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="built_in">window</span>.matchMedia = <span class="built_in">window</span>.matchMedia || matchMediaPolyfill;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sider</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span>&lt;<span class="title">SiderProps</span>, <span class="title">SiderState</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props: SiderProps) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> matchMedia;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">window</span> !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">      matchMedia = <span class="built_in">window</span>.matchMedia;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (matchMedia &amp;&amp; props.breakpoint &amp;&amp; props.breakpoint <span class="keyword">in</span> dimensionMap) &#123;</span><br><span class="line">      <span class="keyword">this</span>.mql = matchMedia(<span class="string">`(max-width: <span class="subst">$&#123;dimensionMap[props.breakpoint]&#125;</span>)`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.mql) &#123;</span><br><span class="line">      <span class="keyword">this</span>.mql.addListener(<span class="keyword">this</span>.responsiveHandler);</span><br><span class="line">      <span class="keyword">this</span>.responsiveHandler(<span class="keyword">this</span>.mql);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  responsiveHandler = <span class="function">(<span class="params">mql: MediaQueryListEvent | MediaQueryList</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; <span class="attr">below</span>: mql.matches &#125;);</span><br><span class="line">    <span class="keyword">const</span> &#123; onBreakpoint &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">if</span> (onBreakpoint) &#123;</span><br><span class="line">      onBreakpoint(mql.matches);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.state.collapsed !== mql.matches) &#123;</span><br><span class="line">      <span class="keyword">this</span>.setCollapsed(mql.matches, <span class="string">'responsive'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setCollapsed = <span class="function">(<span class="params">collapsed: boolean, type: CollapseType</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(<span class="string">'collapsed'</span> <span class="keyword">in</span> <span class="keyword">this</span>.props)) &#123;</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">        collapsed,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> &#123; onCollapse &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">if</span> (onCollapse) &#123;</span><br><span class="line">      onCollapse(collapsed, type);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>侧边栏组件的断点 props.breakpoint 包含五种可能：xs 为 480px；sm 为 576px；md 为 768px；lg 为 992px；xl 为 1200px；xxl 为 1600px。当设置了 props.breakpoint 时，就能实现响应式展开与折叠功能。</p>
<p>当 props.collapsedWidth 设置为 0，折叠状态切换按钮为 bars 类型。默认的折叠状态切换按钮为 left 或 right 类型。此外，可以使用 props.trigger 设置自定义折叠状态切换按钮。</p>
<p>侧边栏的主题样式通过设置样式类实现，如 ant-layout-sider-light。</p>
<p>侧边栏组件使用 <a href="https://github.com/reactjs/react-lifecycles-compat" target="_blank" rel="noopener">react-lifecycles-compat</a> 封装，以在低版本的 react 中书写 static getDerivedStateFromProps, getSnapshotBeforeUpdate 生命周期方法。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/25/antd/Grid/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/25/antd/Grid/" itemprop="url">Grid 栅格</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-25T00:00:00+08:00">2018-11-25</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/antd-组件库/" itemprop="url" rel="index"><span itemprop="name">antd 组件库</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/25/antd/Grid/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/11/25/antd/Grid/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>antd 提供的 24 栅格系统由 Row, Col 组件实现。</p>
<h2 id="Row"><a href="#Row" class="headerlink" title="Row"></a>Row</h2><p>栅格布局组件 Row 用于设定整行 row 内各组 col 的布局风格。当 props.type 为 ‘flex’ 时，意味着整行采用 flex 布局。在 flex 布局的基础上，props.justify 通过 justify-content 样式影响各 col 元素的水平排列方式；props.align 通过 align-items 样式影响各 col 元素的垂直对齐方式。props.gutter 用于设定各 col 元素的间隔，间隔单位可以是 ‘px’ 或 ‘rem’。Row 支持以对象形式配置 props.gutter，如 { xs, sm, md, lg, xl, xxl }。其中，xs 为 576 px 以下屏幕；sm 为 576 - 768 px 尺寸屏幕；md 为 768 - 992 px 尺寸屏幕；lg 为 992 - 1200 px 尺寸屏幕；xl 为 1200 - 1600 px 尺寸屏幕；xxl 为 1600 px 以上屏幕；</p>
<p>在响应式处理上，Row 组件借助 <a href="https://github.com/WickyNilliams/enquire.js" target="_blank" rel="noopener">enquire.js</a> 库实现。其场景如以 { md: 8, lg: 16 } 对象配置 props.gutter，那么，当屏幕尺寸小于 768px 时，就需要将各 col 元素的间隔从 16 px 调整为 8px。Row 组件对这一场景的实现机制为，在 componentDidMount 生命周期使用 enquire.js 库绑定监听函数，以使得当屏幕尺寸变更时，state.screen 当前屏幕状态也会相应得到更新；随后在 render 阶段，由 getGutter 方法获得当前屏幕尺寸下的 col 元素间隔 gutter，并借助 <a href="https://github.com/jamiebuilds/create-react-context" target="_blank" rel="noopener">create-react-context</a> 库将 gutter 注入到 Col 组件中。以下是该机制实现的源码。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">componentDidMount() &#123;</span><br><span class="line">  <span class="built_in">Object</span>.keys(responsiveMap)</span><br><span class="line">    .map(<span class="function">(<span class="params">screen: Breakpoint</span>) =&gt;</span> enquire.register(responsiveMap[screen], &#123;</span><br><span class="line">        match: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="keyword">this</span>.props.gutter !== <span class="string">'object'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">this</span>.setState(<span class="function">(<span class="params">prevState</span>) =&gt;</span> (&#123;</span><br><span class="line">            screens: &#123;</span><br><span class="line">              ...prevState.screens,</span><br><span class="line">              [screen]: <span class="literal">true</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;));</span><br><span class="line">        &#125;,</span><br><span class="line">        unmatch: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="keyword">this</span>.props.gutter !== <span class="string">'object'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">this</span>.setState(<span class="function">(<span class="params">prevState</span>) =&gt;</span> (&#123;</span><br><span class="line">            screens: &#123;</span><br><span class="line">              ...prevState.screens,</span><br><span class="line">              [screen]: <span class="literal">false</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;));</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// Keep a empty destory to avoid triggering unmatch when unregister</span></span><br><span class="line">        destroy() &#123;&#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    ));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getGutter(): number | <span class="literal">undefined</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; gutter &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> gutter === <span class="string">'object'</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= responsiveArray.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> breakpoint: Breakpoint = responsiveArray[i];</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.state.screens[breakpoint] &amp;&amp; gutter[breakpoint] !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> gutter[breakpoint];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> gutter <span class="keyword">as</span> number;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在样式处理方面，整行 row 采用 border-box 盒模型，相对定位，并嵌套使用 .clearfix 样式规则以清除浮动以及 :before, :after 伪类的内容。其余均较为简单，可参见<a href="https://github.com/ant-design/ant-design/blob/master/components/form/style/index.less" target="_blank" rel="noopener">源码</a>。</p>
<h2 id="Col"><a href="#Col" class="headerlink" title="Col"></a>Col</h2><p>Col 组件主要通过样式类以设定 col 元素的大小和偏移情况。如当配置了 props.offset 属性为 4 时，将相应添加 ant-col-xs-offset-4, ant-col-sm-offset-4, ant-col-md-offset-4, ant-col-lg-offset-4, ant-col-xl-offset-4, ant-col-xll-offset-4 样式类。因此，Col 组件的逻辑主要是将 props 转化成样式类，其实现的重点仍在于 less 样式文件。</p>
<p>当然，各 col 元素的间隔 gutter 由 Row 组件传入。以下是其源码实现，RowContext 通过 create-react-context 库创建，即通过 context 属性传递数据，但只有 Col 组件能加以访问。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Row</span></span><br><span class="line">render() &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;RowContext.Provider value=&#123;&#123; gutter &#125;&#125;&gt;</span><br><span class="line">      &lt;div &#123;...otherProps&#125; className=&#123;classes&#125; style=&#123;rowStyle&#125;&gt;</span><br><span class="line">        &#123;children&#125;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>RowContext.Provider&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Col</span></span><br><span class="line">render() &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;RowContext.Consumer&gt;</span><br><span class="line">      &#123;(&#123; gutter &#125;) =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> style = others.style;</span><br><span class="line">        <span class="keyword">if</span> (gutter <span class="keyword">as</span> number &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          style = &#123;</span><br><span class="line">            paddingLeft: (gutter <span class="keyword">as</span> number) / <span class="number">2</span>,</span><br><span class="line">            paddingRight: (gutter <span class="keyword">as</span> number) / <span class="number">2</span>,</span><br><span class="line">            ...style,</span><br><span class="line">          &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">div</span> &#123;<span class="attr">...others</span>&#125; <span class="attr">style</span>=<span class="string">&#123;style&#125;</span> <span class="attr">className</span>=<span class="string">&#123;classes&#125;</span>&gt;</span>&#123;children&#125;<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span>;</span><br><span class="line">      &#125;&#125;</span><br><span class="line">    &lt;<span class="regexp">/RowContext.Consumer&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>在 less 文件中，antd 使用自调用的混合函数创建从 .ant-col-1 到 .ant-col-24 的样式规则。以下是相关源码。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// style/theme/default.less</span></span><br><span class="line"><span class="variable">@grid-columns:</span> <span class="number">24</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mixin.less</span></span><br><span class="line"><span class="comment">// index 由 1 到 24，构建样式规则</span></span><br><span class="line"><span class="selector-class">.make-grid-columns</span>() &#123;</span><br><span class="line">  <span class="selector-class">.col</span>(<span class="variable">@index</span>) &#123;</span><br><span class="line">    <span class="variable">@item:</span> <span class="string">~".@&#123;ant-prefix&#125;-col-@&#123;index&#125;, .@&#123;ant-prefix&#125;-col-xs-@&#123;index&#125;, .@&#123;ant-prefix&#125;-col-sm-@&#123;index&#125;, .@&#123;ant-prefix&#125;-col-md-@&#123;index&#125;, .@&#123;ant-prefix&#125;-col-lg-@&#123;index&#125;"</span>;</span><br><span class="line">    <span class="selector-class">.col</span>((<span class="variable">@index</span> + <span class="number">1</span>), <span class="variable">@item</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.col</span>(<span class="variable">@index</span>, <span class="variable">@list</span>) <span class="keyword">when</span> (<span class="variable">@index</span> =&lt; <span class="variable">@grid-columns</span>) &#123;</span><br><span class="line">    <span class="variable">@item:</span> <span class="string">~".@&#123;ant-prefix&#125;-col-@&#123;index&#125;, .@&#123;ant-prefix&#125;-col-xs-@&#123;index&#125;, .@&#123;ant-prefix&#125;-col-sm-@&#123;index&#125;, .@&#123;ant-prefix&#125;-col-md-@&#123;index&#125;, .@&#123;ant-prefix&#125;-col-lg-@&#123;index&#125;"</span>;</span><br><span class="line">    <span class="selector-class">.col</span>((<span class="variable">@index</span> + <span class="number">1</span>), <span class="string">~"@&#123;list&#125;, @&#123;item&#125;"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.col</span>(<span class="variable">@index</span>, <span class="variable">@list</span>) <span class="keyword">when</span> (<span class="variable">@index</span> &gt; <span class="variable">@grid-columns</span>) &#123;</span><br><span class="line">    <span class="variable">@&#123;list&#125;</span> &#123;</span><br><span class="line">      <span class="attribute">position</span>: relative;</span><br><span class="line">      <span class="comment">// Prevent columns from collapsing when empty</span></span><br><span class="line">      <span class="attribute">min-height</span>: <span class="number">1px</span>;</span><br><span class="line">      <span class="attribute">padding-left</span>: (<span class="variable">@grid-gutter-width</span> / <span class="number">2</span>);</span><br><span class="line">      <span class="attribute">padding-right</span>: (<span class="variable">@grid-gutter-width</span> / <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.col</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.float-grid-columns</span>(<span class="variable">@class</span>) &#123;</span><br><span class="line">  <span class="selector-class">.col</span>(<span class="variable">@index</span>) &#123; <span class="comment">// initial</span></span><br><span class="line">    <span class="variable">@item:</span> <span class="string">~".@&#123;ant-prefix&#125;-col@&#123;class&#125;-@&#123;index&#125;"</span>;</span><br><span class="line">    <span class="selector-class">.col</span>((<span class="variable">@index</span> + <span class="number">1</span>), <span class="variable">@item</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.col</span>(<span class="variable">@index</span>, <span class="variable">@list</span>) <span class="keyword">when</span> (<span class="variable">@index</span> =&lt; <span class="variable">@grid-columns</span>) &#123; <span class="comment">// general</span></span><br><span class="line">    <span class="variable">@item:</span> <span class="string">~".@&#123;ant-prefix&#125;-col@&#123;class&#125;-@&#123;index&#125;"</span>;</span><br><span class="line">    <span class="selector-class">.col</span>((<span class="variable">@index</span> + <span class="number">1</span>), <span class="string">~"@&#123;list&#125;, @&#123;item&#125;"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.col</span>(<span class="variable">@index</span>, <span class="variable">@list</span>) <span class="keyword">when</span> (<span class="variable">@index</span> &gt; <span class="variable">@grid-columns</span>) &#123; <span class="comment">// terminal</span></span><br><span class="line">    <span class="variable">@&#123;list&#125;</span> &#123;</span><br><span class="line">      <span class="attribute">float</span>: left;</span><br><span class="line">      <span class="attribute">flex</span>: <span class="number">0</span> <span class="number">0</span> auto;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.col</span>(<span class="number">1</span>); <span class="comment">// kickstart it</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// index 由 24 到 1，构建样式规则</span></span><br><span class="line"><span class="selector-class">.loop-grid-columns</span>(<span class="variable">@index</span>, <span class="variable">@class</span>) <span class="keyword">when</span> (<span class="variable">@index</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="selector-class">.@&#123;ant-prefix&#125;</span><span class="selector-tag">-col</span><span class="variable">@&#123;class&#125;</span><span class="selector-tag">-</span><span class="variable">@&#123;index&#125;</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">    <span class="attribute">box-sizing</span>: border-box;</span><br><span class="line">    <span class="attribute">width</span>: percentage((<span class="variable">@index</span> / <span class="variable">@grid-columns</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.@&#123;ant-prefix&#125;</span><span class="selector-tag">-col</span><span class="variable">@&#123;class&#125;</span><span class="selector-tag">-push-</span><span class="variable">@&#123;index&#125;</span> &#123;</span><br><span class="line">    <span class="attribute">left</span>: percentage((<span class="variable">@index</span> / <span class="variable">@grid-columns</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.@&#123;ant-prefix&#125;</span><span class="selector-tag">-col</span><span class="variable">@&#123;class&#125;</span><span class="selector-tag">-pull-</span><span class="variable">@&#123;index&#125;</span> &#123;</span><br><span class="line">    <span class="attribute">right</span>: percentage((<span class="variable">@index</span> / <span class="variable">@grid-columns</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.@&#123;ant-prefix&#125;</span><span class="selector-tag">-col</span><span class="variable">@&#123;class&#125;</span><span class="selector-tag">-offset-</span><span class="variable">@&#123;index&#125;</span> &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: percentage((<span class="variable">@index</span> / <span class="variable">@grid-columns</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.@&#123;ant-prefix&#125;</span><span class="selector-tag">-col</span><span class="variable">@&#123;class&#125;</span><span class="selector-tag">-order-</span><span class="variable">@&#123;index&#125;</span> &#123;</span><br><span class="line">    <span class="attribute">order</span>: <span class="variable">@index</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.loop-grid-columns</span>((<span class="variable">@index</span> - <span class="number">1</span>), <span class="variable">@class</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.loop-grid-columns</span>(<span class="variable">@index</span>, <span class="variable">@class</span>) <span class="keyword">when</span> (<span class="variable">@index</span> = <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="selector-class">.@&#123;ant-prefix&#125;</span><span class="selector-tag">-col</span><span class="variable">@&#123;class&#125;</span><span class="selector-tag">-</span><span class="variable">@&#123;index&#125;</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: none;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.@&#123;ant-prefix&#125;</span><span class="selector-tag">-col-push-</span><span class="variable">@&#123;index&#125;</span> &#123;</span><br><span class="line">    <span class="attribute">left</span>: auto;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.@&#123;ant-prefix&#125;</span><span class="selector-tag">-col-pull-</span><span class="variable">@&#123;index&#125;</span> &#123;</span><br><span class="line">    <span class="attribute">right</span>: auto;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.@&#123;ant-prefix&#125;</span><span class="selector-tag">-col</span><span class="variable">@&#123;class&#125;</span><span class="selector-tag">-push-</span><span class="variable">@&#123;index&#125;</span> &#123;</span><br><span class="line">    <span class="attribute">left</span>: auto;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.@&#123;ant-prefix&#125;</span><span class="selector-tag">-col</span><span class="variable">@&#123;class&#125;</span><span class="selector-tag">-pull-</span><span class="variable">@&#123;index&#125;</span> &#123;</span><br><span class="line">    <span class="attribute">right</span>: auto;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.@&#123;ant-prefix&#125;</span><span class="selector-tag">-col</span><span class="variable">@&#123;class&#125;</span><span class="selector-tag">-offset-</span><span class="variable">@&#123;index&#125;</span> &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.@&#123;ant-prefix&#125;</span><span class="selector-tag">-col</span><span class="variable">@&#123;class&#125;</span><span class="selector-tag">-order-</span><span class="variable">@&#123;index&#125;</span> &#123;</span><br><span class="line">    <span class="attribute">order</span>: <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.make-grid</span>(<span class="variable">@class</span>: <span class="string">~''</span>) &#123;</span><br><span class="line">  <span class="selector-class">.float-grid-columns</span>(<span class="variable">@class</span>);</span><br><span class="line">  <span class="selector-class">.loop-grid-columns</span>(<span class="variable">@grid-columns</span>, <span class="variable">@class</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// index.less</span></span><br><span class="line"><span class="selector-class">.make-grid-columns</span>();</span><br><span class="line"><span class="selector-class">.make-grid</span>();</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.make-grid</span>(-xs);</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span> (<span class="attribute">min-width</span>: <span class="variable">@screen-sm-min</span>) &#123;</span><br><span class="line">  <span class="selector-class">.make-grid</span>(-sm);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span> (<span class="attribute">min-width</span>: <span class="variable">@screen-md-min</span>) &#123;</span><br><span class="line">  <span class="selector-class">.make-grid</span>(-md);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span> (<span class="attribute">min-width</span>: <span class="variable">@screen-lg-min</span>) &#123;</span><br><span class="line">  <span class="selector-class">.make-grid</span>(-lg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span> (<span class="attribute">min-width</span>: <span class="variable">@screen-xl-min</span>) &#123;</span><br><span class="line">  <span class="selector-class">.make-grid</span>(-xl);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span> (<span class="attribute">min-width</span>: <span class="variable">@screen-xxl-min</span>) &#123;</span><br><span class="line">  <span class="selector-class">.make-grid</span>(-xxl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/17/css/less 使用指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/17/css/less 使用指南/" itemprop="url">less 使用指南</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-17T00:00:00+08:00">2018-11-17</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/css/" itemprop="url" rel="index"><span itemprop="name">css</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/17/css/less 使用指南/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/11/17/css/less 使用指南/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这篇文章本不打算发布在知乎平台。但是在汇总笔者所不常用的 less 语法时，笔者又小小费了点脑筋，推想了一下 less 的实现（这样有助于从更高的维度去看待很多功能实现）。因此，笔者就希望能在一个更开阔的平台上得到一些回馈和纠错性意见。之所以要汇总 less 语法，那是因为要推究网页、组件库改变样式主题的实现。</p>
<h2 id="导入"><a href="#导入" class="headerlink" title="导入"></a>导入</h2><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@import</span> <span class="string">"library"</span>; <span class="comment">// library.less</span></span><br><span class="line"><span class="keyword">@import</span> <span class="string">"typo.css"</span>;</span><br></pre></td></tr></table></figure>
<h3 id="导入关键字"><a href="#导入关键字" class="headerlink" title="导入关键字"></a>导入关键字</h3><p>导入关键字使用形式如 @import (optional, reference) “foo.less”。</p>
<p>所包含的关键字有：</p>
<ol>
<li>reference: 导入的样式文件将作为参考，其所包含的选择器将不会呈现在输出文件，却可以使用 mixin 混入或 extend 扩展将原选择器的样式添加到新的选择器中。reference 的应用场景如，@import (reference) bootstrap.less 样式，使用混入或扩展关键字只将 .navbar all 相关选择器的样式输出。推想其实现如，以内存形式缓存编译后的样式文件，被引用时才注入到输出文件中。</li>
<li>inline: 全量复制 css 文件，不作处理（less 在某些地方不支持注释；且在不修改 css 的情形下，less 也不支持全部的 css hacks）。</li>
<li>less: 以 less 文件形式处理导入的样式文件，不管文件扩展名。</li>
<li>css: 以 css 文件形式处理导入的样式文件，不管文件扩展名。</li>
<li>once: 样式文件只导入一次，默认。</li>
<li>multiple：样式文件导入多次。</li>
<li>optional: 样式文件不存在时不会报错。</li>
</ol>
<h2 id="嵌套规则"><a href="#嵌套规则" class="headerlink" title="嵌套规则"></a>嵌套规则</h2><p>使用嵌套形式书写样式文件时，&amp; 表示父选择器。</p>
<p>less 将使用父选择器名替换 &amp;。特殊的，使用 &amp; 能改变选择器的顺序；当有多个父选择器时，&amp; 依次解析为这几个父选择器。</p>
<p>推想其实现如，以块 {} 为编译单元，以 selectors 缓存 {} 前选择器，以 content 缓存 {} 内容并作解析，将样式写入 output；然后递归调用前述过程，传入父 selectors, content，解析子块时再将父 selector 添加到子 selector 前，将样式写入 output。嵌套规则以树形结构组织，但样式写入 output 时为扁平化结构。单个 &amp; 可以使用父 selector；多个 &amp;，可先构建两维数组，每个数组项为父 selector 的有序列表，然后遍历两维数组进行替换。若 &amp; 在选择器的尾部，编译时无需在子选择器前添加父选择器，而只将 &amp; 替换为父选择器。</p>
<ol>
<li><p>多个父选择器</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="selector-tag">p</span>, <span class="selector-tag">a</span> &#123;</span><br><span class="line">  <span class="selector-tag">&amp;</span> + <span class="selector-tag">&amp;</span> &#123;</span><br><span class="line">    <span class="attribute">border-top</span>: <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="selector-tag">p</span> + <span class="selector-tag">p</span>,</span><br><span class="line"><span class="selector-tag">p</span> + <span class="selector-tag">a</span>,</span><br><span class="line"><span class="selector-tag">a</span> + <span class="selector-tag">p</span>,</span><br><span class="line"><span class="selector-tag">a</span> + <span class="selector-tag">a</span> &#123;</span><br><span class="line">  <span class="attribute">border-top</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>改变选择器的顺序</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="selector-class">.header</span> &#123;</span><br><span class="line">  <span class="selector-class">.menu</span> &#123;</span><br><span class="line">    <span class="selector-class">.no-borderradius</span> <span class="selector-tag">&amp;</span> &#123;</span><br><span class="line">      <span class="attribute">background-image</span>: url(<span class="string">'images/button-background.png'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="selector-class">.no-borderradius</span> <span class="selector-class">.header</span> <span class="selector-class">.menu</span> &#123;</span><br><span class="line">  <span class="attribute">background-image</span>: url(<span class="string">'images/button-background.png'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><p>less 中变量使用 @variableName: variableValue 形式声明；@variableName 或 @{variableName} 形式使用。变量可用于选择器的名称，样式属性的名称，样式属性的值，url，import 语句等。</p>
<p>less 允许使用变量去定义另一个变量的名称，即 @@variablename2 形式声明变量 variablename1。</p>
<p>less 允许先使用变量，再声明变量。推想其实现如，同 js 一样会将声明提前，并保留在内存中，以精确的值替换掉使用的变量，文件解析完成后，再释放内存。</p>
<p>变量有作用域，就近定义的优先。推想其编译过程，块将解析为函数，当在块中再度遇到相同的变量名，注入函数的实参就会被改变，最终输出也因而改变。其实现可能譬如模板引擎。</p>
<p>变量的一大用途包含，通过变量设置网页样式的主题。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@var:</span> red;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#page</span> &#123;</span><br><span class="line">  <span class="variable">@var:</span> white;</span><br><span class="line">  <span class="selector-id">#header</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="variable">@var</span>; <span class="comment">// white</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="变量与混合"><a href="#变量与混合" class="headerlink" title="变量与混合"></a>变量与混合</h3><p>变量可以存储分离的规则集，其下可包含属性、嵌套规则集、变量声明、混合等。分离的规则集在块 {} 中以函数形式使用，该块内就可以使用分离的规则集内所声明的变量、样式属性和混合。</p>
<p>推想其实现如，将分离规则集解析为函数，在快内使用时再行植入。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="variable">@detached-ruleset:</span> &#123;</span><br><span class="line">  <span class="selector-class">.mixin</span>() &#123;</span><br><span class="line">    <span class="attribute">font-family</span>: <span class="string">"Comic Sans MS"</span>;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="number">#AA86EE</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.cont</span> &#123;</span><br><span class="line">  <span class="variable">@detached-ruleset</span>();</span><br><span class="line">  <span class="selector-class">.mixin</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="selector-class">.cont</span> &#123;</span><br><span class="line">  <span class="attribute">font-family</span>: <span class="string">"Comic Sans MS"</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#AA86EE</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="操作符"><a href="#操作符" class="headerlink" title="操作符"></a>操作符</h2><p>算数运算符 +, -, *, / 可作用于变量、颜色、数值，less 将尝试获得单位。推想其实现，首先将变量替换为实际的值，然后匹配到操作符，解析操作符前后数值的单位并获得最终单位，使用最终单位修正数值，数值计算并输出。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@conversion-1:</span> <span class="number">5cm</span> + <span class="number">10mm</span>; <span class="comment">// 输出 6cm</span></span><br><span class="line"><span class="variable">@conversion-2:</span> <span class="number">2</span> - <span class="number">3cm</span> - <span class="number">5mm</span>; <span class="comment">// 输出 1.5cm</span></span><br><span class="line"><span class="variable">@incompatible-units:</span> <span class="number">2</span> + <span class="number">5px</span> - <span class="number">3cm</span>; <span class="comment">// 输出 4px</span></span><br><span class="line"><span class="variable">@base:</span> <span class="number">5%</span>;</span><br><span class="line"><span class="variable">@filler:</span> <span class="variable">@base</span> * <span class="number">2</span>; <span class="comment">// 输出 10%</span></span><br><span class="line"><span class="variable">@other:</span> <span class="variable">@base</span> + <span class="variable">@filler</span>; <span class="comment">// 输出 15%</span></span><br></pre></td></tr></table></figure>
<h2 id="转义"><a href="#转义" class="headerlink" title="转义"></a>转义</h2><p>任何 ~”anything” 或 ~’anything’ 语句内，单双引号内容都将被保留，可用于规避 ‘//‘, ‘/<em> </em>/‘被误认为注释。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.weird-element</span> &#123;</span><br><span class="line">  <span class="attribute">content</span>: <span class="string">~"^//* some horrible but needed css hack"</span>;<span class="comment">// 输出 content: ^//* some horrible but needed css hack;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="混合"><a href="#混合" class="headerlink" title="混合"></a>混合</h2><p>混合能将某个类或 id 选择器中的样式添加到另一个选择器中，其书写形式如 css 中为类或 id 选择器添加样式，其下可包含选择器（当子选择器为类或 id 选择器时，该子选择器构成另一个混合，可以直接使用；这样，父选择器也称为命名空间）。</p>
<p>当 guard 应用于命名空间时，当且仅当 guard 条件返回真值，才能使用由命名空间定义的混合。参见 guard。</p>
<p>使用混合时添加 !important 关键字，混合下所有样式都将添加 !important。</p>
<p>特别，当类或 id 选择器以 () 结尾时，选择器将不会在输出文件中有所表现，而只是在使用时会将样式混入到其他选择器中。() 中可以添加参数（以 ‘,’ 或 ‘;’ 分割参数），使函数具有函数特征，且支持多态。混合函数使用时可以借助参数名指定参数的值，这样就无关参数的位置；且使用时，@arguments 将包含所有参数；参数支持解构语法如 … 或 @rest…。混合函数的参数可以是复杂的样式规则。</p>
<p>在混合函数中声明的变量，可以在使用混合的块中访问。但是块中若有同名变量，以块中声明的变量优先。</p>
<p>推想其实现如，编译结束后类或 id 选择器构成的混合将保留在内存中，对于 () 结尾的选择器将以函数形式保存，使用时调用函数，这样就不会有样式输出。且保留在内存中的函数是在解析到 () 时构建的，这样就使得 less 语法上呈现多态，编译出来的函数可以使用控制语句处理函数体内参数的多态特征。</p>
<ol>
<li><p>命名空间，不输出混合。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="selector-id">#bundle</span>() &#123;</span><br><span class="line">  <span class="selector-class">.button</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid black;</span><br><span class="line">    <span class="attribute">background-color</span>: grey;</span><br><span class="line">    <span class="selector-tag">&amp;</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">      <span class="attribute">background-color</span>: white</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.tab</span> &#123; ... &#125;</span><br><span class="line">  <span class="selector-class">.citation</span> &#123; ... &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#header</span> <span class="selector-tag">a</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: orange;</span><br><span class="line">  <span class="selector-id">#bundle</span> &gt; <span class="selector-class">.button</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="selector-id">#header</span> <span class="selector-tag">a</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: orange;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">1px</span> solid black;</span><br><span class="line">  <span class="attribute">background-color</span>: grey;</span><br><span class="line">  <span class="selector-tag">&amp;</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background-color</span>: white</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 !important</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="selector-class">.foo</span> (<span class="variable">@bg</span>: <span class="number">#f5f5f5</span>, <span class="variable">@color</span>: <span class="number">#900</span>) &#123;</span><br><span class="line">  <span class="attribute">background</span>: <span class="variable">@bg</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="variable">@color</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.important</span> &#123;</span><br><span class="line">  <span class="selector-class">.foo</span>() !important;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="selector-class">.important</span> &#123;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#f5f5f5</span> <span class="meta">!important</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#900</span> <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>混合函数支持多态</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="selector-class">.mixin</span>(dark; <span class="variable">@color</span>) &#123;</span><br><span class="line">  <span class="attribute">color</span>: darken(<span class="variable">@color</span>, <span class="number">10%</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.mixin</span>(light; <span class="variable">@color</span>) &#123;</span><br><span class="line">  <span class="attribute">color</span>: lighten(<span class="variable">@color</span>, <span class="number">10%</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.mixin</span>(<span class="variable">@_</span>; <span class="variable">@color</span>) &#123;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">@switch:</span> light;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.class</span> &#123;</span><br><span class="line">  <span class="selector-class">.mixin</span>(<span class="variable">@switch</span>; <span class="number">#888</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="selector-class">.class</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#a2a2a2</span>;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>混合函数中定义的变量，可以在使用时引用</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="selector-class">.mixin</span>() &#123;</span><br><span class="line">  <span class="variable">@width:</span>  <span class="number">100%</span>;</span><br><span class="line">  <span class="variable">@height:</span> <span class="number">200px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.caller</span> &#123;</span><br><span class="line">  <span class="selector-class">.mixin</span>();</span><br><span class="line">  <span class="attribute">width</span>:  <span class="variable">@width</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="variable">@height</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="selector-class">.caller</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>:  <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">200px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h2><p>扩展 :extend 是 less 提供的伪类，使用形式如 .big-bag:extend(.bag) 将使 .big-bag 拥有 .bag 的样式。</p>
<p>使用 all 关键字如 .replacement:extend(.test all)，将把 .test 替换为 .replacement，再行输出另一份样式规则。</p>
<p>推想其实现如，selector1:extend(selector2) 伪类前后内容解析为映射形式，在将 selector2 的样式规则赋值给 selector1。</p>
<ol>
<li>all 关键字<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="selector-class">.a</span><span class="selector-class">.b</span><span class="selector-class">.test</span>,</span><br><span class="line"><span class="selector-class">.test</span><span class="selector-class">.c</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: orange;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.test</span> &#123;</span><br><span class="line">  <span class="selector-tag">&amp;</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: green;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.replacement</span><span class="selector-pseudo">:extend(.test</span> <span class="keyword">all</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="selector-class">.a</span><span class="selector-class">.b</span><span class="selector-class">.test</span>,</span><br><span class="line"><span class="selector-class">.test</span><span class="selector-class">.c</span>,</span><br><span class="line"><span class="selector-class">.a</span><span class="selector-class">.b</span><span class="selector-class">.replacement</span>,</span><br><span class="line"><span class="selector-class">.replacement</span><span class="selector-class">.c</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: orange;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.test</span><span class="selector-pseudo">:hover</span>,</span><br><span class="line"><span class="selector-class">.replacement</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: green;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="扩展和指令"><a href="#扩展和指令" class="headerlink" title="扩展和指令"></a>扩展和指令</h3><p>若 extend 伪类在 @media 指令中定义，那么 less 将在 @media 指令内查找匹配的选择器。若 extend 伪类在顶层定义，less 将能匹配到所有 @media 指令中的选择器。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="keyword">@media</span> print &#123;</span><br><span class="line">  <span class="selector-class">.screenClass</span><span class="selector-pseudo">:extend(.selector)</span> &#123;&#125; <span class="comment">// extend inside media</span></span><br><span class="line">  <span class="selector-class">.selector</span> &#123; <span class="comment">// this will be matched - it is in the same media</span></span><br><span class="line">    <span class="attribute">color</span>: black;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="keyword">@media</span> print &#123;</span><br><span class="line">  <span class="selector-class">.selector</span>,</span><br><span class="line">  <span class="selector-class">.screenClass</span> &#123; <span class="comment">/*  ruleset inside the same media was extended */</span></span><br><span class="line">    <span class="attribute">color</span>: black;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="嵌套指令"><a href="#嵌套指令" class="headerlink" title="嵌套指令"></a>嵌套指令</h2><p>嵌套指令会冒泡到顶层。对于条件指令如 @Media, @supports, @document 等，条件指令上的父选择器会被植入条件指令内；对于非条件指令如 @font-face, @keyframes 等，条件指令上的父选择器会被忽略。</p>
<ol>
<li><p>条件指令</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="selector-class">.screen-color</span> &#123;</span><br><span class="line">  <span class="keyword">@media</span> screen &#123;</span><br><span class="line">    <span class="attribute">color</span>: green;</span><br><span class="line">    <span class="keyword">@media</span> (<span class="attribute">min-width</span>: <span class="number">768px</span>) &#123;</span><br><span class="line">      <span class="attribute">color</span>: red;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="keyword">@media</span> screen &#123;</span><br><span class="line">  <span class="selector-class">.screen-color</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: green;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@media</span> screen and (<span class="attribute">min-width</span>: <span class="number">768px</span>) &#123;</span><br><span class="line">  <span class="selector-class">.screen-color</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: red;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>非条件指令</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="selector-id">#a</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: blue;</span><br><span class="line">  <span class="keyword">@font-face</span> &#123;</span><br><span class="line">    <span class="attribute">src</span>: made-up-url;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="selector-id">#a</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: blue;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@font-face</span> &#123;</span><br><span class="line">  <span class="attribute">src</span>: made-up-url;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="guard"><a href="#guard" class="headerlink" title="guard"></a>guard</h2><p>guard 用于指定条件，在满足该条件时，才会有样式输出。使用形式如 when (@var = value)，即当 @var 变量或参数等于 value 时，才满足条件。when 条件内可包含比较运算符如 =, &lt;, &gt;, &lt;=, &gt;=，以及逻辑运算符 and, and not，内置的类型检查函数如 iscolor, isnumber, isstring, iskeyword, isurl, ispixel, ispercentage, isem, isunit。</p>
<p>当使用 guard 递归构建 mixin 时，可以形成循环。</p>
<ol>
<li><p>逻辑运算符</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="selector-class">.mixin</span> (<span class="variable">@a</span>) <span class="keyword">when</span> (<span class="variable">@a</span> &gt; <span class="number">50%</span>) <span class="keyword">and</span> (<span class="variable">@a</span> &gt; <span class="number">5px</span>)&#123;</span><br><span class="line"><span class="attribute">font-size</span>: <span class="number">14px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.mixin</span> (<span class="variable">@a</span>) <span class="keyword">when</span> <span class="keyword">not</span> (<span class="variable">@a</span> &lt; <span class="number">50%</span>) <span class="keyword">and</span> <span class="keyword">not</span> (<span class="variable">@a</span> &lt; <span class="number">5px</span>)&#123;</span><br><span class="line"><span class="attribute">font-size</span>: <span class="number">20px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.mixin</span> (<span class="variable">@a</span>) &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="variable">@a</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.class1</span> &#123; <span class="selector-class">.mixin</span>(<span class="number">#FF0000</span>) &#125;</span><br><span class="line"><span class="selector-class">.class2</span> &#123; <span class="selector-class">.mixin</span>(<span class="number">#555</span>) &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="selector-class">.class1</span> &#123;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">20px</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#FF0000</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.class2</span> &#123;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">20px</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#555</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>循环</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="selector-class">.cont</span>(<span class="variable">@count</span>) <span class="keyword">when</span> (<span class="variable">@count</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="selector-class">.cont</span>((<span class="variable">@count</span> - <span class="number">1</span>));</span><br><span class="line">  <span class="attribute">width</span>: (<span class="number">25px</span> * <span class="variable">@count</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">div</span> &#123;</span><br><span class="line">  <span class="selector-class">.cont</span>(<span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="selector-tag">div</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">25px</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">50px</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">75px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="合并"><a href="#合并" class="headerlink" title="合并"></a>合并</h2><ol>
<li><p>使用 ‘,’ 串联多个样式属性</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="selector-class">.myfunc</span>() &#123;</span><br><span class="line">  <span class="selector-tag">box-shadow</span>+: <span class="selector-tag">5px</span> <span class="selector-tag">5px</span> <span class="selector-tag">5px</span> <span class="selector-tag">grey</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.class</span> &#123;</span><br><span class="line">  <span class="selector-class">.myfunc</span>();</span><br><span class="line">  <span class="selector-tag">box-shadow</span>+: <span class="selector-tag">0</span> <span class="selector-tag">0</span> <span class="selector-tag">5px</span> <span class="selector-id">#f78181</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="selector-class">.class</span> &#123;</span><br><span class="line">  <span class="attribute">box-shadow</span>: <span class="number">5px</span> <span class="number">5px</span> <span class="number">5px</span> grey, <span class="number">0</span> <span class="number">0</span> <span class="number">5px</span> <span class="number">#f78181</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用空格串联多个样式属性</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="selector-class">.mixin</span>() &#123;</span><br><span class="line">  <span class="selector-tag">transform</span>+<span class="selector-tag">_</span>: <span class="selector-tag">scale</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.class</span> &#123;</span><br><span class="line">  <span class="selector-class">.mixin</span>();</span><br><span class="line">  <span class="selector-tag">transform</span>+<span class="selector-tag">_</span>: <span class="selector-tag">rotate</span>(<span class="number">2deg</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="selector-class">.class</span> &#123;</span><br><span class="line">  <span class="attribute">transform</span>: scale(<span class="number">1</span>) rotate(<span class="number">2deg</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><p>推想其实现如，由 less 提供上下文环境，并通过该上下文环境输出内置函数。颜色函数的实现是笔者鞭长莫及的。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@base:</span> <span class="number">#f04615</span>;</span><br><span class="line"><span class="variable">@width:</span> <span class="number">0.5</span>;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.class</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: percentage(<span class="variable">@width</span>);</span><br><span class="line">  <span class="attribute">color</span>: saturate(<span class="variable">@base</span>, <span class="number">5%</span>);</span><br><span class="line">  <span class="attribute">background-color</span>: spin(lighten(<span class="variable">@base</span>, <span class="number">25%</span>), <span class="number">8</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="其他函数"><a href="#其他函数" class="headerlink" title="其他函数"></a>其他函数</h3><ol>
<li>color: 颜色转换函数。</li>
<li>image-size: 从文件中获取图像的宽度及高度，可作为 image-size 样式的值。</li>
<li>image-width : 从文件中获取图像的宽度。</li>
<li>image-height: 从文件中获取图像的高度。</li>
<li>convert: 单位转换，如 convert(10cm, mm)。</li>
<li>data-uri: 用于嵌入资源，data-uri(url, mimeType)。</li>
<li>unit: 可用于指定单位，unit(dimension, unit)。</li>
<li>get-unit: 可用于获取单位，如 get-unit(30px)。</li>
<li>svg-gradient: 可用于转换颜色，</li>
<li>if: 按条件返回指定的值，if(condition, value1, value2)，当 condition 成立时，返回 value1，否则返回 value2。</li>
</ol>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.style</span> &#123;</span><br><span class="line">  <span class="variable">@style:</span> orange, green <span class="number">30%</span>, <span class="number">#DAA520</span>;</span><br><span class="line">  <span class="attribute">background-image</span>: svg-gradient(ellipse, <span class="variable">@style</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="字符串函数"><a href="#字符串函数" class="headerlink" title="字符串函数"></a>字符串函数</h3><ol>
<li>escape: 对特殊字符使用URL编码来对字符串或信息进行编码。</li>
<li>e: 去除字符串的引号。</li>
<li>%: format 函数，用于转化字符串，如 %(string，arguments …)。</li>
<li>replace: 用于替换字符串，如 replace(string, pattern, replacement, flags)。</li>
</ol>
<h3 id="列表函数"><a href="#列表函数" class="headerlink" title="列表函数"></a>列表函数</h3><ol>
<li>length: 用于获取列表的长度，如 @list: “audi”, “benz”, “toyota”, “honda”; length(@list)。</li>
<li>extract: 用于获取列表中指定位置的值，如 @list: “audi”, “benz”, “toyota”, “honda”; length(@list, 2)。</li>
</ol>
<h3 id="数学函数"><a href="#数学函数" class="headerlink" title="数学函数"></a>数学函数</h3><ol>
<li>ceil: 向上取整。</li>
<li>floor: 向下取整。</li>
<li>percentage: 将浮点数转换为百分比字符串。</li>
<li>round: 四舍五入。</li>
<li>sqrt: 获取平方根。</li>
<li>abs: 取绝对值，如 abs(30ft) 将获得 30ft。</li>
<li>sin, asin, cos, acos, tan, atan: 计算正弦、反正弦等。</li>
<li>pi: 返回 pi 的值。</li>
<li>pow: 计算幂。</li>
<li>mod: 计算首参相对次参的模。</li>
<li>min: 计算最小值，如 min(70,30,45,20)。</li>
<li>max: 计算最大值。</li>
</ol>
<h3 id="类型函数"><a href="#类型函数" class="headerlink" title="类型函数"></a>类型函数</h3><p>类型函数包含 iscolor, isnumber, isstring, iskeyword, isurl, ispixel, ispercentage, isem, isunit, isruleset，返回布尔值。</p>
<h3 id="颜色定义函数"><a href="#颜色定义函数" class="headerlink" title="颜色定义函数"></a>颜色定义函数</h3><p>颜色定义函数包含 rgb(red, green, blue), rgba(red, green, blue, alpha), argb, hsl, hsla, hsv, hsva，具体可以参看 <a href="https://www.w3cschool.cn/less/less_color_defination_functions.html" target="_blank" rel="noopener">Less 颜色定义函数</a>。</p>
<h3 id="颜色通道函数"><a href="#颜色通道函数" class="headerlink" title="颜色通道函数"></a>颜色通道函数</h3><ol>
<li>hue: 在 HSL 颜色空间中，提取颜色对象的色调通道。</li>
<li>saturation: 在 HSL 颜色空间中，提取彩色对象的饱和通道。</li>
<li>lightness: 在 HSL 颜色空间中，从颜色对象提取亮度通道。</li>
<li>hsvhue: 在 HSV 色彩空间中，提取色彩对象的色调通道。</li>
<li>hsvsaturation: 在 HSL 颜色空间中，提取彩色对象的饱和通道。</li>
<li>hsvvalue: 在 HSL 颜色空间中，提取颜色对象的值通道。</li>
<li>red: 提取彩色对象的红色通道。</li>
<li>green: 提取彩色对象的绿色通道。</li>
<li>blue: 提取彩色对象的蓝色通道。</li>
<li>alpha: 提取颜色对象的 alpha 通道。</li>
<li>luma: 计算颜色对象的亮度值。</li>
<li>luminance: 在没有伽马校正的情况下计算亮度值。</li>
</ol>
<h3 id="颜色操作函数"><a href="#颜色操作函数" class="headerlink" title="颜色操作函数"></a>颜色操作函数</h3><ol>
<li>saturate: 改变颜色的强度或饱和度，如 saturate(color, amount)。</li>
<li>desaturate: 降低颜色的强度或饱和度。</li>
<li>lighten: 增加颜色的亮度，如 lighten(color, amount)。</li>
<li>darken: 降低颜色的亮度。</li>
<li>fadein: 增加颜色的不透明度，如 fadein(color, amount)。</li>
<li>fadeout: 降低颜色的不透明度。</li>
<li>fade: 设置颜色的不透明度，如 fade(color, amount)。</li>
<li>spin: 旋转颜色的角度，如 spin(color, angle)。</li>
<li>mix: 混合两种颜色以及不透明度，如 mix(color1, color2, weight)，参数 weight 为权重。</li>
<li>tint: 混合颜色和白色，如 tint(color, weight)。</li>
<li>shade: 混合颜色和黑色。</li>
<li>greyscale: 丢弃颜色的饱和度，如 greyscale(color)。</li>
<li>contrast: 设置颜色的对比度，如 contrast(color, dark, light, amount)。</li>
</ol>
<h3 id="颜色混合函数"><a href="#颜色混合函数" class="headerlink" title="颜色混合函数"></a>颜色混合函数</h3><ol>
<li>multiply: 两种RGB通道颜色相乘，然后除以 255 以得到较暗的颜色作为结果。</li>
<li>screen: 获取两种颜色中更明亮的颜色。</li>
<li>overlay: 结合 multiply, screen 的效果生成结果，使光通道更轻，暗通道更暗。</li>
<li>softlight: 工作方式类似于 overlay 函数，但它仅使用颜色的一部分，其中柔和地突出显示其他颜色。</li>
<li>hardlight: 与 overlay 函数类似，但颜色的作用相反。 它使用第二个参数执行 overlay()函数，以确定是否应该执行乘法或屏幕操作。</li>
<li>difference: 从首参颜色中减去次参颜色，负值将反转。</li>
<li>exclusion: 类似于 difference 函数，但具有较低的对比度。</li>
<li>average: 计算两种颜色的均值。</li>
<li>negation: 与 difference 函数相反，从次参颜色减去首参颜色。</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://lesscss.cn/features/" target="_blank" rel="noopener">less 语言特性</a><br><a href="https://www.w3cschool.cn/less/" target="_blank" rel="noopener">less 教程</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/11/antd/Input/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/11/antd/Input/" itemprop="url">antd-Input 组件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-11T00:00:00+08:00">2018-11-11</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/antd-组件库/" itemprop="url" rel="index"><span itemprop="name">antd 组件库</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/11/antd/Input/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/11/11/antd/Input/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Input-组件"><a href="#Input-组件" class="headerlink" title="Input 组件"></a>Input 组件</h2><p>Input 组件只关乎布局，其余均为常规处理。props.addonBefore 为前置标签，props.addonAfter 为后置标签，props.prefix 前缀图标，props.suffix 后缀图标。参看官方图例：</p>
<img src="/2018/11/11/antd/Input/Input组件布局.png">
<p>Input 组件在 render 方法执行阶段将绘制出 input 原生组件。鉴于 react 的实现机制，对于 input 原生组件的处理，有受控组件和非手空组件的区别。受控组件即根据组件的 state 变化渲染 input 节点的值，非受控组件只允许组件渲染出 input 节点的默认值，而其实时值将根据用户的操作行为加以改变。ant design 中的 Input 组件对于受控组件和非受控组件的处理，即是当开发者同时传入 props.value 和 props.defaultValue，props.value 的优先级高于 props.defaultValue，且当 props.value 为 undefined 或 null，均会以空字符串渲染 input 节点的值。</p>
<p>在事件的绑定函数方面，常规的绑定函数均会透传到 input 原生组件上，而 props.onPressEnter, props.onKeyDown 两个绑定函数均会以 inputInstance.handleKeyDown 方法的形式挂载为 input 原生组件的 onKeyDown 绑定函数（inputInstance 为 Input 组件的实例）。</p>
<p>此外，inputInstance 实例内置 focus, blur, select 方法，其功用如 inputInstance.focus 可以在校验表单时使校验失败的输入框组件获得焦点。inputInstance.input 属性用于访问 input 原生节点。</p>
<p>在样式处理方面，笔者将作专文加以阐述。</p>
<h2 id="TextArea-组件"><a href="#TextArea-组件" class="headerlink" title="TextArea 组件"></a>TextArea 组件</h2><p>TextArea 组件用于绘制 textarea 原生节点。不同于使用前后标签、前后图标影响渲染输入框组件的布局，TextArea 组件只包含 textarea 节点，没有其他布局元素。</p>
<p>TextArea 组件的特殊处理逻辑是，textarea 节点的高度随用户输入内容而改变，受控于 props.autosize = { minRows?, maxRows? } 属性。其实现原理为：</p>
<ol>
<li>使用插入文档的隐藏文本框节点计算单行文本的高度，再由 minRows, maxRows 计算文本框的最大最小高度，并计算文本框的高度。计算获得的文本框即 textareaStyles 变量。</li>
<li>调用组件实例的 setState 方法，更新 state.textareaStyles，最终构成组件实例的 resizeTextarea 方法。对于受控组件，将在componentWillReceiveProps 生命周期中判断组件获得的 props.value 是否更新，再使用 window.requestAnimationFrame 方式调用 resizeTextarea 方法，以调整文本框的高度。对于非受控组件，在 onChange 事件发生时调用 resizeTextarea 方法。</li>
</ol>
<p>calculateNodeHeight 函数计算文本框高度源码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> HIDDEN_TEXTAREA_STYLE = <span class="string">`</span></span><br><span class="line"><span class="string">  min-height:0 !important;</span></span><br><span class="line"><span class="string">  max-height:none !important;</span></span><br><span class="line"><span class="string">  height:0 !important;</span></span><br><span class="line"><span class="string">  visibility:hidden !important;</span></span><br><span class="line"><span class="string">  overflow:hidden !important;</span></span><br><span class="line"><span class="string">  position:absolute !important;</span></span><br><span class="line"><span class="string">  z-index:-1000 !important;</span></span><br><span class="line"><span class="string">  top:0 !important;</span></span><br><span class="line"><span class="string">  right:0 !important</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> SIZING_STYLE = [</span><br><span class="line">  <span class="string">'letter-spacing'</span>,</span><br><span class="line">  <span class="string">'line-height'</span>,</span><br><span class="line">  <span class="string">'padding-top'</span>,</span><br><span class="line">  <span class="string">'padding-bottom'</span>,</span><br><span class="line">  <span class="string">'font-family'</span>,</span><br><span class="line">  <span class="string">'font-weight'</span>,</span><br><span class="line">  <span class="string">'font-size'</span>,</span><br><span class="line">  <span class="string">'text-rendering'</span>,</span><br><span class="line">  <span class="string">'text-transform'</span>,</span><br><span class="line">  <span class="string">'width'</span>,</span><br><span class="line">  <span class="string">'text-indent'</span>,</span><br><span class="line">  <span class="string">'padding-left'</span>,</span><br><span class="line">  <span class="string">'padding-right'</span>,</span><br><span class="line">  <span class="string">'border-width'</span>,</span><br><span class="line">  <span class="string">'box-sizing'</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> computedStyleCache: &#123;[key: string]: NodeType&#125; = &#123;&#125;;</span><br><span class="line"><span class="keyword">let</span> hiddenTextarea: HTMLTextAreaElement;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">calculateNodeStyling</span>(<span class="params">node: HTMLElement, useCache = false</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> nodeRef = (</span><br><span class="line">    node.getAttribute(<span class="string">'id'</span>) ||</span><br><span class="line">    node.getAttribute(<span class="string">'data-reactid'</span>) ||</span><br><span class="line">    node.getAttribute(<span class="string">'name'</span>)</span><br><span class="line">  ) <span class="keyword">as</span> string;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (useCache &amp;&amp; computedStyleCache[nodeRef]) &#123;</span><br><span class="line">    <span class="keyword">return</span> computedStyleCache[nodeRef];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> style = <span class="built_in">window</span>.getComputedStyle(node);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> boxSizing = (</span><br><span class="line">    style.getPropertyValue(<span class="string">'box-sizing'</span>) ||</span><br><span class="line">    style.getPropertyValue(<span class="string">'-moz-box-sizing'</span>) ||</span><br><span class="line">    style.getPropertyValue(<span class="string">'-webkit-box-sizing'</span>)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> paddingSize = (</span><br><span class="line">    <span class="built_in">parseFloat</span>(style.getPropertyValue(<span class="string">'padding-bottom'</span>)) +</span><br><span class="line">    <span class="built_in">parseFloat</span>(style.getPropertyValue(<span class="string">'padding-top'</span>))</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> borderSize = (</span><br><span class="line">    <span class="built_in">parseFloat</span>(style.getPropertyValue(<span class="string">'border-bottom-width'</span>)) +</span><br><span class="line">    <span class="built_in">parseFloat</span>(style.getPropertyValue(<span class="string">'border-top-width'</span>))</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> sizingStyle = SIZING_STYLE</span><br><span class="line">    .map(<span class="function"><span class="params">name</span> =&gt;</span> <span class="string">`<span class="subst">$&#123;name&#125;</span>:<span class="subst">$&#123;style.getPropertyValue(name)&#125;</span>`</span>)</span><br><span class="line">    .join(<span class="string">';'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> nodeInfo: NodeType = &#123;</span><br><span class="line">    sizingStyle,</span><br><span class="line">    paddingSize,</span><br><span class="line">    borderSize,</span><br><span class="line">    boxSizing,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (useCache &amp;&amp; nodeRef) &#123;</span><br><span class="line">    computedStyleCache[nodeRef] = nodeInfo;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> nodeInfo;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateNodeHeight</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  uiTextNode: HTMLTextAreaElement,</span></span></span><br><span class="line"><span class="function"><span class="params">  useCache = false,</span></span></span><br><span class="line"><span class="function"><span class="params">  minRows: number | null = null,</span></span></span><br><span class="line"><span class="function"><span class="params">  maxRows: number | null = null,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!hiddenTextarea) &#123;</span><br><span class="line">    hiddenTextarea = <span class="built_in">document</span>.createElement(<span class="string">'textarea'</span>);</span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(hiddenTextarea);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Fix wrap="off" issue</span></span><br><span class="line">  <span class="comment">// https://github.com/ant-design/ant-design/issues/6577</span></span><br><span class="line">  <span class="keyword">if</span> (uiTextNode.getAttribute(<span class="string">'wrap'</span>)) &#123;</span><br><span class="line">    hiddenTextarea.setAttribute(<span class="string">'wrap'</span>, uiTextNode.getAttribute(<span class="string">'wrap'</span>) <span class="keyword">as</span> string);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    hiddenTextarea.removeAttribute(<span class="string">'wrap'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将影响文本框节点高度的样式属性拷贝给隐藏节点</span></span><br><span class="line">  <span class="comment">// overflow 样式属性置为 hidden，以此将滚动条排除在外</span></span><br><span class="line">  <span class="keyword">let</span> &#123;</span><br><span class="line">    paddingSize, borderSize,</span><br><span class="line">    boxSizing, sizingStyle,</span><br><span class="line">  &#125; = calculateNodeStyling(uiTextNode, useCache);</span><br><span class="line">  hiddenTextarea.setAttribute(<span class="string">'style'</span>, <span class="string">`<span class="subst">$&#123;sizingStyle&#125;</span>;<span class="subst">$&#123;HIDDEN_TEXTAREA_STYLE&#125;</span>`</span>);</span><br><span class="line">  hiddenTextarea.value = uiTextNode.value || uiTextNode.placeholder || <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> minHeight = <span class="built_in">Number</span>.MIN_SAFE_INTEGER;</span><br><span class="line">  <span class="keyword">let</span> maxHeight = <span class="built_in">Number</span>.MAX_SAFE_INTEGER;</span><br><span class="line">  <span class="keyword">let</span> height = hiddenTextarea.scrollHeight;<span class="comment">// 以隐藏节点计算文本框高度</span></span><br><span class="line">  <span class="keyword">let</span> overflowY: any;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据盒模式调整高度</span></span><br><span class="line">  <span class="keyword">if</span> (boxSizing === <span class="string">'border-box'</span>) &#123;</span><br><span class="line">    height = height + borderSize;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (boxSizing === <span class="string">'content-box'</span>) &#123;</span><br><span class="line">    height = height - paddingSize;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (minRows !== <span class="literal">null</span> || maxRows !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 计算文本框单行高度</span></span><br><span class="line">    hiddenTextarea.value = <span class="string">' '</span>;</span><br><span class="line">    <span class="keyword">let</span> singleRowHeight = hiddenTextarea.scrollHeight - paddingSize;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (minRows !== <span class="literal">null</span>) &#123;</span><br><span class="line">      minHeight = singleRowHeight * minRows;</span><br><span class="line">      <span class="keyword">if</span> (boxSizing === <span class="string">'border-box'</span>) &#123;</span><br><span class="line">        minHeight = minHeight + paddingSize + borderSize;</span><br><span class="line">      &#125;</span><br><span class="line">      height = <span class="built_in">Math</span>.max(minHeight, height);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (maxRows !== <span class="literal">null</span>) &#123;</span><br><span class="line">      maxHeight = singleRowHeight * maxRows;</span><br><span class="line">      <span class="keyword">if</span> (boxSizing === <span class="string">'border-box'</span>) &#123;</span><br><span class="line">        maxHeight = maxHeight + paddingSize + borderSize;</span><br><span class="line">      &#125;</span><br><span class="line">      overflowY = height &gt; maxHeight ? <span class="string">''</span> : <span class="string">'hidden'</span>;</span><br><span class="line">      height = <span class="built_in">Math</span>.min(maxHeight, height);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!maxRows) &#123;</span><br><span class="line">    overflowY = <span class="string">'hidden'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; height, minHeight, maxHeight, overflowY &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>setState 更新文本框高度源码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不打断本次渲染，在下一次渲染调整文本框的样式</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onNextFrame</span>(<span class="params">cb: (</span>) =&gt; <span class="title">void</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">window</span>.requestAnimationFrame) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">window</span>.requestAnimationFrame(cb);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">window</span>.setTimeout(cb, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clearNextFrameAction</span>(<span class="params">nextFrameId: number</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">window</span>.cancelAnimationFrame) &#123;</span><br><span class="line">    <span class="built_in">window</span>.cancelAnimationFrame(nextFrameId);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">window</span>.clearTimeout(nextFrameId);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextArea</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span>&lt;<span class="title">TextAreaProps</span>, <span class="title">TextAreaState</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> defaultProps = &#123;</span><br><span class="line">    prefixCls: <span class="string">'ant-input'</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  nextFrameActionId: number;</span><br><span class="line"></span><br><span class="line">  state = &#123;</span><br><span class="line">    textareaStyles: &#123;&#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">this</span>.resizeTextarea();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentWillReceiveProps(nextProps: TextAreaProps) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.props.value !== nextProps.value) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.nextFrameActionId) &#123;</span><br><span class="line">        clearNextFrameAction(<span class="keyword">this</span>.nextFrameActionId);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.nextFrameActionId = onNextFrame(<span class="keyword">this</span>.resizeTextarea);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  resizeTextarea = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; autosize &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">if</span> (!autosize || !<span class="keyword">this</span>.textAreaRef) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> minRows = autosize ? (autosize <span class="keyword">as</span> AutoSizeType).minRows : <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">const</span> maxRows = autosize ? (autosize <span class="keyword">as</span> AutoSizeType).maxRows : <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">const</span> textareaStyles = calculateNodeHeight(<span class="keyword">this</span>.textAreaRef, <span class="literal">false</span>, minRows, maxRows);</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; textareaStyles &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleTextareaChange = <span class="function">(<span class="params">e: React.ChangeEvent&lt;HTMLTextAreaElement&gt;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(<span class="string">'value'</span> <span class="keyword">in</span> <span class="keyword">this</span>.props)) &#123;</span><br><span class="line">      <span class="keyword">this</span>.resizeTextarea();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> &#123; onChange &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">if</span> (onChange) &#123;</span><br><span class="line">      onChange(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 余略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Search"><a href="#Search" class="headerlink" title="Search"></a>Search</h2><p>Search 组件基于 Input 组件制作，其特殊处理是在 inputInstance.onPressEnter 方法执行过程中调用 props.onSearch 方法，适用于远程搜索之类的场景；Search 组件还提供 props.enterButton 属性用于配置输入框的后缀图标，默认使用 search 图标，可渲染文本或按钮。实现请参考 ant design 源码。</p>
<h2 id="Group"><a href="#Group" class="headerlink" title="Group"></a>Group</h2><p>Group 组件主要以样式控制多个表单项组件 props.children 的成组渲染。实现请参考 ant design 源码。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/11/设计模式/适配器模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/11/设计模式/适配器模式/" itemprop="url">适配器模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-11T00:00:00+08:00">2018-11-11</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/设计模式/" itemprop="url" rel="index"><span itemprop="name">设计模式</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/11/设计模式/适配器模式/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/11/11/设计模式/适配器模式/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/11/工程化/http-proxy-middleware源码解读/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/11/工程化/http-proxy-middleware源码解读/" itemprop="url">http-proxy-middleware 源码解读</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-11T00:00:00+08:00">2018-11-11</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端工程化/" itemprop="url" rel="index"><span itemprop="name">前端工程化</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/11/工程化/http-proxy-middleware源码解读/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/11/11/工程化/http-proxy-middleware源码解读/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>http-proxy-middleware 库借助于 <a href="http://xzfyu.com/2018/11/09/%E5%B7%A5%E7%A8%8B%E5%8C%96/node-http-proxy%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" target="_blank" rel="noopener">node-http-proxy</a>，用于将 node 服务器接收到的请求转发到目标服务器，实现代理服务器的功能。</p>
<h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><p>可以推想，使用 node-http-proxy 创建代理服务器 proxyServer 后，通过全局注册的转发规则获取到客户端请求 req 需要发送到的目标地址，再通过调用 proxyServer.web, proxyServer.ws 方法转发请求。</p>
<h3 id="转发规则"><a href="#转发规则" class="headerlink" title="转发规则"></a>转发规则</h3><p>从原理层面简单的归纳转发规则，就是客户端请求路径到目标服务器地址的映射关系。node-http-proxy 库将转发规则分为两部分加以配置，context 用于匹配需要转发的客户端请求，options.target 用于设定目标服务器的 host；option.router 根据客户端请求重新设定目标服务器的 host（这样，根据不同的请求，可以设定多个目标服务器）；option.pathRewrite 用于辅助将客户端请求路径转化为目标服务器地址。</p>
<h4 id="context"><a href="#context" class="headerlink" title="context"></a>context</h4><p>context 表示待转发请求的目录名。当客户端请求以 context 起始时，则该请求将被转发。如 context 设置为 ‘/api’，客户端所有以 ‘/api’ 起始的请求都会被转发；默认值为 ‘/‘，意为客户端发送的所有请求都会被转发。node-http-proxy 库使用 createConfig 解析获得 context；matchContext 函数校验客户端请求是否需要转发。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析获取 context，需要代理的请求 url 前缀</span></span><br><span class="line"><span class="comment"> * @param &#123;string|object|function&#125; context 作为 HttpProxyMiddleware 接口传入 createConfig 函数的参数</span></span><br><span class="line"><span class="comment"> * @param &#123;undefined|object&#125; opts 作为 HttpProxyMiddleware 接口传入 createConfig 函数的参数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createConfig</span> (<span class="params">context, opts</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> config = &#123;</span><br><span class="line">    context: <span class="literal">undefined</span>,</span><br><span class="line">    options: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// context 作为 opts 传入，config.context 使用默认值</span></span><br><span class="line">  <span class="keyword">if</span> (isContextless(context, opts)) &#123;</span><br><span class="line">    config.context = <span class="string">'/'</span></span><br><span class="line">    config.options = _.assign(config.options, context)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// context 以 url 形式配置，可同时配置 context, options.target</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isStringShortHand(context)) &#123;</span><br><span class="line">    <span class="keyword">var</span> oUrl = url.parse(context)</span><br><span class="line">    <span class="keyword">var</span> target = [oUrl.protocol, <span class="string">'//'</span>, oUrl.host].join(<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line">    config.context = oUrl.pathname || <span class="string">'/'</span></span><br><span class="line">    config.options = _.assign(config.options, &#123; <span class="attr">target</span>: target &#125;, opts)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oUrl.protocol === <span class="string">'ws:'</span> || oUrl.protocol === <span class="string">'wss:'</span>) &#123;</span><br><span class="line">      config.options.ws = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    config.context = context</span><br><span class="line">    config.options = _.assign(config.options, opts)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 配置 Logger 实例</span></span><br><span class="line">  configureLogger(config.options)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!config.options.target) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(ERRORS.ERR_CONFIG_FACTORY_TARGET_MISSING)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> config</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析获取 context，需要代理的请求 url 前缀</span></span><br><span class="line"><span class="comment"> * @param &#123;string|function&#125; context 需要代理的请求 url 前缀</span></span><br><span class="line"><span class="comment"> * @param &#123;object&#125; uri 客户端请求的 uri，即 req.originalUrl 或 req.url</span></span><br><span class="line"><span class="comment"> * @param &#123;object&#125; req 客户端请求 req</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">matchContext</span> (<span class="params">context, uri, req</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// context 为字符串路径，校验 url 是否以 context 起始</span></span><br><span class="line">  <span class="keyword">if</span> (isStringPath(context)) &#123;</span><br><span class="line">    <span class="keyword">return</span> matchSingleStringPath(context, uri)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// context 为 glob 模式的字符串路径（通过 is-glob 模块判断），校验  url 是否匹配 context（通过 micromatch 判断）</span></span><br><span class="line">  <span class="comment">// [glob 介绍](https://blog.csdn.net/Free_Wind22/article/details/78344166)</span></span><br><span class="line">  <span class="keyword">if</span> (isGlobPath(context)) &#123;</span><br><span class="line">    <span class="keyword">return</span> matchSingleGlobPath(context, uri)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 遍历 context，调用 matchSingleStringPath, matchSingleGlobPath 作校验</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(context)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (context.every(isStringPath)) &#123;</span><br><span class="line">      <span class="keyword">return</span> matchMultiPath(context, uri)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (context.every(isGlobPath)) &#123;</span><br><span class="line">      <span class="keyword">return</span> matchMultiGlobPath(context, uri)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(ERRORS.ERR_CONTEXT_MATCHER_INVALID_ARRAY)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// context 自定义函数，用于校验客户端请求是否需要转发</span></span><br><span class="line">  <span class="keyword">if</span> (_.isFunction(context)) &#123;</span><br><span class="line">    <span class="keyword">var</span> pathname = getUrlPathName(uri)</span><br><span class="line">    <span class="keyword">return</span> context(pathname, req)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(ERRORS.ERR_CONTEXT_MATCHER_GENERIC)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="target"><a href="#target" class="headerlink" title="target"></a>target</h4><p>target 表示目标服务器的 host。在 createConfig 函数的源码中，可以看到，target 即能通过 url 形式的 context 设定，又能通过 options.target 选项设定。当然，这样是作为全局配置设定的；同 node-http-proxy 库，http-proxy-middleware 也可以在具体的请求发生时作特殊处理。这后半分的内容，是通过全局配置 options.router 达成的。在 http-proxy-middleware 处理客户端请求的过程中，getTarget 函数将通过 options.router 获取目标服务器的 host。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取目标服务器的 host</span></span><br><span class="line"><span class="comment"> * @param &#123;object&#125; req 客户端请求 req</span></span><br><span class="line"><span class="comment"> * @param &#123;object&#125; config 即 HttpProxyMiddleware 接口的 options 参数，获取 options.router</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTarget</span> (<span class="params">req, config</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> newTarget</span><br><span class="line">  <span class="keyword">var</span> router = config.router</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (_.isPlainObject(router)) &#123;</span><br><span class="line">    newTarget = getTargetFromProxyTable(req, router)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_.isFunction(router)) &#123;</span><br><span class="line">    newTarget = router(req)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> newTarget</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTargetFromProxyTable</span> (<span class="params">req, table</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> result</span><br><span class="line">  <span class="keyword">var</span> host = req.headers.host</span><br><span class="line">  <span class="keyword">var</span> path = req.url</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> hostAndPath = host + path<span class="comment">// 客户端请求路径</span></span><br><span class="line"></span><br><span class="line">  _.forIn(table, <span class="function"><span class="keyword">function</span> (<span class="params">value, key</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// containsPath(str) 函数，判断 str 是否包含 '/'</span></span><br><span class="line">    <span class="keyword">if</span> (containsPath(key)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (hostAndPath.indexOf(key) &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">        result = table[key]</span><br><span class="line">        logger.debug(<span class="string">'[HPM] Router table match: "%s"'</span>, key)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (key === host) &#123;</span><br><span class="line">        result = table[key]</span><br><span class="line">        logger.debug(<span class="string">'[HPM] Router table match: "%s"'</span>, host)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="pathRewrite"><a href="#pathRewrite" class="headerlink" title="pathRewrite"></a>pathRewrite</h4><p>在 http-proxy-middleware 库中，options.pathRewrite 用于将客户端请求路径转化为目标服务器的路径（pathname 部分），既可以是 map 映射，也可以函数。createPathRewriter 函数将根据 options.pathRewrite 生成路径转化器 pathRewriter 函数；而 pathRewriter 用于将实际的客户端请求地址转化为目标服务器的路径。当 options.pathRewrite 为对象 key-value 时，pathRewriter 将把匹配 key 的客户端请求转化为 value 路径；当 options.pathRewrite 为函数时，将由客户端请求 req.url 获取目标服务器路径。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成 pathRewriter 函数</span></span><br><span class="line"><span class="comment"> * @param &#123;object|function&#125; rewriteConfig 即 HttpProxyMiddleware 接口的 options.pathRewrite 配置项</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createPathRewriter</span> (<span class="params">rewriteConfig</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> rulesCache</span><br><span class="line"></span><br><span class="line">  <span class="comment">// isValidRewriteConfig 函数用于校验 options.pathRewrite</span></span><br><span class="line">  <span class="keyword">if</span> (!isValidRewriteConfig(rewriteConfig)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (_.isFunction(rewriteConfig)) &#123;</span><br><span class="line">    <span class="keyword">var</span> customRewriteFn = rewriteConfig</span><br><span class="line">    <span class="keyword">return</span> customRewriteFn</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    rulesCache = parsePathRewriteRules(rewriteConfig)</span><br><span class="line">    <span class="keyword">return</span> rewritePath</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 参数 path 为 req.url</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">rewritePath</span> (<span class="params">path</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = path</span><br><span class="line"></span><br><span class="line">    _.forEach(rulesCache, <span class="function"><span class="keyword">function</span> (<span class="params">rule</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (rule.regex.test(path)) &#123;</span><br><span class="line">        result = result.replace(rule.regex, rule.value)</span><br><span class="line">        logger.debug(<span class="string">'[HPM] Rewriting path from "%s" to "%s"'</span>, path, result)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parsePathRewriteRules</span> (<span class="params">rewriteConfig</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> rules = []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (_.isPlainObject(rewriteConfig)) &#123;</span><br><span class="line">    _.forIn(rewriteConfig, <span class="function"><span class="keyword">function</span> (<span class="params">value, key</span>) </span>&#123;</span><br><span class="line">      rules.push(&#123;</span><br><span class="line">        regex: <span class="keyword">new</span> <span class="built_in">RegExp</span>(key),</span><br><span class="line">        value: rewriteConfig[key]</span><br><span class="line">      &#125;)</span><br><span class="line">      logger.info(<span class="string">'[HPM] Proxy rewrite rule created: "%s" ~&gt; "%s"'</span>, key, rewriteConfig[key])</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> rules</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="整体流程"><a href="#整体流程" class="headerlink" title="整体流程"></a>整体流程</h3><p>这部分将串联转发规则的解析和应用，是为 http-proxy-middleware 库的整体工作流程。</p>
<ol>
<li>解析 context，options 配置，获得全局注册的 context, options.target；并配置 Logger 实例。</li>
<li>使用 node-http-proxy 库常见代理服务器 proxy。</li>
<li>根据 options.pathRewrite 生成路径转化器 pathRewriter。</li>
<li>为代理服务器绑定事件。</li>
<li>创建转发 http, https, websocket 请求的代理中间件。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">HttpProxyMiddleware</span> (<span class="params">context, opts</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// https://github.com/chimurai/http-proxy-middleware/issues/57</span></span><br><span class="line">  <span class="keyword">var</span> wsUpgradeDebounced = _.debounce(handleUpgrade)</span><br><span class="line">  <span class="keyword">var</span> wsInitialized = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">var</span> config = configFactory.createConfig(context, opts)</span><br><span class="line">  <span class="keyword">var</span> proxyOptions = config.options</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> proxy = httpProxy.createProxyServer(&#123;&#125;)</span><br><span class="line">  logger.info(<span class="string">'[HPM] Proxy created:'</span>, config.context, <span class="string">' -&gt; '</span>, proxyOptions.target)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> pathRewriter = PathRewriter.create(proxyOptions.pathRewrite)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 为代理服务器绑定事件</span></span><br><span class="line">  handlers.init(proxy, proxyOptions)</span><br><span class="line"></span><br><span class="line">  proxy.on(<span class="string">'error'</span>, logError)</span><br><span class="line"></span><br><span class="line">  middleware.upgrade = wsUpgradeDebounced</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> middleware</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 实际的代理中间件</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">middleware</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (shouldProxy(config.context, req)) &#123;</span><br><span class="line">      <span class="keyword">var</span> activeProxyOptions = prepareProxyRequest(req)</span><br><span class="line">      proxy.web(req, res, activeProxyOptions)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      next()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (proxyOptions.ws === <span class="literal">true</span>) &#123;</span><br><span class="line">      catchUpgradeRequest(req.connection.server)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">catchUpgradeRequest</span> (<span class="params">server</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!wsInitialized) &#123;</span><br><span class="line">      server.on(<span class="string">'upgrade'</span>, wsUpgradeDebounced)</span><br><span class="line">      wsInitialized = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 转发 websocket 请求</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleUpgrade</span> (<span class="params">req, socket, head</span>) </span>&#123;</span><br><span class="line">    wsInitialized = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shouldProxy(config.context, req)) &#123;</span><br><span class="line">      <span class="keyword">var</span> activeProxyOptions = prepareProxyRequest(req)</span><br><span class="line">      proxy.ws(req, socket, head, activeProxyOptions)</span><br><span class="line">      logger.info(<span class="string">'[HPM] Upgrading to WebSocket'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断请求是否需要转发</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">shouldProxy</span> (<span class="params">context, req</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> path = (req.originalUrl || req.url)</span><br><span class="line">    <span class="keyword">return</span> contextMatcher.match(context, path, req)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 转发请求</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">prepareProxyRequest</span> (<span class="params">req</span>) </span>&#123;</span><br><span class="line">    req.url = (req.originalUrl || req.url)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> originalPath = req.url</span><br><span class="line">    <span class="keyword">var</span> newProxyOptions = _.assign(&#123;&#125;, proxyOptions)</span><br><span class="line"></span><br><span class="line">    __applyRouter(req, newProxyOptions)</span><br><span class="line">    __applyPathRewrite(req, pathRewriter)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (proxyOptions.logLevel === <span class="string">'debug'</span>) &#123;</span><br><span class="line">      <span class="comment">// getArrow 返回的标识，用于区分 options.router, options.pathRewrite 的作用与否</span></span><br><span class="line">      <span class="comment">// '-&gt;' options.router, options.pathRewrite 均未作用</span></span><br><span class="line">      <span class="comment">// '=&gt;' options.router 作用, options.pathRewrite 未作用</span></span><br><span class="line">      <span class="comment">// '~&gt;' options.router 未作用, options.pathRewrite 作用</span></span><br><span class="line">      <span class="comment">// '≈&gt;' options.router, options.pathRewrite 均作用</span></span><br><span class="line">      <span class="keyword">var</span> arrow = getArrow(originalPath, req.url, proxyOptions.target, newProxyOptions.target)</span><br><span class="line">      logger.debug(<span class="string">'[HPM] %s %s %s %s'</span>, req.method, originalPath, arrow, newProxyOptions.target)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> newProxyOptions</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据请求获取目标服务器的 host</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__applyRouter</span> (<span class="params">req, options</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> newTarget</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.router) &#123;</span><br><span class="line">      newTarget = Router.getTarget(req, options)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (newTarget) &#123;</span><br><span class="line">        logger.debug(<span class="string">'[HPM] Router new target: %s -&gt; "%s"'</span>, options.target, newTarget)</span><br><span class="line">        options.target = newTarget</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将目标服务器路径写入 req.url</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__applyPathRewrite</span> (<span class="params">req, pathRewriter</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pathRewriter) &#123;</span><br><span class="line">      <span class="keyword">var</span> path = pathRewriter(req.url, req)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> path === <span class="string">'string'</span>) &#123;</span><br><span class="line">        req.url = path</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logger.info(<span class="string">'[HPM] pathRewrite: No rewritten path found. (%s)'</span>, req.url)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">logError</span> (<span class="params">err, req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> hostname = (req.headers &amp;&amp; req.headers.host) || (req.hostname || req.host)</span><br><span class="line">    <span class="keyword">var</span> target = proxyOptions.target.host || proxyOptions.target</span><br><span class="line">    <span class="keyword">var</span> errorMessage = <span class="string">'[HPM] Error occurred while trying to proxy request %s from %s to %s (%s) (%s)'</span></span><br><span class="line">    <span class="keyword">var</span> errReference = <span class="string">'https://nodejs.org/api/errors.html#errors_common_system_errors'</span></span><br><span class="line"></span><br><span class="line">    logger.error(errorMessage, req.url, hostname, target, err.code, errReference)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><h4 id="logger"><a href="#logger" class="headerlink" title="logger"></a>logger</h4><p>http-proxy-middleware 库使用单例模式创建 Logger 实例，并提供 setProvider 函数切换打印日志的 console 函数；setLevel 方法用于设定日志级别；继而由 Logger 实例提供 log, error, info, warn, debug 方法，这些方法在调用过程都会校验当前执行的方法是否符合当前日志级别，同时会允许首参以 %s 设定占位符，以注入次参等。</p>
<p>因日志模块在 node 服务器中广为应用，这里贴出 http-proxy-middleware 库中的代码实现。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> loggerInstance</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> defaultProvider = &#123;</span><br><span class="line">  log: <span class="built_in">console</span>.log,</span><br><span class="line">  debug: <span class="built_in">console</span>.log, </span><br><span class="line">  info: <span class="built_in">console</span>.info,</span><br><span class="line">  warn: <span class="built_in">console</span>.warn,</span><br><span class="line">  error: <span class="built_in">console</span>.error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> LEVELS = &#123;</span><br><span class="line">  debug: <span class="number">10</span>,</span><br><span class="line">  info: <span class="number">20</span>,</span><br><span class="line">  warn: <span class="number">30</span>,</span><br><span class="line">  error: <span class="number">50</span>,</span><br><span class="line">  silent: <span class="number">80</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Logger</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> logLevel</span><br><span class="line">  <span class="keyword">var</span> provider</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> api = &#123;</span><br><span class="line">    log: log,</span><br><span class="line">    debug: debug,</span><br><span class="line">    info: info,</span><br><span class="line">    warn: warn,</span><br><span class="line">    error: error,</span><br><span class="line">    setLevel: <span class="function"><span class="keyword">function</span> (<span class="params">v</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (isValidLevel(v)) &#123;<span class="comment">// isValidLevel 校验 v 是否 debug, info, warn, error, slient 中的一个</span></span><br><span class="line">        logLevel = v</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    setProvider: <span class="function"><span class="keyword">function</span> (<span class="params">fn</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (fn &amp;&amp; isValidProvider(fn)) &#123;<span class="comment">// isValidProvider 校验 fn 是否函数</span></span><br><span class="line">        provider = fn(defaultProvider)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  init()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> api</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">init</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    api.setLevel(<span class="string">'info'</span>)</span><br><span class="line">    api.setProvider(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> defaultProvider</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">log</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    provider.log(_interpolate.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">debug</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (_showLevel(<span class="string">'debug'</span>)) &#123;</span><br><span class="line">      provider.debug(_interpolate.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">info</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (_showLevel(<span class="string">'info'</span>)) &#123;</span><br><span class="line">      provider.info(_interpolate.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">warn</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (_showLevel(<span class="string">'warn'</span>)) &#123;</span><br><span class="line">      provider.warn(_interpolate.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">error</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (_showLevel(<span class="string">'error'</span>)) &#123;</span><br><span class="line">      provider.error(_interpolate.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 校验调用的方法是否在当前允许的日志级别下</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_showLevel</span> (<span class="params">showLevel</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">var</span> currentLogLevel = LEVELS[logLevel]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (currentLogLevel &amp;&amp; (currentLogLevel &lt;= LEVELS[showLevel])) &#123;</span><br><span class="line">      result = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 参数转化，允许首参以 %s 形式设置占位符</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_interpolate</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> fn = _.spread(util.format)</span><br><span class="line">    <span class="keyword">var</span> result = fn(_.slice(<span class="built_in">arguments</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  getInstance: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!loggerInstance) &#123;</span><br><span class="line">      loggerInstance = <span class="keyword">new</span> Logger()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> loggerInstance</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="事件绑定"><a href="#事件绑定" class="headerlink" title="事件绑定"></a>事件绑定</h4><p>解析 options.onError, options.onProxyReq, options.onProxyReqWs, options.onProxyRes, options.onOpen, options.onClose，并绑定为代理服务器的事件。</p>
<p>默认的绑定函数为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// onError 绑定函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defaultErrorHandler</span> (<span class="params">err, req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> host = (req.headers &amp;&amp; req.headers.host)</span><br><span class="line">  <span class="keyword">var</span> code = err.code</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (res.writeHead &amp;&amp; !res.headersSent) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/HPE_INVALID/</span>.test(code)) &#123;</span><br><span class="line">      res.writeHead(<span class="number">502</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'ECONNRESET'</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'ENOTFOUND'</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'ECONNREFUSED'</span>:</span><br><span class="line">          res.writeHead(<span class="number">504</span>)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">default</span>: res.writeHead(<span class="number">500</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  res.end(<span class="string">'Error occured while trying to proxy to: '</span> + host + req.url)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// onClose 绑定函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logClose</span> (<span class="params">req, socket, head</span>) </span>&#123;</span><br><span class="line">  logger.info(<span class="string">'[HPM] Client disconnected'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><h3 id="webpack-dev-server"><a href="#webpack-dev-server" class="headerlink" title="webpack-dev-server"></a>webpack-dev-server</h3><p>webpack-dev-server 库会创建 express 服务器，其服务器代理的实现就是解析配置项，并挂载 http-proxy-middleware 中间件。主要逻辑在 features.proxy 方法中实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> features = &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  proxy: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (options.proxy) &#123;</span><br><span class="line">      <span class="comment">// 解析配置</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(options.proxy)) &#123;</span><br><span class="line">        options.proxy = <span class="built_in">Object</span>.keys(options.proxy).map(<span class="function">(<span class="params">context</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">let</span> proxyOptions;</span><br><span class="line">          <span class="keyword">const</span> correctedContext = context</span><br><span class="line">            .replace(<span class="regexp">/^\*$/</span>, <span class="string">'**'</span>)</span><br><span class="line">            .replace(<span class="regexp">/\/\*$/</span>, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">typeof</span> options.proxy[context] === <span class="string">'string'</span>) &#123;</span><br><span class="line">            proxyOptions = &#123;</span><br><span class="line">              context: correctedContext,</span><br><span class="line">              target: options.proxy[context]</span><br><span class="line">            &#125;;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            proxyOptions = <span class="built_in">Object</span>.assign(&#123;&#125;, options.proxy[context]);</span><br><span class="line">            proxyOptions.context = correctedContext;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 日志级别</span></span><br><span class="line">          proxyOptions.logLevel = proxyOptions.logLevel || <span class="string">'warn'</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">return</span> proxyOptions;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 获得 proxy 中间件</span></span><br><span class="line">      <span class="keyword">const</span> getProxyMiddleware = <span class="function">(<span class="params">proxyConfig</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> context = proxyConfig.context || proxyConfig.path;</span><br><span class="line">        <span class="keyword">if</span> (proxyConfig.target) &#123;</span><br><span class="line">          <span class="keyword">return</span> httpProxyMiddleware(context, proxyConfig);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 以配置项挂载多个中间件</span></span><br><span class="line">      options.proxy.forEach(<span class="function">(<span class="params">proxyConfigOrCallback</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> proxyConfig;</span><br><span class="line">        <span class="keyword">let</span> proxyMiddleware;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> proxyConfigOrCallback === <span class="string">'function'</span>) &#123;</span><br><span class="line">          proxyConfig = proxyConfigOrCallback();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          proxyConfig = proxyConfigOrCallback;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        proxyMiddleware = getProxyMiddleware(proxyConfig);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (proxyConfig.ws) &#123;</span><br><span class="line">          websocketProxies.push(proxyMiddleware);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        app.use(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">typeof</span> proxyConfigOrCallback === <span class="string">'function'</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> newProxyConfig = proxyConfigOrCallback();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (newProxyConfig !== proxyConfig) &#123;</span><br><span class="line">              proxyConfig = newProxyConfig;</span><br><span class="line">              proxyMiddleware = getProxyMiddleware(proxyConfig);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">const</span> bypass = <span class="keyword">typeof</span> proxyConfig.bypass === <span class="string">'function'</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">const</span> bypassUrl = (bypass &amp;&amp; proxyConfig.bypass(req, res, proxyConfig)) || <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 转发到本地服务器</span></span><br><span class="line">          <span class="keyword">if</span> (bypassUrl) &#123;</span><br><span class="line">            req.url = bypassUrl;</span><br><span class="line"></span><br><span class="line">            next();</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (proxyMiddleware) &#123;</span><br><span class="line">            <span class="keyword">return</span> proxyMiddleware(req, res, next);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            next();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/09/工程化/node-http-proxy源码解读/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/09/工程化/node-http-proxy源码解读/" itemprop="url">node-http-proxy 源码解读</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-09T00:00:00+08:00">2018-11-09</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端工程化/" itemprop="url" rel="index"><span itemprop="name">前端工程化</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/09/工程化/node-http-proxy源码解读/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/11/09/工程化/node-http-proxy源码解读/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>node-http-proxy 模块用于转发 http 请求，其实现的大致原理为使用 http 或 https 模块搭建 node 代理服务器，将客户端发送的请求数据转发到目标服务器，再将响应输送到客户端。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="整体流程"><a href="#整体流程" class="headerlink" title="整体流程"></a>整体流程</h3><p>同 koa 的中间件机制相仿，node-http-proxy 模块内部组装任务队列，在请求转发的过程中，将任务队列中的处理函数逐个执行。处理函数的意义通常是封装消息头，当然，最后一个处理函数用于转发请求、输出响应。</p>
<p>同常见的 ajax 模块，node-http-proxy 模块接受全局配置的 options，同时，在某个具体的请求中，又接受特定的配置项 opts。而客户端发送的请求可能是 http, https 请求，也可能是 websocket 请求，node-http-proxy 模块必须实现对这两类请求的不同处理。</p>
<p>上述三点，实际的代码体现在 createRightProxy 高阶函数中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数 type 用于区分请求类型，'web' 为普通 http, https 请求，'ws' 为 websocket 请求</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createRightProxy</span>(<span class="params">type</span>) </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 参数 options 为全局配置项</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">req, res <span class="regexp">/*, [head], [opts] */</span></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// passes 任务队列</span></span><br><span class="line">      <span class="keyword">var</span> passes = (type === <span class="string">'ws'</span>) ? <span class="keyword">this</span>.wsPasses : <span class="keyword">this</span>.webPasses,</span><br><span class="line">          args = [].slice.call(<span class="built_in">arguments</span>),</span><br><span class="line">          cntr = args.length - <span class="number">1</span>,</span><br><span class="line">          head, cbl;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 解析回调函数</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="keyword">typeof</span> args[cntr] === <span class="string">'function'</span>) &#123;</span><br><span class="line">        cbl = args[cntr];</span><br><span class="line">        cntr--;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 混入该请求中特定的配置项 opts</span></span><br><span class="line">      <span class="keyword">var</span> requestOptions = options;</span><br><span class="line">      <span class="keyword">if</span>(</span><br><span class="line">        !(args[cntr] <span class="keyword">instanceof</span> Buffer) &amp;&amp;</span><br><span class="line">        args[cntr] !== res</span><br><span class="line">      ) &#123;</span><br><span class="line">        requestOptions = extend(&#123;&#125;, options);</span><br><span class="line">        extend(requestOptions, args[cntr]);</span><br><span class="line">        cntr--;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// head</span></span><br><span class="line">      <span class="keyword">if</span>(args[cntr] <span class="keyword">instanceof</span> Buffer) &#123;</span><br><span class="line">        head = args[cntr];</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 请求的目标地址</span></span><br><span class="line">      [<span class="string">'target'</span>, <span class="string">'forward'</span>].forEach(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> requestOptions[e] === <span class="string">'string'</span>)</span><br><span class="line">          requestOptions[e] = parse_url(requestOptions[e]);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!requestOptions.target &amp;&amp; !requestOptions.forward) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.emit(<span class="string">'error'</span>, <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Must provide a proper URL as target'</span>));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 挨个执行任务队列，处理消息头，转发请求</span></span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i &lt; passes.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(passes[i](req, res, requestOptions, head, <span class="keyword">this</span>, cbl)) &#123;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此，createRightProxy(‘web’)(options), createRightProxy(‘ws’)(options) 就能用于创建实际的请求转发函数。在 node-http-proxy 模块中，这两个函数分别表现为 ProxyServer 实例的 web, ws 方法。其中，proxyServer.web 方法作为 http 或 https 服务器 listen 方法的回调函数，proxyServer.ws 方法作为 ‘upgrade’ 事件的绑定函数，从而能对接上客户端 ajax 请求、websocket 请求的执行时机。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProxyServer</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建转发 http, https; websocket 请求的处理函数</span></span><br><span class="line">  <span class="keyword">this</span>.web = <span class="keyword">this</span>.proxyRequest           = createRightProxy(<span class="string">'web'</span>)(options);</span><br><span class="line">  <span class="keyword">this</span>.ws  = <span class="keyword">this</span>.proxyWebsocketRequest  = createRightProxy(<span class="string">'ws'</span>)(options);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 任务队列，用于处理消息头、转发请求</span></span><br><span class="line">  <span class="keyword">this</span>.webPasses = <span class="built_in">Object</span>.keys(web).map(<span class="function"><span class="keyword">function</span>(<span class="params">pass</span>) </span>&#123;<span class="comment">// this.web 方法执行过程中调用的任务队列</span></span><br><span class="line">    <span class="keyword">return</span> web[pass];</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">this</span>.wsPasses = <span class="built_in">Object</span>.keys(ws).map(<span class="function"><span class="keyword">function</span>(<span class="params">pass</span>) </span>&#123;<span class="comment">// this.ws 方法执行过程中调用的任务队列</span></span><br><span class="line">    <span class="keyword">return</span> ws[pass];</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ProxyServer.prototype.listen = <span class="function"><span class="keyword">function</span>(<span class="params">port, hostname</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> self    = <span class="keyword">this</span>,</span><br><span class="line">      closure = <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123; self.web(req, res); &#125;;<span class="comment">// 转发 http, https 请求</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>._server  = <span class="keyword">this</span>.options.ssl ?</span><br><span class="line">    https.createServer(<span class="keyword">this</span>.options.ssl, closure) :</span><br><span class="line">    http.createServer(closure);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 转发 websocket 请求</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">this</span>.options.ws) &#123;</span><br><span class="line">    <span class="keyword">this</span>._server.on(<span class="string">'upgrade'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, socket, head</span>) </span>&#123; self.ws(req, socket, head); &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>._server.listen(port, hostname);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>以上不涉及任务队列的具体实现，却构成了 node-http-proxy 模块整体处理流程。除外而外，ProxyServer 还提供 before(type, passName, callback), after(type, passName, callback) 原型方法，用于在任务队列的某个具体处理函数之前或之后插入一个处理函数 callback。</p>
<h3 id="http-https-请求"><a href="#http-https-请求" class="headerlink" title="http, https 请求"></a>http, https 请求</h3><p>this.webPasses 任务队列包含如下四种处理函数：deleteLength, timeout, XHeaders, stream。</p>
<ol>
<li>deleteLength 函数：针对 DELETE 或 OPTIONS，且 headers[‘content-length’] 未设置的情形，将 headers[‘content-length’] 置为 0，并删除 headers[‘transfer-encoding’] 消息头。</li>
<li>timeout 函数：若设置了 options.timeout，调用 req.socket.setTimeout(options.timeout) 设置超时时间。</li>
<li>XHeaders 函数：设置 ‘x-forwarded-for’, ‘x-forwarded-port’, ‘x-forwarded-proto’, ‘x-forwarded-host’ 消息头，包含客户端和代理服务器的地址、端口、协议等内容（以 ‘,’ 拼接 req.headers 同名属性即客户端内容、和代理服务器内容）。其中，’x-forwarded-host’ 消息头只包含 req.headers.host，即代理服务器的主机名。由配置项 options.xfwd 启用 ‘x-forwarded-*’ 消息头的设置。</li>
<li>stream 函数：实际转发请求的处理函数。下文将作详解。</li>
</ol>
<p>stream 函数的处理流程为：</p>
<ol>
<li>调用 common.setupOutgoing 方法生成代理请求的配置项。</li>
<li>通过 options.forward, options.target 区分 ‘forward’ 和 ‘target’ 两种模式。在 ‘forward’ 模式下，只通过代理请求转发到目标服务器，输送给客户端的仍是代理服务器的响应。’target’ 模式下，不只可以处理目标服务器的响应，且可监听许多事件对代理请求等作出处理。’forward’ 和 ‘target’ 模式可以并行存在，即同时指定 options.forward, options.target。</li>
</ol>
<p>首先，common.setupOutgoing 的实现如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成代理请求的配置项，将作为 http.request 的参数</span></span><br><span class="line"><span class="comment"> * @param &#123;object&#125; outgoing 即 options.ssl 或 &#123;&#125;</span></span><br><span class="line"><span class="comment"> * @param &#123;object&#125; options 即 options</span></span><br><span class="line"><span class="comment"> * @param &#123;object&#125; req 即实际的请求</span></span><br><span class="line"><span class="comment"> * @param &#123;string|undefined&#125; forward 用于区分 'forward' 和 'target' 模式。值为 'forward' 或 undefined</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">common.setupOutgoing = <span class="function"><span class="keyword">function</span>(<span class="params">outgoing, options, req, forward</span>) </span>&#123;</span><br><span class="line">  outgoing.port = options[forward || <span class="string">'target'</span>].port ||</span><br><span class="line">                  (isSSL.test(options[forward || <span class="string">'target'</span>].protocol) ? <span class="number">443</span> : <span class="number">80</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// http://nodejs.cn/api/http.html#http_http_request_options_callback</span></span><br><span class="line">  <span class="comment">// host, host: 目标服务器的域名或 IP 地址</span></span><br><span class="line">  <span class="comment">// socketPath: Unix 域 Socket（使用 host:port 或 socketPath）</span></span><br><span class="line">  <span class="comment">// ca: ca 证书</span></span><br><span class="line">  [<span class="string">'host'</span>, <span class="string">'hostname'</span>, <span class="string">'socketPath'</span>, <span class="string">'pfx'</span>, <span class="string">'key'</span>,</span><br><span class="line">    <span class="string">'passphrase'</span>, <span class="string">'cert'</span>, <span class="string">'ca'</span>, <span class="string">'ciphers'</span>, <span class="string">'secureProtocol'</span>].forEach(</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123; outgoing[e] = options[forward || <span class="string">'target'</span>][e]; &#125;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 请求方法</span></span><br><span class="line">  outgoing.method = options.method || req.method;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 请求头</span></span><br><span class="line">  outgoing.headers = extend(&#123;&#125;, req.headers);</span><br><span class="line">  <span class="keyword">if</span> (options.headers)&#123;</span><br><span class="line">    extend(outgoing.headers, options.headers);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 基本身份验证，如 'user:password' 用来计算 Authorization 请求头</span></span><br><span class="line">  <span class="keyword">if</span> (options.auth) &#123;</span><br><span class="line">    outgoing.auth = options.auth;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (options.ca) &#123;</span><br><span class="line">    outgoing.ca = options.ca;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isSSL.test(options[forward || <span class="string">'target'</span>].protocol)) &#123;</span><br><span class="line">    outgoing.rejectUnauthorized = (<span class="keyword">typeof</span> options.secure === <span class="string">"undefined"</span>) ? <span class="literal">true</span> : options.secure;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// http://nodejs.cn/api/http.html#http_new_agent_options</span></span><br><span class="line">  <span class="comment">// 长连接时设置 options.agent = &#123; keepAlive, keepAliveMsecs &#125;</span></span><br><span class="line">  outgoing.agent = options.agent || <span class="literal">false</span>;</span><br><span class="line">  outgoing.localAddress = options.localAddress;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 不是长连接，设置 outgoing.headers.connection 请求头</span></span><br><span class="line">  <span class="keyword">if</span> (!outgoing.agent) &#123;</span><br><span class="line">    outgoing.headers = outgoing.headers || &#123;&#125;;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> outgoing.headers.connection !== <span class="string">'string'</span></span><br><span class="line">        || !upgradeHeader.test(outgoing.headers.connection)</span><br><span class="line">       ) &#123; outgoing.headers.connection = <span class="string">'close'</span>; &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 最终的请求路径由 options['forward'|'target'], req.url 拼接产生，可根据 options 配置设定某项是否启用</span></span><br><span class="line">  <span class="keyword">var</span> target = options[forward || <span class="string">'target'</span>];</span><br><span class="line">  <span class="keyword">var</span> targetPath = target &amp;&amp; options.prependPath !== <span class="literal">false</span></span><br><span class="line">    ? (target.path || <span class="string">''</span>) : <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">var</span> outgoingPath = !options.toProxy</span><br><span class="line">    ? (url.parse(req.url).path || <span class="string">''</span>) : req.url;</span><br><span class="line">  outgoingPath = !options.ignorePath ? outgoingPath : <span class="string">''</span>;</span><br><span class="line">  outgoing.path = common.urlJoin(targetPath, outgoingPath);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (options.changeOrigin) &#123;</span><br><span class="line">    outgoing.headers.host =</span><br><span class="line">      <span class="comment">// 通过 requires-port 模块校验在使用某种协议的情况下，是否需要在 url 上拼接端口号</span></span><br><span class="line">      required(outgoing.port, options[forward || <span class="string">'target'</span>].protocol) &amp;&amp; !hasPort(outgoing.host)</span><br><span class="line">        ? outgoing.host + <span class="string">':'</span> + outgoing.port</span><br><span class="line">        : outgoing.host;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> outgoing;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>其次，stream 的实现如下：</p>
<ol>
<li>调用 [http|https].request(outgoing) 创建代理请求。outgoing 由 common.setupOutgoing 函数获得。</li>
<li>调用 (options.buffer || req).pipe(forwardReq) 方法转发代理请求。</li>
<li>target 模式下，调用 web-outgoing 模块中的函数处理代理响应。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stream</span>(<span class="params">req, res, options, _, server, clb</span>) </span>&#123;</span><br><span class="line">  server.emit(<span class="string">'start'</span>, req, res, options.target || options.forward);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// options.followRedirects 是否使用 follow-redirects 重定向</span></span><br><span class="line">  <span class="keyword">var</span> agents = options.followRedirects ? followRedirects : nativeAgents;</span><br><span class="line">  <span class="keyword">var</span> http = agents.http;</span><br><span class="line">  <span class="keyword">var</span> https = agents.https;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(options.forward) &#123;</span><br><span class="line">    <span class="comment">// 生成代理请求</span></span><br><span class="line">    <span class="keyword">var</span> forwardReq = (options.forward.protocol === <span class="string">'https:'</span> ? https : http).request(</span><br><span class="line">      common.setupOutgoing(options.ssl || &#123;&#125;, options, req, <span class="string">'forward'</span>)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> forwardError = createErrorHandler(forwardReq, options.forward);</span><br><span class="line">    req.on(<span class="string">'error'</span>, forwardError);</span><br><span class="line">    forwardReq.on(<span class="string">'error'</span>, forwardError);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转发代理请求</span></span><br><span class="line">    (options.buffer || req).pipe(forwardReq);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 非 target 模式，返回响应</span></span><br><span class="line">    <span class="keyword">if</span>(!options.target) &#123; <span class="keyword">return</span> res.end(); &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 生成代理请求</span></span><br><span class="line">  <span class="keyword">var</span> proxyReq = (options.target.protocol === <span class="string">'https:'</span> ? https : http).request(</span><br><span class="line">    common.setupOutgoing(options.ssl || &#123;&#125;, options, req)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  proxyReq.on(<span class="string">'socket'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">socket</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(server) &#123; server.emit(<span class="string">'proxyReq'</span>, proxyReq, req, res, options); &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(options.proxyTimeout) &#123;</span><br><span class="line">    proxyReq.setTimeout(options.proxyTimeout, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        proxyReq.abort();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  req.on(<span class="string">'aborted'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    proxyReq.abort();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> proxyError = createErrorHandler(proxyReq, options.target);</span><br><span class="line">  req.on(<span class="string">'error'</span>, proxyError);</span><br><span class="line">  proxyReq.on(<span class="string">'error'</span>, proxyError);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">createErrorHandler</span>(<span class="params">proxyReq, url</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">proxyError</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (req.socket.destroyed &amp;&amp; err.code === <span class="string">'ECONNRESET'</span>) &#123;</span><br><span class="line">        server.emit(<span class="string">'econnreset'</span>, err, req, res, url);</span><br><span class="line">        <span class="keyword">return</span> proxyReq.abort();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (clb) &#123;</span><br><span class="line">        clb(err, req, res, url);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        server.emit(<span class="string">'error'</span>, err, req, res, url);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 转发代理请求</span></span><br><span class="line">  (options.buffer || req).pipe(proxyReq);</span><br><span class="line"></span><br><span class="line">  proxyReq.on(<span class="string">'response'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">proxyRes</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(server) &#123; server.emit(<span class="string">'proxyRes'</span>, proxyRes, req, res); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用 web-outgoing 模块中的函数处理代理响应</span></span><br><span class="line">    <span class="keyword">if</span>(!res.headersSent &amp;&amp; !options.selfHandleResponse) &#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i &lt; web_o.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(web_o[i](req, res, proxyRes, options)) &#123; <span class="keyword">break</span>; &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// http://nodejs.cn/api/http.html#http_response_finished</span></span><br><span class="line">    <span class="keyword">if</span> (!res.finished) &#123;</span><br><span class="line">      <span class="comment">// 通过事件处理代理响应</span></span><br><span class="line">      proxyRes.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (server) server.emit(<span class="string">'end'</span>, req, res, proxyRes);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 由 node-http-proxy 模块处理代理响应的情境下，返回响应</span></span><br><span class="line">      <span class="keyword">if</span> (!options.selfHandleResponse) proxyRes.pipe(res);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (server) server.emit(<span class="string">'end'</span>, req, res, proxyRes);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，再来看一下 web-outgoing 模块对代理响应的处理（实现查看源码）：</p>
<ol>
<li>removeChunked 函数：当使用 http/1.0 时（通过 req.httpVersion === ‘1.0’ 判断，客户端决定），移除代理响应的 headers[‘transfer-encoding’]。</li>
<li>setConnection 函数：当使用 http/1.0 时，代理响应的 headers.connection 设为 req.headers.connection || ‘close’；当使用非 http/2.0 时，且 proxyRes.headers.connection 为否，将 代理响应的 headers.connection 设为 req.headers.connection || ‘keep-alive’。</li>
<li>setRedirectHostRewrite 函数：根据 options.hostRewrite 或 options.autoRewrite 或 options.protocolRewrite 重写重定向地址 proxyRes.headers.location。代理相应的状态码须匹配 /^201|30(1|2|7|8)$/ 正则，且 proxyRes.headers.location 须与目标服务器同域名。</li>
<li>writeHeaders 函数：将代理响应的消息头写入实际响应 res 的消息头中。下文将作详解。</li>
<li>writeStatusCode 函数：将代理响应的 statusCode, statusMessage 写入返回给客户端的响应 res 中。</li>
</ol>
<p>setRedirectHostRewrite 函数的代码实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeHeaders</span>(<span class="params">req, res, proxyRes, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> rewriteCookieDomainConfig = options.cookieDomainRewrite,</span><br><span class="line">      rewriteCookiePathConfig = options.cookiePathRewrite,</span><br><span class="line">      preserveHeaderKeyCase = options.preserveHeaderKeyCase,</span><br><span class="line">      rawHeaderKeyMap,</span><br><span class="line">      setHeader = <span class="function"><span class="keyword">function</span>(<span class="params">key, header</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (header == <span class="literal">undefined</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (rewriteCookieDomainConfig &amp;&amp; key.toLowerCase() === <span class="string">'set-cookie'</span>) &#123;</span><br><span class="line">          header = common.rewriteCookieProperty(header, rewriteCookieDomainConfig, <span class="string">'domain'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (rewriteCookiePathConfig &amp;&amp; key.toLowerCase() === <span class="string">'set-cookie'</span>) &#123;</span><br><span class="line">          header = common.rewriteCookieProperty(header, rewriteCookiePathConfig, <span class="string">'path'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        res.setHeader(<span class="built_in">String</span>(key).trim(), header);</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> rewriteCookieDomainConfig === <span class="string">'string'</span>) &#123; <span class="comment">//also test for ''</span></span><br><span class="line">    rewriteCookieDomainConfig = &#123; <span class="string">'*'</span>: rewriteCookieDomainConfig &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> rewriteCookiePathConfig === <span class="string">'string'</span>) &#123; <span class="comment">//also test for ''</span></span><br><span class="line">    rewriteCookiePathConfig = &#123; <span class="string">'*'</span>: rewriteCookiePathConfig &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// http://nodejs.cn/api/http.html#http_message_rawheaders</span></span><br><span class="line">  <span class="keyword">if</span> (preserveHeaderKeyCase &amp;&amp; proxyRes.rawHeaders != <span class="literal">undefined</span>) &#123;</span><br><span class="line">    rawHeaderKeyMap = &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; proxyRes.rawHeaders.length; i += <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> key = proxyRes.rawHeaders[i];</span><br><span class="line">      rawHeaderKeyMap[key.toLowerCase()] = key;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Object</span>.keys(proxyRes.headers).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> header = proxyRes.headers[key];</span><br><span class="line">    <span class="keyword">if</span> (preserveHeaderKeyCase &amp;&amp; rawHeaderKeyMap) &#123;</span><br><span class="line">      key = rawHeaderKeyMap[key] || key;</span><br><span class="line">    &#125;</span><br><span class="line">    setHeader(key, header);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据 options.cookieDomainRewrite, options.cookiePathRewrite 重写 res.headers.cookie 中的 domain, path 属性</span></span><br><span class="line"><span class="comment">// cookie.domain 表示 cookie 所在的域</span></span><br><span class="line"><span class="comment">// cookie.path 表示 cookie 所在的目录</span></span><br><span class="line"><span class="comment">// 参考 [理解cookie的path和domain属性](https://www.cnblogs.com/chris-oil/p/3869803.html)</span></span><br><span class="line">common.rewriteCookieProperty = <span class="function"><span class="keyword">function</span> <span class="title">rewriteCookieProperty</span>(<span class="params">header, config, property</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(header)) &#123;</span><br><span class="line">    <span class="keyword">return</span> header.map(<span class="function"><span class="keyword">function</span> (<span class="params">headerElement</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> rewriteCookieProperty(headerElement, config, property);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> header.replace(<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">"(;\\s*"</span> + property + <span class="string">"=)([^;]+)"</span>, <span class="string">'i'</span>), <span class="function"><span class="keyword">function</span>(<span class="params">match, prefix, previousValue</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> newValue;</span><br><span class="line">    <span class="keyword">if</span> (previousValue <span class="keyword">in</span> config) &#123;</span><br><span class="line">      newValue = config[previousValue];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">'*'</span> <span class="keyword">in</span> config) &#123;</span><br><span class="line">      newValue = config[<span class="string">'*'</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> match;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (newValue) &#123;</span><br><span class="line">      <span class="keyword">return</span> prefix + newValue;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="websocket-请求"><a href="#websocket-请求" class="headerlink" title="websocket 请求"></a>websocket 请求</h3><p>this.wsPasses 任务队列包含如下四种处理函数：checkMethodAndHeader, XHeaders, stream。</p>
<ol>
<li>checkMethodAndHeader 函数：websocket 请求的请求方式必须是 get，且 headers.upgrade 请求头必须是 ‘websocket’，checkMethodAndHeader 函数用于校验请求方式和 headers.upgrade 请求头。</li>
<li>XHeaders 函数：设置 ‘x-forwarded-for’, ‘x-forwarded-port’, ‘x-forwarded-proto’ 消息头，包含客户端和代理服务器的地址、端口、协议等内容（以 ‘,’ 拼接 req.headers 同名属性即客户端内容、和代理服务器内容）。由配置项 options.xfwd 启用 ‘x-forwarded-*’ 消息头的设置。</li>
<li>stream 函数：实际转发请求的处理函数。下文将作详解。</li>
</ol>
<p>stream 函数的处理流程为：</p>
<ol>
<li>调用 common.setupOutgoing 方法生成代理请求的配置项。</li>
<li>调用 [http|https].request(outgoing) 创建代理请求 proxyReq。</li>
<li>调用 proxyReq.end 发送代理请求。 </li>
<li>监听 response 事件，修改消息头后将响应发送给客户端。</li>
<li>监听 upgrade 事件，更换协议后，调用 proxySocket.pipe(socket).pipe(proxySocket) 再次发送代理请求。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">common.setupSocket = <span class="function"><span class="keyword">function</span>(<span class="params">socket</span>) </span>&#123;</span><br><span class="line">  socket.setTimeout(<span class="number">0</span>);</span><br><span class="line">  socket.setNoDelay(<span class="literal">true</span>);</span><br><span class="line">  socket.setKeepAlive(<span class="literal">true</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> socket;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stream</span>(<span class="params">req, socket, options, head, server, clb</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 添加请求头内容</span></span><br><span class="line">  <span class="keyword">var</span> createHttpHeader = <span class="function"><span class="keyword">function</span>(<span class="params">line, headers</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.keys(headers).reduce(<span class="function"><span class="keyword">function</span> (<span class="params">head, key</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> value = headers[key];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(value)) &#123;</span><br><span class="line">        head.push(key + <span class="string">': '</span> + value);</span><br><span class="line">        <span class="keyword">return</span> head;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; value.length; i++) &#123;</span><br><span class="line">        head.push(key + <span class="string">': '</span> + value[i]);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> head;</span><br><span class="line">    &#125;, [line])</span><br><span class="line">    .join(<span class="string">'\r\n'</span>) + <span class="string">'\r\n\r\n'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  common.setupSocket(socket);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (head &amp;&amp; head.length) socket.unshift(head);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建代理请求</span></span><br><span class="line">  <span class="keyword">var</span> proxyReq = (common.isSSL.test(options.target.protocol) ? https : http).request(</span><br><span class="line">    common.setupOutgoing(options.ssl || &#123;&#125;, options, req)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (server) &#123; server.emit(<span class="string">'proxyReqWs'</span>, proxyReq, req, socket, options, head); &#125;</span><br><span class="line"></span><br><span class="line">  proxyReq.on(<span class="string">'error'</span>, onOutgoingError);</span><br><span class="line">  proxyReq.on(<span class="string">'response'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 属性响应到客户端</span></span><br><span class="line">    <span class="keyword">if</span> (!res.upgrade) &#123;</span><br><span class="line">      socket.write(createHttpHeader(<span class="string">'HTTP/'</span> + res.httpVersion + <span class="string">' '</span> + res.statusCode + <span class="string">' '</span> + res.statusMessage, res.headers));</span><br><span class="line">      res.pipe(socket);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  proxyReq.on(<span class="string">'upgrade'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">proxyRes, proxySocket, proxyHead</span>) </span>&#123;</span><br><span class="line">    proxySocket.on(<span class="string">'error'</span>, onOutgoingError);</span><br><span class="line"></span><br><span class="line">    proxySocket.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      server.emit(<span class="string">'close'</span>, proxyRes, proxySocket, proxyHead);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    socket.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      proxySocket.end();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    common.setupSocket(proxySocket);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (proxyHead &amp;&amp; proxyHead.length) proxySocket.unshift(proxyHead);</span><br><span class="line"></span><br><span class="line">    socket.write(createHttpHeader(<span class="string">'HTTP/1.1 101 Switching Protocols'</span>, proxyRes.headers));</span><br><span class="line"></span><br><span class="line">    proxySocket.pipe(socket).pipe(proxySocket);<span class="comment">// 再次发送代理请求？</span></span><br><span class="line"></span><br><span class="line">    server.emit(<span class="string">'open'</span>, proxySocket);</span><br><span class="line">    server.emit(<span class="string">'proxySocket'</span>, proxySocket);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> proxyReq.end(); <span class="comment">// 发送代理请求</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">onOutgoingError</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (clb) &#123;</span><br><span class="line">      clb(err, req, socket);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      server.emit(<span class="string">'error'</span>, err, req, socket);</span><br><span class="line">    &#125;</span><br><span class="line">    socket.end();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><h3 id="http-proxy-middleware"><a href="#http-proxy-middleware" class="headerlink" title="http-proxy-middleware"></a>http-proxy-middleware</h3><p>参见 <a href="http://xzfyu.com/2018/11/11/%E5%B7%A5%E7%A8%8B%E5%8C%96/http-proxy-middleware%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" target="_blank" rel="noopener">http-proxy-middleware 源码解读</a>。</p>
<h3 id="nokit-filter-proxy"><a href="#nokit-filter-proxy" class="headerlink" title="nokit-filter-proxy"></a>nokit-filter-proxy</h3><p>nokit-filter-proxy 库用于为 <a href="https://github.com/nokitjs/nokit" target="_blank" rel="noopener">nokit</a> 服务器添加代理功能。鉴于前端构建工具 dawn 使用 nokit 搭建本地调试服务器，nokit-filter-proxy 库也用于为 dn-middleware-server 中间件实现代理功能。</p>
<p>同 http-proxy-middleware 库，nokit-filter-proxy 借助 node-http-proxy 实现服务器代理的都是先校验请求路径是否匹配转发策略，拦截并转发请求。nokit-filter-proxy 通过绑定 onRequest 事件函数，实现请求的拦截和转发。详见源码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> httpProxy = <span class="built_in">require</span>(<span class="string">"http-proxy"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProxyFilter</span>(<span class="params">server</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">var</span> utils = self.utils = server.require(<span class="string">"$./core/utils"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// proxy 配置，作为请求路径转发规则</span></span><br><span class="line">  self.configs = server.configs.proxy || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 作为代理服务器的配置项</span></span><br><span class="line">  self.configs.options = self.configs.options || &#123;&#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 代理请求设置 'x-forwarded-for', 'x-forwarded-port', 'x-forwarded-proto', 'x-forwarded-host' 消息头</span></span><br><span class="line">  <span class="keyword">if</span> (utils.isNull(self.configs.options.xfwd)) &#123;</span><br><span class="line">    self.configs.options.xfwd = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 代理请求设置 headers.host 消息头</span></span><br><span class="line">  <span class="keyword">if</span> (utils.isNull(self.configs.options.changeOrigin)) &#123;</span><br><span class="line">    self.configs.options.changeOrigin = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 请求路径转发规则，key - value 形式，key 为客户端请求路径正则，value 为目标服务器路径</span></span><br><span class="line">  self.configs.rules = self.configs.rules || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建代理服务器  </span></span><br><span class="line">  self.proxy = httpProxy.createProxyServer(self.configs.options);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 转发代理请求前，使用 headers 配置修改代理请求的消息头</span></span><br><span class="line">  self.onProxyReqHandler = self.onProxyReqHandler.bind(self);</span><br><span class="line">  self.proxy.on(<span class="string">"proxyReq"</span>, self.onProxyReqHandler);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ProxyFilter.prototype.onProxyReqHandler = <span class="function"><span class="keyword">function</span>(<span class="params">proxyReq, req, res, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">if</span> (!self.configs.headers) <span class="keyword">return</span>;</span><br><span class="line">  self.utils.each(self.configs.headers, <span class="function"><span class="keyword">function</span>(<span class="params">name, value</span>) </span>&#123;</span><br><span class="line">    proxyReq.setHeader(name, value);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// self.matchRule 根据 rules 配置，解析出请求路径转发规则</span></span><br><span class="line">ProxyFilter.prototype.matchRule = <span class="function"><span class="keyword">function</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">var</span> rule = <span class="literal">null</span>;</span><br><span class="line">  self.utils.each(self.configs.rules, <span class="function"><span class="keyword">function</span>(<span class="params">exprText, target</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> expr = <span class="keyword">new</span> <span class="built_in">RegExp</span>(exprText);</span><br><span class="line">    <span class="keyword">if</span> (expr.test(url)) &#123;</span><br><span class="line">      <span class="keyword">var</span> urlParts = expr.exec(url);</span><br><span class="line">      rule = &#123;</span><br><span class="line">        url: urlParts.length &gt; <span class="number">1</span> ? urlParts[<span class="number">1</span>] : url,</span><br><span class="line">        target: target</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> rule;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ProxyFilter.prototype.onRequest = <span class="function"><span class="keyword">function</span>(<span class="params">context, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">var</span> res = context.res,</span><br><span class="line">    req = context.req;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> rule = self.matchRule(req.url);</span><br><span class="line">  <span class="keyword">if</span> (!rule) <span class="keyword">return</span> next();</span><br><span class="line">  req.url = rule.url || <span class="string">"/"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 转发代理请求</span></span><br><span class="line">  self.proxy.web(req, res, &#123;</span><br><span class="line">    <span class="string">"target"</span>: rule.target</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>这两篇文章都是在笔者整理完 proxy 设计模式后整理的。鉴于本人水平有限，文章难免错谬，仍望读者不吝赐教。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpeg"
                alt="Alfred" />
            
              <p class="site-author-name" itemprop="name">Alfred</p>
              <p class="site-description motion-element" itemprop="description">人苦不知足，既得陇，复望蜀</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">62</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    <span class="site-state-item-count">25</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    <span class="site-state-item-count">23</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Alfred-sg" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/xiu-fan-79/activities" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-globe"></i>知乎</a>
                  </span>
                
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Alfred</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Pisces</a> v6.0.2</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.0.2"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.2"></script>



  

  
    <script id="dsq-count-scr" src="https://alfred.disqus.com/count.js" async></script>
  

  





	





  












  





  

  

  

  

  
  

  

  

  

  

</body>
</html>
