<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.2" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.2">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.2" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.0.2',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="Hexo, NexT" />


<meta name="description" content="人苦不知足，既得陇，复望蜀">
<meta property="og:type" content="website">
<meta property="og:title" content="修子范语">
<meta property="og:url" content="http://yoursite.com/page/3/index.html">
<meta property="og:site_name" content="修子范语">
<meta property="og:description" content="人苦不知足，既得陇，复望蜀">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="修子范语">
<meta name="twitter:description" content="人苦不知足，既得陇，复望蜀">






  <link rel="canonical" href="http://yoursite.com/page/3/"/>


  <title>修子范语</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">修子范语</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Alfredo's Notes</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
        </li>
      

      
    </ul>
  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/24/设计模式/职责链模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/24/设计模式/职责链模式/" itemprop="url">职责链模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-24T00:00:00+08:00">2018-06-24</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/设计模式/" itemprop="url" rel="index"><span itemprop="name">设计模式</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/06/24/设计模式/职责链模式/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/06/24/设计模式/职责链模式/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>职责链模式(Chain of Responsibility)的主要实现逻辑为，将请求的处理对象构造为链式结构，然后在这条链上依序传递请求，直到请求被某个对象处理，或者最终得不到处理。</p>
<p>《设计模式:可复用面向对象软件的基础》一书将职责链模式描述为：</p>
<p>Avoid coupling the sender of a request to its receiver by giving morethan one object a chance to handle the request. Chain the receiving objects and pass the request along the chain until an object handles it.</p>
<h2 id="经典实现"><a href="#经典实现" class="headerlink" title="经典实现"></a>经典实现</h2><p>职责链模式包含下列组件：</p>
<ul>
<li>Handler: 处理请求对象的抽象接口，包含 handle 抽象方法，用于处理请求或调用下一个处理对象处理请求；setNextHandler 方法（可选），用于设定下一个处理对象；nextHandler 属性为下一个处理对象。</li>
<li>ConcerteHandler: 处理请求的具体类，包含 handle, setNextHandler 方法的实现，nextHandler 属性访问下一个处理对象。</li>
<li>Client: 用于向链上的具体处理者传递请求。</li>
</ul>
<p>以下代码使用职责链模式揣测浏览器事件冒泡机制的简要实现。与浏览器不同的是，示例代码只演示父子层级关系中，子节点如何将事件对象转交给父节点，并触发绑定在父节点上的事件处理函数。不过，通过这段简要的代码实现，可以猜想事件对象 stopPropagation 方法的实现。事件对象可在鼠标或键盘点击时构造；在浏览器中，指定下一个处理对象这一过程，也可以在解析 dom 树的时候实现，使父节点自然成为子节点的下一个处理对象。关于事件捕获的实现，疑似通过事件对象的坐标属性和元素的位置属性比对实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">abstract <span class="class"><span class="keyword">class</span> <span class="title">Handler</span></span>&#123;</span><br><span class="line">  nextHandler;</span><br><span class="line"></span><br><span class="line">  handle()&#123;&#125;</span><br><span class="line">  setNextHandler(nextHandler)&#123;</span><br><span class="line">    <span class="keyword">this</span>.nextHandler = nextHandler;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span> <span class="keyword">extends</span> <span class="title">Handler</span></span>&#123;</span><br><span class="line">  clickHandlers = [];</span><br><span class="line"></span><br><span class="line">  handle(event)&#123;</span><br><span class="line">    <span class="keyword">switch</span>(event.type)&#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'onClick'</span>:</span><br><span class="line">        <span class="keyword">for</span> ( <span class="keyword">const</span> handler <span class="keyword">of</span> <span class="keyword">this</span>.clickHandlers )&#123;</span><br><span class="line">          handler();</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">if</span> ( <span class="keyword">this</span>.nextHandler ) <span class="keyword">this</span>.nextHandler.handle(event);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onClick(handler)&#123;</span><br><span class="line">    <span class="keyword">this</span>.clickHandlers.push(handler);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParentNode</span> <span class="keyword">extends</span> <span class="title">Node</span></span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChildNode</span> <span class="keyword">extends</span> <span class="title">Node</span></span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> parentNode = <span class="keyword">new</span> ParentNode();</span><br><span class="line"><span class="keyword">const</span> childNode = <span class="keyword">new</span> ChildNode();</span><br><span class="line">childNode.setNextHandler(parentNode);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mouseEvent = <span class="keyword">new</span> MouseEvent();</span><br><span class="line">childNode.handle(mouseEvent);</span><br></pre></td></tr></table></figure>
<p>通过上述代码示例，我们也可以猜想 JavaScript 语言中原型链的实现。</p>
<p>职责链模式具有如下特点：</p>
<ol>
<li>处理对象呈链式结构，因此，天然可以用来处理流程。在实现上，可以使用 setNextHandler 方法指定下一个处理对象，也可以使用一条已有的链，如父子结构形成的层级关系，或者队列形式（队列内若存储函数，当函数返回值为 false 时，表示不再将请求转交给下一个处理对象）。通常情况下，职责链模式表现为，根据请求的不同，再唤醒链上的某个处理对象加以操作，效果等同于策略模式。介于其链式处理的特征，职责链模式有一个变种，即请求经由前一个处理对象封装后，再交由下一个处理对象，这和浏览器的事件冒泡机制相仿（这样的链式操作，也可以通过函数队列或者迭代器模式实现）。</li>
<li>当链未明确指定时，可在链中灵活地添加处理对象、并指定下一个处理对象，跳过不必要的处理逻辑。</li>
<li>请求对象可以采用最简单的硬编码形式，也可以采用复杂的对象形式、或者使用特定的 Request 类加以构造，甚至使用转换函数从标识符中获取到传入处理对象的数据。这里要指出职责链模式的另一个变种，即可通过处理对象对请求进行特定包装后，再唤醒下一个处理对象。如第一点指出的，对于简单的请求对象，我们可以换用策略模式实现多样的处理机制；甚至对于复杂的请求对象，我们也可以制定规则转换引擎将其转换为简单的标识符形式，再通过策略模式加以处理。但是策略模式只能选中一种算法，且没有呈现出链式结构，因此策略模式不能像职责链模式那样不能用于控制流程，如审批流。</li>
<li>职责链模式可用于降低请求发送者和接受者的耦合度，处理对象也不需要知道链的结构。</li>
<li>过长的职责链影响程序的性能，同时也占用内存开销。在某些情况下，传入的请求会得不到处理，这时可以在链的尾端添加一个兜底函数处理请求。</li>
</ol>
<h2 id="js-中的职责链模式"><a href="#js-中的职责链模式" class="headerlink" title="js 中的职责链模式"></a>js 中的职责链模式</h2><p>在 js 中，可借助 AOP 切面实现职责链模式，在实现上呈现出函数式特征。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handler1</span>(<span class="params"></span>)</span>&#123; &#125;;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handler2</span>(<span class="params"></span>)</span>&#123; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Function</span>.property.after = <span class="function"><span class="params">nextHandler</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> ret = <span class="keyword">this</span>.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !!ret ) <span class="keyword">return</span> nextHandler.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">handler1.after(handler2);</span><br></pre></td></tr></table></figure>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><p>如前文所说，职责链模式可应用于呈现出父子结构的图形界面上，以实现事件处理或者其他图形效果。</p>
<p>职责链也可用于流程控制，如审批流等。</p>
<p>在已知的应用中，职责链模式见于 servelt 过滤器的实现，redux、koa 中间件的实现，koa-router 路由的实现。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>[设计模式:可复用面向对象软件的基础]<br>[Javascript 设计模式和开发实践 - 曾探]</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/13/jquery/动效分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/13/jquery/动效分析/" itemprop="url">jquery 动效分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-13T00:00:00+08:00">2018-06-13</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/jquery/" itemprop="url" rel="index"><span itemprop="name">jquery</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/06/13/jquery/动效分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/06/13/jquery/动效分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="动效基础"><a href="#动效基础" class="headerlink" title="动效基础"></a>动效基础</h2><p>在阅读 jquery/effects 模块源码之前，有必要先了解一下制作前端动效的一些基本知识，其内容包含动效实现的基本原理、缓动函数等。对于以上内容，笔者将在这一小节一一加以介绍。</p>
<h3 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h3><p>动效实现的基本原理如同逐帧制作动画，相隔时间较短的两帧动画可以促使人类视觉误以为那是连续的一个过程。术语刷新率 fps 指每秒更新多少帧画面。通常，每秒刷新 24 张画面最适宜于人类视觉，也就是单张画面的滞留时间为 25 毫秒。因此，制作小球动效等价于在时间轴上计算小球当前的运动位置这一数学命题，即算术表达式 x = fn(t)。</p>
<h3 id="缓动函数"><a href="#缓动函数" class="headerlink" title="缓动函数"></a>缓动函数</h3><p>常规的缓动函数表达式为 x = fn(t, b, c, d)，其中 x 为当前样式，t 为动画执行事件，b 为起始样式，c 为最终样式，d 为动画总时长。在已知 b, c, d 三个参数的情形下，缓动函数可以表述为 x = fn(t)，其斜率为速度，二次导数为加速度。</p>
<p>常见的缓动函数可以查看 <a href="https://esings.net/zh-cn" target="_blank" rel="noopener">缓动函数速查表</a>。缓动函数名中，后缀 In 表示加速，Out 表示减速，InOut 标识先加速、后减速；后缀 Sine 表示由三角函数实现，Quad 表示由二次方函数实现，Cubic 为三次方，Quart 为四次方，Quint 为五次方，Circ 为开平方根，Expo 为开立方根，Elastic 为结合三角函数和开立方根的初级弹簧效果，Back 为使用常数 1.70158 计算的回退效果，Bounce 为高级弹簧效果。linear 为线性函数。</p>
<img src="/2018/06/13/jquery/动效分析/easing.png">
<p>jquery.esing 类库列出了多种缓动函数集合，参数 p 为动画已执行时间占动画总时长的百分比，返回值当前移动距离占总移动距离的百分比。代码如下（包含 jquery 中提供的 linear, swing 函数）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> c1 = <span class="number">1.70158</span>;</span><br><span class="line"><span class="keyword">const</span> c2 = c1 * <span class="number">1.525</span>;</span><br><span class="line"><span class="keyword">const</span> c3 = c1 + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">const</span> c4 = ( <span class="number">2</span> * <span class="built_in">Math</span>.PI ) / <span class="number">3</span>;</span><br><span class="line"><span class="keyword">const</span> c5 = ( <span class="number">2</span> * <span class="built_in">Math</span>.PI ) / <span class="number">4.5</span>;</span><br><span class="line"></span><br><span class="line">$.esing = &#123;</span><br><span class="line">  linear(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">  &#125;,</span><br><span class="line">  swing(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0.5</span> - <span class="built_in">Math</span>.Math.cos( p * <span class="built_in">Math</span>.PI ) / <span class="number">2</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInQuad(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p * p;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeOutQuad(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> - ( <span class="number">1</span> - p ) * ( <span class="number">1</span> - p );</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInOutQuad(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p &lt; <span class="number">0.5</span> ? </span><br><span class="line">      <span class="number">2</span> * p * p : </span><br><span class="line">      <span class="number">1</span> - <span class="built_in">Math</span>.pow( <span class="number">-2</span> * p + <span class="number">2</span>, <span class="number">2</span> ) / <span class="number">2</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInCubic(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p * p * p;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeOutCubic(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> - <span class="built_in">Math</span>.pow( <span class="number">1</span> - p, <span class="number">3</span> );</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInOutCubic(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p &lt; <span class="number">0.5</span> ? </span><br><span class="line">      <span class="number">4</span> * p * p * p : </span><br><span class="line">      <span class="number">1</span> - <span class="built_in">Math</span>.pow( <span class="number">-2</span> * p + <span class="number">2</span>, <span class="number">3</span> ) / <span class="number">2</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInQuart(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p * p * p * p;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeOutQuart(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> - <span class="built_in">Math</span>.pow( <span class="number">1</span> - p, <span class="number">4</span> );</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInOutQuart(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p &lt; <span class="number">0.5</span> ?</span><br><span class="line">      <span class="number">8</span> * p * p * p * p :</span><br><span class="line">      <span class="number">1</span> - <span class="built_in">Math</span>.pow( <span class="number">-2</span> * p + <span class="number">2</span>, <span class="number">4</span> ) / <span class="number">2</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInQuint(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p * p * p * p * p;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeOutQuint(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> - <span class="built_in">Math</span>.pow( <span class="number">1</span> - p, <span class="number">5</span> );</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInOutQuint(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p &lt; <span class="number">0.5</span> ?</span><br><span class="line">      <span class="number">16</span> * p * p * p * p * p :</span><br><span class="line">      <span class="number">1</span> - <span class="built_in">Math</span>.pow( <span class="number">-2</span> * p + <span class="number">2</span>, <span class="number">5</span> ) / <span class="number">2</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInSine(p) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> - <span class="built_in">Math</span>.cos( p * <span class="built_in">Math</span>.PI/<span class="number">2</span> );</span><br><span class="line">  &#125;,</span><br><span class="line">  easeOutSine(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Math</span>.sin( p * <span class="built_in">Math</span>.PI/<span class="number">2</span> );</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInOutSine(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> -( <span class="built_in">Math</span>.cos( <span class="built_in">Math</span>.PI * p ) - <span class="number">1</span> ) / <span class="number">2</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInEppo(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p === <span class="number">0</span> ? <span class="number">0</span> : <span class="built_in">Math</span>.pow( <span class="number">2</span>, <span class="number">10</span> * p - <span class="number">10</span> );</span><br><span class="line">  &#125;,</span><br><span class="line">  easeOutEppo(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p === <span class="number">1</span> ? <span class="number">1</span> : <span class="number">1</span> - <span class="built_in">Math</span>.pow( <span class="number">2</span>, <span class="number">-10</span> * p );</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInOutEppo(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p === <span class="number">0</span> ? <span class="number">0</span> : p === <span class="number">1</span> ? <span class="number">1</span> : p &lt; <span class="number">0.5</span> ?</span><br><span class="line">      <span class="built_in">Math</span>.pow( <span class="number">2</span>, <span class="number">20</span> * p - <span class="number">10</span> ) / <span class="number">2</span> :</span><br><span class="line">      ( <span class="number">2</span> - <span class="built_in">Math</span>.pow( <span class="number">2</span>, <span class="number">-20</span> * p + <span class="number">10</span> ) ) / <span class="number">2</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInCirc(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> - <span class="built_in">Math</span>.sqrt( <span class="number">1</span> - <span class="built_in">Math</span>.pow( p, <span class="number">2</span> ) );</span><br><span class="line">  &#125;,</span><br><span class="line">  easeOutCirc(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Math</span>.sqrt( <span class="number">1</span> - <span class="built_in">Math</span>.pow( p - <span class="number">1</span>, <span class="number">2</span> ) );</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInOutCirc(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p &lt; <span class="number">0.5</span> ?</span><br><span class="line">      ( <span class="number">1</span> - <span class="built_in">Math</span>.sqrt( <span class="number">1</span> - <span class="built_in">Math</span>.pow( <span class="number">2</span> * p, <span class="number">2</span> ) ) ) / <span class="number">2</span> :</span><br><span class="line">      ( <span class="built_in">Math</span>.sqrt( <span class="number">1</span> - <span class="built_in">Math</span>.pow( <span class="number">-2</span> * p + <span class="number">2</span>, <span class="number">2</span> ) ) + <span class="number">1</span> ) / <span class="number">2</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInElastic(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p === <span class="number">0</span> ? <span class="number">0</span> : p === <span class="number">1</span> ? <span class="number">1</span> :</span><br><span class="line">      -<span class="built_in">Math</span>.pow( <span class="number">2</span>, <span class="number">10</span> * p - <span class="number">10</span> ) * <span class="built_in">Math</span>.sin( ( p * <span class="number">10</span> - <span class="number">10.75</span> ) * c4 );</span><br><span class="line">  &#125;,</span><br><span class="line">  easeOutElastic(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p === <span class="number">0</span> ? <span class="number">0</span> : p === <span class="number">1</span> ? <span class="number">1</span> :</span><br><span class="line">      <span class="built_in">Math</span>.pow( <span class="number">2</span>, <span class="number">-10</span> * p ) * <span class="built_in">Math</span>.sin( ( p * <span class="number">10</span> - <span class="number">0.75</span> ) * c4 ) + <span class="number">1</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInOutElastic(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p === <span class="number">0</span> ? <span class="number">0</span> : p === <span class="number">1</span> ? <span class="number">1</span> : p &lt; <span class="number">0.5</span> ?</span><br><span class="line">      -( <span class="built_in">Math</span>.pow( <span class="number">2</span>, <span class="number">20</span> * p - <span class="number">10</span> ) * <span class="built_in">Math</span>.sin( ( <span class="number">20</span> * p - <span class="number">11.125</span> ) * c5 )) / <span class="number">2</span> :</span><br><span class="line">      <span class="built_in">Math</span>.pow( <span class="number">2</span>, <span class="number">-20</span> * p + <span class="number">10</span> ) * <span class="built_in">Math</span>.sin( ( <span class="number">20</span> * p - <span class="number">11.125</span> ) * c5 ) / <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInBack(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> c3 * p * p * p - c1 * p * p;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeOutBack(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> + c3 * <span class="built_in">Math</span>.pow( p - <span class="number">1</span>, <span class="number">3</span> ) + c1 * <span class="built_in">Math</span>.pow( p - <span class="number">1</span>, <span class="number">2</span> );</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInOutBack(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p &lt; <span class="number">0.5</span> ?</span><br><span class="line">      ( <span class="built_in">Math</span>.pow( <span class="number">2</span> * p, <span class="number">2</span> ) * ( ( c2 + <span class="number">1</span> ) * <span class="number">2</span> * p - c2 ) ) / <span class="number">2</span> :</span><br><span class="line">      ( <span class="built_in">Math</span>.pow( <span class="number">2</span> * p - <span class="number">2</span>, <span class="number">2</span> ) *( ( c2 + <span class="number">1</span> ) * ( p * <span class="number">2</span> - <span class="number">2</span> ) + c2 ) + <span class="number">2</span> ) / <span class="number">2</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInBounce(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> - bounceOut( <span class="number">1</span> - p );</span><br><span class="line">  &#125;,</span><br><span class="line">  easeOutBounce(p) &#123;</span><br><span class="line">    <span class="keyword">var</span> n1 = <span class="number">7.5625</span>,</span><br><span class="line">      d1 = <span class="number">2.75</span>;</span><br><span class="line">    <span class="keyword">if</span> ( p &lt; <span class="number">1</span> / d1 ) &#123;</span><br><span class="line">      <span class="keyword">return</span> n1 * p * p;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( p &lt; <span class="number">2</span> / d1 ) &#123;</span><br><span class="line">      <span class="keyword">return</span> n1 * (p -= (<span class="number">1.5</span> / d1)) * p + <span class="number">0.75</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( p &lt; <span class="number">2.5</span> / d1 ) &#123;</span><br><span class="line">      <span class="keyword">return</span> n1 * (p -= (<span class="number">2.25</span> / d1)) * p + <span class="number">0.9375</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> n1 * (p-=(<span class="number">2.625</span>/d1))*p + <span class="number">0.984375</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInOutBounce(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p &lt; <span class="number">0.5</span> ?</span><br><span class="line">      ( <span class="number">1</span> - bounceOut( <span class="number">1</span> - <span class="number">2</span> * p ) ) / <span class="number">2</span> :</span><br><span class="line">      ( <span class="number">1</span> + bounceOut( <span class="number">2</span> * p - <span class="number">1</span> ) ) / <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>关于各式缓动函数的由来、及其与贝塞尔曲线的关系，笔者暂时没能力加以分析。</p>
<h3 id="requestAnimationFrame"><a href="#requestAnimationFrame" class="headerlink" title="requestAnimationFrame"></a>requestAnimationFrame</h3><p>有了缓动函数，就需要通过定时器运作动画脚本，间隔 25 毫秒刷新元素的显示样式。通常，我们会使用 setInterval 函数创建定时器，但在这种情况下，当页面上有多个动画脚本时，创建的多个定时器无疑会影响性能，就容易造成动画的执行延时。为了优化性能，我们可借助于创建队列的方式，把待执行的动画脚本添加到队列中，再使用单个定时器在 25 毫秒取出队列中的函数加以执行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> millisec = <span class="number">25</span>;</span><br><span class="line"><span class="keyword">const</span> queue = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line"><span class="keyword">const</span> uuid = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">animate</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  [...queue.values()].map(<span class="function"><span class="params">fn</span> =&gt;</span> &#123;</span><br><span class="line">    fn(<span class="keyword">new</span> <span class="built_in">Date</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.setInterval(animate, millisec);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> request = <span class="function"><span class="params">handler</span> =&gt;</span> &#123;</span><br><span class="line">  uuid++;</span><br><span class="line">  queue.set(uuid, handler);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> uuid;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> cancel = <span class="function"><span class="params">id</span> =&gt;</span> &#123;</span><br><span class="line">  queue.delete(id);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  request,</span><br><span class="line">  cancel</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>对于上述 js 代码，浏览器端提供的 requestAnimationFrame 接口也实现了相同的功能，由浏览器管控 dom 渲染的时机、事件队列等，刷新率为 60 帧左右，不能快进，也不能放慢，不适用于帧率要求较高的动画，如游戏等。requestAnimationFrame 函数的返回值为 ID，可用于终止动画；通过调用 cancelAnimationFrame 接口的方式。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAnimationFrame</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; </span><br><span class="line">    requestAnimationFrame, cancelAnimationFrame, </span><br><span class="line">    mozRequestAnimationFrame, mozCancelAnimationFrame, </span><br><span class="line">    webiketRequestAnimationFrame, webkitCancelAnimationFrame </span><br><span class="line">  &#125; = <span class="built_in">window</span>;</span><br><span class="line">  <span class="keyword">const</span> EmptyFunction = <span class="function"><span class="params">timestamp</span> =&gt;</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// IE10, Chrome24</span></span><br><span class="line">  <span class="keyword">if</span> ( requestAnimationFrame )&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      request: requestAnimationFrame,</span><br><span class="line">      cancel: cancelAnimationFrame</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// FireFox 11 以下没有实现 mozCancelAnimationFrame 接口</span></span><br><span class="line">  <span class="comment">// 且 mozRequestAnimationFrame 接口只用于触发 'MozBeforePaint' 事件</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( mozRequestAnimationFrame &amp;&amp; mozCancelAnimationFrame )&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      request: mozRequestAnimationFrame,</span><br><span class="line">      cancel: mozCancelAnimationFrame</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// webkit 某个版本没有返回 id，动画不能清除</span></span><br><span class="line">  <span class="comment">// webkit 某个版本没有给动画函数注入 time 参数</span></span><br><span class="line">  <span class="comment">// webkit 早期版本使用 webkitCancelRequestAnimationFrame 清除动画</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( webiketRequestAnimationFrame &amp;&amp; webiketRequestAnimationFrame(EmptyFunction) )&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      request: <span class="function"><span class="params">fn</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> webiketRequestAnimationFrame(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> fn(<span class="keyword">new</span> <span class="built_in">Date</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;,</span><br><span class="line">      cancel: webkitCancelAnimationFrame || webkitCancelRequestAnimationFrame</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h4><p>除了 setInterval, requestAnimationFrame 方法，还可以借助 setTimeout 函数（通过递归调用）、postMessage 异步方法（同 setImmediate 函数，在所有页面脚本执行完成后被调用，通过 addEventListener 方法监听 ‘message’ 事件）实现动画，IE10 还可以借助 setImmediate 方法。</p>
<p>通过自制脚本，可以侦测 setInterval, setTimeout, requestAnimationFrame, postMessage 诸方法在 1s 时间内的最小帧数，最大帧数以及平均帧数，并以图形化界面输出。关于这部分内容，可参考司徒正美的《Javascript 框架设计》一书第 381 页。笔者不作详谈。</p>
<p>关于 setImmediate 方法以及 node 端 process.nextTick 方法的实现原理，笔者将在后续的文章中加以分析。</p>
<h3 id="动画队列"><a href="#动画队列" class="headerlink" title="动画队列"></a>动画队列</h3><p>动画队列是指以联动方式组织同一个元素的动画流程，当前一个动画执行完成后，再执行下一个动画。</p>
<h2 id="jQuery-基础"><a href="#jQuery-基础" class="headerlink" title="jQuery 基础"></a>jQuery 基础</h2><p>这部分内容将介绍 jQuery/effects 动画模块所涉及的 jQuery 接口。关于这些接口的实现，读者可参详网上内容。当然，笔者也将在后续的文章加以详谈。</p>
<h3 id="Promise-对象"><a href="#Promise-对象" class="headerlink" title="Promise 对象"></a>Promise 对象</h3><p>$.deferred 方法用于创建 Promise 延迟对象。该Promise 对象中，promise 方法，可以为 Promise 对象添加额外的属性和方法；progress, done, fail, always 方法可用于挂载回调函数；notifyWith, resolveWith, rejectWith 方法用于触发回调函数的执行。</p>
<p>Promise 对象在动效模块中的表现就是在动画执行期间或动画执行完成后，触发特定回调函数的执行。</p>
<p>在 jQuery 动效源码中，我们也将看到嵌套使用 promise.done 方法（defaultPrefilter 函数中嵌套使用 anim.always 方法，以清除缓存中的 queue 属性），以确保某个回调函数必然最后执行。因为该回调函数在包裹它的回调执行期间，被添加回调队列中，也就是回调队列中的最后一项。</p>
<h3 id="css-操作"><a href="#css-操作" class="headerlink" title="css 操作"></a>css 操作</h3><p>$.css(prop, [val]) 方法用于获取或设置元素的显示样式。</p>
<p>$.cssHooks 集合形式，为指定 css 样式设置 $.css 方法的执行逻辑，如 $.cssHooks.borderRadius 是为对圆角进行处理，其值为 { get: (elem, computed, extra) =&gt; {}, set: (elem, value) =&gt; {}, expand: value =&gt; {} } 形式的对象。其中，get, set 方法影响 css 样式的取值、赋值操作，expand 方法对样式的值进行处理。</p>
<p>adjustCSS(elem, prop, valueParts, tween)，内部方法，转换并获得待设置的 css 样式值。参数 valueParts 为新设置的 css 属性，包含 +/- 符号、数值和单位，有两种设定形式，包含 +/- 号时，在原值上累加；不包含，取 valueParts 中的数值作为新的样式值。在第一种情形下，valueParts 中的单位若与获取到的样式值的原单位不符，需要将原样式值转换为新单位下的相应值。参数 tween 在动画情形中使用，其 cur 方法用于获取当前样式值，在 adjustCSS 方法执行过程中，其 unit, start, end 属性将相应得到修正。</p>
<p>showHide(elems, showFlag)，内部方法，用于显式或隐藏元素。</p>
<h3 id="data-缓存"><a href="#data-缓存" class="headerlink" title="data 缓存"></a>data 缓存</h3><p>jQuery 中创建的 Data 实例，是通过挂载在特定的节点上实现的，又分为两类，第一类通过 dataPriv 函数创建私有的 Data 实例，第二类通过 dataUser 函数创建外部使用的 Data 实例。data 实例又包含 cache(owner), get(owner, key), set(owner, key, value), access(owner, key, [value]), remove(owner, key), hasData(owner) 方法，其中，参数 owner 为挂载缓存数据的对象，通常为节点。</p>
<p>当全量取出 data 缓存数据时（在不设定 key 键的情况下），作为引用对象，修改其值，也将影响缓存数据。这一点在 jQuery 动效源码中 defaultPrefilter 处理 queue 队列时有使用。</p>
<h3 id="queue-队列"><a href="#queue-队列" class="headerlink" title="queue 队列"></a>queue 队列</h3><p>jQuery.queue(elem, type, data) 方法通过 dataPriv 数据缓存创建、添加或获取以 <code>${queueName}queue</code> 为主键的函数队列。</p>
<p>jQuery.dequeue(elem, type) 方法取出 <code>${queueName}queue</code> 函数队列中首个函数并执行。每个队列函数获得的参数为 elem, next, hooks，其中，next 借助于 jQuery.dequeue 方法执行第二个队列函数，hooks 为 <code>${queueName}queueHooks</code> 钩子函数集合。当 type 为默认的 ‘fx’ 时，在队列顶端插入 ‘inprogress’ 字符串，标记当前有队列函数在执行中，阻止 $.queue 方法运作过程取出首个队列函数并执行，而只能通过 $.dequeue 或 jQuery.dequeue 方法执行队列函数。不得不说，jQuery 中的多态性、各模块间的耦合度几至于芜杂，并不简单明朗，也许借助于类的方式可以写得更为晓畅明白。</p>
<p>jQuery._queueHooks(elem, type) 方法取出 <code>${queueName}queueHooks</code> 钩子函数集合，或其默认值。默认的钩子函数集合只包含 empty 方法，即如前所述，其用于从 dataPriv 缓存中移除 <code>${queueName}queue</code> 属性。</p>
<p>$.queue(queueName, [queue || callback]) 创建、添加或获取 <code>${queueName}queue</code> 函数队列。当添加队列函数时，其会调用 jQuery.dequeue 取出居于首位的队列函数并执行，若其取出的 <code>${queueName}queue</code> 首项不是 ‘inprogress’ 字符串。</p>
<p>$.dequeue(queueName) 方法从 <code>${queueName}queue</code> 函数队列中取出顶端的函数并执行，且下一个队列函数将作为参数 next 传入前一个队列函数中，queue 缓存数据则会即时移除该顶端函数；所有队列函数取出执行后，调用 <code>${queueName}queueHooks</code> 钩子函数集合中的 empty 方法，用于从 dataPriv 缓存中移除 <code>${queueName}queue</code> 属性。</p>
<p>$.clearQueue(queueName) 方法用于清空 <code>${queueName}queue</code> 函数队列。</p>
<p>queue 队列在动效模块中的表现就是组织动画队列。jQuery 的动画可分为两种情形，其一立即执行，多个动画也将并行执行，其二使用动画队列，挨个执行。jQuery 默认使用动画队列方式处理动效。</p>
<p>使用 $.queue 方法添加动画函数时，默认首个动画会立即执行。当再度调用 $.queue 方法添加第二个动画函数时，因为其从 queue 队列中取出的首项为 ‘inprogress’ 字符串（将阻止通过 $.queue 执行首个队列函数，而只能采用 jQuery.dequeue 方法予以执行），第二个动画函数在 $.queue 方法执行期间得不到执行。若在此时，第一个动画函数执行完成后的回调中使用 jQuery.dequeue 方法，则将触发第二个动画函数的执行。按上述实现，在动画执行结束后，因为有 ‘inprogress’ 字符串存储在队列中，无论调用 $.queue 还是 $.animate 方法添加队列函数，都将不能自动执行。这是 jQuery 队列中的诡异现象，需要调用 jQuery.dequeue 方法或者清除队列，才能使 $.queue, $.animate 方法添加的队列函数不再被阻塞。源码参见下文。</p>
<p>下文中，queue 队列指代本节中的 <code>${queueName}queue</code> 函数队列，queueHooks 钩子函数集合指代 <code>${queueName}queueHooks</code> 钩子函数集合，queueHooks.empty 指代钩子函数集合中的 empty 方法，dataPriv.queue 指代 dataPriv[<code>${queueName}queue</code>] 队列函数。</p>
<h2 id="动效模块设计"><a href="#动效模块设计" class="headerlink" title="动效模块设计"></a>动效模块设计</h2><p>jQuery 对动效模块的设计中，首先映入眼帘的是 Animation 函数，其基本骨架是以 deferred 模块组织异步逻辑。其中，tick 内含定时任务函数用于计算动画已执行时长百分比，并触发挂载在 promise 对象上的 progress, done, fail 回调函数的执行；animation 内部变量既包含基本的动画属性和方法，又兼有 promise 对象的属性和方法，随后通过该 animation 对象挂载 progress, done, fail 回调。</p>
<p>在 Animation 函数中，propFilter 函数用于转换 Animation 函数参数中的样式配置项及缓动配置项；Animation.prefilters 数组为动画执行前的一组预处理函数，既能影响应用于动画上的一些属性，又能通过 animation 的 progress, done, fail, always 方法影响异步回调。默认的 defaultPrefilter 函数用于清空 queue 队列，以及对显示隐藏动画作特殊处理。</p>
<p>tick 定时任务通过 jQuery.fx.timer 函数执行，其实现是添加到 jQuery.timers 动画队列中，由 schedule 调度函数通过 window.requestAnimationFrame 方法或 window.setTimeout 函数在一定时间内取出执行。所以，jQuery 中所有动画可理解为均借助于单个定时器实现。在 schedule 函数调度实现的基础上，jQuery 中所有动画可以通过 jQuery.fx.stop 函数终止动画的运作。</p>
<p>以上描述均不涉及 jQuery 动画中的样式变更凭何实现，那么 jQuery 动画中的样式变更到底是怎么实现的呢？原来在定时任务 tick 执行过程中，jQuery 会取出 animation.tweens 数组并执行数组项的 run 方法。tween 又是怎样一个概念呢？tween 针对单个 css 样式属性，通过当前样式值及动画已执行时长计算待调整的样式值，并对元素的样式做出调整。因此在 Animation 函数的实现中，程序首先将遍历待变更的 css 样式属性创建 tween；当 jQuery.fx.timer 函数触发 tick 定时任务函数执行时，在 tick 函数执行过程中，将遍历 tween 数组并执行其 run 方法，促使元素的样式得到更新。</p>
<p>以上内容，可以分为三个板块：</p>
<ol>
<li><p>以 jQuery.fx.timer 等函数为核心的定时任务调用机制。</p>
</li>
<li><p>Tween 实例的创建和执行。其执行过程中，将使用缓动函数更新节点样式。</p>
</li>
<li><p>基于 promise 实现的 Animation 函数，其将创建 tick 定时任务，添加 promise 回调，设置回调的执行时机。抛开这些，Animation 函数还将对参数作适当的转化处理，并执行 prefilter 预处理器。</p>
</li>
</ol>
<p>基于以上三点，就能实现单个元素的动画效果，但是没有涉及动画队列。虽然在 jQuery 中，对队列函数的控制主要在 queue 模块中，而 effects 动效模块与此交互的部分却落在接口层，如 $.animate, $.stop, $.finish 方法的实现中。这在实现部分将予以详述。</p>
<img src="/2018/06/13/jquery/动效分析/effects.png">
<h2 id="动效模块实现"><a href="#动效模块实现" class="headerlink" title="动效模块实现"></a>动效模块实现</h2><h3 id="jQuery-fx-timer-定时任务"><a href="#jQuery-fx-timer-定时任务" class="headerlink" title="jQuery.fx.timer 定时任务"></a>jQuery.fx.timer 定时任务</h3><p>当有定时任务 timer 函数，通过 jQuery.fx.timer 函数存入 jQuery.timers 定时任务队列中，再调用 jQuery.fx.start 函数，以启动定时任务调用程序。当用户反复调用 jQuery.fx.timer 函数时，为了避免定时任务调用程序多次执行，jQuery.fx.start 函数中带有 inProgress 标识。当定时任务调用程序已启动，inProgress 标识置为真值，实际的调度函数 schedule 将不再被重复调用。</p>
<p>通过 jQuery.fx.start 函数调用的调度函数 schedule 中，或者借助于 window.requestAnimationFrame 方法或者借助于 window.setTimeout 方法，以在间隔一定时间内递归调用 schedule 函数，从而触发 jQuery.fx.tick 函数的执行。</p>
<p>jQuery.fx.tick 函数中，程序将取出 jQuery.timers 队列中的所有定时任务并同步执行执行，若定时任务返回否值，则将其从 jQuery.timers 队列中移除。即当某个定时任务返回真值时，该定时任务将在一定时间间隔后再次被调用，直到其返回否值。</p>
<p>借助于 inProgress 标识为真值时，实际的调度函数 schedule 才会遍历 jQuery.timers 队列中的定时任务并予以执行，jQuery.fx.stop 方法通过将 inProgress 标识置为 null 的方式，可用于终止定时任务调用程序。而在 schedule 调度函数的执行逻辑中，当 jQuery.timers 队列已清空，也会通过调用 jQuery.fx.stop 方法，将 inProgress 标识置为 null。</p>
<p>在 jQuery 动画模块中，作为 timer 定时任务函数的是，Animation 函数体内创建的 tick 函数，其执行逻辑为在动画执行期间更新样式并触发 progress 回调，在动画完成后触发 done, fail 回调。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fxNow;</span><br><span class="line">jQuery.timers = [];</span><br><span class="line">jQuery.fx.interval = <span class="number">13</span>;</span><br><span class="line"></span><br><span class="line">jQuery.fx.timer = <span class="function"><span class="keyword">function</span>(<span class="params"> timer </span>) </span>&#123;</span><br><span class="line">	jQuery.timers.push( timer );</span><br><span class="line">	jQuery.fx.start();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">jQuery.fx.start = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ( inProgress ) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	inProgress = <span class="literal">true</span>;</span><br><span class="line">	schedule();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">schedule</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ( inProgress ) &#123;</span><br><span class="line">		<span class="keyword">if</span> ( <span class="built_in">document</span>.hidden === <span class="literal">false</span> &amp;&amp; <span class="built_in">window</span>.requestAnimationFrame ) &#123;</span><br><span class="line">			<span class="built_in">window</span>.requestAnimationFrame( schedule );</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="built_in">window</span>.setTimeout( schedule, jQuery.fx.interval );</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		jQuery.fx.tick();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jQuery.fx.tick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> timer,</span><br><span class="line">		i = <span class="number">0</span>,</span><br><span class="line">		timers = jQuery.timers;</span><br><span class="line"></span><br><span class="line">	fxNow = <span class="built_in">Date</span>.now();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> ( ; i &lt; timers.length; i++ ) &#123;</span><br><span class="line">		timer = timers[ i ];</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Run the timer and safely remove it when done (allowing for external removal)</span></span><br><span class="line">		<span class="keyword">if</span> ( !timer() &amp;&amp; timers[ i ] === timer ) &#123;</span><br><span class="line">			timers.splice( i--, <span class="number">1</span> );</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( !timers.length ) &#123;</span><br><span class="line">		jQuery.fx.stop();</span><br><span class="line">	&#125;</span><br><span class="line">	fxNow = <span class="literal">undefined</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">jQuery.fx.stop = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	inProgress = <span class="literal">null</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="Tween-样式更新"><a href="#Tween-样式更新" class="headerlink" title="Tween 样式更新"></a>Tween 样式更新</h3><h4 id="Tween-构造函数"><a href="#Tween-构造函数" class="headerlink" title="Tween 构造函数"></a>Tween 构造函数</h4><p>Tween 在实例化过程中，首先记录关联的节点 this.elem、待更新的样式属性 this.prop、缓动函数类型 this.easing、选项 this.options（包含动画执行时长 duration、步进函数 step = (currentStyle, tween) =&gt; {}。其中，步进函数执行时的上下文为节点元素，即 this.elem），随后计算起始样式值 this.start，并记录结束样式值 this.end、样式的单位 this.unit。</p>
<p>在 Tween 实例的 run 方法中，将更新节点的样式值。其实现的具体逻辑为，根据传参动 percent 画已执行时长百分比，通过缓动函数 eased = fn(percent, duration * percent, 0, 1, duration)，计算样式已变更值占所需变更值的百分比 eased，并存入 this.pos 属性中，由此获得新的样式值 this.now。（缓动函数见前文）</p>
<p>在 Tween 实例的执行逻辑中，jQuery 额外构建了一套节点样式取值、赋值机制，即通过 Tween.propHooks 样式处理集合进行操作。其所需面对的一种情形是，this.elem 不是节点元素，或者指定的样式属性 this.prop 不是节点所有的属性，来自于用户自定义。在这种情况下，Tween.propHooks 作为一种钩子处理集合，将截获样式的获取和赋值，由 elem 引用对象以 elem[this.prop] = this.now 的形式存储待更新的样式。同时针对 IE 9 及其以下浏览器，scrollTop 作为特殊的样式，其样式赋值操作将直接作用于 elem 元素，而不是 elem.style 样式集合中。</p>
<p>与此同时，若用户在 jQuery.fx.step 步进函数集合中注册了针对某一个样式的特殊行为，样式赋值操作将只唤醒该行为，而不会对节点 this.elem 进行处理。如需对 this.elem 节点的样式进行处理，仍需要由用户承担额外的开发工作。</p>
<p>关于选项中的步进函数 options.step，其可用于以日志形式记录待更新样式的值、或者在样式更新的某个值上作特殊处理。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Tween</span>(<span class="params"> elem, options, prop, end, easing </span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> Tween.prototype.init( elem, options, prop, end, easing );</span><br><span class="line">&#125;</span><br><span class="line">jQuery.Tween = Tween;</span><br><span class="line"></span><br><span class="line">Tween.prototype = &#123;</span><br><span class="line">	<span class="keyword">constructor</span>: Tween,</span><br><span class="line">	init: function( elem, options, prop, end, easing, unit ) &#123;</span><br><span class="line">		<span class="keyword">this</span>.elem = elem;</span><br><span class="line">		<span class="keyword">this</span>.prop = prop;</span><br><span class="line">		<span class="keyword">this</span>.easing = easing || jQuery.easing._default;</span><br><span class="line">		<span class="keyword">this</span>.options = options;</span><br><span class="line">		<span class="keyword">this</span>.start = <span class="keyword">this</span>.now = <span class="keyword">this</span>.cur();</span><br><span class="line">		<span class="keyword">this</span>.end = end;</span><br><span class="line">		<span class="keyword">this</span>.unit = unit || ( jQuery.cssNumber[ prop ] ? <span class="string">""</span> : <span class="string">"px"</span> );</span><br><span class="line">	&#125;,</span><br><span class="line">	cur: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">var</span> hooks = Tween.propHooks[ <span class="keyword">this</span>.prop ];</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> hooks &amp;&amp; hooks.get ?</span><br><span class="line">			hooks.get( <span class="keyword">this</span> ) :</span><br><span class="line">			Tween.propHooks._default.get( <span class="keyword">this</span> );</span><br><span class="line">	&#125;,</span><br><span class="line">	run: <span class="function"><span class="keyword">function</span>(<span class="params"> percent </span>) </span>&#123;</span><br><span class="line">		<span class="keyword">var</span> eased,</span><br><span class="line">			hooks = Tween.propHooks[ <span class="keyword">this</span>.prop ];</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( <span class="keyword">this</span>.options.duration ) &#123;</span><br><span class="line">			<span class="keyword">this</span>.pos = eased = jQuery.easing[ <span class="keyword">this</span>.easing ](</span><br><span class="line">				percent, <span class="keyword">this</span>.options.duration * percent, <span class="number">0</span>, <span class="number">1</span>, <span class="keyword">this</span>.options.duration</span><br><span class="line">			);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">this</span>.pos = eased = percent;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.now = ( <span class="keyword">this</span>.end - <span class="keyword">this</span>.start ) * eased + <span class="keyword">this</span>.start;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( <span class="keyword">this</span>.options.step ) &#123;</span><br><span class="line">			<span class="keyword">this</span>.options.step.call( <span class="keyword">this</span>.elem, <span class="keyword">this</span>.now, <span class="keyword">this</span> );</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( hooks &amp;&amp; hooks.set ) &#123;</span><br><span class="line">			hooks.set( <span class="keyword">this</span> );</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			Tween.propHooks._default.set( <span class="keyword">this</span> );</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Tween.prototype.init.prototype = Tween.prototype;</span><br><span class="line"></span><br><span class="line">Tween.propHooks = &#123;</span><br><span class="line">	_default: &#123;</span><br><span class="line">		get: <span class="function"><span class="keyword">function</span>(<span class="params"> tween </span>) </span>&#123;</span><br><span class="line">			<span class="keyword">var</span> result;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Use a property on the element directly when it is not a DOM element,</span></span><br><span class="line">			<span class="comment">// or when there is no matching style property that exists.</span></span><br><span class="line">			<span class="keyword">if</span> ( tween.elem.nodeType !== <span class="number">1</span> ||</span><br><span class="line">				tween.elem[ tween.prop ] != <span class="literal">null</span> &amp;&amp; tween.elem.style[ tween.prop ] == <span class="literal">null</span> ) &#123;</span><br><span class="line">				<span class="keyword">return</span> tween.elem[ tween.prop ];</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Passing an empty string as a 3rd parameter to .css will automatically</span></span><br><span class="line">			<span class="comment">// attempt a parseFloat and fallback to a string if the parse fails.</span></span><br><span class="line">			<span class="comment">// Simple values such as "10px" are parsed to Float;</span></span><br><span class="line">			<span class="comment">// complex values such as "rotate(1rad)" are returned as-is.</span></span><br><span class="line">			result = jQuery.css( tween.elem, tween.prop, <span class="string">""</span> );</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Empty strings, null, undefined and "auto" are converted to 0.</span></span><br><span class="line">			<span class="keyword">return</span> !result || result === <span class="string">"auto"</span> ? <span class="number">0</span> : result;</span><br><span class="line">		&#125;,</span><br><span class="line">		set: <span class="function"><span class="keyword">function</span>(<span class="params"> tween </span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Use step hook for back compat.</span></span><br><span class="line">			<span class="comment">// Use cssHook if its there.</span></span><br><span class="line">			<span class="comment">// Use .style if available and use plain properties where available.</span></span><br><span class="line">			<span class="keyword">if</span> ( jQuery.fx.step[ tween.prop ] ) &#123;</span><br><span class="line">				jQuery.fx.step[ tween.prop ]( tween );</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> ( tween.elem.nodeType === <span class="number">1</span> &amp;&amp;</span><br><span class="line">				( tween.elem.style[ jQuery.cssProps[ tween.prop ] ] != <span class="literal">null</span> ||</span><br><span class="line">					jQuery.cssHooks[ tween.prop ] ) ) &#123;</span><br><span class="line">				jQuery.style( tween.elem, tween.prop, tween.now + tween.unit );</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				tween.elem[ tween.prop ] = tween.now;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Support: IE &lt;=9 only</span></span><br><span class="line"><span class="comment">// Panic based approach to setting things on disconnected nodes</span></span><br><span class="line">Tween.propHooks.scrollTop = Tween.propHooks.scrollLeft = &#123;</span><br><span class="line">	set: <span class="function"><span class="keyword">function</span>(<span class="params"> tween </span>) </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> ( tween.elem.nodeType &amp;&amp; tween.elem.parentNode ) &#123;</span><br><span class="line">			tween.elem[ tween.prop ] = tween.now;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">jQuery.easing = &#123;</span><br><span class="line">	linear: <span class="function"><span class="keyword">function</span>(<span class="params"> p </span>) </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> p;</span><br><span class="line">	&#125;,</span><br><span class="line">	swing: <span class="function"><span class="keyword">function</span>(<span class="params"> p </span>) </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0.5</span> - <span class="built_in">Math</span>.cos( p * <span class="built_in">Math</span>.PI ) / <span class="number">2</span>;</span><br><span class="line">	&#125;,</span><br><span class="line">	_default: <span class="string">"swing"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Back compat &lt;1.8 extension point</span></span><br><span class="line">jQuery.fx.step = &#123;&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="创建-Tween-实例"><a href="#创建-Tween-实例" class="headerlink" title="创建 Tween 实例"></a>创建 Tween 实例</h4><p>不得不说，jQuery 有五花八门的拦截机制，部分是为了满足吊诡的开发需要，部分是为了便于对 jQuery 作一层封装。其实既不借助于事件系统，也不像 webpack 那样采用回调链的方式（适用于异步形式，可以拦截后续的流程），而是使用注册 hooks 集合，针对属性对原始行为作一些拓展。Tween 构造函数中如此，创建 Tween 实例也是如此。</p>
<p>在 Animation 函数中，jQuery 将针对每个待调整的样式属性创建各自的 Tween 实例，默认采用 animition.createTween 方法。这一过程由 Animation.tweeners[ “<em>“ ] 方法实现，当样式值带有 +, - 号时，adjustCSS 用于调整结束样式。除此之外，用户可以使用 Animation.tweener(callback) 方法改变 Animation.tweeners[ “</em>“ ] 方法的行为，或者使用 Animation.tweener(prop, callback) 方法创建自定义的 tween，用于变更样式值。</p>
<p>需要指明的一点是，只要调用 createTween 函数，就会将新创建的 tween 添加到 animation.tweens 数组中，动画执行期间，均会刷新样式。jQuery 源码中，创建 tween 的时机有两个，其一在 Animation 函数中根据待变更的样式创建 tween，其二在 defaultPrefilter 预处理器中针对 slideUp 等动效，用于处理元素的宽高属性更新。源码见下文。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createTween</span>(<span class="params"> value, prop, animation </span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> tween,</span><br><span class="line">		collection = ( Animation.tweeners[ prop ] || [] ).concat( Animation.tweeners[ <span class="string">"*"</span> ] ),</span><br><span class="line">		index = <span class="number">0</span>,</span><br><span class="line">		length = collection.length;</span><br><span class="line">	<span class="keyword">for</span> ( ; index &lt; length; index++ ) &#123;</span><br><span class="line">		<span class="keyword">if</span> ( ( tween = collection[ index ].call( animation, prop, value ) ) ) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// We're done with this property</span></span><br><span class="line">			<span class="keyword">return</span> tween;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Animation</span>(<span class="params"> elem, properties, options </span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> animation = deferred.promise( &#123;</span><br><span class="line">			tweens: [],</span><br><span class="line">			createTween: <span class="function"><span class="keyword">function</span>(<span class="params"> prop, end </span>) </span>&#123;</span><br><span class="line">				<span class="keyword">var</span> tween = jQuery.Tween( elem, animation.opts, prop, end,</span><br><span class="line">						animation.opts.specialEasing[ prop ] || animation.opts.easing );</span><br><span class="line">				animation.tweens.push( tween );</span><br><span class="line">				<span class="keyword">return</span> tween;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">		&#125; );</span><br><span class="line"></span><br><span class="line">  jQuery.map( props, createTween, animation );</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jQuery.Animation = jQuery.extend( Animation, &#123;</span><br><span class="line">	tweeners: &#123;</span><br><span class="line">		<span class="string">"*"</span>: [ <span class="function"><span class="keyword">function</span>(<span class="params"> prop, value </span>) </span>&#123;</span><br><span class="line">			<span class="keyword">var</span> tween = <span class="keyword">this</span>.createTween( prop, value );</span><br><span class="line">			adjustCSS( tween.elem, prop, rcssNum.exec( value ), tween );</span><br><span class="line">			<span class="keyword">return</span> tween;</span><br><span class="line">		&#125; ]</span><br><span class="line">	&#125;,</span><br><span class="line"></span><br><span class="line">	tweener: <span class="function"><span class="keyword">function</span>(<span class="params"> props, callback </span>) </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> ( isFunction( props ) ) &#123;</span><br><span class="line">			callback = props;</span><br><span class="line">			props = [ <span class="string">"*"</span> ];</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			props = props.match( rnothtmlwhite );</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> prop,</span><br><span class="line">			index = <span class="number">0</span>,</span><br><span class="line">			length = props.length;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> ( ; index &lt; length; index++ ) &#123;</span><br><span class="line">			prop = props[ index ];</span><br><span class="line">			Animation.tweeners[ prop ] = Animation.tweeners[ prop ] || [];</span><br><span class="line">			Animation.tweeners[ prop ].unshift( callback );</span><br><span class="line">		&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Animation-动画函数"><a href="#Animation-动画函数" class="headerlink" title="Animation 动画函数"></a>Animation 动画函数</h3><p>剥离 jQuery.fx.timer 定时任务执行机制和 Tween 样式变更机制后，Animation 函数的实现也极为简单。其主要逻辑为，借助 deferred 模块创建 promise 对象（其表现为 animation 对象），构建 tick 函数用于设置 promise 回调的执行时机以及调用 tween.run 方法更新样式，为 promise 对象设置回调函数。</p>
<p>在 animation 对象中，createTween 方法用于创建 tween，并存入 animation.tweens 数组中，动画执行期间，再取出数组项刷新元素样式。stop 方法通过将 stopped 置为 true，以终止动画，若其传参 gotoEnd 为真值，则逐个遍历 animation.tweens 数组，将动画执行到末端状态。stop 方法中触发回调的机制也由 gotoEnd 传参决定，若其为真，触发成功回调，反之，触发失败回调；回调参数带有 gotoEnd 标识。</p>
<p>除了设置 promise 回调相关内容、启动定时任务执行脚本外，Animation 函数还有一些预处理操作。其中，propFilter 对参数进行预处理；Animation.prefilters 对 queue 队列以及特殊样式进行预处理，其返回值中的 stop 方法将注册为 queueHooks 钩子函数集合的 stop 方法；选项 options.start 由用户对 animation 进行一些预处理操作。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Animation</span>(<span class="params"> elem, properties, options </span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> result,</span><br><span class="line">		stopped,</span><br><span class="line">		index = <span class="number">0</span>,</span><br><span class="line">		length = Animation.prefilters.length,</span><br><span class="line">		deferred = jQuery.Deferred().always( <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Don't match elem in the :animated selector</span></span><br><span class="line">			<span class="keyword">delete</span> tick.elem;</span><br><span class="line">		&#125; ),</span><br><span class="line">		tick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> ( stopped ) &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">var</span> currentTime = fxNow || createFxNow(),</span><br><span class="line">				remaining = <span class="built_in">Math</span>.max( <span class="number">0</span>, animation.startTime + animation.duration - currentTime ),</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Support: Android 2.3 only</span></span><br><span class="line">				<span class="comment">// Archaic crash bug won't allow us to use `1 - ( 0.5 || 0 )` (#12497)</span></span><br><span class="line">				temp = remaining / animation.duration || <span class="number">0</span>,</span><br><span class="line">				percent = <span class="number">1</span> - temp,</span><br><span class="line">				index = <span class="number">0</span>,</span><br><span class="line">				length = animation.tweens.length;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> ( ; index &lt; length; index++ ) &#123;</span><br><span class="line">				animation.tweens[ index ].run( percent );</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			deferred.notifyWith( elem, [ animation, percent, remaining ] );</span><br><span class="line"></span><br><span class="line">			<span class="comment">// If there's more to do, yield</span></span><br><span class="line">			<span class="keyword">if</span> ( percent &lt; <span class="number">1</span> &amp;&amp; length ) &#123;</span><br><span class="line">				<span class="keyword">return</span> remaining;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// If this was an empty animation, synthesize a final progress notification</span></span><br><span class="line">			<span class="keyword">if</span> ( !length ) &#123;</span><br><span class="line">				deferred.notifyWith( elem, [ animation, <span class="number">1</span>, <span class="number">0</span> ] );</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Resolve the animation and report its conclusion</span></span><br><span class="line">			deferred.resolveWith( elem, [ animation ] );</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;,</span><br><span class="line">		animation = deferred.promise( &#123;</span><br><span class="line">			elem: elem,</span><br><span class="line">			props: jQuery.extend( &#123;&#125;, properties ),</span><br><span class="line">			opts: jQuery.extend( <span class="literal">true</span>, &#123;</span><br><span class="line">				specialEasing: &#123;&#125;,</span><br><span class="line">				easing: jQuery.easing._default</span><br><span class="line">			&#125;, options ),</span><br><span class="line">			originalProperties: properties,</span><br><span class="line">			originalOptions: options,</span><br><span class="line">			startTime: fxNow || createFxNow(),</span><br><span class="line">			duration: options.duration,</span><br><span class="line">			tweens: [],</span><br><span class="line">			createTween: <span class="function"><span class="keyword">function</span>(<span class="params"> prop, end </span>) </span>&#123;</span><br><span class="line">				<span class="keyword">var</span> tween = jQuery.Tween( elem, animation.opts, prop, end,</span><br><span class="line">						animation.opts.specialEasing[ prop ] || animation.opts.easing );</span><br><span class="line">				animation.tweens.push( tween );</span><br><span class="line">				<span class="keyword">return</span> tween;</span><br><span class="line">			&#125;,</span><br><span class="line">			stop: <span class="function"><span class="keyword">function</span>(<span class="params"> gotoEnd </span>) </span>&#123;</span><br><span class="line">				<span class="keyword">var</span> index = <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">					<span class="comment">// If we are going to the end, we want to run all the tweens</span></span><br><span class="line">					<span class="comment">// otherwise we skip this part</span></span><br><span class="line">					length = gotoEnd ? animation.tweens.length : <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">if</span> ( stopped ) &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				stopped = <span class="literal">true</span>;</span><br><span class="line">				<span class="keyword">for</span> ( ; index &lt; length; index++ ) &#123;</span><br><span class="line">					animation.tweens[ index ].run( <span class="number">1</span> );</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Resolve when we played the last frame; otherwise, reject</span></span><br><span class="line">				<span class="keyword">if</span> ( gotoEnd ) &#123;</span><br><span class="line">					deferred.notifyWith( elem, [ animation, <span class="number">1</span>, <span class="number">0</span> ] );</span><br><span class="line">					deferred.resolveWith( elem, [ animation, gotoEnd ] );</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					deferred.rejectWith( elem, [ animation, gotoEnd ] );</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; ),</span><br><span class="line">		props = animation.props;</span><br><span class="line"></span><br><span class="line">	propFilter( props, animation.opts.specialEasing );</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> ( ; index &lt; length; index++ ) &#123;</span><br><span class="line">		result = Animation.prefilters[ index ].call( animation, elem, props, animation.opts );</span><br><span class="line">		<span class="keyword">if</span> ( result ) &#123;</span><br><span class="line">			<span class="keyword">if</span> ( isFunction( result.stop ) ) &#123;</span><br><span class="line">				jQuery._queueHooks( animation.elem, animation.opts.queue ).stop =</span><br><span class="line">					result.stop.bind( result );</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	jQuery.map( props, createTween, animation );</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( isFunction( animation.opts.start ) ) &#123;</span><br><span class="line">		animation.opts.start.call( elem, animation );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Attach callbacks from options</span></span><br><span class="line">	animation</span><br><span class="line">		.progress( animation.opts.progress )</span><br><span class="line">		.done( animation.opts.done, animation.opts.complete )</span><br><span class="line">		.fail( animation.opts.fail )</span><br><span class="line">		.always( animation.opts.always );</span><br><span class="line"></span><br><span class="line">	jQuery.fx.timer(</span><br><span class="line">		jQuery.extend( tick, &#123;</span><br><span class="line">			elem: elem,</span><br><span class="line">			anim: animation,</span><br><span class="line">			queue: animation.opts.queue</span><br><span class="line">		&#125; )</span><br><span class="line">	);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> animation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="propFilter"><a href="#propFilter" class="headerlink" title="propFilter"></a>propFilter</h4><p>propFilter 函数以引用对象形式对传参样式属性集合 props, 缓动函数类型集合 specialEasing 进行处理。首先，其将 props 属性转化为驼峰式书写形式，同时 props 属性的值支持以二元数组形式约定样式和缓动函数类型。其次，当传入的 props 属性作为复合属性、且在 jQuery.cssHooks 注册了预处理集合，且该集合中存在 expand 处理，传入的 props 属性的值将经过 expand 方法处理，由返回值定义该操作哪些样式。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">propFilter</span>(<span class="params"> props, specialEasing </span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> index, name, easing, value, hooks;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// camelCase, specialEasing and expand cssHook pass</span></span><br><span class="line">	<span class="keyword">for</span> ( index <span class="keyword">in</span> props ) &#123;</span><br><span class="line">		name = camelCase( index );</span><br><span class="line">		easing = specialEasing[ name ];</span><br><span class="line">		value = props[ index ];</span><br><span class="line">		<span class="keyword">if</span> ( <span class="built_in">Array</span>.isArray( value ) ) &#123;</span><br><span class="line">			easing = value[ <span class="number">1</span> ];</span><br><span class="line">			value = props[ index ] = value[ <span class="number">0</span> ];</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( index !== name ) &#123;</span><br><span class="line">			props[ name ] = value;</span><br><span class="line">			<span class="keyword">delete</span> props[ index ];</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		hooks = jQuery.cssHooks[ name ];</span><br><span class="line">		<span class="keyword">if</span> ( hooks &amp;&amp; <span class="string">"expand"</span> <span class="keyword">in</span> hooks ) &#123;</span><br><span class="line">			value = hooks.expand( value );</span><br><span class="line">			<span class="keyword">delete</span> props[ name ];</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Not quite $.extend, this won't overwrite existing keys.</span></span><br><span class="line">			<span class="comment">// Reusing 'index' because we have the correct "name"</span></span><br><span class="line">			<span class="keyword">for</span> ( index <span class="keyword">in</span> value ) &#123;</span><br><span class="line">				<span class="keyword">if</span> ( !( index <span class="keyword">in</span> props ) ) &#123;</span><br><span class="line">					props[ index ] = value[ index ];</span><br><span class="line">					specialEasing[ index ] = easing;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			specialEasing[ name ] = easing;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Animation-prefilters"><a href="#Animation-prefilters" class="headerlink" title="Animation.prefilters"></a>Animation.prefilters</h4><p>jQuery.Animation.prefilters 作为预处理函数队列，可通过 jQuery.Animation.prefilter 添加，默认只有一个预处理函数 defaultPrefilter。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">jQuery.Animation = jQuery.extend( Animation, &#123;</span><br><span class="line">	prefilters: [ defaultPrefilter ],</span><br><span class="line"></span><br><span class="line">	prefilter: <span class="function"><span class="keyword">function</span>(<span class="params"> callback, prepend </span>) </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> ( prepend ) &#123;</span><br><span class="line">			Animation.prefilters.unshift( callback );</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			Animation.prefilters.push( callback );</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; );</span><br></pre></td></tr></table></figure>
<p>defaultPrefilter 函数的处理内容有两块，其一针对即时执行的动画，当类型为 ‘fx’ 的 queue 队列的长度变为 0 时，也即队列等待执行的动画时，使用 queueHooks.empty 方法移除 dataPriv 中与当前 queue 相关的属性；其二针对 slideUp 等动效，不只元素的 display 属性需要在动画起始、结束时作特殊处理，元素的宽高等样式也需要通过计算获得。</p>
<p>对于内容一，有一点疑问，既然动画没有添加到 queue 队列中，为什么还要调用 queueHooks 钩子清除缓存中的数据呢？作为用于避免内存浪费的保证吗？</p>
<p>内容一的实现，在于缓存在元素上的 hooks.unqueued 标识，动画执行期间加 1，动画执行完成后减 1，由此可以判断所有动画是否均已执行完成。当 hooks.unqueued 标识重新变成 0 值时，且缓存中的 queue 队列长度也为 0，调用钩子集合中的 empty 方法，移除 dataPriv.queue 属性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defaultPrefilter</span>(<span class="params"> elem, props, opts </span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> hooks, oldfire,</span><br><span class="line">		isBox = <span class="string">"width"</span> <span class="keyword">in</span> props || <span class="string">"height"</span> <span class="keyword">in</span> props,</span><br><span class="line">		anim = <span class="keyword">this</span>,</span><br><span class="line">		orig = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Queue-skipping animations hijack the fx hooks</span></span><br><span class="line">	<span class="keyword">if</span> ( !opts.queue ) &#123;</span><br><span class="line">		hooks = jQuery._queueHooks( elem, <span class="string">"fx"</span> );</span><br><span class="line">		<span class="keyword">if</span> ( hooks.unqueued == <span class="literal">null</span> ) &#123;</span><br><span class="line">			hooks.unqueued = <span class="number">0</span>;</span><br><span class="line">			oldfire = hooks.empty.fire;</span><br><span class="line">			hooks.empty.fire = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">				<span class="keyword">if</span> ( !hooks.unqueued ) &#123;</span><br><span class="line">					oldfire();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;</span><br><span class="line">		hooks.unqueued++;</span><br><span class="line"></span><br><span class="line">		anim.always( <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Ensure the complete handler is called before this completes</span></span><br><span class="line">			anim.always( <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">				hooks.unqueued--;</span><br><span class="line">				<span class="keyword">if</span> ( !jQuery.queue( elem, <span class="string">"fx"</span> ).length ) &#123;</span><br><span class="line">					hooks.empty.fire();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; );</span><br><span class="line">		&#125; );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>内容二的处理逻辑为，在 slideUp 等动效执行期间，需要对元素的显示动效作处理，从隐藏到显示或者从显示到隐藏；当动效包含宽高属性的变动时，需要将 display 从 ‘none’ 或 ‘inline’ 转换成 ‘inline-block’，以使 slideUp 等动效发生过程中，宽高样式能在视图中正常显示；当动效包含 overflow 属性变更时（作为参数 opts 选项的属性，而不像其他样式变更那样在 props 参数中），在动效执行期间，将元素的 overslow 属性设置 ‘hidden’，在动效执行完成后，再切换为配置值。</p>
<p>内容二的实现，借助于 dataShow 缓存数据，该缓存用于记录动效起始状态，其包含 display, hidden 属性，也包含 slideUp 等动效相关的 height, marginTop, paddingTop, [width] 属性。</p>
<p>dataShow.display 属性取决于元素本身的 display 样式。情形一，若其为 ‘none’，则尝试先将该元素展示在视图上，然后取其 display 样式，并存入 dataShow.display 缓存中。在这种情况下，缓存 dataShow.display 的意义在于，动画执行期间将元素的 display 样式设定为缓存值（当元素显示的 display 样式为 ‘inline’ 或 ‘inline-block’，进入情形二中的处理逻辑），以使动画得以展示。情形二，若其为 ‘inline’ 或 ‘inline-block’，dataShow.display 属性直接取元素的 display 样式。在这种情形下，缓存 dataShow.display 的意义在于，首次动画执行期间将元素的 display 样式设为 ‘inline-block’，以使 width 属性能正常变更；且对于 slideUp 等滑动、渐隐类特效（在源码中的表现为，传入 Animation 的参数为 { marginLeft: ‘show’ } 等形式），等动画执行结束后，元素的 display 样式仍回设为 dataShow.display 缓存值；当首次动画执行期间、再启动第二个动画时，则跳过上述处理逻辑、沿用第一个动画将 display 样式置为 ‘inline-block’ 的做法。</p>
<p>以上处理存在两个疑点。其一，上文也有指出，当元素包含除 slideUp 等类型以外的动效时，动画执行结束后，元素的 display 属性将定格为 ‘inline-block’，而不是初始的 ‘inline’。这种做法是为了满足下一个动画改变元素宽度的需求吗？其二，当第一个动画类型为 slideUp 等，在该动画执行期间插入第二个动画，当第一个动画执行完成后，元素的 display 样式将可能被设为 ‘inline’，这是否会影响第二个动画的执行？这种处理方式仍取决于动画通常以队列方式添加，而不是即时执行吗（即两个动画并行执行的可能很小）？</p>
<p>内容二中，最后的处理逻辑是，使用 dataShow 缓存记录元素的初始 height, marginTop, paddingTop, [width] 等属性（这些数据经 createTween 函数处理后获得），并在动画执行前后使用 display 属性切换元素的显示状态，这样就不会影响元素原有的宽高属性。与此同时，程序将使用 createTween 函数在 animation.tweens 数组中添加 tween，该 tween 用于在动画执行期间刷新元素的 height, marginTop, paddingTop, [width] 等属性，从而实现动画效果。</p>
<p>上述处理逻辑的设计，基于接口层面需实现 $.slideUp 等方法。如果以类的方式构造动画模块，可以用继承类实现 slideUp 等动效，而不需要像 jQuery 那样在一体化处理逻辑掺杂 slideUp 等动效的实现。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> rfxtypes = <span class="regexp">/^(?:toggle|show|hide)$/</span>；</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defaultPrefilter</span>(<span class="params"> elem, props, opts </span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> prop, value, toggle, propTween, restoreDisplay, display,</span><br><span class="line">		isBox = <span class="string">"width"</span> <span class="keyword">in</span> props || <span class="string">"height"</span> <span class="keyword">in</span> props,</span><br><span class="line">		anim = <span class="keyword">this</span>,</span><br><span class="line">		orig = &#123;&#125;,</span><br><span class="line">		style = elem.style,</span><br><span class="line">		hidden = elem.nodeType &amp;&amp; isHiddenWithinTree( elem ),</span><br><span class="line">		dataShow = dataPriv.get( elem, <span class="string">"fxshow"</span> );</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Detect show/hide animations</span></span><br><span class="line">	<span class="keyword">for</span> ( prop <span class="keyword">in</span> props ) &#123;</span><br><span class="line">		value = props[ prop ];</span><br><span class="line">		<span class="keyword">if</span> ( rfxtypes.test( value ) ) &#123;</span><br><span class="line">			<span class="keyword">delete</span> props[ prop ];</span><br><span class="line">			toggle = toggle || value === <span class="string">"toggle"</span>;</span><br><span class="line">			<span class="keyword">if</span> ( value === ( hidden ? <span class="string">"hide"</span> : <span class="string">"show"</span> ) ) &#123;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Pretend to be hidden if this is a "show" and</span></span><br><span class="line">				<span class="comment">// there is still data from a stopped show/hide</span></span><br><span class="line">				<span class="keyword">if</span> ( value === <span class="string">"show"</span> &amp;&amp; dataShow &amp;&amp; dataShow[ prop ] !== <span class="literal">undefined</span> ) &#123;</span><br><span class="line">					hidden = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Ignore all other no-op show/hide data</span></span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			orig[ prop ] = dataShow &amp;&amp; dataShow[ prop ] || jQuery.style( elem, prop );</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Bail out if this is a no-op like .hide().hide()</span></span><br><span class="line">	propTween = !jQuery.isEmptyObject( props );</span><br><span class="line">	<span class="keyword">if</span> ( !propTween &amp;&amp; jQuery.isEmptyObject( orig ) ) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Restrict "overflow" and "display" styles during box animations</span></span><br><span class="line">	<span class="keyword">if</span> ( isBox &amp;&amp; elem.nodeType === <span class="number">1</span> ) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Support: IE &lt;=9 - 11, Edge 12 - 15</span></span><br><span class="line">		<span class="comment">// Record all 3 overflow attributes because IE does not infer the shorthand</span></span><br><span class="line">		<span class="comment">// from identically-valued overflowX and overflowY and Edge just mirrors</span></span><br><span class="line">		<span class="comment">// the overflowX value there.</span></span><br><span class="line">		opts.overflow = [ style.overflow, style.overflowX, style.overflowY ];</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Identify a display type, preferring old show/hide data over the CSS cascade</span></span><br><span class="line">		restoreDisplay = dataShow &amp;&amp; dataShow.display;</span><br><span class="line">		<span class="keyword">if</span> ( restoreDisplay == <span class="literal">null</span> ) &#123;</span><br><span class="line">			restoreDisplay = dataPriv.get( elem, <span class="string">"display"</span> );</span><br><span class="line">		&#125;</span><br><span class="line">		display = jQuery.css( elem, <span class="string">"display"</span> );</span><br><span class="line">		<span class="keyword">if</span> ( display === <span class="string">"none"</span> ) &#123;</span><br><span class="line">			<span class="keyword">if</span> ( restoreDisplay ) &#123;</span><br><span class="line">				display = restoreDisplay;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Get nonempty value(s) by temporarily forcing visibility</span></span><br><span class="line">				showHide( [ elem ], <span class="literal">true</span> );</span><br><span class="line">				restoreDisplay = elem.style.display || restoreDisplay;</span><br><span class="line">				display = jQuery.css( elem, <span class="string">"display"</span> );</span><br><span class="line">				showHide( [ elem ] );</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Animate inline elements as inline-block</span></span><br><span class="line">		<span class="keyword">if</span> ( display === <span class="string">"inline"</span> || display === <span class="string">"inline-block"</span> &amp;&amp; restoreDisplay != <span class="literal">null</span> ) &#123;</span><br><span class="line">			<span class="keyword">if</span> ( jQuery.css( elem, <span class="string">"float"</span> ) === <span class="string">"none"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Restore the original display value at the end of pure show/hide animations</span></span><br><span class="line">				<span class="keyword">if</span> ( !propTween ) &#123;</span><br><span class="line">					anim.done( <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">						style.display = restoreDisplay;</span><br><span class="line">					&#125; );</span><br><span class="line">					<span class="keyword">if</span> ( restoreDisplay == <span class="literal">null</span> ) &#123;</span><br><span class="line">						display = style.display;</span><br><span class="line">						restoreDisplay = display === <span class="string">"none"</span> ? <span class="string">""</span> : display;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				style.display = <span class="string">"inline-block"</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( opts.overflow ) &#123;</span><br><span class="line">		style.overflow = <span class="string">"hidden"</span>;</span><br><span class="line">		anim.always( <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">			style.overflow = opts.overflow[ <span class="number">0</span> ];</span><br><span class="line">			style.overflowX = opts.overflow[ <span class="number">1</span> ];</span><br><span class="line">			style.overflowY = opts.overflow[ <span class="number">2</span> ];</span><br><span class="line">		&#125; );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Implement show/hide animations</span></span><br><span class="line">	propTween = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">for</span> ( prop <span class="keyword">in</span> orig ) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// General show/hide setup for this element animation</span></span><br><span class="line">		<span class="keyword">if</span> ( !propTween ) &#123;</span><br><span class="line">			<span class="keyword">if</span> ( dataShow ) &#123;</span><br><span class="line">				<span class="keyword">if</span> ( <span class="string">"hidden"</span> <span class="keyword">in</span> dataShow ) &#123;</span><br><span class="line">					hidden = dataShow.hidden;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				dataShow = dataPriv.access( elem, <span class="string">"fxshow"</span>, &#123; <span class="attr">display</span>: restoreDisplay &#125; );</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Store hidden/visible for toggle so `.stop().toggle()` "reverses"</span></span><br><span class="line">			<span class="keyword">if</span> ( toggle ) &#123;</span><br><span class="line">				dataShow.hidden = !hidden;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Show elements before animating them</span></span><br><span class="line">			<span class="keyword">if</span> ( hidden ) &#123;</span><br><span class="line">				showHide( [ elem ], <span class="literal">true</span> );</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* eslint-disable no-loop-func */</span></span><br><span class="line"></span><br><span class="line">			anim.done( <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* eslint-enable no-loop-func */</span></span><br><span class="line"></span><br><span class="line">				<span class="comment">// The final step of a "hide" animation is actually hiding the element</span></span><br><span class="line">				<span class="keyword">if</span> ( !hidden ) &#123;</span><br><span class="line">					showHide( [ elem ] );</span><br><span class="line">				&#125;</span><br><span class="line">				dataPriv.remove( elem, <span class="string">"fxshow"</span> );</span><br><span class="line">				<span class="keyword">for</span> ( prop <span class="keyword">in</span> orig ) &#123;</span><br><span class="line">					jQuery.style( elem, prop, orig[ prop ] );</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; );</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Per-property setup</span></span><br><span class="line">		propTween = createTween( hidden ? dataShow[ prop ] : <span class="number">0</span>, prop, anim );</span><br><span class="line">		<span class="keyword">if</span> ( !( prop <span class="keyword">in</span> dataShow ) ) &#123;</span><br><span class="line">			dataShow[ prop ] = propTween.start;</span><br><span class="line">			<span class="keyword">if</span> ( hidden ) &#123;</span><br><span class="line">				propTween.end = propTween.start;</span><br><span class="line">				propTween.start = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="接口设计"><a href="#接口设计" class="headerlink" title="接口设计"></a>接口设计</h3><p>在动效接口部分，笔者将拆分为两类加以分析，其一是通用的动画接口，其二是 slideUp 等特殊动效。前者提供 $.animate, $.stop, $.finish 方法；后者基于前者的 animate 方法实现。</p>
<h4 id="通用动画接口"><a href="#通用动画接口" class="headerlink" title="通用动画接口"></a>通用动画接口</h4><p>$.animate 方法的处理逻辑为：</p>
<p>首先，使用 jQuery.speed 方法处理传参，且该方法将把 jQuery.dequeue 方法挂载到动画的回调函数中，以使前一个动画执行完成后，能取出 queue 队列中的下一个动画或普通函数并执行。特别的，当 jQuery.fx.off 开关置为真值时，样式变更将在下一个定时任务中即时得到完成。</p>
<p>其次，在 $.animate 方法中，如果传参 speed.queue 为 false，那么就以立即执行方式调用 Animation 函数；反之，以动画队列方式处理 Animation 函数。Animation 函数通过 doAnimation 函数封装，后续将指出为什么要用 doAnimation 函数进行封装。</p>
<p>$.stop 方法的处理逻辑为：</p>
<p>首先，视传参 clearQueue 是否为真值，清空 queue 队列函数。</p>
<p>其次，调用 queueHooks 钩子中的 stop 方法，并传入 gotoEnd 参数。该 stop 一则可以通过添加返回值带有 stop 方法的 prefilter 函数实现，一则可以调用 jQuery._queueHooks 注册。</p>
<p>其次，通过 queue 类型和 elem 属性，从 jQuery.timers 定时任务队列中取出待执行的 animation 对象，执行其 stop 方法，阻止元素样式更新或者将样式更新为最终状态（由  gotoEnd 入参决定）；并从 jQuery.timers 缓存中剔除当前元素的动画任务，基于 queue 类型判断，存储在同一个 queue 队列中的动画都将被移除。</p>
<p>最后，如果 gotoEnd 入参为否值，或者动画函数尚没有添加到 jQuery.timers 定时任务队列中（其情形为，动画函数在 queue 队列中等待执行。这种情形发生在调用 $.animate 方法在 queue 队列中创建 ‘inprogress’ 字符串的时候，等该动画执行完后，再使用 $.animate, $.queue 方法都将只把动画或普通函数添加到队列中，而不会自动执行，这部分可参见 jQuery 基础 - queue 队列一节），那么调用 jQuery.dequeue 方法，取出下一个动画函数并执行。如果 jQuery 对 stop 方法的设计采用如 requestAnimationFrame 的形式，即将 animation 对象输出给用户，由用户手动调用该 animation 的 stop 方法，就不会出现如上问题，而且对终止动画的操作也更具颗粒性。也许使用类的编码方式会更加合理。</p>
<p>$.finish 方法的处理逻辑为：</p>
<p>首先，从 queue 队列中取出 $.animate 方法创建的 doAnimation 函数，将 dataPriv.finish 缓存属性置为真。</p>
<p>其次，将 queue 队列置为空数组。</p>
<p>其次，调用 queueHooks.stop 钩子。</p>
<p>其次，根据 queue 类型和 elem 属性，遍历 jQuery.timers 定时任务队列，执行 animation.stop 方法，并从 jQuery.timers 队列中移除动画。</p>
<p>其次，执行 doAnimation.finish 方法，即 doAnimation 本身，这里仍是针对动画在队列中排队、得不到执行的情形。</p>
<p>最后，移除 dataPriv.finish 标识，意味着 doAnimation 函数中的 dataPriv.finish 只可能发生于 $.finish 方法执行期间。</p>
<p>由以上可以看出，jQuery 在顾全某些特殊情形时，各模块、各函数间的耦合度相当高，编码极不明朗，在程序设计上大有不可取的姿态。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> rrun = <span class="regexp">/queueHooks$/</span>;</span><br><span class="line"></span><br><span class="line">jQuery.speed = <span class="function"><span class="keyword">function</span>(<span class="params"> speed, easing, fn </span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> opt = speed &amp;&amp; <span class="keyword">typeof</span> speed === <span class="string">"object"</span> ? jQuery.extend( &#123;&#125;, speed ) : &#123;</span><br><span class="line">		complete: fn || !fn &amp;&amp; easing ||</span><br><span class="line">			isFunction( speed ) &amp;&amp; speed,</span><br><span class="line">		duration: speed,</span><br><span class="line">		easing: fn &amp;&amp; easing || easing &amp;&amp; !isFunction( easing ) &amp;&amp; easing</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Go to the end state if fx are off</span></span><br><span class="line">	<span class="keyword">if</span> ( jQuery.fx.off ) &#123;</span><br><span class="line">		opt.duration = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> ( <span class="keyword">typeof</span> opt.duration !== <span class="string">"number"</span> ) &#123;</span><br><span class="line">			<span class="keyword">if</span> ( opt.duration <span class="keyword">in</span> jQuery.fx.speeds ) &#123;</span><br><span class="line">				opt.duration = jQuery.fx.speeds[ opt.duration ];</span><br><span class="line"></span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				opt.duration = jQuery.fx.speeds._default;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Normalize opt.queue - true/undefined/null -&gt; "fx"</span></span><br><span class="line">	<span class="keyword">if</span> ( opt.queue == <span class="literal">null</span> || opt.queue === <span class="literal">true</span> ) &#123;</span><br><span class="line">		opt.queue = <span class="string">"fx"</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Queueing</span></span><br><span class="line">	opt.old = opt.complete;</span><br><span class="line"></span><br><span class="line">	opt.complete = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> ( isFunction( opt.old ) ) &#123;</span><br><span class="line">			opt.old.call( <span class="keyword">this</span> );</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( opt.queue ) &#123;</span><br><span class="line">			jQuery.dequeue( <span class="keyword">this</span>, opt.queue );</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> opt;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">jQuery.fn.extend( &#123;</span><br><span class="line">	animate: <span class="function"><span class="keyword">function</span>(<span class="params"> prop, speed, easing, callback </span>) </span>&#123;</span><br><span class="line">		<span class="keyword">var</span> empty = jQuery.isEmptyObject( prop ),</span><br><span class="line">			optall = jQuery.speed( speed, easing, callback ),</span><br><span class="line">			doAnimation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Operate on a copy of prop so per-property easing won't be lost</span></span><br><span class="line">				<span class="keyword">var</span> anim = Animation( <span class="keyword">this</span>, jQuery.extend( &#123;&#125;, prop ), optall );</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Empty animations, or finishing resolves immediately</span></span><br><span class="line">				<span class="keyword">if</span> ( empty || dataPriv.get( <span class="keyword">this</span>, <span class="string">"finish"</span> ) ) &#123;</span><br><span class="line">					anim.stop( <span class="literal">true</span> );</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;;</span><br><span class="line">			doAnimation.finish = doAnimation;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> empty || optall.queue === <span class="literal">false</span> ?</span><br><span class="line">			<span class="keyword">this</span>.each( doAnimation ) :</span><br><span class="line">			<span class="keyword">this</span>.queue( optall.queue, doAnimation );</span><br><span class="line">	&#125;,</span><br><span class="line">	stop: <span class="function"><span class="keyword">function</span>(<span class="params"> type, clearQueue, gotoEnd </span>) </span>&#123;</span><br><span class="line">		<span class="keyword">var</span> stopQueue = <span class="function"><span class="keyword">function</span>(<span class="params"> hooks </span>) </span>&#123;</span><br><span class="line">			<span class="keyword">var</span> stop = hooks.stop;</span><br><span class="line">			<span class="keyword">delete</span> hooks.stop;</span><br><span class="line">			stop( gotoEnd );</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( <span class="keyword">typeof</span> type !== <span class="string">"string"</span> ) &#123;</span><br><span class="line">			gotoEnd = clearQueue;</span><br><span class="line">			clearQueue = type;</span><br><span class="line">			type = <span class="literal">undefined</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ( clearQueue &amp;&amp; type !== <span class="literal">false</span> ) &#123;</span><br><span class="line">			<span class="keyword">this</span>.queue( type || <span class="string">"fx"</span>, [] );</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.each( <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">			<span class="keyword">var</span> dequeue = <span class="literal">true</span>,</span><br><span class="line">				index = type != <span class="literal">null</span> &amp;&amp; type + <span class="string">"queueHooks"</span>,</span><br><span class="line">				timers = jQuery.timers,</span><br><span class="line">				data = dataPriv.get( <span class="keyword">this</span> );</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> ( index ) &#123;</span><br><span class="line">				<span class="keyword">if</span> ( data[ index ] &amp;&amp; data[ index ].stop ) &#123;</span><br><span class="line">					stopQueue( data[ index ] );</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">for</span> ( index <span class="keyword">in</span> data ) &#123;</span><br><span class="line">					<span class="keyword">if</span> ( data[ index ] &amp;&amp; data[ index ].stop &amp;&amp; rrun.test( index ) ) &#123;</span><br><span class="line">						stopQueue( data[ index ] );</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> ( index = timers.length; index--; ) &#123;</span><br><span class="line">				<span class="keyword">if</span> ( timers[ index ].elem === <span class="keyword">this</span> &amp;&amp;</span><br><span class="line">					( type == <span class="literal">null</span> || timers[ index ].queue === type ) ) &#123;</span><br><span class="line"></span><br><span class="line">					timers[ index ].anim.stop( gotoEnd );</span><br><span class="line">					dequeue = <span class="literal">false</span>;</span><br><span class="line">					timers.splice( index, <span class="number">1</span> );</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Start the next in the queue if the last step wasn't forced.</span></span><br><span class="line">			<span class="comment">// Timers currently will call their complete callbacks, which</span></span><br><span class="line">			<span class="comment">// will dequeue but only if they were gotoEnd.</span></span><br><span class="line">			<span class="keyword">if</span> ( dequeue || !gotoEnd ) &#123;</span><br><span class="line">				jQuery.dequeue( <span class="keyword">this</span>, type );</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; );</span><br><span class="line">	&#125;,</span><br><span class="line">	finish: <span class="function"><span class="keyword">function</span>(<span class="params"> type </span>) </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> ( type !== <span class="literal">false</span> ) &#123;</span><br><span class="line">			type = type || <span class="string">"fx"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.each( <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">			<span class="keyword">var</span> index,</span><br><span class="line">				data = dataPriv.get( <span class="keyword">this</span> ),</span><br><span class="line">				queue = data[ type + <span class="string">"queue"</span> ],</span><br><span class="line">				hooks = data[ type + <span class="string">"queueHooks"</span> ],</span><br><span class="line">				timers = jQuery.timers,</span><br><span class="line">				length = queue ? queue.length : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Enable finishing flag on private data</span></span><br><span class="line">			data.finish = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Empty the queue first</span></span><br><span class="line">			jQuery.queue( <span class="keyword">this</span>, type, [] );</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> ( hooks &amp;&amp; hooks.stop ) &#123;</span><br><span class="line">				hooks.stop.call( <span class="keyword">this</span>, <span class="literal">true</span> );</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Look for any active animations, and finish them</span></span><br><span class="line">			<span class="keyword">for</span> ( index = timers.length; index--; ) &#123;</span><br><span class="line">				<span class="keyword">if</span> ( timers[ index ].elem === <span class="keyword">this</span> &amp;&amp; timers[ index ].queue === type ) &#123;</span><br><span class="line">					timers[ index ].anim.stop( <span class="literal">true</span> );</span><br><span class="line">					timers.splice( index, <span class="number">1</span> );</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Look for any animations in the old queue and finish them</span></span><br><span class="line">			<span class="keyword">for</span> ( index = <span class="number">0</span>; index &lt; length; index++ ) &#123;</span><br><span class="line">				<span class="keyword">if</span> ( queue[ index ] &amp;&amp; queue[ index ].finish ) &#123;</span><br><span class="line">					queue[ index ].finish.call( <span class="keyword">this</span> );</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Turn off finishing flag</span></span><br><span class="line">			<span class="keyword">delete</span> data.finish;</span><br><span class="line">		&#125; );</span><br><span class="line">	&#125;</span><br><span class="line">&#125; );</span><br></pre></td></tr></table></figure>
<h4 id="特殊动效"><a href="#特殊动效" class="headerlink" title="特殊动效"></a>特殊动效</h4><p>jQuery 中的特殊动效包含 toggle, show, hide, slideUp, slideDown, fadeIn, fadeOut, fadeToggle，主要为滑动及渐隐。</p>
<p>对于 toggle, show, hide，其处理逻辑为区分是即时的样式改变，还是动画。</p>
<p>对于其他样式，则需要通过 genFx 函数获取注入 Animation 函数的 props。如针对 $.slideUp 方法，genFx 函数的返回值为 { height: ‘show’, marginTop: ‘show’, paddingTop: ‘show’, marginBottom: ‘show’, paddingottom: ‘show’ }。前文已经提到，这样的数据作为参数 props 注入 Animation 函数时，将被 defaultProfilter 预处理器所拦截，并创建 tween 已更新元素的相关样式，构成滑动效果。余同</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Generate parameters to create a standard animation</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genFx</span>(<span class="params"> type, includeWidth </span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> which,</span><br><span class="line">		i = <span class="number">0</span>,</span><br><span class="line">		attrs = &#123; <span class="attr">height</span>: type &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If we include width, step value is 1 to do all cssExpand values,</span></span><br><span class="line">	<span class="comment">// otherwise step value is 2 to skip over Left and Right</span></span><br><span class="line">	includeWidth = includeWidth ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> ( ; i &lt; <span class="number">4</span>; i += <span class="number">2</span> - includeWidth ) &#123;</span><br><span class="line">		which = cssExpand[ i ];</span><br><span class="line">		attrs[ <span class="string">"margin"</span> + which ] = attrs[ <span class="string">"padding"</span> + which ] = type;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( includeWidth ) &#123;</span><br><span class="line">		attrs.opacity = attrs.width = type;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> attrs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jQuery.each( [ <span class="string">"toggle"</span>, <span class="string">"show"</span>, <span class="string">"hide"</span> ], <span class="function"><span class="keyword">function</span>(<span class="params"> i, name </span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> cssFn = jQuery.fn[ name ];</span><br><span class="line">	jQuery.fn[ name ] = <span class="function"><span class="keyword">function</span>(<span class="params"> speed, easing, callback </span>) </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> speed == <span class="literal">null</span> || <span class="keyword">typeof</span> speed === <span class="string">"boolean"</span> ?</span><br><span class="line">			cssFn.apply( <span class="keyword">this</span>, <span class="built_in">arguments</span> ) :</span><br><span class="line">			<span class="keyword">this</span>.animate( genFx( name, <span class="literal">true</span> ), speed, easing, callback );</span><br><span class="line">	&#125;;</span><br><span class="line">&#125; );</span><br><span class="line"></span><br><span class="line">jQuery.each( &#123;</span><br><span class="line">	slideDown: genFx( <span class="string">"show"</span> ),</span><br><span class="line">	slideUp: genFx( <span class="string">"hide"</span> ),</span><br><span class="line">	slideToggle: genFx( <span class="string">"toggle"</span> ),</span><br><span class="line">	fadeIn: &#123; <span class="attr">opacity</span>: <span class="string">"show"</span> &#125;,</span><br><span class="line">	fadeOut: &#123; <span class="attr">opacity</span>: <span class="string">"hide"</span> &#125;,</span><br><span class="line">	fadeToggle: &#123; <span class="attr">opacity</span>: <span class="string">"toggle"</span> &#125;</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params"> name, props </span>) </span>&#123;</span><br><span class="line">	jQuery.fn[ name ] = <span class="function"><span class="keyword">function</span>(<span class="params"> speed, easing, callback </span>) </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.animate( props, speed, easing, callback );</span><br><span class="line">	&#125;;</span><br><span class="line">&#125; );</span><br></pre></td></tr></table></figure>
<h2 id="感悟"><a href="#感悟" class="headerlink" title="感悟"></a>感悟</h2><p>这几天，我总想用一种形象化的比喻来描述自己管窥中的程序设计。有想过把它比作为流水线上的零部件加工，可使这样的形容不足以说明程序设计的复杂度。在源码阅读过程中，我发现，程序设计里对模块的使用并不像产业工人那样只是做简单的拼装。模块间的耦合度会因为设计的不合理、开发者能力的局限、问题的复杂度，而显出一定的复杂度。譬如，在 jQuery 中，queue 模块会内嵌许多针对动效的处理逻辑，基于类的形式构建程序处理的多样性会比在函数体内设置标识、或者通过传参判断，条理会更清晰明朗；在 webpack 中，module 的编译流程会散落在多个模块中，各个模块间的关联性并不是那么容易理清。程序设计并不像对汽车零部件的加工，走完这道工序，就是那一道工序。它更像从史记中理出某个历史事件，比如汉武帝听从大行王恢的建议在马邑对匈奴设伏，事件的枝节会散落在各个人物传记中；各方人物的心理也小挖掘；针对史料，又需要摸索作者的曲笔、晦言；当把事件置入历史长河、国内外局势中，则需要作一番更深远的考量。换回到工业层面，也许可以把程序设计思想为，模块就好比一台可以加工多种产品的设备，模块间的铰链就好比产品在多个设备中周转，程序设计像是创建一个工厂、一套工程，而不止于一个产品。</p>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><ol>
<li><p>参考 Java 中多线程 Thread 的设计，使用类的形式构建 Animation 模块。</p>
</li>
<li><p>是否能构建一个独立的流程控制器，用于在制作模块时，控制其执行流程，并对外提供钩子。</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/05/19/设计模式/策略模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/05/19/设计模式/策略模式/" itemprop="url">策略模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-05-19T00:00:00+08:00">2018-05-19</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/设计模式/" itemprop="url" rel="index"><span itemprop="name">设计模式</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/05/19/设计模式/策略模式/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/05/19/设计模式/策略模式/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>状态模式(Strategy pattern，也称为算法簇模式)的主要实现逻辑为，构建多个策略类用于封装不同的算法，并将这些算法的其中一个以引用形式注入给上下文对象，以使上下文对象可以将其行为委托给策略类处理。相较于<a href="http://xzfyu.com/2018/03/24/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F/" target="_blank" rel="noopener">状态模式</a>内部封装了状态切换，上下文对象的行为多数委托给状态对象加以处理，策略模式委托给策略类的处理通常只是单个行为，即算法，并且，设置策略（即替换算法）的过程由外部调用者完成。</p>
<p>《设计模式:可复用面向对象软件的基础》一书将状态模式描述为：</p>
<blockquote class="blockquote-center"><p>Define a family of algorithms, encapsulate each one, and make them interchangeable. Strategy lets the algorithm vary independently fromclients that use it.. </p>
</blockquote>
<h2 id="经典实现"><a href="#经典实现" class="headerlink" title="经典实现"></a>经典实现</h2><p>策略模式包含下列组件：</p>
<ul>
<li>Context: 以引用对象形式持有某个 ConcreteStrategy，对外暴露的交互接口通过将行为委托给 ConcreteStrategy 实现。</li>
<li>Strategy: 策略类，定义算法的抽象接口。</li>
<li>ConcreteStrategy: 具体策略子类，实现 Strategy 抽象类中定义的算法。</li>
</ul>
<p>以下代码使用策略模式实现了排序算法，通过 ArrayList 实例的 setSortStragery 方法即可切换排序算法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br></pre></td><td class="code"><pre><span class="line">abstract <span class="class"><span class="keyword">class</span> <span class="title">SortPolicy</span></span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(context)&#123;</span><br><span class="line">    <span class="keyword">this</span>.context = context;<span class="comment">// 通过引用属性访问 Context 实例，可访问实例属性，以处理状态切换操作；可改为传参实现</span></span><br><span class="line">  &#125;</span><br><span class="line">  sort()&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 冒泡排序，比较相邻元素，将最小值左移</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BubbleSort</span> <span class="keyword">extends</span> <span class="title">SortPolicy</span> </span>&#123;</span><br><span class="line">  sort()&#123;</span><br><span class="line">    <span class="keyword">const</span> arr = <span class="keyword">this</span>.context.target;</span><br><span class="line">    <span class="keyword">const</span> len = arr.length;</span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len; i++ )&#123;</span><br><span class="line">      <span class="keyword">for</span> ( <span class="keyword">let</span> j = <span class="number">0</span>; j &lt; len - <span class="number">1</span> - i; j++ )&#123;</span><br><span class="line">        <span class="keyword">if</span> ( arr[j] &gt; arr[j+<span class="number">1</span>] ) </span><br><span class="line">          <span class="keyword">this</span>.context.swap(j, j + <span class="number">1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 选择排序，选取最小值，排在左侧</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SelectionSort</span> <span class="keyword">extends</span> <span class="title">SortPolicy</span> </span>&#123;</span><br><span class="line">  sort()&#123;</span><br><span class="line">    <span class="keyword">const</span> arr = <span class="keyword">this</span>.context.target;</span><br><span class="line">    <span class="keyword">const</span> len = arr.length;</span><br><span class="line">    <span class="keyword">let</span> minIndex;<span class="comment">// 最小值序号</span></span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">let</span> i = <span class="number">0</span>; i &lt; len - <span class="number">1</span>; i++ )&#123;</span><br><span class="line">      minIndex = i;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> ( <span class="keyword">let</span> j = i; j &lt; len; j++ )&#123;</span><br><span class="line">        <span class="keyword">if</span> ( arr[minIndex] &gt; arr[j] ) </span><br><span class="line">          minIndex = j;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ( i !== minIndex )</span><br><span class="line">        <span class="keyword">this</span>.context.swap(i, minIndex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 插入排序，将后一位比较项顺序插入到之前已排序的数组中</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">InsertionSort</span> <span class="keyword">extends</span> <span class="title">SortPolicy</span> </span>&#123;</span><br><span class="line">  sort()&#123;</span><br><span class="line">    <span class="keyword">const</span> arr = <span class="keyword">this</span>.context.target;</span><br><span class="line">    <span class="keyword">const</span> len = arr.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">let</span> i = <span class="number">1</span>; i &lt; length; i++ )&#123;</span><br><span class="line">      <span class="keyword">let</span> j = i;</span><br><span class="line">      <span class="keyword">let</span> temp = arr[i];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">while</span> ( j &gt; <span class="number">0</span> &amp;&amp; arr[j - <span class="number">1</span>] &gt; temp )&#123;</span><br><span class="line">        arr[j] = arr[j - <span class="number">1</span>];</span><br><span class="line">        j--;</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      arr[j] = temp;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 归并排序，将数组项拆分后分别排序，再合并排序</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MergeSort</span> <span class="keyword">extends</span> <span class="title">SortPolicy</span> </span>&#123;</span><br><span class="line">  sort()&#123;</span><br><span class="line">    <span class="keyword">const</span> arr = <span class="keyword">this</span>.context.target;</span><br><span class="line">    <span class="keyword">this</span>.mergeSortRec(arr);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 分治</span></span><br><span class="line">  mergeSortRec(arr)&#123;</span><br><span class="line">    <span class="keyword">const</span> len = arr.length;</span><br><span class="line">    <span class="keyword">if</span> ( len === <span class="number">1</span> ) <span class="keyword">return</span> arr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> mid = <span class="built_in">Math</span>.floor(len / <span class="number">2</span>);</span><br><span class="line">    <span class="keyword">let</span> left = arr.slice(<span class="number">0</span>, mid);</span><br><span class="line">    <span class="keyword">let</span> right = arr.slice(mid, len);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.merge(<span class="keyword">this</span>.mergeSortRec(left), <span class="keyword">this</span>.mergeSortRec(right));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 合并两个已排序数组</span></span><br><span class="line">  merge(left, right)&#123;</span><br><span class="line">    <span class="keyword">const</span> leftLen = left.length;</span><br><span class="line">    <span class="keyword">const</span> rightLen = right.length;</span><br><span class="line">    <span class="keyword">let</span> leftIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> rightIndex = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> result = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ( leftIndex &lt; leftLen &amp;&amp; rightIndex &lt; rightLen )&#123;</span><br><span class="line">      <span class="keyword">if</span> ( left[leftIndex] &lt; right[rightIndex] )</span><br><span class="line">        result.push(left[leftIndex++]);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        result.push(right[rightIndex++]);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ( leftIndex &lt; leftLen )&#123;</span><br><span class="line">      result.push(left[leftIndex++]);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ( rightIndex &lt; rightLen )&#123;</span><br><span class="line">      result.push(right[rightIndex++]);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 快速排序，选取中间项，将左右两边元素按和中间相的比较结果对调，递归该过程，实现数组排序</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">QuickSort</span> <span class="keyword">extends</span> <span class="title">SortPolicy</span> </span>&#123;</span><br><span class="line">  sort()&#123;</span><br><span class="line">    <span class="keyword">const</span> arr = <span class="keyword">this</span>.context.target;</span><br><span class="line">    <span class="keyword">const</span> len = arr.length;</span><br><span class="line">    <span class="keyword">this</span>.quick(arr, <span class="number">0</span>, len);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 递归，实现分治</span></span><br><span class="line">  quick(arr, left, right)&#123;</span><br><span class="line">    <span class="keyword">const</span> len = arr.length;</span><br><span class="line">    <span class="keyword">let</span> index;</span><br><span class="line">    <span class="keyword">if</span> ( len &gt; <span class="number">1</span> )&#123;</span><br><span class="line">      index = <span class="keyword">this</span>.partition(arr, left, right);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ( left &lt; index <span class="number">-1</span> )</span><br><span class="line">        <span class="keyword">this</span>.quick(arr, left, index - <span class="number">1</span>);</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> ( index &lt; right )</span><br><span class="line">        <span class="keyword">this</span>.quick(arr, index, right);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// 按中间项对调元素，大值放在右边，小值放在左边</span></span><br><span class="line">  partition(arr, left, right)&#123;</span><br><span class="line">    <span class="keyword">let</span> pivot = arr[<span class="built_in">Math</span>.floor((right + left) / <span class="number">2</span>)];</span><br><span class="line">    <span class="keyword">let</span> i = left;</span><br><span class="line">    <span class="keyword">let</span> j = right;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ( i &lt;= j )&#123;</span><br><span class="line">      <span class="keyword">while</span> ( arr[i] &lt; pivot )&#123;</span><br><span class="line">        i++;</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">while</span> ( arr[j] &gt; pivot )&#123;</span><br><span class="line">        j--;</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ( i &lt;= j )&#123;</span><br><span class="line">        <span class="keyword">this</span>.context.swap(arr, i, j);</span><br><span class="line">        i++;</span><br><span class="line">        j--;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> i;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 堆排序</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HeapSort</span> <span class="keyword">extends</span> <span class="title">SortPolicy</span> </span>&#123;</span><br><span class="line">  sort()&#123;</span><br><span class="line">    <span class="keyword">const</span> arr = <span class="keyword">this</span>.context.target;</span><br><span class="line">    <span class="keyword">let</span> heapSize = arr.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.buildHeap(arr);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> ( heapSize &gt; <span class="number">1</span> )&#123;</span><br><span class="line">      heapSize--;</span><br><span class="line">      <span class="keyword">this</span>.context.swap(arr, <span class="number">0</span>, heapSize);</span><br><span class="line">      <span class="keyword">this</span>.heapify(arr, heapSize, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  buildHeap(arr)&#123;</span><br><span class="line">    <span class="keyword">const</span> heapSize = arr.length;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> ( <span class="keyword">let</span> i = <span class="built_in">Math</span>.floor(heapSize / <span class="number">2</span>); i &gt;= <span class="number">0</span>; i-- )&#123;</span><br><span class="line">      <span class="keyword">this</span>.heapify(arr, heapSize, i);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  heapify(arr, heapSize, i)&#123;</span><br><span class="line">    <span class="keyword">let</span> left = <span class="number">2</span> * i + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">let</span> right = <span class="number">2</span> * i + <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">let</span> largest = i;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( left &lt; heapSize &amp;&amp; arr[left] &gt; arr[largest] )</span><br><span class="line">      largest = left;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( right &lt; heapSize &amp;&amp; arr[right] &gt; arr[largest] )</span><br><span class="line">      largest = right;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( largest !== i )&#123;</span><br><span class="line">      <span class="keyword">this</span>.context.swap(arr, i, largest);</span><br><span class="line">      <span class="keyword">this</span>.heapify(arr, heapSize, largest);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ArrayList</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>()&#123;</span><br><span class="line">    <span class="keyword">this</span>.target = [];</span><br><span class="line">    <span class="keyword">this</span>.sortStragery = <span class="keyword">new</span> BubbleSort(<span class="keyword">this</span>);<span class="comment">// 排序策略</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  insert(item)&#123;</span><br><span class="line">    <span class="keyword">this</span>.target.push(item);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 元素互换</span></span><br><span class="line">  swap(i, j)&#123;</span><br><span class="line">    <span class="keyword">let</span> arr = <span class="keyword">this</span>.target;</span><br><span class="line">    <span class="keyword">let</span> temp = arr[i];</span><br><span class="line">    arr[i] = arr[j];</span><br><span class="line">    arr[j] = temp;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setSortStragery(Stragery)&#123;</span><br><span class="line">    <span class="keyword">this</span>.sortStragery = <span class="keyword">new</span> Stragery(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  sort()&#123;</span><br><span class="line">    <span class="keyword">this</span>.sortStragery.sort();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  toString()&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.target.join();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>策略模式需要注意的点：</p>
<ol>
<li>调用者需要对策略模式提供的算法足够了解。</li>
<li>Context 类既可以通过调用时向 ConcreteStrategy 具体策略子类注入参数实现，也可以将自身作为引用存储在 ConcreteStrategy 具体策略子类中。同时 ConcreteStrategy 具体策略子类可以从 Strategy 抽象接口继承属性，其自身也可以实现为有状态值的。</li>
<li>Context 类可设置多个，以针对不同的需求，如不同的设备。</li>
</ol>
<h2 id="js-中的策略模式"><a href="#js-中的策略模式" class="headerlink" title="js 中的策略模式"></a>js 中的策略模式</h2><p>同<a href="http://xzfyu.com/2018/03/24/%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/%E7%8A%B6%E6%80%81%E6%A8%A1%E5%BC%8F/" target="_blank" rel="noopener">状态模式</a>，js 可以使用对象字面量声明多个策略子类，通过访问对象属性的方式调用算法。</p>
<h3 id="动效算法切换"><a href="#动效算法切换" class="headerlink" title="动效算法切换"></a>动效算法切换</h3><p>本节以前端动效为例，试图说明策略模式在该领域中的应用。读者若想对前端动效有更深入的理解，可参见笔者的另一篇文章，<a href="http://xzfyu.com/2018/05/20/jquery/%E5%8A%A8%E6%95%88%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">jquery 动效分析</a>。</p>
<p>动效实现的基本数学思想是通过动画执行时长 duration、起始位置 beginning val、结束位置(即要变化的总量) change 计算动画已执行时间 timestamp 的所处位置 pos，即函数 pos = fn(t, b, c, d)。在动效中，位置这个概念会被起始样式和结束样式所替换。策略模式的用武之地即在于设定不同的缓动函数，以计算当前样式值。</p>
<p>在表达式 pos = fn(t, b, c, d) 中，参数 t 动画已执行时间, b 起始样式 由程序计算获得，参数 c 结束样式, d 动画总时长 由调用方提供。为扼要说明起见，示例代码将不提供计算样式和设置样式值的 getStyles, setStyles 方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> Easings = &#123;</span><br><span class="line">  linear(t, b, c, d)&#123;</span><br><span class="line">    <span class="keyword">return</span> c * t / d + b;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeIn(t, b, c, d)&#123;</span><br><span class="line">    <span class="keyword">return</span> c * (t / d) * t + b;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeOut(t, b, c, d)&#123;</span><br><span class="line">    <span class="keyword">return</span> -c * (t / d) * (t - <span class="number">2</span>) + b;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInOut(t, b, c, d)&#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="number">2</span>t / d &lt; <span class="number">1</span> ) <span class="keyword">return</span> c / <span class="number">2</span> * t * t + b;</span><br><span class="line">    <span class="keyword">return</span> - c / <span class="number">2</span> * ((--t) * (t - <span class="number">2</span>) - <span class="number">1</span>) + b;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animation</span> </span>&#123;</span><br><span class="line">  node = <span class="literal">null</span>;</span><br><span class="line">  startTime = <span class="number">0</span>;</span><br><span class="line">  startStyles = <span class="literal">null</span>;</span><br><span class="line">  endStyles = <span class="literal">null</span>;</span><br><span class="line">  duration = <span class="literal">null</span>;</span><br><span class="line">  easing = <span class="literal">null</span>;</span><br><span class="line">  running = <span class="literal">false</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">constructor</span>(node, styles, duration, easing)&#123;</span><br><span class="line">    <span class="keyword">this</span>.node = node;</span><br><span class="line">    <span class="keyword">this</span>.startTime = +<span class="keyword">new</span> <span class="built_in">Date</span>;</span><br><span class="line">    <span class="keyword">this</span>.startStyles = getStyles(node);</span><br><span class="line">    <span class="keyword">this</span>.endStyles = styles;</span><br><span class="line">    <span class="keyword">this</span>.duration = duration;</span><br><span class="line">    <span class="keyword">this</span>.easing = Easings[easing];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.run();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  run()&#123;</span><br><span class="line">    <span class="keyword">const</span> that = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">this</span>.running = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">let</span> timer = setInterval(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      that.tween();</span><br><span class="line">      <span class="keyword">if</span> ( !running ) clearInterval(timer);</span><br><span class="line">    &#125;, <span class="number">10</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  tween()&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; node, startTime, startStyles, endStyles, duration, easing &#125; = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">const</span> currentTime = +<span class="keyword">new</span> <span class="built_in">Date</span>;</span><br><span class="line">    <span class="keyword">const</span> t = currentTime - startTime;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( t &gt;= <span class="keyword">this</span>.duration )&#123;</span><br><span class="line">      setStyles(node, endStyles);</span><br><span class="line">      <span class="keyword">this</span>.running = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> currentStyles = &#123;&#125;;</span><br><span class="line">    <span class="built_in">Object</span>.keys(endStyles).map(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> startStyle = startStyles[key];</span><br><span class="line">      <span class="keyword">let</span> endStyle = endStyles[key];</span><br><span class="line"></span><br><span class="line">      currentStyles[key] = easing(t, startStyle, endStyle, duration);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    setStyles(<span class="keyword">this</span>.node, currentStyles);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>上述代码中，由调用方提供缓动函数算法名，animation 实例将根据将通过指定的缓动函数计算节点的当前样式，并作相应更新。关于前端动效（包含缓动函数，动画队列等）的细微说明，笔者将在后续的文章加以展开。</p>
<h3 id="校验算法切换"><a href="#校验算法切换" class="headerlink" title="校验算法切换"></a>校验算法切换</h3><p>策略模式也可以应用于数据校验中，即通过对某个字段设定校验规则，通过该规则从校验函数集合中选取函数，并对相应的数据做出校验。若需深入理解数据校验过程，可参看笔者的另一篇文章 <a href="http://xzfyu.com/2018/01/24/%E6%B5%85%E6%9E%90async-validator%E6%BA%90%E7%A0%81/" target="_blank" rel="noopener">浅析async-validator源码</a>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> stratrgies = &#123;</span><br><span class="line">  notEmpty(value, rule)&#123;</span><br><span class="line">    <span class="keyword">if</span> ( value === <span class="string">''</span> ) <span class="keyword">return</span> rule.msg;</span><br><span class="line">  &#125;,</span><br><span class="line">  minLength(value, rule)&#123;</span><br><span class="line">    <span class="keyword">if</span> ( value.length &lt; rule.length ) <span class="keyword">return</span> rule.msg;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Validator</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.rules = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(rules)&#123;</span><br><span class="line">    <span class="keyword">this</span>.rules = rules;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  validate(data)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; rules &#125; = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">let</span> errors = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Object</span>.keys(data).map(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> rule = rules[key];</span><br><span class="line">      <span class="keyword">const</span> value = data[key];</span><br><span class="line">      <span class="keyword">const</span> validateMethod = stratrgies[rule.type];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> msg = validateMethod(value, rule);</span><br><span class="line">      <span class="keyword">if</span> ( msg )&#123;</span><br><span class="line">        <span class="keyword">if</span> ( !errors ) errors = &#123;&#125;;</span><br><span class="line">        errors[key] = msg;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> errors;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>[设计模式:可复用面向对象软件的基础]<br>[Javascript 设计模式和开发实践 - 曾探]</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/24/设计模式/状态模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/24/设计模式/状态模式/" itemprop="url">状态模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-24T00:00:00+08:00">2018-03-24</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/设计模式/" itemprop="url" rel="index"><span itemprop="name">设计模式</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/24/设计模式/状态模式/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/03/24/设计模式/状态模式/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>状态模式(State pattern) 的主要处理逻辑为，构建多个状态对象(state object)以维护特定状态下的行为集，和一个上下文对象(context)以引用形式维护与当前状态对应的状态对象，并将与状态相关的行为委托给这个状态对象加以处理；当状态更新时，上下文对象将重设其实际引用的状态对象，而其行为也将得到变更。通常，状态以标识符形式（有时候表现为内部数据值，即除了标识符以外，还有额外的数据）存储，在编写上下文对象的行为时，会使用大量的条件语句，通过当前的状态值判断实际需要执行的动作；对于新添加的状态，上下文对象的行为也需要相应改变其处理逻辑。当状态以引用对象的形式存储后，状态对象的行为可直接调用其引用的状态对象的方法；对于新添加的状态，只需要构建新的状态对象，即可加以实现。</p>
<p>状态模式的表现即如《设计模式:可复用面向对象软件的基础》一书中所说的：</p>
<blockquote class="blockquote-center"><p>Allow an object to alter its behavior when its internal state changes.The object will appear to change its class. </p>
</blockquote>
<h2 id="经典实现"><a href="#经典实现" class="headerlink" title="经典实现"></a>经典实现</h2><p>状态模式包含下列组件：</p>
<ul>
<li>Context: 定义交互接口，以引用对象形式持有某个 ConcreteState，其行为通过委托给 ConcreteState 实现；当状态更新时，其持有的 ConcreteState 引用也将得到更新。</li>
<li>State: 状态对象，定义行为的抽象类。</li>
<li>ConcreteState: 具体状态子类，实现 State 抽象类中定义的行为。</li>
</ul>
<p>使用状态模式的效果：</p>
<ol>
<li>使用特定的类维护特定状态的行为，该类可以共享，且不同状态的类之间相互没有耦合。</li>
<li>状态转换更加显式化。从 Context 的角度看，状态转换只需更新其下引用的状态对象，其过程是原子的。而以内部数据值存储状态时，更新状态时，需要同时更新多个内部数据值。</li>
</ol>
<p>以下载状态为例，其简单实现为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// typescript 编码</span></span><br><span class="line">abstract <span class="class"><span class="keyword">class</span> <span class="title">State</span></span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(context)&#123;</span><br><span class="line">    <span class="keyword">super</span>(context);</span><br><span class="line">    <span class="keyword">this</span>.context = context;<span class="comment">// 通过引用属性访问 Context 实例，可访问实例属性，以处理状态切换操作；可改为传参实现</span></span><br><span class="line">  &#125;</span><br><span class="line">  download()&#123;&#125;</span><br><span class="line">  pause()&#123;&#125;</span><br><span class="line">  fail()&#123;&#125;</span><br><span class="line">  finish()&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReadyState</span> <span class="keyword">extends</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">  @override</span><br><span class="line">  download()&#123;</span><br><span class="line">    <span class="keyword">this</span>.context.setState(<span class="keyword">this</span>.context.downloadingState());</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Start Download!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @override</span><br><span class="line">  pause()&#123;&#125;</span><br><span class="line"></span><br><span class="line">  @override</span><br><span class="line">  fail()&#123;&#125;</span><br><span class="line"></span><br><span class="line">  @override</span><br><span class="line">  finish()&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DownLoadState, PauseState, FailState, FinishState 实现</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DownLoad</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>()&#123;</span><br><span class="line">    <span class="keyword">this</span>.readyState = <span class="keyword">new</span> ReadyState(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.downLoadState = <span class="keyword">new</span> DownLoadState(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.pauseState = <span class="keyword">new</span> PauseState(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.failState = <span class="keyword">new</span> FailState(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.finishState = <span class="keyword">new</span> FinishState(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">this</span>.state = <span class="keyword">this</span>.readyState;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  download()&#123;</span><br><span class="line">    <span class="keyword">this</span>.state.download();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  pause()&#123;</span><br><span class="line">    <span class="keyword">this</span>.state.pause();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fail()&#123;</span><br><span class="line">    <span class="keyword">this</span>.state.fail();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  finish()&#123;</span><br><span class="line">    <span class="keyword">this</span>.state.finish();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setState(State)&#123;</span><br><span class="line">    <span class="keyword">this</span>.state = State;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>上述实现存在的问题：</p>
<ol>
<li>状态转换在 ConcreteState 具体状态子类中实现，这样 ConcreteState 就存在相互依赖关系，其中一个必须知道后继状态是哪一个。同时对于状态转换策略不同的业务场景，也不能共享状态对象。状态转换也可以放在 Context 中完成，这样做不利于状态转换的扩展，同时，状态转换较为复杂时（如开叉后再汇合，就像 git 的提交记录），其中的处理逻辑就会显得繁复。</li>
<li>状态对象在 Context 初始化过程中即予创建，且始终不销毁，而不是在需要使用的时候再行创建，使用完以后即予销毁。状态变更较为频繁的场景推荐在 Context 初始化过程中一次性创建所有状态对象；状态变更不频繁且初始状态未知的场景推荐使用即时创建状态对象。</li>
</ol>
<p>因此，实现可以改写为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用时创建状态对象，状态切换仍由状态对象完成</span></span><br><span class="line">abstract <span class="class"><span class="keyword">class</span> <span class="title">State</span></span>&#123;</span><br><span class="line">  download(context)&#123;&#125;</span><br><span class="line">  pause(context)&#123;&#125;</span><br><span class="line">  fail(context)&#123;&#125;</span><br><span class="line">  finish(context)&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReadyState</span> <span class="keyword">extends</span> <span class="title">State</span> </span>&#123;</span><br><span class="line">  @override</span><br><span class="line">  download(context)&#123;</span><br><span class="line">    context.setState(<span class="keyword">new</span> DownLoadState());</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"Start Download!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @override</span><br><span class="line">  pause(context)&#123;&#125;</span><br><span class="line"></span><br><span class="line">  @override</span><br><span class="line">  fail(context)&#123;&#125;</span><br><span class="line"></span><br><span class="line">  @override</span><br><span class="line">  finish(context)&#123;&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// DownLoadState, PauseState, FailState, FinishState 实现</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DownLoad</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>()&#123;</span><br><span class="line">    <span class="keyword">this</span>.state = <span class="keyword">new</span> ReadyState(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  download()&#123;</span><br><span class="line">    <span class="keyword">this</span>.state.download(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  pause()&#123;</span><br><span class="line">    <span class="keyword">this</span>.state.pause(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fail()&#123;</span><br><span class="line">    <span class="keyword">this</span>.state.fail(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  finish()&#123;</span><br><span class="line">    <span class="keyword">this</span>.state.finish(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setState(State)&#123;</span><br><span class="line">    <span class="keyword">this</span>.state = State;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="js-中的状态模式"><a href="#js-中的状态模式" class="headerlink" title="js 中的状态模式"></a>js 中的状态模式</h2><p>在 js 中，可直接使用对象字面量声明状态对象，同时，借助于 Function.prototype.call 方法可以将上下文对象的行为委托给状态对象加以处理。实现代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> FSM = &#123;</span><br><span class="line">  ready: &#123;</span><br><span class="line">    download: <span class="function"><span class="params">()</span> =&gt;</span> &#123; </span><br><span class="line">      <span class="keyword">this</span>.state = FSM.download;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Start Download!"</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    pause: <span class="function"><span class="params">()</span> =&gt;</span> &#123; &#125;,</span><br><span class="line">    fail: <span class="function"><span class="params">()</span> =&gt;</span> &#123; &#125;,</span><br><span class="line">    finish: <span class="function"><span class="params">()</span> =&gt;</span> &#123; &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  download: &#123;</span><br><span class="line">    download: <span class="function"><span class="params">()</span> =&gt;</span> &#123; &#125;,</span><br><span class="line">    pause: <span class="function"><span class="params">()</span> =&gt;</span> &#123; </span><br><span class="line">      <span class="keyword">this</span>.state = FSM.pause;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Download is paused!"</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    fail: <span class="function"><span class="params">()</span> =&gt;</span> &#123; </span><br><span class="line">      <span class="keyword">this</span>.state = FSM.fail;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Download is failed!"</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    finish: <span class="function"><span class="params">()</span> =&gt;</span> &#123; </span><br><span class="line">      <span class="keyword">this</span>.state = FSM.finish;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Download is finished!"</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// pause, fail, success 状态实现</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DownLoad</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>()&#123;</span><br><span class="line">    <span class="keyword">this</span>.state = FSM.ready;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  download()&#123;</span><br><span class="line">    <span class="keyword">this</span>.state.download.call(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  pause()&#123;</span><br><span class="line">    <span class="keyword">this</span>.state.pause.call(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fail()&#123;</span><br><span class="line">    <span class="keyword">this</span>.state.fail.call(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  finish()&#123;</span><br><span class="line">    <span class="keyword">this</span>.state.finish.call(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>将上述代码中 Function.prototype.call 方法作进一步封装，可实现为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> delegate = <span class="function">(<span class="params">context, delegation</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    download: <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123; </span><br><span class="line">      <span class="keyword">return</span> delegation.download.call(context, ...args);</span><br><span class="line">    &#125;,</span><br><span class="line">    pause: <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123; </span><br><span class="line">      <span class="keyword">return</span> delegation.pause.call(context, ...args);</span><br><span class="line">    &#125;,</span><br><span class="line">    fail: <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123; </span><br><span class="line">      <span class="keyword">return</span> delegation.fail.call(context, ...args);</span><br><span class="line">    &#125;,</span><br><span class="line">    finish: <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123; </span><br><span class="line">      <span class="keyword">return</span> delegation.finish.call(context, ...args);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> FSM = &#123;</span><br><span class="line">  ready: &#123;</span><br><span class="line">    download: <span class="function"><span class="params">()</span> =&gt;</span> &#123; </span><br><span class="line">      <span class="keyword">this</span>.state = <span class="keyword">this</span>.download;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Start Download!"</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    pause: <span class="function"><span class="params">()</span> =&gt;</span> &#123; &#125;,</span><br><span class="line">    fail: <span class="function"><span class="params">()</span> =&gt;</span> &#123; &#125;,</span><br><span class="line">    finish: <span class="function"><span class="params">()</span> =&gt;</span> &#123; &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  download: &#123;</span><br><span class="line">    download: <span class="function"><span class="params">()</span> =&gt;</span> &#123; &#125;,</span><br><span class="line">    pause: <span class="function"><span class="params">()</span> =&gt;</span> &#123; </span><br><span class="line">      <span class="keyword">this</span>.state = <span class="keyword">this</span>.pause;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Download is paused!"</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    fail: <span class="function"><span class="params">()</span> =&gt;</span> &#123; </span><br><span class="line">      <span class="keyword">this</span>.state = <span class="keyword">this</span>.fail;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Download is failed!"</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    finish: <span class="function"><span class="params">()</span> =&gt;</span> &#123; </span><br><span class="line">      <span class="keyword">this</span>.state = <span class="keyword">this</span>.finish;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Download is finished!"</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// pause, fail, success 状态实现</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DownLoad</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>()&#123;</span><br><span class="line">    <span class="keyword">this</span>.ready = delegate(<span class="keyword">this</span>, FSM.ready);</span><br><span class="line">    <span class="keyword">this</span>.download = delegate(<span class="keyword">this</span>, FSM.download);</span><br><span class="line">    <span class="keyword">this</span>.pause = delegate(<span class="keyword">this</span>, FSM.pause);</span><br><span class="line">    <span class="keyword">this</span>.fail = delegate(<span class="keyword">this</span>, FSM.fail);</span><br><span class="line">    <span class="keyword">this</span>.success = delegate(<span class="keyword">this</span>, FSM.success);</span><br><span class="line">    <span class="keyword">this</span>.state = <span class="keyword">this</span>.ready;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  download()&#123;</span><br><span class="line">    <span class="keyword">this</span>.state.download();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  pause()&#123;</span><br><span class="line">    <span class="keyword">this</span>.state.pause();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fail()&#123;</span><br><span class="line">    <span class="keyword">this</span>.state.fail(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  finish()&#123;</span><br><span class="line">    <span class="keyword">this</span>.state.finish(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过 Proxy 代理实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> FSM = &#123;</span><br><span class="line">  ready: &#123;</span><br><span class="line">    download: <span class="function">(<span class="params">context</span>) =&gt;</span> &#123; </span><br><span class="line">      context.state = FSM.download;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Start Download!"</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    pause: <span class="function">(<span class="params">context</span>) =&gt;</span> &#123; &#125;,</span><br><span class="line">    fail: <span class="function">(<span class="params">context</span>) =&gt;</span> &#123; &#125;,</span><br><span class="line">    finish: <span class="function">(<span class="params">context</span>) =&gt;</span> &#123; &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  download: &#123;</span><br><span class="line">    download: <span class="function">(<span class="params">context</span>) =&gt;</span> &#123; &#125;,</span><br><span class="line">    pause: <span class="function">(<span class="params">context</span>) =&gt;</span> &#123; </span><br><span class="line">      context.state = FSM.pause;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Download is paused!"</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    fail: <span class="function">(<span class="params">context</span>) =&gt;</span> &#123; </span><br><span class="line">      context.state = <span class="keyword">this</span>.fail;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Download is failed!"</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    finish: <span class="function">(<span class="params">context</span>) =&gt;</span> &#123; </span><br><span class="line">      context.state = <span class="keyword">this</span>.finish;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Download is finished!"</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// pause, fail, success 状态实现</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DownLoad</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>()&#123;</span><br><span class="line">    <span class="keyword">this</span>.state = FSM.ready;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> download = <span class="keyword">new</span> <span class="built_in">Proxy</span>(<span class="keyword">new</span> Download(), &#123;</span><br><span class="line">  get(target, propKey, receiver)&#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">Object</span>.keys(target.state).indexOf(propKey) !== <span class="number">-1</span> )&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">        target.state[propKey](target, ...args);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> target[propKey];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="表驱动的状态模式"><a href="#表驱动的状态模式" class="headerlink" title="表驱动的状态模式"></a>表驱动的状态模式</h2><p>表驱动的状态模式，其处理逻辑为使用表结构约定每种状态在特定条件下（该条件也可以是执行状态转换逻辑的函数名）的后继状态为谁，就此实现状态转换。</p>
<p>借助于 Proxy 代理，实现表驱动的简易代码为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> FSM = &#123;</span><br><span class="line">  ready: &#123;</span><br><span class="line">    download: <span class="function"><span class="params">()</span> =&gt;</span> &#123; </span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Start Download!"</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    pause: <span class="function"><span class="params">()</span> =&gt;</span> &#123; &#125;,</span><br><span class="line">    fail: <span class="function"><span class="params">()</span> =&gt;</span> &#123; &#125;,</span><br><span class="line">    finish: <span class="function"><span class="params">()</span> =&gt;</span> &#123; &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  download: &#123;</span><br><span class="line">    download: <span class="function"><span class="params">()</span> =&gt;</span> &#123; &#125;,</span><br><span class="line">    pause: <span class="function"><span class="params">()</span> =&gt;</span> &#123; </span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Download is paused!"</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    fail: <span class="function"><span class="params">()</span> =&gt;</span> &#123; </span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Download is failed!"</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">    finish: <span class="function"><span class="params">()</span> =&gt;</span> &#123; </span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">"Download is finished!"</span>);</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// pause, fail, success 状态实现</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DownLoad</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>()&#123;</span><br><span class="line">    <span class="comment">// 状态转换规则</span></span><br><span class="line">    <span class="keyword">this</span>.rules = &#123;</span><br><span class="line">      ready: [&#123; <span class="attr">transition</span>: <span class="string">'download'</span>, <span class="attr">to</span>: <span class="string">'downloading'</span> &#125;],</span><br><span class="line">      download: [&#123; </span><br><span class="line">        transition: <span class="string">'pause'</span>, <span class="attr">to</span>: <span class="string">'paused'</span> </span><br><span class="line">      &#125;,&#123;</span><br><span class="line">        transition: <span class="string">'fail'</span>, <span class="attr">to</span>: <span class="string">'failed'</span> </span><br><span class="line">      &#125;,&#123;</span><br><span class="line">        transition: <span class="string">'finish'</span>, <span class="attr">to</span>: <span class="string">'finished'</span> </span><br><span class="line">      &#125;],</span><br><span class="line">      pause: [&#123; <span class="attr">transition</span>: <span class="string">'download'</span>, <span class="attr">to</span>: <span class="string">'downloading'</span> &#125;]</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">this</span>.state = <span class="string">'ready'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> download = <span class="keyword">new</span> <span class="built_in">Proxy</span>(<span class="keyword">new</span> Download(), &#123;</span><br><span class="line">  get(target, propKey, receiver)&#123;</span><br><span class="line">    <span class="keyword">const</span> state = target.state;</span><br><span class="line">    <span class="keyword">const</span> stateObject = FSM[state];</span><br><span class="line">    <span class="keyword">const</span> rules = target.rules[state];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( <span class="built_in">Object</span>.keys(stateObject).indexOf(propKey) !== <span class="number">-1</span> )&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">        stateObject[propKey](target, rules, ...args);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 状态装换</span></span><br><span class="line">        <span class="keyword">const</span> rule = rules.filter(<span class="function"><span class="params">rl</span> =&gt;</span> rl.transition === propKey)[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> ( rule ) target.state = rule.to;</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> target[propKey];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>通过上述代码可以发现，基于表结构实现的状态转换需要从表中查询后继状态，没有函数调用直观便捷，同时，状态转换过程需要扩展的动作也难以添加。</p>
<h3 id="javascript-state-machine"><a href="#javascript-state-machine" class="headerlink" title="javascript-state-machine"></a>javascript-state-machine</h3><p><a href="https://github.com/jakesgordon/javascript-state-machine" target="_blank" rel="noopener">javascript-state-machine</a> 是基于表结构实现的状态转换管理器。相较于状态模式使用状态对象管理状态，并借此改变上下文对象的行为，其重心在于不同状态下行为的不同，换句话说，就是不同模式下不同的业务表现。因此，《设计模式:可复用面向对象软件的基础》书中描述了 GUI 编程使用状态模式协调不同的绘图控件。而 javascript-state-machine 模块的重心在于状态转换的流程，由此种状态进入另一种状态，通过事件执行钩子函数。</p>
<p>javascript-state-machine 模块有如下几个概念：</p>
<ul>
<li>transition: 事务，设定状态切换的方法名，并制定该方法状态切换的规则，从 [from] 状态转变为 [to] 状态。当切换前的 [from] 状态不同时，可使用同一个事务定制多种状态切换规则。由 transitions = [{ name, from, to }] 选项注入。</li>
<li>state: 状态。通过 transitions 选项转换得来。特别的，transition.to 状态可以用函数形式设定，在状态转换过程中注入 states 状态集中。</li>
<li>lifecycle events: 生命周期事件，即执行钩子，分为两类，以 onBefore, onAfter 为前缀的事务执行前后的生命周期钩子，以 onEnter, onLeave 为前缀的状态变更前后的生命周期钩子。特殊的，onBeforeTransition, onLeaveState, onTransition, onEnterState, onAfterTransition 为全局声明周期钩子。事件名由 transitions 选项注入，绑定函数由 methods = { eventName: () =&gt; {} } 选项注入，或者通过调用 fsm.observer({ eventName: () =&gt; {} }) 方法注入。</li>
<li>observer: 观察者，即绑定函数。可以通过 methods 选项添加，或者通过 StateMachine 实例的 observe 方法添加，以数组形式存储对象 { event: ({ transition, from, to, fsm, event }) =&gt; {} }。当事件发生时，再取出串行执行，通过 promise 实现了异步执行机制。</li>
</ul>
<p>在 javascript-state-machine 模块的构造中，整体架构：</p>
<ul>
<li>config 模块提供 Config 类，用于管理 states, transitions, lifecycle, data, methods, plugins 等实例属性。其中 state 以 this.states 数组形式存储，transitions 以 this.transitions 数组形式存储方法名，this.map = { [from]:{ [name]: transition } } 存储转换规则（其中，transition 为 transitions 选项中的数组项，from 为 transition.from，name 为 transition.name）,this.lifecycle = { onBefore: { transition, …customTransitionName }, onAfter, on, onEnter: { state, …customStateName }, onLeave } 形式存储事件名（其中，this.lifecycle.onBefore.transition 等为全局事件名 ）。Config 还提供 transitionFor(state, transition) 用于查找切换后的状态。</li>
<li>jsm 模式提供 JSM 类，用于组织状态切换及触发钩子函数的逻辑。通过 this.config 访问 Config 实例，this.context 访问 StateMachine 实例，其 init 方法将 config.data 注入为 StateMachine 实例的属性；在 JSM 实例化过程中，又将注入到 StateMachine 实例方法的config.methods 绑定函数注入为 jsm.observers 属性中，通过 observersForEvent(event) 方法取出绑定函数，再交由 observeEvents 方法统筹一次状态变更过程中执行依序执行的事件、并执行绑定函数（以取出的 observer = { eventName: ({ transition, from, to, fsm, event }) =&gt; {} } 作为上下文，特别的，首个 observer 的就是 StateMachine 实例），最终提供 jsm.fire(transition, args) 方法将当前状态更改为 transition 事务下指定的后继状态（并导出为 stateMachine 实例的 transition 同名方法）、以及 jsm.transit(transition, from, to, args) 方法将状态转换到 to，并指定状态时的 transition, from。事件触发、执行绑定函数过程，绑定函数中的异步逻辑通过返回 promise 处理；状态变更期间，jsm.pending 属性置为真，直到状态变更完毕或报错。</li>
<li>app 模块提供 StateMachine 类，暴露用户接口。StateMachine 类实例化过程中会将 config 实例的 methods, data 属性转变为其实例属性，同时添加以 transition.name 标识的实例方法，因此三者的命名不能冲突。以 config, jsm, app 三个模块实现 StateMachine 类的好处是尽量少地暴露出交互接口。可通过 StateMachine 实例访问当前的状态 stateMachine.state，公共方法 is(state), can(transition), cannot(transition), observe({ event: () =&gt; {} }), transitions(), allTransitions(), allStates(), onInvalidTransition(transition, from, to), onPendingTransition(transition, from, to)，以及通过选线注入的实例属性或方法如 data, transitions, methods 选项。</li>
</ul>
<p>需要留意的特性包含：</p>
<ul>
<li>data 选项依赖注入。当 data 选项包含方法时，其参数依赖注入的机制通过工厂函数 StateMachine.factory 实现，创建并返回 StateMachine 的另一种构造函数，该构造函数只将参数注入为 data 方法的参数；选项由 StateMachine.factory 注入。其目的是让多个 StateMachine 实例握有不同的 data 数据，但在不同状态中定制 data 数据需要借助于常规的状态模式。</li>
<li>to 状态转换的条件性。javascript-state-machine 模块没有设置 condition 条件（在匹配 condition 条件下，才从 from 状态转换到 to 状态），而是可以用函数形式设置 to，以使切换后的状态可以在转换阶段获得。</li>
<li>插件机制。如同 Vue, mocha 的插件机制，javascript-state-machine 模块的插件在 StateMachine 实例化过程中就会执行 plugin 函数或 plugin.configure 方法，其返回值中的 methods, properties 属性注入为 StateMachine 实例的方法或属性、init, lifecycle 方法将在状态初始化及变更期间被唤起执行。插件通过 plugins 选项或者 StateMachine.plugin 静态属性注入。</li>
<li>内置 history 插件，通过 require(‘javascipt-state-machine/lib/history’) 引用，记录状态变更历史，通过 fsm.transit 方法实现回撤、前进功能。</li>
<li>内置 visualize 工具，通过 require(‘javascipt-state-machine/lib/visualize’) 引用，将状态转变为 .dot 语句，借助于 <a href="http://www.graphviz.org/" target="_blank" rel="noopener">GraphViz</a> 类库表现为图形。</li>
</ul>
<p>具体请参考 javascript-state-machine 类库文档及源码。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/18/参考文档/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/18/参考文档/" itemprop="url">参考文档</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-18T16:43:28+08:00">2018-03-18</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/文档/" itemprop="url" rel="index"><span itemprop="name">文档</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/18/参考文档/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/03/18/参考文档/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>Jenkins: <a href="https://www.jianshu.com/p/b524b151d35f" target="_blank" rel="noopener">Jenkins 使用简易教程</a></p>
<p>Nginx: <a href="https://www.cnblogs.com/zhouxinfei/p/7862285.html" target="_blank" rel="noopener">Nginx安装及配置详解</a><br><a href="http://tengine.taobao.org/book/index.html" target="_blank" rel="noopener">Nginx开发从入门到精通</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/17/es6/Decorator/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/17/es6/Decorator/" itemprop="url">修饰器</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-17T12:59:49+08:00">2018-03-17</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/es6/" itemprop="url" rel="index"><span itemprop="name">es6</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/17/es6/Decorator/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/03/17/es6/Decorator/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>修饰器是 es7 中的一个提案，其本质为编译期间执行的一个函数，用于装饰类、方法、属性等，不能用于装饰函数（因为函数存在声明提升）。</p>
<p>使用 decorator(target, property?, desciptor?){} 语句声明修饰器函数，其中，参数 target 为目标函数，property 为属性，desciptor 为属性描述符，后两个参数用于装饰方法或属性的情景下。装饰类，在修饰器中直接操纵类即可；装饰方法或属性时，通过返回新的属性描述符实现。</p>
<p><em>代码段 1：装饰类</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params">target</span>)</span>&#123;</span><br><span class="line">  target.isTestable = <span class="literal">true</span>;</span><br><span class="line">  target.prototype.isTestable = <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@test</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;&#125;</span><br></pre></td></tr></table></figure></p>
<p><em>代码段 2：装饰属性或方法</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">readonly</span>(<span class="params">target, name, descriptor</span>)</span>&#123;</span><br><span class="line">  descriptor.writable = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">return</span> descriptor;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span></span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(name, age, tel)&#123;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">    <span class="keyword">this</span>.id = id;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @readonly</span><br><span class="line">  id()&#123;<span class="keyword">return</span> <span class="keyword">this</span>.id&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="core-decorators"><a href="#core-decorators" class="headerlink" title="core-decorators"></a>core-decorators</h2><p><a href="https://github.com/jayphelps/core-decorators" target="_blank" rel="noopener">core-decorators.js</a> 是一个第三方模块，提供了常见的修饰器。</p>
<ol>
<li>@readonly 修饰属性或方法为只读。通过将 descriptor.writable 赋值为 false 实现。</li>
<li>@nonconfigurable 修饰属性或方法为不可配置。通过将 descriptor.configurable 赋值为 false 实现。</li>
<li>@decorate(decorator, …args) 以指定函数装饰方法或属性。通过执行 decorator(fn|value, …args) 实现，其中 fn|value 为 descriptor.get 或 target[property]。</li>
<li>@extendDescriptor 继承父类的 get/set 方法。通过 Object.getPrototypeOf(target) 获取父类实现。</li>
<li>@nonenumerable 修饰属性不可枚举。通过将 descriptor.enumerable 赋值为 false 实现。</li>
<li>@lazyInitialize 在访问时延迟赋值属性。通过在访问属性时执行 descriptor.initializer 方法实现。</li>
<li>@autobind 将方法的上下文赋值为 target，即便方法通过 fn = target.method 语句赋值给某函数 fn，在函数 fn 执行期间，其上下文仍为 target。通过 fn.bind(target) 实现。autobind 修饰器可用于装饰类。</li>
<li>@deprecate(message, {url}?)|@deprecated(message, {url}?) 在方法执行期间予以已废除提示。通过将 descriptor.value 赋值为封装了提示动作的函数实现。</li>
<li>@override 检查子类是否正确覆盖了父类的同名方法，descriptor.value 形式时校验类型是否相同；descriptor.get, descriptor.set 形式校验父类、子类是否存在对等的设置。</li>
<li>@time 打印方法的执行时间，借助于 console.time, console.timeEnd 实现，可通过改写 defaultConsole 实现自定义设置。</li>
<li>@profile 浏览器端监测方法的执行性能，借助于 console.profile, console.profileEnd 实现。</li>
</ol>
<h2 id="babel-转码"><a href="#babel-转码" class="headerlink" title="babel 转码"></a>babel 转码</h2><p>借助于 babel-plugin-transform-decorators-legacy 插件，可以将修饰符降级为 es5。</p>
<h3 id="babel-plugin-transform-decorators-legacy-原理"><a href="#babel-plugin-transform-decorators-legacy-原理" class="headerlink" title="babel-plugin-transform-decorators-legacy 原理"></a>babel-plugin-transform-decorators-legacy 原理</h3>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/15/Vue/数据绑定/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/15/Vue/数据绑定/" itemprop="url">Vue 源码分析 - 数据侦测</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-15T00:00:00+08:00">2018-03-15</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/vue/" itemprop="url" rel="index"><span itemprop="name">vue</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/15/Vue/数据绑定/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/03/15/Vue/数据绑定/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="序言"><a href="#序言" class="headerlink" title="序言"></a>序言</h2><p>数据侦测，也称为数据绑定，即是监测数据的更新状况，当数据更新时，触发后续动作的执行。以伪语法的形式，可以用 <em>表达式 1</em> 概括说明。</p>
<p><em>表达式 1</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">when(data changed)&#123;</span><br><span class="line">  <span class="keyword">do</span> compute</span><br><span class="line">  <span class="keyword">do</span> reaction</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>基于 <em>表达式 1</em> ，有如下概念（基于 <a href="http://cn.mobx.js.org/" target="_blank" rel="noopener">mobx 文档</a> 整理）：</p>
<p><em>概念 1</em><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Observable: 监测数据，可以是状态，更新其值将触发执行 compute 及 reaction</span><br><span class="line">action: 促使 Observable 更新的动作，可用于收集 Observable 更新前后的状况</span><br><span class="line">compute: Observable 更新后，触发执行的动作，用于获取计算属性</span><br><span class="line">reaction: Observable 更新后，触发执行的动作，用于执行副作用</span><br><span class="line">derivations: 衍生，Observable 更新后触发动作的统称，包含 compute 及 reaction</span><br></pre></td></tr></table></figure></p>
<p>程序实现 <em>表达式 1</em> 中的逻辑，主要有两种方式。第一种方式是使用定时器周期性检测 <em>Observable</em> 数据（下文中的响应式数据，即指监测数据 <em>Observable</em>）的变更，当数据变更时，触发执行后续的动作。第二种方式是借助于硬编码或钩子，将后续执行动作添加到数据更新的过程 <em>action</em> 之后。本篇文章旨在讨论基于观察者模式（即钩子函数的底层实现）这一种解决方案。上述两种方式都聚焦于解决怎样在数据更新后、引起后续动作的执行。当使用观察者模式实现数据侦测时，所要面临的难题是，怎样推断单个 <em>Observable</em> 数据被哪些 <em>derivations</em> 订阅（也可以称为观察或监测，当数据更新时，将引起这些 <em>derivations</em> 的执行），以及单个 <em>derivations</em> 订阅了哪些 <em>Observable</em> 数据（在这些数据更新后，都会引起 <em>derivations</em> 的执行），即确定 <em>Observable</em> 和 <em>derivations</em> 的依赖关系。</p>
<p>这篇文章首先将探讨使用观察者模式实现数据侦测的基本思路（见诸 <em>探讨</em> 一节），随后分析 <em>Vue</em> 源码对数据侦测功能的实现（见诸 <em>Vue 实现</em> 一节），其次分析数据侦测在 <em>Vue</em> 中的实际使用，表现为 <em>Vue</em> 实例的配置项以及 <em>Vue</em> 对外提供的接口（见诸 <em>Vue 应用</em> 一节），最后将借鉴 <em>mobx</em> 的 api，简单制作一个相应类库（见诸 <em>延伸</em> 一节）。需要说明的是，无论探讨一节，还是延伸一节，都是基于笔者对 <em>Vue</em> 源码的领悟，思路也因而有所局限。对于实现数据侦测功能的多种技术方案，笔者譬如井底之蛙。在这方面，读者可自行翻阅实现了数据侦测功能的其他类库或框架，免使思维陷入这篇文章的小小格局。</p>
<p>在阅读后续章节前，读者可以酌情先了解下 <a href="http://xzfyu.com/2018/03/04/设计模式/观察者模式/" target="_blank" rel="noopener">观察者模式</a>，或者跟随笔者的思路拾级而上。</p>
<h2 id="探讨"><a href="#探讨" class="headerlink" title="探讨"></a>探讨</h2><p>数据侦测用观察者模式实现的简易原理是，当访问数据时，调用 <strong>Observer.subscribe(topic, listener)</strong> 方法，以绑定函数（下文将用订阅函数代称）形式添加订阅者；当更新数据时，调用 <strong>Observer.publish(topic, …args)</strong> 方法，执行后续的动作，即调用 <strong>listener(…args)</strong> 函数。通过在更新数据前，先访问数据，就可以使绑定函数观察这份数据变更，在数据变更后自动执行绑定函数。</p>
<p><em>代码段 1</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> handlebars <span class="keyword">from</span> <span class="string">'handlebars'</span>;</span><br><span class="line"><span class="keyword">import</span> Observer <span class="keyword">from</span> <span class="string">'./observer'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rerender</span>(<span class="params">key, data</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">let</span> el = <span class="built_in">document</span>.getElementById(<span class="string">"entry"</span>);</span><br><span class="line">  <span class="keyword">let</span> template = el.innerHTML;</span><br><span class="line">  <span class="keyword">let</span> compiler = handlebars.compile(template);</span><br><span class="line">  <span class="keyword">let</span> html = compiler(data)</span><br><span class="line">  el.innerHTML = html;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Observable</span> </span>&#123;</span><br><span class="line">  data = <span class="literal">null</span>;</span><br><span class="line">  </span><br><span class="line">  construtor(data)&#123;</span><br><span class="line">    <span class="keyword">this</span>.data = data;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  get(key)&#123;</span><br><span class="line">    Observer.subscribe(key, rerender);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>[key];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  set(key, val)&#123;</span><br><span class="line">    <span class="keyword">let</span> oldVal = <span class="keyword">this</span>.get(key);</span><br><span class="line">    <span class="keyword">if</span> ( oldVal !== val )&#123;</span><br><span class="line">      <span class="keyword">this</span>.data[key] = val;</span><br><span class="line">      Observer.publish(key, <span class="keyword">this</span>.data);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> ob = <span class="keyword">new</span> Observable(&#123; <span class="attr">name</span>: <span class="string">'jack'</span> &#125;);</span><br><span class="line">ob.set(<span class="string">'name'</span>, <span class="string">'andy'</span>);<span class="comment">// 通过执行绑定函数 rerender 重绘视图</span></span><br></pre></td></tr></table></figure></p>
<p>上述代码就是用观察者模式表现硬编码形式的 <strong>data.name = ‘andy’; rerender(data)</strong> 语句的处理逻辑。有关 <em>Observer</em> 类的实现，请参详 <a href="http://xzfyu.com/2018/03/04/设计模式/观察者模式/" target="_blank" rel="noopener">观察者模式</a> 一文。然而，上述代码存在下述问题：</p>
<p><em>问题清单 1</em></p>
<ol>
<li>代码书写风格的问题。<strong>ob.set(key, val)</strong> 可否简化为 <strong>data[key] = val</strong> 形式，使其同样能唤起后续动作的执行？</li>
<li>显式指明的订阅函数和硬编码风格相差无几，对于 <em>derivations</em> 多样的业务场景并不适用，能否将其解耦，使 <em>derivations</em> 的执行过程更为灵活？</li>
</ol>
<p><em>解决方案 1</em></p>
<ol>
<li>针对 <em>问题 1</em>，可通过调用 <strong>Object.defineProperty(targer, key, descriptor)</strong> 方法，将 <em>代码段 1</em> 中 <strong>get, set</strong> 方法的处理逻辑写进访问器属性中，得到解决。而 <strong>Object.defineProperty</strong> 方法，也是 Vue 相关源码的实现内核所在。</li>
<li>针对 <em>问题 2</em>，可通过将硬编码的 <strong>rerenderView</strong> 订阅函数演化为更灵活的订阅者管理器 <em>SubscriberManager</em> 类实现。即在响应式数据变更过程中，由 <em>SubscriberManager</em> 实例实时查找同这些响应式数据相关的订阅函数，并触发订阅函数的执行。</li>
</ol>
<p>为着实现 <em>SubscriberManager</em> 类，将要面临如何解决 <em>Observable</em> 和 <em>derivations</em> 之间依赖关系管理的问题。</p>
<p><em>问题清单 2</em></p>
<ol>
<li><em>Observable</em> 和 <em>derivations</em> 的依赖关系问题。思想如由 <strong>getFullname</strong> 计算函数获得的 <strong>fullname</strong> 依赖于响应式数据中 <strong>firstname, secondname</strong> 属性的场景，即 <strong>firstname, secondname</strong> 属性变更时，将触发调用 <strong>getFullname</strong> 订阅函数的执行，而当其他属性变更时，并不触发 <strong>getFullname</strong> 的执行。<strong>getFullname</strong> 订阅函数和 <strong>firstname, secondname</strong> 监测属性有相互依赖关系。当 <strong>firstname, secondname</strong> 属性移除后，<strong>getFullname</strong> 订阅函数不再执行；当 <strong>getFullname</strong> 函数移除后，<strong>firstname, secondname</strong> 属性更新不再通知 <strong>getFullname</strong> 函数。并且，依赖关系问题不只包含当响应式数据或订阅函数移除时如何重置依赖，还包含当新增一项 <em>derivations</em> 观察的数据或者新增一项订阅 <em>Observable</em> 的函数时如何更新依赖。</li>
</ol>
<p><em>解决方案 2</em></p>
<ol>
<li>针对 <em>问题 1</em>，在没有使用 <strong>Object.defineProperty(targer, key, descriptor)</strong> 方法的场景中，可以通过 <strong>Observer.subscribe(observale, key, listener)</strong> 方式显式指明订阅函数 <strong>listener</strong> 需要在 <strong>observale[key]</strong> 数据变更后执行。这种显式指明的方式譬如手动添加，其依赖关系也必然要手动移除，需要费一番功夫才能实现自动化更新和重置依赖。虽然，可以将订阅函数 <strong>listener</strong> 以 <strong>{ bindTo: [ keyPath ], linstener }</strong> 形式存储到 <strong>observale._listening</strong> 属性中（其中，<strong>keyPath</strong> 为键路径），或者以 <strong>Map</strong> 映射存储响应式对象键路径和订阅函数，通过 <strong>id</strong> 号搜寻依赖，以避免对外暴露依赖关系。在这方面，可以参考 <a href="https://github.com/jashkenas/backbone" target="_blank" rel="noopener">backbone</a> 及 <a href="https://github.com/emberjs/ember.js" target="_blank" rel="noopener">emberjs</a> 的实现。对这两者，笔者的领悟还不够充分。</li>
<li>继上，在使用 <strong>Object.defineProperty(targer, key, descriptor)</strong> 方法的场景中，订阅函数 <strong>listener</strong> 若以 <strong>observale</strong> 为上下文，在其执行过程中并访问 <strong>this[key]</strong> 属性时，<strong>descriptor.get</strong> 方法将得到调用。可以确知的是，<strong>descriptor.get</strong> 方法在 <strong>listener</strong> 执行背景下得到调用。当使用变量缓存 <strong>listener</strong> 时（必要情况下，可再使用先进后出队列存储执行中的订阅函数数组，其意义是在多个订阅函数嵌套执行的场景中获取当前执行的订阅函数），就可以从容建立当前订阅函数 <strong>listener</strong> 和监测数据 <strong>target[key]</strong> 的互为依赖关系。</li>
</ol>
<p><em>代码段 2</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> currentSubscriber = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(reactiveData, subscriber)&#123;</span><br><span class="line">    currentSubscriber = subscriber.bind(reactiveData);</span><br><span class="line">    subscriber.call(reactiveData);</span><br><span class="line">    currentSubscriber = <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubscriberManager</span> </span>&#123;</span><br><span class="line">  subscribers = [];</span><br><span class="line"></span><br><span class="line">  refreshSubscribers()&#123;</span><br><span class="line">    <span class="comment">// 实时查找订阅者</span></span><br><span class="line">    <span class="keyword">let</span> &#123; subscribers &#125; = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">if</span> ( subscribers.indexOf(currentSubscriber) !== <span class="number">-1</span> ) </span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    </span><br><span class="line">    subscribers.push(currentSubscriber);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  notify()&#123;</span><br><span class="line">    <span class="comment">// 通知订阅者数据已变更</span></span><br><span class="line">    <span class="keyword">this</span>.subscribers.map(<span class="function"><span class="params">subscriber</span> =&gt;</span> &#123;</span><br><span class="line">      subscriber();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">convertToReactiveData</span>(<span class="params">target, key, val</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> subscriberManager = <span class="keyword">new</span> SubscriberManager();<span class="comment">// target 的每个属性，都需要一个订阅者管理器</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> property = <span class="built_in">Object</span>.getOwnPropertyDescriptor(target, key);</span><br><span class="line">  <span class="keyword">if</span> (property &amp;&amp; property.configurable === <span class="literal">false</span>) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> getter = property &amp;&amp; property.get;</span><br><span class="line">  <span class="keyword">const</span> setter = property &amp;&amp; property.set;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(target, key, &#123;</span><br><span class="line">    enumerable: <span class="literal">true</span>,</span><br><span class="line">    configurable: <span class="literal">true</span>,</span><br><span class="line">    get: <span class="function"><span class="keyword">function</span> <span class="title">reactiveGetter</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> value = getter ? getter.call(target) : val;</span><br><span class="line">      <span class="keyword">if</span> ( currentSubscriber ) subscriberManager.refreshSubscribers();</span><br><span class="line">      <span class="keyword">return</span> value</span><br><span class="line">    &#125;,</span><br><span class="line">    set: <span class="function"><span class="keyword">function</span> <span class="title">reactiveSetter</span> (<span class="params">newVal</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> value = getter ? getter.call(target) : val;</span><br><span class="line">      <span class="keyword">if</span> ( newVal === value ) <span class="keyword">return</span>;</span><br><span class="line">      <span class="keyword">if</span> ( setter )</span><br><span class="line">        setter.call(target, newVal);</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">        val = newVal;</span><br><span class="line">      subscriberManager.notify();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReactiveDataManager</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(data)&#123;</span><br><span class="line">    data.__reactiveDataManager__ = <span class="keyword">this</span>;</span><br><span class="line">    <span class="built_in">Object</span>.keys(data).map(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> val = data[key];</span><br><span class="line">      convertToReactiveData(data, key, val);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> data = &#123; <span class="attr">firstname</span>: <span class="string">'Steven'</span>, <span class="attr">secondname</span>: <span class="string">'Spielberg'</span> &#125;;</span><br><span class="line"><span class="keyword">new</span> ReactiveDataManager(data);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">computeFullname</span>(<span class="params"></span>)</span>&#123;<span class="comment">// 将构建两个 SubscriberManager 实例</span></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`computed fullname is <span class="subst">$&#123;<span class="keyword">this</span>.firstname&#125;</span> <span class="subst">$&#123;<span class="keyword">this</span>.secondname&#125;</span>.`</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>.firstname&#125;</span> <span class="subst">$&#123;<span class="keyword">this</span>.secondname&#125;</span>`</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">new</span> Watcher(data, computeFullname);<span class="comment">// 'computed fullname is Steven Spielberg.'</span></span><br><span class="line"></span><br><span class="line">data.secondname = <span class="string">'Jobs'</span>;<span class="comment">// 'computed fullname is Steven Jobs.'</span></span><br></pre></td></tr></table></figure></p>
<p><em>代码段 2</em> 即为 Vue 扼要的实现逻辑，至于怎样将数组和深度嵌套的数据转变成响应式数据，以及如何重置依赖关系，将在下一节分析 Vue 源码的过程中予以说明。</p>
<h2 id="Vue-实现"><a href="#Vue-实现" class="headerlink" title="Vue 实现"></a>Vue 实现</h2><p>在 <em>Vue</em> 源码中，<strong>src/core/oberser</strong> 目录下各模块用于实现数据侦测。下文将用 <strong>oberser</strong> 包代称 <strong>src/core/oberser</strong> 目录。</p>
<p><em>目录结构 1</em><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">|--- observer </span><br><span class="line">  |--- index.js <span class="comment"># 将对象或数组转化为响应式数据</span></span><br><span class="line">  |--- array.js <span class="comment"># 提供改写数组 push 等原型方法的工具包</span></span><br><span class="line">  |--- watcher.js <span class="comment"># 将订阅函数实现为订阅者 Watcher 实例</span></span><br><span class="line">  |--- dep.js <span class="comment"># 管理响应式数据和订阅者 Watcher 的依赖关系，在 Vue 中视为 observable</span></span><br><span class="line">  └--- scheduler.js <span class="comment"># 用于调度订阅者的延迟执行</span></span><br></pre></td></tr></table></figure></p>
<p>本节主要针对 <strong>index, array, watcher, dep, scheduler</strong> 模块予以扼要分析，与 Vue 实例、重新渲染机制的交互过程将在下一节予以分析。</p>
<h3 id="响应式数据"><a href="#响应式数据" class="headerlink" title="响应式数据"></a>响应式数据</h3><p>在 <em>Vue</em> 中，<strong>index</strong> 模块提供的 <strong>new Observer(value)</strong> 类用于将普通数据 <strong>value</strong> 转化成响应式数据，当响应式数据更新时，将自动订阅函数的执行。<strong>value</strong> 的数据类型可以是对象或数组。若 <strong>value</strong> 为对象，遍历其属性，通过 <strong>defineReactive</strong> 函数将属性的存取过程转变为响应式，取值时更新依赖，赋值时触发订阅函数的执行。若 <strong>value</strong> 为数组，改写其 <strong>push, pop, shift, unshift, splice, sort, reverse</strong> 原型方法，将其变异为响应式数组，上述方法执行时将触发订阅函数的执行；并通过创建新的 <strong>Observer</strong> 实例将数组项转化为响应式数据。</p>
<p>因此，将普通数据转化为响应式数据基于 <strong>defineReactive(target, key, value)</strong> 函数。如前文所述，<strong>defineReactive</strong> 函数通过 <strong>Object.defineProperty(obj, key, descriptor)</strong> 方法改写属性描述符实现，其中，getter 方法用于更新订阅者，setter 方法用于触发订阅函数的执行。因为 obj[key] 等同于一个主题对象，因此在 defineReactive 函数执行过程，会针对每个 key 键创建一个 Dep 依赖管理实例，再由 getter 访问器属性调用 dep.depend 方法刷新依赖。刷新依赖的机制，可参见前文，也即订阅函数(在 Vue 表现为 Watcher 实例)在执行过程中需要访问 obj[key]，就可以将 watcher 实例赋值给 Dep.target 静态属性，并促使 dep 实例和 watcher 实例相互建立引用关系(其中，dep.subs 数组存储 watchcer 实例，即与主题对象相关的订阅函数；watcher.deps 数组存储 dep 实例，即与订阅函数相关的主题对象)。当 setter 访问器执行过程中(即 action 促使数据更新时。在 Vue 中，action 表现为 method)，将由 dep.notify 方法调用 dep.subs 数组中每个 watchcer 实例的update，进而执行 watcher 挂载的订阅函数。</p>
<p>当 obj 为深度嵌套的数据结构时，需要作怎样的处理才能将其转变为响应式数据？易于想到的处理方式是，遍历对象的属性，当其为复杂数据结构时，递归调用 new Observer(obj[key]) 将该属性转化为响应式数据，自顶向下(或者如backbone的实现，自底向上构建响应式数据)。Vue 另辟蹊径，既然每次调用 setter 访问器时，同样需要将 newValue 转变为响应式数据，将 obj[key] 初始值转化为 observer 实例也在属性描述符中处理。对于深度嵌套的数据结构，defineReactive 函数也多了入参 sallow，用于指定是否将复杂数据结构的子属性转化为响应式数据。</p>
<p><em>代码段 3</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// observer/array.js</span></span><br><span class="line"><span class="keyword">const</span> arrayProto = <span class="built_in">Array</span>.prototype</span><br><span class="line"><span class="keyword">const</span> arrayMethods = <span class="built_in">Object</span>.create(arrayProto)</span><br><span class="line"></span><br><span class="line">;[</span><br><span class="line">  <span class="string">'push'</span>,</span><br><span class="line">  <span class="string">'pop'</span>,</span><br><span class="line">  <span class="string">'shift'</span>,</span><br><span class="line">  <span class="string">'unshift'</span>,</span><br><span class="line">  <span class="string">'splice'</span>,</span><br><span class="line">  <span class="string">'sort'</span>,</span><br><span class="line">  <span class="string">'reverse'</span></span><br><span class="line">]</span><br><span class="line">.forEach(<span class="function"><span class="keyword">function</span> (<span class="params">method</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// cache original method</span></span><br><span class="line">  <span class="keyword">const</span> original = arrayProto[method]</span><br><span class="line">  def(arrayMethods, method, <span class="function"><span class="keyword">function</span> <span class="title">mutator</span> (<span class="params">...args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> result = original.apply(<span class="keyword">this</span>, args)</span><br><span class="line">    <span class="keyword">const</span> ob = <span class="keyword">this</span>.__ob__</span><br><span class="line">    <span class="keyword">let</span> inserted</span><br><span class="line">    <span class="keyword">switch</span> (method) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'push'</span>:</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'unshift'</span>:</span><br><span class="line">        inserted = args</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      <span class="keyword">case</span> <span class="string">'splice'</span>:</span><br><span class="line">        inserted = args.slice(<span class="number">2</span>)</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (inserted) ob.observeArray(inserted)</span><br><span class="line">    ob.dep.notify()</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// observer/index.js</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">protoAugment</span> (<span class="params">target, src: Object, keys: any</span>) </span>&#123;</span><br><span class="line">  target.__proto__ = src</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">copyAugment</span> (<span class="params">target: Object, src: Object, keys: Array&lt;string&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = keys.length; i &lt; l; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = keys[i]</span><br><span class="line">    def(target, key, src[key])</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">dependArray</span> (<span class="params">value: Array&lt;any&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> e, i = <span class="number">0</span>, l = value.length; i &lt; l; i++) &#123;</span><br><span class="line">    e = value[i]</span><br><span class="line">    e &amp;&amp; e.__ob__ &amp;&amp; e.__ob__.dep.depend()</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(e)) &#123;</span><br><span class="line">      dependArray(e)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">  value: any;</span><br><span class="line">  dep: Dep;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span> (value: any) &#123;</span><br><span class="line">    <span class="keyword">this</span>.value = value</span><br><span class="line">    <span class="keyword">this</span>.dep = <span class="keyword">new</span> Dep()</span><br><span class="line">    def(value, <span class="string">'__ob__'</span>, <span class="keyword">this</span>)</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(value)) &#123;</span><br><span class="line">      <span class="keyword">const</span> augment = hasProto</span><br><span class="line">        ? protoAugment<span class="comment">// protoAugment(target, src) 执行 target.__proto__ = src</span></span><br><span class="line">        : copyAugment<span class="comment">// copyAugment(target, src, keys) 遍历 keys，将 src[key] 赋值给 target[key]</span></span><br><span class="line">      augment(value, arrayMethods, arrayKeys)<span class="comment">// 将数组的 push 等方法改写为响应式</span></span><br><span class="line">      <span class="keyword">this</span>.observeArray(value)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.walk(value)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  walk (obj: <span class="built_in">Object</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(obj)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</span><br><span class="line">      defineReactive(obj, keys[i], obj[keys[i]])</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  observeArray (items: <span class="built_in">Array</span>&lt;any&gt;) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = items.length; i &lt; l; i++) &#123;</span><br><span class="line">      observe(items[i])</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observe</span> (<span class="params">value: any</span>): <span class="title">Observer</span> | <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!isObject(value)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> ob: Observer | <span class="keyword">void</span></span><br><span class="line">  <span class="keyword">if</span> (hasOwn(value, <span class="string">'__ob__'</span>) &amp;&amp; value.__ob__ <span class="keyword">instanceof</span> Observer) &#123;</span><br><span class="line">    ob = value.__ob__</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">    (<span class="built_in">Array</span>.isArray(value) || isPlainObject(value)) &amp;&amp;</span><br><span class="line">    <span class="built_in">Object</span>.isExtensible(value)</span><br><span class="line">  ) &#123;</span><br><span class="line">    ob = <span class="keyword">new</span> Observer(value)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ob</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineReactive</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  obj: Object,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  val: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  shallow?: boolean</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> dep = <span class="keyword">new</span> Dep()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> property = <span class="built_in">Object</span>.getOwnPropertyDescriptor(obj, key)</span><br><span class="line">  <span class="keyword">if</span> (property &amp;&amp; property.configurable === <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> getter = property &amp;&amp; property.get</span><br><span class="line">  <span class="keyword">const</span> setter = property &amp;&amp; property.set</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> childOb = !shallow &amp;&amp; observe(val)</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(obj, key, &#123;</span><br><span class="line">    enumerable: <span class="literal">true</span>,</span><br><span class="line">    configurable: <span class="literal">true</span>,</span><br><span class="line">    get: <span class="function"><span class="keyword">function</span> <span class="title">reactiveGetter</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> value = getter ? getter.call(obj) : val</span><br><span class="line">      <span class="keyword">if</span> (Dep.target) &#123;</span><br><span class="line">        dep.depend()</span><br><span class="line">        <span class="keyword">if</span> (childOb) &#123;</span><br><span class="line">          childOb.dep.depend()</span><br><span class="line">          <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(value)) &#123;</span><br><span class="line">            dependArray(value)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> value</span><br><span class="line">    &#125;,</span><br><span class="line">    set: <span class="function"><span class="keyword">function</span> <span class="title">reactiveSetter</span> (<span class="params">newVal</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> value = getter ? getter.call(obj) : val</span><br><span class="line">      <span class="keyword">if</span> (newVal === value || (newVal !== newVal &amp;&amp; value !== value)) &#123;<span class="comment">// 更新前后均为 NaN</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (setter) &#123;</span><br><span class="line">        setter.call(obj, newVal)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        val = newVal</span><br><span class="line">      &#125;</span><br><span class="line">      childOb = !shallow &amp;&amp; observe(newVal)</span><br><span class="line">      dep.notify()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上述代码中，数组的依赖(指需要访问数据的订阅函数，即实际的订阅者)更新仍旧基于 Object.defineProperty 方法，可以得知的是，observer 不能单纯地将数组转变为响应式数据，数组必须是某个响应式对象的子属性。因此，vue 中的数据侦测实现不能单独作为类库使用。这在下一节中将作再度说明。</p>
<p>当 observer 实例对应的原始数据为数组时，observer 实例的 dep 属性存在的意义是，用于在 getter 访问器属性中通过该 dep 值(即 childOb.dep.depend)更新依赖，以使数组的 push 等方法执行时，好通过调用 dep.notify 方法，触发订阅函数的执行。同时，Vue 也不支持通过 arr[idx] = item 或 arr.length = len 语句触发订阅函数的调用。</p>
<p>介于 Object.defineProperty 方法只能对存在的属性起作用，Vue 中提供 set(target, key, value), del(target, key) 函数用于实现新增和删除属性同样需要触发订阅函数的场景。针对数组项，调用改写的原型方法 unshift, pop, splice 即可以移除数组项，并触发订阅函数的执行。然而，Vue 中提供的 set, del 函数将调用变异的 splice 方法处理数组，在数组项新增或删除时也触发订阅函数的执行。因此，set(arr, idx, item) 函数可用于代替 arr[idx] = item。</p>
<p>若 set, del 函数为响应式对象，将调用该对象相应的 observer 实例的 dep.notify 方法，也因而，observer 实例的 dep 属性存在的另一层意义是，用于促使 set, del 函数中的 observer.dep.notify 方法调用过程中，唤起订阅函数的执行。更新依赖仍旧在于 getter 访问器属性中的 childOb.dep.depend 方法。</p>
<p><em>代码段 4</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">set</span> (<span class="params">target: Array&lt;any&gt; | Object, key: any, val: any</span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(target) &amp;&amp; isValidArrayIndex(key)) &#123;</span><br><span class="line">    target.length = <span class="built_in">Math</span>.max(target.length, key)</span><br><span class="line">    target.splice(key, <span class="number">1</span>, val)</span><br><span class="line">    <span class="keyword">return</span> val</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (hasOwn(target, key)) &#123;</span><br><span class="line">    target[key] = val</span><br><span class="line">    <span class="keyword">return</span> val</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> ob = (target: any).__ob__</span><br><span class="line">  <span class="keyword">if</span> (!ob) &#123;</span><br><span class="line">    target[key] = val</span><br><span class="line">    <span class="keyword">return</span> val</span><br><span class="line">  &#125;</span><br><span class="line">  defineReactive(ob.value, key, val)</span><br><span class="line">  ob.dep.notify()</span><br><span class="line">  <span class="keyword">return</span> val</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">del</span> (<span class="params">target: Array&lt;any&gt; | Object, key: any</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(target) &amp;&amp; isValidArrayIndex(key)) &#123;</span><br><span class="line">    target.splice(key, <span class="number">1</span>)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> ob = (target: any).__ob__</span><br><span class="line">  hasOwn(target, key)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">delete</span> target[key]</span><br><span class="line">  <span class="keyword">if</span> (!ob) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  ob.dep.notify()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="依赖管理"><a href="#依赖管理" class="headerlink" title="依赖管理"></a>依赖管理</h3><p>参见探讨一节中所示的最后一段代码，每个访问属性及其订阅函数的依赖关系可以通过 SubscriberManager 类加以管理。在 Vue 中，将 SubscriberManager 类分拆为 Dep 和 Watcher 两个类。</p>
<p>其中，Dep 根据对象的每个访问属性、或 Observer 实例(原始数据为对象或数组)，管理其依赖(即订阅函数)，因此，Vue 又将 Dep 实例注释为 observable 监视数据。依赖更新过程通过在 index.js 模块中调用 dep.depend 实现。dep.depend 方法执行过程中，将会调用 Dep.target. depend 方法更新该 dep 实例和 Dep.target(即当前运行中的订阅者 watcher 实例) 的依赖关系，也即更新 watcher.deps 数组(数组项为 Dep 实例)，表示订阅者 watcher 正在监测哪些响应式数据的变更；更新 dep.subs 数组(数组项为 Watcher 实例)，表示监视数据需要把状态更新通知哪些订阅者。这样就建立了 watcher 和 dep 互为引用关系。需要强调的是，更新依赖基于 getter 访问器属性中的 dep.depend 执行语句，getter 访问器又通过显式调用订阅函数才能触发，因此，在 Watcher 类的实现中，以 expOrFn 入参形式设定的订阅函数需要在响应式数据更新前得到调用，这也就是为什么在 Vue 中 Watcher 构造函数中会执行 this.get 方法的原因了。</p>
<p>因为实际的开发者可能嵌套两个以上订阅函数，所以 Vue 中使用 targetStack 以堆栈形式存储 Dep.target，以使嵌套调用的两个订阅函数中，后一个订阅函数执行完成后，将 Dep.target 回滚到前一个订阅函数的相关 Watcher 实例。</p>
<p><em>代码段 5</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// observer/dep.js</span></span><br><span class="line"><span class="keyword">let</span> uid = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dep</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> target: ?Watcher;</span><br><span class="line">  id: number;</span><br><span class="line">  subs: <span class="built_in">Array</span>&lt;Watcher&gt;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span> () &#123;</span><br><span class="line">    <span class="keyword">this</span>.id = uid++</span><br><span class="line">    <span class="keyword">this</span>.subs = []</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  addSub (sub: Watcher) &#123;</span><br><span class="line">    <span class="keyword">this</span>.subs.push(sub)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  removeSub (sub: Watcher) &#123;</span><br><span class="line">    remove(<span class="keyword">this</span>.subs, sub)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  depend () &#123;</span><br><span class="line">    <span class="keyword">if</span> (Dep.target) &#123;</span><br><span class="line">      Dep.target.addDep(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  notify () &#123;</span><br><span class="line">    <span class="keyword">const</span> subs = <span class="keyword">this</span>.subs.slice()</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = subs.length; i &lt; l; i++) &#123;</span><br><span class="line">      subs[i].update()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 针对嵌套使用订阅函数的场景</span></span><br><span class="line">Dep.target = <span class="literal">null</span></span><br><span class="line"><span class="keyword">const</span> targetStack = []</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">pushTarget</span> (<span class="params">_target: Watcher</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (Dep.target) targetStack.push(Dep.target)</span><br><span class="line">  Dep.target = _target</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">popTarget</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  Dep.target = targetStack.pop()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>如前文所述，在 Vue 中，Watcher 构造函数的参数 expOrFn 为实际的订阅函数，而参数 cb 为响应式数据变更后待执行的回调函数，expOrFn 决定 cb 关联哪些响应式数据或其监测属性。</p>
<p>在 Watcher 类的实现中，参数 expOrFn 将被包装为 watcher.getter 方法，执行时以 vm 为上下文及首参，并通过 watcher.get 方法调用。watcher.get 方法的主要流程为，在 watcher.getter 执行前，通过 pushTarget(this) 将 Dep.target 赋值为当前的 watcher 实例，以使 dep.depend 方法执行过程中可以更新 watcher.deps 及 dep.subs 依赖；在 watcher.getter 执行后，通过调用 popTarget 函数释放 Dep.target，并调用 watcher 实例的 cleanupDeps 方法重置依赖。参数 expOrFn 可以是以 ‘.’ 分割的键名或普通函数。前者用于获取入参 vm 的深层属性，并作为返回值，意味着该属性及其祖先属性的更新将引起 cb 函数的执行(当返回值为复杂结构属性，可通过传参 options.deep 监测其子属性的更新，其实现原理是，利用 traverse 函数访问 watcher.getter 方法返回值的子孙属性或数组项，以此刷新依赖)；后者通过访问响应式数据 this 或首参 vm 的属性更新依赖，允许用户在 expOrFn 函数中自定义需要侦测哪个响应式数据的变更。</p>
<p>watcher 实例的依赖更新过程为，addDep 方法将新增的 dep 实例(通过和 newDepIds 比较判断新增与否)添加到 newDeps, newDepIds 中，所包含的 dep 实例为订阅函数执行过程中访问的响应式数据及其监测属性的相关 dep；cleanupDeps 方法将 newDeps, newDepIds 赋值给 deps, depIds，并置空 newDeps, newDepIds，即 newDeps, newDepIds 仅保留本次订阅函数执行过程中 dep 依赖，针对场景如订阅函数中使用条件语句变更访问的响应式数据等。</p>
<p>可以看见的是，Vue 更新 dep 和 watcher 的依赖关系都基于实际访问函数 expOrFn 的执行过程，却没法感知订阅函数的存在与否，这就造成了一个问题，当订阅函数删除时，dep.subs 中仍会有该订阅函数的相关 watcher 实例，这将促使订阅函数在响应式数据更新时再度执行。为此，Vue 提供了 watcher.teardown 实例方法，通过显式调用，能将当前 watcher 实例从 dep.subs 及 vm._watchers 数组中剔除掉。watcher.teardown 执行过程中，将this.active 标识符置为否，针对异步更新响应式数据过程时、手动调用 watcher.teardown 方法移除订阅函数的场景。而 watcher.depend 实例方法用于显式更新关联 dep 实例的依赖，即将当前 watcher 实例添加到各关联 dep.subs 数组中。</p>
<p>上述说明的 Watcher 类如下：</p>
<p><em>代码段 6</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> uid = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">  vm: Component;</span><br><span class="line">  expression: string;</span><br><span class="line">  cb: <span class="built_in">Function</span>;</span><br><span class="line">  id: number;</span><br><span class="line">  active: boolean;</span><br><span class="line">  deps: <span class="built_in">Array</span>&lt;Dep&gt;;</span><br><span class="line">  newDeps: <span class="built_in">Array</span>&lt;Dep&gt;;</span><br><span class="line">  depIds: ISet;</span><br><span class="line">  newDepIds: ISet;</span><br><span class="line">  getter: <span class="built_in">Function</span>;</span><br><span class="line">  value: any;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span> (</span><br><span class="line">    vm: Component,</span><br><span class="line">    expOrFn: string | Function,</span><br><span class="line">    cb: Function,</span><br><span class="line">    options?: Object</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">this</span>.vm = vm</span><br><span class="line">    vm._watchers.push(<span class="keyword">this</span>)</span><br><span class="line">    <span class="keyword">if</span> (options) &#123;</span><br><span class="line">      <span class="keyword">this</span>.deep = !!options.deep</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.deep = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.cb = cb</span><br><span class="line">    <span class="keyword">this</span>.id = ++uid <span class="comment">// uid for batching</span></span><br><span class="line">    <span class="keyword">this</span>.active = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">this</span>.deps = []</span><br><span class="line">    <span class="keyword">this</span>.newDeps = []</span><br><span class="line">    <span class="keyword">this</span>.depIds = <span class="keyword">new</span> <span class="built_in">Set</span>()</span><br><span class="line">    <span class="keyword">this</span>.newDepIds = <span class="keyword">new</span> <span class="built_in">Set</span>()</span><br><span class="line">    <span class="keyword">this</span>.expression = process.env.NODE_ENV !== <span class="string">'production'</span></span><br><span class="line">      ? expOrFn.toString()</span><br><span class="line">      : <span class="string">''</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> expOrFn === <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.getter = expOrFn</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.getter = parsePath(expOrFn)</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.getter) &#123;</span><br><span class="line">        <span class="keyword">this</span>.getter = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line">        process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; warn(</span><br><span class="line">          <span class="string">`Failed watching path: "<span class="subst">$&#123;expOrFn&#125;</span>" `</span> +</span><br><span class="line">          <span class="string">'Watcher only accepts simple dot-delimited paths. '</span> +</span><br><span class="line">          <span class="string">'For full control, use a function instead.'</span>,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.value = <span class="keyword">this</span>.get()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  get () &#123;</span><br><span class="line">    pushTarget(<span class="keyword">this</span>)</span><br><span class="line">    <span class="keyword">let</span> value</span><br><span class="line">    <span class="keyword">const</span> vm = <span class="keyword">this</span>.vm</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      value = <span class="keyword">this</span>.getter.call(vm, vm)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> e</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.deep) &#123;</span><br><span class="line">        traverse(value)<span class="comment">// 通过访问复杂结构数据 value 的子孙属性及数组项，实现依赖刷新</span></span><br><span class="line">      &#125;</span><br><span class="line">      popTarget()</span><br><span class="line">      <span class="keyword">this</span>.cleanupDeps()</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> value</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  addDep (dep: Dep) &#123;</span><br><span class="line">    <span class="keyword">const</span> id = dep.id</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.newDepIds.has(id)) &#123;</span><br><span class="line">      <span class="keyword">this</span>.newDepIds.add(id)</span><br><span class="line">      <span class="keyword">this</span>.newDeps.push(dep)</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.depIds.has(id)) &#123;</span><br><span class="line">        dep.addSub(<span class="keyword">this</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  cleanupDeps () &#123;</span><br><span class="line">    <span class="keyword">let</span> i = <span class="keyword">this</span>.deps.length</span><br><span class="line">    <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">      <span class="keyword">const</span> dep = <span class="keyword">this</span>.deps[i]</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.newDepIds.has(dep.id)) &#123;</span><br><span class="line">        dep.removeSub(<span class="keyword">this</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> tmp = <span class="keyword">this</span>.depIds</span><br><span class="line">    <span class="keyword">this</span>.depIds = <span class="keyword">this</span>.newDepIds</span><br><span class="line">    <span class="keyword">this</span>.newDepIds = tmp</span><br><span class="line">    <span class="keyword">this</span>.newDepIds.clear()</span><br><span class="line">    tmp = <span class="keyword">this</span>.deps</span><br><span class="line">    <span class="keyword">this</span>.deps = <span class="keyword">this</span>.newDeps</span><br><span class="line">    <span class="keyword">this</span>.newDeps = tmp</span><br><span class="line">    <span class="keyword">this</span>.newDeps.length = <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  update () &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.active) &#123;</span><br><span class="line">      <span class="keyword">const</span> value = <span class="keyword">this</span>.get()</span><br><span class="line">      <span class="keyword">const</span> oldValue = <span class="keyword">this</span>.value</span><br><span class="line">      <span class="keyword">this</span>.cb.call(<span class="keyword">this</span>.vm, value, oldValue)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  depend () &#123;</span><br><span class="line">    <span class="keyword">let</span> i = <span class="keyword">this</span>.deps.length</span><br><span class="line">    <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">      <span class="keyword">this</span>.deps[i].depend()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  teardown () &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.active) &#123;</span><br><span class="line">      remove(<span class="keyword">this</span>.vm._watchers, <span class="keyword">this</span>)</span><br><span class="line">      <span class="keyword">let</span> i = <span class="keyword">this</span>.deps.length</span><br><span class="line">      <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">        <span class="keyword">this</span>.deps[i].removeSub(<span class="keyword">this</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.active = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上述代码存在的问题：</p>
<p><em>问题清单 3</em></p>
<ol>
<li>每次响应式数据变更时，都会唤起订阅函数的执行，如一前一后分别改变 <strong>firstname</strong> 和 <strong>secondname</strong> 将会两次调用 <strong>getFullname</strong> 函数。有没有办法何必更新，只触发调用 <em>derivations</em> 执行一次呢？</li>
<li>订阅函数的执行时机由响应式数据有否更新决定。当开发者使用 <strong>computed</strong> 选项声明了一个计算属性，无论他有没有实际使用这个计算属性，当数据更新时，仍会触发 <strong>computed</strong> 方法的执行，这是不必要的。该问题的一般意义是，怎样只注册订阅函数，而订阅函数的执行时机仍由开发者决定，该订阅函数执行时，又能获取到更新后的数据？</li>
<li>作为 <em>derivations</em> 的 <strong>watcher.getter</strong> 兼有 <em>action</em> 更新响应式数据的能力，因其以响应式数据 <em>observale</em> 为执行上下文。用户可以在传入的 <strong>expOrFn</strong> 函数中使用 <strong>this[key] = value</strong> 语句唤起订阅函数的执行，该过程将再次调用 <strong>expOrFn</strong> 函数中的赋值语句，若 <strong>value</strong> 值每次都在改变（如赋值为 <strong>Math.random()</strong>），将造成死循环。</li>
</ol>
<p><em>解决方案 3</em></p>
<ol>
<li>针对 <em>问题 1</em>，可以将与当前触发本次响应式数据变更的 <em>action</em> 函数的所有相关 <strong>watcher</strong> 依赖添加到队列中，等待 <em>action</em> 执行完成后，再取出 <strong>watcher</strong> 实例加以执行。当然，这样处理存在的问题是，多个 <em>action</em> 更新同一份数据时，仍会造成订阅函数执行多次。在 Vue 的实现中，<strong>watcher</strong> 实例由 nextTick 函数添加到异步队列中，在主线程任务跑完后，才会执行异步队里中的 <strong>watcher</strong> 实例，而不是等待当前的 <em>action</em> 执行完成。这样处理的意义也解决了另一个问题，<em>Vue</em> 可以在模板中使用 <em>js</em> 语句更新响应式数据，这会造成承载着重绘职责的 <strong>watcher</strong> 实例变成深度嵌套结构。使用 nextTick 函数后，须等待前一个重绘流程完成，再执行下一个重绘流程。关于这部分内容，将在下一节再度予以分析。Vue 默认将 <strong>watcher</strong> 添加到异步队列中，与之平级的还有 <strong>lazy, sync</strong> 模式。顾名思义，<strong>sync</strong> 模式指，响应式数据变更后，当即触发订阅函数的执行。</li>
<li>针对 <em>问题 2</em>，Vue 中提供了 <em>lazy</em> 模式，通过传参 options.lazy = true 设置。该模式下，在响应式数据更新后，只引起 watcher.dirty 状态被置为 true，触发 watcher.get 方法需要主动调用 watcher.evaluate 方法。在 watcher.evaluate 方法执行过程中，watcher.getter 方法的返回值将存储在 watcher.value 中，由此对外提供访问属性，用于获取新的计算值。可以想见，使用 <em>lazy</em> 模式也能处理同一个 <em>action</em> 函数更新多个响应式数据、触发订阅函数执行多次的 <em>问题 1</em>。Vue 中的计算属性即基于 lazy 模式实现，即在视图更新时访问计算属性，以此主动调用 watcher.evaluate 方法，<strong>firstname</strong> 和 <strong>secondname</strong> 属性的前后变更都只将触发 <strong>getFullname</strong> 执行一次，而更新 watcher.dirty 状态的动作仍会执行两次。关于计算属性相关内容，将在下一节 <em>Vue 应用</em> 中予以再次分析。</li>
<li>异步队列仅能解决同一个 <em>action</em> 更新多个响应式数据引起的订阅函数执行多次的问题，但是，不能用于处理同一个 <em>action</em> 反复更新同一个响应式数据引起的死循环。对于 <em>问题 3</em> 中的特例 – 使用 lazy 模式处理的计算属性，响应式数据变更时实际触发的动作只是将 watcher.dirty 置为真值，而没有调用 <strong>watcher.getter</strong> 方法，<em>derivations</em> 并不兼有 <em>action</em> 更新响应式数据的能力，也就不会引起死循环问题。对于没有采用 <em>lazy</em> 模式的 <strong>watcher</strong> 实例，当监测中的响应式数据前后相继更新时，其 <strong>watcher.getter</strong> 方法仍会执行多次，而由外部传入的 <strong>expOrFn</strong> 函数以及 <strong>cb</strong> 回调也会执行多次。这也是 Vue 实例中 watch 选项存在的问题。当 watch 选项中某方法将关联的响应式属性赋值为 <strong>Math.random()</strong> 时，会引起死循环。参考计算属性的实现，订阅函数单次执行的场景，也许可使用 <strong>vue.$watch(expOrFn, null, { lazy: true })</strong> 处理，这也将在下一节予以分析。</li>
</ol>
<p><em>解决方案 3</em> 是不完全的，需要开发者遵从一种规约，譬如变异数组不能通过 <strong>arr[index] = item</strong> 语句触发订阅函数的执行一样。通过计算属性这个特例，也可以发现，在 Vue 使用过程中，需注意区分参数 expOrFn 及 cb 的职责。非 lazy 模式下，expOrFn 主要用于引导订阅者 watcher 监测哪些响应式数据变更，定位监测数据通过在函数形式 expOrFn 使用 this 关键字访问数据，或者通过键路径形式的 expOrFn 设定观察属性，或者通过 options.deep 选项监测两者的返回值。cb 仅在非 lazy 模式下使用，作为回调函数，有可能在响应式数据变更后执行。Vue 为 cb 设定的执行条件为，watcher.getter 方法返回值与原有值不等，或返回了对象，或 options.deep 为真值。这样的条件，也未见逻辑上的妥帖。非 lazy 模式下，在 expOrFn 中作除依赖收集之外的处理时须谨慎。lazy 模式下，cb 回调没有机会得到触发执行（除非 Vue 对外暴露 watcher 实例，可以显示调用 watcher.run 方法），expOrFn 的执行时机由 observer 模块的使用者调用 watcher.evaluate 方法决定（非 lazy 模式由 Vue 决定其执行时机）。计算属性这个特例就使用了 lazy 模式，expOrFn 的返回值用于更新 watcher.value 并输出。非 lazy 模式或 lazy 模式下，都需要避免在 expOrFn 或 cb 中修改响应式数据（cb 同样以全量的 observable 为执行上下文），以免再次触发订阅函数的执行。当然，若足够 Vue 实现的原理，在 expOrFn 或 cb 中修改响应式数据也许能开启某些黑魔法，这些黑魔法也可能因为 Vue 版本的升级而惨遭淘汰。</p>
<p>在 Vue 中，Watcher 实例化过程还接受 user 选项，用于判断当前 watcher 实例是 Vue 内建的，还是来自于开发者。而当 user 选项置真值时，Vue 只负责校验 expOrFn 键路径能否正确取值或者函数能否正确执行，而没有包含依赖关系的梳理、死循环的避免等等。</p>
<p>为实现 lazy, sync 模式，<em>代码段 3</em> 中 update 方法将被拆解为 update, run 方法。update 方法用于判断当前使用的模式，run 方法调用 watcher.get 更新依赖，再执行 cb 回调。</p>
<p><em>代码段 4</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; queueWatcher &#125; <span class="keyword">from</span> <span class="string">'./scheduler'</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  user: boolean;</span><br><span class="line">  lazy: boolean;</span><br><span class="line">  dirty: boolean;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">constructor</span> (</span><br><span class="line">    vm: Component,</span><br><span class="line">    expOrFn: string | Function,</span><br><span class="line">    cb: Function,</span><br><span class="line">    options?: Object</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options) &#123;</span><br><span class="line">      <span class="keyword">this</span>.user = !!options.user</span><br><span class="line">      <span class="keyword">this</span>.lazy = !!options.lazy</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.user = <span class="keyword">this</span>.lazy = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.value = <span class="keyword">this</span>.lazy</span><br><span class="line">      ? <span class="literal">undefined</span></span><br><span class="line">      : <span class="keyword">this</span>.get()<span class="comment">// 当即执行，收集 watcher 观察的响应式数据，建立依赖关系</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  update()&#123;</span><br><span class="line">    <span class="keyword">if</span> ( <span class="keyword">this</span>.lazy )&#123;</span><br><span class="line">      <span class="keyword">this</span>.dirty = <span class="literal">true</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.sync) &#123;</span><br><span class="line">      <span class="keyword">this</span>.run()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      queueWatcher(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  run () &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.active) &#123;</span><br><span class="line">      <span class="keyword">const</span> value = <span class="keyword">this</span>.get()</span><br><span class="line">      <span class="keyword">if</span> (</span><br><span class="line">        value !== <span class="keyword">this</span>.value ||</span><br><span class="line">        isObject(value) ||</span><br><span class="line">        <span class="keyword">this</span>.deep</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="keyword">const</span> oldValue = <span class="keyword">this</span>.value</span><br><span class="line">        <span class="keyword">this</span>.value = value</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.user) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.cb.call(<span class="keyword">this</span>.vm, value, oldValue)</span><br><span class="line">          &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">            handleError(e, <span class="keyword">this</span>.vm, <span class="string">`callback for watcher "<span class="subst">$&#123;<span class="keyword">this</span>.expression&#125;</span>"`</span>)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">this</span>.cb.call(<span class="keyword">this</span>.vm, value, oldValue)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="调度器"><a href="#调度器" class="headerlink" title="调度器"></a>调度器</h4><p><em>代码段 4</em> 中的 <strong>queueWatcher</strong> 函数由 <strong>scheduler</strong> 模块提供。<strong>scheduler</strong> 模块通过 <strong>nextTick</strong> 函数将 <strong>watcher</strong> 添加到异步队列中，等待主线程任务执行完成后，再予以执行 <strong>watcher.run</strong> 方法。</p>
<p><strong>scheduler</strong> 模块主要逻辑为当主线程任务尚在执行过程中，将 <strong>watcher</strong> 实例添加到 <strong>queue</strong> 异步队列中；若异步队列已经开始执行，则将 <strong>watcher</strong> 按 <strong>id</strong> 顺序添加 <strong>queue</strong> 队列中。特殊情况是，若在 <strong>watcher</strong> 中更新响应式数据，触发当前 <strong>watcher</strong> 再度被添加到异步队列中、并等待执行，即如 <em>问题清单 3</em> 中 <em>问题 3</em> 中的描述，通过 <strong>circular</strong> 记录当前 <strong>watcher</strong> 执行次数，若超过 <strong>MAX_UPDATE_COUNT</strong> 个数，予以警告提示。</p>
<p>异步队列中，<strong>watcher</strong> 实例的执行顺序以 <strong>watcher</strong>实例的创建顺序为准，通过 <strong>watcher.id</strong> 判断，主要目的是保证组价的重绘动作放在响应式数据更新时尾端，同时保证父子组件的重绘顺序，这部分内容，将在下一节予以分析。</p>
<p><em>代码段 5</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> MAX_UPDATE_COUNT = <span class="number">100</span><span class="comment">// 开发环境同一个 watcher 在单次异步队列中最大执行次数</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> queue: <span class="built_in">Array</span>&lt;Watcher&gt; = []</span><br><span class="line"><span class="keyword">let</span> has: &#123; [key: number]: ?<span class="literal">true</span> &#125; = &#123;&#125;</span><br><span class="line"><span class="keyword">let</span> circular: &#123; [key: number]: number &#125; = &#123;&#125;</span><br><span class="line"><span class="keyword">let</span> waiting = <span class="literal">false</span><span class="comment">// 异步队列等待执行中状态标识</span></span><br><span class="line"><span class="keyword">let</span> flushing = <span class="literal">false</span><span class="comment">// 异步队列执行中状态标识</span></span><br><span class="line"><span class="keyword">let</span> index = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">resetSchedulerState</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  index = queue.length = <span class="number">0</span></span><br><span class="line">  has = &#123;&#125;</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    circular = &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  waiting = flushing = <span class="literal">false</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushSchedulerQueue</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  flushing = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">let</span> watcher, id</span><br><span class="line"></span><br><span class="line">  queue.sort(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a.id - b.id)<span class="comment">// watcher 重排序</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (index = <span class="number">0</span>; index &lt; queue.length; index++) &#123;</span><br><span class="line">    watcher = queue[index]</span><br><span class="line">    id = watcher.id</span><br><span class="line">    has[id] = <span class="literal">null</span></span><br><span class="line">    watcher.run()</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; has[id] != <span class="literal">null</span>) &#123;</span><br><span class="line">      circular[id] = (circular[id] || <span class="number">0</span>) + <span class="number">1</span></span><br><span class="line">      <span class="keyword">if</span> (circular[id] &gt; MAX_UPDATE_COUNT) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          <span class="string">'You may have an infinite update loop '</span> + (</span><br><span class="line">            watcher.user</span><br><span class="line">              ? <span class="string">`in watcher with expression "<span class="subst">$&#123;watcher.expression&#125;</span>"`</span></span><br><span class="line">              : <span class="string">`in a component render function.`</span></span><br><span class="line">          ),</span><br><span class="line">          watcher.vm</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  resetSchedulerState()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">queueWatcher</span> (<span class="params">watcher: Watcher</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> id = watcher.id</span><br><span class="line">  <span class="keyword">if</span> (has[id] == <span class="literal">null</span>) &#123;</span><br><span class="line">    has[id] = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 主线程尚在执行中</span></span><br><span class="line">    <span class="keyword">if</span> (!flushing) &#123;</span><br><span class="line">      queue.push(watcher)</span><br><span class="line">    <span class="comment">// 异步队列开始执行</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> i = queue.length - <span class="number">1</span></span><br><span class="line">      <span class="keyword">while</span> (i &gt; index &amp;&amp; queue[i].id &gt; watcher.id) &#123;</span><br><span class="line">        i--</span><br><span class="line">      &#125;</span><br><span class="line">      queue.splice(i + <span class="number">1</span>, <span class="number">0</span>, watcher)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!waiting) &#123;</span><br><span class="line">      waiting = <span class="literal">true</span></span><br><span class="line">      nextTick(flushSchedulerQueue)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="Vue-应用"><a href="#Vue-应用" class="headerlink" title="Vue 应用"></a>Vue 应用</h2><p>创建 <em>Vue</em> 实例（下文中 <strong>vm</strong> 即指 <em>Vue</em> 实例）过程中，调用 <strong>observe</strong> 包的模块主要包含 <strong>core/instance</strong> 目录下的 <strong>state, inject, lifecycle</strong> 模块。<strong>state</strong> 模块用于将 Vue 选项 <strong>prop, data, methods, computed, watch</strong> 注入数据侦测功能，并导出数据侦测功能相关的实例属性或方法如 <strong>$props, $data, $set, $del, $watch</strong>。<strong>inject</strong>模块用于将 Vue 选项 <strong>inject</strong> 注入数据侦测功能。<strong>lifecycle</strong> 模块用于将 <strong>updateComponent</strong> 组件更新函数绑定为订阅函数。</p>
<h3 id="prop-data-methods-computed-watch"><a href="#prop-data-methods-computed-watch" class="headerlink" title="prop, data, methods, computed, watch"></a>prop, data, methods, computed, watch</h3><p>注入 Vue 实例且与数据侦测功能相关的选项包含 prop, data, methods, computed, watch。其中 props 为父组件传入的属性或方法，data 将转化为实际的响应式数据，methods 为影响响应式数据变更的 action，computed 为响应式数据变更后执行的计算函数，watch 为响应式数据变更后执行的副作用函数。props, data, methods, computed 均将通过代理导出为 Vue 实例的实例属性或方法，意味着 props, data, methods, computed 中的属性或方法名不能相重，Vue 实例代理的优先级为 props, methods，data, computed。</p>
<p><em>代码段 6</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">proxy</span> (<span class="params">target: Object, sourceKey: string, key: string</span>) </span>&#123;</span><br><span class="line">  sharedPropertyDefinition.get = <span class="function"><span class="keyword">function</span> <span class="title">proxyGetter</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>[sourceKey][key]</span><br><span class="line">  &#125;</span><br><span class="line">  sharedPropertyDefinition.set = <span class="function"><span class="keyword">function</span> <span class="title">proxySetter</span> (<span class="params">val</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>[sourceKey][key] = val</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(target, key, sharedPropertyDefinition)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// initState 函数将在 Vue 实例化过程中通过 _init 实例方法得到执行</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initState</span> (<span class="params">vm: Component</span>) </span>&#123;</span><br><span class="line">  vm._watchers = []</span><br><span class="line">  <span class="keyword">const</span> opts = vm.$options</span><br><span class="line">  <span class="keyword">if</span> (opts.props) initProps(vm, opts.props)</span><br><span class="line">  <span class="keyword">if</span> (opts.methods) initMethods(vm, opts.methods)</span><br><span class="line">  <span class="keyword">if</span> (opts.data) &#123;</span><br><span class="line">    initData(vm)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    observe(vm._data = &#123;&#125;, <span class="literal">true</span> <span class="comment">/* asRootData */</span>)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (opts.computed) initComputed(vm, opts.computed)</span><br><span class="line">  <span class="comment">// Firefox 中，普通对象含有 watch 原型方法，nativeWatch 即该原型方法</span></span><br><span class="line">  <span class="keyword">if</span> (opts.watch &amp;&amp; opts.watch !== nativeWatch) &#123;</span><br><span class="line">    initWatch(vm, opts.watch)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><em>代码段 6</em> 中，<strong>initState</strong> 函数将在 <em>Vue</em> 实例化过程中通过 <strong>vm._init</strong> 实例方法得到执行，其中，<strong>initProps, initMethods, initData, initComputed, initWatch</strong> 分别对 <strong>props, data, methods, computed, watch</strong> 选项进行处理操作。<strong>proxy</strong> 函数提供通过 <strong>vm</strong> 代理取值和赋值的功能。</p>
<h4 id="props"><a href="#props" class="headerlink" title="props"></a>props</h4><p><em>代码段 7</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initProps</span> (<span class="params">vm: Component, propsOptions: Object</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> propsData = vm.$options.propsData || &#123;&#125;</span><br><span class="line">  <span class="keyword">const</span> props = vm._props = &#123;&#125;</span><br><span class="line">  <span class="keyword">const</span> keys = vm.$options._propKeys = []<span class="comment">// 辅助遍历</span></span><br><span class="line">  <span class="keyword">const</span> isRoot = !vm.$parent</span><br><span class="line">  observerState.shouldConvert = isRoot</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> propsOptions) &#123;</span><br><span class="line">    keys.push(key)</span><br><span class="line">    <span class="keyword">const</span> value = validateProp(key, propsOptions, propsData, vm)</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> hyphenatedKey = hyphenate(key)</span><br><span class="line">      <span class="keyword">if</span> (isReservedAttribute(hyphenatedKey) ||</span><br><span class="line">          config.isReservedAttr(hyphenatedKey)) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          <span class="string">`"<span class="subst">$&#123;hyphenatedKey&#125;</span>" is a reserved attribute and cannot be used as component prop.`</span>,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      defineReactive(props, key, value, () =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (vm.$parent &amp;&amp; !isUpdatingChildComponent) &#123;</span><br><span class="line">          warn(</span><br><span class="line">            <span class="string">`Avoid mutating a prop directly since the value will be `</span> +</span><br><span class="line">            <span class="string">`overwritten whenever the parent component re-renders. `</span> +</span><br><span class="line">            <span class="string">`Instead, use a data or computed property based on the prop's `</span> +</span><br><span class="line">            <span class="string">`value. Prop being mutated: "<span class="subst">$&#123;key&#125;</span>"`</span>,</span><br><span class="line">            vm</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      defineReactive(props, key, value)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!(key <span class="keyword">in</span> vm)) &#123;</span><br><span class="line">      proxy(vm, <span class="string">`_props`</span>, key)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  observerState.shouldConvert = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stateMixin</span> (<span class="params">Vue: Class&lt;Component&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> propsDef = &#123;&#125;</span><br><span class="line">  propsDef.get = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>._props &#125;</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    propsDef.set = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      warn(<span class="string">`$props is readonly.`</span>, <span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(Vue.prototype, <span class="string">'$props'</span>, propsDef)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><em>代码段 7</em> 中，通过 <strong>defineReactive</strong> 函数监测从父组件传入的 <strong>props</strong> 变更，该变更过程发生在更新子组件时，见于 <strong>core/instance/lifecycle.js</strong> 模块中的 <strong>updateChildComponent</strong> 函数。当渲染的是顶层根节点时，将 <strong>observerState.shouldConvert</strong> 标识符置为真值，意味着当顶层根节点的 <strong>props</strong> 子属性为复杂结构数据且不是响应式数据时，将其转换为响应式数据。当渲染的是其他节点是，<strong>props</strong> 子属性保持原有的数据状态，即其传入响应式数据，则输出响应式数据；传入普通数据，则输出普通数据。因为 <strong>props</strong> 是响应式数据，<em>Vue</em> 在开发环境下提示使用者修改 <strong>props</strong> 须谨慎。通过 <strong>stateMixin</strong> 函数导出的 <strong>vm.$props</strong> 在开发环境也是只读的。但用户仍可以修改 <strong>vm.$props</strong> 的子属性。</p>
<p>同时，<em>代码段 7</em> 中 observe 函数改写为 <em>代码段 7</em> 中形式，添加 <strong>observerState.shouldConvert</strong> 标识符阻止将子组件获得的 props 子属性转变为 Observer 实例。</p>
<p><em>代码段 8</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> observerState = &#123;</span><br><span class="line">  shouldConvert: <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">observe</span> (<span class="params">value: any</span>): <span class="title">Observer</span> | <span class="title">void</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!isObject(value)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">let</span> ob: Observer | <span class="keyword">void</span></span><br><span class="line">  <span class="keyword">if</span> (hasOwn(value, <span class="string">'__ob__'</span>) &amp;&amp; value.__ob__ <span class="keyword">instanceof</span> Observer) &#123;</span><br><span class="line">    ob = value.__ob__</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">    observerState.shouldConvert &amp;&amp;<span class="comment">// 阻止将子组件获得的 props 子属性转变为 Observer 实例</span></span><br><span class="line">    (<span class="built_in">Array</span>.isArray(value) || isPlainObject(value)) &amp;&amp;</span><br><span class="line">    <span class="built_in">Object</span>.isExtensible(value) &amp;&amp;</span><br><span class="line">    !value._isVue<span class="comment">// 排除 Vue 实例</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    ob = <span class="keyword">new</span> Observer(value)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ob</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h4 id="data"><a href="#data" class="headerlink" title="data"></a>data</h4><p><em>代码段 9</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getData</span> (<span class="params">data: Function, vm: Component</span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> data.call(vm, vm)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    handleError(e, vm, <span class="string">`data()`</span>)</span><br><span class="line">    <span class="keyword">return</span> &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initData</span> (<span class="params">vm: Component</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> data = vm.$options.data</span><br><span class="line">  data = vm._data = <span class="keyword">typeof</span> data === <span class="string">'function'</span></span><br><span class="line">    ? getData(data, vm)</span><br><span class="line">    : data || &#123;&#125;</span><br><span class="line">  <span class="keyword">if</span> (!isPlainObject(data)) &#123;</span><br><span class="line">    data = &#123;&#125;</span><br><span class="line">    process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; warn(</span><br><span class="line">      <span class="string">'data functions should return an object:\n'</span> +</span><br><span class="line">      <span class="string">'https://vuejs.org/v2/guide/components.html#data-Must-Be-a-Function'</span>,</span><br><span class="line">      vm</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(data)</span><br><span class="line">  <span class="keyword">const</span> props = vm.$options.props</span><br><span class="line">  <span class="keyword">const</span> methods = vm.$options.methods</span><br><span class="line">  <span class="keyword">let</span> i = keys.length</span><br><span class="line">  <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = keys[i]</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (methods &amp;&amp; hasOwn(methods, key)) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          <span class="string">`Method "<span class="subst">$&#123;key&#125;</span>" has already been defined as a data property.`</span>,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (props &amp;&amp; hasOwn(props, key)) &#123;</span><br><span class="line">      process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; warn(</span><br><span class="line">        <span class="string">`The data property "<span class="subst">$&#123;key&#125;</span>" is already declared as a prop. `</span> +</span><br><span class="line">        <span class="string">`Use prop default value instead.`</span>,</span><br><span class="line">        vm</span><br><span class="line">      )</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isReserved(key)) &#123;</span><br><span class="line">      proxy(vm, <span class="string">`_data`</span>, key)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 将 data 转变为响应式数据</span></span><br><span class="line">  observe(data, <span class="literal">true</span> <span class="comment">/* asRootData */</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stateMixin</span> (<span class="params">Vue: Class&lt;Component&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> dataDef = &#123;&#125;</span><br><span class="line">  dataDef.get = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>._data &#125;</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    dataDef.set = <span class="function"><span class="keyword">function</span> (<span class="params">newData: Object</span>) </span>&#123;</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">'Avoid replacing instance root $data. '</span> +</span><br><span class="line">        <span class="string">'Use nested data properties instead.'</span>,</span><br><span class="line">        <span class="keyword">this</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(Vue.prototype, <span class="string">'$data'</span>, dataDef)</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><em>代码段 9</em> 中，通过 <strong>observe</strong> 函数将 <strong>data</strong> 选项转变为响应式数据。<strong>data</strong> 选项可以是对象或函数形式，当其为函数时，可以通过上下文或首参 <em>Vue</em> 实例获取从父组件注入的 <strong>props</strong>。<strong>initData</strong> 函数中，通过代理将 data 导出为 <em>Vue</em> 实例的属性，开发者也可以通过 <strong>vm._data</strong> 或 <strong>vm.$data</strong> 获取全量数据。</p>
<h4 id="methods"><a href="#methods" class="headerlink" title="methods"></a>methods</h4><p><em>代码段 10</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initMethods</span> (<span class="params">vm: Component, methods: Object</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> props = vm.$options.props</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> methods) &#123;</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (methods[key] == <span class="literal">null</span>) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          <span class="string">`Method "<span class="subst">$&#123;key&#125;</span>" has an undefined value in the component definition. `</span> +</span><br><span class="line">          <span class="string">`Did you reference the function correctly?`</span>,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (props &amp;&amp; hasOwn(props, key)) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          <span class="string">`Method "<span class="subst">$&#123;key&#125;</span>" has already been defined as a prop.`</span>,</span><br><span class="line">          vm</span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> ((key <span class="keyword">in</span> vm) &amp;&amp; isReserved(key)) &#123;</span><br><span class="line">        warn(</span><br><span class="line">          <span class="string">`Method "<span class="subst">$&#123;key&#125;</span>" conflicts with an existing Vue instance method. `</span> +</span><br><span class="line">          <span class="string">`Avoid defining component methods that start with _ or $.`</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    vm[key] = methods[key] == <span class="literal">null</span> ? noop : bind(methods[key], vm)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对 <strong>methods</strong> 选项的处理无他，也就是将 <em>Vue</em> 实例作为其执行上下文。methods 作为更新响应式数据的 <em>action</em>，仍是开发者需要遵从的一种规则。通过 <strong>methods</strong> 各方法对 <em>Vue</em> 实例中的响应式数据执行赋值操作，既可以触发订阅函数的执行。也可以通过直接赋值 <strong>vm.$data</strong> 的子属性触发订阅函数的执行，但不推荐。</p>
<h4 id="computed"><a href="#computed" class="headerlink" title="computed"></a>computed</h4><p><em>代码段 11</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> computedWatcherOptions = &#123; <span class="attr">lazy</span>: <span class="literal">true</span> &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initComputed</span> (<span class="params">vm: Component, computed: Object</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> watchers = vm._computedWatchers = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> computed) &#123;</span><br><span class="line">    <span class="keyword">const</span> userDef = computed[key]</span><br><span class="line">    <span class="keyword">const</span> getter = <span class="keyword">typeof</span> userDef === <span class="string">'function'</span> ? userDef : userDef.get</span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp; getter == <span class="literal">null</span>) &#123;</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`Getter is missing for computed property "<span class="subst">$&#123;key&#125;</span>".`</span>,</span><br><span class="line">        vm</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    watchers[key] = <span class="keyword">new</span> Watcher(</span><br><span class="line">      vm,</span><br><span class="line">      getter || noop,</span><br><span class="line">      noop,</span><br><span class="line">      computedWatcherOptions</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!(key <span class="keyword">in</span> vm)) &#123;</span><br><span class="line">      defineComputed(vm, key, userDef)</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (key <span class="keyword">in</span> vm.$data) &#123;</span><br><span class="line">        warn(<span class="string">`The computed property "<span class="subst">$&#123;key&#125;</span>" is already defined in data.`</span>, vm)</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (vm.$options.props &amp;&amp; key <span class="keyword">in</span> vm.$options.props) &#123;</span><br><span class="line">        warn(<span class="string">`The computed property "<span class="subst">$&#123;key&#125;</span>" is already defined as a prop.`</span>, vm)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defineComputed</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  target: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  key: string,</span></span></span><br><span class="line"><span class="function"><span class="params">  userDef: Object | Function</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> shouldCache = !isServerRendering()</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> userDef === <span class="string">'function'</span>) &#123;</span><br><span class="line">    sharedPropertyDefinition.get = createComputedGetter(key)</span><br><span class="line">    sharedPropertyDefinition.set = noop</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    sharedPropertyDefinition.get = userDef.get</span><br><span class="line">      ? userDef.cache !== <span class="literal">false</span></span><br><span class="line">        ? createComputedGetter(key) </span><br><span class="line">        : userDef.get</span><br><span class="line">      : noop</span><br><span class="line">    sharedPropertyDefinition.set = userDef.set</span><br><span class="line">      ? userDef.set</span><br><span class="line">      : noop</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span> &amp;&amp;</span><br><span class="line">      sharedPropertyDefinition.set === noop) &#123;</span><br><span class="line">    sharedPropertyDefinition.set = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      warn(</span><br><span class="line">        <span class="string">`Computed property "<span class="subst">$&#123;key&#125;</span>" was assigned to but it has no setter.`</span>,</span><br><span class="line">        <span class="keyword">this</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(target, key, sharedPropertyDefinition)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createComputedGetter</span> (<span class="params">key</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">computedGetter</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> watcher = <span class="keyword">this</span>._computedWatchers &amp;&amp; <span class="keyword">this</span>._computedWatchers[key]</span><br><span class="line">    <span class="keyword">if</span> (watcher) &#123;</span><br><span class="line">      <span class="keyword">if</span> (watcher.dirty) &#123;</span><br><span class="line">        watcher.evaluate()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (Dep.target) &#123;</span><br><span class="line">        watcher.depend()</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> watcher.value</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><em>代码段 11</em> 中，通过创建 lazy 模式的 Watcher 实例处理计算属性。通过代码，也可以看出，开发者传入的 computed 选项，其属性 userDef 可以是函数或对象形式。若 userDef 为函数，当响应式数据未更新，使用 vm[computedKey] 取值时将获取缓存中的 watcher.value；当响应式数据已更新，则调用 watcher.evaluate 方法（即在模板 template 中使用计算属性时）重新计算值。若 userDef 为对象，且 userDef.cache 属性为真值，vm[computedKey] 取值方式与 userDef 为函数的情形相同；而 vm[computedKey] 赋值操作以 vm 为上下文，可以手动操作响应式数据，也就有可能触发 userDef.get 的再次执行，须谨慎。若 userDef 为对象，且 userDef.cache 属性为否值，vm[computedKey] 的取值、赋值操作仍以 vm 为上下文，两者在响应式数据更新后均不会触发执行，但可以可以手动操作响应式数据。</p>
<h4 id="watcher"><a href="#watcher" class="headerlink" title="watcher"></a>watcher</h4><p><em>代码段 12</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initWatch</span> (<span class="params">vm: Component, watch: Object</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> watch) &#123;</span><br><span class="line">    <span class="keyword">const</span> handler = watch[key]</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(handler)) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; handler.length; i++) &#123;</span><br><span class="line">        createWatcher(vm, key, handler[i])</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      createWatcher(vm, key, handler)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createWatcher</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  vm: Component,</span></span></span><br><span class="line"><span class="function"><span class="params">  keyOrFn: string | Function,</span></span></span><br><span class="line"><span class="function"><span class="params">  handler: any,</span></span></span><br><span class="line"><span class="function"><span class="params">  options?: Object</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isPlainObject(handler)) &#123;</span><br><span class="line">    options = handler</span><br><span class="line">    handler = handler.handler</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> handler === <span class="string">'string'</span>) &#123;</span><br><span class="line">    handler = vm[handler]</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> vm.$watch(keyOrFn, handler, options)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对 watcher 选项处理，即是创建 Watcher 实例的过程。watcher 选项的属性名可以是键路径，作为 Watcher 构造函数的入参 keyOrFn；而其值可以是函数或对象，若为对象，以 watch[key].handler 作为 Watcher 构造函数的入参 cb，其余属性作为入参 options。vm.$watch 方法见下一小节。</p>
<h4 id="set-del-watch-Vue-set-Vue-del"><a href="#set-del-watch-Vue-set-Vue-del" class="headerlink" title="$set, $del, $watch, Vue.set, Vue.del"></a>$set, $del, $watch, Vue.set, Vue.del</h4><p><em>代码段 13</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stateMixin</span> (<span class="params">Vue: Class&lt;Component&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  Vue.prototype.$set = set</span><br><span class="line">  Vue.prototype.$<span class="keyword">delete</span> = del</span><br><span class="line"></span><br><span class="line">  Vue.prototype.$watch = <span class="function"><span class="keyword">function</span> (<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    expOrFn: string | Function,</span></span></span><br><span class="line"><span class="function"><span class="params">    cb: any,</span></span></span><br><span class="line"><span class="function"><span class="params">    options?: Object</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>): <span class="title">Function</span> </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> vm: Component = <span class="keyword">this</span></span><br><span class="line">    <span class="keyword">if</span> (isPlainObject(cb)) &#123;</span><br><span class="line">      <span class="keyword">return</span> createWatcher(vm, expOrFn, cb, options)</span><br><span class="line">    &#125;</span><br><span class="line">    options = options || &#123;&#125;</span><br><span class="line">    options.user = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">const</span> watcher = <span class="keyword">new</span> Watcher(vm, expOrFn, cb, options)</span><br><span class="line">    <span class="keyword">if</span> (options.immediate) &#123;</span><br><span class="line">      cb.call(vm, watcher.value)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">unwatchFn</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      watcher.teardown()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>vm.$set, vm.$del 即取 observe 包导出的 set, del 函数。vm.$watch 方法允许次参 cb 为对象，并将 options.user 选项置为真值，标识为用户设定的 watcher；若 options.immediate 选项为真值，当即执行 cb；返回函数用于在 derivations, observale 依赖关系中释放该 watcher。</p>
<p>Vue.set, Vue.del 方法同 vm.$set, vm.$del。</p>
<h4 id="provide-inject"><a href="#provide-inject" class="headerlink" title="provide, inject"></a>provide, inject</h4><p><em>代码段 14</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initProvide</span> (<span class="params">vm: Component</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> provide = vm.$options.provide</span><br><span class="line">  <span class="keyword">if</span> (provide) &#123;</span><br><span class="line">    vm._provided = <span class="keyword">typeof</span> provide === <span class="string">'function'</span></span><br><span class="line">      ? provide.call(vm)</span><br><span class="line">      : provide</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">initInjections</span> (<span class="params">vm: Component</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> result = resolveInject(vm.$options.inject, vm)</span><br><span class="line">  <span class="keyword">if</span> (result) &#123;</span><br><span class="line">    observerState.shouldConvert = <span class="literal">false</span></span><br><span class="line">    <span class="built_in">Object</span>.keys(result).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">        defineReactive(vm, key, result[key], () =&gt; &#123;</span><br><span class="line">          warn(</span><br><span class="line">            <span class="string">`Avoid mutating an injected value directly since the changes will be `</span> +</span><br><span class="line">            <span class="string">`overwritten whenever the provided component re-renders. `</span> +</span><br><span class="line">            <span class="string">`injection being mutated: "<span class="subst">$&#123;key&#125;</span>"`</span>,</span><br><span class="line">            vm</span><br><span class="line">          )</span><br><span class="line">        &#125;)</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        defineReactive(vm, key, result[key])</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">    observerState.shouldConvert = <span class="literal">true</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">resolveInject</span> (<span class="params">inject: any, vm: Component</span>): ?<span class="title">Object</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (inject) &#123;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="built_in">Object</span>.create(<span class="literal">null</span>)</span><br><span class="line">    <span class="keyword">const</span> keys = hasSymbol</span><br><span class="line">        ? <span class="built_in">Reflect</span>.ownKeys(inject).filter(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="built_in">Object</span>.getOwnPropertyDescriptor(inject, key).enumerable</span><br><span class="line">        &#125;)</span><br><span class="line">        : <span class="built_in">Object</span>.keys(inject)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> key = keys[i]</span><br><span class="line">      <span class="keyword">const</span> provideKey = inject[key].from</span><br><span class="line">      <span class="keyword">let</span> source = vm</span><br><span class="line">      <span class="keyword">while</span> (source) &#123;</span><br><span class="line">        <span class="keyword">if</span> (source._provided &amp;&amp; provideKey <span class="keyword">in</span> source._provided) &#123;</span><br><span class="line">          result[key] = source._provided[provideKey]</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        &#125;</span><br><span class="line">        source = source.$parent</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!source) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">'default'</span> <span class="keyword">in</span> inject[key]) &#123;</span><br><span class="line">          <span class="keyword">const</span> provideDefault = inject[key].default</span><br><span class="line">          result[key] = <span class="keyword">typeof</span> provideDefault === <span class="string">'function'</span></span><br><span class="line">            ? provideDefault.call(vm)</span><br><span class="line">            : provideDefault</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">          warn(<span class="string">`Injection "<span class="subst">$&#123;key&#125;</span>" not found`</span>, vm)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>provide, inject 选项用于实现组件间的跨级传递，其基本实现同 props 选项，可参考 props 一小节。</p>
<h4 id="vm-watcher"><a href="#vm-watcher" class="headerlink" title="vm._watcher"></a>vm._watcher</h4><p>Vue 中，将更新后的响应式数据重绘到页面上，这一过程借助于在挂载组件时执行 <strong>vm._watcher = new Watcher(vm, updateComponent, noop)</strong> 语句创建 Watcher 实例实现。需要更新视图时，通过 <strong>vm._watcher.update</strong> 方法即可更新视图。这条执行语句见于 lifecycle 模块中的 mountComponent 函数，updateComponent 函数将作为 Watcher 构造函数的入参 expOrFn，即当在 vm 中响应式数据变更后，调用 updateComponent 函数更新组件、重绘视图。这部分内容，笔者将在后续的文章中加以分析。</p>
<p>前文提到的 <strong>computed, watch</strong> 选项和 <strong>$watch</strong> 方法均会创建 <strong>watcher</strong> 实例；同时这一小节也指明，各组件的 <strong>mountComponent</strong> 函数执行过程中均会创建 <strong>watcher</strong> 实例。可以预知的是，与组件 <strong>updateComponent</strong> 函数相关的重绘 <strong>watcher</strong> 实例会在与 <strong>computed, watch</strong> 选项相关的一般 <strong>watcher</strong> 实例后创建，因此上文中的 <strong>scheduler</strong> 模块通过 <strong>watcher.id</strong> 排序执行各 <strong>watcher.run</strong> 方法，以保证一般 <strong>watcher</strong> 实例在重绘 <strong>watcher</strong> 实例之后执行；重绘 <strong>watcher</strong> 实例按父子组件的顺序执行；当子组件移除时，其下的各 <strong>watcher</strong> 实例又将被跳过（响应式数据删除后，相关 watcher 实例便不再被唤起执行）。实现参见 <em>代码段 5</em>。</p>
<p>当 <strong>updateComponent</strong> 函数执行过程中，模板中设定的 <em>js</em> 函数可以更新响应式数据，在该函数执行过程中，与一般 <strong>watcher</strong> 实例执行过程触发响应式数据变更一样，都会将后续的 <strong>watcher</strong> 实例添加到异步队列中，并在同一个异步队列中执行完成。在 <strong>updateComponent</strong> 函数，须执行组件的 update 钩子，组件 Vue 实例通过 watcher.vm 获取；以及 keep-alive 组件的 activated 钩子。关于这部分内容，笔者将在后续的文章中再加以分析</p>
<p>改写 <strong>scheduler</strong> 模块中 <strong>flushSchedulerQueue</strong> 的函数如下：</p>
<p><em>代码段 15</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushSchedulerQueue</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  resetSchedulerState()</span><br><span class="line"></span><br><span class="line">  callActivatedHooks(activatedQueue)</span><br><span class="line">  callUpdatedHooks(updatedQueue)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// devtool hook</span></span><br><span class="line">  <span class="keyword">if</span> (devtools &amp;&amp; config.devtools) &#123;</span><br><span class="line">    devtools.emit(<span class="string">'flush'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callUpdatedHooks</span> (<span class="params">queue</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> i = queue.length</span><br><span class="line">  <span class="keyword">while</span> (i--) &#123;</span><br><span class="line">    <span class="keyword">const</span> watcher = queue[i]</span><br><span class="line">    <span class="keyword">const</span> vm = watcher.vm</span><br><span class="line">    <span class="keyword">if</span> (vm._watcher === watcher &amp;&amp; vm._isMounted) &#123;</span><br><span class="line">      callHook(vm, <span class="string">'updated'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// createComponent 函数执行时调用，添加 keep-alive 组件</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">queueActivatedComponent</span> (<span class="params">vm: Component</span>) </span>&#123;</span><br><span class="line">  vm._inactive = <span class="literal">false</span></span><br><span class="line">  activatedChildren.push(vm)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">callActivatedHooks</span> (<span class="params">queue</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; queue.length; i++) &#123;</span><br><span class="line">    queue[i]._inactive = <span class="literal">true</span></span><br><span class="line">    activateChildComponent(queue[i], <span class="literal">true</span> <span class="comment">/* true */</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上即为 Vue 内部对数据监测功能的使用。</p>
<h2 id="延伸"><a href="#延伸" class="headerlink" title="延伸"></a>延伸</h2><p>本节将根据 mobx 的 api 接口设计响应式 model。</p>
<p>class Model {<br>  @observable data = {<br>    firstname: ‘steven’,<br>    secondname: ‘spielberg’<br>  };</p>
<p>  @action changeData(){<br>    this.data = {<br>      firstname: ‘steven’,<br>      secondname: ‘jobs’<br>    }<br>  }</p>
<p>  @computed get fullname(){<br>    return <code>${this.firstname}.${this.secondname}</code>;<br>  }</p>
<p>  @reaction log(){<br>    console.log(‘name changed’);<br>  }<br>};</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/04/设计模式/观察者模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/04/设计模式/观察者模式/" itemprop="url">观察者模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-04T00:00:00+08:00">2018-03-04</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/设计模式/" itemprop="url" rel="index"><span itemprop="name">设计模式</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/04/设计模式/观察者模式/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/03/04/设计模式/观察者模式/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>观察者模式(Observer pattern)也称为发布-订阅模式(publish-subscribe pattern)，其处理逻辑即是当主题对象(a subject or a observable，也称为目标)的状态发生变更时，自动以广播的形式通知依赖于它的多个观察者(observers)，促使这些观察者执行后续的动作。其一般意义即为，在一对多的依赖关系中，当依赖更新时，所有依赖于它的对象(dependent)都会自动接收通知，并启用后续的处理流程。</p>
<p>在《设计模式:可复用面向对象软件的基础》一书中，观察者模式被定义为</p>
<blockquote class="blockquote-center"><p>One or more observers are interested in the state of a subject and register their interest with the subject by attaching themselves. When something changes in our subject that the observer may be interested in, a notify message is sent which calls the update method in each observer. When the observer is no longer interested in the subject’s state, they can simply detach themselves. </p>
</blockquote>
<h2 id="经典实现"><a href="#经典实现" class="headerlink" title="经典实现"></a>经典实现</h2><p>观察者模式包含下列组件：</p>
<ul>
<li>Subject: 维护 observers 清单，可添加或移除 observer。由 Subject 衍生出具象类 ConcreteSubject，通过继承或 extend。</li>
<li>Observer: 提供 update 接口。当 observer 对象接到 subject 状态更新的通知时，自动调用 update 方法。由 Observer 衍生出具象类 ConcreteObserver。</li>
<li>ConcreteSubject: 在 Subject 基础上构建，存储主题状态。当状态更新时，通知所有 ConcreteObserver 具体观察者。</li>
<li>ConcreteObserver: 在 Observer 基础上构建，存储 ConcreteSubject 的引用，实现 update 接口。该接口调用时，具体观察者的内部状态 observerState 将与 ConcreteSubject 具体主题对象的 subjectState 状态保持一致。</li>
</ul>
<p>简单实现为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">  observers = <span class="keyword">new</span> ObserverList();</span><br><span class="line"></span><br><span class="line">  attach(observer)&#123;</span><br><span class="line">    <span class="keyword">this</span>.observers.push(observer);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  detach(observer)&#123;</span><br><span class="line">    <span class="keyword">this</span>.observers = <span class="keyword">this</span>.observers.filter(<span class="function"><span class="params">ob</span> =&gt;</span> ob !== observer);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  notify()&#123;</span><br><span class="line">    <span class="keyword">this</span>.observers.map(<span class="function"><span class="params">observer</span> =&gt;</span> observer.update());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">  update()&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteSubject</span> <span class="keyword">extends</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">  subjectState = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  attach(concreteObserver)&#123;</span><br><span class="line">    concreteObserver.concreteSubject = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">super</span>.attach(concreteObserver);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  detach(concreteObserver)&#123;</span><br><span class="line">    concreteObserver.concreteSubject = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">super</span>.detach(concreteObserver);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getState()&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.subjectState;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setState(state)&#123;</span><br><span class="line">    <span class="keyword">this</span>.subjectState = state;</span><br><span class="line">    <span class="keyword">this</span>.notify();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteObserver</span> </span>&#123;</span><br><span class="line">  observerState = <span class="literal">null</span>;</span><br><span class="line">  concreteSubject = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  update()&#123;</span><br><span class="line">    <span class="keyword">this</span>.observerState = <span class="keyword">this</span>.concreteSubject.getState();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述实现存在的问题：</p>
<ol>
<li>观察者需要监听多个主题对象的更新状态。可将 subject 实例作为 update 方法的参数，以使 observer 知晓哪个主题对象触发了更新。</li>
<li>多个状态更新过程，将触发同样多个 notify，造成效率低。可由 observer 实例在合并多个状态更新后，控制 notify 方法的调用。</li>
<li>观察者接受通知时，需要额外的附属信息。可由 subject 实例在调用 update 方法时注入参数实现。按参数信息量的大小，可分为推模型(push model)、拉模型(pull model)两类。推模型，subject 将全量信息注入 update 方法；拉模型，subject 只将少量信息注入 update 方法，再由 observer 实例获取 subject 实例的状态。</li>
<li>观察者只对主题对象的部分信息感兴趣。可由 attach(observer, interset?) 方法中添加 interset 参数实现，interset 表示观察者实际感兴趣的方面(aspects)。</li>
<li><p>当主题对象和观察者的依赖关系较为复杂时，需要实现更改管理器 ChangeManager 来管理依赖关系。ChangeManager 的目的尽量减少观察者反映其主题对象的状态变化所需的工作量。ChangeManager 包含三种职责，维护主体对象到观察者的映射，因此就不需要主题对象维护观察者的引用，也不需要观察者维护主题对象的引用；定义一个特定的更新策略；根据主题对象的请求，更新所有观察者。有两种特殊的 ChangeManager，SimpleChangeManager 总是更新每一个主题对象的所有观察者；DAGChangeManager 处理主题对象及其观察者之间依赖关系构成的无环有向图，两个或多个主题对象改变产生冗余更新时，DAGChangeManager 将保证观察者仅接受一个更新。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChangeManager</span> </span>&#123;</span><br><span class="line">  subjectToObserverMap = <span class="keyword">new</span> <span class="built_in">Map</span>;</span><br><span class="line"></span><br><span class="line">  register(subject, observer)&#123;</span><br><span class="line">    <span class="keyword">let</span> observers = <span class="keyword">this</span>.subjectToObserverMap.get(subject);</span><br><span class="line">    <span class="keyword">let</span> has = observers.some(<span class="function"><span class="params">ob</span> =&gt;</span> ob === observer);</span><br><span class="line">    <span class="keyword">if</span> ( !has ) observers.push(observer);</span><br><span class="line">    <span class="keyword">this</span>.subjectToObserverMap.set(subject, observers);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  unregister(subject, observer)&#123;</span><br><span class="line">    <span class="keyword">let</span> observers = <span class="keyword">this</span>.subjectToObserverMap.get(subject);</span><br><span class="line">    observers = observers.some(<span class="function"><span class="params">ob</span> =&gt;</span> ob !== observer);</span><br><span class="line">    <span class="keyword">this</span>.subjectToObserverMap.set(subject, observers);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  notify()&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleChangeManager</span> <span class="keyword">extends</span> <span class="title">ChangeManager</span> </span>&#123;</span><br><span class="line">  notify()&#123;</span><br><span class="line">    subjectToObserverMap.keys.map(<span class="function"><span class="params">subject</span> =&gt;</span> &#123;</span><br><span class="line">      subjectToObserverMap.get(subject).map(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">        observer.update(subject);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DAGChangeManager</span> <span class="keyword">extends</span> <span class="title">ChangeManager</span> </span>&#123;</span><br><span class="line">  notify()&#123;</span><br><span class="line">    <span class="keyword">let</span> shouldUpdate = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    subjectToObserverMap.keys.map(<span class="function"><span class="params">subject</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="comment">/* subject */</span>) shouldUpdate = <span class="literal">true</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    subjectToObserverMap.keys.map(<span class="function"><span class="params">subject</span> =&gt;</span> &#123;</span><br><span class="line">      subjectToObserverMap.get(subject).map(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (shouldUpdate) observer.update();</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>结合主题对象和观察者，将其接口结合在一个类中实现，这样可以避免多重继承。</p>
</li>
</ol>
<h2 id="发布订阅模式"><a href="#发布订阅模式" class="headerlink" title="发布订阅模式"></a>发布订阅模式</h2><p>发布订阅模式(或者事件模型)即是观察者模式的一个变种。观察者模式基于在主题对象(the object firing event)中维护观察者(the object wishing receive topic notiffications)，状态更新时触发观察者的行为实现；当观察者仅对主题对象的部分数据感兴趣时，需要在 attach(observer, interset?) 方法执行过程中注入参数 interset。发布订阅模式通过主题频道(topic channel or event channel，也称为事件频道)关联订阅者(subscribers, the object wishing receive topic notiffications)和发布者(publisher, the object firing event)。简单地说，观察者模式基于主题对象、观察者这两个类实现，各自维护另一方的引用；发布订阅模式基于事件模型实现，订阅者以绑定函数形式存储于 topics 或 events 内部属性中，发布过程即取出绑定函数并执行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基于发布订阅语义</span></span><br><span class="line"><span class="keyword">let</span> subUid = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pubsub</span> </span>&#123;</span><br><span class="line">  topics = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  subscribe(topic, func)&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.topics[topic])</span><br><span class="line">      <span class="keyword">this</span>.topics[topic] = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> token = (++subUid).toString();</span><br><span class="line">    <span class="keyword">this</span>.topics[topic].push(&#123;</span><br><span class="line">      token: token,</span><br><span class="line">      func: func</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> token;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  publish(topic, ...args)&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.topics[topic])</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.topics[topic].map(<span class="function"><span class="params">subscriber</span> =&gt;</span> &#123;</span><br><span class="line">      subscriber.func(topic, ...args);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  unsubscribe(token)&#123;</span><br><span class="line">    <span class="keyword">this</span>.topics.map(<span class="function"><span class="params">topic</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.topics[topic] = <span class="keyword">this</span>.topics[topic].filter(<span class="function"><span class="params">subscribe</span> =&gt;</span> subscribe.token !== token);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基于事件模型语义</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Event</span> </span>&#123;</span><br><span class="line">  events = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  on(event, handler)&#123;<span class="comment">// 也可实现为 linsten, bind 方法</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.events[event])</span><br><span class="line">      <span class="keyword">this</span>.events[event] = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.events[event].push(handler);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  emit(event, ...args)&#123;<span class="comment">// 也可实现为 trigger, fire 方法</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.events[event])</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.events[event].map(<span class="function"><span class="params">handler</span> =&gt;</span> &#123;</span><br><span class="line">      handler(event, ...args);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  off(event, handler)&#123;<span class="comment">// 也可实现为 remove 方法</span></span><br><span class="line">    <span class="keyword">if</span> ( !<span class="keyword">this</span>.events[event] ) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( !handler )</span><br><span class="line">      <span class="keyword">this</span>.events[event] = [];</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">this</span>.events[event] = <span class="keyword">this</span>.events[event].filter(<span class="function"><span class="params">fn</span> =&gt;</span> handler !== fn);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><h3 id="延迟订阅"><a href="#延迟订阅" class="headerlink" title="延迟订阅"></a>延迟订阅</h3><p>在事件模型中，通常需要先添加订阅者，然后再发布事件。在实际业务场景中，有可能存在先发布，发布时还没有订阅者的情景，如 QQ 的离线消息。这时需要构建一个存放离线事件的堆栈(offlineStack)存储发布的消息，当有对象订阅这条消息时，再遍历堆栈，取出事件执行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OfflineEvent</span> </span>&#123;</span><br><span class="line">  offlineStack = [];</span><br><span class="line"></span><br><span class="line">  on(event, handler, last)&#123;</span><br><span class="line">    <span class="keyword">super</span>.on(event, handler);</span><br><span class="line">    <span class="keyword">if</span> ( last )&#123;</span><br><span class="line">      <span class="keyword">this</span>.offlineStack.pop()();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.offlineStack.map(<span class="function"><span class="params">fn</span> =&gt;</span> &#123;</span><br><span class="line">        fn();</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  emit(event, ...args)&#123;</span><br><span class="line">    <span class="keyword">let</span> fn = <span class="function"><span class="params">()</span> =&gt;</span> &#123; supper.emit.call(<span class="keyword">this</span>, event, ...args) &#125;;</span><br><span class="line">    <span class="keyword">this</span>.offlineStack.push(fn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  off(event, handler)&#123;</span><br><span class="line">    <span class="keyword">super</span>.off(event, handler);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="node-events-模块"><a href="#node-events-模块" class="headerlink" title="node: events 模块"></a>node: events 模块</h3><p>events 模块提供 EventEmitter 类，主要实现逻辑见前述 Event 类。</p>
<p>不同的是:</p>
<ol>
<li>once(event, linstener): node 中的 events 模块实现了 once 方法，其实现逻辑为用包装函数(wrapped)装饰 listener，在 emit 方法触发事件调用后，由触发执行的包装函数(wrapped)移除 listener，即调用 eventEmitter.removeListener(event, listener) 方法。</li>
<li>prependListener(event, listener): events 模块还实现了 prependListener 方法，用于在 this._events[event] 数组头部插入 listener，addListener 或 on 方法为尾部插入。</li>
<li>removeListener, removeAllListeners: removeListener(event, listener) 方法只能移除某个绑定函数，即需要指定参数 listener；removeAllListeners(event) 用于移除所有绑定函数，或者某个事件的绑定函数(当指定 event 参数时)，其移除过程中，先移除普通事件的绑定函数，再移除 ‘removeListener’ 事件的绑定函数，即在普通事件的绑定函数移除过程中，仍会触发 ‘removeListener’ 事件。</li>
<li>‘error’ 事件: 对于 ‘error’ 事件，即便没有注册绑定函数，也会以抛出错误对象的形式加以处理。</li>
<li>‘newListener’ 事件: 以 ‘newListener’ 添加的绑定函数，若未曾调用 emit 方法显式触发事件，在下一次 addListener, prependListener 方法执行过程中，将取出 ‘newListener’ 事件的绑定函数，率先执行，即 ‘newListener’ 特殊事件在注册绑定函数时触发执行。</li>
<li>‘removeListener’ 事件: 同 ‘newListener’ 事件，为 events 模块的特殊事件，即在移除绑定函数时触发执行。</li>
<li>在注册绑定函数的过程中，单个绑定函数将以函数形式存储，多个存储为数组形式。</li>
<li>listeners(event), rawListeners(event): 用于获取某个事件的绑定函数。</li>
<li>listenerCount(event): 在 events 模块中，添加和移除绑定函数，都会更新 this._eventsCount 属性(绑定函数个数)，然而 listenerCount(event) 方法用于获取某个事件的绑定函数个数。</li>
<li>setMaxListeners(num), getMaxListeners: 在 events 模块中，this._maxListeners 属性用于限定可注册绑定函数的最大个数，setMaxListeners(num), getMaxListeners 方法即用于设置或获取该值。</li>
</ol>
<p>具体代码，请翻看 node/lib/events.js 文件(version = 9.7.1)。</p>
<h2 id="疑问"><a href="#疑问" class="headerlink" title="疑问"></a>疑问</h2><ol>
<li>关于 DAGChangeManager？</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>[设计模式:可复用面向对象软件的基础]<br><a href="https://addyosmani.com/resources/essentialjsdesignpatterns/book/#observerpatternjavascript" target="_blank" rel="noopener">学习 Javascript 设计模式</a><br>[Javascript 设计模式和开发实践 - 曾探]</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/28/Vue/vue整体架构/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/28/Vue/vue整体架构/" itemprop="url">vue整体架构</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-28T00:00:00+08:00">2018-02-28</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/vue/" itemprop="url" rel="index"><span itemprop="name">vue</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/28/Vue/vue整体架构/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/02/28/Vue/vue整体架构/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br></pre></td><td class="code"><pre><span class="line">|--- compiler <span class="comment"># 将 html 脚本编译为字符串函数体，作为 Vue 实例的 render 方法???</span></span><br><span class="line">  |--- codegen <span class="comment"># 将 ast 转化成字符串拼接的函数内容体</span></span><br><span class="line">    |--- events.js <span class="comment"># 提供 genHandlers(events, isNative, warn) 将 </span></span><br><span class="line">    <span class="comment"># el.events = &#123; name: ['handler1', 'handler2'] &#125; 事件转化为字符串 </span></span><br><span class="line">    <span class="comment"># `on:&#123;$&#123;name&#125;:handler1,handler2&#125;` 形式。html 中绑定事件接受三种形式，</span></span><br><span class="line">    <span class="comment"># 纯函数形式，函数名或方法名，或函数体，由 vue 注入 $event 事件对象</span></span><br><span class="line">    └--- index.js <span class="comment"># 提供 generate(ast, options) 函数，将抽象语法树转化成</span></span><br><span class="line">    <span class="comment"># 字符串拼接的函数 render = `with(this)&#123;return $&#123;code&#125;&#125;`，返回值为</span></span><br><span class="line">    <span class="comment"># &#123; render, staticRenderFns &#125; 对象。options 通过 CodegenState 类</span></span><br><span class="line">    <span class="comment"># 注入全局指令及 options.modules['transformCode'|'genData']</span></span><br><span class="line">  |--- directives <span class="comment"># 注入为 CodegenState 实例的 directives 属性，在 html</span></span><br><span class="line">  <span class="comment"># 中为节点注入指令属性时，在 codegen/index.js 脚本执行 genDirectives 函数</span></span><br><span class="line">  <span class="comment"># 阶段，通过指令属性名获取相应的全局指令脚本 directive，并执行 </span></span><br><span class="line">  <span class="comment"># directives(el, dir, warn)，其中 dir 为指令名</span></span><br><span class="line">    |--- bind.js </span><br><span class="line">    |--- index.js </span><br><span class="line">    |--- model.js </span><br><span class="line">    └--- on.js </span><br><span class="line">  |--- parser <span class="comment"># 将 html 字符串转化成 ast 抽象语法树</span></span><br><span class="line">    |--- entity-decoder.js </span><br><span class="line">    |--- html-parser.js <span class="comment"># 提供 parseHtml(html, options) 函数，解析 html，</span></span><br><span class="line">    <span class="comment"># 通过 options['start'|    'end'|'comment'|'chars'] 提取</span></span><br><span class="line">    <span class="comment"># 节点标签(含属性)、注释和节点内外字符集</span></span><br><span class="line">    |--- index.js <span class="comment"># 提供 parse(template, options) 函数，内部调用 parseHtml </span></span><br><span class="line">    <span class="comment"># 函数，将 html 字符串转化成抽象语法树，树节点 el 注入 parent, children, </span></span><br><span class="line">    <span class="comment"># events, props, attrs, if, for, key, ref 等属性</span></span><br><span class="line">    |--- filter-parser.js <span class="comment"># 提供 parseFilters(exp) 函数，</span></span><br><span class="line">    <span class="comment"># 将 exp = `$&#123;expression&#125;|$&#123;filter&#125;|...` 转换成特定字符串 </span></span><br><span class="line">    <span class="comment"># `_f("$&#123;filter&#125;")($&#123;exp&#125;)`</span></span><br><span class="line">    └--- text-parser.js <span class="comment"># 提供 parseText(text, delimiters?) 函数，</span></span><br><span class="line">    <span class="comment"># 区分对待普通字符串和由分隔符包裹的字符串(应用过滤器，</span></span><br><span class="line">    <span class="comment"># 以 token = `_s($&#123;exp&#125;)` 形式返回)，最终生成 tokens 数组</span></span><br><span class="line">  |--- optimizer.js <span class="comment"># 提供 optimize(root, options) 函数，为视图中不会</span></span><br><span class="line">  <span class="comment"># 改变的静态节点注入 static = true 属性，为只包含文本的静态节点注入</span></span><br><span class="line">  <span class="comment"># staticRoot = true 属性及 staticInFor 属性</span></span><br><span class="line">  |--- create-compiler.js <span class="comment"># 提供 createCompilerCreator(baseCompile) </span></span><br><span class="line">  <span class="comment"># 函数，返回 createCompiler(template, options) 函数，用于创建 </span></span><br><span class="line">  <span class="comment"># &#123; compile, compileToFunctions &#125;。compile 方法，即由通过调用 </span></span><br><span class="line">  <span class="comment"># baseCompile 函数，先执行 parse 函数，后执行 generate 函数，</span></span><br><span class="line">  <span class="comment"># 返回 &#123; render, staticRenderFns, errors,tips &#125; 对象。</span></span><br><span class="line">  <span class="comment"># compileToFunctions 方法即 createCompileToFunctionFn(compile) 返回值</span></span><br><span class="line">  |--- to-function.js <span class="comment"># 提供 createCompileToFunctionFn(compile) 函数，</span></span><br><span class="line">  <span class="comment"># 返回 compileToFunctions(template, options?, vm?) 函数。</span></span><br><span class="line">  <span class="comment"># compileToFunctions 函数同样返回 &#123; render, staticRenderFns &#125; 对象，</span></span><br><span class="line">  <span class="comment"># 其中 render 方法用于将 compile().render 字符串构建为函数并执行</span></span><br><span class="line">  |--- index.js <span class="comment"># 通过为 createCompilerCreator 函数注入 baseCompile 回调，</span></span><br><span class="line">  <span class="comment"># 返回 &#123; compile, compileToFunctions &#125; 对象，见 create-compiler.js 文件注释</span></span><br><span class="line">  |--- error-detector.js</span><br><span class="line">  └--- helpers.js <span class="comment"># 工具函数</span></span><br><span class="line">|--- core</span><br><span class="line">  |--- components </span><br><span class="line">    |--- index.js </span><br><span class="line">    └--- keep-alive.js </span><br><span class="line">  |--- global-api </span><br><span class="line">    |--- use.js <span class="comment"># 添加 Vue.use(plugin, ...args) 静态方法，插件机制，直接执行插件</span></span><br><span class="line">    <span class="comment"># plugin 函数或 plugin.install 函数</span></span><br><span class="line">    |--- mixin.js <span class="comment"># 添加 Vue.mixin(obj) 静态方法，参数 obj 将混入到 Vue.options 属性中</span></span><br><span class="line">    |--- extend.js <span class="comment"># 添加 Vue.extend(options) 静态方法，基于 Vue 构造函数，创建子构造函数</span></span><br><span class="line">    <span class="comment"># 可用于创建生成 vue 实例的工厂函数，由 instance/init.js 模块将各类的 options 注入为</span></span><br><span class="line">    <span class="comment"># Vue 实例的 $options 属性</span></span><br><span class="line">    |--- assets.js <span class="comment"># 添加 Vue['component'|'directive'|'filter'](id, definition?) </span></span><br><span class="line">    <span class="comment"># 静态方法，获取或添加 Vue.options['components'|'directives'|'filters'][id]，</span></span><br><span class="line">    <span class="comment"># 用于创建全局组件、指令或过滤器</span></span><br><span class="line">    └--- index.js <span class="comment"># 添加 Vue.config 静态属性，Vue.util 工具函数集合，</span></span><br><span class="line">    <span class="comment"># Vue.['set'|'delete'|'nextTick'] 静态方法</span></span><br><span class="line">  |--- instance </span><br><span class="line">    |--- render-helpers</span><br><span class="line">      |--- <span class="built_in">bind</span>-object-listeners.js</span><br><span class="line">      |--- <span class="built_in">bind</span>-object-props.js</span><br><span class="line">      |--- check-keycodes.js</span><br><span class="line">      |--- index.js</span><br><span class="line">      |--- render-list.js</span><br><span class="line">      |--- render-slot.js</span><br><span class="line">      |--- render-static.js</span><br><span class="line">      |--- resolve-filter.js</span><br><span class="line">      └--- resolve-slots.js</span><br><span class="line">    |--- init.js <span class="comment"># initMixin(Vue) 为 Vue 添加 _init(options) 原型方法，</span></span><br><span class="line">    <span class="comment"># 合并祖先组件的 options 及 options 入参，赋值给 vm.$options，</span></span><br><span class="line">    <span class="comment"># 相继调用 initProxy, initLifecycle, initEvents, initRender, </span></span><br><span class="line">    <span class="comment"># initInjections, initState, initProvide 方法，执行 'beforeCreate', 'mounted' </span></span><br><span class="line">    <span class="comment"># 生命周期方法，条件调用 $mount(vm.$options.el) 挂载组件</span></span><br><span class="line">    |--- proxy.js <span class="comment"># initProxy(vm)，赋值vm._renderProxy，用户通过 vm._renderProxy </span></span><br><span class="line">    <span class="comment"># 获取不存在的 vm 属性时将会予以警告</span></span><br><span class="line">    |--- lifecycle.js <span class="comment"># initLifecycle(vm)，初始化生命周期相关属性</span></span><br><span class="line">    <span class="comment"># lifecycleMixin(Vue) 为 Vue 添加 _update, $forceUpdate, $destory 原型方法；</span></span><br><span class="line">    <span class="comment"># mountComponent(vm, el, hydrating?) 构建 Watcher 实例，回调中执行 </span></span><br><span class="line">    <span class="comment"># vm._update 方法，执行 'beforeCreate', 'mounted' 方法；</span></span><br><span class="line">    <span class="comment"># update(vm, propsData, listeners, parentVnode, renderChildren) 调用 </span></span><br><span class="line">    <span class="comment"># vm.$forceUpdate 方法更新视图???</span></span><br><span class="line">    <span class="comment"># activateChildComponent(vm, direct?), deactivateChildComponent(vm, direct?)；</span></span><br><span class="line">    <span class="comment"># callHook(vm, hook) 执行 vm.$options[hook]，条件调用 vm.$emit(`hook:$&#123;hook&#125;`)</span></span><br><span class="line">    |--- events.js <span class="comment"># initEvents(vm) 通过 vm.$on, vm.$once 绑定 </span></span><br><span class="line">    <span class="comment"># vm.$options._parentListeners 函数；eventMixin(Vue) 为 Vue 添加 </span></span><br><span class="line">    <span class="comment"># $on, $once, $off, $emit 原型方法，注册事件存储在 vm._events 属性中</span></span><br><span class="line">    |--- render.js <span class="comment"># initRender(vm) 设置 vm['$node'|'$slot'|'$scopeSlots'|</span></span><br><span class="line">    <span class="comment"># '$createElement'|'_c'] 属性或方法，调用 defineReactive 使 </span></span><br><span class="line">    <span class="comment"># vm['$attrs'|'listeners'] 为响应式；renderMixin(Vue) 为 Vue 添加 </span></span><br><span class="line">    <span class="comment"># $nextTick, _render(调用 vm.$options.render 创建 Vnode), </span></span><br><span class="line">    <span class="comment"># _o, _n, _s, _l, ... (注入 compile 函数)等方法</span></span><br><span class="line">    |--- inject.js <span class="comment"># 组件跨级传递数据。initProvider(vm) 将 vm.$options.provide </span></span><br><span class="line">    <span class="comment"># 赋值给 vm._provide；initInjections 调用 defineReactive 将先辈组件传入的</span></span><br><span class="line">    <span class="comment"># 数据响应式化；resolveInject 获取先辈组件的数据</span></span><br><span class="line">    |--- state.js <span class="comment"># proxy(target, sourceKey, key) 将 target[sourceKey][key] </span></span><br><span class="line">    <span class="comment"># 代理为 target[key]；initState(vm) 调用 initProps, initMethods, initData, </span></span><br><span class="line">    <span class="comment"># initComputed, initWatch，间接使用 defineReactive 或 new Watch 响应化</span></span><br><span class="line">    <span class="comment"># 数据或观察数据；stateMixin(Vue) 为 Vue 添加 $data, $props 只读属性，</span></span><br><span class="line">    <span class="comment"># $set, $delete, watch(expOrFn, cb, options?) 原型方法</span></span><br><span class="line">    └--- index.js <span class="comment"># Vue 构造函数，调用 initMixin(Vue), stateMixin(Vue), </span></span><br><span class="line">    <span class="comment"># eventsMixin(Vue), lifecycleMixin(Vue), renderMixin(Vue) 注入原型方法</span></span><br><span class="line">  |--- observer </span><br><span class="line">    |--- index.js <span class="comment"># observerState.shouldConvert 是否将新值转换为响应式；</span></span><br><span class="line">    <span class="comment"># new Observer(value)，若 value 为数组，改写 push 方法，递归为数组项生成 </span></span><br><span class="line">    <span class="comment"># Observer 实例；若 value 为对象，调用 defineReactive 函数使属性响应化，</span></span><br><span class="line">    <span class="comment"># value.__ob__ 挂载 Observer 实例；observer(value, asRootData?) 创建</span></span><br><span class="line">    <span class="comment"># 并返回 value 对应的 Observer 实例；defineReactive 函数调用 </span></span><br><span class="line">    <span class="comment"># Object.defineProperty 方法重写属性的访问器属性，set 方法触发 dep.notify，</span></span><br><span class="line">    <span class="comment"># get 方法触发 dep.depend 方法；set 函数将新添加的属性转化为响应式；</span></span><br><span class="line">    <span class="comment"># delete 函数删除属性触发 dep.notify 方法</span></span><br><span class="line">    |--- array.js <span class="comment"># arrayMethods 提供改写数组 push 等方法的对象，push 等方法</span></span><br><span class="line">    <span class="comment"># 执行时触发 dep.notify 方法调用</span></span><br><span class="line">    |--- dep.js <span class="comment"># Dep 类，管理订阅者，addSub, removeSub 添加或移除订阅者，</span></span><br><span class="line">    <span class="comment"># depend 使 dep 和 Dep.target = watcher 实例相互关联，notify 调用</span></span><br><span class="line">    <span class="comment"># 订阅者的 update 方法；pushTarget, popTarget 更改 Dep.Target</span></span><br><span class="line">    |--- watcher.js <span class="comment"># new Watcher(vm, expOrFn, cb, options?) 通过更改</span></span><br><span class="line">    <span class="comment"># 响应式数据，触发 dep.notify 调用 watcher.update，执行 cb 回调</span></span><br><span class="line">    └--- scheduler.js <span class="comment"># queueWatcher(watcher) 将 watcher 置入队列，</span></span><br><span class="line">    <span class="comment"># 通过 nextTick 在下次渲染完成后调用 watcher 队列的 run 方法，执行其 </span></span><br><span class="line">    <span class="comment"># cb 回调，并调用 'updated', 'activated' 生命周期方法；</span></span><br><span class="line">    <span class="comment"># queueActivatedComponent(vm) 将 vm 加入 activatedChildren 队列，</span></span><br><span class="line">    <span class="comment"># 用于触发 'activated' 生命周期方法</span></span><br><span class="line">  |--- util </span><br><span class="line">    |--- debug.js </span><br><span class="line">    |--- env.js </span><br><span class="line">    |--- error.js </span><br><span class="line">    |--- index.js</span><br><span class="line">    |--- lang.js </span><br><span class="line">    |--- options.js </span><br><span class="line">    |--- perf.js</span><br><span class="line">    └--- props.js </span><br><span class="line">  |--- vdom </span><br><span class="line">    |--- helpers</span><br><span class="line">      |--- extract-props.js </span><br><span class="line">      |--- get-first-component-child.js </span><br><span class="line">      |--- index.js</span><br><span class="line">      |--- is-async-placeholder.js </span><br><span class="line">      |--- merge-hook.js </span><br><span class="line">      |--- normalize-children.js</span><br><span class="line">      |--- resolve-async-component.js </span><br><span class="line">      └--- update-listeners.js</span><br><span class="line">    |--- modules</span><br><span class="line">      |--- directives.js</span><br><span class="line">      |--- index.js </span><br><span class="line">      └--- ref.js</span><br><span class="line">    |--- vnode.js <span class="comment"># Vnode 类，虚拟节点，其 context 属性通常为 vm 实例；</span></span><br><span class="line">    <span class="comment"># createEmptyNode(text) 创建注释节点，createTextNode(text) 创建文本节点</span></span><br><span class="line">    <span class="comment"># cloneNode(vnode, deep?), cloneNodes(vnodes, deep?) 复制节点</span></span><br><span class="line">    |--- create-element.js <span class="comment"># 提供 _createElement(context, tag?, data?, </span></span><br><span class="line">    <span class="comment"># children, normalizationType?) 函数，区分固有元素、已定义组件名、组件的</span></span><br><span class="line">    <span class="comment"># 构造函数等情况，创建 Vnode 实例；createElement 函数，调用 _createElement，</span></span><br><span class="line">    <span class="comment"># 构建 vm._c, vm.$createElement，创建 Vnode 实例</span></span><br><span class="line">    |--- create-component.js <span class="comment"># 提供 createComponent(Ctor, data, context, </span></span><br><span class="line">    <span class="comment"># children, tag?) 参数 Ctor 为构造函数、options 对象或 async 函数，</span></span><br><span class="line">    <span class="comment"># context 为 vm 实例，data 来自 ast，当 options.functional 为真值，</span></span><br><span class="line">    <span class="comment"># 为无状态组件，最终创建 Vnode</span></span><br><span class="line">    |--- create-functional-component.js <span class="comment"># 提供 createFunctionalComponent</span></span><br><span class="line">    <span class="comment"># (Ctor, propsData, data, contextVm, children) 函数，无状态组件，</span></span><br><span class="line">    <span class="comment"># 不会生成 Vue 实例，没有 data，最终创建 Vnode</span></span><br><span class="line">    └--- patch.js <span class="comment"># 提供 createPatchFunction(backend) 函数，参数 backend 中，</span></span><br><span class="line">    <span class="comment"># nodeOpts 属性为平台节点操作，modules 数组为平台属性、样式、事件操作以及</span></span><br><span class="line">    <span class="comment"># Vue 特有的指令、ref 引用操作，生成 patch(oldVnode, Vnode, hydrating, </span></span><br><span class="line">    <span class="comment"># removeOnly, parentElm, refElm) 函数，绘制或重绘视图</span></span><br><span class="line">  |--- config.js </span><br><span class="line">  └--- index.js </span><br><span class="line">|--- platforms</span><br><span class="line">  |--- web</span><br><span class="line">    |--- compiler</span><br><span class="line">      |--- directives</span><br><span class="line">        |--- html.js</span><br><span class="line">        |--- index.js</span><br><span class="line">        |--- model.js</span><br><span class="line">        └--- text.js</span><br><span class="line">      |--- modules</span><br><span class="line">        |--- class.js</span><br><span class="line">        |--- index.js</span><br><span class="line">        |--- model.js</span><br><span class="line">        └--- style.js</span><br><span class="line">      |--- index.js</span><br><span class="line">      |--- options.js</span><br><span class="line">      └--- util.js</span><br><span class="line">    |--- runtime</span><br><span class="line">      |--- components</span><br><span class="line">        |--- index.js</span><br><span class="line">        |--- transition-group.js</span><br><span class="line">        └--- transition.js</span><br><span class="line">      |--- directives</span><br><span class="line">        |--- index.js</span><br><span class="line">        |--- model.js</span><br><span class="line">        └--- show.js</span><br><span class="line">      |--- modules</span><br><span class="line">        |--- attrs.js <span class="comment"># 浏览器端 updateAttrs(oldVnode, vnode) 更新 attr 属性</span></span><br><span class="line">        <span class="comment"># 返回 &#123; create: updateAttrs, update: updateAttrs &#125;</span></span><br><span class="line">        |--- class.js <span class="comment"># 浏览器端 updateClass(oldVnode, vnode) 更新 class 属性</span></span><br><span class="line">        <span class="comment"># 返回 &#123; create: updateClass, update: updateClass &#125;</span></span><br><span class="line">        |--- dom-props.js <span class="comment"># 浏览器端 updateDOMProps(oldVnode, vnode) 更新 prop 属性</span></span><br><span class="line">        <span class="comment"># 返回 &#123; create: updateDOMProps, update: updateDOMProps &#125;</span></span><br><span class="line">        |--- events.js <span class="comment"># 浏览器端 updateDOMListeners(oldVnode, vnode) 更新绑定事件，</span></span><br><span class="line">        <span class="comment"># updateDOMListeners 将为 core/vdom/helpers/index.js 模块注入 add, remove，</span></span><br><span class="line">        <span class="comment"># 返回 &#123; create: updateDOMListeners, update: updateDOMListeners &#125;</span></span><br><span class="line">        |--- style.js <span class="comment"># 浏览器端 updateStyle(oldVnode, vnode) 更新 style 属性</span></span><br><span class="line">        <span class="comment"># 返回 &#123; create: updateStyle, update: updateStyle &#125;</span></span><br><span class="line">        |--- transition.js</span><br><span class="line">        └--- index.js <span class="comment"># 用于构建传入 createPatchFunction(backend) 函数中的 </span></span><br><span class="line">        <span class="comment"># backend.modules 数组，浏览器端节点属性、类、事件、样式操作</span></span><br><span class="line">      |--- class-util.js <span class="comment"># 浏览器端 addClass(el, cls), removeClass(el, cls) 函数</span></span><br><span class="line">      |--- transition-util.js <span class="comment"># resolveTransition(def?) 构建 transition 类名；</span></span><br><span class="line">      <span class="comment"># transitionProp, transitionEndEvent, animationProp, animationEndEvent </span></span><br><span class="line">      <span class="comment"># 相关事件名；nextFrame(fn) 通过 requestAnimationFrame 或 setTimeout </span></span><br><span class="line">      <span class="comment"># 执行 fn 函数；addTransitionClass(el, cls), removeTransitionClass(el, cls)，</span></span><br><span class="line">      <span class="comment"># 类操作；getTransitionInfo(el, expectedType?) 通过 el 样式获取相关属性；</span></span><br><span class="line">      <span class="comment"># whenTransitionEnds(el, expectedType, cb) 通过事件执行 cb 回调</span></span><br><span class="line">      |--- node-ops.js <span class="comment"># 浏览器端 createElement(tagName, vnode), </span></span><br><span class="line">      <span class="comment"># createElementNS(namespace, tagName), createTextNode(text), </span></span><br><span class="line">      <span class="comment"># createComment(text), insertBefore(parentNode, newNode, referenceNode), </span></span><br><span class="line">      <span class="comment"># removeChild(node, child), appendChild(node, child), parentNode(node), </span></span><br><span class="line">      <span class="comment"># nextSibling(node), tagName(node), setTextContext(node), </span></span><br><span class="line">      <span class="comment"># setAttribute(node, key, val) 函数</span></span><br><span class="line">      <span class="comment"># 用于构建传入 createPatchFunction(backend) 函数中的 backend.nodeOpts</span></span><br><span class="line">      |--- patch.js <span class="comment"># 通过 core/vdom/patch.js 模块构建 patch 函数</span></span><br><span class="line">      └--- index.js <span class="comment"># 添加 Vue.config 属性；添加 Vue.options.directives 指令，</span></span><br><span class="line">      <span class="comment"># 添加 Vue.options.components 组件；添加 __patch__, $mount 原型方法；</span></span><br><span class="line">      <span class="comment"># devtools 触发 'emit' 事件；导出 Vue</span></span><br><span class="line">    |--- server</span><br><span class="line">      |--- directives</span><br><span class="line">        |--- index.js</span><br><span class="line">        └--- show.js</span><br><span class="line">      |--- modules</span><br><span class="line">        |--- attrs.js</span><br><span class="line">        |--- class.js</span><br><span class="line">        |--- dom-props.js</span><br><span class="line">        |--- index.js</span><br><span class="line">        └--- style.js</span><br><span class="line">      |--- compiler.js</span><br><span class="line">      └--- util.js</span><br><span class="line">    |--- util</span><br><span class="line">      |--- attrs.js</span><br><span class="line">      |--- class.js</span><br><span class="line">      |--- compat.js</span><br><span class="line">      |--- element.js</span><br><span class="line">      |--- index.js</span><br><span class="line">      └--- style.js</span><br><span class="line">    |--- entry-runtime.js <span class="comment"># 导出 web/runtime/index.js 文件中的 Vue 构造函数</span></span><br><span class="line">    |--- entry-compiler.js</span><br><span class="line">    |--- entry-runtime-with-compiler.js <span class="comment"># 改写 $mount 原型方法，通过 template </span></span><br><span class="line">    <span class="comment"># 节点、html 字符串或节点 id，设置 options.render 方法，随后挂载组件；</span></span><br><span class="line">    <span class="comment"># 添加 Vue.compile =  compileToFunctions 静态方法</span></span><br><span class="line">    |--- entry-server-basic-renderer.js</span><br><span class="line">    └--- entry-server-renderer.js</span><br><span class="line">  └--- weex</span><br><span class="line">    |--- compiler</span><br><span class="line">      |--- directives</span><br><span class="line">        |--- index.js</span><br><span class="line">        └--- model.js</span><br><span class="line">      |--- modules</span><br><span class="line">        |--- append.js</span><br><span class="line">        |--- class.js</span><br><span class="line">        |--- index.js</span><br><span class="line">        |--- props.js</span><br><span class="line">        └--- style.js</span><br><span class="line">      └--- index.js</span><br><span class="line">    |--- runtime</span><br><span class="line">      |--- components</span><br><span class="line">        |--- index.js</span><br><span class="line">        |--- richtext.js</span><br><span class="line">        |--- transition-group.js</span><br><span class="line">        └--- transition.js</span><br><span class="line">      |--- directives</span><br><span class="line">        └--- index.js</span><br><span class="line">      |--- modules</span><br><span class="line">        |--- attrs.js</span><br><span class="line">        |--- class.js</span><br><span class="line">        |--- events.js</span><br><span class="line">        |--- index.js</span><br><span class="line">        |--- style.js</span><br><span class="line">        └--- transition.js</span><br><span class="line">      |--- index.js</span><br><span class="line">      |--- node-ops.js</span><br><span class="line">      |--- patch.js</span><br><span class="line">      └--- text-node.js</span><br><span class="line">    |--- util</span><br><span class="line">      └--- index.js</span><br><span class="line">    |--- entry-compiler.js</span><br><span class="line">    |--- entry-framework.js</span><br><span class="line">    └--- entry-runtime-factory.js</span><br><span class="line">|--- server</span><br><span class="line">  |--- bundle-renderer.js </span><br><span class="line">    |--- create-bundle-renderer.js</span><br><span class="line">    |--- create-bundle-runner.js</span><br><span class="line">    └--- <span class="built_in">source</span>-map-support.js</span><br><span class="line">  |--- optimizing-compiler.js </span><br><span class="line">    |--- codegen.js</span><br><span class="line">    |--- index.js</span><br><span class="line">    |--- modules.js</span><br><span class="line">    |--- optimizer.js</span><br><span class="line">    └--- runtime-helpers.js</span><br><span class="line">  |--- template-renderer.js </span><br><span class="line">    |--- create-async-file-mapper.js</span><br><span class="line">    |--- index.js</span><br><span class="line">    |--- parse-template.js</span><br><span class="line">    └--- template-stream.js</span><br><span class="line">  |--- webpack-plugin.js </span><br><span class="line">    |--- client.js</span><br><span class="line">    |--- server.js</span><br><span class="line">    └--- util.js</span><br><span class="line">  |--- create-basic-renderer.js </span><br><span class="line">  |--- create-renderer.js </span><br><span class="line">  |--- render-context.js </span><br><span class="line">  |--- render-stream.js </span><br><span class="line">  |--- render.js </span><br><span class="line">  |--- util.js </span><br><span class="line">  └--- write.js </span><br><span class="line">|--- sfc</span><br><span class="line">  └--- parser.js </span><br><span class="line">└--- shared</span><br><span class="line">  |--- constants.js <span class="comment"># 导出 SSR_ATTR 服务器端渲染, ASSET_TYPES 静态成员名</span></span><br><span class="line">  <span class="comment"># (component, directive, filter), LIFECYCLE_HOOKS 生命周期钩子</span></span><br><span class="line">  └--- util.js</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/25/Js/typescript文档笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/25/Js/typescript文档笔记/" itemprop="url">typescript文档笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-25T00:00:00+08:00">2018-02-25</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/js/" itemprop="url" rel="index"><span itemprop="name">js</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/25/Js/typescript文档笔记/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/02/25/Js/typescript文档笔记/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="基础类型"><a href="#基础类型" class="headerlink" title="基础类型"></a>基础类型</h2><p>ts 基础类型包含 boolean, number, string, array, tuple 元祖, enum, any 任意类型, void 非任意类型(可赋值为 undefined 或 null，通常用于函数无返回值时), undefined, null, never 永不存在值的类型(通常用于函数报错或陷入死循环时), symbol。</p>
<p>其中，数值类型支持十进制、十六进制、八进制和二进制字面量。</p>
<p>字符串类型支持 es6 模板字符串。</p>
<p>数组类型 Array<t> 限定元素类型一致，使用 let list: number[] = [1, 2, 3]; 或 let list: Array<number> = [1, 2, 3]; 声明。ReadonlyArray<t> 只读数组类型，不能将其赋值给普通数组，但可以通过类型断言将其转化为普通数组，如 numberReadonlyArray as number[]。</t></number></t></p>
<p>元祖类型预先声明元素类型，元素类型可以不一致。如 let x: [string, number]; x = [‘hello’, 10]; 同时，对于新增的元素，其类型必须在已声明类型中。上述示例中，x[6] = true; 将报错。</p>
<p>枚举从 0 开始为元素编号，也可以手动编号，如 enum Color {Red = 1, Green, Blue}; 通过 Color.Red 或 Color[1] 可以获取枚举值。</p>
<p>symbol 类型的值是通过 Symbol 构造函数创建，其值不可改变且唯一，如 let sym = Symbol()。es6 支持。</p>
<h3 id="类型断言"><a href="#类型断言" class="headerlink" title="类型断言"></a>类型断言</h3><p>类型断言使用 <type>value 或 value as Type；JSX 中只能使用 as，不能使用尖括号。TS 尝试做类型转换，而没有类型检查和结构。</type></p>
<h3 id="Symbol"><a href="#Symbol" class="headerlink" title="Symbol"></a>Symbol</h3><ul>
<li>Symbol.hasInstance 方法，instanceof 运算符内部调用 Symbol.hasInstance 方法。</li>
<li>Symbol.iterator 方法，for-of语句内部调用 Symbol.iterator 方法，返回对象的默认迭代器。</li>
<li>Symbol.isConcatSpreadable 属性，Array.prototype.concat 方法内部使用 Symbol.isConcatSpreadable 判断数组是否可展开。</li>
<li>Symbol.match 方法，String.prototype.match 方法内部调用 Symbol.match 方法。</li>
<li>Symbol.replace 方法，String.prototype.replace 方法内部调用 Symbol.replace 方法。</li>
<li>Symbol.search 方法，String.prototype.search 方法内部调用 Symbol.search 方法。</li>
<li>Symbol.split 方法，String.prototype.split 方法内部调用 Symbol.split 方法。</li>
<li>Symbol.toStringTag 方法，Object.prototype.toString 方法内部调用 Symbol.toStringTag 方法。</li>
<li>Symbol.species 构造函数，用于创建派生对象。</li>
<li>Symbol.toPrimitive 方法，ToPrimitive 抽象操作调用 Symbol.toPrimitive 方法，把对象转换为相应的原始值。</li>
<li>Symbol.unscopables 对象，它自己拥有的属性会被with作用域排除在外。</li>
</ul>
<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><p>let 为块级作用域，用于修正 var 为函数、模块级作用域的怪异问题。<br>const 块级作用域，常量。</p>
<h3 id="块级作用域"><a href="#块级作用域" class="headerlink" title="块级作用域"></a>块级作用域</h3><p>var 变量的声明会在编译阶段上移到函数、模块头部，因此造成怪异一为在 if, for 语句中声明的 var 变量可以在条件或循环语句外访问；造成怪异二为在内外两层 for 语句条件体内声明的同一变量引用同一个变量；造成怪异三为 for 语句执行过程有延迟，其最终引用的是条件体执行完成的结果。</p>
<p>推想 let 修正块级作用域的过程，就是在编译过程中用匿名函数包裹代码块(if, for, {} 平级)，var 变量在该匿名函数中声明，可以解决怪异一、二；使用闭包包裹延迟函数，可以在延迟函数等待期间保留原有的作用域，这可能会导致内存泄漏。</p>
<h3 id="解构"><a href="#解构" class="headerlink" title="解构"></a>解构</h3><p>数组使用 [ item1, item2, …rests ] = arr; 语法解构，如 [first, second] = [second, first]; 即为变量交换数据。</p>
<p>对象使用 { prop1, prop2, …rests } = obj; 语法解构。</p>
<p>属性重命名采用 “:”，默认值采用 “=”，如 { prop1 = “default”, prop2: “key” }。</p>
<p>解构适用于函数入参。</p>
<h3 id="展开"><a href="#展开" class="headerlink" title="展开"></a>展开</h3><p>展开同样使用 “…”，如 val = { prop1: “value”, …obj }。</p>
<h2 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h2><h3 id="接口作为类型"><a href="#接口作为类型" class="headerlink" title="接口作为类型"></a>接口作为类型</h3><p>当使用 value: Interface 语法将接口用于类型检查时，value 必须满足 Interface 声明的结构化类型，即 value 作为对象时，其属性需满足 Interface 属性的类型规则，允许 value 包含接口未声明的额外属性；value 作为函数时，其入参、返回值须满足接口约定的类型规则，value 参数名可与 Interface 定义的名字不同。</p>
<p>接口类型使用 “?” 后缀声明可选属性，当可选属性存在时，且 value 为对象字面量时，将不允许 value 包含接口未声明的额外属性；若 value 为变量，则允许。</p>
<p>使用 “readonly” 修饰符声明只读属性。</p>
<p>使用 [propName: Type1]: Type2 索引签名可用于接受特定类型的属性，Type1 用于约定索引的类型(索引包含对象的属性和数组项)，Type2 用于约定值类型。索引签名 Type1 可以是 “string”, “number” 中的一个，数字通过转化为字符串索引对象，因此数字索引的返回值必须是字符串索引的返回值的子类型。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">interface SquareConfig &#123;</span><br><span class="line">  color?: string;</span><br><span class="line">  width?: number;</span><br><span class="line">  [propName: string]: any;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface SearchFunc &#123;</span><br><span class="line">  (source: string, <span class="attr">subString</span>: string): boolean;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关于索引类型</span></span><br><span class="line">interface NumberDictionary &#123;</span><br><span class="line">  [index: string]: number;</span><br><span class="line">  length: number;<span class="comment">// 可以，length是number类型</span></span><br><span class="line">  name: string<span class="comment">// 错误，`name`的类型与索引类型返回值的类型不匹配</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="接口用于实现"><a href="#接口用于实现" class="headerlink" title="接口用于实现"></a>接口用于实现</h3><p>接口描述了类的公共部分，但不包含私有部分。</p>
<p>当类实现了接口时，只对其实例部分进行类型检查，而 constructor 方法属于类的静态部分。对 constructor 方法进行校验需要由工厂函数完成。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">interface ClockConstructor &#123;</span><br><span class="line">  <span class="keyword">new</span> (hour: number, <span class="attr">minute</span>: number): ClockInterface;</span><br><span class="line">&#125;</span><br><span class="line">interface ClockInterface &#123;</span><br><span class="line">  tick();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createClock</span>(<span class="params">ctor: ClockConstructor, hour: number, minute: number</span>): <span class="title">ClockInterface</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ctor(hour, minute);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DigitalClock</span> <span class="title">implements</span> <span class="title">ClockInterface</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(h: number, m: number) &#123; &#125;</span><br><span class="line">  tick() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"beep beep"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> digital = createClock(DigitalClock, <span class="number">12</span>, <span class="number">17</span>);</span><br></pre></td></tr></table></figure>
<p>接口可以继承接口，且一个接口可以继承多个接口。</p>
<p>接口可以继承类。当接口继承类时，接口会继承类的private和protected成员，但不包含类的实现。继承类的接口只能被该类及其子类继承。</p>
<h2 id="类"><a href="#类" class="headerlink" title="类"></a>类</h2><p>子类通过 super 关键字访问父类，如 super() 用于执行父类的构造函数。</p>
<p>public 关键字用于声明公共属性，默认使用 public 修饰符；protected 关键字用于声明保护属性；private 关键字用于声明私有属性。实例含有相同的公共属性、私有属性，且这些公共属性、私有属性声明在同一个类中，两个实例就是兼容的，就可以互相赋值，否则会报错。</p>
<p>constructor 构造函数也能被标注为 protected，意味着这个类不能在包含它的类外被实例化，但是能被继承。</p>
<p>对构造函数的入参使用 private, protected, public 修饰符时，类初始化将构建同名私有属性、保护属性、公共属性。</p>
<p>readonly 关键字用于声明只读属性，只读属性必须在声明时或构造函数里被初始化。</p>
<p>get, set 关键字用于声明存取器属性，需要将编译器设置为输出ECMAScript 5或更高，只带有 get 不带有 set的存取器自动被推断为 readonly。</p>
<p>static 关键字用于声明静态属性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  protected name: string;</span><br><span class="line">  protected <span class="keyword">constructor</span>(theName: string) &#123; <span class="keyword">this</span>.name = theName; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Employee 能够继承 Person</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employee</span> <span class="keyword">extends</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  private department: string;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(name: string, department: string) &#123;</span><br><span class="line">    <span class="keyword">super</span>(name);</span><br><span class="line">    <span class="keyword">this</span>.department = department;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public getElevatorPitch() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`Hello, my name is <span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span> and I work in <span class="subst">$&#123;<span class="keyword">this</span>.department&#125;</span>.`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> howard = <span class="keyword">new</span> Employee(<span class="string">"Howard"</span>, <span class="string">"Sales"</span>);</span><br><span class="line"><span class="keyword">let</span> john = <span class="keyword">new</span> Person(<span class="string">"John"</span>); <span class="comment">// 错误: 'Person' 的构造函数是被保护的.</span></span><br></pre></td></tr></table></figure>
<h3 id="抽象类"><a href="#抽象类" class="headerlink" title="抽象类"></a>抽象类</h3><p>abstract 关键字用于声明抽象类。在抽象类，abstract 关键字还可以用于声明抽象方法，抽象方法只定义方法签名但不包含方法体，即不包含实现。由子类提供具体方法。</p>
<h3 id="Mixins混入"><a href="#Mixins混入" class="headerlink" title="Mixins混入"></a>Mixins混入</h3><p>ts 中的类，可以用 implements 关键字实现多个类，即将类视为接口，需要在实现类中添加接口类的成员属性，再通过 applyMixins 等自定义函数将接口类的原型属性赋给实现类。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Disposable Mixin</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Disposable</span> </span>&#123;</span><br><span class="line">  isDisposed: boolean;</span><br><span class="line">  dispose() &#123;</span><br><span class="line">    <span class="keyword">this</span>.isDisposed = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Activatable Mixin</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Activatable</span> </span>&#123;</span><br><span class="line">  isActive: boolean;</span><br><span class="line">  activate() &#123;</span><br><span class="line">    <span class="keyword">this</span>.isActive = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  deactivate() &#123;</span><br><span class="line">    <span class="keyword">this</span>.isActive = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SmartObject</span> <span class="title">implements</span> <span class="title">Disposable</span>, <span class="title">Activatable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    setInterval(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="keyword">this</span>.isActive + <span class="string">" : "</span> + <span class="keyword">this</span>.isDisposed), <span class="number">500</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  interact() &#123;</span><br><span class="line">    <span class="keyword">this</span>.activate();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Disposable</span></span><br><span class="line">  isDisposed: boolean = <span class="literal">false</span>;</span><br><span class="line">  dispose: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line">  <span class="comment">// Activatable</span></span><br><span class="line">  isActive: boolean = <span class="literal">false</span>;</span><br><span class="line">  activate: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line">  deactivate: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line">&#125;</span><br><span class="line">applyMixins(SmartObject, [Disposable, Activatable]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> smartObj = <span class="keyword">new</span> SmartObject();</span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> smartObj.interact(), <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// In your runtime library somewhere</span></span><br><span class="line"><span class="comment">////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">applyMixins</span>(<span class="params">derivedCtor: any, baseCtors: any[]</span>) </span>&#123;</span><br><span class="line">  baseCtors.forEach(<span class="function"><span class="params">baseCtor</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">Object</span>.getOwnPropertyNames(baseCtor.prototype).forEach(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">      derivedCtor.prototype[name] = baseCtor.prototype[name];</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><p>定义函数时，可以声明参数和返回值的类型，如 (arg: Type1) =&gt; Type2 {} 或 function(arg: Type1): Type2 {}。</p>
<p>函数重载通过定义多个函数类型来实现。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> suits = [<span class="string">"hearts"</span>, <span class="string">"spades"</span>, <span class="string">"clubs"</span>, <span class="string">"diamonds"</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pickCard</span>(<span class="params">x: &#123;suit: string; card: number; &#125;[]</span>): <span class="title">number</span>;</span></span><br><span class="line"><span class="function"><span class="title">function</span> <span class="title">pickCard</span>(<span class="params">x: number</span>): </span>&#123;suit: string; card: number; &#125;;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pickCard</span>(<span class="params">x</span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> x == <span class="string">"object"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> pickedCard = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * x.length);</span><br><span class="line">    <span class="keyword">return</span> pickedCard;</span><br><span class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> x == <span class="string">"number"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> pickedSuit = <span class="built_in">Math</span>.floor(x / <span class="number">13</span>);</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">suit</span>: suits[pickedSuit], <span class="attr">card</span>: x % <span class="number">13</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> myDeck = [&#123; <span class="attr">suit</span>: <span class="string">"diamonds"</span>, <span class="attr">card</span>: <span class="number">2</span> &#125;, &#123; <span class="attr">suit</span>: <span class="string">"spades"</span>, <span class="attr">card</span>: <span class="number">10</span> &#125;, &#123; <span class="attr">suit</span>: <span class="string">"hearts"</span>, <span class="attr">card</span>: <span class="number">4</span> &#125;];</span><br><span class="line"><span class="keyword">let</span> pickedCard1 = myDeck[pickCard(myDeck)];</span><br><span class="line">alert(<span class="string">"card: "</span> + pickedCard1.card + <span class="string">" of "</span> + pickedCard1.suit);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> pickedCard2 = pickCard(<span class="number">15</span>);</span><br><span class="line">alert(<span class="string">"card: "</span> + pickedCard2.card + <span class="string">" of "</span> + pickedCard2.suit);</span><br></pre></td></tr></table></figure>
<h3 id="this关键字"><a href="#this关键字" class="headerlink" title="this关键字"></a>this关键字</h3><p>非方法式调用会将 this 视为 window(在严格模式下，this 为 undefined)。fn(…args) 等同 fn.call(window [ES5-strict: undefined], …args)。obj.method(…args) 等同 obj.method.call(obj, …args)。</p>
<p>方法若以闭包形式书写，其返回函数的 this 始终指向 undefined 或 window，而不是挂载的对象。箭头函数即用于将返回函数的 this 指向挂载对象。不同于函数在调用时才获知 this 的指向，箭头函数在定义时就声明了 this 的指向。</p>
<p>推想函数 this 指向，就是在编译过程通过判断调用方式是函数还是方法，将 this 赋值为 undefined 或相关对象。箭头函数改写 this 的实现过程也即是，在编译阶段通过包装函数调用 bind 方法将箭头函数的 this 改写为函数所在的 this 或方法的上层对象。箭头函数的 this 指向在包装函数内实现，因此不能改变 this 的指向。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">interface Card &#123;</span><br><span class="line">    suit: string;</span><br><span class="line">    card: number;</span><br><span class="line">&#125;</span><br><span class="line">interface Deck &#123;</span><br><span class="line">    suits: string[];</span><br><span class="line">    cards: number[];</span><br><span class="line">    createCardPicker(<span class="keyword">this</span>: Deck): <span class="function"><span class="params">()</span> =&gt;</span> Card;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> deck: Deck = &#123;</span><br><span class="line">    suits: [<span class="string">"hearts"</span>, <span class="string">"spades"</span>, <span class="string">"clubs"</span>, <span class="string">"diamonds"</span>],</span><br><span class="line">    cards: <span class="built_in">Array</span>(<span class="number">52</span>),</span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> The function now explicitly specifies that its callee must be of type Deck</span></span><br><span class="line">    <span class="comment">// 使用 this 参数将 this 的类型从 any 变更成 Deck 类型</span></span><br><span class="line">    createCardPicker: <span class="function"><span class="keyword">function</span>(<span class="params">this: Deck</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> pickedCard = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">52</span>);</span><br><span class="line">            <span class="keyword">let</span> pickedSuit = <span class="built_in">Math</span>.floor(pickedCard / <span class="number">13</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="attr">suit</span>: <span class="keyword">this</span>.suits[pickedSuit], <span class="attr">card</span>: pickedCard % <span class="number">13</span>&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> cardPicker = deck.createCardPicker();</span><br><span class="line"><span class="keyword">let</span> pickedCard = cardPicker();</span><br><span class="line"></span><br><span class="line">alert(<span class="string">"card: "</span> + pickedCard.card + <span class="string">" of "</span> + pickedCard.suit);</span><br></pre></td></tr></table></figure>
<h2 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h2><p>声明时不确定类型，调用时设定类型，促使定义的函数或类适用于不同的类型，同时能避免使用 any 时跳过类型校验的情景。</p>
<p>泛型使用 ‘&lt;’, ‘&gt;’ 包裹。</p>
<p>泛型函数使用 function<t>(arg: T): T {  } 或 function<t>(arg: Array<t>): T {  } 等形式。</t></t></t></p>
<p>泛型类使用 class ClassName<t> { method: (arg: T) =&gt; T } 等形式。</t></p>
<p>泛型可使用继承接口的形式加以约束</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 泛型函数</span></span><br><span class="line">interface GenericIdentityFn&lt;T&gt; &#123;</span><br><span class="line">  (arg: T): T;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">identity</span>&lt;<span class="title">T</span>&gt;(<span class="params">arg: T</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> arg;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> myIdentity: GenericIdentityFn&lt;number&gt; = identity;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 泛型类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenericNumber</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  zeroValue: T;</span><br><span class="line">  add: <span class="function">(<span class="params">x: T, y: T</span>) =&gt;</span> T;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> myGenericNumber = <span class="keyword">new</span> GenericNumber&lt;number&gt;();</span><br><span class="line">myGenericNumber.zeroValue = <span class="number">0</span>;</span><br><span class="line">myGenericNumber.add = <span class="function"><span class="keyword">function</span>(<span class="params">x, y</span>) </span>&#123; <span class="keyword">return</span> x + y; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用泛型创建工厂函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">create</span>&lt;<span class="title">T</span>&gt;(<span class="params">c: &#123;new(</span>): <span class="title">T</span>; &#125;): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> c();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h2><p>枚举类型在编译阶段通过函数赋值对象的方式构建，每个枚举成员包含枚举值和枚举名，生成枚举值到枚举名的双向映射。在编译阶段，枚举值通过直接求值获得；若未指定枚举值，首个枚举成员的枚举值初始化为 0，其余枚举成员的枚举值由前一个枚举成员的枚举值加 1 获得。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">enum Directions &#123;</span><br><span class="line">  Up,</span><br><span class="line">  Down,</span><br><span class="line">  Left,</span><br><span class="line">  Right</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Directions.Up;<span class="comment">// 0</span></span><br><span class="line">Directions[<span class="number">0</span>];<span class="comment">// "Up"</span></span><br></pre></td></tr></table></figure>
<h2 id="高级类型"><a href="#高级类型" class="headerlink" title="高级类型"></a>高级类型</h2><p>交叉类型使用 Type1 &amp; Type2 &amp; Type3 语法，被校验数据须包含所有声明类型的特性。</p>
<p>联合类型使用 Type1 | Type2 | Type3 语法，被校验数据可以是所有声明类型的其中之一。</p>
<p>标签联合仍使用 Type1 | Type2 | Type3 语法，且 Type1, Type2, Type3 中包含可辨识的标签属性，用于区分到底属于哪个类型。</p>
<p>索引类型使用 keyof T 校验对象属性, T[K] 校验值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 标签联合</span></span><br><span class="line">interface Square &#123;</span><br><span class="line">  kind: <span class="string">"square"</span>;</span><br><span class="line">  size: number;</span><br><span class="line">&#125;</span><br><span class="line">interface Rectangle &#123;</span><br><span class="line">  kind: <span class="string">"rectangle"</span>;</span><br><span class="line">  width: number;</span><br><span class="line">  height: number;</span><br><span class="line">&#125;</span><br><span class="line">interface Circle &#123;</span><br><span class="line">  kind: <span class="string">"circle"</span>;</span><br><span class="line">  radius: number;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Shape = Square | Rectangle | Circle;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">area</span>(<span class="params">s: Shape</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (s.kind) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"square"</span>: <span class="keyword">return</span> s.size * s.size;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"rectangle"</span>: <span class="keyword">return</span> s.height * s.width;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"circle"</span>: <span class="keyword">return</span> <span class="built_in">Math</span>.PI * s.radius ** <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 索引类型</span></span><br><span class="line">function getProperty&lt;T, K extends keyof T&gt;(o: T, name: K): T[K] &#123;</span><br><span class="line">  <span class="keyword">return</span> o[name]; <span class="comment">// o[name] is of type T[K]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>映射类型，通过 [P in keyof T] 遍历旧类型的值 T[P]，以构建新类型。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Readonly, Partial, Pick, Record 包含在 ts 标准库中</span></span><br><span class="line">type Readonly&lt;T&gt; = &#123;</span><br><span class="line">  readonly [P <span class="keyword">in</span> keyof T]: T[P];</span><br><span class="line">&#125;</span><br><span class="line">type Partial&lt;T&gt; = &#123;</span><br><span class="line">  [P <span class="keyword">in</span> keyof T]?: T[P];</span><br><span class="line">&#125;</span><br><span class="line">type Pick&lt;T, K extends keyof T&gt; = &#123;</span><br><span class="line">  [P <span class="keyword">in</span> K]: T[P];</span><br><span class="line">&#125;</span><br><span class="line">type Record&lt;K extends string, T&gt; = &#123;</span><br><span class="line">  [P <span class="keyword">in</span> K]: T;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="类型别名"><a href="#类型别名" class="headerlink" title="类型别名"></a>类型别名</h2><p>类型别名使用 type Alias = Type 语法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">type Name = string;</span><br><span class="line">type NameResolver = <span class="function"><span class="params">()</span> =&gt;</span> string;</span><br><span class="line">type NameOrResolver = Name | NameResolver;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getName</span>(<span class="params">n: NameOrResolver</span>): <span class="title">Name</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> n === <span class="string">'string'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> n();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 泛型类型别名</span></span><br><span class="line">type Container&lt;T&gt; = &#123; <span class="attr">value</span>: T &#125;;</span><br></pre></td></tr></table></figure>
<h2 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h2><p>模块有其自身的作用域，通过模块加载器导入其他模块。模块导入使用 import 关键字，导出使用 export 关键字，默认导出使用 default 关键字(数值、类和函数声明可以直接被标记为默认导出)。</p>
<p>模块导入导出也可以使用 export = xxx; import module = require(“module”); 语法。</p>
<p>根据编译时指定的模块目标参数，编译器会生成相应的供Node.js (CommonJS)，Require.js (AMD)，isomorphic (UMD), SystemJS或ECMAScript 2015 native modules (ES6)模块加载系统使用的代码。编译时，使用 –module commonjs，将转化为 CommonJS 模块；使用 –module amd，将转化为 AMD 模块；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 导出重命名</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZipCodeValidator</span> <span class="title">implements</span> <span class="title">StringValidator</span> </span>&#123;</span><br><span class="line">  isAcceptable(s: string) &#123;</span><br><span class="line">    <span class="keyword">return</span> s.length === <span class="number">5</span> &amp;&amp; numberRegexp.test(s);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> &#123; ZipCodeValidator &#125;;</span><br><span class="line"><span class="keyword">export</span> &#123; ZipCodeValidator <span class="keyword">as</span> mainValidator &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重新导出</span></span><br><span class="line"><span class="keyword">export</span> &#123;ZipCodeValidator <span class="keyword">as</span> RegExpBasedZipCodeValidator&#125; <span class="keyword">from</span> <span class="string">"./ZipCodeValidator"</span>;</span><br><span class="line"><span class="keyword">export</span> * <span class="keyword">from</span> <span class="string">"./ZipCodeValidator"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导入重命名</span></span><br><span class="line"><span class="keyword">import</span> &#123; ZipCodeValidator <span class="keyword">as</span> ZCV &#125; <span class="keyword">from</span> <span class="string">"./ZipCodeValidator"</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> validator <span class="keyword">from</span> <span class="string">"./ZipCodeValidator"</span>;</span><br></pre></td></tr></table></figure>
<h3 id="模块解析策略"><a href="#模块解析策略" class="headerlink" title="模块解析策略"></a>模块解析策略</h3><p>ts 共有两种模块解析策略，Node 和 Classic，默认值为使用了 –module AMD | System | ES2015 模块系统的 Classic 策略。当使用 Classic 策略时，查找非相对模块通过从包含导入文件的目录开始依次向上级目录遍历，以定位匹配的声明文件。当使用 Node 策略时，查找相对模块先定位到同名文件，再定位到同名目录(根据目录下 package.json 文件中的 types 属性定位文件，或者定位到目录下 index.ts 文件)；查找相对模块通过先上遍历目录，定位到每层 node_modules 目录下与 模块同名的目录，再通过 package.json 或 index.ts 定位模块文件。</p>
<p>tsconfig.json 文件中的 compilerOptions.baseUrl, compilerOptions.paths 属性用于设定查找文件的基础路径以及特定模块的查找路径。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"compilerOptions"</span>: &#123;</span><br><span class="line">    "baseUrl": ".", // 相对于当前路径进行计算，compilerOptions.paths 存在时须指定 baseUrl</span><br><span class="line">    "paths": &#123;</span><br><span class="line">      "jquery": ["node_modules/jquery/dist/jquery"], // 此处映射是相对于"baseUrl"</span><br><span class="line">      "*": [// 其他模块分别在 projectRoot 或 projectRoot/generated 目录下查找</span><br><span class="line">        "*",</span><br><span class="line">        <span class="string">"generated/*"</span></span><br><span class="line">      ],</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h2><p>命名空间使用 namespace Name {} 声明，使用 export 关键字将命名空间内部声明的数据导出，没有使用 export 修饰的数据只能在命名空间内使用。编译阶段，在全局空间下构建一个普通对象，export 导出的数据构成该对象的属性或方法，因此，从命名空间中导出的数据通过 Name.exportName 加以引用。</p>
<p>可以将同一个命名空间内声明的多个类放置在不同的文件中，仍旧使用同一个命名空间，再使用引用标签可以告知编译器这些文件之间的关联。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">namespace Validation &#123;</span><br><span class="line">  <span class="keyword">export</span> interface StringValidator &#123;</span><br><span class="line">    isAcceptable(s: string): boolean;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> lettersRegexp = <span class="regexp">/^[A-Za-z]+$/</span>;</span><br><span class="line">  <span class="keyword">const</span> numberRegexp = <span class="regexp">/^[0-9]+$/</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">LettersOnlyValidator</span> <span class="title">implements</span> <span class="title">StringValidator</span> </span>&#123;</span><br><span class="line">    isAcceptable(s: string) &#123;</span><br><span class="line">        <span class="keyword">return</span> lettersRegexp.test(s);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ZipCodeValidator</span> <span class="title">implements</span> <span class="title">StringValidator</span> </span>&#123;</span><br><span class="line">    isAcceptable(s: string) &#123;</span><br><span class="line">      <span class="keyword">return</span> s.length === <span class="number">5</span> &amp;&amp; numberRegexp.test(s);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> strings = [<span class="string">"Hello"</span>, <span class="string">"98052"</span>, <span class="string">"101"</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> validators: &#123; [s: string]: Validation.StringValidator; &#125; = &#123;&#125;;</span><br><span class="line">validators[<span class="string">"ZIP code"</span>] = <span class="keyword">new</span> Validation.ZipCodeValidator();</span><br><span class="line">validators[<span class="string">"Letters only"</span>] = <span class="keyword">new</span> Validation.LettersOnlyValidator();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> s <span class="keyword">of</span> strings) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> name <span class="keyword">in</span> validators) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`"<span class="subst">$&#123; s &#125;</span>" - <span class="subst">$&#123; validators[name].isAcceptable(s) ? <span class="string">"matches"</span> : <span class="string">"does not match"</span> &#125;</span> <span class="subst">$&#123; name &#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用多个文件分解命名空间</span></span><br><span class="line"><span class="comment">// Validation.ts</span></span><br><span class="line">namespace Validation &#123;</span><br><span class="line">  <span class="keyword">export</span> interface StringValidator &#123;</span><br><span class="line">    isAcceptable(s: string): boolean;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LettersOnlyValidator.ts</span></span><br><span class="line"><span class="comment">/// &lt;reference path="Validation.ts" /&gt;</span></span><br><span class="line">namespace Validation &#123;</span><br><span class="line">  <span class="keyword">const</span> lettersRegexp = <span class="regexp">/^[A-Za-z]+$/</span>;</span><br><span class="line">  <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">LettersOnlyValidator</span> <span class="title">implements</span> <span class="title">StringValidator</span> </span>&#123;</span><br><span class="line">    isAcceptable(s: string) &#123;</span><br><span class="line">      <span class="keyword">return</span> lettersRegexp.test(s);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ZipCodeValidator.ts</span></span><br><span class="line"><span class="comment">/// &lt;reference path="Validation.ts" /&gt;</span></span><br><span class="line">namespace Validation &#123;</span><br><span class="line">  <span class="keyword">const</span> numberRegexp = <span class="regexp">/^[0-9]+$/</span>;</span><br><span class="line">  <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ZipCodeValidator</span> <span class="title">implements</span> <span class="title">StringValidator</span> </span>&#123;</span><br><span class="line">    isAcceptable(s: string) &#123;</span><br><span class="line">      <span class="keyword">return</span> s.length === <span class="number">5</span> &amp;&amp; numberRegexp.test(s);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Test.ts</span></span><br><span class="line"><span class="comment">/// &lt;reference path="Validation.ts" /&gt;</span></span><br><span class="line"><span class="comment">/// &lt;reference path="LettersOnlyValidator.ts" /&gt;</span></span><br><span class="line"><span class="comment">/// &lt;reference path="ZipCodeValidator.ts" /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> strings = [<span class="string">"Hello"</span>, <span class="string">"98052"</span>, <span class="string">"101"</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> validators: &#123; [s: string]: Validation.StringValidator; &#125; = &#123;&#125;;</span><br><span class="line">validators[<span class="string">"ZIP code"</span>] = <span class="keyword">new</span> Validation.ZipCodeValidator();</span><br><span class="line">validators[<span class="string">"Letters only"</span>] = <span class="keyword">new</span> Validation.LettersOnlyValidator();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> s <span class="keyword">of</span> strings) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> name <span class="keyword">in</span> validators) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">""</span><span class="string">" + s + "</span><span class="string">" "</span> + (validators[name].isAcceptable(s) ? <span class="string">" matches "</span> : <span class="string">" does not match "</span>) + name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 import q = x.y.z 语法以别名形式导出常用命名空间内的类，import 相较于 var，会构建新的引用</span></span><br><span class="line">namespace Shapes &#123;</span><br><span class="line">  <span class="keyword">export</span> namespace Polygons &#123;</span><br><span class="line">    <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Triangle</span> </span>&#123; &#125;</span><br><span class="line">    <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Square</span> </span>&#123; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> polygons = Shapes.Polygons;</span><br><span class="line"><span class="keyword">let</span> sq = <span class="keyword">new</span> polygons.Square(); <span class="comment">// Same as "new Shapes.Polygons.Square()"</span></span><br></pre></td></tr></table></figure>
<h2 id="声明合并"><a href="#声明合并" class="headerlink" title="声明合并"></a>声明合并</h2><p>ts 的声明会创建以下三种实体，命名空间，类型或值。创建命名空间的声明会新建一个命名空间，用 “.” 访问其下设定的值(包含类，函数等)。创建类型的声明会用声明的模型创建一个类型并绑定到给定的名字上，包含类，枚举，接口，类型别名。创建值的声明会创建在 js 输出中看到的值，包含函数，变量。给定名字相同时，ts 会将声明合并。</p>
<h3 id="合并接口"><a href="#合并接口" class="headerlink" title="合并接口"></a>合并接口</h3><p>ts 合并接口时，后声明接口中的函数成员具有较高优先级(当该函数的参数类型更为精细时，则该函数成员具有更高优先级)；同名非函数成员有不同类型时，会造成编译错误。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">interface Document &#123;</span><br><span class="line">  createElement(tagName: any): Element;</span><br><span class="line">&#125;</span><br><span class="line">interface Document &#123;</span><br><span class="line">  createElement(tagName: <span class="string">"div"</span>): HTMLDivElement;</span><br><span class="line">  createElement(tagName: <span class="string">"span"</span>): HTMLSpanElement;</span><br><span class="line">&#125;</span><br><span class="line">interface Document &#123;</span><br><span class="line">  createElement(tagName: string): HTMLElement;</span><br><span class="line">  createElement(tagName: <span class="string">"canvas"</span>): HTMLCanvasElement;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 合并后</span></span><br><span class="line">interface Document &#123;</span><br><span class="line">  createElement(tagName: <span class="string">"canvas"</span>): HTMLCanvasElement;</span><br><span class="line">  createElement(tagName: <span class="string">"div"</span>): HTMLDivElement;</span><br><span class="line">  createElement(tagName: <span class="string">"span"</span>): HTMLSpanElement;</span><br><span class="line">  createElement(tagName: string): HTMLElement;</span><br><span class="line">  createElement(tagName: any): Element;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="合并命名空间"><a href="#合并命名空间" class="headerlink" title="合并命名空间"></a>合并命名空间</h3><p>ts 合并命名空间时，当某个命名空间有非导出成员，编译时将会报错。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">namespace Animals &#123;</span><br><span class="line">  <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Zebra</span> </span>&#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">namespace Animals &#123;</span><br><span class="line">  <span class="keyword">export</span> interface Legged &#123; <span class="attr">numberOfLegs</span>: number; &#125;</span><br><span class="line">  <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 合并后</span></span><br><span class="line">namespace Animals &#123;</span><br><span class="line">  <span class="keyword">export</span> interface Legged &#123; <span class="attr">numberOfLegs</span>: number; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Zebra</span> </span>&#123; &#125;</span><br><span class="line">  <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="合并命名空间和类"><a href="#合并命名空间和类" class="headerlink" title="合并命名空间和类"></a>合并命名空间和类</h3><p>为类添加静态属性，可用于创建内部类。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Album</span> </span>&#123;</span><br><span class="line">  label: Album.AlbumLabel;</span><br><span class="line">&#125;</span><br><span class="line">namespace Album &#123;</span><br><span class="line">  <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AlbumLabel</span> </span>&#123; &#125;<span class="comment">// 必须导出</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="合并命名空间和函数"><a href="#合并命名空间和函数" class="headerlink" title="合并命名空间和函数"></a>合并命名空间和函数</h3><p>为函数添加属性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">buildLabel</span>(<span class="params">name: string</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> buildLabel.prefix + name + buildLabel.suffix;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">namespace buildLabel &#123;</span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">let</span> suffix = <span class="string">""</span>;</span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">let</span> prefix = <span class="string">"Hello, "</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="合并命名空间和枚举"><a href="#合并命名空间和枚举" class="headerlink" title="合并命名空间和枚举"></a>合并命名空间和枚举</h3><p>为枚举添加属性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">enum Color &#123;</span><br><span class="line">  red = <span class="number">1</span>,</span><br><span class="line">  green = <span class="number">2</span>,</span><br><span class="line">  blue = <span class="number">4</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用 Color.mixColor 添加枚举成员</span></span><br><span class="line">namespace Color &#123;</span><br><span class="line">  <span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mixColor</span>(<span class="params">colorName: string</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (colorName == <span class="string">"yellow"</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Color.red + Color.green;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (colorName == <span class="string">"white"</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Color.red + Color.green + Color.blue;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (colorName == <span class="string">"magenta"</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Color.red + Color.blue;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (colorName == <span class="string">"cyan"</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Color.green + Color.blue;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="装饰器"><a href="#装饰器" class="headerlink" title="装饰器"></a>装饰器</h2><p>装饰器使用 @expression 语法，可以修饰类，属性，方法，访问符或参数，可以添加多个装饰器，由内至外依次求值。装饰器为普通函数，可以通过创建装饰器工厂的方式向装饰器注入特定的依赖。</p>
<p>类装饰器只接受类的构造函数作为参数，如 function classDecorator (constructor){}。</p>
<p>属性装饰器接受类的构造函数(当方法属于静态成员)或类的原型对象(当方法属于实例成员)，成员的名字作为参数，如 function propDecorator (target, propertyKey)。</p>
<p>方法装饰器接受类的构造函数(当方法属于静态成员)或类的原型对象(当方法属于实例成员)，成员的名字，成员的属性描述符作为参数，如 function methodDecorator (target, propertyKey, descriptor)。</p>
<p>访问器装饰器接受类的构造函数(当方法属于静态成员)或类的原型对象(当方法属于实例成员)，成员的名字，成员的属性描述符作为参数，但不能同时装饰 get, set 访问器，如 function vistitorDecorator (target, propertyKey, descriptor)。</p>
<p>参数装饰器接受接受类的构造函数(当方法属于静态成员)或类的原型对象(当方法属于实例成员)，成员的名字，参数在函数参数列表中的索引，如 function parameterDecorator (target, propertyKey, parameterIndex)。</p>
<p>ts 中使用装饰器需要将 tsconfig.json 配置文件中的 compilerOptions.experimentalDecorators 属性置为真，且 compilerOptions.target 属性至少为 “ES5”。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 类装饰器</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">classDecorator</span>&lt;<span class="title">T</span> <span class="title">extends</span> </span>&#123;<span class="keyword">new</span>(...args:any[]):&#123;&#125;&#125;&gt;(<span class="keyword">constructor</span>:T) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">constructor</span> </span>&#123;</span><br><span class="line">    newProperty = <span class="string">"new property"</span>;</span><br><span class="line">    hello = <span class="string">"override"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@classDecorator</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Greeter</span> </span>&#123;</span><br><span class="line">  property = <span class="string">"property"</span>;</span><br><span class="line">  hello: string;</span><br><span class="line">  <span class="keyword">constructor</span>(m: string) &#123;</span><br><span class="line">    <span class="keyword">this</span>.hello = m;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方法装饰器和参数装饰器</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"reflect-metadata"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> requiredMetadataKey = <span class="built_in">Symbol</span>(<span class="string">"required"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">required</span>(<span class="params">target: Object, propertyKey: string | symbol, parameterIndex: number</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> existingRequiredParameters: number[] = <span class="built_in">Reflect</span>.getOwnMetadata(requiredMetadataKey, target, propertyKey) || [];</span><br><span class="line">  existingRequiredParameters.push(parameterIndex);</span><br><span class="line">  <span class="built_in">Reflect</span>.defineMetadata(requiredMetadataKey, existingRequiredParameters, target, propertyKey);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validate</span>(<span class="params">target: any, propertyName: string, descriptor: TypedPropertyDescriptor&lt;Function&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> method = descriptor.value;</span><br><span class="line">  descriptor.value = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> requiredParameters: number[] = <span class="built_in">Reflect</span>.getOwnMetadata(requiredMetadataKey, target, propertyName);</span><br><span class="line">    <span class="keyword">if</span> (requiredParameters) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> parameterIndex <span class="keyword">of</span> requiredParameters) &#123;</span><br><span class="line">        <span class="keyword">if</span> (parameterIndex &gt;= <span class="built_in">arguments</span>.length || <span class="built_in">arguments</span>[parameterIndex] === <span class="literal">undefined</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Missing required argument."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> method.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Greeter</span> </span>&#123;</span><br><span class="line">  greeting: string;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(message: string) &#123;</span><br><span class="line">    <span class="keyword">this</span>.greeting = message;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @validate</span><br><span class="line">  greet(@required name: string) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Hello "</span> + name + <span class="string">", "</span> + <span class="keyword">this</span>.greeting;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h2><p>当一个对象实现了 Symbol.iterator 属性时，该对象就是可迭代的。内置类型如 Array, Map, Set, String, Int32Array, Uint32Array等都实现了各自的 Symbol.iterator 属性。for…of 语句基于调用对象上的 Symbol.iterator 方法，用于遍历值。for…of 遍历索引，可以操作任何对象。</p>
<h2 id="JSX"><a href="#JSX" class="headerlink" title="JSX"></a>JSX</h2><p>ts 支持三种 jsx 模式，preserve, react, react-native，这些模式只在代码生成阶段产生影响。preserve 模式下生成代码中会保留 .jsx，由后续的工具(如 Babel)转换输出，生成文件带有 jsx 扩展名；react 模式会生成 React.createElement 等代码，无需再作转换，生成文件扩展名为 .js；react-native 模式相当于 preserve，保留 jsx 代码，生成文件的扩展名为 .js。</p>
<p>ts 中，编写 jsx 代码，须使用 .tsx 文件扩展名。.tsx 文件禁用 <type>id 形式的类型断言，类型断言可以使用 id as Type。</type></p>
<h3 id="固有元素"><a href="#固有元素" class="headerlink" title="固有元素"></a>固有元素</h3><p>固有元素使用特殊的接口 JSX.IntrinsicElements 来查找。默认情况下，这个接口没有指定，不对固有元素进行类型检查。 若这个接口存在，那么固有元素的名字需在 JSX.IntrinsicElements 接口的属性里查找。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">declare namespace JSX &#123;</span><br><span class="line">  interface IntrinsicElements &#123;</span><br><span class="line">    foo: any;<span class="comment">// 校验属性通过 foo: &#123; bar?: boolean &#125;，相应元素可写成 &lt;foo bar /&gt;;</span></span><br><span class="line">    <span class="comment">// [elemName: string]: any; 字符串索引</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;foo /&gt;;<span class="comment">// 正确</span></span><br><span class="line">&lt;bar /&gt;;<span class="comment">// 错误</span></span><br></pre></td></tr></table></figure>
<h3 id="无状态组件"><a href="#无状态组件" class="headerlink" title="无状态组件"></a>无状态组件</h3><p>无状态组件为普通函数，类型检查同函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">interface ClickableProps &#123;</span><br><span class="line">  children: JSX.Element[] | JSX.Element</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface HomeProps extends ClickableProps &#123;</span><br><span class="line">  home: JSX.Element;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface SideProps extends ClickableProps &#123;</span><br><span class="line">  side: JSX.Element | string;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MainButton</span>(<span class="params">prop: HomeProps</span>): <span class="title">JSX</span>.<span class="title">Element</span>;</span></span><br><span class="line"><span class="function"><span class="title">function</span> <span class="title">MainButton</span>(<span class="params">prop: SideProps</span>): <span class="title">JSX</span>.<span class="title">Element</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="类组件"><a href="#类组件" class="headerlink" title="类组件"></a>类组件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">declare namespace JSX &#123;</span><br><span class="line">  interface ElementAttributesProperty &#123;</span><br><span class="line">    props; <span class="comment">// 指定用来使用的属性名</span></span><br><span class="line">  &#125;</span><br><span class="line">  interface ElementChildrenAttribute &#123;</span><br><span class="line">    children: &#123;&#125;;  <span class="comment">// 指定 children</span></span><br><span class="line">  &#125;</span><br><span class="line">  interface ElementClass &#123;<span class="comment">// 用于校验元素类型</span></span><br><span class="line">    render: any;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyComponent</span> </span>&#123;</span><br><span class="line">  props: &#123;</span><br><span class="line">    foo?: string;</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyFactoryFunction</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">render</span>: <span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;MyComponent foo=<span class="string">"bar"</span> /&gt;; <span class="comment">// 正确</span></span><br><span class="line">&lt;MyFactoryFunction /&gt;; <span class="comment">// 正确</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotAValidComponent</span> </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">NotAValidFactoryFunction</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;NotAValidComponent /&gt;; <span class="comment">// 错误</span></span><br><span class="line">&lt;NotAValidFactoryFunction /&gt;; <span class="comment">// 错误</span></span><br></pre></td></tr></table></figure>
<h2 id="疑问"><a href="#疑问" class="headerlink" title="疑问"></a>疑问</h2><ol>
<li>类型推论???</li>
<li>类型兼容性???</li>
<li>高级类型中的类型保护???</li>
<li>模块按需加载，在 ts 中加载其他模块系统的模块??? 外部模块??? 模块 + 声明合并</li>
<li>tsconfig.json 配置文件???</li>
<li>装饰器中的元数据，reflect-metadata库???</li>
<li>三斜线指令???</li>
<li>编写声明文件 .d.ts???</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><a class="page-number" href="/page/5/">5</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpeg"
                alt="Alfred" />
            
              <p class="site-author-name" itemprop="name">Alfred</p>
              <p class="site-description motion-element" itemprop="description">人苦不知足，既得陇，复望蜀</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">42</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    <span class="site-state-item-count">18</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    <span class="site-state-item-count">19</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Alfred-sg" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/xiu-fan-79/activities" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-globe"></i>知乎</a>
                  </span>
                
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Alfred</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Pisces</a> v6.0.2</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.0.2"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.2"></script>



  

  
    <script id="dsq-count-scr" src="https://alfred.disqus.com/count.js" async></script>
  

  





	





  












  





  

  

  

  

  
  

  

  

  

  

</body>
</html>
