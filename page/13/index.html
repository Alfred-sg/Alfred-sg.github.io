<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.0.2" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.2">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.2" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.0.2',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="Hexo, NexT">


<meta name="description" content="人苦不知足，既得陇，复望蜀">
<meta property="og:type" content="website">
<meta property="og:title" content="修子范语">
<meta property="og:url" content="http://yoursite.com/page/13/index.html">
<meta property="og:site_name" content="修子范语">
<meta property="og:description" content="人苦不知足，既得陇，复望蜀">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="修子范语">
<meta name="twitter:description" content="人苦不知足，既得陇，复望蜀">






  <link rel="canonical" href="http://yoursite.com/page/13/">


  <title>修子范语</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">修子范语</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Alfredo's Notes</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/03/04/设计模式/观察者模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/03/04/设计模式/观察者模式/" itemprop="url">观察者模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-03-04T00:00:00+08:00">2018-03-04</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/设计模式/" itemprop="url" rel="index"><span itemprop="name">设计模式</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/03/04/设计模式/观察者模式/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/03/04/设计模式/观察者模式/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>观察者模式(Observer pattern)也称为发布-订阅模式(publish-subscribe pattern)，其处理逻辑即是当主题对象(a subject or a observable，也称为目标)的状态发生变更时，自动以广播的形式通知依赖于它的多个观察者(observers)，促使这些观察者执行后续的动作。其一般意义即为，在一对多的依赖关系中，当依赖更新时，所有依赖于它的对象(dependent)都会自动接收通知，并启用后续的处理流程。</p>
<p>在《设计模式:可复用面向对象软件的基础》一书中，观察者模式被定义为</p>
<blockquote class="blockquote-center"><p>One or more observers are interested in the state of a subject and register their interest with the subject by attaching themselves. When something changes in our subject that the observer may be interested in, a notify message is sent which calls the update method in each observer. When the observer is no longer interested in the subject’s state, they can simply detach themselves. </p>
</blockquote>
<h2 id="经典实现"><a href="#经典实现" class="headerlink" title="经典实现"></a>经典实现</h2><p>观察者模式包含下列组件：</p>
<ul>
<li>Subject: 维护 observers 清单，可添加或移除 observer。由 Subject 衍生出具象类 ConcreteSubject，通过继承或 extend。</li>
<li>Observer: 提供 update 接口。当 observer 对象接到 subject 状态更新的通知时，自动调用 update 方法。由 Observer 衍生出具象类 ConcreteObserver。</li>
<li>ConcreteSubject: 在 Subject 基础上构建，存储主题状态。当状态更新时，通知所有 ConcreteObserver 具体观察者。</li>
<li>ConcreteObserver: 在 Observer 基础上构建，存储 ConcreteSubject 的引用，实现 update 接口。该接口调用时，具体观察者的内部状态 observerState 将与 ConcreteSubject 具体主题对象的 subjectState 状态保持一致。</li>
</ul>
<p>简单实现为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">  observers = <span class="keyword">new</span> ObserverList();</span><br><span class="line"></span><br><span class="line">  attach(observer)&#123;</span><br><span class="line">    <span class="keyword">this</span>.observers.push(observer);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  detach(observer)&#123;</span><br><span class="line">    <span class="keyword">this</span>.observers = <span class="keyword">this</span>.observers.filter(<span class="function"><span class="params">ob</span> =&gt;</span> ob !== observer);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  notify()&#123;</span><br><span class="line">    <span class="keyword">this</span>.observers.map(<span class="function"><span class="params">observer</span> =&gt;</span> observer.update());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Observer</span> </span>&#123;</span><br><span class="line">  update()&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteSubject</span> <span class="keyword">extends</span> <span class="title">Subject</span> </span>&#123;</span><br><span class="line">  subjectState = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  attach(concreteObserver)&#123;</span><br><span class="line">    concreteObserver.concreteSubject = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">super</span>.attach(concreteObserver);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  detach(concreteObserver)&#123;</span><br><span class="line">    concreteObserver.concreteSubject = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">super</span>.detach(concreteObserver);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getState()&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.subjectState;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setState(state)&#123;</span><br><span class="line">    <span class="keyword">this</span>.subjectState = state;</span><br><span class="line">    <span class="keyword">this</span>.notify();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ConcreteObserver</span> </span>&#123;</span><br><span class="line">  observerState = <span class="literal">null</span>;</span><br><span class="line">  concreteSubject = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  update()&#123;</span><br><span class="line">    <span class="keyword">this</span>.observerState = <span class="keyword">this</span>.concreteSubject.getState();</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述实现存在的问题：</p>
<ol>
<li>观察者需要监听多个主题对象的更新状态。可将 subject 实例作为 update 方法的参数，以使 observer 知晓哪个主题对象触发了更新。</li>
<li>多个状态更新过程，将触发同样多个 notify，造成效率低。可由 observer 实例在合并多个状态更新后，控制 notify 方法的调用。</li>
<li>观察者接受通知时，需要额外的附属信息。可由 subject 实例在调用 update 方法时注入参数实现。按参数信息量的大小，可分为推模型(push model)、拉模型(pull model)两类。推模型，subject 将全量信息注入 update 方法；拉模型，subject 只将少量信息注入 update 方法，再由 observer 实例获取 subject 实例的状态。</li>
<li>观察者只对主题对象的部分信息感兴趣。可由 attach(observer, interset?) 方法中添加 interset 参数实现，interset 表示观察者实际感兴趣的方面(aspects)。</li>
<li><p>当主题对象和观察者的依赖关系较为复杂时，需要实现更改管理器 ChangeManager 来管理依赖关系。ChangeManager 的目的尽量减少观察者反映其主题对象的状态变化所需的工作量。ChangeManager 包含三种职责，维护主体对象到观察者的映射，因此就不需要主题对象维护观察者的引用，也不需要观察者维护主题对象的引用；定义一个特定的更新策略；根据主题对象的请求，更新所有观察者。有两种特殊的 ChangeManager，SimpleChangeManager 总是更新每一个主题对象的所有观察者；DAGChangeManager 处理主题对象及其观察者之间依赖关系构成的无环有向图，两个或多个主题对象改变产生冗余更新时，DAGChangeManager 将保证观察者仅接受一个更新。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChangeManager</span> </span>&#123;</span><br><span class="line">  subjectToObserverMap = <span class="keyword">new</span> <span class="built_in">Map</span>;</span><br><span class="line"></span><br><span class="line">  register(subject, observer)&#123;</span><br><span class="line">    <span class="keyword">let</span> observers = <span class="keyword">this</span>.subjectToObserverMap.get(subject);</span><br><span class="line">    <span class="keyword">let</span> has = observers.some(<span class="function"><span class="params">ob</span> =&gt;</span> ob === observer);</span><br><span class="line">    <span class="keyword">if</span> ( !has ) observers.push(observer);</span><br><span class="line">    <span class="keyword">this</span>.subjectToObserverMap.set(subject, observers);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  unregister(subject, observer)&#123;</span><br><span class="line">    <span class="keyword">let</span> observers = <span class="keyword">this</span>.subjectToObserverMap.get(subject);</span><br><span class="line">    observers = observers.some(<span class="function"><span class="params">ob</span> =&gt;</span> ob !== observer);</span><br><span class="line">    <span class="keyword">this</span>.subjectToObserverMap.set(subject, observers);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  notify()&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SimpleChangeManager</span> <span class="keyword">extends</span> <span class="title">ChangeManager</span> </span>&#123;</span><br><span class="line">  notify()&#123;</span><br><span class="line">    subjectToObserverMap.keys.map(<span class="function"><span class="params">subject</span> =&gt;</span> &#123;</span><br><span class="line">      subjectToObserverMap.get(subject).map(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">        observer.update(subject);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DAGChangeManager</span> <span class="keyword">extends</span> <span class="title">ChangeManager</span> </span>&#123;</span><br><span class="line">  notify()&#123;</span><br><span class="line">    <span class="keyword">let</span> shouldUpdate = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    subjectToObserverMap.keys.map(<span class="function"><span class="params">subject</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="comment">/* subject */</span>) shouldUpdate = <span class="literal">true</span>;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    subjectToObserverMap.keys.map(<span class="function"><span class="params">subject</span> =&gt;</span> &#123;</span><br><span class="line">      subjectToObserverMap.get(subject).map(<span class="function"><span class="params">observer</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (shouldUpdate) observer.update();</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>结合主题对象和观察者，将其接口结合在一个类中实现，这样可以避免多重继承。</p>
</li>
</ol>
<h2 id="发布订阅模式"><a href="#发布订阅模式" class="headerlink" title="发布订阅模式"></a>发布订阅模式</h2><p>发布订阅模式(或者事件模型)即是观察者模式的一个变种。观察者模式基于在主题对象(the object firing event)中维护观察者(the object wishing receive topic notiffications)，状态更新时触发观察者的行为实现；当观察者仅对主题对象的部分数据感兴趣时，需要在 attach(observer, interset?) 方法执行过程中注入参数 interset。发布订阅模式通过主题频道(topic channel or event channel，也称为事件频道)关联订阅者(subscribers, the object wishing receive topic notiffications)和发布者(publisher, the object firing event)。简单地说，观察者模式基于主题对象、观察者这两个类实现，各自维护另一方的引用；发布订阅模式基于事件模型实现，订阅者以绑定函数形式存储于 topics 或 events 内部属性中，发布过程即取出绑定函数并执行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基于发布订阅语义</span></span><br><span class="line"><span class="keyword">let</span> subUid = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Pubsub</span> </span>&#123;</span><br><span class="line">  topics = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  subscribe(topic, func)&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.topics[topic])</span><br><span class="line">      <span class="keyword">this</span>.topics[topic] = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> token = (++subUid).toString();</span><br><span class="line">    <span class="keyword">this</span>.topics[topic].push(&#123;</span><br><span class="line">      token: token,</span><br><span class="line">      func: func</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> token;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  publish(topic, ...args)&#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.topics[topic])</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.topics[topic].map(<span class="function"><span class="params">subscriber</span> =&gt;</span> &#123;</span><br><span class="line">      subscriber.func(topic, ...args);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  unsubscribe(token)&#123;</span><br><span class="line">    <span class="keyword">this</span>.topics.map(<span class="function"><span class="params">topic</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.topics[topic] = <span class="keyword">this</span>.topics[topic].filter(<span class="function"><span class="params">subscribe</span> =&gt;</span> subscribe.token !== token);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 基于事件模型语义</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Event</span> </span>&#123;</span><br><span class="line">  events = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  on(event, handler)&#123;<span class="comment">// 也可实现为 linsten, bind 方法</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.events[event])</span><br><span class="line">      <span class="keyword">this</span>.events[event] = [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.events[event].push(handler);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  emit(event, ...args)&#123;<span class="comment">// 也可实现为 trigger, fire 方法</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.events[event])</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.events[event].map(<span class="function"><span class="params">handler</span> =&gt;</span> &#123;</span><br><span class="line">      handler(event, ...args);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  off(event, handler)&#123;<span class="comment">// 也可实现为 remove 方法</span></span><br><span class="line">    <span class="keyword">if</span> ( !<span class="keyword">this</span>.events[event] ) <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( !handler )</span><br><span class="line">      <span class="keyword">this</span>.events[event] = [];</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="keyword">this</span>.events[event] = <span class="keyword">this</span>.events[event].filter(<span class="function"><span class="params">fn</span> =&gt;</span> handler !== fn);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><h3 id="延迟订阅"><a href="#延迟订阅" class="headerlink" title="延迟订阅"></a>延迟订阅</h3><p>在事件模型中，通常需要先添加订阅者，然后再发布事件。在实际业务场景中，有可能存在先发布，发布时还没有订阅者的情景，如 QQ 的离线消息。这时需要构建一个存放离线事件的堆栈(offlineStack)存储发布的消息，当有对象订阅这条消息时，再遍历堆栈，取出事件执行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">OfflineEvent</span> </span>&#123;</span><br><span class="line">  offlineStack = [];</span><br><span class="line"></span><br><span class="line">  on(event, handler, last)&#123;</span><br><span class="line">    <span class="keyword">super</span>.on(event, handler);</span><br><span class="line">    <span class="keyword">if</span> ( last )&#123;</span><br><span class="line">      <span class="keyword">this</span>.offlineStack.pop()();</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.offlineStack.map(<span class="function"><span class="params">fn</span> =&gt;</span> &#123;</span><br><span class="line">        fn();</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  emit(event, ...args)&#123;</span><br><span class="line">    <span class="keyword">let</span> fn = <span class="function"><span class="params">()</span> =&gt;</span> &#123; supper.emit.call(<span class="keyword">this</span>, event, ...args) &#125;;</span><br><span class="line">    <span class="keyword">this</span>.offlineStack.push(fn);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  off(event, handler)&#123;</span><br><span class="line">    <span class="keyword">super</span>.off(event, handler);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="node-events-模块"><a href="#node-events-模块" class="headerlink" title="node: events 模块"></a>node: events 模块</h3><p>events 模块提供 EventEmitter 类，主要实现逻辑见前述 Event 类。</p>
<p>不同的是:</p>
<ol>
<li>once(event, linstener): node 中的 events 模块实现了 once 方法，其实现逻辑为用包装函数(wrapped)装饰 listener，在 emit 方法触发事件调用后，由触发执行的包装函数(wrapped)移除 listener，即调用 eventEmitter.removeListener(event, listener) 方法。</li>
<li>prependListener(event, listener): events 模块还实现了 prependListener 方法，用于在 this._events[event] 数组头部插入 listener，addListener 或 on 方法为尾部插入。</li>
<li>removeListener, removeAllListeners: removeListener(event, listener) 方法只能移除某个绑定函数，即需要指定参数 listener；removeAllListeners(event) 用于移除所有绑定函数，或者某个事件的绑定函数(当指定 event 参数时)，其移除过程中，先移除普通事件的绑定函数，再移除 ‘removeListener’ 事件的绑定函数，即在普通事件的绑定函数移除过程中，仍会触发 ‘removeListener’ 事件。</li>
<li>‘error’ 事件: 对于 ‘error’ 事件，即便没有注册绑定函数，也会以抛出错误对象的形式加以处理。</li>
<li>‘newListener’ 事件: 以 ‘newListener’ 添加的绑定函数，若未曾调用 emit 方法显式触发事件，在下一次 addListener, prependListener 方法执行过程中，将取出 ‘newListener’ 事件的绑定函数，率先执行，即 ‘newListener’ 特殊事件在注册绑定函数时触发执行。</li>
<li>‘removeListener’ 事件: 同 ‘newListener’ 事件，为 events 模块的特殊事件，即在移除绑定函数时触发执行。</li>
<li>在注册绑定函数的过程中，单个绑定函数将以函数形式存储，多个存储为数组形式。</li>
<li>listeners(event), rawListeners(event): 用于获取某个事件的绑定函数。</li>
<li>listenerCount(event): 在 events 模块中，添加和移除绑定函数，都会更新 this._eventsCount 属性(绑定函数个数)，然而 listenerCount(event) 方法用于获取某个事件的绑定函数个数。</li>
<li>setMaxListeners(num), getMaxListeners: 在 events 模块中，this._maxListeners 属性用于限定可注册绑定函数的最大个数，setMaxListeners(num), getMaxListeners 方法即用于设置或获取该值。</li>
</ol>
<p>具体代码，请翻看 node/lib/events.js 文件(version = 9.7.1)。</p>
<h2 id="疑问"><a href="#疑问" class="headerlink" title="疑问"></a>疑问</h2><ol>
<li>关于 DAGChangeManager？</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>[设计模式:可复用面向对象软件的基础]<br><a href="https://addyosmani.com/resources/essentialjsdesignpatterns/book/#observerpatternjavascript" target="_blank" rel="noopener">学习 Javascript 设计模式</a><br>[Javascript 设计模式和开发实践 - 曾探]</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/28/Vue/vue整体架构/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/28/Vue/vue整体架构/" itemprop="url">vue整体架构</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-28T00:00:00+08:00">2018-02-28</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/vue/" itemprop="url" rel="index"><span itemprop="name">vue</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/28/Vue/vue整体架构/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/02/28/Vue/vue整体架构/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br></pre></td><td class="code"><pre><span class="line">|--- compiler <span class="comment"># 将 html 脚本编译为字符串函数体，作为 Vue 实例的 render 方法???</span></span><br><span class="line">  |--- codegen <span class="comment"># 将 ast 转化成字符串拼接的函数内容体</span></span><br><span class="line">    |--- events.js <span class="comment"># 提供 genHandlers(events, isNative, warn) 将 </span></span><br><span class="line">    <span class="comment"># el.events = &#123; name: ['handler1', 'handler2'] &#125; 事件转化为字符串 </span></span><br><span class="line">    <span class="comment"># `on:&#123;$&#123;name&#125;:handler1,handler2&#125;` 形式。html 中绑定事件接受三种形式，</span></span><br><span class="line">    <span class="comment"># 纯函数形式，函数名或方法名，或函数体，由 vue 注入 $event 事件对象</span></span><br><span class="line">    └--- index.js <span class="comment"># 提供 generate(ast, options) 函数，将抽象语法树转化成</span></span><br><span class="line">    <span class="comment"># 字符串拼接的函数 render = `with(this)&#123;return $&#123;code&#125;&#125;`，返回值为</span></span><br><span class="line">    <span class="comment"># &#123; render, staticRenderFns &#125; 对象。options 通过 CodegenState 类</span></span><br><span class="line">    <span class="comment"># 注入全局指令及 options.modules['transformCode'|'genData']</span></span><br><span class="line">  |--- directives <span class="comment"># 注入为 CodegenState 实例的 directives 属性，在 html</span></span><br><span class="line">  <span class="comment"># 中为节点注入指令属性时，在 codegen/index.js 脚本执行 genDirectives 函数</span></span><br><span class="line">  <span class="comment"># 阶段，通过指令属性名获取相应的全局指令脚本 directive，并执行 </span></span><br><span class="line">  <span class="comment"># directives(el, dir, warn)，其中 dir 为指令名</span></span><br><span class="line">    |--- bind.js </span><br><span class="line">    |--- index.js </span><br><span class="line">    |--- model.js </span><br><span class="line">    └--- on.js </span><br><span class="line">  |--- parser <span class="comment"># 将 html 字符串转化成 ast 抽象语法树</span></span><br><span class="line">    |--- entity-decoder.js </span><br><span class="line">    |--- html-parser.js <span class="comment"># 提供 parseHtml(html, options) 函数，解析 html，</span></span><br><span class="line">    <span class="comment"># 通过 options['start'|    'end'|'comment'|'chars'] 提取</span></span><br><span class="line">    <span class="comment"># 节点标签(含属性)、注释和节点内外字符集</span></span><br><span class="line">    |--- index.js <span class="comment"># 提供 parse(template, options) 函数，内部调用 parseHtml </span></span><br><span class="line">    <span class="comment"># 函数，将 html 字符串转化成抽象语法树，树节点 el 注入 parent, children, </span></span><br><span class="line">    <span class="comment"># events, props, attrs, if, for, key, ref 等属性</span></span><br><span class="line">    |--- filter-parser.js <span class="comment"># 提供 parseFilters(exp) 函数，</span></span><br><span class="line">    <span class="comment"># 将 exp = `$&#123;expression&#125;|$&#123;filter&#125;|...` 转换成特定字符串 </span></span><br><span class="line">    <span class="comment"># `_f("$&#123;filter&#125;")($&#123;exp&#125;)`</span></span><br><span class="line">    └--- text-parser.js <span class="comment"># 提供 parseText(text, delimiters?) 函数，</span></span><br><span class="line">    <span class="comment"># 区分对待普通字符串和由分隔符包裹的字符串(应用过滤器，</span></span><br><span class="line">    <span class="comment"># 以 token = `_s($&#123;exp&#125;)` 形式返回)，最终生成 tokens 数组</span></span><br><span class="line">  |--- optimizer.js <span class="comment"># 提供 optimize(root, options) 函数，为视图中不会</span></span><br><span class="line">  <span class="comment"># 改变的静态节点注入 static = true 属性，为只包含文本的静态节点注入</span></span><br><span class="line">  <span class="comment"># staticRoot = true 属性及 staticInFor 属性</span></span><br><span class="line">  |--- create-compiler.js <span class="comment"># 提供 createCompilerCreator(baseCompile) </span></span><br><span class="line">  <span class="comment"># 函数，返回 createCompiler(template, options) 函数，用于创建 </span></span><br><span class="line">  <span class="comment"># &#123; compile, compileToFunctions &#125;。compile 方法，即由通过调用 </span></span><br><span class="line">  <span class="comment"># baseCompile 函数，先执行 parse 函数，后执行 generate 函数，</span></span><br><span class="line">  <span class="comment"># 返回 &#123; render, staticRenderFns, errors,tips &#125; 对象。</span></span><br><span class="line">  <span class="comment"># compileToFunctions 方法即 createCompileToFunctionFn(compile) 返回值</span></span><br><span class="line">  |--- to-function.js <span class="comment"># 提供 createCompileToFunctionFn(compile) 函数，</span></span><br><span class="line">  <span class="comment"># 返回 compileToFunctions(template, options?, vm?) 函数。</span></span><br><span class="line">  <span class="comment"># compileToFunctions 函数同样返回 &#123; render, staticRenderFns &#125; 对象，</span></span><br><span class="line">  <span class="comment"># 其中 render 方法用于将 compile().render 字符串构建为函数并执行</span></span><br><span class="line">  |--- index.js <span class="comment"># 通过为 createCompilerCreator 函数注入 baseCompile 回调，</span></span><br><span class="line">  <span class="comment"># 返回 &#123; compile, compileToFunctions &#125; 对象，见 create-compiler.js 文件注释</span></span><br><span class="line">  |--- error-detector.js</span><br><span class="line">  └--- helpers.js <span class="comment"># 工具函数</span></span><br><span class="line">|--- core</span><br><span class="line">  |--- components </span><br><span class="line">    |--- index.js </span><br><span class="line">    └--- keep-alive.js </span><br><span class="line">  |--- global-api </span><br><span class="line">    |--- use.js <span class="comment"># 添加 Vue.use(plugin, ...args) 静态方法，插件机制，直接执行插件</span></span><br><span class="line">    <span class="comment"># plugin 函数或 plugin.install 函数</span></span><br><span class="line">    |--- mixin.js <span class="comment"># 添加 Vue.mixin(obj) 静态方法，参数 obj 将混入到 Vue.options 属性中</span></span><br><span class="line">    |--- extend.js <span class="comment"># 添加 Vue.extend(options) 静态方法，基于 Vue 构造函数，创建子构造函数</span></span><br><span class="line">    <span class="comment"># 可用于创建生成 vue 实例的工厂函数，由 instance/init.js 模块将各类的 options 注入为</span></span><br><span class="line">    <span class="comment"># Vue 实例的 $options 属性</span></span><br><span class="line">    |--- assets.js <span class="comment"># 添加 Vue['component'|'directive'|'filter'](id, definition?) </span></span><br><span class="line">    <span class="comment"># 静态方法，获取或添加 Vue.options['components'|'directives'|'filters'][id]，</span></span><br><span class="line">    <span class="comment"># 用于创建全局组件、指令或过滤器</span></span><br><span class="line">    └--- index.js <span class="comment"># 添加 Vue.config 静态属性，Vue.util 工具函数集合，</span></span><br><span class="line">    <span class="comment"># Vue.['set'|'delete'|'nextTick'] 静态方法</span></span><br><span class="line">  |--- instance </span><br><span class="line">    |--- render-helpers</span><br><span class="line">      |--- <span class="built_in">bind</span>-object-listeners.js</span><br><span class="line">      |--- <span class="built_in">bind</span>-object-props.js</span><br><span class="line">      |--- check-keycodes.js</span><br><span class="line">      |--- index.js</span><br><span class="line">      |--- render-list.js</span><br><span class="line">      |--- render-slot.js</span><br><span class="line">      |--- render-static.js</span><br><span class="line">      |--- resolve-filter.js</span><br><span class="line">      └--- resolve-slots.js</span><br><span class="line">    |--- init.js <span class="comment"># initMixin(Vue) 为 Vue 添加 _init(options) 原型方法，</span></span><br><span class="line">    <span class="comment"># 合并祖先组件的 options 及 options 入参，赋值给 vm.$options，</span></span><br><span class="line">    <span class="comment"># 相继调用 initProxy, initLifecycle, initEvents, initRender, </span></span><br><span class="line">    <span class="comment"># initInjections, initState, initProvide 方法，执行 'beforeCreate', 'mounted' </span></span><br><span class="line">    <span class="comment"># 生命周期方法，条件调用 $mount(vm.$options.el) 挂载组件</span></span><br><span class="line">    |--- proxy.js <span class="comment"># initProxy(vm)，赋值vm._renderProxy，用户通过 vm._renderProxy </span></span><br><span class="line">    <span class="comment"># 获取不存在的 vm 属性时将会予以警告</span></span><br><span class="line">    |--- lifecycle.js <span class="comment"># initLifecycle(vm)，初始化生命周期相关属性</span></span><br><span class="line">    <span class="comment"># lifecycleMixin(Vue) 为 Vue 添加 _update, $forceUpdate, $destory 原型方法；</span></span><br><span class="line">    <span class="comment"># mountComponent(vm, el, hydrating?) 构建 Watcher 实例，回调中执行 </span></span><br><span class="line">    <span class="comment"># vm._update 方法，执行 'beforeCreate', 'mounted' 方法；</span></span><br><span class="line">    <span class="comment"># update(vm, propsData, listeners, parentVnode, renderChildren) 调用 </span></span><br><span class="line">    <span class="comment"># vm.$forceUpdate 方法更新视图???</span></span><br><span class="line">    <span class="comment"># activateChildComponent(vm, direct?), deactivateChildComponent(vm, direct?)；</span></span><br><span class="line">    <span class="comment"># callHook(vm, hook) 执行 vm.$options[hook]，条件调用 vm.$emit(`hook:$&#123;hook&#125;`)</span></span><br><span class="line">    |--- events.js <span class="comment"># initEvents(vm) 通过 vm.$on, vm.$once 绑定 </span></span><br><span class="line">    <span class="comment"># vm.$options._parentListeners 函数；eventMixin(Vue) 为 Vue 添加 </span></span><br><span class="line">    <span class="comment"># $on, $once, $off, $emit 原型方法，注册事件存储在 vm._events 属性中</span></span><br><span class="line">    |--- render.js <span class="comment"># initRender(vm) 设置 vm['$node'|'$slot'|'$scopeSlots'|</span></span><br><span class="line">    <span class="comment"># '$createElement'|'_c'] 属性或方法，调用 defineReactive 使 </span></span><br><span class="line">    <span class="comment"># vm['$attrs'|'listeners'] 为响应式；renderMixin(Vue) 为 Vue 添加 </span></span><br><span class="line">    <span class="comment"># $nextTick, _render(调用 vm.$options.render 创建 Vnode), </span></span><br><span class="line">    <span class="comment"># _o, _n, _s, _l, ... (注入 compile 函数)等方法</span></span><br><span class="line">    |--- inject.js <span class="comment"># 组件跨级传递数据。initProvider(vm) 将 vm.$options.provide </span></span><br><span class="line">    <span class="comment"># 赋值给 vm._provide；initInjections 调用 defineReactive 将先辈组件传入的</span></span><br><span class="line">    <span class="comment"># 数据响应式化；resolveInject 获取先辈组件的数据</span></span><br><span class="line">    |--- state.js <span class="comment"># proxy(target, sourceKey, key) 将 target[sourceKey][key] </span></span><br><span class="line">    <span class="comment"># 代理为 target[key]；initState(vm) 调用 initProps, initMethods, initData, </span></span><br><span class="line">    <span class="comment"># initComputed, initWatch，间接使用 defineReactive 或 new Watch 响应化</span></span><br><span class="line">    <span class="comment"># 数据或观察数据；stateMixin(Vue) 为 Vue 添加 $data, $props 只读属性，</span></span><br><span class="line">    <span class="comment"># $set, $delete, watch(expOrFn, cb, options?) 原型方法</span></span><br><span class="line">    └--- index.js <span class="comment"># Vue 构造函数，调用 initMixin(Vue), stateMixin(Vue), </span></span><br><span class="line">    <span class="comment"># eventsMixin(Vue), lifecycleMixin(Vue), renderMixin(Vue) 注入原型方法</span></span><br><span class="line">  |--- observer </span><br><span class="line">    |--- index.js <span class="comment"># observerState.shouldConvert 是否将新值转换为响应式；</span></span><br><span class="line">    <span class="comment"># new Observer(value)，若 value 为数组，改写 push 方法，递归为数组项生成 </span></span><br><span class="line">    <span class="comment"># Observer 实例；若 value 为对象，调用 defineReactive 函数使属性响应化，</span></span><br><span class="line">    <span class="comment"># value.__ob__ 挂载 Observer 实例；observer(value, asRootData?) 创建</span></span><br><span class="line">    <span class="comment"># 并返回 value 对应的 Observer 实例；defineReactive 函数调用 </span></span><br><span class="line">    <span class="comment"># Object.defineProperty 方法重写属性的访问器属性，set 方法触发 dep.notify，</span></span><br><span class="line">    <span class="comment"># get 方法触发 dep.depend 方法；set 函数将新添加的属性转化为响应式；</span></span><br><span class="line">    <span class="comment"># delete 函数删除属性触发 dep.notify 方法</span></span><br><span class="line">    |--- array.js <span class="comment"># arrayMethods 提供改写数组 push 等方法的对象，push 等方法</span></span><br><span class="line">    <span class="comment"># 执行时触发 dep.notify 方法调用</span></span><br><span class="line">    |--- dep.js <span class="comment"># Dep 类，管理订阅者，addSub, removeSub 添加或移除订阅者，</span></span><br><span class="line">    <span class="comment"># depend 使 dep 和 Dep.target = watcher 实例相互关联，notify 调用</span></span><br><span class="line">    <span class="comment"># 订阅者的 update 方法；pushTarget, popTarget 更改 Dep.Target</span></span><br><span class="line">    |--- watcher.js <span class="comment"># new Watcher(vm, expOrFn, cb, options?) 通过更改</span></span><br><span class="line">    <span class="comment"># 响应式数据，触发 dep.notify 调用 watcher.update，执行 cb 回调</span></span><br><span class="line">    └--- scheduler.js <span class="comment"># queueWatcher(watcher) 将 watcher 置入队列，</span></span><br><span class="line">    <span class="comment"># 通过 nextTick 在下次渲染完成后调用 watcher 队列的 run 方法，执行其 </span></span><br><span class="line">    <span class="comment"># cb 回调，并调用 'updated', 'activated' 生命周期方法；</span></span><br><span class="line">    <span class="comment"># queueActivatedComponent(vm) 将 vm 加入 activatedChildren 队列，</span></span><br><span class="line">    <span class="comment"># 用于触发 'activated' 生命周期方法</span></span><br><span class="line">  |--- util </span><br><span class="line">    |--- debug.js </span><br><span class="line">    |--- env.js </span><br><span class="line">    |--- error.js </span><br><span class="line">    |--- index.js</span><br><span class="line">    |--- lang.js </span><br><span class="line">    |--- options.js </span><br><span class="line">    |--- perf.js</span><br><span class="line">    └--- props.js </span><br><span class="line">  |--- vdom </span><br><span class="line">    |--- helpers</span><br><span class="line">      |--- extract-props.js </span><br><span class="line">      |--- get-first-component-child.js </span><br><span class="line">      |--- index.js</span><br><span class="line">      |--- is-async-placeholder.js </span><br><span class="line">      |--- merge-hook.js </span><br><span class="line">      |--- normalize-children.js</span><br><span class="line">      |--- resolve-async-component.js </span><br><span class="line">      └--- update-listeners.js</span><br><span class="line">    |--- modules</span><br><span class="line">      |--- directives.js</span><br><span class="line">      |--- index.js </span><br><span class="line">      └--- ref.js</span><br><span class="line">    |--- vnode.js <span class="comment"># Vnode 类，虚拟节点，其 context 属性通常为 vm 实例；</span></span><br><span class="line">    <span class="comment"># createEmptyNode(text) 创建注释节点，createTextNode(text) 创建文本节点</span></span><br><span class="line">    <span class="comment"># cloneNode(vnode, deep?), cloneNodes(vnodes, deep?) 复制节点</span></span><br><span class="line">    |--- create-element.js <span class="comment"># 提供 _createElement(context, tag?, data?, </span></span><br><span class="line">    <span class="comment"># children, normalizationType?) 函数，区分固有元素、已定义组件名、组件的</span></span><br><span class="line">    <span class="comment"># 构造函数等情况，创建 Vnode 实例；createElement 函数，调用 _createElement，</span></span><br><span class="line">    <span class="comment"># 构建 vm._c, vm.$createElement，创建 Vnode 实例</span></span><br><span class="line">    |--- create-component.js <span class="comment"># 提供 createComponent(Ctor, data, context, </span></span><br><span class="line">    <span class="comment"># children, tag?) 参数 Ctor 为构造函数、options 对象或 async 函数，</span></span><br><span class="line">    <span class="comment"># context 为 vm 实例，data 来自 ast，当 options.functional 为真值，</span></span><br><span class="line">    <span class="comment"># 为无状态组件，最终创建 Vnode</span></span><br><span class="line">    |--- create-functional-component.js <span class="comment"># 提供 createFunctionalComponent</span></span><br><span class="line">    <span class="comment"># (Ctor, propsData, data, contextVm, children) 函数，无状态组件，</span></span><br><span class="line">    <span class="comment"># 不会生成 Vue 实例，没有 data，最终创建 Vnode</span></span><br><span class="line">    └--- patch.js <span class="comment"># 提供 createPatchFunction(backend) 函数，参数 backend 中，</span></span><br><span class="line">    <span class="comment"># nodeOpts 属性为平台节点操作，modules 数组为平台属性、样式、事件操作以及</span></span><br><span class="line">    <span class="comment"># Vue 特有的指令、ref 引用操作，生成 patch(oldVnode, Vnode, hydrating, </span></span><br><span class="line">    <span class="comment"># removeOnly, parentElm, refElm) 函数，绘制或重绘视图</span></span><br><span class="line">  |--- config.js </span><br><span class="line">  └--- index.js </span><br><span class="line">|--- platforms</span><br><span class="line">  |--- web</span><br><span class="line">    |--- compiler</span><br><span class="line">      |--- directives</span><br><span class="line">        |--- html.js</span><br><span class="line">        |--- index.js</span><br><span class="line">        |--- model.js</span><br><span class="line">        └--- text.js</span><br><span class="line">      |--- modules</span><br><span class="line">        |--- class.js</span><br><span class="line">        |--- index.js</span><br><span class="line">        |--- model.js</span><br><span class="line">        └--- style.js</span><br><span class="line">      |--- index.js</span><br><span class="line">      |--- options.js</span><br><span class="line">      └--- util.js</span><br><span class="line">    |--- runtime</span><br><span class="line">      |--- components</span><br><span class="line">        |--- index.js</span><br><span class="line">        |--- transition-group.js</span><br><span class="line">        └--- transition.js</span><br><span class="line">      |--- directives</span><br><span class="line">        |--- index.js</span><br><span class="line">        |--- model.js</span><br><span class="line">        └--- show.js</span><br><span class="line">      |--- modules</span><br><span class="line">        |--- attrs.js <span class="comment"># 浏览器端 updateAttrs(oldVnode, vnode) 更新 attr 属性</span></span><br><span class="line">        <span class="comment"># 返回 &#123; create: updateAttrs, update: updateAttrs &#125;</span></span><br><span class="line">        |--- class.js <span class="comment"># 浏览器端 updateClass(oldVnode, vnode) 更新 class 属性</span></span><br><span class="line">        <span class="comment"># 返回 &#123; create: updateClass, update: updateClass &#125;</span></span><br><span class="line">        |--- dom-props.js <span class="comment"># 浏览器端 updateDOMProps(oldVnode, vnode) 更新 prop 属性</span></span><br><span class="line">        <span class="comment"># 返回 &#123; create: updateDOMProps, update: updateDOMProps &#125;</span></span><br><span class="line">        |--- events.js <span class="comment"># 浏览器端 updateDOMListeners(oldVnode, vnode) 更新绑定事件，</span></span><br><span class="line">        <span class="comment"># updateDOMListeners 将为 core/vdom/helpers/index.js 模块注入 add, remove，</span></span><br><span class="line">        <span class="comment"># 返回 &#123; create: updateDOMListeners, update: updateDOMListeners &#125;</span></span><br><span class="line">        |--- style.js <span class="comment"># 浏览器端 updateStyle(oldVnode, vnode) 更新 style 属性</span></span><br><span class="line">        <span class="comment"># 返回 &#123; create: updateStyle, update: updateStyle &#125;</span></span><br><span class="line">        |--- transition.js</span><br><span class="line">        └--- index.js <span class="comment"># 用于构建传入 createPatchFunction(backend) 函数中的 </span></span><br><span class="line">        <span class="comment"># backend.modules 数组，浏览器端节点属性、类、事件、样式操作</span></span><br><span class="line">      |--- class-util.js <span class="comment"># 浏览器端 addClass(el, cls), removeClass(el, cls) 函数</span></span><br><span class="line">      |--- transition-util.js <span class="comment"># resolveTransition(def?) 构建 transition 类名；</span></span><br><span class="line">      <span class="comment"># transitionProp, transitionEndEvent, animationProp, animationEndEvent </span></span><br><span class="line">      <span class="comment"># 相关事件名；nextFrame(fn) 通过 requestAnimationFrame 或 setTimeout </span></span><br><span class="line">      <span class="comment"># 执行 fn 函数；addTransitionClass(el, cls), removeTransitionClass(el, cls)，</span></span><br><span class="line">      <span class="comment"># 类操作；getTransitionInfo(el, expectedType?) 通过 el 样式获取相关属性；</span></span><br><span class="line">      <span class="comment"># whenTransitionEnds(el, expectedType, cb) 通过事件执行 cb 回调</span></span><br><span class="line">      |--- node-ops.js <span class="comment"># 浏览器端 createElement(tagName, vnode), </span></span><br><span class="line">      <span class="comment"># createElementNS(namespace, tagName), createTextNode(text), </span></span><br><span class="line">      <span class="comment"># createComment(text), insertBefore(parentNode, newNode, referenceNode), </span></span><br><span class="line">      <span class="comment"># removeChild(node, child), appendChild(node, child), parentNode(node), </span></span><br><span class="line">      <span class="comment"># nextSibling(node), tagName(node), setTextContext(node), </span></span><br><span class="line">      <span class="comment"># setAttribute(node, key, val) 函数</span></span><br><span class="line">      <span class="comment"># 用于构建传入 createPatchFunction(backend) 函数中的 backend.nodeOpts</span></span><br><span class="line">      |--- patch.js <span class="comment"># 通过 core/vdom/patch.js 模块构建 patch 函数</span></span><br><span class="line">      └--- index.js <span class="comment"># 添加 Vue.config 属性；添加 Vue.options.directives 指令，</span></span><br><span class="line">      <span class="comment"># 添加 Vue.options.components 组件；添加 __patch__, $mount 原型方法；</span></span><br><span class="line">      <span class="comment"># devtools 触发 'emit' 事件；导出 Vue</span></span><br><span class="line">    |--- server</span><br><span class="line">      |--- directives</span><br><span class="line">        |--- index.js</span><br><span class="line">        └--- show.js</span><br><span class="line">      |--- modules</span><br><span class="line">        |--- attrs.js</span><br><span class="line">        |--- class.js</span><br><span class="line">        |--- dom-props.js</span><br><span class="line">        |--- index.js</span><br><span class="line">        └--- style.js</span><br><span class="line">      |--- compiler.js</span><br><span class="line">      └--- util.js</span><br><span class="line">    |--- util</span><br><span class="line">      |--- attrs.js</span><br><span class="line">      |--- class.js</span><br><span class="line">      |--- compat.js</span><br><span class="line">      |--- element.js</span><br><span class="line">      |--- index.js</span><br><span class="line">      └--- style.js</span><br><span class="line">    |--- entry-runtime.js <span class="comment"># 导出 web/runtime/index.js 文件中的 Vue 构造函数</span></span><br><span class="line">    |--- entry-compiler.js</span><br><span class="line">    |--- entry-runtime-with-compiler.js <span class="comment"># 改写 $mount 原型方法，通过 template </span></span><br><span class="line">    <span class="comment"># 节点、html 字符串或节点 id，设置 options.render 方法，随后挂载组件；</span></span><br><span class="line">    <span class="comment"># 添加 Vue.compile =  compileToFunctions 静态方法</span></span><br><span class="line">    |--- entry-server-basic-renderer.js</span><br><span class="line">    └--- entry-server-renderer.js</span><br><span class="line">  └--- weex</span><br><span class="line">    |--- compiler</span><br><span class="line">      |--- directives</span><br><span class="line">        |--- index.js</span><br><span class="line">        └--- model.js</span><br><span class="line">      |--- modules</span><br><span class="line">        |--- append.js</span><br><span class="line">        |--- class.js</span><br><span class="line">        |--- index.js</span><br><span class="line">        |--- props.js</span><br><span class="line">        └--- style.js</span><br><span class="line">      └--- index.js</span><br><span class="line">    |--- runtime</span><br><span class="line">      |--- components</span><br><span class="line">        |--- index.js</span><br><span class="line">        |--- richtext.js</span><br><span class="line">        |--- transition-group.js</span><br><span class="line">        └--- transition.js</span><br><span class="line">      |--- directives</span><br><span class="line">        └--- index.js</span><br><span class="line">      |--- modules</span><br><span class="line">        |--- attrs.js</span><br><span class="line">        |--- class.js</span><br><span class="line">        |--- events.js</span><br><span class="line">        |--- index.js</span><br><span class="line">        |--- style.js</span><br><span class="line">        └--- transition.js</span><br><span class="line">      |--- index.js</span><br><span class="line">      |--- node-ops.js</span><br><span class="line">      |--- patch.js</span><br><span class="line">      └--- text-node.js</span><br><span class="line">    |--- util</span><br><span class="line">      └--- index.js</span><br><span class="line">    |--- entry-compiler.js</span><br><span class="line">    |--- entry-framework.js</span><br><span class="line">    └--- entry-runtime-factory.js</span><br><span class="line">|--- server</span><br><span class="line">  |--- bundle-renderer.js </span><br><span class="line">    |--- create-bundle-renderer.js</span><br><span class="line">    |--- create-bundle-runner.js</span><br><span class="line">    └--- <span class="built_in">source</span>-map-support.js</span><br><span class="line">  |--- optimizing-compiler.js </span><br><span class="line">    |--- codegen.js</span><br><span class="line">    |--- index.js</span><br><span class="line">    |--- modules.js</span><br><span class="line">    |--- optimizer.js</span><br><span class="line">    └--- runtime-helpers.js</span><br><span class="line">  |--- template-renderer.js </span><br><span class="line">    |--- create-async-file-mapper.js</span><br><span class="line">    |--- index.js</span><br><span class="line">    |--- parse-template.js</span><br><span class="line">    └--- template-stream.js</span><br><span class="line">  |--- webpack-plugin.js </span><br><span class="line">    |--- client.js</span><br><span class="line">    |--- server.js</span><br><span class="line">    └--- util.js</span><br><span class="line">  |--- create-basic-renderer.js </span><br><span class="line">  |--- create-renderer.js </span><br><span class="line">  |--- render-context.js </span><br><span class="line">  |--- render-stream.js </span><br><span class="line">  |--- render.js </span><br><span class="line">  |--- util.js </span><br><span class="line">  └--- write.js </span><br><span class="line">|--- sfc</span><br><span class="line">  └--- parser.js </span><br><span class="line">└--- shared</span><br><span class="line">  |--- constants.js <span class="comment"># 导出 SSR_ATTR 服务器端渲染, ASSET_TYPES 静态成员名</span></span><br><span class="line">  <span class="comment"># (component, directive, filter), LIFECYCLE_HOOKS 生命周期钩子</span></span><br><span class="line">  └--- util.js</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/25/Js/typescript文档笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/25/Js/typescript文档笔记/" itemprop="url">typescript文档笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-25T00:00:00+08:00">2018-02-25</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/js/" itemprop="url" rel="index"><span itemprop="name">js</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/25/Js/typescript文档笔记/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/02/25/Js/typescript文档笔记/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="基础类型"><a href="#基础类型" class="headerlink" title="基础类型"></a>基础类型</h2><p>ts 基础类型包含 boolean, number, string, array, tuple 元祖, enum, any 任意类型, void 非任意类型(可赋值为 undefined 或 null，通常用于函数无返回值时), undefined, null, never 永不存在值的类型(通常用于函数报错或陷入死循环时), symbol。</p>
<p>其中，数值类型支持十进制、十六进制、八进制和二进制字面量。</p>
<p>字符串类型支持 es6 模板字符串。</p>
<p>数组类型 Array<t> 限定元素类型一致，使用 let list: number[] = [1, 2, 3]; 或 let list: Array<number> = [1, 2, 3]; 声明。ReadonlyArray<t> 只读数组类型，不能将其赋值给普通数组，但可以通过类型断言将其转化为普通数组，如 numberReadonlyArray as number[]。</t></number></t></p>
<p>元祖类型预先声明元素类型，元素类型可以不一致。如 let x: [string, number]; x = [‘hello’, 10]; 同时，对于新增的元素，其类型必须在已声明类型中。上述示例中，x[6] = true; 将报错。</p>
<p>枚举从 0 开始为元素编号，也可以手动编号，如 enum Color {Red = 1, Green, Blue}; 通过 Color.Red 或 Color[1] 可以获取枚举值。</p>
<p>symbol 类型的值是通过 Symbol 构造函数创建，其值不可改变且唯一，如 let sym = Symbol()。es6 支持。</p>
<h3 id="类型断言"><a href="#类型断言" class="headerlink" title="类型断言"></a>类型断言</h3><p>类型断言使用 <type>value 或 value as Type；JSX 中只能使用 as，不能使用尖括号。TS 尝试做类型转换，而没有类型检查和结构。</type></p>
<h3 id="Symbol"><a href="#Symbol" class="headerlink" title="Symbol"></a>Symbol</h3><ul>
<li>Symbol.hasInstance 方法，instanceof 运算符内部调用 Symbol.hasInstance 方法。</li>
<li>Symbol.iterator 方法，for-of语句内部调用 Symbol.iterator 方法，返回对象的默认迭代器。</li>
<li>Symbol.isConcatSpreadable 属性，Array.prototype.concat 方法内部使用 Symbol.isConcatSpreadable 判断数组是否可展开。</li>
<li>Symbol.match 方法，String.prototype.match 方法内部调用 Symbol.match 方法。</li>
<li>Symbol.replace 方法，String.prototype.replace 方法内部调用 Symbol.replace 方法。</li>
<li>Symbol.search 方法，String.prototype.search 方法内部调用 Symbol.search 方法。</li>
<li>Symbol.split 方法，String.prototype.split 方法内部调用 Symbol.split 方法。</li>
<li>Symbol.toStringTag 方法，Object.prototype.toString 方法内部调用 Symbol.toStringTag 方法。</li>
<li>Symbol.species 构造函数，用于创建派生对象。</li>
<li>Symbol.toPrimitive 方法，ToPrimitive 抽象操作调用 Symbol.toPrimitive 方法，把对象转换为相应的原始值。</li>
<li>Symbol.unscopables 对象，它自己拥有的属性会被with作用域排除在外。</li>
</ul>
<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><p>let 为块级作用域，用于修正 var 为函数、模块级作用域的怪异问题。<br>const 块级作用域，常量。</p>
<h3 id="块级作用域"><a href="#块级作用域" class="headerlink" title="块级作用域"></a>块级作用域</h3><p>var 变量的声明会在编译阶段上移到函数、模块头部，因此造成怪异一为在 if, for 语句中声明的 var 变量可以在条件或循环语句外访问；造成怪异二为在内外两层 for 语句条件体内声明的同一变量引用同一个变量；造成怪异三为 for 语句执行过程有延迟，其最终引用的是条件体执行完成的结果。</p>
<p>推想 let 修正块级作用域的过程，就是在编译过程中用匿名函数包裹代码块(if, for, {} 平级)，var 变量在该匿名函数中声明，可以解决怪异一、二；使用闭包包裹延迟函数，可以在延迟函数等待期间保留原有的作用域，这可能会导致内存泄漏。</p>
<h3 id="解构"><a href="#解构" class="headerlink" title="解构"></a>解构</h3><p>数组使用 [ item1, item2, …rests ] = arr; 语法解构，如 [first, second] = [second, first]; 即为变量交换数据。</p>
<p>对象使用 { prop1, prop2, …rests } = obj; 语法解构。</p>
<p>属性重命名采用 “:”，默认值采用 “=”，如 { prop1 = “default”, prop2: “key” }。</p>
<p>解构适用于函数入参。</p>
<h3 id="展开"><a href="#展开" class="headerlink" title="展开"></a>展开</h3><p>展开同样使用 “…”，如 val = { prop1: “value”, …obj }。</p>
<h2 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h2><h3 id="接口作为类型"><a href="#接口作为类型" class="headerlink" title="接口作为类型"></a>接口作为类型</h3><p>当使用 value: Interface 语法将接口用于类型检查时，value 必须满足 Interface 声明的结构化类型，即 value 作为对象时，其属性需满足 Interface 属性的类型规则，允许 value 包含接口未声明的额外属性；value 作为函数时，其入参、返回值须满足接口约定的类型规则，value 参数名可与 Interface 定义的名字不同。</p>
<p>接口类型使用 “?” 后缀声明可选属性，当可选属性存在时，且 value 为对象字面量时，将不允许 value 包含接口未声明的额外属性；若 value 为变量，则允许。</p>
<p>使用 “readonly” 修饰符声明只读属性。</p>
<p>使用 [propName: Type1]: Type2 索引签名可用于接受特定类型的属性，Type1 用于约定索引的类型(索引包含对象的属性和数组项)，Type2 用于约定值类型。索引签名 Type1 可以是 “string”, “number” 中的一个，数字通过转化为字符串索引对象，因此数字索引的返回值必须是字符串索引的返回值的子类型。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">interface SquareConfig &#123;</span><br><span class="line">  color?: string;</span><br><span class="line">  width?: number;</span><br><span class="line">  [propName: string]: any;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface SearchFunc &#123;</span><br><span class="line">  (source: string, <span class="attr">subString</span>: string): boolean;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 关于索引类型</span></span><br><span class="line">interface NumberDictionary &#123;</span><br><span class="line">  [index: string]: number;</span><br><span class="line">  length: number;<span class="comment">// 可以，length是number类型</span></span><br><span class="line">  name: string<span class="comment">// 错误，`name`的类型与索引类型返回值的类型不匹配</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="接口用于实现"><a href="#接口用于实现" class="headerlink" title="接口用于实现"></a>接口用于实现</h3><p>接口描述了类的公共部分，但不包含私有部分。</p>
<p>当类实现了接口时，只对其实例部分进行类型检查，而 constructor 方法属于类的静态部分。对 constructor 方法进行校验需要由工厂函数完成。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">interface ClockConstructor &#123;</span><br><span class="line">  <span class="keyword">new</span> (hour: number, <span class="attr">minute</span>: number): ClockInterface;</span><br><span class="line">&#125;</span><br><span class="line">interface ClockInterface &#123;</span><br><span class="line">  tick();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createClock</span>(<span class="params">ctor: ClockConstructor, hour: number, minute: number</span>): <span class="title">ClockInterface</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> ctor(hour, minute);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DigitalClock</span> <span class="title">implements</span> <span class="title">ClockInterface</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(h: number, m: number) &#123; &#125;</span><br><span class="line">  tick() &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"beep beep"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> digital = createClock(DigitalClock, <span class="number">12</span>, <span class="number">17</span>);</span><br></pre></td></tr></table></figure>
<p>接口可以继承接口，且一个接口可以继承多个接口。</p>
<p>接口可以继承类。当接口继承类时，接口会继承类的private和protected成员，但不包含类的实现。继承类的接口只能被该类及其子类继承。</p>
<h2 id="类"><a href="#类" class="headerlink" title="类"></a>类</h2><p>子类通过 super 关键字访问父类，如 super() 用于执行父类的构造函数。</p>
<p>public 关键字用于声明公共属性，默认使用 public 修饰符；protected 关键字用于声明保护属性；private 关键字用于声明私有属性。实例含有相同的公共属性、私有属性，且这些公共属性、私有属性声明在同一个类中，两个实例就是兼容的，就可以互相赋值，否则会报错。</p>
<p>constructor 构造函数也能被标注为 protected，意味着这个类不能在包含它的类外被实例化，但是能被继承。</p>
<p>对构造函数的入参使用 private, protected, public 修饰符时，类初始化将构建同名私有属性、保护属性、公共属性。</p>
<p>readonly 关键字用于声明只读属性，只读属性必须在声明时或构造函数里被初始化。</p>
<p>get, set 关键字用于声明存取器属性，需要将编译器设置为输出ECMAScript 5或更高，只带有 get 不带有 set的存取器自动被推断为 readonly。</p>
<p>static 关键字用于声明静态属性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  protected name: string;</span><br><span class="line">  protected <span class="keyword">constructor</span>(theName: string) &#123; <span class="keyword">this</span>.name = theName; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Employee 能够继承 Person</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Employee</span> <span class="keyword">extends</span> <span class="title">Person</span> </span>&#123;</span><br><span class="line">  private department: string;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(name: string, department: string) &#123;</span><br><span class="line">    <span class="keyword">super</span>(name);</span><br><span class="line">    <span class="keyword">this</span>.department = department;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  public getElevatorPitch() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">`Hello, my name is <span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span> and I work in <span class="subst">$&#123;<span class="keyword">this</span>.department&#125;</span>.`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> howard = <span class="keyword">new</span> Employee(<span class="string">"Howard"</span>, <span class="string">"Sales"</span>);</span><br><span class="line"><span class="keyword">let</span> john = <span class="keyword">new</span> Person(<span class="string">"John"</span>); <span class="comment">// 错误: 'Person' 的构造函数是被保护的.</span></span><br></pre></td></tr></table></figure>
<h3 id="抽象类"><a href="#抽象类" class="headerlink" title="抽象类"></a>抽象类</h3><p>abstract 关键字用于声明抽象类。在抽象类，abstract 关键字还可以用于声明抽象方法，抽象方法只定义方法签名但不包含方法体，即不包含实现。由子类提供具体方法。</p>
<h3 id="Mixins混入"><a href="#Mixins混入" class="headerlink" title="Mixins混入"></a>Mixins混入</h3><p>ts 中的类，可以用 implements 关键字实现多个类，即将类视为接口，需要在实现类中添加接口类的成员属性，再通过 applyMixins 等自定义函数将接口类的原型属性赋给实现类。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Disposable Mixin</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Disposable</span> </span>&#123;</span><br><span class="line">  isDisposed: boolean;</span><br><span class="line">  dispose() &#123;</span><br><span class="line">    <span class="keyword">this</span>.isDisposed = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Activatable Mixin</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Activatable</span> </span>&#123;</span><br><span class="line">  isActive: boolean;</span><br><span class="line">  activate() &#123;</span><br><span class="line">    <span class="keyword">this</span>.isActive = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  deactivate() &#123;</span><br><span class="line">    <span class="keyword">this</span>.isActive = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SmartObject</span> <span class="title">implements</span> <span class="title">Disposable</span>, <span class="title">Activatable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    setInterval(<span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">console</span>.log(<span class="keyword">this</span>.isActive + <span class="string">" : "</span> + <span class="keyword">this</span>.isDisposed), <span class="number">500</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  interact() &#123;</span><br><span class="line">    <span class="keyword">this</span>.activate();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Disposable</span></span><br><span class="line">  isDisposed: boolean = <span class="literal">false</span>;</span><br><span class="line">  dispose: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line">  <span class="comment">// Activatable</span></span><br><span class="line">  isActive: boolean = <span class="literal">false</span>;</span><br><span class="line">  activate: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line">  deactivate: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line">&#125;</span><br><span class="line">applyMixins(SmartObject, [Disposable, Activatable]);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> smartObj = <span class="keyword">new</span> SmartObject();</span><br><span class="line">setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> smartObj.interact(), <span class="number">1000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">////////////////////////////////////////</span></span><br><span class="line"><span class="comment">// In your runtime library somewhere</span></span><br><span class="line"><span class="comment">////////////////////////////////////////</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">applyMixins</span>(<span class="params">derivedCtor: any, baseCtors: any[]</span>) </span>&#123;</span><br><span class="line">  baseCtors.forEach(<span class="function"><span class="params">baseCtor</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="built_in">Object</span>.getOwnPropertyNames(baseCtor.prototype).forEach(<span class="function"><span class="params">name</span> =&gt;</span> &#123;</span><br><span class="line">      derivedCtor.prototype[name] = baseCtor.prototype[name];</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><p>定义函数时，可以声明参数和返回值的类型，如 (arg: Type1) =&gt; Type2 {} 或 function(arg: Type1): Type2 {}。</p>
<p>函数重载通过定义多个函数类型来实现。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> suits = [<span class="string">"hearts"</span>, <span class="string">"spades"</span>, <span class="string">"clubs"</span>, <span class="string">"diamonds"</span>];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pickCard</span>(<span class="params">x: &#123;suit: string; card: number; &#125;[]</span>): <span class="title">number</span>;</span></span><br><span class="line"><span class="function"><span class="title">function</span> <span class="title">pickCard</span>(<span class="params">x: number</span>): </span>&#123;suit: string; card: number; &#125;;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pickCard</span>(<span class="params">x</span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> x == <span class="string">"object"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> pickedCard = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * x.length);</span><br><span class="line">    <span class="keyword">return</span> pickedCard;</span><br><span class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> x == <span class="string">"number"</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> pickedSuit = <span class="built_in">Math</span>.floor(x / <span class="number">13</span>);</span><br><span class="line">    <span class="keyword">return</span> &#123; <span class="attr">suit</span>: suits[pickedSuit], <span class="attr">card</span>: x % <span class="number">13</span> &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> myDeck = [&#123; <span class="attr">suit</span>: <span class="string">"diamonds"</span>, <span class="attr">card</span>: <span class="number">2</span> &#125;, &#123; <span class="attr">suit</span>: <span class="string">"spades"</span>, <span class="attr">card</span>: <span class="number">10</span> &#125;, &#123; <span class="attr">suit</span>: <span class="string">"hearts"</span>, <span class="attr">card</span>: <span class="number">4</span> &#125;];</span><br><span class="line"><span class="keyword">let</span> pickedCard1 = myDeck[pickCard(myDeck)];</span><br><span class="line">alert(<span class="string">"card: "</span> + pickedCard1.card + <span class="string">" of "</span> + pickedCard1.suit);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> pickedCard2 = pickCard(<span class="number">15</span>);</span><br><span class="line">alert(<span class="string">"card: "</span> + pickedCard2.card + <span class="string">" of "</span> + pickedCard2.suit);</span><br></pre></td></tr></table></figure>
<h3 id="this关键字"><a href="#this关键字" class="headerlink" title="this关键字"></a>this关键字</h3><p>非方法式调用会将 this 视为 window(在严格模式下，this 为 undefined)。fn(…args) 等同 fn.call(window [ES5-strict: undefined], …args)。obj.method(…args) 等同 obj.method.call(obj, …args)。</p>
<p>方法若以闭包形式书写，其返回函数的 this 始终指向 undefined 或 window，而不是挂载的对象。箭头函数即用于将返回函数的 this 指向挂载对象。不同于函数在调用时才获知 this 的指向，箭头函数在定义时就声明了 this 的指向。</p>
<p>推想函数 this 指向，就是在编译过程通过判断调用方式是函数还是方法，将 this 赋值为 undefined 或相关对象。箭头函数改写 this 的实现过程也即是，在编译阶段通过包装函数调用 bind 方法将箭头函数的 this 改写为函数所在的 this 或方法的上层对象。箭头函数的 this 指向在包装函数内实现，因此不能改变 this 的指向。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">interface Card &#123;</span><br><span class="line">    suit: string;</span><br><span class="line">    card: number;</span><br><span class="line">&#125;</span><br><span class="line">interface Deck &#123;</span><br><span class="line">    suits: string[];</span><br><span class="line">    cards: number[];</span><br><span class="line">    createCardPicker(<span class="keyword">this</span>: Deck): <span class="function"><span class="params">()</span> =&gt;</span> Card;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">let</span> deck: Deck = &#123;</span><br><span class="line">    suits: [<span class="string">"hearts"</span>, <span class="string">"spades"</span>, <span class="string">"clubs"</span>, <span class="string">"diamonds"</span>],</span><br><span class="line">    cards: <span class="built_in">Array</span>(<span class="number">52</span>),</span><br><span class="line">    <span class="comment">// <span class="doctag">NOTE:</span> The function now explicitly specifies that its callee must be of type Deck</span></span><br><span class="line">    <span class="comment">// 使用 this 参数将 this 的类型从 any 变更成 Deck 类型</span></span><br><span class="line">    createCardPicker: <span class="function"><span class="keyword">function</span>(<span class="params">this: Deck</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">let</span> pickedCard = <span class="built_in">Math</span>.floor(<span class="built_in">Math</span>.random() * <span class="number">52</span>);</span><br><span class="line">            <span class="keyword">let</span> pickedSuit = <span class="built_in">Math</span>.floor(pickedCard / <span class="number">13</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="attr">suit</span>: <span class="keyword">this</span>.suits[pickedSuit], <span class="attr">card</span>: pickedCard % <span class="number">13</span>&#125;;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> cardPicker = deck.createCardPicker();</span><br><span class="line"><span class="keyword">let</span> pickedCard = cardPicker();</span><br><span class="line"></span><br><span class="line">alert(<span class="string">"card: "</span> + pickedCard.card + <span class="string">" of "</span> + pickedCard.suit);</span><br></pre></td></tr></table></figure>
<h2 id="泛型"><a href="#泛型" class="headerlink" title="泛型"></a>泛型</h2><p>声明时不确定类型，调用时设定类型，促使定义的函数或类适用于不同的类型，同时能避免使用 any 时跳过类型校验的情景。</p>
<p>泛型使用 ‘&lt;’, ‘&gt;’ 包裹。</p>
<p>泛型函数使用 function<t>(arg: T): T {  } 或 function<t>(arg: Array<t>): T {  } 等形式。</t></t></t></p>
<p>泛型类使用 class ClassName<t> { method: (arg: T) =&gt; T } 等形式。</t></p>
<p>泛型可使用继承接口的形式加以约束</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 泛型函数</span></span><br><span class="line">interface GenericIdentityFn&lt;T&gt; &#123;</span><br><span class="line">  (arg: T): T;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">identity</span>&lt;<span class="title">T</span>&gt;(<span class="params">arg: T</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> arg;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> myIdentity: GenericIdentityFn&lt;number&gt; = identity;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 泛型类</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">GenericNumber</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  zeroValue: T;</span><br><span class="line">  add: <span class="function">(<span class="params">x: T, y: T</span>) =&gt;</span> T;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> myGenericNumber = <span class="keyword">new</span> GenericNumber&lt;number&gt;();</span><br><span class="line">myGenericNumber.zeroValue = <span class="number">0</span>;</span><br><span class="line">myGenericNumber.add = <span class="function"><span class="keyword">function</span>(<span class="params">x, y</span>) </span>&#123; <span class="keyword">return</span> x + y; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用泛型创建工厂函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">create</span>&lt;<span class="title">T</span>&gt;(<span class="params">c: &#123;new(</span>): <span class="title">T</span>; &#125;): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> c();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="枚举"><a href="#枚举" class="headerlink" title="枚举"></a>枚举</h2><p>枚举类型在编译阶段通过函数赋值对象的方式构建，每个枚举成员包含枚举值和枚举名，生成枚举值到枚举名的双向映射。在编译阶段，枚举值通过直接求值获得；若未指定枚举值，首个枚举成员的枚举值初始化为 0，其余枚举成员的枚举值由前一个枚举成员的枚举值加 1 获得。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">enum Directions &#123;</span><br><span class="line">  Up,</span><br><span class="line">  Down,</span><br><span class="line">  Left,</span><br><span class="line">  Right</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Directions.Up;<span class="comment">// 0</span></span><br><span class="line">Directions[<span class="number">0</span>];<span class="comment">// "Up"</span></span><br></pre></td></tr></table></figure>
<h2 id="高级类型"><a href="#高级类型" class="headerlink" title="高级类型"></a>高级类型</h2><p>交叉类型使用 Type1 &amp; Type2 &amp; Type3 语法，被校验数据须包含所有声明类型的特性。</p>
<p>联合类型使用 Type1 | Type2 | Type3 语法，被校验数据可以是所有声明类型的其中之一。</p>
<p>标签联合仍使用 Type1 | Type2 | Type3 语法，且 Type1, Type2, Type3 中包含可辨识的标签属性，用于区分到底属于哪个类型。</p>
<p>索引类型使用 keyof T 校验对象属性, T[K] 校验值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 标签联合</span></span><br><span class="line">interface Square &#123;</span><br><span class="line">  kind: <span class="string">"square"</span>;</span><br><span class="line">  size: number;</span><br><span class="line">&#125;</span><br><span class="line">interface Rectangle &#123;</span><br><span class="line">  kind: <span class="string">"rectangle"</span>;</span><br><span class="line">  width: number;</span><br><span class="line">  height: number;</span><br><span class="line">&#125;</span><br><span class="line">interface Circle &#123;</span><br><span class="line">  kind: <span class="string">"circle"</span>;</span><br><span class="line">  radius: number;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">type Shape = Square | Rectangle | Circle;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">area</span>(<span class="params">s: Shape</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (s.kind) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"square"</span>: <span class="keyword">return</span> s.size * s.size;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"rectangle"</span>: <span class="keyword">return</span> s.height * s.width;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">"circle"</span>: <span class="keyword">return</span> <span class="built_in">Math</span>.PI * s.radius ** <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 索引类型</span></span><br><span class="line">function getProperty&lt;T, K extends keyof T&gt;(o: T, name: K): T[K] &#123;</span><br><span class="line">  <span class="keyword">return</span> o[name]; <span class="comment">// o[name] is of type T[K]</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>映射类型，通过 [P in keyof T] 遍历旧类型的值 T[P]，以构建新类型。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Readonly, Partial, Pick, Record 包含在 ts 标准库中</span></span><br><span class="line">type Readonly&lt;T&gt; = &#123;</span><br><span class="line">  readonly [P <span class="keyword">in</span> keyof T]: T[P];</span><br><span class="line">&#125;</span><br><span class="line">type Partial&lt;T&gt; = &#123;</span><br><span class="line">  [P <span class="keyword">in</span> keyof T]?: T[P];</span><br><span class="line">&#125;</span><br><span class="line">type Pick&lt;T, K extends keyof T&gt; = &#123;</span><br><span class="line">  [P <span class="keyword">in</span> K]: T[P];</span><br><span class="line">&#125;</span><br><span class="line">type Record&lt;K extends string, T&gt; = &#123;</span><br><span class="line">  [P <span class="keyword">in</span> K]: T;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="类型别名"><a href="#类型别名" class="headerlink" title="类型别名"></a>类型别名</h2><p>类型别名使用 type Alias = Type 语法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">type Name = string;</span><br><span class="line">type NameResolver = <span class="function"><span class="params">()</span> =&gt;</span> string;</span><br><span class="line">type NameOrResolver = Name | NameResolver;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getName</span>(<span class="params">n: NameOrResolver</span>): <span class="title">Name</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> n === <span class="string">'string'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> n;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> n();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 泛型类型别名</span></span><br><span class="line">type Container&lt;T&gt; = &#123; <span class="attr">value</span>: T &#125;;</span><br></pre></td></tr></table></figure>
<h2 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h2><p>模块有其自身的作用域，通过模块加载器导入其他模块。模块导入使用 import 关键字，导出使用 export 关键字，默认导出使用 default 关键字(数值、类和函数声明可以直接被标记为默认导出)。</p>
<p>模块导入导出也可以使用 export = xxx; import module = require(“module”); 语法。</p>
<p>根据编译时指定的模块目标参数，编译器会生成相应的供Node.js (CommonJS)，Require.js (AMD)，isomorphic (UMD), SystemJS或ECMAScript 2015 native modules (ES6)模块加载系统使用的代码。编译时，使用 –module commonjs，将转化为 CommonJS 模块；使用 –module amd，将转化为 AMD 模块；</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// 导出重命名</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ZipCodeValidator</span> <span class="title">implements</span> <span class="title">StringValidator</span> </span>&#123;</span><br><span class="line">  isAcceptable(s: string) &#123;</span><br><span class="line">    <span class="keyword">return</span> s.length === <span class="number">5</span> &amp;&amp; numberRegexp.test(s);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">export</span> &#123; ZipCodeValidator &#125;;</span><br><span class="line"><span class="keyword">export</span> &#123; ZipCodeValidator <span class="keyword">as</span> mainValidator &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 重新导出</span></span><br><span class="line"><span class="keyword">export</span> &#123;ZipCodeValidator <span class="keyword">as</span> RegExpBasedZipCodeValidator&#125; <span class="keyword">from</span> <span class="string">"./ZipCodeValidator"</span>;</span><br><span class="line"><span class="keyword">export</span> * <span class="keyword">from</span> <span class="string">"./ZipCodeValidator"</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导入重命名</span></span><br><span class="line"><span class="keyword">import</span> &#123; ZipCodeValidator <span class="keyword">as</span> ZCV &#125; <span class="keyword">from</span> <span class="string">"./ZipCodeValidator"</span>;</span><br><span class="line"><span class="keyword">import</span> * <span class="keyword">as</span> validator <span class="keyword">from</span> <span class="string">"./ZipCodeValidator"</span>;</span><br></pre></td></tr></table></figure>
<h3 id="模块解析策略"><a href="#模块解析策略" class="headerlink" title="模块解析策略"></a>模块解析策略</h3><p>ts 共有两种模块解析策略，Node 和 Classic，默认值为使用了 –module AMD | System | ES2015 模块系统的 Classic 策略。当使用 Classic 策略时，查找非相对模块通过从包含导入文件的目录开始依次向上级目录遍历，以定位匹配的声明文件。当使用 Node 策略时，查找相对模块先定位到同名文件，再定位到同名目录(根据目录下 package.json 文件中的 types 属性定位文件，或者定位到目录下 index.ts 文件)；查找相对模块通过先上遍历目录，定位到每层 node_modules 目录下与 模块同名的目录，再通过 package.json 或 index.ts 定位模块文件。</p>
<p>tsconfig.json 文件中的 compilerOptions.baseUrl, compilerOptions.paths 属性用于设定查找文件的基础路径以及特定模块的查找路径。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">"compilerOptions"</span>: &#123;</span><br><span class="line">    "baseUrl": ".", // 相对于当前路径进行计算，compilerOptions.paths 存在时须指定 baseUrl</span><br><span class="line">    "paths": &#123;</span><br><span class="line">      "jquery": ["node_modules/jquery/dist/jquery"], // 此处映射是相对于"baseUrl"</span><br><span class="line">      "*": [// 其他模块分别在 projectRoot 或 projectRoot/generated 目录下查找</span><br><span class="line">        "*",</span><br><span class="line">        <span class="string">"generated/*"</span></span><br><span class="line">      ],</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="命名空间"><a href="#命名空间" class="headerlink" title="命名空间"></a>命名空间</h2><p>命名空间使用 namespace Name {} 声明，使用 export 关键字将命名空间内部声明的数据导出，没有使用 export 修饰的数据只能在命名空间内使用。编译阶段，在全局空间下构建一个普通对象，export 导出的数据构成该对象的属性或方法，因此，从命名空间中导出的数据通过 Name.exportName 加以引用。</p>
<p>可以将同一个命名空间内声明的多个类放置在不同的文件中，仍旧使用同一个命名空间，再使用引用标签可以告知编译器这些文件之间的关联。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">namespace Validation &#123;</span><br><span class="line">  <span class="keyword">export</span> interface StringValidator &#123;</span><br><span class="line">    isAcceptable(s: string): boolean;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> lettersRegexp = <span class="regexp">/^[A-Za-z]+$/</span>;</span><br><span class="line">  <span class="keyword">const</span> numberRegexp = <span class="regexp">/^[0-9]+$/</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">LettersOnlyValidator</span> <span class="title">implements</span> <span class="title">StringValidator</span> </span>&#123;</span><br><span class="line">    isAcceptable(s: string) &#123;</span><br><span class="line">        <span class="keyword">return</span> lettersRegexp.test(s);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ZipCodeValidator</span> <span class="title">implements</span> <span class="title">StringValidator</span> </span>&#123;</span><br><span class="line">    isAcceptable(s: string) &#123;</span><br><span class="line">      <span class="keyword">return</span> s.length === <span class="number">5</span> &amp;&amp; numberRegexp.test(s);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> strings = [<span class="string">"Hello"</span>, <span class="string">"98052"</span>, <span class="string">"101"</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> validators: &#123; [s: string]: Validation.StringValidator; &#125; = &#123;&#125;;</span><br><span class="line">validators[<span class="string">"ZIP code"</span>] = <span class="keyword">new</span> Validation.ZipCodeValidator();</span><br><span class="line">validators[<span class="string">"Letters only"</span>] = <span class="keyword">new</span> Validation.LettersOnlyValidator();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> s <span class="keyword">of</span> strings) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> name <span class="keyword">in</span> validators) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">`"<span class="subst">$&#123; s &#125;</span>" - <span class="subst">$&#123; validators[name].isAcceptable(s) ? <span class="string">"matches"</span> : <span class="string">"does not match"</span> &#125;</span> <span class="subst">$&#123; name &#125;</span>`</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用多个文件分解命名空间</span></span><br><span class="line"><span class="comment">// Validation.ts</span></span><br><span class="line">namespace Validation &#123;</span><br><span class="line">  <span class="keyword">export</span> interface StringValidator &#123;</span><br><span class="line">    isAcceptable(s: string): boolean;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// LettersOnlyValidator.ts</span></span><br><span class="line"><span class="comment">/// &lt;reference path="Validation.ts" /&gt;</span></span><br><span class="line">namespace Validation &#123;</span><br><span class="line">  <span class="keyword">const</span> lettersRegexp = <span class="regexp">/^[A-Za-z]+$/</span>;</span><br><span class="line">  <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">LettersOnlyValidator</span> <span class="title">implements</span> <span class="title">StringValidator</span> </span>&#123;</span><br><span class="line">    isAcceptable(s: string) &#123;</span><br><span class="line">      <span class="keyword">return</span> lettersRegexp.test(s);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ZipCodeValidator.ts</span></span><br><span class="line"><span class="comment">/// &lt;reference path="Validation.ts" /&gt;</span></span><br><span class="line">namespace Validation &#123;</span><br><span class="line">  <span class="keyword">const</span> numberRegexp = <span class="regexp">/^[0-9]+$/</span>;</span><br><span class="line">  <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">ZipCodeValidator</span> <span class="title">implements</span> <span class="title">StringValidator</span> </span>&#123;</span><br><span class="line">    isAcceptable(s: string) &#123;</span><br><span class="line">      <span class="keyword">return</span> s.length === <span class="number">5</span> &amp;&amp; numberRegexp.test(s);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Test.ts</span></span><br><span class="line"><span class="comment">/// &lt;reference path="Validation.ts" /&gt;</span></span><br><span class="line"><span class="comment">/// &lt;reference path="LettersOnlyValidator.ts" /&gt;</span></span><br><span class="line"><span class="comment">/// &lt;reference path="ZipCodeValidator.ts" /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> strings = [<span class="string">"Hello"</span>, <span class="string">"98052"</span>, <span class="string">"101"</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> validators: &#123; [s: string]: Validation.StringValidator; &#125; = &#123;&#125;;</span><br><span class="line">validators[<span class="string">"ZIP code"</span>] = <span class="keyword">new</span> Validation.ZipCodeValidator();</span><br><span class="line">validators[<span class="string">"Letters only"</span>] = <span class="keyword">new</span> Validation.LettersOnlyValidator();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">let</span> s <span class="keyword">of</span> strings) &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> name <span class="keyword">in</span> validators) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">""</span><span class="string">" + s + "</span><span class="string">" "</span> + (validators[name].isAcceptable(s) ? <span class="string">" matches "</span> : <span class="string">" does not match "</span>) + name);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用 import q = x.y.z 语法以别名形式导出常用命名空间内的类，import 相较于 var，会构建新的引用</span></span><br><span class="line">namespace Shapes &#123;</span><br><span class="line">  <span class="keyword">export</span> namespace Polygons &#123;</span><br><span class="line">    <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Triangle</span> </span>&#123; &#125;</span><br><span class="line">    <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Square</span> </span>&#123; &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> polygons = Shapes.Polygons;</span><br><span class="line"><span class="keyword">let</span> sq = <span class="keyword">new</span> polygons.Square(); <span class="comment">// Same as "new Shapes.Polygons.Square()"</span></span><br></pre></td></tr></table></figure>
<h2 id="声明合并"><a href="#声明合并" class="headerlink" title="声明合并"></a>声明合并</h2><p>ts 的声明会创建以下三种实体，命名空间，类型或值。创建命名空间的声明会新建一个命名空间，用 “.” 访问其下设定的值(包含类，函数等)。创建类型的声明会用声明的模型创建一个类型并绑定到给定的名字上，包含类，枚举，接口，类型别名。创建值的声明会创建在 js 输出中看到的值，包含函数，变量。给定名字相同时，ts 会将声明合并。</p>
<h3 id="合并接口"><a href="#合并接口" class="headerlink" title="合并接口"></a>合并接口</h3><p>ts 合并接口时，后声明接口中的函数成员具有较高优先级(当该函数的参数类型更为精细时，则该函数成员具有更高优先级)；同名非函数成员有不同类型时，会造成编译错误。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">interface Document &#123;</span><br><span class="line">  createElement(tagName: any): Element;</span><br><span class="line">&#125;</span><br><span class="line">interface Document &#123;</span><br><span class="line">  createElement(tagName: <span class="string">"div"</span>): HTMLDivElement;</span><br><span class="line">  createElement(tagName: <span class="string">"span"</span>): HTMLSpanElement;</span><br><span class="line">&#125;</span><br><span class="line">interface Document &#123;</span><br><span class="line">  createElement(tagName: string): HTMLElement;</span><br><span class="line">  createElement(tagName: <span class="string">"canvas"</span>): HTMLCanvasElement;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 合并后</span></span><br><span class="line">interface Document &#123;</span><br><span class="line">  createElement(tagName: <span class="string">"canvas"</span>): HTMLCanvasElement;</span><br><span class="line">  createElement(tagName: <span class="string">"div"</span>): HTMLDivElement;</span><br><span class="line">  createElement(tagName: <span class="string">"span"</span>): HTMLSpanElement;</span><br><span class="line">  createElement(tagName: string): HTMLElement;</span><br><span class="line">  createElement(tagName: any): Element;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="合并命名空间"><a href="#合并命名空间" class="headerlink" title="合并命名空间"></a>合并命名空间</h3><p>ts 合并命名空间时，当某个命名空间有非导出成员，编译时将会报错。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">namespace Animals &#123;</span><br><span class="line">  <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Zebra</span> </span>&#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">namespace Animals &#123;</span><br><span class="line">  <span class="keyword">export</span> interface Legged &#123; <span class="attr">numberOfLegs</span>: number; &#125;</span><br><span class="line">  <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 合并后</span></span><br><span class="line">namespace Animals &#123;</span><br><span class="line">  <span class="keyword">export</span> interface Legged &#123; <span class="attr">numberOfLegs</span>: number; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Zebra</span> </span>&#123; &#125;</span><br><span class="line">  <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">Dog</span> </span>&#123; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="合并命名空间和类"><a href="#合并命名空间和类" class="headerlink" title="合并命名空间和类"></a>合并命名空间和类</h3><p>为类添加静态属性，可用于创建内部类。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Album</span> </span>&#123;</span><br><span class="line">  label: Album.AlbumLabel;</span><br><span class="line">&#125;</span><br><span class="line">namespace Album &#123;</span><br><span class="line">  <span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">AlbumLabel</span> </span>&#123; &#125;<span class="comment">// 必须导出</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="合并命名空间和函数"><a href="#合并命名空间和函数" class="headerlink" title="合并命名空间和函数"></a>合并命名空间和函数</h3><p>为函数添加属性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">buildLabel</span>(<span class="params">name: string</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> buildLabel.prefix + name + buildLabel.suffix;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">namespace buildLabel &#123;</span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">let</span> suffix = <span class="string">""</span>;</span><br><span class="line">  <span class="keyword">export</span> <span class="keyword">let</span> prefix = <span class="string">"Hello, "</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="合并命名空间和枚举"><a href="#合并命名空间和枚举" class="headerlink" title="合并命名空间和枚举"></a>合并命名空间和枚举</h3><p>为枚举添加属性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">enum Color &#123;</span><br><span class="line">  red = <span class="number">1</span>,</span><br><span class="line">  green = <span class="number">2</span>,</span><br><span class="line">  blue = <span class="number">4</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用 Color.mixColor 添加枚举成员</span></span><br><span class="line">namespace Color &#123;</span><br><span class="line">  <span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">mixColor</span>(<span class="params">colorName: string</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (colorName == <span class="string">"yellow"</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Color.red + Color.green;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (colorName == <span class="string">"white"</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Color.red + Color.green + Color.blue;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (colorName == <span class="string">"magenta"</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Color.red + Color.blue;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (colorName == <span class="string">"cyan"</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> Color.green + Color.blue;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="装饰器"><a href="#装饰器" class="headerlink" title="装饰器"></a>装饰器</h2><p>装饰器使用 @expression 语法，可以修饰类，属性，方法，访问符或参数，可以添加多个装饰器，由内至外依次求值。装饰器为普通函数，可以通过创建装饰器工厂的方式向装饰器注入特定的依赖。</p>
<p>类装饰器只接受类的构造函数作为参数，如 function classDecorator (constructor){}。</p>
<p>属性装饰器接受类的构造函数(当方法属于静态成员)或类的原型对象(当方法属于实例成员)，成员的名字作为参数，如 function propDecorator (target, propertyKey)。</p>
<p>方法装饰器接受类的构造函数(当方法属于静态成员)或类的原型对象(当方法属于实例成员)，成员的名字，成员的属性描述符作为参数，如 function methodDecorator (target, propertyKey, descriptor)。</p>
<p>访问器装饰器接受类的构造函数(当方法属于静态成员)或类的原型对象(当方法属于实例成员)，成员的名字，成员的属性描述符作为参数，但不能同时装饰 get, set 访问器，如 function vistitorDecorator (target, propertyKey, descriptor)。</p>
<p>参数装饰器接受接受类的构造函数(当方法属于静态成员)或类的原型对象(当方法属于实例成员)，成员的名字，参数在函数参数列表中的索引，如 function parameterDecorator (target, propertyKey, parameterIndex)。</p>
<p>ts 中使用装饰器需要将 tsconfig.json 配置文件中的 compilerOptions.experimentalDecorators 属性置为真，且 compilerOptions.target 属性至少为 “ES5”。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 类装饰器</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">classDecorator</span>&lt;<span class="title">T</span> <span class="title">extends</span> </span>&#123;<span class="keyword">new</span>(...args:any[]):&#123;&#125;&#125;&gt;(<span class="keyword">constructor</span>:T) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="class"><span class="keyword">class</span> <span class="keyword">extends</span> <span class="title">constructor</span> </span>&#123;</span><br><span class="line">    newProperty = <span class="string">"new property"</span>;</span><br><span class="line">    hello = <span class="string">"override"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@classDecorator</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Greeter</span> </span>&#123;</span><br><span class="line">  property = <span class="string">"property"</span>;</span><br><span class="line">  hello: string;</span><br><span class="line">  <span class="keyword">constructor</span>(m: string) &#123;</span><br><span class="line">    <span class="keyword">this</span>.hello = m;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方法装饰器和参数装饰器</span></span><br><span class="line"><span class="keyword">import</span> <span class="string">"reflect-metadata"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> requiredMetadataKey = <span class="built_in">Symbol</span>(<span class="string">"required"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">required</span>(<span class="params">target: Object, propertyKey: string | symbol, parameterIndex: number</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> existingRequiredParameters: number[] = <span class="built_in">Reflect</span>.getOwnMetadata(requiredMetadataKey, target, propertyKey) || [];</span><br><span class="line">  existingRequiredParameters.push(parameterIndex);</span><br><span class="line">  <span class="built_in">Reflect</span>.defineMetadata(requiredMetadataKey, existingRequiredParameters, target, propertyKey);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">validate</span>(<span class="params">target: any, propertyName: string, descriptor: TypedPropertyDescriptor&lt;Function&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> method = descriptor.value;</span><br><span class="line">  descriptor.value = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> requiredParameters: number[] = <span class="built_in">Reflect</span>.getOwnMetadata(requiredMetadataKey, target, propertyName);</span><br><span class="line">    <span class="keyword">if</span> (requiredParameters) &#123;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> parameterIndex <span class="keyword">of</span> requiredParameters) &#123;</span><br><span class="line">        <span class="keyword">if</span> (parameterIndex &gt;= <span class="built_in">arguments</span>.length || <span class="built_in">arguments</span>[parameterIndex] === <span class="literal">undefined</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"Missing required argument."</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> method.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Greeter</span> </span>&#123;</span><br><span class="line">  greeting: string;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(message: string) &#123;</span><br><span class="line">    <span class="keyword">this</span>.greeting = message;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @validate</span><br><span class="line">  greet(@required name: string) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"Hello "</span> + name + <span class="string">", "</span> + <span class="keyword">this</span>.greeting;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="迭代器"><a href="#迭代器" class="headerlink" title="迭代器"></a>迭代器</h2><p>当一个对象实现了 Symbol.iterator 属性时，该对象就是可迭代的。内置类型如 Array, Map, Set, String, Int32Array, Uint32Array等都实现了各自的 Symbol.iterator 属性。for…of 语句基于调用对象上的 Symbol.iterator 方法，用于遍历值。for…of 遍历索引，可以操作任何对象。</p>
<h2 id="JSX"><a href="#JSX" class="headerlink" title="JSX"></a>JSX</h2><p>ts 支持三种 jsx 模式，preserve, react, react-native，这些模式只在代码生成阶段产生影响。preserve 模式下生成代码中会保留 .jsx，由后续的工具(如 Babel)转换输出，生成文件带有 jsx 扩展名；react 模式会生成 React.createElement 等代码，无需再作转换，生成文件扩展名为 .js；react-native 模式相当于 preserve，保留 jsx 代码，生成文件的扩展名为 .js。</p>
<p>ts 中，编写 jsx 代码，须使用 .tsx 文件扩展名。.tsx 文件禁用 <type>id 形式的类型断言，类型断言可以使用 id as Type。</type></p>
<h3 id="固有元素"><a href="#固有元素" class="headerlink" title="固有元素"></a>固有元素</h3><p>固有元素使用特殊的接口 JSX.IntrinsicElements 来查找。默认情况下，这个接口没有指定，不对固有元素进行类型检查。 若这个接口存在，那么固有元素的名字需在 JSX.IntrinsicElements 接口的属性里查找。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">declare namespace JSX &#123;</span><br><span class="line">  interface IntrinsicElements &#123;</span><br><span class="line">    foo: any;<span class="comment">// 校验属性通过 foo: &#123; bar?: boolean &#125;，相应元素可写成 &lt;foo bar /&gt;;</span></span><br><span class="line">    <span class="comment">// [elemName: string]: any; 字符串索引</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;foo /&gt;;<span class="comment">// 正确</span></span><br><span class="line">&lt;bar /&gt;;<span class="comment">// 错误</span></span><br></pre></td></tr></table></figure>
<h3 id="无状态组件"><a href="#无状态组件" class="headerlink" title="无状态组件"></a>无状态组件</h3><p>无状态组件为普通函数，类型检查同函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">interface ClickableProps &#123;</span><br><span class="line">  children: JSX.Element[] | JSX.Element</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface HomeProps extends ClickableProps &#123;</span><br><span class="line">  home: JSX.Element;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">interface SideProps extends ClickableProps &#123;</span><br><span class="line">  side: JSX.Element | string;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MainButton</span>(<span class="params">prop: HomeProps</span>): <span class="title">JSX</span>.<span class="title">Element</span>;</span></span><br><span class="line"><span class="function"><span class="title">function</span> <span class="title">MainButton</span>(<span class="params">prop: SideProps</span>): <span class="title">JSX</span>.<span class="title">Element</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="类组件"><a href="#类组件" class="headerlink" title="类组件"></a>类组件</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">declare namespace JSX &#123;</span><br><span class="line">  interface ElementAttributesProperty &#123;</span><br><span class="line">    props; <span class="comment">// 指定用来使用的属性名</span></span><br><span class="line">  &#125;</span><br><span class="line">  interface ElementChildrenAttribute &#123;</span><br><span class="line">    children: &#123;&#125;;  <span class="comment">// 指定 children</span></span><br><span class="line">  &#125;</span><br><span class="line">  interface ElementClass &#123;<span class="comment">// 用于校验元素类型</span></span><br><span class="line">    render: any;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyComponent</span> </span>&#123;</span><br><span class="line">  props: &#123;</span><br><span class="line">    foo?: string;</span><br><span class="line">  &#125;</span><br><span class="line">  render() &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyFactoryFunction</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123; <span class="attr">render</span>: <span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;MyComponent foo=<span class="string">"bar"</span> /&gt;; <span class="comment">// 正确</span></span><br><span class="line">&lt;MyFactoryFunction /&gt;; <span class="comment">// 正确</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">NotAValidComponent</span> </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">NotAValidFactoryFunction</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;NotAValidComponent /&gt;; <span class="comment">// 错误</span></span><br><span class="line">&lt;NotAValidFactoryFunction /&gt;; <span class="comment">// 错误</span></span><br></pre></td></tr></table></figure>
<h2 id="疑问"><a href="#疑问" class="headerlink" title="疑问"></a>疑问</h2><ol>
<li>类型推论???</li>
<li>类型兼容性???</li>
<li>高级类型中的类型保护???</li>
<li>模块按需加载，在 ts 中加载其他模块系统的模块??? 外部模块??? 模块 + 声明合并</li>
<li>tsconfig.json 配置文件???</li>
<li>装饰器中的元数据，reflect-metadata库???</li>
<li>三斜线指令???</li>
<li>编写声明文件 .d.ts???</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/24/Js/flow使用指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/24/Js/flow使用指南/" itemprop="url">flow使用指南</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-24T00:00:00+08:00">2018-02-24</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端工程化/" itemprop="url" rel="index"><span itemprop="name">前端工程化</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/24/Js/flow使用指南/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/02/24/Js/flow使用指南/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>flow 是 facebook 推出的 js 代码类型检查工具。</p>
<p>flow 可借助 babel 编译，添加 babel-preset-flow 即可；babel-preset-react 包含 babel-preset-flow。或者借助安装 flow-bin 启动类型检查，flow-remove-types 移除类型标记。</p>
<p>通过在脚本前添加 // @flow 或 /<em> @flow </em>/ 将文件标注为需要类型校验的，否则将会跳过 flow 校验（除非执行 flow check –all 命令校验所有文件）。</p>
<h2 id="类型标注-Type-Annotations"><a href="#类型标注-Type-Annotations" class="headerlink" title="类型标注/Type Annotations"></a>类型标注/Type Annotations</h2><h3 id="基础类型-Primitive-Types"><a href="#基础类型-Primitive-Types" class="headerlink" title="基础类型/Primitive Types"></a>基础类型/Primitive Types</h3><p>flow 支持校验的基础数据类型包含 boolean, string, number, null, undefined（在 flow 中，使用 void 标注）。es6 的 symbol 类型尚不支持。</p>
<p>boolean, string, number 字面量使用小写形式标注类型；包装对象如 new Number(10) 使用大写形式标注类型。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">method</span>(<span class="params">x: number, y: string, z: boolean</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">method(<span class="number">3.14</span>, <span class="string">"hello"</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">method</span>(<span class="params">x: Number, y: String, z: Boolean</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">method(<span class="keyword">new</span> <span class="built_in">Number</span>(<span class="number">42</span>), <span class="keyword">new</span> <span class="built_in">String</span>(<span class="string">"world"</span>), <span class="keyword">new</span> <span class="built_in">Boolean</span>(<span class="literal">false</span>));</span><br></pre></td></tr></table></figure>
<h3 id="字面量类型-Literal-Types"><a href="#字面量类型-Literal-Types" class="headerlink" title="字面量类型/Literal Types"></a>字面量类型/Literal Types</h3><p>flow 允许使用字面量作为类型标注，约定仅接受该字面量，如 value: 2 将仅接受数值 2，其他报错。</p>
<h3 id="混合类型-Mixed-Types、任意类型-Any-types"><a href="#混合类型-Mixed-Types、任意类型-Any-types" class="headerlink" title="混合类型/Mixed Types、任意类型/Any types"></a>混合类型/Mixed Types、任意类型/Any types</h3><p>使用 mixed 标注可接受任意类型数据，但在使用时需显示校验类型。</p>
<p>使用 any 标注可接受任意类型数据，且在使用时也跳过校验。若作为对象，其下的所有属性均采用 any 类型形式。需要避免使用 any 类型。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stringify</span>(<span class="params">value: mixed</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// $ExpectError</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">""</span> + value; <span class="comment">// Error!</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stringify(<span class="string">"foo"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stringify</span>(<span class="params">value: mixed</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'string'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span> + value; <span class="comment">// Works!</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stringify(<span class="string">"foo"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="数组-Array-Types"><a href="#数组-Array-Types" class="headerlink" title="数组/Array Types"></a>数组/Array Types</h3><p>数组通过 Array<type> 或 Type[] 标注，元素的类型必须一致，但可以是 undefined 或 null，如 Array<number> 或 number[]。</number></type></p>
<h3 id="元祖-Tuple-Types"><a href="#元祖-Tuple-Types" class="headerlink" title="元祖/Tuple Types"></a>元祖/Tuple Types</h3><p>元祖通过 [type, type, type] 形式标注，即元素的类型单独标注，且元素不能增删，因此不能使用 push, pop 等数组原型方法，但可以使用 join 等方法，不同长度的元祖不能相互赋值，元祖和数组之间也不能相互赋值，如 [number, boolean, void]，该元祖标识可接受赋值如 [1, true]。</p>
<h3 id="函数-Function-Types"><a href="#函数-Function-Types" class="headerlink" title="函数/Function Types"></a>函数/Function Types</h3><p>flow 可标注函数入参和返回值，如 function concat(a: string, b: string): string { return a + b; }。</p>
<p>可选参数通过 ‘?’ 后缀标注，如 function acceptsOptionalString(value?: string) { }，参数可以是 undefined。</p>
<p>默认参数可使用如下形式 function method(value: string = “default”) { /<em> … </em>/ }，参数可以是 undefined，但不能为 null。</p>
<p>解构参数通过数组类型标注，如 function method(…args: Array<number>) { }。</number></p>
<p>函数类型校验或者通过添加设定入参返回值标注，或者通过添加设定 Funtion 标注，如 function method(func: () =&gt; mixed) { } 或 function method(func: Function) { }。</p>
<h3 id="对象-Object-Types"><a href="#对象-Object-Types" class="headerlink" title="对象/Object Types"></a>对象/Object Types</h3><p>对象通过 { propname: Type } 形式标注，如 var obj2: { foo: number, bar: boolean, baz: string, } = { foo: 1, bar: true, baz: ‘three’, }。</p>
<p>可选属性通过 ‘?’ 后缀标注，如 { propertyName?: string }，propertyName 属性可以是 undefined。</p>
<h3 id="类-Class-Types"><a href="#类-Class-Types" class="headerlink" title="类/Class Types"></a>类/Class Types</h3><p>类本身可作为类型标识。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> myInstance: MyClass = <span class="keyword">new</span> MyClass();</span><br></pre></td></tr></table></figure>
<p>在类中，方法标识同函数，属性在使用前必须先标识。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line">  prop: number;</span><br><span class="line">  method(): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.prop = <span class="number">42</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>类支持泛型标识。将泛型标识的类作为标识时，必须为所有泛型传递参数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>&lt;<span class="title">A</span>, <span class="title">B</span>, <span class="title">C</span>&gt; </span>&#123;</span><br><span class="line">  property: A;</span><br><span class="line">  method(val: B): C &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>&lt;<span class="title">A</span>, <span class="title">B</span>, <span class="title">C</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(arg1: A, arg2: B, arg3: C) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> val: MyClass&lt;number, boolean, string&gt; = <span class="keyword">new</span> MyClass(<span class="number">1</span>, <span class="literal">true</span>, <span class="string">'three'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="接口-Interface-Types"><a href="#接口-Interface-Types" class="headerlink" title="接口/Interface Types"></a>接口/Interface Types</h3><h4 id="接口作为类型标识"><a href="#接口作为类型标识" class="headerlink" title="接口作为类型标识"></a>接口作为类型标识</h4><p>接口可作为类型校验标识（结构类型校验/Structural typing，非名义类型校验/Nominal typing ）。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line">interface Serializable &#123;</span><br><span class="line">  serialize(): string;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</span><br><span class="line">  serialize() &#123; <span class="keyword">return</span> <span class="string">'[Foo]'</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bar</span> </span>&#123;</span><br><span class="line">  serialize() &#123; <span class="keyword">return</span> <span class="string">'[Bar]'</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> foo: Serializable = <span class="keyword">new</span> Foo(); <span class="comment">// Works!</span></span><br><span class="line"><span class="keyword">const</span> bar: Serializable = <span class="keyword">new</span> Bar(); <span class="comment">// Works!</span></span><br></pre></td></tr></table></figure>
<p>接口类型通过 ‘+’, ‘-‘ 符号设置只读、只写属性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当接口作为类型标识</span></span><br><span class="line">interface MyInterface &#123;</span><br><span class="line">  +readOnly: number | string;</span><br><span class="line">  -writeOnly: number | string;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> value: MyInterface = &#123; </span><br><span class="line">  readOnly: <span class="number">3</span>,<span class="comment">// 可读，不可写</span></span><br><span class="line">  writeOnly: number | string<span class="comment">// 可写，不可读</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="接口作为类实现标准"><a href="#接口作为类实现标准" class="headerlink" title="接口作为类实现标准"></a>接口作为类实现标准</h4><p>接口用于类实现/implements，一个类可以实现多个接口。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">interface MyInterface &#123;</span><br><span class="line">  method(value: string): number;</span><br><span class="line">  property?: string;</span><br><span class="line">  [key: string]: number;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用泛型</span></span><br><span class="line">interface MyInterface&lt;A, B, C&gt; &#123;</span><br><span class="line">  foo: A;</span><br><span class="line">  bar: B;</span><br><span class="line">  baz: C;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="泛型-Generic-Types"><a href="#泛型-Generic-Types" class="headerlink" title="泛型/Generic Types"></a>泛型/Generic Types</h3><p>泛型用于在运行时注入特定的类型。以类型标识的变量使用接口中未声明的属性时，须先作校验属性是否存在。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 函数中使用泛型</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">method</span>&lt;<span class="title">T</span>&gt;(<span class="params">value: T</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类使用泛型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Class</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  prop: T;</span><br><span class="line">  <span class="keyword">constructor</span>(param: T) &#123; &#125;</span><br><span class="line">  method(): T &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类型别名使用泛型</span></span><br><span class="line">type TypeAlias&lt;T&gt; = &#123;</span><br><span class="line">  key: T</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接口使用泛型</span></span><br><span class="line">interface Interface&lt;T&gt; &#123;</span><br><span class="line">  prop: T</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logFoo</span>&lt;<span class="title">T</span>: </span>&#123; foo: string &#125;&gt;(obj: T): T &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(obj.foo); <span class="comment">// Works!</span></span><br><span class="line">  <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logFoo(&#123; <span class="attr">foo</span>: <span class="string">'foo'</span>, <span class="attr">bar</span>: <span class="string">'bar'</span> &#125;);  <span class="comment">// Works!</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// @flow</span></span><br><span class="line">type Item&lt;T: number = <span class="number">1</span>&gt; = &#123;</span><br><span class="line">  prop: T,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> foo: Item&lt;&gt; = &#123; <span class="attr">prop</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="keyword">let</span> bar: Item&lt;<span class="number">2</span>&gt; = &#123; <span class="attr">prop</span>: <span class="number">2</span> &#125;;</span><br></pre></td></tr></table></figure>
<h3 id="可能的类型-Maybe-types"><a href="#可能的类型-Maybe-types" class="headerlink" title="可能的类型/Maybe types"></a>可能的类型/Maybe types</h3><p>可能的类型通过 ‘?’ 前缀标注，如 ?string，其值可以是 null 或 undefined。</p>
<h3 id="联合类型-Union-Types"><a href="#联合类型-Union-Types" class="headerlink" title="联合类型/Union Types"></a>联合类型/Union Types</h3><p>联合类型使用 ype1 | Type2 | … | TypeN 标注，被标识数据应满足其中一个类型校验。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 联合类型在处理响应的情景中使用，'| ... |'用于避免 success, error 属性冲突</span></span><br><span class="line"><span class="comment">// @flow</span></span><br><span class="line">type Success = &#123;| success: <span class="literal">true</span>, <span class="attr">value</span>: boolean |&#125;;</span><br><span class="line">type Failed  = &#123;| error: <span class="literal">true</span>, <span class="attr">message</span>: string |&#125;;</span><br><span class="line"></span><br><span class="line">type Response = Success | Failed;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleResponse</span>(<span class="params">response: Response</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (response.success) &#123;</span><br><span class="line">    <span class="keyword">var</span> value: boolean = response.value; <span class="comment">// Works!</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> error: string = response.error; <span class="comment">// Works!</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="交叉类型-Intersection-Types"><a href="#交叉类型-Intersection-Types" class="headerlink" title="交叉类型/Intersection Types"></a>交叉类型/Intersection Types</h3><p>交叉类型使用 Type1 &amp; Type2 &amp; … &amp; TypeN 标识，被标识数据应满足所有类型校验，需要由开发者避免类型冲突。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line">type A = &#123; <span class="attr">a</span>: number &#125;;</span><br><span class="line">type B = &#123; <span class="attr">b</span>: boolean &#125;;</span><br><span class="line">type C = &#123; <span class="attr">c</span>: string &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">method</span>(<span class="params">value: A &amp; B &amp; C</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">method(&#123; <span class="attr">a</span>: <span class="number">1</span> &#125;); <span class="comment">// Error!</span></span><br><span class="line">method(&#123; <span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>: <span class="literal">true</span> &#125;); <span class="comment">// Error!</span></span><br><span class="line">method(&#123; <span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>: <span class="literal">true</span>, <span class="attr">c</span>: <span class="string">'three'</span> &#125;); <span class="comment">// Works!</span></span><br></pre></td></tr></table></figure>
<h3 id="类型别名-Type-Aliases"><a href="#类型别名-Type-Aliases" class="headerlink" title="类型别名/Type Aliases"></a>类型别名/Type Aliases</h3><p>为常用的类型设置别名，采用如右形式语法 type Alias = Type。设置别名后，方便复用该类型。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">type NumberAlias = number;</span><br><span class="line">type ObjectAlias = &#123;</span><br><span class="line">  property: string,</span><br><span class="line">  method(): number,</span><br><span class="line">&#125;;</span><br><span class="line">type UnionAlias = <span class="number">1</span> | <span class="number">2</span> | <span class="number">3</span>;</span><br><span class="line">type AliasAlias = ObjectAlias;</span><br><span class="line">type GenericsObjectAlias&lt;A, B, C&gt; = &#123;</span><br><span class="line">  property: A,</span><br><span class="line">  method(val: B): C,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> val: ObjectAlias = &#123; <span class="comment">/* ... */</span> &#125;;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">method</span>(<span class="params">val: ObjectAlias</span>) </span>&#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123; <span class="keyword">constructor</span>(val: ObjectAlias) &#123; <span class="comment">/* ... */</span> &#125; &#125;</span><br><span class="line"><span class="keyword">var</span> myObject: GenericsObjectAlias&lt;number, boolean, string&gt; = &#123;</span><br><span class="line">  property: <span class="number">1</span>,</span><br><span class="line">  method(val: boolean): string &#123; <span class="keyword">return</span> <span class="string">''</span>; &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="不透明的类型别名-Opaque-Type-Aliases"><a href="#不透明的类型别名-Opaque-Type-Aliases" class="headerlink" title="不透明的类型别名/Opaque Type Aliases"></a>不透明的类型别名/Opaque Type Aliases</h4><p>不透明的类型别名不允许在定义该类型别名的文件外使用其基础类型，如 opaque type Alias = Type; 或 opaque type Alias: SuperType = Type 用于约定父类型，Type 必须是 SuperType的子类型，且在声明文件外使用该父类型校验。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 示例 1</span></span><br><span class="line"><span class="comment">// exports.js</span></span><br><span class="line"><span class="keyword">export</span> opaque type NumberAlias = number;</span><br><span class="line"></span><br><span class="line"><span class="comment">// imports.js</span></span><br><span class="line"><span class="keyword">import</span> type &#123;NumberAlias&#125; <span class="keyword">from</span> <span class="string">'./exports'</span>;</span><br><span class="line"></span><br><span class="line">(<span class="number">0</span>: NumberAlias) <span class="comment">// Error: 0 is not a NumberAlias!</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">convert</span>(<span class="params">x: NumberAlias</span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> x; <span class="comment">// Error: x is not a number!</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例 2</span></span><br><span class="line"><span class="comment">// exports.js</span></span><br><span class="line"><span class="keyword">export</span> opaque type ID: string = string;</span><br><span class="line"></span><br><span class="line"><span class="comment">// imports.js</span></span><br><span class="line"><span class="keyword">import</span> type &#123;ID&#125; <span class="keyword">from</span> <span class="string">'./exports'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatID</span>(<span class="params">x: ID</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"ID: "</span> + x; <span class="comment">// Ok! IDs are strings.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">toID</span>(<span class="params">x: string</span>): <span class="title">ID</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x; <span class="comment">// Error: strings are not IDs.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例 3 - 泛型</span></span><br><span class="line"><span class="comment">// @flow</span></span><br><span class="line">opaque type MyObject&lt;A, B, C&gt;: &#123; <span class="attr">foo</span>: A, <span class="attr">bar</span>: B &#125; = &#123;</span><br><span class="line">  foo: A,</span><br><span class="line">  bar: B,</span><br><span class="line">  baz: C,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> val: MyObject&lt;number, boolean, string&gt; = &#123;</span><br><span class="line">  foo: <span class="number">1</span>,</span><br><span class="line">  bar: <span class="literal">true</span>,</span><br><span class="line">  baz: <span class="string">'three'</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例 4 - 使用声明</span></span><br><span class="line">declare opaque type Foo;</span><br><span class="line">declare opaque type PositiveNumber: number;</span><br></pre></td></tr></table></figure>
<h3 id="typeof"><a href="#typeof" class="headerlink" title="typeof"></a>typeof</h3><p>typeof 操作符返回 flow 的数据类型，可能是开发者设置的类型标识。对基本类型，typeof 操作符返回名义类型；对类，typeof 操作符返回结构类型。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="keyword">let</span> num1 = <span class="number">42</span>;</span><br><span class="line"><span class="keyword">let</span> num2: <span class="keyword">typeof</span> num1 = <span class="number">3.14</span>;     <span class="comment">// Works!</span></span><br><span class="line"><span class="keyword">let</span> num3: <span class="keyword">typeof</span> num1 = <span class="string">'world'</span>;  <span class="comment">// Error!</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> bool1 = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">let</span> bool2: <span class="keyword">typeof</span> bool1 = <span class="literal">false</span>;  <span class="comment">// Works!</span></span><br><span class="line"><span class="keyword">let</span> bool3: <span class="keyword">typeof</span> bool1 = <span class="number">42</span>;     <span class="comment">// Error!</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> str1 = <span class="string">'hello'</span>;</span><br><span class="line"><span class="keyword">let</span> str2: <span class="keyword">typeof</span> str1 = <span class="string">'world'</span>; <span class="comment">// Works!</span></span><br><span class="line"><span class="keyword">let</span> str3: <span class="keyword">typeof</span> str1 = <span class="literal">false</span>;   <span class="comment">// Error!</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line">  method(val: number) &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">YourClass</span> </span>&#123;</span><br><span class="line">  method(val: number) &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> test1: <span class="keyword">typeof</span> MyClass = YourClass; <span class="comment">// Error!</span></span><br><span class="line"><span class="keyword">let</span> test1: <span class="keyword">typeof</span> MyClass = MyClass;   <span class="comment">// Works!</span></span><br></pre></td></tr></table></figure>
<h3 id="类型断言-Type-Casting-Expressions"><a href="#类型断言-Type-Casting-Expressions" class="headerlink" title="类型断言/Type Casting Expressions"></a>类型断言/Type Casting Expressions</h3><p>类型断言可使用 (value: Type) 语法，flow 尝试将 value 转换为 Type 类型，且不作类型校验。</p>
<p>flow 中只允许相关类型转换，由低级到高级，即 42 能转换到 number，不能转换到 string，number 类型不能转换为 42。通过 any 关键字可以将 42 从数值型转换到字符串型。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="keyword">let</span> value = <span class="number">42</span>;</span><br><span class="line"></span><br><span class="line">(value: number); <span class="comment">// Works!</span></span><br><span class="line">(value: string); <span class="comment">// Error!</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> newValue = ((value: any): string);</span><br><span class="line"></span><br><span class="line">(newValue: number); <span class="comment">// Error!</span></span><br><span class="line">(newValue: string); <span class="comment">// Works!</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cloneObject</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> clone = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Object</span>.keys(obj).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    clone[key] = obj[key];</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ((clone: any): <span class="keyword">typeof</span> obj); <span class="comment">// &lt;&lt;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> clone = cloneObject(&#123;</span><br><span class="line">  foo: <span class="number">1</span>,</span><br><span class="line">  bar: <span class="literal">true</span>,</span><br><span class="line">  baz: <span class="string">'three'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">(clone.foo: <span class="number">1</span>);       <span class="comment">// Works!</span></span><br><span class="line">(clone.bar: <span class="literal">true</span>);    <span class="comment">// Works!</span></span><br><span class="line">(clone.baz: <span class="string">'three'</span>); <span class="comment">// Works!</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cloneObject</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  (obj: &#123; [key: string]: mixed &#125;); <span class="comment">// &lt;&lt;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> clone = &#123;&#125;;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> ((clone: any): <span class="keyword">typeof</span> obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> clone = cloneObject(&#123;</span><br><span class="line">  foo: <span class="number">1</span>,</span><br><span class="line">  bar: <span class="literal">true</span>,</span><br><span class="line">  baz: <span class="string">'three'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">(clone.foo: <span class="number">1</span>);       <span class="comment">// Works!</span></span><br><span class="line">(clone.bar: <span class="literal">true</span>);    <span class="comment">// Works!</span></span><br><span class="line">(clone.baz: <span class="string">'three'</span>); <span class="comment">// Works!</span></span><br></pre></td></tr></table></figure>
<h3 id="工具类型-Utility-Types"><a href="#工具类型-Utility-Types" class="headerlink" title="工具类型/Utility Types"></a>工具类型/Utility Types</h3><h4 id="Keys"><a href="#Keys" class="headerlink" title="$Keys"></a>$Keys<t></t></h4><p>$Keys<t> 以对象或类型的属性构建联合类型。</t></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="keyword">const</span> countries = &#123;</span><br><span class="line">  US: <span class="string">"United States"</span>,</span><br><span class="line">  IT: <span class="string">"Italy"</span>,</span><br><span class="line">  FR: <span class="string">"France"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">type Country = $Keys&lt;<span class="keyword">typeof</span> countries&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> italy: Country = <span class="string">'IT'</span>;</span><br><span class="line"><span class="keyword">const</span> nope: Country = <span class="string">'nope'</span>; <span class="comment">// 'nope' is not a Country</span></span><br></pre></td></tr></table></figure>
<h4 id="Values"><a href="#Values" class="headerlink" title="$Values"></a>$Values<t></t></h4><p>$Values<t> 以对象或类型的值构建联合类型。</t></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line">type Props = &#123;</span><br><span class="line">  name: string,</span><br><span class="line">  age: number,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The following two types are equivalent:</span></span><br><span class="line">type PropValues = string | number;</span><br><span class="line">type Prop$Values = $Values&lt;Props&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> name: Prop$Values = <span class="string">'Jon'</span>;  <span class="comment">// OK</span></span><br><span class="line"><span class="keyword">const</span> age: Prop$Values = <span class="number">42</span>;  <span class="comment">// OK</span></span><br><span class="line"><span class="keyword">const</span> fn: Prop$Values = <span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;;  <span class="comment">// Error!</span></span><br></pre></td></tr></table></figure>
<h4 id="ReadOnly"><a href="#ReadOnly" class="headerlink" title="$ReadOnly"></a>$ReadOnly<t></t></h4><p>$ReadOnly<t> 用于将对象或类型的属性转化为只读属性。</t></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The following two types are equivalent:</span></span><br><span class="line">type ReadOnlyObj = &#123;</span><br><span class="line">  +key: any,  <span class="comment">// read-only field, marked by the `+` annotation</span></span><br><span class="line">&#125;;</span><br><span class="line">type ReadOnlyObj = $ReadOnly&lt;&#123;</span><br><span class="line">  key: any,</span><br><span class="line">&#125;&gt;;</span><br></pre></td></tr></table></figure>
<h4 id="Exact"><a href="#Exact" class="headerlink" title="$Exact"></a>$Exact<t></t></h4><p>$Exact&lt;{name: string}&gt; 语法和 {| name: string |} 等价，用于避免对象属性冲突。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line">type ExactUser = $Exact&lt;&#123;<span class="attr">name</span>: string&#125;&gt;;</span><br><span class="line">type ExactUserShorthand = &#123;| name: string |&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> user2 = &#123;<span class="attr">name</span>: <span class="string">'John Wilkes Booth'</span>&#125;;</span><br><span class="line"><span class="comment">// These will both be satisfied because they are equivalent</span></span><br><span class="line">(user2: ExactUser);</span><br><span class="line">(user2: ExactUserShorthand);</span><br></pre></td></tr></table></figure>
<h4 id="Diff-lt-A-B-gt"><a href="#Diff-lt-A-B-gt" class="headerlink" title="$Diff&lt;A, B&gt;"></a>$Diff&lt;A, B&gt;</h4><p>$Diff&lt;A, B&gt; 语法中，待校验数据须包含 A 仅有的属性，能包含 B 有的属性，且 B 中不能有 A 没有的属性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line">type Props = &#123; <span class="attr">name</span>: string, <span class="attr">age</span>: number &#125;;</span><br><span class="line">type DefaultProps = &#123; <span class="attr">age</span>: number &#125;;</span><br><span class="line">type RequiredProps = $Diff&lt;Props, DefaultProps&gt;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setProps</span>(<span class="params">props: RequiredProps</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setProps(&#123; <span class="attr">name</span>: <span class="string">'foo'</span> &#125;);</span><br><span class="line">setProps(&#123; <span class="attr">name</span>: <span class="string">'foo'</span>, <span class="attr">age</span>: <span class="number">42</span>, <span class="attr">baz</span>: <span class="literal">false</span> &#125;); <span class="comment">// you can pass extra props too</span></span><br><span class="line">setProps(&#123; <span class="attr">age</span>: <span class="number">42</span> &#125;); <span class="comment">// error, name is required</span></span><br></pre></td></tr></table></figure>
<h4 id="Rest-lt-A-B-gt"><a href="#Rest-lt-A-B-gt" class="headerlink" title="$Rest&lt;A, B&gt;"></a>$Rest&lt;A, B&gt;</h4><p>$Rest&lt;A, B&gt; 语法中，待校验数据只能包含 A 仅有的属性，不能包含 B 有的属性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line">type Props = &#123; <span class="attr">name</span>: string, <span class="attr">age</span>: number &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> props: Props = &#123;<span class="attr">name</span>: <span class="string">'Jon'</span>, <span class="attr">age</span>: <span class="number">42</span>&#125;;</span><br><span class="line"><span class="keyword">const</span> &#123;age, ...otherProps&#125; = props;</span><br><span class="line">(otherProps: $Rest&lt;Props, &#123;|age: number|&#125;&gt;);</span><br><span class="line">otherProps.age;  <span class="comment">// Error</span></span><br></pre></td></tr></table></figure>
<h4 id="PropertyType-lt-T-k-gt"><a href="#PropertyType-lt-T-k-gt" class="headerlink" title="$PropertyType&lt;T, k&gt;"></a>$PropertyType&lt;T, k&gt;</h4><p>$PropertyType&lt;T, k&gt; 语法用于获取特定属性的类型。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tooltip</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  props: &#123;</span><br><span class="line">    text: string,</span><br><span class="line">    onMouseOver: <span class="function">(<span class="params">&#123;x: number, y: number&#125;</span>) =&gt;</span> <span class="keyword">void</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> someProps: $PropertyType&lt;Tooltip, <span class="string">'props'</span>&gt; = &#123;</span><br><span class="line">  text: <span class="string">'foo'</span>,</span><br><span class="line">  onMouseOver: <span class="function">(<span class="params">data: &#123;x: number, y: number&#125;</span>) =&gt;</span> <span class="literal">undefined</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> otherProps: $PropertyType&lt;Tooltip, <span class="string">'props'</span>&gt; = &#123;</span><br><span class="line">  text: <span class="string">'foo'</span></span><br><span class="line">  <span class="comment">// Missing the `onMouseOver` definition</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="ElementType-lt-T-k-gt"><a href="#ElementType-lt-T-k-gt" class="headerlink" title="$ElementType&lt;T, k&gt;"></a>$ElementType&lt;T, k&gt;</h4><p>$ElementType&lt;T, k&gt; 语法用于获取特定元素的类型，包含数组项、元祖项、对象属性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Using objects:</span></span><br><span class="line">type Obj = &#123;</span><br><span class="line">  name: string,</span><br><span class="line">  age: number,</span><br><span class="line">&#125;</span><br><span class="line">(<span class="string">'Jon'</span>: $ElementType&lt;Obj, <span class="string">'name'</span>&gt;);</span><br><span class="line">(<span class="number">42</span>: $ElementType&lt;Obj, <span class="string">'age'</span>&gt;);</span><br><span class="line">(<span class="literal">true</span>: $ElementType&lt;Obj, <span class="string">'name'</span>&gt;); <span class="comment">// Nope, `name` is not a boolean</span></span><br><span class="line">(<span class="literal">true</span>: $ElementType&lt;Obj, <span class="string">'other'</span>&gt;); <span class="comment">// Nope, property `other` is not in Obj</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Using tuples:</span></span><br><span class="line">type Tuple = [boolean, string];</span><br><span class="line">(<span class="literal">true</span>: $ElementType&lt;Tuple, <span class="number">0</span>&gt;);</span><br><span class="line">(<span class="string">'foo'</span>: $ElementType&lt;Tuple, <span class="number">1</span>&gt;);</span><br><span class="line">(<span class="string">'bar'</span>: $ElementType&lt;Tuple, <span class="number">2</span>&gt;); <span class="comment">// Nope, can't access position 2</span></span><br></pre></td></tr></table></figure>
<h4 id="ObjMap-lt-T-F-gt"><a href="#ObjMap-lt-T-F-gt" class="headerlink" title="$ObjMap&lt;T, F&gt;"></a>$ObjMap&lt;T, F&gt;</h4><p>$ObjMap&lt;T, F&gt; 遍历 T 对象或类型，以函数 F 重新构建属性类型。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// let's write a function type that takes a `() =&gt; V` and returns a `V` (its return type)</span></span><br><span class="line">type ExtractReturnType = &lt;V&gt;(() =&gt; V) =&gt; V</span><br><span class="line"></span><br><span class="line">function run&lt;A, O: &#123;[key: string]: () =&gt; A&#125;&gt;(o: O): $ObjMap&lt;O, ExtractReturnType&gt; &#123;</span><br><span class="line">  return Object.keys(o).reduce((acc, k) =&gt; Object.assign(acc, &#123; [k]: o[k]() &#125;), &#123;&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const o = &#123;</span><br><span class="line">  a: () =&gt; true,</span><br><span class="line">  b: () =&gt; 'foo'</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">(run(o).a: boolean); // Ok</span><br><span class="line">(run(o).b: string);  // Ok</span><br><span class="line">// $ExpectError</span><br><span class="line">(run(o).b: boolean); // Nope, b is a string</span><br><span class="line">// $ExpectError</span><br><span class="line">run(o).c;</span><br></pre></td></tr></table></figure>
<h4 id="TupleMap-lt-T-F-gt"><a href="#TupleMap-lt-T-F-gt" class="headerlink" title="$TupleMap&lt;T, F&gt;"></a>$TupleMap&lt;T, F&gt;</h4><p>$TupleMap&lt;T, F&gt; 遍历 T 元祖或类型，以函数 F 重新构建元祖项。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line">type ExtractReturnType = &lt;V&gt;(() =&gt; V) =&gt; V</span><br><span class="line"></span><br><span class="line">function run&lt;A, I: Array&lt;() =&gt; A&gt;&gt;(iter: I): $TupleMap&lt;I, ExtractReturnType&gt; &#123;</span><br><span class="line">  return iter.map(fn =&gt; fn());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const arr = [() =&gt; 'foo', () =&gt; 'bar'];</span><br><span class="line">(run(arr)[0]: string); // OK</span><br><span class="line">(run(arr)[1]: string); // OK</span><br><span class="line">(run(arr)[1]: boolean); // Error</span><br></pre></td></tr></table></figure>
<h4 id="Call"><a href="#Call" class="headerlink" title="$Call"></a>$Call<f></f></h4><p>$Call<f> 调用 F 函数，函数返回值用于校验类型，参数在 F 后添加。</f></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="comment">// Takes an object type, returns the type of its `prop` key</span></span><br><span class="line">type ExtractPropType = &lt;T&gt;(&#123;prop: T&#125;) =&gt; T;</span><br><span class="line">type Obj = &#123;prop: number&#125;;</span><br><span class="line">type PropType = $Call&lt;ExtractPropType, Obj&gt;;  // Call `ExtractPropType` with `Obj` as an argument</span><br><span class="line">type Nope = $Call&lt;ExtractPropType, &#123;nope: number&#125;&gt;;  // Error: argument doesn't match `Obj`.</span><br><span class="line"></span><br><span class="line">(5: PropType); // OK</span><br><span class="line">(true: PropType);  // Error: PropType is a number</span><br><span class="line">(5: Nope);  // Error</span><br></pre></td></tr></table></figure>
<h4 id="Class"><a href="#Class" class="headerlink" title="Class"></a>Class<t></t></h4><p>Class<t> 指用类 T 校验类型。</t></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Store</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExtendedStore</span> <span class="keyword">extends</span> <span class="title">Store</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Model</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeStore</span>(<span class="params">storeClass: Class&lt;Store&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> storeClass();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(makeStore(Store): Store);</span><br><span class="line">(makeStore(ExtendedStore): Store);</span><br><span class="line">(makeStore(Model): Model); <span class="comment">// error</span></span><br><span class="line">(makeStore(ExtendedStore): Model); <span class="comment">// Flow infers the return type</span></span><br></pre></td></tr></table></figure>
<h4 id><a href="#" class="headerlink" title="*"></a>*</h4><ul>
<li>用于以占位符形式指明存在类型/Existential Type。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeParamStore</span>&lt;<span class="title">T</span>&gt;(<span class="params">storeClass: Class&lt;ParamStore&lt;T&gt;&gt;, data: T</span>): * </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> storeClass(data);</span><br><span class="line">&#125;</span><br><span class="line">(makeParamStore(ParamStore, <span class="number">1</span>): ParamStore&lt;number&gt;);</span><br><span class="line">(makeParamStore(ParamStore, <span class="number">1</span>): ParamStore&lt;boolean&gt;); <span class="comment">// failed because of the second parameter</span></span><br></pre></td></tr></table></figure>
<h3 id="模块-Module-Types"><a href="#模块-Module-Types" class="headerlink" title="模块/Module Types"></a>模块/Module Types</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;&#125;;</span><br><span class="line"><span class="keyword">export</span> type MyObject = &#123; <span class="comment">/* ... */</span> &#125;;</span><br><span class="line"><span class="keyword">export</span> interface MyInterface &#123; <span class="comment">/* ... */</span> &#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123; <span class="comment">/* ... */</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="keyword">import</span> type Foo, &#123;MyObject, MyInterface&#125; <span class="keyword">from</span> <span class="string">'./exports'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">typeof</span> &#123;MyClass&#125; <span class="keyword">from</span> <span class="string">'./exports'</span>;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/21/读书笔记/Pro Git读书笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/21/读书笔记/Pro Git读书笔记/" itemprop="url">Pro Git 笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-21T00:00:00+08:00">2018-02-21</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/读书笔记/" itemprop="url" rel="index"><span itemprop="name">读书笔记</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/21/读书笔记/Pro Git读书笔记/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/02/21/读书笔记/Pro Git读书笔记/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>git 版本管理通过 SHA-1 哈希算法为工作区的文件生成快照实现，存放于本地暂存区或版本库中（.git 目录下保存所有快照信息）。hash 算法基于文件内容和目录结构，git 保存的信息都通过 hash 值(SHA-1 哈希算法校验和/SHA-1 checksum)进行索引。修改工作区/working tree 的文件后(modified)，通过 git add 命令提交到暂存区/staging range(staged)，再通过 git commit 命令提交到版本库/git directory(commited)；若文件未变更，将沿用原有的快照。因此本地多版本管理不需要远程交互。</p>
<p>当文件提交到暂存区时(stage)，git 会为每个文件计算校验和/checksum，在 git 仓库中保存 blob 对象以引用文件快照，校验和将保存到暂存区中。当提交到版本库时(commit)，git 会计算目录的校验和并构建树对象(blod 文件对象将以索引形式存储在树对象中)，随后创建提交对象，该提交对象包含作者名、电邮、message、指向上述树对象的指针、指向之前提交版本的指针。git 仓库可理解为存储系列提交对象的单链表结构(以哈希算法的校验和值作为索引)。在多分支开发的特殊情况下，提交对象会转变为树形结构(单链表可视为只有主干的树)，即多个提交对象的 parent 指针可以指向同一个提交对象父节点，提交历史产生分叉。在提交对象模型的基础上，git 分支就是指向某个提交对象的移动指针(通过校验和指向提交对象，文件形式存储)，其提交历史来自于提交对象模型，形成单链表结构。多分支管理、及单分支的回滚和提交动作均衍生于树结构的提交对象模型，分支仅承担着指向改变的任务；创建新分支即是创建一个指向当前提交对象的指针；提交时，创建新的提交对象，并改变当前分支的指向。在 git 中，HEAD 指针用于指向当前工作的分支，通过改变 HEAD 指针的指向即为切换分支操作。需要说明的是，当切换回较旧的分支时，不只改变了 HEAD 指针的指向，同时也使工作目录变更为该分支指向的提交对象，即资源快照。多分支开发时，新的提交对象将作为提交对象模型的叶子节点，这一过程也可以通过 HEAD 指针感知当前的提交对象属于哪个分支。因此在 git 中，分支不是多次提交记录的集合，而是在抽象所有提交记录为单一的模型后、衍伸而来的理念。遵照这样的设计，master 分支和其他分支拥有相同的特征，只是 master 分支会在 git 仓库初始化时被创建。</p>
<p>在 git 中，HEAD 指针指向版本库，INDEX 指针指向暂存区，版本库和暂存区都存储在 .git 文件夹中。因此，git add 命令将工作区内容复制到暂存区/INDEX。git commit 将暂存区内容复制到版本库/HEAD。git status 比较工作区、暂存区、版本库内容是否相同，若工作区和暂存区内容不相同，提示 not staged，需要通过 git add 暂存；若暂存区和版本库内容不同，提示 not committed，需要通过 git commit 提交。执行 git checkout, git clone 命令时，先将 HEAD 指针指向切换的分支，再将版本库内容复制到暂存区，再将暂存区内容复制到工作区。</p>
<p>git 提供了 git reset <checksum> 命令，执行该命令，不仅改变 HEAD 指针的指向，同时将工作分支指向 checksum 提交对象上。如果 HEAD 指向 master 分支，运行 git reset 9e5e64a 将会使 master 指向 9e5e64a，将撤销 9e5e64a 之后的提交，也可以用于重置 9e5e64a 之后的提交；git reset 命令默认将暂存区内容也替换为 9e5e64a 指向的提交对象，这和显式执行 git reset –mixed 命令相同。git reset –soft 命令只将版本库中内容替换为指定的提交对象。git reset –hard 命令可同时将版本库、暂存区和工作区内容替换为指定的提交对象。使用 git reset <filepath> 或 git reset <checksum> <filepath> 命令将目标从提交对象转向 filepath 路径指定的文件或目录，操作是从指定的提交对象中获取内容，复制到暂存区。</filepath></checksum></filepath></checksum></p>
<p>在 git checkout 命令执行过程中，会比较工作区和暂存区的差别，并尝试合并，这是 git reset 命令所没有的操作。当执行 git checkout <filepath> 命令时，该命令不仅会影响暂存区，同时会尝试合并工作区，这也是 git reset 命令所没有的操作。</filepath></p>
<p>合并/merge 分支时，会向上遍历文档对象模型，寻找共同的祖先节点作为合并基础。若待合并分支的提交/commit 动作在当前工作分支(work-in-progress branch)之后产生，当前分支将采用快进/fast-forward 方式修改，即将当前分支指向待合并分支的提交对象，指针右移。合并分叉分支时，即待合并的两个分支为同时开发，将获取这两个分支的提交对象，以及他们共同祖先节点的提交对象作为合并基础，作三方合并(three-way merge)，最终将构建出新的提交对象(该提交对象有两个父节点，使文档对象模型由树结构转变为合流结构)。若两个分叉分支同时对同一块区域做更改，git 不会自动合并，将产生一个合并冲突(merge conflict)，并阻止 git 的后续执行流程，如构建新的提交对象等，git 还会为冲突文件注入标准的冲突解决标记(standard conflict-resolution markers)。通过 git status 命令可查看冲突文件。冲突解决标记中，以 &lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD 起始部分为当前工作分支内容，以 &gt;&gt;&gt;&gt;&gt;&gt;&gt; branchname 结束部分为待合并分支内容，中间以 =======。解决冲突后，需要依序提交到暂存区和版本库中，将产生一条合并记录，可能包含冲突解决记录。合并分支可使用 git mergetool 命令，启用图形化合并工具，参看 Git Branching。</p>
<p>git merge 合并发生冲突时，暂存区/stages 下缓存着共同祖先版本/stage-0，当前工作版本/stage-1，待合并的版本/stage-2。通过 git show :1|2|3:<conflictfilename> &gt; fileName 可以以拷贝形式导出冲突的共同祖先文件等。其中，:1|2|3:<conflictfilename> 为各冲突文件 bolb 对象相关 SHA-1 值的简写形式，:1:<conflictfilename> 为祖先冲突文件，:2:<conflictfilename> 为工作分支文件，:3:<conflictfilename> 为待合并文件。导出三份拷贝文件后，手工修复冲突，可使用 git merge-file 命令合并冲突文件，使用 git diff 命令可比较冲突结果与待比较文件的差异，git clean 命令用于清理为合并拷贝出来的文件。</conflictfilename></conflictfilename></conflictfilename></conflictfilename></conflictfilename></p>
<p>另外，在合并发生冲突时，使用 git checkout –conflict=diff3 命令可以查看不止于当前工作分支的冲突文件和待合并的冲突文件，还包含共同祖先的冲突文件。默认只查看当前工作分支的冲突文件和待合并的冲突文件，即 git checkout –conflict=merge 命令。使用 git config –global merge.conflictstyle diff3 命令，将全局的合并方案改成 diff3。git checkout –ours 合并时使用当前工作分支文件内容；git checkout –theirs 合并时使用待合并分支文件内容。git 在合并过程中，会将合并成功的文件提交到暂存区，因此 git diff 命令可以查看冲突文件；解决冲突后，仍可使用 git diff 或 git log –cc -p -1 命令查看解决冲突后的文件。</p>
<p>若想撤销文件合并，可使用 git reset –hard HEAD~ 命令将合并取消，提交记录返回到合并前；或者使用 git revert -m 1 basebranch 命令撤销合并，将提交对象撤回到 basebranch 分支内容。需要注意的是，git revert -m 1 basebranch 命令将无法合并待合并分支起始的提交内容，针对这一问题，可使用 git revert <checksum> 撤销还原。<br>参看 Git Tools。</checksum></p>
<p>远程引用(remote references)是对远程仓库中分支、标签等的引用或指针。更恰当的说，引用内容即为远程分支中的提交对象模型，单链表形式。远程跟踪分支(remote-tracking branches)将远程分支的引用保存在本地，不受用户影响，git fetch|pull|push 操作时更新引用，使本地 shortname/branchname 指向远程服务器的同名分支。远程引用采用 shortname/branchname 形式命名分支。当 git clone 命令执行时，将在本地创建 origin/master 分支和 master 分支，两者均指向相同的提交对象模型。当用户在 master 分支开发并提交时，另一用户将自己的代码 push 到远程 master 分支上，本地 origin/master 的指向将不作改变；假使在这时候执行 git fetch 命令，将抓取远程仓库新添加的提交对象，本地 origin/master 也将右移、指向另一用户创建的提交对象上，提交对象模型转化为树形结构。</p>
<p>变基/rebase 是 git 中除了 merge 以外整合两个分支的另一种方式。当提交历史呈分叉状态，可以将其中一个分叉的提交记录基于合并基础、提取为更新补丁，再将其合并到另一个分叉中，这个过程就是变基。变基命令在提取为补丁的分支上执行行，因此需要切换到该分支如 patch 分支，然后执行 git rebase basebaranch 命令，提取补丁并以该补丁产生新的提交对象(patch 分支指向该提交对象)，此时分叉的提交历史将转变为单链表形式，而 basebaranch 分支的指向仍保持不变。切换到 basebaranch 分支，再执行 git merge patch 命令，可以将 basebaranch 分支的指针右移，指向 rebase 命令新创建的提交对象。经过上述步骤后，整个开叉分支的整合操作也就完成了，patch 分支的提交对象将被抹去，但 patch 分支仍然存在，需要手动删除。变基同合并比较，最大的优点即是使提交历史呈线性状态，而不是分叉、合流结构。在开源项目中贡献代码通常采用变基命令。使用 git rebase basebranch patch 命令执行变基操作时，可以不用将工作分支切换到 patch 上，即提取 patch 分支的修改补丁，基于修改补丁在 basebranch 分支上创建新的提交对象。执行 git rebase –onto basebranch patch1 patch2 命令，获取 patch2 分支不同于 patch1 分支的修改补丁，基于修改补丁再在 basebranch 分支上创建新的提交对象。</p>
<p>执行变基操作有一条原则，即不能在你的本地仓库执行变基操作。变基操作能改变本地仓库的提交历史，进而影响远程仓库的提交记录，但是对于协作者而言，在分支开叉时拉取编程变更，又在变基后拉取远程变更，他本地远程引用的提交记录中即会保留变基前的开叉，又会有变基后新增的提交对象。git 变基的实现原理是，在每次提交时，git 不只计算本次提交的校验和，还会计算本次修改内容的校验和 patch-id。通过 patch-id，git 能分辨出新增的本地修改。在本地分支上，使用 git rebase remote/branch 命令将本地修改变基到远程引用，同时本地的提交历史将转变为单链表结构，这能解决前述变基前后的操作同时提交到远程仓库的问题。</p>
<p>除了合并和变基以外，git 支持拣选/cherry-pick 操作，其意义以校验和获取某次提交补丁，再应用到当前工作分支上。因为操作时间的不同，通过拣选在当前分支创建的提交会重新计算校验和。具体命令如 git cherry-pick e43a6fd3e94888d76779ad79fb568ed180e5fcdf。其中，e43a6fd3e94888d76779ad79fb568ed180e5fcdf 为之前提交对象的校验和/checksum，作为提交对象的索引。</p>
<p>参考：<br><a href="https://git-scm.com/book/zh/v2/Git-分支-分支简介" target="_blank" rel="noopener">分支简介</a><br><a href="https://git-scm.com/book/zh/v2/Git-分支-分支的新建与合并" target="_blank" rel="noopener">分支的新建与合并</a><br><a href="https://git-scm.com/book/zh/v2/Git-分支-变基" target="_blank" rel="noopener">变基</a><br><a href="https://git-scm.com/book/zh/v2/Git-工具-重置揭密" target="_blank" rel="noopener">重置揭密</a></p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>git 配置分为三类，系统级，用户级，和项目级；优先级从右到左。git config 命令中，–system 选项指定系统级，–global 选项指定用户级，两者均没有为项目级。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">git config --list <span class="comment"># 查看配置</span></span><br><span class="line">git config user.name <span class="comment"># 查看用户配置</span></span><br><span class="line">git config --global user.name &lt;name&gt; <span class="comment"># 指定用户</span></span><br><span class="line">git config --global user.email &lt;email&gt; <span class="comment"># 指定邮箱</span></span><br><span class="line">git config --global core.editor emacs <span class="comment"># 指定编辑器，默认为系统自带编辑器，可选 vim, emacs, notepad++</span></span><br><span class="line">git config --global commit.template &lt;filepath&gt; <span class="comment"># 以 filepath 文件作为提交信息模板，打开编辑器时作为前缀</span></span><br><span class="line">git config --global core.pager <span class="string">''</span> <span class="comment"># 设置 git log|diff 命令的分页器，可选值 more, less。'' 空字符串为完整显示</span></span><br><span class="line">git config --global user.signingkey &lt;gpg-key-id&gt; <span class="comment"># 设置 GPG 签署密钥，影响 git tag -s &lt;tag-name&gt; 命令</span></span><br><span class="line">git config --global core.excludesfile &lt;filepath&gt; <span class="comment"># 设置忽略的文件</span></span><br><span class="line">git config --global help.autocorrect 1 <span class="comment"># 输入命令有误时，0.1s 后自动执行模糊匹配的命令</span></span><br><span class="line">git config --global credential.helper cache <span class="comment"># 将 https 推送需要的用户密码缓存在内存中，时效为几分钟</span></span><br><span class="line">git config --global color.ui <span class="literal">false</span> <span class="comment"># 禁用有彩色输出</span></span><br><span class="line">git config --global color.[diff|branch|interactive|status].meta <span class="string">"blue black bold"</span> <span class="comment"># 设置命令的颜色</span></span><br><span class="line">git config --global core.autocrlf <span class="literal">true</span> <span class="comment"># Windows 使用回车（CR）和换行（LF）两个字符来结束一行，而 Mac 和 Linux 只使用换行（LF）一个字符。core.autocrlf 设置为 true，提交时自动将回车和换行转换成换行，检出时将换行转换成回车和换行。core.autocrlf 设置为 input，提交时自动把回车和换行转换成换行，检出时不转换</span></span><br><span class="line">git config --global core.whitespace \</span><br><span class="line">  trailing-space,space-before-tab,indent-with-non-tab <span class="comment"># 空格检测。默认开启项 blank-at-eol，查找行尾的空格；blank-at-eof，盯住文件底部的空行；space-before-tab，警惕行头 tab 前面的空格。默认关闭项 indent-with-non-tab，揪出以空格而非 tab 开头的行（你可以用 tabwidth 选项控制它）；tab-in-indent，监视在行头表示缩进的 tab；cr-at-eol，告诉 Git 忽略行尾的回车。git diff 时将应用空格检测；git apply --whitespace=warn &lt;patch&gt; 应用补丁时检测空格；git apply --whitespace=fix &lt;patch&gt; 自动修复；git rebase --whitespace=fix 变基时自动修复</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 别名</span></span><br><span class="line">git config --global alias.co checkout <span class="comment"># git co 将等价于 git checkout</span></span><br><span class="line">git config --global alias.br branch</span><br><span class="line">git config --global alias.ci commit</span><br><span class="line">git config --global alias.st status</span><br><span class="line">git config --global alias.unstage <span class="string">'reset HEAD --'</span> <span class="comment"># git unstage 将等价于 git reset Head -- </span></span><br><span class="line">git config --global alias.last <span class="string">'log -1 HEAD'</span> <span class="comment"># git last 查看最后一次提交信息</span></span><br><span class="line">git config --global alias.visual <span class="string">'!npm'</span> <span class="comment"># git visual 将调用外部命令 npm</span></span><br><span class="line"></span><br><span class="line">git config --global pull.rebase <span class="literal">true</span> <span class="comment"># 更改 pull.rebase 的默认配置</span></span><br><span class="line">git config --global merge.conflictstyle diff3 <span class="comment"># 以 diff3 方式查看冲突文件，包含当前工作分支、待合并分支、共同祖先分支的冲突文件内容</span></span><br><span class="line"></span><br><span class="line">git config --system receive.fsckObjects <span class="literal">true</span> <span class="comment"># 推送生效前检验每个对象的有效性以及 SHA-1 检验和是否保持一致</span></span><br><span class="line">git config --system receive.denyNonFastForwards <span class="literal">true</span> <span class="comment"># 禁用强制更新 git push -f</span></span><br><span class="line">git config --system receive.denyDeletes <span class="literal">true</span> <span class="comment"># 避免删除远程分支后，再推送本地分支</span></span><br></pre></td></tr></table></figure>
<h3 id="帮助"><a href="#帮助" class="headerlink" title="帮助"></a>帮助</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">help</span> config <span class="comment"># 打印 git config 命令的完整手册</span></span><br><span class="line">man git-confgi <span class="comment"># 同上</span></span><br><span class="line">git-config -h|--<span class="built_in">help</span> <span class="comment"># 简要帮助信息</span></span><br></pre></td></tr></table></figure>
<h3 id="疑问"><a href="#疑问" class="headerlink" title="疑问"></a>疑问</h3><ol>
<li>保存快照不吃磁盘空间吗？git 命令在运行时比较文件差异，如 add, commit？那执行效率如何提升？</li>
<li>数据库怎样存储历史版本数据？</li>
<li>游戏在用户端以补丁形式下载并更新，若代码使用 git 管理，怎样做到根据文件差异只做局部封信，而不是全量下载并更新？同样的，git pull 等命令怎样做到效率地只修改局部资源？</li>
<li>在多分支开发，又相继合并到 master 分支的情形下，提交对象链表会形成怎样的构造？根据提交时间形成单链表形式？</li>
<li>git reset 命令执行后，如何改变提交历史，新的提交对之前提交历史的影响？如重置第三次提交，新的提交会在第一次提交之后创建提交对象，还是在之前创建提交对象？</li>
<li>git checkout 命令可以针对某次提交对象，即可以执行 git checkout <checksum> 命令？</checksum></li>
</ol>
<h2 id="Git-Basics"><a href="#Git-Basics" class="headerlink" title="Git Basics"></a>Git Basics</h2><h3 id="创建本地仓库"><a href="#创建本地仓库" class="headerlink" title="创建本地仓库"></a>创建本地仓库</h3><p>创建 git 本地仓库，指定 git init 或 git clone <url> [projectName] 命令（projectName 用于指定本地目录名）。git clone 将拷贝远程仓库的所有版本及所有文件（当服务器磁盘损坏时，方便使用本地仓库的命令将远程仓库的资源回滚到拷贝前），创建 .git 目录，并检出最新分支。git clone 时，可使用 https 协议 或 git:// 起始的 SSH 协议。</url></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git init <span class="comment"># 创建 git 本地仓库</span></span><br><span class="line">git <span class="built_in">clone</span> &lt;url&gt; [projectName] <span class="comment"># 克隆远程仓库，指定远程仓库的简称默认为 origin，且本地 master 分支将跟踪/track 远程 master，可使用 git pull|push 命令</span></span><br></pre></td></tr></table></figure>
<h3 id="文件状态"><a href="#文件状态" class="headerlink" title="文件状态"></a>文件状态</h3><p>工作区的文件状态有两种，已追踪/tracked, 未追踪/untracked。暂存区的最新快照中包含某文件，该文件即被追踪；若不包含，该文件即未追踪。已追踪文件又分为三种状态，未变更/unmodified, 已变更/modified, 已提交到暂存区/staged。在切换分支时，git 会校验工作区的文件改动是否提交到版本库中，未提交，则阻止切换，用以防止丢失工作区的改动。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">git status <span class="comment"># 获取文件状态</span></span><br><span class="line">git status -s|--short <span class="comment"># 文件状态扼要信息。?? 未追踪文件，A 新增文件提交到到暂存区，M 修改文件提交到暂存区，MM 暂存区和工作区文件状态</span></span><br><span class="line">git diff <span class="comment"># 工作区和暂存区文件差异，显示文件更新细节，包括添加的行、删除的行，合称为文件更新补丁/patch</span></span><br><span class="line">git diff --staged|--cached <span class="comment"># 暂存区和版本库文件差异</span></span><br><span class="line">git difftool <span class="comment"># 使用 Araxis, emerge, vimdiff 等软件以图形化或其他格式显示文件差异</span></span><br><span class="line">git difftool -tool-help <span class="comment"># 查看系统支持的 git diff 插件</span></span><br><span class="line">git add &lt;files&gt; <span class="comment"># 工作区文件提交到暂存区，将产生暂存区的历史快照/historical snapshort。参数为文件或目录路径</span></span><br><span class="line">git commit <span class="comment"># 暂存区快照提交版本去，需由命令行编辑器设置 message，# 起始内容将被忽略。命令行编辑器中默认以 # 添加 git status 输出内容。-v 选项可用于注入 git diff 完整信息</span></span><br><span class="line">git commit -m <span class="string">'message'</span> <span class="comment"># 设置 message 并提交</span></span><br><span class="line">git commit -a <span class="comment"># 直接将工作区中已追踪的文件提交到版本库，跳过暂存区</span></span><br><span class="line">git rm &lt;pattern&gt; <span class="comment"># 暂存区删除文件，工作区也作相应删除，需要提交到版本库。直接删除工作区中文件，不会影响暂存区</span></span><br><span class="line">git rm -f|--force &lt;pattern&gt; <span class="comment"># 修改后文件提交到暂存区，与版本库中文件有差异，需使用 -f 选项强制删除</span></span><br><span class="line">git rm --cached &lt;pattern&gt; <span class="comment"># 暂存区删除文件，但保留工作区文件，适用于未配置 .gitignore 的文件</span></span><br><span class="line">git mv file_from file_to <span class="comment"># 移动文件，可实现文件重命名。重命名时，等同于 mv file_from file_to; git rm file_from; git add file_to。git 没有显式追踪文件移动操作，通过执行的命令获知用户重命名行为</span></span><br></pre></td></tr></table></figure>
<h3 id="gitignore"><a href="#gitignore" class="headerlink" title=".gitignore"></a>.gitignore</h3><p>.gitignore 配置文件，即忽略文件列表。可设置多个 .gitignore 文件，当前文件所在目录自底向上获取 .gitignore 文件，作为优先级顺序。编写 .gitignore 文件可使用标准 glob 模式(shell 中简易正则，* 零或多个任意字符，** 任意中间目录，其余同正则)；空行或 ‘#’ 开头将被忽略；’/‘ 开头相对于工程目录；’/‘ 结尾匹配目录；’!’ 开头置否值。</p>
<h3 id="commit-历史记录"><a href="#commit-历史记录" class="headerlink" title="commit 历史记录"></a>commit 历史记录</h3><p>无论本地仓库，还是克隆下来的远程仓库，都可以使用 git log 命令查看提交记录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> <span class="comment"># 显示提交记录，反序排列，包含 SHA-1 哈希算法校验和(作为索引), 作者, 日期, message</span></span><br><span class="line">git <span class="built_in">log</span> -p|--patch <span class="comment"># 显示内容差异</span></span><br><span class="line">git <span class="built_in">log</span> --<span class="built_in">stat</span> <span class="comment"># 显示每次更新的文件修改统计信息</span></span><br><span class="line">git <span class="built_in">log</span> --shortstat <span class="comment"># 只显示 --stat 中最后的行数修改添加移除统计</span></span><br><span class="line">git <span class="built_in">log</span> --name-only <span class="comment"># 仅在提交信息后显示已修改的文件清单</span></span><br><span class="line">git <span class="built_in">log</span> --name-status <span class="comment"># 显示新增、修改、删除的文件清单</span></span><br><span class="line">git <span class="built_in">log</span> --abbrev-commit <span class="comment"># 仅显示 SHA-1 的前几个字符，而非所有的 40 个字符</span></span><br><span class="line">git <span class="built_in">log</span> --relative-date <span class="comment"># 使用较短的相对时间显示，如 '2 weeks ago'</span></span><br><span class="line">git <span class="built_in">log</span> --graph <span class="comment"># 显示 ASCII 图形表示的分支合并历史</span></span><br><span class="line">git <span class="built_in">log</span> --pretty=oneline <span class="comment"># 指定显示格式，--pretty 选项的可选值为 oneline, short, full, fuller, format。其中，oneline 以一行展示提交信息</span></span><br><span class="line">git <span class="built_in">log</span> --pretty=format:<span class="string">"%h - %an, %ar : %s"</span> <span class="comment"># 指定输出信息的模板字符串，用于提取分析报告。占位符包含 %H 提交对象/commit的完整哈希字串, %h 提交对象的简短哈希字串, %T 树对象/tree的完整哈希字串, %t, %P 父对象/parent的完整哈希字串, %p, %an 作者, %ae 作者的邮箱, %ad 作者修订日期, %ar 作者的相对修订日期, %cn 提交者, %ce, %cd, %cr, %s 说明</span></span><br><span class="line">git <span class="built_in">log</span> --oneline <span class="comment"># --pretty=oneline --abbrev-commit 简写形式</span></span><br><span class="line">git <span class="built_in">log</span> -&lt;n&gt; <span class="comment"># -n 指定只显示最后两次提交记录，如 -2。通常不需要使用。因为 git log 显示采用分页形式，用户只能看到第一页</span></span><br><span class="line">git <span class="built_in">log</span> --since|--after=2.weeks <span class="comment"># --since 选项指定起始时间，可用相对时间或绝对时间，如 '2 years 1 day 3 minutes ago'</span></span><br><span class="line">git <span class="built_in">log</span> --until|--before=<span class="string">"2008-01-15"</span> <span class="comment"># 同上，指定结束时间</span></span><br><span class="line">git <span class="built_in">log</span> --author=authorname <span class="comment"># 过滤作者</span></span><br><span class="line">git <span class="built_in">log</span> --committer=committername <span class="comment"># 过滤提交者</span></span><br><span class="line">git <span class="built_in">log</span> --grep=messagekey <span class="comment"># 按 message 中关键字检索，与 --author 合用时为或匹配，添加 --all-match 选项强制匹配 grep 指定关键字</span></span><br><span class="line">git <span class="built_in">log</span> -S function_name <span class="comment"># 指定字符串检索更改相应字符串的提交记录</span></span><br><span class="line">git <span class="built_in">log</span> --no-merges <span class="comment"># 不显示 merge 记录</span></span><br><span class="line">git <span class="built_in">log</span> --filename <span class="comment"># 作为最后一个选项，检索更改相应文件或目录的提交记录</span></span><br></pre></td></tr></table></figure>
<h3 id="撤销"><a href="#撤销" class="headerlink" title="撤销"></a>撤销</h3><p>撤销操作不能回滚，容易引起数据丢失。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git commit --amend <span class="comment"># 合并上一次提交记录，适用于文件漏提交等轻微改动场景。若暂存区文件未作更新，commit 快照将保持不变，只更改 message 或者连 message 也未作更改。只保留当前的提交记录；撤销上一次提交记录，即不会存在于提交记录中</span></span><br><span class="line">git reset HEAD &lt;filename&gt; <span class="comment"># 暂存区文件重置为提交前状态。执行 git status 命令，工作位已更改文件的状态为 unstaged。git reset 命令不加选项，只更改暂存区。git reset --hard 命令将可能导致工作区的当前进度全部丢失，相当危险</span></span><br><span class="line">git checkout -- &lt;file&gt; <span class="comment">#  使用暂存区的文件替换工作区的文件，即工作区文件回滚</span></span><br></pre></td></tr></table></figure>
<h3 id="远程协作"><a href="#远程协作" class="headerlink" title="远程协作"></a>远程协作</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">git remote <span class="comment"># 列出远程服务器的简称，默认为 origin</span></span><br><span class="line">git remote -v <span class="comment"># 列出远程服务器的简称和 url 列表，同一个项目可能指定了多个远程仓库。fetch, push 操作的服务器资源也可能不同，由远程仓库决定</span></span><br><span class="line">remote add &lt;shortname&gt; &lt;url&gt; <span class="comment"># 添加远程仓库</span></span><br><span class="line">git fetch &lt;shortname|url&gt; <span class="comment"># 抓取远程仓库资源，包含所有分支，并创建本地远程跟踪分支，却不会创建可修改、供开发的本地同名分支。只下载远程仓库资源，需手动 merge</span></span><br><span class="line">git pull <span class="comment"># 若本地分支跟踪远程分支，git pull 命令自动拉取远程仓库中指定的分支，并尝试 merge</span></span><br><span class="line">git pull &lt;remotename&gt; &lt;branchname&gt; <span class="comment"># 拉取远程分支资源，并尝试 merge。选项 remotename 指定远程仓库，branchname 指定分支</span></span><br><span class="line">git push <span class="comment"># 若本地分支跟踪远程分支，git push 将资源推送到远程仓库下的指定分支</span></span><br><span class="line">git push &lt;remotename&gt; &lt;branchname&gt; <span class="comment"># 推送资源到指定远程下的指定分支</span></span><br><span class="line">git remote show &lt;remotename&gt; <span class="comment"># 查看远程仓库 fetch|push 操作的 url，包含的分支，以及跟踪分支信息</span></span><br><span class="line">git remote rename shortname_before shortname_after <span class="comment"># 改写远程仓库的简称，同时改变分支名，如更新为 shortname_after/master</span></span><br><span class="line">git remote remove|rm &lt;remotename&gt; <span class="comment"># 本地移除某远程仓库，同时影响其下分支和配置，对远程仓库无影响</span></span><br></pre></td></tr></table></figure>
<h3 id="打标签"><a href="#打标签" class="headerlink" title="打标签"></a>打标签</h3><p>git 标签分为两种，轻量标签lightweight, 附注标签 annotated。轻量标签通过 git tag 不带选项创建，附注标签通过 git tag -a 创建。附注标签以对象形式存储在 git 数据库中，包含标签作者，电邮，日期，标签信息/message，并且可以使用 GPG 签名和验证。git tag 命令通常用来发布不再修改的版本(通过 git push <tagname> 命令)，且发布以后，不能再作修改，需要在本地创建新分支拉取标签资源，作适当修改后再发布。</tagname></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git tag <span class="comment"># 列出所有标签，以字母顺序罗列</span></span><br><span class="line">git tag -l|-list &lt;pattern&gt; <span class="comment"># 只罗列匹配的标签，如 git tag -l "v1.8.5*"。pattern 中若含有通配符，-l 选项不可缺失</span></span><br><span class="line">git tag &lt;tagname&gt; <span class="comment"># 创建轻量标签，git show &lt;tagname&gt; 时只显示 commit 信息</span></span><br><span class="line">git tag -a &lt;tagname&gt; -m <span class="string">"message"</span> <span class="comment"># 创建附注标签，git show &lt;tagname&gt; 时除显示 commit 信息外，还显示标签作者，电邮，日期，标签信息等</span></span><br><span class="line">git show &lt;tagname&gt; <span class="comment"># 查看标签信息及对应的提交信息</span></span><br><span class="line">git tag -a &lt;tagname&gt; &lt;checksum&gt; <span class="comment"># 提交后再打标签，选项 checksum 为 hash算法校验和，即快照的索引，可以只包含部分 hash 值</span></span><br><span class="line">git push origin &lt;tagname&gt; <span class="comment"># 将标签推送到远程共享服务器上</span></span><br><span class="line">git push --tags <span class="comment"># 将本地所有标签推送到服务器上</span></span><br><span class="line">git checkout &lt;tagname&gt; <span class="comment"># 检出标签，但不能真正检出标签，本地仓库会进入 "detached HEAD" 状态，提交将不从属于任何分支，只有 commit checksum 校验和能被 git 感知到</span></span><br><span class="line">git checkout -b &lt;branchnam&gt; &lt;tagname&gt; <span class="comment"># 在本地创建新分支，并拉取指定标签资源。修改后，重新创建标签并 push</span></span><br></pre></td></tr></table></figure>
<h3 id="疑问-1"><a href="#疑问-1" class="headerlink" title="疑问"></a>疑问</h3><ol>
<li>暂存区存在的意义？</li>
<li>强制删除的意义？</li>
<li>commit 提交记录以何种形式存储，才能实现快速检索？关于 git database？</li>
<li>本地版本库如何回滚？</li>
<li>git pull|push 只拉取或推送快照，还是所有历史记录？</li>
<li>git 远程服务器对版本管理的实现是否和本地相同，可否指定局域网中某台机器作为拉取资源的源头？</li>
<li>打标签只针对 commit 操作？且标签只针对不会再修改的版本？git push origin [tagname] 推送到共享服务器和 git push origin [branchname] 的差异？</li>
<li>切换分支时，为什么需要提交到版本库，而不是暂存库，这样就可以避免工作区的变更丢失了？</li>
</ol>
<h2 id="Git-Branching"><a href="#Git-Branching" class="headerlink" title="Git Branching"></a>Git Branching</h2><h3 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h3><p>分支原理见 Getting Started。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> --oneline --decorate <span class="comment"># --decorate 选项用于查询各个分支及 HEAD 指针指向哪个提交对象</span></span><br><span class="line">git <span class="built_in">log</span> --oneline --decorate --graph --all <span class="comment"># 查看提交历史的分叉情况，各个分支及 HEAD 指针的指向</span></span><br><span class="line">git branch <span class="comment"># 查看所有分支，带 '*' 的为当前分支</span></span><br><span class="line">git branch -v <span class="comment"># 查看所有分支最后一次提交记录</span></span><br><span class="line">git branch --merged <span class="comment"># 查看已合并到当前分支的所有分支</span></span><br><span class="line">git branch --no-merged <span class="comment"># 查看未合并到当前分支的所有分支</span></span><br><span class="line">git branch --merged &lt;branchname&gt; <span class="comment"># 查看已合并到 branchname 分支的所有分支</span></span><br><span class="line">git branch --no-merged &lt;branchname&gt; <span class="comment"># 查看未合并到 branchname 分支的所有分支</span></span><br><span class="line">git branch &lt;branchname&gt; <span class="comment"># 创建分支，但不切换分支</span></span><br><span class="line">git branch -d &lt;branchname&gt; <span class="comment"># 删除分支，branchname 未合并到当前分支，将不予删除</span></span><br><span class="line">git branch -D &lt;branchname&gt; <span class="comment"># 强制删除分支</span></span><br><span class="line">git checkout &lt;branchname&gt; <span class="comment"># 切换分支，即改变 HEAD 指针指向。修改文件但未提交到版本库的，git 将阻止切换</span></span><br><span class="line">git checkout -b &lt;branchname&gt; <span class="comment"># 创建并切换分支</span></span><br><span class="line">git merge &lt;branchname&gt; <span class="comment"># 将 branchname 分支合并到当前分支</span></span><br><span class="line">git status <span class="comment"># 查看冲突文件</span></span><br><span class="line">git mergetool <span class="comment"># 使用图形化工具解决冲突，默认使用 opendiff 工具，可选用工具包含 opendiff, kdiff3, tkdiff, xxdiff, meld, tortoisemerge, gvimdiff, diffuse, diffmerge, ecmerge, p4merge, araxis, bc3, codecompare, vimdiff, emerge</span></span><br><span class="line">git mergetool --tool-help <span class="comment"># 合并工具帮助信息</span></span><br></pre></td></tr></table></figure>
<h3 id="工作流"><a href="#工作流" class="headerlink" title="工作流"></a>工作流</h3><p>推荐使用的本地开发工作流/workflow 有两种，长期分支模式(Long-Running Branches)，特性分支模式(Topic Branches)。当然，这只是一种参考。</p>
<p>长期分支模式根据稳定性创建分支，需要较高稳定性的分支创建在前，较低稳定性的创建在后，如 master 分支先于 develop 分支，develop 分支先于 topic 分支，合并时依序将 topic 分支合并到 develop 分支，develop 分支合并到 master 分支。适用于大型项目，作为分支创建的基础结构，在每个分支可以再次使用特性分支模式。</p>
<p>特性分支模式适用于开发者想法多变的场景，比如在 master 分支基础创建 hotfix 分支，接着创建 hotfix_v2，同时开发 hotfix, hotfix_v2 分支，最终又启用 hotfix 分支；与此同时，开发过程中 master 分支不只产生了新的提交，后续又创建了实现新想法的 idea 分支，最后将 hotfix_v2, idea 分支合并到 master 分支。</p>
<h3 id="远程分支"><a href="#远程分支" class="headerlink" title="远程分支"></a>远程分支</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">git ls-remote &lt;shortname&gt; <span class="comment"># 查看远程引用清单</span></span><br><span class="line">git remote show &lt;shortname&gt; <span class="comment"># 查看远程引用详细信息</span></span><br><span class="line">git push &lt;shortname&gt; &lt;branch&gt; <span class="comment"># 将当前分支的提交内容推送到远程 branch 分支，git 自动将分支名扩展为 refs/heads/branch:refs/heads/branch，意为将本地 branch 分支推送并更新远程 branch 分支</span></span><br><span class="line">git push shortname localebranch:remotebranch <span class="comment"># 推送本地 localebranch 分支，将其作为远程 remotebranch 分支</span></span><br><span class="line">git merge shortname/branchname <span class="comment"># 将远程跟踪分支 shortname/branchname 合并到当前分支，合并前须 git fetch</span></span><br><span class="line">git checkout -b localebranch shortname/remotebranch <span class="comment"># 通过远程跟踪分支创建本地分支，自动跟踪远程分支，可使用 git pull|push 简化拉取、提交操作；且可以在命令行中使用 @&#123;upstream&#125; 或 @&#123;u&#125; 代替 shortname/remotebranch</span></span><br><span class="line">git checkout --track shortname/remotebranch <span class="comment"># 上一条命令的简写形式，创建 remotebranch 同名分支</span></span><br><span class="line">git checkout remotebranch <span class="comment"># 上一条命令的简写形式，条件是本地未存在 remotebranch 同名分支，远程存在</span></span><br><span class="line">git branch -u|--<span class="built_in">set</span>-upstream-to shortname/remotebranch <span class="comment"># 当前分支切换跟踪远程 remotebranch 分支。-u 选项可用于 pull, push 命令</span></span><br><span class="line">git branch -vv <span class="comment"># 查看本地分支在跟踪哪个远程分支，以及ahead, behind, up to date等提交状态。这条命令基于最后一次 fetch 的数据，命令本身没有连接服务器</span></span><br><span class="line">git fetch &lt;shortname|url&gt; <span class="comment"># 抓取远程仓库资源，包含所有分支，并创建本地远程跟踪分支，却不会创建可修改、供开发的本地同名分支。只下载远程仓库资源，不会更改工作区内容，需手动 merge</span></span><br><span class="line">git pull <span class="comment"># git fetch, git merge 命令的结合，拉取数据并合并</span></span><br><span class="line">git push origin --delete remotebranch <span class="comment"># 删除远程分支</span></span><br></pre></td></tr></table></figure>
<h3 id="变基"><a href="#变基" class="headerlink" title="变基"></a>变基</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git rebase &lt;basebranch&gt; <span class="comment"># 将当前分支以补丁形式在 basebranch 分支上创建新的提交对象。完成开叉分支的整合操作还需要在 basebranch 分支上 merge 当前分支</span></span><br><span class="line">git rebase &lt;basebranch&gt; &lt;topicbranch&gt; <span class="comment"># 同上，该命令不需要切换到 topicbranch 分支后执行</span></span><br><span class="line">git rebase --onto &lt;basebranch&gt; &lt;topicbranch1&gt; &lt;topicbranch2&gt; <span class="comment"># --onto 选项用于获取在 topicbranch2 分支内但不在 topicbranch1 内的文件修改补丁，并在 basebranch 分支上创建新的提交对象，即变基到 basebranch </span></span><br><span class="line">git rebase remote/branch <span class="comment"># 将本地修改变基到远程引用 remote/branch 分支上</span></span><br><span class="line">git pull --rebase remote/branch <span class="comment"># 等同 git fetch, get rebase remote/branch</span></span><br></pre></td></tr></table></figure>
<h2 id="Git-on-the-Server"><a href="#Git-on-the-Server" class="headerlink" title="Git on the Server"></a>Git on the Server</h2><h3 id="传输协议"><a href="#传输协议" class="headerlink" title="传输协议"></a>传输协议</h3><p>git 可以使用四种传输资料的协议：Local 本地协议，Http 协议，SSH 协议和 Git 协议。</p>
<p>Local 协议常见于协作者对同一个共享的文件系统(如一个挂载的 NFS)都有访问权限。git clone /opt/git/project.git 命令将采用硬链接或直接拷贝文件；git clone file:///opt/git/project.git 将触发用于网路传输资料的进程，传输效率较低；git remote add local_proj /opt/git/project.git 命令用于增加本地版本库。</p>
<p>Http 协议既支持像 git:// 协议一样设置匿名服务，也可以像 SSH 协议一样提供传输时的授权和加密。Git 协议，要么谁都可以克隆这个版本库，要么谁也不能。</p>
<h3 id="搭建-git-服务器"><a href="#搭建-git-服务器" class="headerlink" title="搭建 git 服务器"></a>搭建 git 服务器</h3><p>首先需要把现有 git 仓库导出为一个裸仓库，即不包含工作目录的仓库。这一过程通过 –bare 选项完成，具体命令为 git clone –bare my_project my_project.git。其次将裸仓库放在服务器上，若已在 git.example.com 搭好服务器，且需要在 /opt/git 目录下放置所有 git 仓库，通过执行 scp -r my_project.git <a href="mailto:user@git.example.com" target="_blank" rel="noopener">user@git.example.com</a>:/opt/git 复制裸仓库到 /opt/git 目录下。此时，对服务器 /opt/git 目录拥有可读权限的用户就可以通过 git clone <a href="mailto:user@git.example.com" target="_blank" rel="noopener">user@git.example.com</a>:/opt/git/my_project.git 克隆仓库。若在仓库中执行 git init –bare –shared 命令，可将仓库的权限设为可写(基于服务器文件系统权限)。连接服务器的权限通过服务器自有的 SSH 服务实现，创建访问账户也针对服务器，而不是 git 仓库。访问权限也可以在服务器创建 git 账户，然后将需要写权限的用户的 SSH 公钥加入 git 账户的 ~/.ssh/authorized_keys 文件中；或者让 SSH 服务器通过某个 LDAP 服务，或者其他已经设定好的集中授权机制，来进行授权。</p>
<p>生成 SSH 公钥通过以下步骤完成：通过 ssh-keygen 命令创建公钥(存放在 id_dsa.pub 文件中)和密钥(存放在 id_dsa 文件中)；将公钥复制到 git 账户的 ~/.ssh/authorized_keys 文件中(通过 git 服务器管理员完成，或自动化脚本实现)。</p>
<p>在服务器创建 git 账户时，将使所有获得授权的用户都能以系统用户 git 的身份登录服务器从而获得一个普通 shell，即能对服务器进行一定操作。若想对此加以限制，则需要修改 passwd 文件中(git 用户所对应)的 shell 值；或者通过 git 软件包自带的 git-shell 工具代替 bash 或 csh 作为用户的登录 shell，用户即不能通过登录 shell 执行非 git 命令(上述过程，通过 sudo chsh git 命令改变系统用户的登录 shell 实现)。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --bare my_project my_project.git <span class="comment"># 通过 --bare 选项创建裸仓库</span></span><br><span class="line">cp -Rf my_project/.git my_project.git <span class="comment"># 同上</span></span><br><span class="line">git init --bare <span class="comment"># 新疆一个空仓库</span></span><br><span class="line">git init --bare --shared <span class="comment"># 新疆一个空仓库，并将仓库的权限设为可写</span></span><br></pre></td></tr></table></figure>
<h3 id="疑问-2"><a href="#疑问-2" class="headerlink" title="疑问"></a>疑问</h3><ol>
<li>协议相关知识再梳理？</li>
<li>搭建 git 服务器过程再梳理，包含守护进程、git-http-backend 脚本在Apache 服务器上的使用、GitWeb 网页查看、GitLab 服务器等？</li>
</ol>
<h2 id="Distributed-Git"><a href="#Distributed-Git" class="headerlink" title="Distributed Git"></a>Distributed Git</h2><h3 id="分布式工作流"><a href="#分布式工作流" class="headerlink" title="分布式工作流"></a>分布式工作流</h3><p>分布式工作流有三种，包含集中式工作流、集成管理者工作流、司令官和副官工作流。一般项目采用集中式工作流，当 A 用户提交了代码后，B 用户再次提交前，先须拉取代码并合并，然后才能提交；否则会报提交失败。集成管理者工作流通常在 github 开源代码中采用，即作为开源代码的贡献者，先须 fork 该项目，创建一个自己的仓库，更新提交后，发送消息给开源代码的维护者，等待维护者合并贡献者的代码并提交。司令官和副官工作流见于 linux 开发项目，普通开发者完成开发后，基于司令官的 master 执行变基操作；副官再将普通开发者的分支合并到自己的 master 分支上；司令官合并所有副官的 master 分支并提交。</p>
<h3 id="提交准则"><a href="#提交准则" class="headerlink" title="提交准则"></a>提交准则</h3><ol>
<li>避免空白错误。</li>
<li>尝试让每一个提交成为一个逻辑上的独立变更集，即针对每个问题，独立提交一次。</li>
<li>完善提交信息，使用 vim 编辑提交信息，推荐使用 标题 + 空行 + 正文 形式。</li>
</ol>
<h3 id="贡献代码"><a href="#贡献代码" class="headerlink" title="贡献代码"></a>贡献代码</h3><h4 id="私有小型团队"><a href="#私有小型团队" class="headerlink" title="私有小型团队"></a>私有小型团队</h4><p>用户 A 创建特性分支 feature1 并作修改后，再将特性分支合并到 master 分支上。用户 B 创建了特性分支 feature2 并作修改后，若在此时，用户 B 想把 feature2 内容合并到 master 分支并作提交，那他需要在 master 分支上执行 git fetch; git merge origin/master; git merge feature2 命令，即合并本地特性分支和远程协作者提交内容后，才可以正式提交代码。这样的工作流程最常见于实际项目中。</p>
<h4 id="私有大型团队"><a href="#私有大型团队" class="headerlink" title="私有大型团队"></a>私有大型团队</h4><p>用户 A 和 B 在特性分支 feature1 上工作，用户 B 和 C 在特性分支 feature2 上工作。工作流程采用了整合-管理者工作流程，即独立小组的工作只能被特定的工程师整合，主仓库的 master 分支只能被那些工程师更新。当 feature1, feature2 开发并测试完成后，再由整合者将两个分支的内容合并到 master 分支上。对于 feature1, feature2 的开发工作流程，同小型私有团队，即提交前先要合并协作者上传到远端的代码。</p>
<h4 id="派生的公开项目"><a href="#派生的公开项目" class="headerlink" title="派生的公开项目"></a>派生的公开项目</h4><p>首先 clone 项目，然后在本地创建 feature1 分支(使 master 分支保持干净，避免维护者不采用你的代码时，需要回滚 master 分支到最初 clone 时的状态)，fork 仓库(即派生项目)后提交到远程自己的同名仓库中。通知开源项目的维护者拉取你的改动，这通常被称为拉取请求(pull request)，可通过执行 git request-pull origin/master feature 命令告知维护者改动是在你 fork 的仓库的 feature 分支上完成的。</p>
<h4 id="通过邮件的公开项目"><a href="#通过邮件的公开项目" class="headerlink" title="通过邮件的公开项目"></a>通过邮件的公开项目</h4><p>有几个历史悠久的、大型的项目会通过一个开发者的邮件列表接受补丁。使用 git format-patch 来生成可以邮寄到列表的 mbox 格式的文件 - 它将每一个提交转换为一封电子邮件，提交信息的第一行作为主题，剩余信息与提交引入的补丁作为正文。-M 选项用于告诉 Git 查找重命名。通过 git config 设置 imap 区块的 folder = “[Gmail]/Drafts”, host = imaps://imap.gmail.com, user = <a href="mailto:user@gmail.com" target="_blank" rel="noopener">user@gmail.com</a>, pass = p4ssw0rd, port = 993, sslverify = false 属性(如果 IMAP 服务器不使用 SSL，无需设置 port, sslverify 属性，host 的值会是 imap:// 而不是 imaps://)；再执行 git imap-send 可以将补丁序列放在特定 IMAP 服务器的 Drafts 文件夹。或者通过 git config 设置 sendemail 区块的 smtpencryption = tls, smtpserver = smtp.gmail.com, smtpuser = <a href="mailto:user@gmail.com" target="_blank" rel="noopener">user@gmail.com</a>, smtpserverport = 587 属性；再执行 git send-email 通过 SMTP 服务器发送补丁。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git diff --check <span class="comment"># 检查空白错误。空白错误是指行尾的空格、Tab 制表符，和行首空格后跟 Tab 制表符的行为</span></span><br><span class="line">git format-patch -M origin/master <span class="comment"># 生成 .patch 扩展名的补丁文件，可以编辑该文件，添加额外信息</span></span><br><span class="line">cat *.patch |git imap-send <span class="comment"># 通过 IMAP 发送正确格式化的补丁</span></span><br><span class="line">git send-email *.patch <span class="comment"># 通过 SMTP 服务器发送补丁</span></span><br></pre></td></tr></table></figure>
<h3 id="维护项目"><a href="#维护项目" class="headerlink" title="维护项目"></a>维护项目</h3><h4 id="应用补丁"><a href="#应用补丁" class="headerlink" title="应用补丁"></a>应用补丁</h4><p>若补丁通过 git diff 生成，使用 git apply 命令可在当前工作分支中应用文件补丁。应用补丁前，使用 git apply –check 命令可检查补丁是否可以顺利应用。</p>
<p>若补丁通过 format-patch 生成，使用 git am 命令可以提取出 mbox 文件中的实际变更并应用，且自动创建新的提交。</p>
<h4 id="合并工作流"><a href="#合并工作流" class="headerlink" title="合并工作流"></a>合并工作流</h4><p>合并工作流，可以将特性分支逐次合并到 master 分支上；或者保持 master 分支的稳定性，再创建 develop 长期分支，将特性分支合并 develop 分支，等 develop 分支稳定后，再合并到 master 分支上；或者在 master 之外创建 next, pu(proposed updates，用于新工作), maint(maintenance backports，用于维护性向后移植工作) 分支，安全的特性分支先合并入 next 分支，再合并到 master 分支上。</p>
<h4 id="拣选"><a href="#拣选" class="headerlink" title="拣选"></a>拣选</h4><p>执行 git cherry-pick，见原理。</p>
<h4 id="重用冲突解决方案-reuse-recorded-resolution"><a href="#重用冲突解决方案-reuse-recorded-resolution" class="headerlink" title="重用冲突解决方案/reuse recorded resolution"></a>重用冲突解决方案/reuse recorded resolution</h4><p>执行 git config –global rerere.enabled true 缓存冲突解决方案。执行 git rerere 命令将从缓存中查找相似的冲突，并应用对应的解决方案。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">git apply *.patch <span class="comment"># 在当前分支中应用补丁</span></span><br><span class="line">git apply --check *.patch <span class="comment"># 检查补丁是否可被顺利应用</span></span><br><span class="line">git am *.patch <span class="comment"># 读取 mbox 文件实际变更并应用</span></span><br><span class="line">git am -3 *.patch <span class="comment"># -3 选项将使用三方合并应用补丁</span></span><br><span class="line">git am -3 -i mbox <span class="comment"># 使用交互模式应用多个补丁</span></span><br><span class="line">git am --resolved <span class="comment"># git am 报错后，手动解决冲突，执行下一个补丁的应用</span></span><br><span class="line">git am --skip <span class="comment"># 跳过当前补丁</span></span><br><span class="line">git am --abort <span class="comment"># 当前分支回退到应用补丁前状态，终止补丁应用</span></span><br><span class="line">git <span class="built_in">log</span> branch1 --not branch2 <span class="comment"># 找出仅属于 branch1 但不属于 branch2 的提交记录</span></span><br><span class="line">git diff branch <span class="comment"># 当前工作分支与 branch 分支比较差异</span></span><br><span class="line">git merge-base branch1 branch2 <span class="comment"># 找出 branch1 和 branch2 的共同祖先</span></span><br><span class="line">git diff branch1...branch2 <span class="comment"># 比较 branch1 的最新提交和两个分支的共同祖先之间的差异</span></span><br><span class="line">git cherry-pick &lt;checksum&gt; <span class="comment"># 以某个提交对象为基底在当前工作分支上创建新的提交对象，将重新计算校验和，如 git cherry-pick e43a6fd3e94888d76779ad79fb568ed180e5fcdf</span></span><br><span class="line">git config --global rerere.enabled <span class="literal">true</span> <span class="comment"># 开启冲突解决方案缓存</span></span><br><span class="line">git rerere <span class="comment"># 查找相似的冲突解决方案并应用</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 发布</span></span><br><span class="line">git tag -s &lt;version&gt; -m <span class="string">'message'</span> <span class="comment"># 打标签</span></span><br><span class="line">gpg --list-keys <span class="comment"># 查找 GPG 公钥</span></span><br><span class="line">gpg -a --<span class="built_in">export</span> &lt;gpgkey&gt; | git <span class="built_in">hash</span>-object -w --stdin <span class="comment"># git hash-object 命令以 blob 对象形式在 git 中导入公钥，并返回该 blob 对象的 SHA-1 值。该 SHA-1 值可以用于发布标签，如 git tag -a &lt;tagname&gt; &lt;sha-1&gt;</span></span><br><span class="line">git show &lt;tagname&gt; | gpg --import <span class="comment"># 开发者获取并导入公钥，用于贡献代码</span></span><br><span class="line">git describe &lt;branch&gt; <span class="comment"># 生成构建号，包含最近的标签名、自该标签之后的提交数目和你所描述的提交的部分 SHA-1 值</span></span><br><span class="line">git archive master --prefix=<span class="string">'project/'</span> | gzip &gt; `git describe master`.tar.gz <span class="comment"># 创建 .tar.gz 压缩包</span></span><br><span class="line">git archive master --prefix=<span class="string">'project/'</span> --format=zip &gt; `git describe master`.zip <span class="comment"># 创建 .zip 压缩包</span></span><br><span class="line">git shortlog --no-merges master --not v1.0.1 <span class="comment"># 生成自 v1.0.1 版本发布以来所有提交的总结</span></span><br></pre></td></tr></table></figure>
<p>疑问：</p>
<ol>
<li>公共项目的发布问题？</li>
</ol>
<h2 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h2><p>github 钩子和服务订制、API，参见：<br><a href="https://git-scm.com/book/zh/v2/GitHub-脚本-GitHub" target="_blank" rel="noopener">https://git-scm.com/book/zh/v2/GitHub-脚本-GitHub</a><br><a href="https://developer.github.com" target="_blank" rel="noopener">https://developer.github.com</a></p>
<h2 id="Git-Tools"><a href="#Git-Tools" class="headerlink" title="Git Tools"></a>Git Tools</h2><h3 id="选取提交记录"><a href="#选取提交记录" class="headerlink" title="选取提交记录"></a>选取提交记录</h3><p>根据提交对象的 SHA-1 值查看提交记录。引用日志只在本地生成，不能通过远程交互被协作者拷贝。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> --abbrev-commit --pretty=oneline <span class="comment"># 获取简短且唯一的 SHA-1 值</span></span><br><span class="line">git show &lt;sha-1&gt;|&lt;branch&gt; <span class="comment"># 显示提交记录</span></span><br><span class="line">git rev-parse &lt;branch&gt; <span class="comment"># 获取最近一次提交的 SHA-1 值</span></span><br><span class="line">git reflog <span class="comment"># 查看引用日志，引用日志记录了最近几个月的 HEAD 和分支引用所指向的历史，包含提交对象的简短 SHA-1 值、HEAD 记录和提交信息</span></span><br><span class="line">git show HEAD@&#123;5&#125; <span class="comment"># 查看第五次提交记录</span></span><br><span class="line">git show &lt;branch&gt;@&#123;yesterday&#125; <span class="comment"># 查看 branch 分支昨天指向了哪个提交</span></span><br><span class="line">git show HEAD^ <span class="comment"># ^ 引用指上一次提交，HEAD^ 即上一次提交，HEAD^^ 即之前第二次提交</span></span><br><span class="line">git show &lt;sha-1&gt;^ <span class="comment"># 特定提交的上一次提交</span></span><br><span class="line">git show HEAD~ <span class="comment"># ~ 指父引用，~2 指之前第二次提交</span></span><br><span class="line">git show &lt;sha-1&gt;~num <span class="comment"># 特定提交前第 num 次提交</span></span><br><span class="line"></span><br><span class="line">git <span class="built_in">log</span> branch1..branch2 <span class="comment"># branch1..branch2 指在 branch2 分支中而不在 branch1 分支中的提交，branch2 留空，自动以 HEAD 填充，如 git log origin/master..HEAD 或 git log origin/master..。branch1..branch2可用于其他命令</span></span><br><span class="line">git <span class="built_in">log</span> refA refB ^refC <span class="comment"># 指定被 refA, refB 包含，但不被 refC 包含的提交记录</span></span><br><span class="line">git <span class="built_in">log</span> refA refB --not refC <span class="comment"># 同上</span></span><br><span class="line">git <span class="built_in">log</span> branch1...branch2 <span class="comment"># 选出不被两个分支同时包含的提交记录</span></span><br><span class="line">git <span class="built_in">log</span> --left-right branch1...branch2 <span class="comment"># 选出不被两个分支同时包含的提交记录，并显示提交对象属于 branch1 还是 branch2</span></span><br></pre></td></tr></table></figure>
<h3 id="交互式暂存"><a href="#交互式暂存" class="headerlink" title="交互式暂存"></a>交互式暂存</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git add -i|--interactive <span class="comment"># --interactive 选项用于开启交互式暂存命令行，执行后左侧显示已暂存的，右侧显示未暂存的；根据提示命令面板执行后续操作，如 1/status 显示状态, 2/update 提交到暂存区, 3/revert 从暂存区撤回, 4/add untracked 提交未追踪文件到暂存区, 5/patch 暂存补丁，可将部分修改提交到暂存区, 6/diff 查看已暂存内容的区别</span></span><br><span class="line">git add -p|--patch <span class="comment"># 暂存部分文件</span></span><br><span class="line">git reset --patch <span class="comment"># 部分重置文件</span></span><br><span class="line">git checkout --patch <span class="comment"># 部分检出文件</span></span><br><span class="line">git stash save --patch <span class="comment"># 部分暂存文件</span></span><br></pre></td></tr></table></figure>
<h3 id="储藏"><a href="#储藏" class="headerlink" title="储藏"></a>储藏</h3><p>通过 git stash 命令可以将工作区的改动储藏起来，却不是提交到暂存区；再使用 git stash apply 应用之前的储藏(可以在另一个分支上应用储藏；且当前分支做过修改后，仍可以应用储藏，必要时需解决冲突)。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">git stash <span class="comment"># 储藏工作区的改动，可用于切换分支前避免与远程代码的合并</span></span><br><span class="line">git stash save <span class="comment"># 同上</span></span><br><span class="line">git stash --keep-index <span class="comment"># 同上，--keep-index 选项将不储藏已使用 git add 暂存的内容</span></span><br><span class="line">git stash -u|--include-untracked <span class="comment"># 默认 git stash 不包含未追踪的文件，--include-untracked 选项将包含未追踪的文件</span></span><br><span class="line">git stash --patch <span class="comment"># 交互式地指引用户需要将那些改动储藏，那些改动保存在工作区</span></span><br><span class="line">git stash --all <span class="comment"># 移除修改，并储藏起来</span></span><br><span class="line">git stash list <span class="comment"># 查看所有储藏内容</span></span><br><span class="line">git stash apply <span class="comment"># 将储藏重新应用在工作分支上，默认为最近的储藏</span></span><br><span class="line">git stash apply stash@&#123;num&#125; <span class="comment"># 将第 num 次储藏应用在工作分支上，0 为最近的储藏</span></span><br><span class="line">git stash apply --index <span class="comment"># 应用储藏，同时应用暂存</span></span><br><span class="line">git stash branch &lt;branchname&gt; <span class="comment"># 创建一个新分支，检出储藏工作时所在的提交，重新在那应用工作，并扔掉储藏</span></span><br><span class="line">git stash drop stash@&#123;num&#125; <span class="comment"># 移除储藏</span></span><br><span class="line">git stash pop stash@&#123;num&#125; <span class="comment"># 应用并移除储藏</span></span><br></pre></td></tr></table></figure>
<h3 id="清理"><a href="#清理" class="headerlink" title="清理"></a>清理</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clean <span class="comment"># 从工作目录中移除未被追踪的文件</span></span><br><span class="line">git clean -f -d <span class="comment"># 强制移除工作目录中所有未追踪的文件以及空的子目录</span></span><br><span class="line">git clean -d -n <span class="comment"># 移除项预览</span></span><br><span class="line">git clean -n -d -x <span class="comment"># git clean 默认不移除 .gitignore 中匹配的文件，-x 选项将移除该类文件</span></span><br><span class="line">git clean -x -i|--interactive <span class="comment"># 交互式执行 clean 命令</span></span><br></pre></td></tr></table></figure>
<h3 id="签署标签"><a href="#签署标签" class="headerlink" title="签署标签"></a>签署标签</h3><p>参考：<a href="https://git-scm.com/book/zh/v2/Git-工具-签署工作" target="_blank" rel="noopener">https://git-scm.com/book/zh/v2/Git-工具-签署工作</a></p>
<h3 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git grep string/regexp <span class="comment"># 从提交历史或工作目录中查找匹配正则或字符串的内容，--and 选项用于设置更复杂字符串或正则匹配规则</span></span><br><span class="line">git grep string/regexp &lt;filepath&gt; &lt;version&gt; <span class="comment"># 指定文件或文件夹、版本号搜索</span></span><br><span class="line">git grep -n string/regexp <span class="comment"># 输出行号</span></span><br><span class="line">git grep -p string/regexp <span class="comment"># 查看匹配的行属于哪一个方法或函数</span></span><br><span class="line">git grep -count string/regexp <span class="comment"># 输出概要信息</span></span><br><span class="line">git grep --<span class="built_in">break</span> --heading string/regexp <span class="comment"># 使输出更易读</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志搜索</span></span><br><span class="line">git <span class="built_in">log</span> -string --oneline <span class="comment"># 从提交历史或 diff 内容中检索匹配字符串或正则的提交记录，-S 选项只查看新增和删除匹配内容的提交，-G 选项使用正则表达式检索</span></span><br><span class="line">git <span class="built_in">log</span> -L :string:filepath <span class="comment"># 行日志搜索，搜索特定文件中 string 变更的提交记录</span></span><br></pre></td></tr></table></figure>
<h3 id="重写历史"><a href="#重写历史" class="headerlink" title="重写历史"></a>重写历史</h3><p>git commit –amend 用于修改前一次提交。<br>git rebase -i 交互式修改多次提交记录，可拆分，可弃用，可合并，可重置等。须在本地环境中使用，提交到线上再调用变基，会使协作者变得不方便。<br>git filter-branch 使用脚本的方式改写大量提交记录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">git commit --amend <span class="comment"># 修改前一次提交记录，修改暂存区再执行该命令时可改变提交内容，否则只是改变提交信息</span></span><br><span class="line">git rebase -i HEAD~2^|HEAD~3 <span class="comment"># -i 选项开启交互式变基命令，将唤起编辑器，反序修改前三次提交，最后一次修改在前。因为之前的提交已提交，显示 p, pick 默认提交，修改为 r, reword 重写提交信息；e, edit 使用  git commit --amend 重置提交，可用于拆分提交；s, squash 将提交信息合并到之前执行 pick 命令的提交对象中，且将多次提交信息合并；f, fixup 同 squash，但丢弃提交信息，x, exec，唤起 shell 提交。弃用某次提交记录，可直接从 git rebase -i HEAD~2^|HEAD~3 显示的列表中删除</span></span><br><span class="line">git filter-branch --tree-filter <span class="string">'rm -f passwords.txt'</span> HEAD <span class="comment"># --tree-filter 选项在检出项目的每一个提交后运行指定的命令然后重新提交结果。--all 选项用于改写所有分支</span></span><br><span class="line">git filter-branch --subdirectory-filter trunk HEAD <span class="comment"># 让 trunk 子目录作为每一个提交的新的项目根目录</span></span><br><span class="line">git filter-branch --commit-filter <span class="string">'</span></span><br><span class="line"><span class="string">  if [ "$GIT_AUTHOR_EMAIL" = "schacon@localhost" ];</span></span><br><span class="line"><span class="string">  then</span></span><br><span class="line"><span class="string">    GIT_AUTHOR_NAME="Scott Chacon";</span></span><br><span class="line"><span class="string">    GIT_AUTHOR_EMAIL="schacon@example.com";</span></span><br><span class="line"><span class="string">    git commit-tree "$@";</span></span><br><span class="line"><span class="string">  else</span></span><br><span class="line"><span class="string">    git commit-tree "$@";</span></span><br><span class="line"><span class="string">  fi'</span> HEAD <span class="comment"># 修改多个项目的提交邮箱，且重写每个提交的校验和，不只匹配邮箱地址的提交</span></span><br></pre></td></tr></table></figure>
<h3 id="重置揭密"><a href="#重置揭密" class="headerlink" title="重置揭密"></a>重置揭密</h3><p>参考原理。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git cat-file -p HEAD <span class="comment"># 查看版本库当前提交信息</span></span><br><span class="line">git ls-tree -r HEAD <span class="comment"># 查看版本库中提交文件的 checksum 及其文件名</span></span><br><span class="line">git ls-files -s <span class="comment"># 查看暂存区中文件的 checksum 及其文件名</span></span><br><span class="line"></span><br><span class="line">git reset &lt;checksum&gt; <span class="comment"># 将版本库和暂存区内容替换为 checksum 指向的提交对象</span></span><br><span class="line">git reset --soft &lt;checksum&gt; <span class="comment"># 将版本库内容替换为 checksum 指向的提交对象</span></span><br><span class="line">git reset --mixed &lt;checksum&gt; <span class="comment"># 将版本库和暂存区内容替换为 checksum 指向的提交对象</span></span><br><span class="line">git reset --hard &lt;checksum&gt; <span class="comment"># 将版本库、暂存区和工作区内容替换为 checksum 指向的提交对象</span></span><br><span class="line">git reset &lt;filepath&gt; <span class="comment"># 从 HEAD 中获取 filepath 文件或目录，复制到暂存区</span></span><br><span class="line">git reset &lt;checksum&gt; &lt;filepath&gt; <span class="comment"># 从 checksum 中获取 filepath 文件或目录，复制到暂存区</span></span><br></pre></td></tr></table></figure>
<h3 id="高级合并"><a href="#高级合并" class="headerlink" title="高级合并"></a>高级合并</h3><p>合并前可以通过保存到临时分支或通过执行 git stash 命令储藏起来，避免合并对工作区的影响，使工作区内容丢失。</p>
<p>子树合并是项目某目录下包含一个子工程，同时 git 分支也包含一个从属于子工程的分支，从而引起子分支和子工程目录的合并操作。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">git merge --abort <span class="comment"># 退出合并，工作区内容恢复到合并前</span></span><br><span class="line">git reset --hard HEAD <span class="comment"># 退出合并，将版本库、暂存区和工作区内容重置到合并前</span></span><br><span class="line">git merge -Xignore-space-change <span class="comment"># 忽略任意数量的已有空白的修改</span></span><br><span class="line">git merge -Xignore-space-change <span class="comment"># 忽略所有空白修改</span></span><br><span class="line">git show :1:&lt;conflictFileName&gt; &gt; commonFileName <span class="comment"># 拷贝并导出冲突的共同祖先文件</span></span><br><span class="line">git show :2:&lt;conflictFileName&gt; &gt; oursFileName <span class="comment"># 拷贝并导出冲突的工作目录文件</span></span><br><span class="line">git show :3:&lt;conflictFileName&gt; &gt; theirsFileName <span class="comment"># 拷贝并导出冲突的待合并文件</span></span><br><span class="line">git ls-files -u <span class="comment"># 查看冲突文件的完整 SHA-1 值</span></span><br><span class="line">git merge-file -p \</span><br><span class="line">  oursFileName commonFileName theirsFileName &gt; fileName <span class="comment"># oursFileName, commonFileName, theirsFileName 拷贝的冲突文件手工解决冲突后，合并冲突文件</span></span><br><span class="line">git diff --ours <span class="comment"># 查看合并结果和当前工作分支的差别，-b 选项用于移除空格比较，--base 选项查看比较文件两边是如何改动的</span></span><br><span class="line">git diff --theirs <span class="comment"># 查看合并结果和待合并分支的差别</span></span><br><span class="line">git clean -f <span class="comment"># 清理为合并拷贝的文件，如 commonFileName 等</span></span><br><span class="line">git checkout --conflict=diff3 <span class="comment"># 查看工作分支、待合并分支、共同祖先分支的冲突文件</span></span><br><span class="line">git checkout --conflict=merge <span class="comment"># 默认，查看工作分支、待合并分支的冲突文件</span></span><br><span class="line">git checkout --ours <span class="comment"># 合并时使用当前工作分支文件内容</span></span><br><span class="line">git checkout --theirs <span class="comment"># 合并时使用待合并分支文件内容</span></span><br><span class="line">git <span class="built_in">log</span> --oneline --left-right branch1...branch2 <span class="comment"># 查看合并文件的提交记录来源</span></span><br><span class="line">git <span class="built_in">log</span> --oneline --left-right --merge <span class="comment"># 查看合并过程中，有冲突文件的提交记录来源</span></span><br><span class="line">git diff <span class="comment"># 查看冲突文件或冲突结果</span></span><br><span class="line">git <span class="built_in">log</span> --cc -p -1 <span class="comment"># 查看冲突结果</span></span><br><span class="line">git reset --hard HEAD~ <span class="comment"># 撤销合并，将版本库撤回到合并前状态</span></span><br><span class="line">git revert -m 1 basebranch <span class="comment"># 撤销合并，将提交对象撤回到 basebranch 分支内容。-m 1 标记指出 “mainline” 需要被保留下来的父结点。此时将无法合并待合并分支的内容</span></span><br><span class="line">git revert &lt;checksum&gt; <span class="comment"># 撤销 git revert -m 1 basebranch 命令</span></span><br><span class="line">git merge -Xours &lt;branch&gt; <span class="comment"># 选用当前工作分支内容进行合并</span></span><br><span class="line">git merge -Theirs &lt;branch&gt; <span class="comment"># 选用待合并分支内容进行合并</span></span><br><span class="line">git merge-file --ours &lt;filepath&gt; <span class="comment"># 选用当前工作分支内容进行合并</span></span><br><span class="line">git merge-file --theirs &lt;filepath&gt; <span class="comment"># 选用待合并分支内容进行合并</span></span><br><span class="line">git merge -s ours &lt;branch&gt; <span class="comment"># 假合并，直接将当前工作分支内容作为合并结果</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 子树合并</span></span><br><span class="line">git <span class="built_in">read</span>-tree --prefix=dirname/ -u sub_project_branch <span class="comment"># 将子工程分支的内容拷贝到 dirname 目录中</span></span><br><span class="line">git merge --squash -s recursive -Xsubtree=dirname sub_project_branch <span class="comment"># 将 sub_project_branch 分支内容合并到 dirname 目录中</span></span><br><span class="line">git diff-tree -p sub_project_branch <span class="comment"># 查看差异</span></span><br><span class="line">git diff-tree -p &lt;remote&gt;/&lt;branch&gt; <span class="comment"># 和远程引用相比较</span></span><br></pre></td></tr></table></figure>
<h3 id="rerere-命令"><a href="#rerere-命令" class="headerlink" title="rerere 命令"></a>rerere 命令</h3><p>通过 git config –global rerere.enabled true 命令开启 rerere 功能。rerere 记录冲突解决方案，自动解决冲突。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git config --global rerere.enabled <span class="literal">true</span> <span class="comment"># 开启 rerere 功能</span></span><br><span class="line">git rerere status <span class="comment"># 查看合并前的状态</span></span><br><span class="line">git rerere diff <span class="comment"># 查看解决前后的文件内容差异。冲突解决后，可查看 git rerere 将要记录的内容</span></span><br><span class="line">git ls-files -u <span class="comment"># 查看各冲突文件 checksum</span></span><br></pre></td></tr></table></figure>
<h3 id="使用-git-调试"><a href="#使用-git-调试" class="headerlink" title="使用 git 调试"></a>使用 git 调试</h3><p>使用 git blame 命令可以查看文件内容的历次更改，适用在确知某方法会引起 bug 的场景，可查看该方法的改动细节。</p>
<p>使用 git bisect 命令可以定位哪次提交引起了异常。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git blame -L startLine,endLine filepath <span class="comment"># 查看 filepath 文件自 startLine 起始、到 endLine 行结束的变更记录。-L 选项用于限制行号。-C 选项会分析拷贝之后再重命名文件的原始出处</span></span><br><span class="line"></span><br><span class="line">git bisect start <span class="comment"># 启动二分查找</span></span><br><span class="line">git bisect bad <span class="comment"># 告知 git 当前提交有问题</span></span><br><span class="line">git bisect good &lt;checksum&gt; <span class="comment"># 告知 git 将 checksum 指向的提交对象标记为好的。由 git 告知用户在正常提交和错误提交之间有多少次提交，二次查找中间那次提交，通过 git bisect bad 或 git bisect good 标记好坏。git 会自动定位到提交中点，再由用户判断提交结果的好坏</span></span><br><span class="line">git bisect reset <span class="comment"># 重置 HEAD 指针</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过执行脚本定位 bug 来源。checksum1 是坏的提交，checksum2 是好的提交</span></span><br><span class="line">git bisect start &lt;checksum1&gt;|HEAD &lt;checksum2&gt;</span><br><span class="line">git bisect run filepath</span><br></pre></td></tr></table></figure>
<h3 id="子模块"><a href="#子模块" class="headerlink" title="子模块"></a>子模块</h3><p>子模块虽然在工程目录中创建了子目录，但是若不在该子目录中，git 并不会跟踪子模块的文件内容，而是将它看作该仓库中的一个特殊提交。子模块提交时标记为 160000 模式，意味着将一次提交记作一项目录记录，而非将它记录成一个子目录或者一个文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">git submodule add &lt;remoteurl&gt; &lt;dirname&gt; <span class="comment"># 克隆远程仓库，以远程仓库名创建文件夹，或者自定义文件夹。同时会添加 .gitmodules 文件，用于保存本地目录和远程仓库地址</span></span><br><span class="line">git config submodule.&lt;dirname&gt;.url &lt;url&gt; <span class="comment"># 重设远程仓库地址</span></span><br><span class="line">git diff --cached --submodule <span class="comment"># 查看子模块的文件差异</span></span><br><span class="line">git submodule init <span class="comment"># 子模块初始化</span></span><br><span class="line">git submodule update <span class="comment"># 获取远程仓库数据，并检出父项目中属于子模块的提交</span></span><br><span class="line">git <span class="built_in">clone</span> --recursive mainurl <span class="comment"># mainurl 为父项目的 url，同时更新子模块</span></span><br><span class="line">git submodule update --remote subproject <span class="comment"># 在父项目工作目录中进行更新，避免手动进入子模块抓取和合并</span></span><br><span class="line">git submodule update --remote --merge <span class="comment"># 合并</span></span><br><span class="line">git submodule update --remote --rebase <span class="comment"># 变基</span></span><br><span class="line">git submodule update --init <span class="comment"># 初始化拉取远程内容</span></span><br><span class="line">git <span class="built_in">log</span> -p --submodule <span class="comment"># 查看子模块的提交日志</span></span><br><span class="line">git push --recurse-submodules=check <span class="comment"># 推送时校验子项目有否提交</span></span><br><span class="line">git push --recurse-submodules=on-demand <span class="comment"># 推送子模块，或者子项目中执行 git push 命令</span></span><br><span class="line">git submodule foreach <span class="string">'git stash'</span> <span class="comment"># 在所有子模块中运行 git stash 命令</span></span><br><span class="line">git rm -r &lt;dirname&gt; <span class="comment"># 从暂存区移除子项目目录</span></span><br><span class="line">rm -Rf &lt;dirname&gt; <span class="comment"># 移除子项目目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 子模块命令别名</span></span><br><span class="line">git config alias.sdiff <span class="string">'!'</span><span class="string">"git diff &amp;&amp; git submodule foreach 'git diff'"</span></span><br><span class="line">git config alias.spush <span class="string">'push --recurse-submodules=on-demand'</span></span><br><span class="line">git config alias.supdate <span class="string">'submodule update --remote --merge'</span></span><br></pre></td></tr></table></figure>
<h3 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git bundle create bundlefilename HEAD &lt;branch&gt; <span class="comment"># 将 branch 分支所有提交数据打包到 bundlefilename 文件中</span></span><br><span class="line">git bundle create bundlefilename &lt;branch&gt; ^&lt;checksum&gt; <span class="comment"># 设定提交区间，并打包文件。提交区间可以用 ... 等符号操作</span></span><br><span class="line">git <span class="built_in">clone</span> bundlefilename dirname <span class="comment"># 将打包文件解压到 dirname 目录中</span></span><br><span class="line">git bundle verify bundlefilename <span class="comment"># 校验打包文件是不是合法的 Git 包</span></span><br><span class="line">git bundle list-heads bundlefilename <span class="comment"># 查看打包文件包含哪些提交对象和分支</span></span><br><span class="line">git fetch bundlefilename branch:<span class="built_in">local</span>-branch <span class="comment"># 将打包文件中的分支导入本地工程中</span></span><br></pre></td></tr></table></figure>
<h3 id="替换"><a href="#替换" class="headerlink" title="替换"></a>替换</h3><p>大型项目可分成一个短历史提交记录和一个长历史提交记录，短历史供新的开发者使用，后者给喜欢数据挖掘的人使用。制作短历史提交记录通过 git commit-tree 命令合并提交记录，再通过 git rebase 命令将必要的提交变基到刚创建的合并提交记录上，就可以制作短历史提交记录。执行 git replace 命令，可以查看长历史提交记录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git branch &lt;branch&gt; &lt;checksum&gt; <span class="comment"># 以提交对象 checksum 创建分支 branch</span></span><br><span class="line">git push remote localbranch:remotebranch <span class="comment"># 将本地 localbranch 分支推送到远程仓库 remote 下的 remotebranch 分支</span></span><br><span class="line">git commit-tree &lt;checksum&gt;^&#123;tree&#125; <span class="comment"># 将 checksum 提交对象及其前的提交合并为新的提交对象，返回新提交对象的 SHA-1 </span></span><br><span class="line">git rebase --onto checksum1 checksum2 <span class="comment"># 将 checksum2 后的提交变基到 checksum1 上，checksum1 后产生新的提交记录</span></span><br><span class="line">git replace checksum1 checksum2 <span class="comment"># 将 checksum1 及其前的提交记录替换为 checksum2 及其前的提交记录</span></span><br><span class="line">git cat-file -p &lt;checksum&gt; <span class="comment"># 查看 checksum 提交的提交树 SHA-1 值及其父提交</span></span><br></pre></td></tr></table></figure>
<h3 id="凭证存储"><a href="#凭证存储" class="headerlink" title="凭证存储"></a>凭证存储</h3><p>使用 SSH 连接远端，且设置了一个没有口令的密钥，这样就可以在不用输入用户名和密码的情况下安全连接远端。使用 HTTP 存储，每一个连接都需要输入用户名和密码。git 凭证机制默认不存储用户名和密码，’cache’ 模式内存中暂时存储用户名和密码，’store’ 模式将用户名和密码存储在磁盘中，mac 下 ‘osxkeychain’ 以加密方式将凭证缓存到系统用户的钥匙串，windows 下可借助 ‘winstore’ 工具以加密方式将凭证存储在磁盘中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git config --global credential.helper cache|store <span class="comment"># 设置凭证存储模式</span></span><br><span class="line">git config --global credential.helper store --file &lt;path&gt; <span class="comment"># 设置存储目录</span></span><br><span class="line">git config --global credential.helper cache --timeout &lt;seconds&gt; <span class="comment"># 设置过期时间</span></span><br><span class="line">git credential fill <span class="comment"># 交互式设置凭证，通过 protocol/协议, host/主机名 设置</span></span><br></pre></td></tr></table></figure>
<h3 id="疑问-3"><a href="#疑问-3" class="headerlink" title="疑问"></a>疑问</h3><ol>
<li>获取某个特定的提交对象后，可否对该提交对象进行操作？</li>
<li>关于签署标签？</li>
<li>关于 git filter-branch？</li>
<li>关于子模块？</li>
</ol>
<h2 id="Customizing-Git"><a href="#Customizing-Git" class="headerlink" title="Customizing Git"></a>Customizing Git</h2><h3 id="自定义合并、比较工具"><a href="#自定义合并、比较工具" class="headerlink" title="自定义合并、比较工具"></a>自定义合并、比较工具</h3><p>借助 Perforce 图形化合并工具（P4Merge）来合并文件和解决冲突。</p>
<ol>
<li>下载 P4Merge。</li>
<li><p>创建一个名为 extMerge 的脚本包装 merge 命令，让它把参数转发给 p4merge 二进制文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /usr/local/bin/extMerge</span></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">/Applications/p4merge.app/Contents/MacOS/p4merge $*</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建一个名为 extDiff 的脚本包装 diff 命令，让它把参数转发给 p4merge 二进制文件。git 传递以下参数给 diff：path old-file old-hex old-mode new-file new-hex new-mode。实际仅需要 old-file 和 new-file 参数。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /usr/local/bin/extDiff</span></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">[ <span class="variable">$#</span> -eq 7 ] &amp;&amp; /usr/<span class="built_in">local</span>/bin/extMerge <span class="string">"<span class="variable">$2</span>"</span> <span class="string">"<span class="variable">$5</span>"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使 extMerge, extDiff 脚本拥有可执行权限。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /usr/<span class="built_in">local</span>/bin/extMerge</span><br><span class="line">sudo chmod +x /usr/<span class="built_in">local</span>/bin/extDiff</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置文件，自定义合并和比较文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git config --global merge.tool extMerge <span class="comment"># 通知 Git 该使用哪个合并工具</span></span><br><span class="line">git config --global mergetool.extMerge.cmd \</span><br><span class="line">  <span class="string">'extMerge \"$BASE\" \"$LOCAL\" \"$REMOTE\" \"$MERGED\"'</span> <span class="comment"># 规定命令运行的方式</span></span><br><span class="line">git config --global mergetool.extMerge.trustExitCode <span class="literal">false</span> <span class="comment"># 通知 Git 程序的返回值是否表示合并操作成功</span></span><br><span class="line">git config --global diff.external extDiff <span class="comment"># 通知 Git 该用什么命令做比较</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 git diff <checksum1> <checksum2> 命令，将自动唤起 P4Merge 图形化工具。</checksum2></checksum1></p>
</li>
<li>使用 git mergetool 命令，将自动唤起 P4Merge 图形化工具。</li>
</ol>
<h3 id="git-属性"><a href="#git-属性" class="headerlink" title="git 属性"></a>git 属性</h3><p>通过 .gitattributes 文件或 .git/info/attributes 文件设置属性，可用于识别二进制文件、比较二进制文件。</p>
<h4 id="识别二进制文件"><a href="#识别二进制文件" class="headerlink" title="识别二进制文件"></a>识别二进制文件</h4><p>只需配置 .gitattributes 文件。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*.pbxproj binary <span class="comment"># 将 pbxproj 识别为二进制文件，git 将不会对其修改，如 CRLF 问题</span></span><br></pre></td></tr></table></figure></p>
<h4 id="比较-word-文件"><a href="#比较-word-文件" class="headerlink" title="比较 word 文件"></a>比较 word 文件</h4><p>比较二进制 Microsoft Word 文件步骤：</p>
<ol>
<li>下载 docx2txt。</li>
<li><p>编写可执行脚本，即 docx2txt 文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">docx2txt.pl <span class="variable">$1</span> -</span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑配置。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config diff.word.textconv docx2txt</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置 .gitattributes 文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*.docx diff=word <span class="comment"># 使用 “word” 过滤器，即借助 docx2txt 程序将 Word 文档转为可读文本文件</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="比较图像文件"><a href="#比较图像文件" class="headerlink" title="比较图像文件"></a>比较图像文件</h4><p>在比较时对图像文件运用一个过滤器(如 exiftool)，提炼出 EXIF 信息——这是在大部分图像格式中都有记录的一种元数据。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'*.png diff=exif'</span> &gt;&gt; .gitattributes</span><br><span class="line">git config diff.exif.textconv exiftool</span><br></pre></td></tr></table></figure>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">test</span>/ <span class="built_in">export</span>-ignore <span class="comment"># .gitattributes 文件中设置不必导出的文件或文件夹</span></span><br><span class="line">LAST_COMMIT <span class="built_in">export</span>-subst <span class="comment"># 设置 LAST_COMMIT 文件用于接受提交记录，git commit 提交后，执行 git archive 命令，将提交记录导出到 LAST_COMMIT 文件中。LAST_COMMIT 文件内容如 'Last commit date: $Format:%cd by %aN$'</span></span><br><span class="line">database.xml merge=ours <span class="comment"># 设置合并策略，采用工作目录中的文件</span></span><br></pre></td></tr></table></figure>
<h3 id="git-钩子"><a href="#git-钩子" class="headerlink" title="git 钩子"></a>git 钩子</h3><p>git 钩子放置在 .git/hooks 子目录中。git init 初始化项目时有示例，可以用 Ruby 或 Python 编程。</p>
<h4 id="客户端钩子"><a href="#客户端钩子" class="headerlink" title="客户端钩子"></a>客户端钩子</h4><p>克隆远程仓库时不被复制。</p>
<ol>
<li>pre-commit 钩子在键入提交信息前运行。使用 git commit –no-verify 来绕过这个环节。</li>
<li>prepare-commit-msg 钩子在启动提交信息编辑器之前，默认信息被创建之后运行。</li>
<li>commit-msg 钩子在编辑器退出后运行。</li>
<li>post-commit 钩子在整个提交过程完成后运行。</li>
<li>applypatch-msg 钩子在应用补丁之前运行，git am 命令执行。</li>
<li>pre-applypatch 钩子在应用补丁之后、产生提交之前运行，git am 命令执行。</li>
<li>post-applypatch 钩子在提交产生之后运行，git am 命令执行。</li>
<li>pre-rebase 钩子在变基之前运行。</li>
<li>post-rewrite 钩子被那些会替换提交记录的命令调用，比如 git commit –amend 和 git rebase 命令。</li>
<li>post-checkout 钩子在检出之后运行。</li>
<li>post-merge 钩子在合并之后运行。</li>
<li>pre-push 钩子在推送之前运行。</li>
<li>re-auto-gc 钩子会在垃圾回收开始之前被调用。git 的一些日常操作在运行时，偶尔会调用 git gc –auto 进行垃圾回收。</li>
</ol>
<h4 id="服务器端钩子"><a href="#服务器端钩子" class="headerlink" title="服务器端钩子"></a>服务器端钩子</h4><ol>
<li>pre-receive 钩子在推送过程运行，同时向多个分支推送的情形下也只触发一次。</li>
<li>update 钩子在推送过程运行，同时向多个分支推送的情形下触发多次。</li>
<li>post-receive 钩子在整个过程完结以后运行，可以用来更新其他系统服务或者通知用户。它的用途包括给某个邮件列表发信，通知持续集成（continous integration）的服务器，或者更新问题追踪系统（ticket-tracking system） —— 甚至可以通过分析提交信息来决定某个问题（ticket）是否应该被开启，修改或者关闭。</li>
</ol>
<h3 id="疑问-4"><a href="#疑问-4" class="headerlink" title="疑问"></a>疑问</h3><ol>
<li>文件检出和暂存时设置过滤器，参考<a href="https://git-scm.com/book/zh/v2/自定义-Git-Git-属性" target="_blank" rel="noopener">git 属性</a>？</li>
<li>使用钩子，参考<a href="https://git-scm.com/book/zh/v2/自定义-Git-使用强制策略的一个例子" target="_blank" rel="noopener">使用强制策略的一个例子</a></li>
</ol>
<h2 id="Git-Internals"><a href="#Git-Internals" class="headerlink" title="Git Internals"></a>Git Internals</h2><p>从根本上来讲 git 是一个内容寻址（content-addressable）文件系统，并在此之上提供了一个版本控制系统的用户界面。</p>
<p>.git 目录包含：description 文件仅供 GitWeb 程序使用；config 文件包含项目特有的配置选项；info 目录包含一个全局性排除文件；hooks 目录包含客户端或服务端的钩子脚本；objects 目录存储所有数据内容；refs 目录存储指向数据（分支）的提交对象的指针；HEAD 文件指示目前被检出的分支；index 文件保存暂存区信息。</p>
<h3 id="git-对象"><a href="#git-对象" class="headerlink" title="git 对象"></a>git 对象</h3><p>git 是一个内容寻址文件系统。这意味着，git 的核心部分是一个简单的键值对数据库（key-value data store）。 你可以向该数据库插入任意类型的内容，它会返回一个键值，通过该键值可以在任意时刻再次检索（retrieve）该内容。 通过底层命令 hash-object 可将任意数据保存于 .git 目录，并返回相应的键值。在 git 中，文件内容存储为数据对象/blob object，文件目录存储为树对象/tree object。一个树对象包含了一条或多条树对象记录（tree entry），每条记录含有一个指向数据对象或者子树对象的 SHA-1 指针，以及相应的模式、类型、文件名信息。</p>
<p>通常，Git 根据某一时刻暂存区所表示的状态创建并记录一个对应的树对象。所以创建树对象时，先须把文件写入暂存区，以此获得树对象的校验和。但是，树对象的校验和不便于记忆，即不便于获取该树对象。在 git 中，使用提交对象定位树对象，以及该树对象的创建时间，即通过提交对象的校验和获取或存储树对象。提交对象的格式为，先指定一个顶层树对象，代表当前项目快照；然后是作者/提交者信息（依据 user.name 和 user.email 配置来设定，外加一个时间戳）；留空一行，最后是提交注释。</p>
<p>运行 git add 和 git commit 命令时，git 所做的实质工作——将被改写的文件保存为数据对象，更新暂存区，记录树对象，最后创建一个指明了顶层树对象和父提交的提交对象。数据对象、树对象和提交对象最初均以单独文件的形式保存在 .git/objects 目录下（首先转换为带有如 “blob #{content.length}\0” 等头部信息的内存数据，其次计算校验和，最后再写入 .git/objects 目录下）。</p>
<p>在存储文件对象时，为避免同一文件的不同版本保存多份，git 使用包文件存储，即保存最新版本的完整数据，其他版本保存与最新版本的差异。使用 git gc 命令可执行打包过程；git verify-pack 命令查看打包的内容。自动打包过程发生在 push 命令触发或本地包含太多不同版本的文件，大约需要 7000 个以上的松散对象或超过 50 个的包文件才能让 git 启动一次真正的 gc 命令（可通过修改 gc.auto 与 gc.autopacklimit 的设置来改动这些数值）。打包后，.git/refs 目录将清空，相应创建 .git/packed-refs 目录；更新引用时，再相应创建 .git/refs 目录下文件；查找分支引用先从 .git/refs 目录找起，其次 .git/packed-refs 目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'test content'</span> | git <span class="built_in">hash</span>-object -w --stdin <span class="comment"># 写入数据。-w 选项指示 hash-object 命令存储数据对象；若不指定此选项，则该命令仅返回对应的键值； --stdin 选项则指示该命令从标准输入读取内容；若不指定此选项，则须在命令尾部给出待存储文件的路径。返回40位校验和，以前两位作为目录名，后38位作为文件名，存储在 .git/objects 目录中</span></span><br><span class="line">git <span class="built_in">hash</span>-object -w test.txt <span class="comment"># 写入数据</span></span><br><span class="line">git cat-file -p &lt;checksum&gt; <span class="comment"># 读取数据</span></span><br><span class="line">find .git/objects -<span class="built_in">type</span> f <span class="comment"># 查看 .git/objects 目录下文件列表</span></span><br><span class="line">git cat-file -p &lt;checksum&gt; &gt; &lt;filepath&gt; <span class="comment"># 将 .git/objects 目录下存储的某条数据导出到 filepath 文件中</span></span><br><span class="line">git cat-file -t &lt;checksum&gt; <span class="comment"># 查看 git 存储数据的对象类型，如返回 blob 或 tree</span></span><br><span class="line"></span><br><span class="line">git cat-file -p master^&#123;tree&#125; <span class="comment"># 查看树对象 master^&#123;tree&#125; 下的内容，可能包含 blob 或 tree 对象。master^&#123;tree&#125; 表示 master 分支上最新的提交所指向的树对象</span></span><br><span class="line">git cat-file -p &lt;checksum&gt; <span class="comment"># 查看树对象、提交对象下的内容，将获取最新版本的文件内容</span></span><br><span class="line">git update-index --add --cacheinfo 100644 \</span><br><span class="line">  83baae61804e65cc73a7201a7252750c76066a30 test.txt <span class="comment"># 通过 update-index 命令为 test.txt 文件创建暂存区，选项 --add 将文件存储到暂存区中；选项 --cacheinfo 将文件添加到 git 数据库，而非当前目录中；文件模式 100644 表示为普通文件，100755 为可执行文件，120000 为符号链接</span></span><br><span class="line">git update-index &lt;filepath&gt; <span class="comment"># 更新暂存区中文件</span></span><br><span class="line">git update-index --add &lt;filepath&gt; <span class="comment"># 添加暂存区中文件</span></span><br><span class="line">git write-tree <span class="comment"># 将暂存区内容写入树对象，返回树对象的 SHA-1 值</span></span><br><span class="line">git <span class="built_in">read</span>-tree &lt;checksum&gt; <span class="comment"># 将树对象读入暂存区</span></span><br><span class="line">git <span class="built_in">read</span>-tree --prefix=dirname &lt;checksum&gt; <span class="comment"># 将树对象读入暂存区，--prefix 选项将其作为子树存储在 dirname 目录下</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'first commit'</span> | git commit-tree &lt;checksum&gt; <span class="comment"># 以树对象 checksum 创建提交对象，返回提交对象的校验和。创建的提交对象可通过 git log 查看</span></span><br></pre></td></tr></table></figure>
<h3 id="git-引用"><a href="#git-引用" class="headerlink" title="git 引用"></a>git 引用</h3><p>git 通过 .git/refs 目录下的文件存储提交对象的引用，以分支形式分类存储，不同分支创建不同的文件，同一文件下包含该分支的提交记录历史。</p>
<p>HEAD 引用通过 .git/HEAD 文件存储，文件内容如 ref: refs/heads/master，指向其他分支引用。</p>
<p>标签对象（tag object）非常类似于一个提交对象——它包含标签创建者信息、日期、注释信息，以及一个指针。 主要的区别在于，标签对象通常指向一个提交对象，而不是一个树对象。它像是一个永不移动的分支引用——永远指向同一个提交对象，分支引用指向的提交对象可以改写。所以标签对象可用于发布。另外要注意的是，标签对象并非必须指向某个提交对象；你可以对任意类型的 Git 对象打标签。标签对象存储在 .git/refs/tags 目录中，以标签名作为文件名。</p>
<p>.git/refs/remotes 目录下保存远程引用。远程引用和分支引用的主要区别在于，远程引用是只读的。虽然可以 git checkout 到某个远程引用，但是 git 并不会将 HEAD 引用指向该远程引用。因此，永远不能通过 commit 命令来更新远程引用，而只能通过 push 命令更新。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git update-ref refs/heads/master 1a410efbd13591db07496601ebc7a059dd55cfe9 <span class="comment"># 在 master 分支中添加提交对象的校验和，比直接编辑文件更安全</span></span><br><span class="line">git symbolic-ref HEAD <span class="comment"># 查看 .git/HEAD 文件内容</span></span><br><span class="line">git symbolic-ref HEAD refs/heads/<span class="built_in">test</span> <span class="comment"># 修改 HEAD 引用的指向</span></span><br><span class="line">git update-ref refs/tags/v1.0 cac0cab538b970a37ea1e769cbbde608743bc96d <span class="comment"># 创建轻量标签</span></span><br><span class="line">git tag -a v1.1 1a410efbd13591db07496601ebc7a059dd55cfe9 -m <span class="string">'test tag'</span> <span class="comment"># -a 选项用于创建附注标签</span></span><br></pre></td></tr></table></figure>
<h3 id="引用规格"><a href="#引用规格" class="headerlink" title="引用规格"></a>引用规格</h3><p>引用规格/refspec 用于设定 fetch 命令的请求地址和拉取的分支，以小节形式存储在 .git/config 文件中。引用规格的格式由一个可选的 + 号和紧随其后的 <src>:<dst> 组成，其中 <src> 是一个模式（pattern），代表远程版本库中的引用；<dst> 是那些远程引用在本地所对应的位置。 + 号告诉 Git 即使在不能快进的情况下也要（强制）更新引用。</dst></src></dst></src></p>
<p>执行 git remote add origin <a href="https://github.com/schacon/simplegit-progit" target="_blank" rel="noopener">https://github.com/schacon/simplegit-progit</a> 命令，.git/config 文件将添加引用规格如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[remote <span class="string">"origin"</span>]</span><br><span class="line">	url = https://github.com/schacon/simplegit-progit</span><br><span class="line">	fetch = +refs/heads/*:refs/remotes/origin/* <span class="comment"># 当修改为 fetch = +refs/heads/master:refs/remotes/origin/master 时，将只抓取远程 master 分支（fetch 可以设置多个，以拉取不同分支的引用）；或者单次执行 git fetch origin master:refs/remotes/origin/mymaster 命令，将远程 master 分支拉到本地的 origin/mymaster 分支</span></span><br><span class="line">  <span class="comment"># push = refs/heads/master:refs/heads/qa/master 用于设置推送，或执行 git push origin master:refs/heads/qa/master 命令</span></span><br></pre></td></tr></table></figure></p>
<p>执行 git push origin :topic 命令可删除远程 topic 分支，因为 src 为空值，即代表删除。</p>
<h3 id="数据恢复"><a href="#数据恢复" class="headerlink" title="数据恢复"></a>数据恢复</h3><p>引用日志/reflog 记录每一次你改变 HEAD 时它的值。每一次提交或改变分支时，引用日志都会被更新。引用日志也可以通过 git update-ref 命令更新。git reflog 命令用于查看引用日志。引用日志存放在 .git/logs/ 目录中。</p>
<p>引用日志可用于找回丢失的提交，如 reset, rebase 命令导致丢失。通过 git branch <branch> <checksum> 命令创建新分支指向丢失的提交。</checksum></branch></p>
<p>当引用日志也同样丢失时，可以使用 git fsck –full 查看没有被引用的提交对象，即丢失的提交对象。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git reflog <span class="comment"># 查看引用日志</span></span><br><span class="line">git <span class="built_in">log</span> -g <span class="comment"># 以标准日志格式查看引用日志</span></span><br><span class="line">git count-objects -v <span class="comment"># 查看内存占用，size-pack 指以 kb 为大小的包文件</span></span><br></pre></td></tr></table></figure>
<h3 id="疑问："><a href="#疑问：" class="headerlink" title="疑问："></a>疑问：</h3><ol>
<li>git 的远程交互机制，参考<a href="https://git-scm.com/book/zh/v2/Git-内部原理-传输协议" target="_blank" rel="noopener">传输协议</a></li>
<li>移除git 数据库中的历史文件，参考<a href="https://git-scm.com/book/zh/v2/Git-内部原理-维护与数据恢复" target="_blank" rel="noopener">维护与数据恢复</a></li>
<li>git 环境变量，参考<a href="https://git-scm.com/book/zh/v2/Git-内部原理-环境变量" target="_blank" rel="noopener">环境变量</a></li>
</ol>
<p>参考：<br><a href="https://git-scm.com/book/zh/v2" target="_blank" rel="noopener">https://git-scm.com/book/zh/v2</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/13/手册/mocha使用指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/13/手册/mocha使用指南/" itemprop="url">mocha使用指南</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-13T18:50:11+08:00">2018-02-13</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端工程化/" itemprop="url" rel="index"><span itemprop="name">前端工程化</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/13/手册/mocha使用指南/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/02/13/手册/mocha使用指南/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>mocha 是一款可运行在 node 环境或浏览器上的测试框架。</p>
<p>mocha 本身没有实现断言库，可使用 chai, should.js, expect.js, better-assert, unexpected 等断言库或 node 内置的 assert 模块。断言库错误输出需有 actual, expected 属性。</p>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><h3 id="BDD"><a href="#BDD" class="headerlink" title="BDD"></a>BDD</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BDD 风格，describe/context, it/specify, before, after, beforeEach, afterEach</span></span><br><span class="line"><span class="keyword">var</span> assert = <span class="built_in">require</span>(<span class="string">'assert'</span>);</span><br><span class="line">describe(<span class="string">'Array'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;<span class="comment">// 测试套件</span></span><br><span class="line">  describe(<span class="string">'#indexOf()'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    it(<span class="string">'should return -1 when the value is not present'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;<span class="comment">// 测试单元</span></span><br><span class="line">      assert.equal([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>].indexOf(<span class="number">4</span>), <span class="number">-1</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="TDD"><a href="#TDD" class="headerlink" title="TDD"></a>TDD</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TDD 风格，suite, test, suiteSetup, suiteTeardown, setup, teardown</span></span><br><span class="line">suite(<span class="string">'Array'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  setup(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  suite(<span class="string">'#indexOf()'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    test(<span class="string">'should return -1 when not present'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      assert.equal(<span class="number">-1</span>, [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>].indexOf(<span class="number">4</span>));</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="EXPORTS"><a href="#EXPORTS" class="headerlink" title="EXPORTS"></a>EXPORTS</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// EXPORTS 风格，before, after, beforeEach, afterEach</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  before: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="string">'Array'</span>: &#123;<span class="comment">// 对象作为测试套件</span></span><br><span class="line">    <span class="string">'#indexOf()'</span>: &#123;</span><br><span class="line">      <span class="string">'should return -1 when not present'</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;<span class="comment">// 函数为测试单元</span></span><br><span class="line">        [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>].indexOf(<span class="number">4</span>).should.equal(<span class="number">-1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="QUNIT"><a href="#QUNIT" class="headerlink" title="QUNIT"></a>QUNIT</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// QUNIT 风格，suite, test, before, after, beforeEach, afterEach</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ok</span>(<span class="params">expr, msg</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!expr) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">suite(<span class="string">'Array'</span>);</span><br><span class="line"></span><br><span class="line">test(<span class="string">'#length'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> arr = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line">  ok(arr.length == <span class="number">3</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">test(<span class="string">'#indexOf()'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> arr = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line">  ok(arr.indexOf(<span class="number">1</span>) == <span class="number">0</span>);</span><br><span class="line">  ok(arr.indexOf(<span class="number">2</span>) == <span class="number">1</span>);</span><br><span class="line">  ok(arr.indexOf(<span class="number">3</span>) == <span class="number">2</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">suite(<span class="string">'String'</span>);</span><br><span class="line"></span><br><span class="line">test(<span class="string">'#length'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  ok(<span class="string">'foo'</span>.length == <span class="number">3</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="REQUIRE"><a href="#REQUIRE" class="headerlink" title="REQUIRE"></a>REQUIRE</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// REQUIRE 风格，使用 require 注入</span></span><br><span class="line"><span class="keyword">var</span> testCase = <span class="built_in">require</span>(<span class="string">'mocha'</span>).describe;</span><br><span class="line"><span class="keyword">var</span> pre = <span class="built_in">require</span>(<span class="string">'mocha'</span>).before;</span><br><span class="line"><span class="keyword">var</span> assertions = <span class="built_in">require</span>(<span class="string">'mocha'</span>).it;</span><br><span class="line"><span class="keyword">var</span> assert = <span class="built_in">require</span>(<span class="string">'chai'</span>).assert;</span><br><span class="line"></span><br><span class="line">testCase(<span class="string">'Array'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  pre(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  testCase(<span class="string">'#indexOf()'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    assertions(<span class="string">'should return -1 when not present'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      assert.equal([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>].indexOf(<span class="number">4</span>), <span class="number">-1</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>mocha 后跟测试文件名（可使用通配符），或将测试脚本放在 test 目录里，执行 mocha 命令测试 test 目录下的测试脚本（默认只执行第一层）。浏览器端使用 mocha.setup 方法配置 mocha。</p>
<p>选项（可以将命令行参数放在 mocha.opts 文件里，也可以 mocha.opts 文件里指定测试目录）：</p>
<ul>
<li>-u, –ui <name> 测试脚本编码风格，可选值 bdd|tdd|qunit|exports。</name></li>
<li>–recursive 使用 mocha 测试 test 目录下所有文件。</li>
<li>-g, –grep <pattern> 只测试匹配正则的 it 。</pattern></li>
<li>-f, –fgrep <string> 只测试包含字符串的 it。</string></li>
<li>-i, –invert 反转 grep, fgrep 选项。</li>
<li>–bail, -b 有一个测试脚本未通过时，就停止测试。</li>
<li>-d, –debug 启动 debug 模式。</li>
<li>–debug-brk enable node’s debugger breaking on the first line???</li>
<li>-gc, –expose-gc expose gc extension???</li>
<li>–harmony&lt;_classes,_generators,…&gt; all node –harmony* flags are available???</li>
<li>–es_staging 启用所有 staged 特征???</li>
<li>-S, –sort 排序测试文件。</li>
<li>–compilers <ext>:<module>,… 指定测编译器，如 mocha –compilers js:babel-core/register。若需使用 Map、Set 等，须在测试脚本前 import ‘babel-polyfill’。</module></ext></li>
<li>-r, –require <name> 加载特定的模块，如 ‘babel-polyfill’。</name></li>
<li>–file <file> 测试时加载指定文件。</file></li>
<li>–globals <names> 以 ‘,’ 分割形式注入全局变量。</names></li>
<li>-A, –async-only 测试脚本只能使用异步编程，回调或 promise 形式。</li>
<li>-w, –watch 监视文件变动，自动运行测试脚本。</li>
<li>-t, –timeout <ms> 指定测试时的超时时间，默认为 2000 ms。</ms></li>
<li>-s, –slow <ms> 高亮显示超过指定时间的测试报告，默认为 75 ms。</ms></li>
<li>–check-leaks 检测全局变量泄漏。</li>
<li>–growl, -G 将报告显示在桌面。</li>
<li>-R, –reporter <name> 指定报告打印形式，默认是 spec 格式，可选值 tap, dot, nyan, mochawesome 网页报告（须先安装 npm install –dev mochawesome）。</name></li>
<li>-O, –reporter-options &lt;k=v,k2=v2,…&gt;，打印选项。</li>
<li>–reporters 显示所有报告格式。</li>
<li>-c, –colors 显示颜色。</li>
<li>-C, –no-colors 不显示颜色。</li>
<li>–full-trace 显示完整的堆栈信息。</li>
<li>生成规格文件，如 mocha –recursive -R markdown &gt; spec.md 或 mocha –recursive -R doc &gt; spec.html。<br>…</li>
</ul>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><h3 id="钩子函数"><a href="#钩子函数" class="headerlink" title="钩子函数"></a>钩子函数</h3><ul>
<li>before，在测试用例之前执行</li>
<li>after，在测试用例之后执行</li>
<li>beforeEach，在每个单元测试前执行</li>
<li>afterEach，在每个单元测试后执行</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 钩子允许在 describe 外围，回调将在测试脚本之前或之后执行</span></span><br><span class="line">beforeEach(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'before every test in every file'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'hooks'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 钩子函数以匿名函数使用，允许携带描述；命名函数不能</span></span><br><span class="line">  before(<span class="string">'some description'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// runs before all tests in this block</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 钩子支持同步或异步编程</span></span><br><span class="line">  beforeEach(<span class="function"><span class="keyword">function</span>(<span class="params">done</span>) </span>&#123;</span><br><span class="line">    db.clear(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (err) <span class="keyword">return</span> done(err);</span><br><span class="line">      db.save([tobi, loki, jane], done);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// test cases</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="异步测试"><a href="#异步测试" class="headerlink" title="异步测试"></a>异步测试</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 回调函数形式</span></span><br><span class="line">describe(<span class="string">'User'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  describe(<span class="string">'#save()'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    it(<span class="string">'should save without error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">done</span>) </span>&#123;<span class="comment">// done 只能执行一次，两次及以上会报错</span></span><br><span class="line">      <span class="keyword">var</span> user = <span class="keyword">new</span> User(<span class="string">'Luna'</span>);</span><br><span class="line">      user.save(done);<span class="comment">// done 能自动识别并处理 err 错误</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// promise 形式</span></span><br><span class="line">describe(<span class="string">'#find()'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  it(<span class="string">'respond with matching records'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// db.find(&#123; type: 'User' &#125;) 返回 promise</span></span><br><span class="line">    <span class="keyword">return</span> db.find(&#123; <span class="attr">type</span>: <span class="string">'User'</span> &#125;).should.eventually.have.length(<span class="number">3</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// async 函数形式</span></span><br><span class="line">describe(<span class="string">'#find()'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  it(<span class="string">'responds with matching records'</span>, <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> users = <span class="keyword">await</span> db.find(&#123; <span class="attr">type</span>: <span class="string">'User'</span> &#125;);</span><br><span class="line">    users.should.have.length(<span class="number">3</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="延迟执行"><a href="#延迟执行" class="headerlink" title="延迟执行"></a>延迟执行</h3><p>命令行选项 –delay 用于延迟，相应测试脚本使用 setTimeout 包裹。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// do some setup</span></span><br><span class="line"></span><br><span class="line">  describe(<span class="string">'my suite'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  run();</span><br><span class="line">&#125;, <span class="number">5000</span>);</span><br></pre></td></tr></table></figure>
<h3 id="搁置测试"><a href="#搁置测试" class="headerlink" title="搁置测试"></a>搁置测试</h3><p>使测试处于 pending 状态，仍然会打印报告。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">'Array'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  describe(<span class="string">'#indexOf()'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// pending test below</span></span><br><span class="line">    it(<span class="string">'should return -1 when the value is not present'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="限制测试"><a href="#限制测试" class="headerlink" title="限制测试"></a>限制测试</h3><ul>
<li>describe, it 调用 only 方法将只运行指定测试脚本，添加的钩子仍会执行。</li>
<li>describe, it 调用 skip 方法将避免某些脚本的执行。skip 也可以在 mocha 运行过程中调用，或在钩子中调用，两者均使用 this.skip()。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// only 方法限制只执行某些测试脚本</span></span><br><span class="line">describe(<span class="string">'Array'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  describe.only(<span class="string">'#indexOf()'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    it.only(<span class="string">'should return -1 unless present'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// this test will be run</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    it(<span class="string">'should return the index when present'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// this test will not be run</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// skip 方法跳过执行指定测试脚本</span></span><br><span class="line">describe(<span class="string">'Array'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  describe(<span class="string">'#indexOf()'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    it.skip(<span class="string">'should return -1 unless present'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// this test will not be run</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    it(<span class="string">'should return the index when present'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// this test will be run</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// mocha 运行时 skip</span></span><br><span class="line">it(<span class="string">'should only test in the correct environment'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="comment">/* check test environment */</span>) &#123;</span><br><span class="line">    <span class="comment">// make assertions</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.skip();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 钩子 skip</span></span><br><span class="line">before(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="comment">/* check test environment */</span>) &#123;</span><br><span class="line">    <span class="comment">// setup code</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.skip();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="实例方法"><a href="#实例方法" class="headerlink" title="实例方法"></a>实例方法</h3><ul>
<li>retries(num)，指定重复执行测试脚本 num 次，不推荐在单元测试中使用。</li>
<li>slow(time)，高亮显示超过指定时间的测试报告，默认为 75 ms。</li>
<li>timeout(time)，设定超时时间，可在 describe, it 或钩子 中调用。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// retries</span></span><br><span class="line">describe(<span class="string">'retries'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Retry all tests in this suite up to 4 times</span></span><br><span class="line">  <span class="keyword">this</span>.retries(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">  beforeEach(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    browser.get(<span class="string">'http://www.yahoo.com'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'should succeed on the 3rd try'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Specify this test to only retry up to 2 times</span></span><br><span class="line">    <span class="keyword">this</span>.retries(<span class="number">2</span>);</span><br><span class="line">    expect($(<span class="string">'.foo'</span>).isDisplayed()).to.eventually.be.true;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// slow</span></span><br><span class="line">describe(<span class="string">'something slow'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.slow(<span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'should take long enough for me to go make a sandwich'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// timeout</span></span><br><span class="line">describe(<span class="string">'a suite of tests'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.timeout(<span class="number">500</span>);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'should take less than 500ms'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">done</span>)</span>&#123;</span><br><span class="line">    setTimeout(done, <span class="number">300</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'should take less than 500ms as well'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">done</span>)</span>&#123;</span><br><span class="line">    setTimeout(done, <span class="number">250</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/12/手册/chai使用指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/12/手册/chai使用指南/" itemprop="url">chai使用指南</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-12T19:12:35+08:00">2018-02-12</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端工程化/" itemprop="url" rel="index"><span itemprop="name">前端工程化</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/12/手册/chai使用指南/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/02/12/手册/chai使用指南/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>chai 是一款辅助 TDD 测试驱动开发, BDD 行为驱动开发 的断言库。</p>
<p>有关 TDD 和 BDD，可参考：<br><a href="https://www.cnblogs.com/Leo_wl/p/4780678.html" target="_blank" rel="noopener">开发人员看测试之TDD和BDD</a><br><a href="http://blog.jobbole.com/110560/" target="_blank" rel="noopener">TDD 已死？让我们再聊聊 TDD</a><br><a href="http://blog.csdn.net/dc_726/article/details/49688379" target="_blank" rel="noopener">BDD敏捷开发入门与实战</a></p>
<p>chai 的 TDD 模块只包含 assert 一种， BDD 模块包含 except, should 两种。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><ul>
<li>chai.config.includeStack = false，错误输出中是否包含堆栈信息</li>
<li>chai.config.showDiff = true，是否显示 diff</li>
<li>chai.config.truncateThreshold = 40，错误输出中 actual, expexted 打印字符串上限???</li>
</ul>
<h2 id="api手册"><a href="#api手册" class="headerlink" title="api手册"></a>api手册</h2><h3 id="TDD测试"><a href="#TDD测试" class="headerlink" title="TDD测试"></a>TDD测试</h3><h4 id="assert"><a href="#assert" class="headerlink" title="assert"></a>assert</h4><p>类似 node 的同名模块。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> assert = <span class="built_in">require</span>(<span class="string">'chai'</span>).assert</span><br><span class="line">  , foo = <span class="string">'bar'</span></span><br><span class="line">  , beverages = &#123; <span class="attr">tea</span>: [ <span class="string">'chai'</span>, <span class="string">'matcha'</span>, <span class="string">'oolong'</span> ] &#125;;</span><br><span class="line"></span><br><span class="line">assert.typeOf(foo, <span class="string">'string'</span>); <span class="comment">// without optional message</span></span><br><span class="line">assert.typeOf(foo, <span class="string">'string'</span>, <span class="string">'foo is a string'</span>);</span><br><span class="line">assert.equal(foo, <span class="string">'bar'</span>, <span class="string">'foo equal `bar`'</span>);</span><br><span class="line">assert.lengthOf(foo, <span class="number">3</span>, <span class="string">'foo`s value has a length of 3'</span>);</span><br><span class="line">assert.lengthOf(beverages.tea, <span class="number">3</span>, <span class="string">'beverages has 3 types of tea'</span>);</span><br></pre></td></tr></table></figure>
<h4 id="apis"><a href="#apis" class="headerlink" title="apis"></a>apis</h4><ul>
<li>assert(expression, message)，参数 expression 为待测试的语句</li>
<li>.fail(actual, expected, [message], [operator])，operator 为操作（默认为 !=）</li>
<li>.ifError(object)，校验真值时抛出错误</li>
<li>.isOk/isNotOk/isTrue/isNotTrue/isFalse/isNotFalse/isNull/isNotNull/isNaN/isNotNaN/<br>isUndefined/isDefined/isFunction/isNotFunction/isObject/isNotObject/isArray/isNotArray/<br>isString/isNotString/isNumber/isNotNumber/isFinite/isBoolean/isNotBoolean(object, [message])</li>
<li>.exists/notExists(value, [message])，校验 value 不是 null 或 undefined</li>
<li>.typeOf/notTypeOf(value, type, [message]) 类型校验</li>
<li>.instanceOf/notInstanceOf(object, constructor, [message])</li>
<li>.match/notMatch(value, regexp, [message])</li>
<li>.equal/notEqual/strictEqual/notStrictEqual/deepEqual/notDeepEqual(actual, expected, [message])，’==’, ‘===’ 或 深度相等</li>
<li>.isAbove/isAtLeast/isBelow/isAtMost(valueToCheck, valueToBeAbove, [message])，以操作符 ‘&gt;’, ‘&gt;=’, ‘&lt;’, ‘&lt;=’ 校验</li>
<li>.operator(val1, operator, val2, [message])，’&gt;’, ‘&lt;’ 操作符校验</li>
<li>.closeTo(actual, expected, delta, [message])，actual 在 expected - delta, expected + delta 之间</li>
<li>.approximately(actual, expected, delta, [message])，同上</li>
<li>.changes/doesNotChange/increases/doesNotIncrease/decreases/<br>doesNotDecrease(function, object, property, [message])，校验函数执行时是否改变对象属性</li>
<li>.changesBy/changesButNotBy/ncreasesBy/increasesButNotBy/decreasesBy/<br>doesNotDecreaseBy/decreasesButNotBy(function, object, property, delta, [message])，校验属性数值改变 + delta</li>
<li>.lengthOf(object, length, [message])，校验字符串或数组的长度</li>
<li>.isExtensible/isNotExtensible/isSealed/isNotSealed/isFrozen/isNotFrozen(object)</li>
<li>.isEmpty/isNotEmpty(target)，校验对象、数组、字符串、Map、Set非空</li>
<li>.oneOf(inList, list, [message])</li>
<li>.include/notInclude/deepInclude/notDeepInclude/nestedInclude/notNestedInclude/<br>deepNestedInclude/notDeepNestedInclude/ownInclude/notOwnInclude/<br>deepOwnInclude/notDeepOwnInclude(haystack, needle, [message])，校验是否包含数组项，子字符串，或者对象属性的截取。deep 为深度匹配，nest 以分隔符 . 或者 [] 校验嵌套属性，own 校验是否自有属性</li>
<li>sameMembers/notSameMembers/sameDeepMembers/notSameDeepMembers/<br>sameOrderedMembers/notSameOrderedMembers/<br>sameDeepOrderedMembers/notSameDeepOrderedMembers(set1, set2, [message])，校验 set 是否有相同的成员。orderd 顺序相同</li>
<li>.includeMembers/notIncludeMembers/includeDeepMembers/notIncludeDeepMembers/<br>includeOrderedMembers/notIncludeOrderedMembers/<br>includeDeepOrderedMembers/notIncludeDeepOrderedMembers(superset, subset, [message])</li>
<li>.property/notProperty/nestedProperty/notNestedProperty(object, property, [message])</li>
<li>.propertyVal/notPropertyVal/deepPropertyVal/notDeepPropertyVal/<br>notNestedProperty/notNestedPropertyVal/<br>deepNestedPropertyVal/notDeepNestedPropertyVal(object, property, value, [message])</li>
<li>.hasAnyKeys/hasAllKeys/containsAllKeys/doesNotHaveAnyKeys/<br>doesNotHaveAllKeys/hasAnyDeepKeys/hasAllDeepKeys/<br>containsAllDeepKeys/doesNotHaveAnyDeepKeys/doesNotHaveAllDeepKeys(object, [keys], [message])</li>
<li>.throws/doesNotThrow(fn, [errorLike/string/regexp], [string/regexp], [message])，校验函数 fn 将抛出指定类型及文案的错误</li>
</ul>
<h3 id="TDD测试-except-should"><a href="#TDD测试-except-should" class="headerlink" title="TDD测试 - except, should"></a>TDD测试 - except, should</h3><h4 id="except"><a href="#except" class="headerlink" title="except"></a>except</h4><p>提供链式调用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> expect = <span class="built_in">require</span>(<span class="string">'chai'</span>).expect</span><br><span class="line">  , foo = <span class="string">'bar'</span></span><br><span class="line">  , beverages = &#123; <span class="attr">tea</span>: [ <span class="string">'chai'</span>, <span class="string">'matcha'</span>, <span class="string">'oolong'</span> ] &#125;;</span><br><span class="line"></span><br><span class="line">expect(foo).to.be.a(<span class="string">'string'</span>);</span><br><span class="line">expect(foo).to.equal(<span class="string">'bar'</span>);</span><br><span class="line">expect(foo).to.have.lengthOf(<span class="number">3</span>);</span><br><span class="line">expect(beverages).to.have.property(<span class="string">'tea'</span>).with.lengthOf(<span class="number">3</span>);</span><br></pre></td></tr></table></figure>
<h4 id="should"><a href="#should" class="headerlink" title="should"></a>should</h4><p>增强了 Object.property 功能，因此需先显示调用 chai.should 函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> should = <span class="built_in">require</span>(<span class="string">'chai'</span>).should() <span class="comment">//actually call the function</span></span><br><span class="line">  , foo = <span class="string">'bar'</span></span><br><span class="line">  , beverages = &#123; <span class="attr">tea</span>: [ <span class="string">'chai'</span>, <span class="string">'matcha'</span>, <span class="string">'oolong'</span> ] &#125;;</span><br><span class="line"></span><br><span class="line">foo.should.be.a(<span class="string">'string'</span>);</span><br><span class="line">foo.should.equal(<span class="string">'bar'</span>);</span><br><span class="line">foo.should.have.lengthOf(<span class="number">3</span>);</span><br><span class="line">beverages.should.have.property(<span class="string">'tea'</span>).with.lengthOf(<span class="number">3</span>);</span><br></pre></td></tr></table></figure>
<h4 id="语言链修饰符"><a href="#语言链修饰符" class="headerlink" title="语言链修饰符"></a>语言链修饰符</h4><p>语言链修饰符用于增强代码的可读性，包含 to, be, been, isthat, and, has, have, with, at, of, same</p>
<h4 id="apis-1"><a href="#apis-1" class="headerlink" title="apis"></a>apis</h4><ul>
<li>not 将断言置否，即否值满足断言，如 expect(function () {}).to.not.throw();</li>
<li>deep 深比较，如 expect({a: 1}).to.deep.equal({a: 1});</li>
<li>nested 嵌套属性，以 . 或 [] 分割，如 expect({a: {b: [‘x’, ‘y’]}}).to.have.nested.property(‘a.b[1]’);</li>
<li>own 如 expect({a: 1}).to.have.own.property(‘a’);</li>
<li>ordered 顺序比较，如 expect([1, 2]).to.have.ordered.members([1, 2]).but.not.have.ordered.members([2, 1]);</li>
<li>any/all 如 expect({a: 1, b: 2}).to.not.have.any.keys(‘c’, ‘d’);</li>
<li>.a/an(type[, msg]) 如 expect({a: 1}).to.be.an(‘object’);</li>
<li>.include(val[, msg]) 如 expect(‘foobar’).to.include(‘foo’);</li>
<li>.ok/true/false/null/undefined/NaN/exist/empty/arguments/finite 如 expect(arguments).to.be.arguments;</li>
<li>.eql(obj[, msg]) 如 expect({a: 1}).to.eql({a: 1}).but.not.equal({a: 1});</li>
<li>.above/least/below/most(n[, msg]) 如 expect(1).to.be.at.least(2);</li>
<li>.within(start, finish[, msg]) 如 expect(2).to.be.within(1, 3);</li>
<li>.instanceof(constructor[, msg]) 如 expect({a: 1}).to.not.be.an.instanceof(Array);</li>
<li>.property(name[, val[, msg]]) 如 expect({x: {a: 1}}).to.have.deep.property(‘x’, {a: 1});</li>
<li>.ownPropertyDescriptor(name[, descriptor[, msg]]) 如 expect({a: 1}).to.have.ownPropertyDescriptor(‘a’);</li>
<li>.lengthOf(n[, msg]) 如 expect([1, 2, 3]).to.have.lengthOf(3);</li>
<li>.match(re[, msg]) 如 expect(‘foobar’).to.match(/^foo/);</li>
<li>.string(str[, msg]) 包含子字符串，如 expect(‘foobar’).to.not.have.string(‘taco’);</li>
<li>.keys(key1[, key2[, …]]) 如 expect({a: 1, b: 2}).to.have.all.keys(‘a’, ‘b’);</li>
<li>.throw([errorLike], [errMsgMatcher], [msg]) 校验函数必须抛出错误，如 expect(badFn).to.throw();</li>
<li>.respondTo(method[, msg]) 校验对象是否有某方法，可以是继承的，如 expect(new Cat()).to.respondTo(‘meow’);</li>
<li>.itself 自有属性，如 expect(Cat).itself.to.respondTo(‘hiss’).but.not.respondTo(‘meow’);</li>
<li>.satisfy(matcher[, msg]) 校验是否匹配 matcher，如 expect(1).to.satisfy(function(num) { return num &gt; 0; });</li>
<li>.closeTo(expected, delta[, msg]) 校验值在 expected - delta ~ expected + delta 范围内，如 expect(1.5).to.be.closeTo(1, 0.5);</li>
<li>.members(set[, msg]) 如 expect([1, 2, 3]).to.have.members([2, 1, 3]);</li>
<li>.oneOf(list[, msg]) 如 expect(1).to.be.oneOf([1, 2, 3]);</li>
<li>.change(subject[, prop[, msg]]) 执行函数后，引起对象或其属性改变，如 expect(addDot).to.change(myObj, ‘dots’);</li>
<li>.increase(subject[, prop[, msg]]) 值增加</li>
<li>.decrease(subject[, prop[, msg]]) 值减少</li>
<li>.by(delta[, msg]) 如 expect(addTwo).to.increase(myObj, ‘val’).by(2);</li>
<li>.extensible/sealed/frozen 对象可扩展性</li>
<li>.fail(actual, expected, [message], [operator])，operator 为操作（默认为 !=）</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/11/手册/Enzyme使用指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/11/手册/Enzyme使用指南/" itemprop="url">Enzyme使用指南</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-11T00:00:00+08:00">2018-02-11</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端工程化/" itemprop="url" rel="index"><span itemprop="name">前端工程化</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/11/手册/Enzyme使用指南/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/02/11/手册/Enzyme使用指南/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Enzyme 是一款 react 组件测试工具。</p>
<p>Enzyme 基于 <a href="https://github.com/cheeriojs/cheerio" target="_blank" rel="noopener">cheerio</a> 实现虚拟 dom 的查找和遍历；而 cheerio 号称为服务器端的 jquery 实现。</p>
<p>Enzyme 本身不实现测试和断言库，你可以选择使用 Mocha/chai, Jasmine, Jest 等测试或断言库。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><ol>
<li>安装 npm i –save-dev enzyme。</li>
<li>针对项目中使用的 react 版本，安装 enzyme-adapter-react-16, enzyme-adapter-react-15（15.5.0 版本起）, enzyme-adapter-react-15.4（15.0.0 ~ 15.4.x）, enzyme-adapter-react-14, enzyme-adapter-react-13 适配器。</li>
<li><p>配置 enzyme 以使用适配器。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Enzyme <span class="keyword">from</span> <span class="string">'enzyme'</span>;</span><br><span class="line"><span class="keyword">import</span> Adapter <span class="keyword">from</span> <span class="string">'enzyme-adapter-react-16'</span>;</span><br><span class="line"></span><br><span class="line">Enzyme.configure(&#123; <span class="attr">adapter</span>: <span class="keyword">new</span> Adapter() &#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写测试用例。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; expect &#125; <span class="keyword">from</span> <span class="string">'chai'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; shallow &#125; <span class="keyword">from</span> <span class="string">'enzyme'</span>;</span><br><span class="line"><span class="keyword">import</span> sinon <span class="keyword">from</span> <span class="string">'sinon'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> MyComponent <span class="keyword">from</span> <span class="string">'./MyComponent'</span>;</span><br><span class="line"><span class="keyword">import</span> Foo <span class="keyword">from</span> <span class="string">'./Foo'</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'&lt;MyComponent /&gt;'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'renders three &lt;Foo /&gt; components'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> wrapper = shallow(<span class="xml"><span class="tag">&lt;<span class="name">MyComponent</span> /&gt;</span>);</span></span><br><span class="line"><span class="xml">    expect(wrapper.find(Foo)).to.have.length(3);</span></span><br><span class="line"><span class="xml">  &#125;);</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  it('renders an `.icon-star`', () =&gt; &#123;</span></span><br><span class="line"><span class="xml">    const wrapper = shallow(<span class="tag">&lt;<span class="name">MyComponent</span> /&gt;</span>);</span></span><br><span class="line"><span class="xml">    expect(wrapper.find('.icon-star')).to.have.length(1);</span></span><br><span class="line"><span class="xml">  &#125;);</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  it('renders children when passed in', () =&gt; &#123;</span></span><br><span class="line"><span class="xml">    const wrapper = shallow((</span></span><br><span class="line">      &lt;MyComponent&gt;</span><br><span class="line">        &lt;div className="unique" /&gt;</span><br><span class="line">      &lt;/MyComponent&gt;</span><br><span class="line">    ));</span><br><span class="line">    expect(wrapper.contains(&lt;div className="unique" /&gt;)).to.equal(true);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it('simulates click events', () =&gt; &#123;</span><br><span class="line">    const onButtonClick = sinon.spy();</span><br><span class="line">    const wrapper = shallow(&lt;Foo onButtonClick=&#123;onButtonClick&#125; /&gt;);</span><br><span class="line">    wrapper.find('button').simulate('click');</span><br><span class="line">    expect(onButtonClick).to.have.property('callCount', 1);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="api-手册"><a href="#api-手册" class="headerlink" title="api 手册"></a>api 手册</h2><h3 id="渲染模式"><a href="#渲染模式" class="headerlink" title="渲染模式"></a>渲染模式</h3><ol>
<li>浅渲染：shallow(node[, options]) =&gt; ShallowWrapper。参数 node 为 ReactElement，options.context 传入组件的context，options.disableLifecycleMethods 生命周期方法是否有效。</li>
<li>完整渲染：mount(node[, options]) =&gt; ReactWrapper。options.context 传入组件的context，options.attachTo 生命周期方法是否有效。需要完整的 dom api，所以需要安装 <a href="https://github.com/jsdom/jsdom" target="_blank" rel="noopener">jsdom</a> 库。</li>
<li>静态渲染：render(node[, options]) =&gt; CheerioWrapper，渲染为 html，通过 cheerio 解析 html。</li>
</ol>
<h3 id="wrapper-api"><a href="#wrapper-api" class="headerlink" title="wrapper api"></a>wrapper api</h3><ol>
<li>.find(selector) =&gt; Wrapper</li>
<li>.findWhere(predicate) =&gt; Wrapper</li>
<li>.filter(selector) =&gt; Wrapper</li>
<li>.filterWhere(predicate) =&gt; Wrapper</li>
<li>.hostNodes() =&gt; Wrapper，事先存在于文档中 host 节点</li>
<li>.contains(nodeOrNodes) =&gt; Boolean</li>
<li>.containsMatchingElement(node) =&gt; Boolean</li>
<li>.containsAllMatchingElements(nodes) =&gt; Boolean</li>
<li>.containsAnyMatchingElements(nodes) =&gt; Boolean</li>
<li>.equals(node) =&gt; Boolean</li>
<li>.matchesElement(node) =&gt; Boolean</li>
<li>.hasClass(className) =&gt; Boolean</li>
<li>.is(selector) =&gt; Boolean</li>
<li>.exists() =&gt; Boolean</li>
<li>.isEmpty() =&gt; Boolean</li>
<li>.isEmptyRender() =&gt; Boolean</li>
<li>.not(selector) =&gt; Wrapper</li>
<li>.children() =&gt; Wrapper</li>
<li>.childAt(index) =&gt; Wrapper</li>
<li>.parents() =&gt; Wrapper</li>
<li>.parent() =&gt; Wrapper</li>
<li>.closest(selector) =&gt; Wrapper</li>
<li>.shallow([options]) =&gt; Wrapper，ShallowWrapper 独有</li>
<li>.render() =&gt; CheerioWrapper</li>
<li>.unmount() =&gt; Wrapper。ReactWrapper 独有 .mount() =&gt; Wrapper 方法</li>
<li>.text() =&gt; String</li>
<li>.html() =&gt; String</li>
<li>.get(index) =&gt; ReactElement</li>
<li>.getElement() =&gt; ReactElement。ReactWrapper 中为 .getNode() =&gt; ReactElement 方法</li>
<li>.getElements() =&gt; Array<reactelement>。ReactWrapper 中为 .getNodes() =&gt; Array<reactelement> 方法。ReactWrapper 独有 .getDOMNode() =&gt; DOMComponent 方法。</reactelement></reactelement></li>
<li>.at(index) =&gt; Wrapper</li>
<li>.first() =&gt; Wrapper</li>
<li>.last() =&gt; Wrapper</li>
<li>.state([key]) =&gt; Any</li>
<li>.context([key]) =&gt; Any</li>
<li>.props() =&gt; Object</li>
<li>.prop(key) =&gt; Any</li>
<li>.key() =&gt; String</li>
<li>.simulate(event[, data]) =&gt; Wrapper，模拟点击事件等</li>
<li>.setState(nextState) =&gt; Wrapper</li>
<li>.setProps(nextProps) =&gt; Wrapper</li>
<li>.setContext(context) =&gt; Wrapper</li>
<li>.instance() =&gt; ReactComponent</li>
<li>.update() =&gt; Wrapper，调用 forceUpdate 方法强制更新组件实例。调用实例方法后，需要调用 .update 强制刷新 props。</li>
<li>.debug() =&gt; String，.children 返回已渲染的节点，.children().debug() 返回渲染实际配置格式</li>
<li>.type() =&gt; String|Function|null</li>
<li>.name() =&gt; String</li>
<li>.forEach(fn) =&gt; Wrapper</li>
<li>.map(fn) =&gt; Array</li>
<li>.reduce(fn[, initialValue]) =&gt; Any</li>
<li>.reduceRight(fn[, initialValue]) =&gt; Any</li>
<li>.slice([begin[, end]]) =&gt; Wrapper</li>
<li>.tap(intercepter) =&gt; Self</li>
<li>.some(selector) =&gt; Boolean</li>
<li>.someWhere(predicate) =&gt; Boolean</li>
<li>.every(selector) =&gt; Boolean</li>
<li>.everyWhere(predicate) =&gt; Boolean</li>
<li>.dive([options]) =&gt; Wrapper，ShallowWrapper 独有</li>
<li>.ref(refName) =&gt; Wrapper，ReactWrapper 独有</li>
<li>.detach() =&gt; void，ReactWrapper 独有</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/10/手册/storybook使用指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/10/手册/storybook使用指南/" itemprop="url">storybook使用指南</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-10T20:44:57+08:00">2018-02-10</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端工程化/" itemprop="url" rel="index"><span itemprop="name">前端工程化</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/10/手册/storybook使用指南/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/02/10/手册/storybook使用指南/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>storybook 在应用之外，为 UI 组件提供了独立的开发、调试环境。react-transition-group 类库的测试工作即通过 storybook 实现。</p>
<p>storybook 支持调试 react, vue, angular, react-native 组件。<a href="https://storybook.js.org/" target="_blank" rel="noopener">storybook官网</a></p>
<h2 id="操作指南"><a href="#操作指南" class="headerlink" title="操作指南"></a>操作指南</h2><ol>
<li>全局安装 @storybook/cli</li>
<li>项目目录安装依赖：react 项目为 @storybook/react，vue 项目为 @storybook/vue，angular 项目为 @storybook/angular。同时需要安装 babel-core。</li>
<li><p>package.json 添加</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// -h 选项 指定以 127.0.0.1 作为主机</span><br><span class="line">// -p 选项 指定以 9001 作为端口号</span><br><span class="line">// -s 选项 指定 public 作为为静态文件目录</span><br><span class="line">// -c 选项 指定以 .storybook 作为配置目录</span><br><span class="line">// -o 选项 指定以 .out 作为打包文件目录</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"storybook"</span>: <span class="string">"start-storybook -h 127.0.0.1 -p 9001 -s ./public -c .storybook"</span>,</span><br><span class="line">    <span class="attr">"build:storybook"</span>: <span class="string">"build-storybook -s ./public -c .storybook -o .out"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建配置文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .storybook/config.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; configure &#125; <span class="keyword">from</span> <span class="string">'@storybook/react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadStories</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">'../stories/index.js'</span>);</span><br><span class="line">  <span class="comment">// You can require as many stories as you need.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">configure(loadStories, <span class="built_in">module</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写 story。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// stories/index.js</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; storiesOf &#125; <span class="keyword">from</span> <span class="string">'@storybook/react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; action &#125; <span class="keyword">from</span> <span class="string">'@storybook/addon-actions'</span>;</span><br><span class="line"><span class="keyword">import</span> Button <span class="keyword">from</span> <span class="string">'../components/Button'</span>;<span class="comment">// 来自于工程目录</span></span><br><span class="line"></span><br><span class="line">storiesOf(<span class="string">'Button'</span>, <span class="built_in">module</span>)</span><br><span class="line">  .add(<span class="string">'with text'</span>, () =&gt; (</span><br><span class="line">    &lt;Button onClick=&#123;action(<span class="string">'clicked'</span>)&#125;&gt;Hello Button&lt;<span class="regexp">/Button&gt;</span></span><br><span class="line"><span class="regexp">  ))</span></span><br><span class="line"><span class="regexp">  .add('with some emoji', () =&gt; (</span></span><br><span class="line"><span class="regexp">    &lt;Button onClick=&#123;action('clicked')&#125;&gt;😀 😎 👍 💯&lt;/</span>Button&gt;</span><br><span class="line">  ));</span><br></pre></td></tr></table></figure>
</li>
<li><p>npm run storybook，将在 9001 端口启动服务，Button 按钮下有 with text, with some emoji 两个 story。</p>
</li>
<li>npm run build:storybook，打包输出静态文件。通过 storybook-deployer 工具可以将静态文件发布到 github 上，或者通过 build-storybook 命令将文件打包到 docs 目录中，作为 github pages 的根目录。</li>
</ol>
<h3 id="贴示"><a href="#贴示" class="headerlink" title="贴示"></a>贴示</h3><ol>
<li><p>storybook 内部集成 webpack，通过 babel 编译 js，.babelrc 文件可替代 storybook 的默认配置；支持 css, json, 图片等静态文件的加载。<br>自定义 webpack 配置通过在 .storybook 目录中添加 webpack.config.js 实现，如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 除了 babel-loader 外，默认配置中的其余加载器全部停用</span></span><br><span class="line"><span class="comment">// 这种配置方式不能用于配置 babel-loader（第一个加载器）, entry, output</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.scss$/</span>,</span><br><span class="line">        loaders: [<span class="string">"style-loader"</span>, <span class="string">"css-loader"</span>, <span class="string">"sass-loader"</span>],</span><br><span class="line">        include: path.resolve(__dirname, <span class="string">'../'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line"><span class="comment">// 这种配置方式不能用于替换 babel-loader（第一个加载器）, entry, output，所有已存在的插件</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">storybookBaseConfig, configType, defaultConfig</span>) =&gt;</span> &#123;</span><br><span class="line">  storybookBaseConfig.module.rules.push(&#123;</span><br><span class="line">    test: <span class="regexp">/\.scss$/</span>,</span><br><span class="line">    loaders: [<span class="string">"style-loader"</span>, <span class="string">"css-loader"</span>, <span class="string">"sass-loader"</span>],</span><br><span class="line">    include: path.resolve(__dirname, <span class="string">'../'</span>)</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> storybookBaseConfig;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>html，head 头部添加标签。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// .storybook/preview-head.html 配置文件将如下标签注入到渲染导入组件的 iframe 中，不影响 storybook 主界面</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://use.typekit.net/xxxyyy.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="keyword">try</span>&#123; Typekit.load(); &#125; <span class="keyword">catch</span>(e)&#123; &#125;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// .storybook/preview-head.html 配置文件，将影响 storybook 主界面</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过访问 <a href="http://localhost:9009/iframe.html?selectedKind=Button&amp;selectedStory=with+text&amp;dataId=0" target="_blank" rel="noopener">http://localhost:9009/iframe.html?selectedKind=Button&amp;selectedStory=with+text&amp;dataId=0</a> 可以访问 Button 下的 with text 这个 story，浏览器显示将不带左边栏。</p>
</li>
</ol>
<h2 id="辅助测试"><a href="#辅助测试" class="headerlink" title="辅助测试"></a>辅助测试</h2><h3 id="Structural-Testing"><a href="#Structural-Testing" class="headerlink" title="Structural Testing"></a>Structural Testing</h3><p>Structural Testing 结构测试的目的是判断页面元素是否异常，缺失或增加等。</p>
<p>在 storybook 中，借助 <a href="https://facebook.github.io/jest/blog/2016/07/27/jest-14.html" target="_blank" rel="noopener">Jest’s snapshot testing</a> 实现结构测试。针对 react，Jest 将为虚拟 DOM 拍摄快照，将其转化为 json 数据，在下一次运行时比对两张快照是否有偏差。</p>
<p>具体步骤为：</p>
<ol>
<li>安装 @storybook/addon-storyshots 插件。</li>
<li><p>编写 storyshots.test.js 文件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> initStoryshots <span class="keyword">from</span> <span class="string">'@storybook/addon-storyshots'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// getStorybook() 函数获取所有 story</span></span><br><span class="line">initStoryshots(&#123; <span class="comment">/* configuration options */</span> &#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行 storyshots.test.js 脚本，可用于测试组件逻辑是否崩盘。</p>
</li>
</ol>
<p>参考文档：<a href="http://onetwo.ren/ReactStorybook%E7%9A%84%E5%90%84%E7%A7%8D%E6%95%85%E4%BA%8B/" target="_blank" rel="noopener">ReactStorybook 的各种故事</a></p>
<h3 id="interaction-testing"><a href="#interaction-testing" class="headerlink" title="interaction testing"></a>interaction testing</h3><p>关于 interaction testing 交互测试，可以通过模拟用户输入，在 <a href="https://github.com/airbnb/enzyme" target="_blank" rel="noopener">Enzyme</a> 测试框架 Jest, Mocha 实现。</p>
<p>在 storybook 中，交互测试可通过 <a href="https://github.com/mthuret/storybook-addon-specifications" target="_blank" rel="noopener">storybook-addon-specifications</a> 插件实现。</p>
<p>具体步骤为：</p>
<ol>
<li>安装 storybook-addon-specifications 插件。</li>
<li><p>编写 .storybook/addons.js 配置文件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'storybook-addon-specifications/register'</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加测试文件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; storiesOf &#125; <span class="keyword">from</span> <span class="string">'@kadira/storybook'</span></span><br><span class="line"><span class="keyword">import</span> &#123; specs, describe, it &#125; <span class="keyword">from</span> <span class="string">'storybook-addon-specifications'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;mount&#125; <span class="keyword">from</span> <span class="string">"enzyme"</span>;</span><br><span class="line"><span class="keyword">import</span> expect <span class="keyword">from</span> <span class="string">"expect"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> stories = storiesOf(<span class="string">'Button'</span>, <span class="built_in">module</span>);</span><br><span class="line"></span><br><span class="line">stories.add(<span class="string">'Hello World'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> story =</span><br><span class="line">    &lt;button onClick=&#123;action(<span class="string">'Hello World'</span>)&#125;&gt;</span><br><span class="line">      Hello World</span><br><span class="line">    &lt;<span class="regexp">/button&gt;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  /</span><span class="regexp">/ describe 首参必须与 story 名字相同</span></span><br><span class="line"><span class="regexp">  specs(() =&gt; describe('Hello World', function () &#123;</span></span><br><span class="line"><span class="regexp">    it('Should have the Hello World label', function () &#123;</span></span><br><span class="line"><span class="regexp">      let output = mount(story);</span></span><br><span class="line"><span class="regexp">      expect(output.text()).toContain('Hello World');</span></span><br><span class="line"><span class="regexp">    &#125;);</span></span><br><span class="line"><span class="regexp">  &#125;));</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  return story;</span></span><br><span class="line"><span class="regexp">&#125;);</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h2><h3 id="使用插件"><a href="#使用插件" class="headerlink" title="使用插件"></a>使用插件</h3><p>在 storybook 中，插件分为两类，装饰器 Decorator（通过封装 react 组件实现，如 storybook-router） 或 以面板形式注入的 Native Addon（如 addon-actions）。</p>
<ol>
<li><p>添加 .storybook/addons.js 配置文件用于向页面添加右下方插件面板。如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'@storybook/addon-actions/register'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'@storybook/addon-links/register'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'@storybook/addon-notes/register'</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写 stroy</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; storiesOf &#125; <span class="keyword">from</span> <span class="string">'@storybook/react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; action &#125; <span class="keyword">from</span> <span class="string">'@storybook/addon-actions'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; WithNotes &#125; <span class="keyword">from</span> <span class="string">'@storybook/addon-notes'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Button <span class="keyword">from</span> <span class="string">'./Button'</span>;</span><br><span class="line"></span><br><span class="line">storiesOf(<span class="string">'Button'</span>, <span class="built_in">module</span>)</span><br><span class="line">  .add(<span class="string">'with some emoji'</span>, () =&gt; (</span><br><span class="line">    &lt;WithNotes notes=&#123;<span class="string">'Here we use some emoji as the Button text. Doesn&amp;apos;t it look nice?'</span>&#125;&gt;</span><br><span class="line">      &lt;Button onClick=&#123;action(<span class="string">'clicked'</span>)&#125;&gt;😀 😎 👍 💯&lt;<span class="regexp">/Button&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>WithNotes&gt;</span><br><span class="line">  ));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用装饰器 1</span></span><br><span class="line"><span class="keyword">import</span> &#123; storiesOf &#125; <span class="keyword">from</span> <span class="string">'@storybook/react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; action &#125; <span class="keyword">from</span> <span class="string">'@storybook/addon-actions'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Button <span class="keyword">from</span> <span class="string">'./button'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styles = &#123;</span><br><span class="line">  textAlign: <span class="string">'center'</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> CenterDecorator = <span class="function">(<span class="params">storyFn</span>) =&gt;</span> (</span><br><span class="line">  &lt;div style=&#123;styles&#125;&gt;</span><br><span class="line">    &#123; storyFn() &#125;</span><br><span class="line">  &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">storiesOf('Button', module)</span></span><br><span class="line"><span class="regexp">  .addDecorator(CenterDecorator)</span></span><br><span class="line"><span class="regexp">  .add('with text', () =&gt; (</span></span><br><span class="line"><span class="regexp">    &lt;Button onClick=&#123;action('clicked')&#125;&gt;Hello Button&lt;/</span>Button&gt;</span><br><span class="line">  ))</span><br><span class="line">  .add(<span class="string">'with some emojies'</span>, () =&gt; (</span><br><span class="line">    &lt;Button onClick=&#123;action(<span class="string">'clicked'</span>)&#125;&gt;😀 😎 👍 💯&lt;<span class="regexp">/Button&gt;</span></span><br><span class="line"><span class="regexp">  ));</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 使用装饰器 2</span></span><br><span class="line"><span class="regexp">import &#123; storiesOf, addDecorator &#125; from '@storybook/</span>react<span class="string">';</span></span><br><span class="line"><span class="string">import &#123; action &#125; from '</span>@storybook/addon-actions<span class="string">';</span></span><br><span class="line"><span class="string">import &#123; linkTo &#125; from '</span>@storybook/addon-links<span class="string">';</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">import Button from '</span>./button<span class="string">';</span></span><br><span class="line"><span class="string">import Welcome from '</span>./welcome<span class="string">';</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">const styles = &#123;</span></span><br><span class="line"><span class="string">  textAlign: '</span>center<span class="string">',</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string">const CenterDecorator = (storyFn) =&gt; (</span></span><br><span class="line"><span class="string">  &lt;div style=&#123;styles&#125;&gt;</span></span><br><span class="line"><span class="string">    &#123; storyFn() &#125;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;</span></span><br><span class="line"><span class="string">);</span></span><br><span class="line"><span class="string">addDecorator(CenterDecorator);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">storiesOf('</span>Welcome<span class="string">', module)</span></span><br><span class="line"><span class="string">  .add('</span>to Storybook<span class="string">', () =&gt; (</span></span><br><span class="line"><span class="string">    &lt;Welcome showApp=&#123;linkTo('</span>Button<span class="string">')&#125;/&gt;</span></span><br><span class="line"><span class="string">  ));</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">storiesOf('</span>Button<span class="string">', module)</span></span><br><span class="line"><span class="string">  .add('</span><span class="keyword">with</span> text<span class="string">', () =&gt; (</span></span><br><span class="line"><span class="string">    &lt;Button onClick=&#123;action('</span>clicked<span class="string">')&#125;&gt;Hello Button&lt;/Button&gt;</span></span><br><span class="line"><span class="string">  ))</span></span><br><span class="line"><span class="string">  .add('</span><span class="keyword">with</span> some emojies<span class="string">', () =&gt; (</span></span><br><span class="line"><span class="string">    &lt;Button onClick=&#123;action('</span>clicked<span class="string">')&#125;&gt;😀 😎 👍 💯&lt;/Button&gt;</span></span><br><span class="line"><span class="string">  ));</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="插件清单"><a href="#插件清单" class="headerlink" title="插件清单"></a>插件清单</h3><ol>
<li><a href="https://github.com/storybooks/storybook/tree/master/addons/storyshots" target="_blank" rel="noopener">Storyshots</a>: 快照测试。</li>
<li><a href="https://github.com/mthuret/storybook-addon-specifications" target="_blank" rel="noopener">Specs</a>: 交互测试。</li>
<li><a href="https://github.com/storybooks/storybook/tree/master/addons/notes" target="_blank" rel="noopener">Notes</a>: 在 story 中添加备注。</li>
<li><a href="https://github.com/storybooks/storybook/tree/master/addons/info" target="_blank" rel="noopener">Info</a>: 用于创建 css 框架手册。</li>
<li><a href="https://github.com/tuchk4/storybook-readme" target="_blank" rel="noopener">Readme</a>: 将 markdown 导入为 story。</li>
<li><a href="https://github.com/storybooks/storybook/tree/master/addons/actions" target="_blank" rel="noopener">actions</a>: 显示事件的 event 对象。</li>
<li><a href="https://github.com/truffls/storybook-addon-intl" target="_blank" rel="noopener">Intl</a>: 添加 locales 面板，用于切换语言。</li>
<li><a href="https://github.com/Sambego/storybook-state" target="_blank" rel="noopener">State</a>: 添加 state 面板，展示或更新 state，重绘视图。</li>
<li><a href="https://github.com/evgenykochetkov/react-storybook-addon-props-combinations" target="_blank" rel="noopener">Props Combinations</a>: 配置可能有的props，一次性绘出多个组件作对比。</li>
<li><a href="https://github.com/storybooks/storybook/tree/master/addons/knobs" target="_blank" rel="noopener">Knobs</a>: 页面上变更 props 重绘视图。</li>
<li><a href="https://github.com/storybooks/storybook/tree/master/addons/links" target="_blank" rel="noopener">Links</a>: 通过 linkTo 函数或 LinkTo 组件链接多个 story，支持点击跳转。</li>
<li><a href="https://github.com/gvaldambrini/storybook-router" target="_blank" rel="noopener">Story-router</a>: 装饰器，支持 storybook 使用 react-router 等路由组件。</li>
<li><a href="https://github.com/storybook-eol/addon-backgrounds" target="_blank" rel="noopener">Backgrounds</a>: 切换背景图或背景颜色。</li>
<li><a href="https://github.com/joscha/storybook-addon-i18n-tools" target="_blank" rel="noopener">i18n tools</a>: 切换文字对齐方式，左对齐或右对齐。</li>
<li><a href="https://github.com/react-theming/storybook-addon-material-ui" target="_blank" rel="noopener">Material-UI</a>: 添加并切换自定义主题。</li>
<li><a href="https://github.com/philcockfield/storybook-host" target="_blank" rel="noopener">Host</a>: 装饰器，在页面上以盒模式展示组件。</li>
<li><a href="https://github.com/Checkfront/react-storybook-addon-chapters" target="_blank" rel="noopener">Chapters</a>: 在同一个 story 中以章节形式展示多个组件。</li>
<li><a href="https://github.com/storybooks/storybook/tree/master/addons/options" target="_blank" rel="noopener">Options</a>: 调整 storybook 页面外观，切换为全屏等。</li>
<li><a href="https://github.com/storybooks/storybook-addon-console" target="_blank" rel="noopener">Console</a>: 将浏览器控制台 console 信息输出到 storybook log 面板。</li>
<li><a href="https://github.com/storybooks/addon-jsx" target="_blank" rel="noopener">JSX preview</a>: 展示及拷贝 JSX 代码。</li>
<li><a href="https://github.com/buildit/storybook-addon-versions" target="_blank" rel="noopener">Versions</a>: 添加版本号，查看各版本的变化。</li>
<li><a href="https://github.com/abhiaiyer91/apollo-storybook-decorator" target="_blank" rel="noopener">Apollo</a>: 添加 Apollo client，模拟 GraphQL 查询。</li>
<li><a href="https://github.com/tsuyoshiwada/storybook-chrome-screenshot" target="_blank" rel="noopener">Screenshot</a>: 保存网页截图。</li>
<li><a href="https://storybook.js.org/addons/addon-gallery/" target="_blank" rel="noopener">Styles</a>: storybook 预览界面添加自定义样式。</li>
<li><a href="https://github.com/hharnisc/storybook-addon-figma" target="_blank" rel="noopener">Figma</a>: 添加 Figma 设计面板。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/07/react/react相关/浅析react-transition-group源码/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/07/react/react相关/浅析react-transition-group源码/" itemprop="url">浅析react-transition-group源码</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-07T23:19:17+08:00">2018-02-07</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/react/" itemprop="url" rel="index"><span itemprop="name">react</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/07/react/react相关/浅析react-transition-group源码/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/02/07/react/react相关/浅析react-transition-group源码/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="react-transition-group-1-版本回顾"><a href="#react-transition-group-1-版本回顾" class="headerlink" title="react-transition-group 1 版本回顾"></a>react-transition-group 1 版本回顾</h2><p>react-transition-group 1 版本在子组件创建、删除过程通过添加 class 控制 css 动效。</p>
<p>介于 css transition 动效在元素添加到页面过程就会执行，因此这个过程无需调控动效的执行。而当有元素被移除时，我们需要容器组件驻留被删除的子组件，等到动效执行完成后，才实际删除该子组件。</p>
<p>针对这一问题，react-transition-group 提供了 TransitionGroup 容器组件。其 state.children 属性为实际待绘制的组件，当组件更新时，通过比对 state.children, props.children，就可以获知新增了哪些组件、移除了哪些组件（用户配置的子组件通过 key 键存储成映射结构）。当子组件被移除时，触发 performLeave 方法，以调用子组件的 componentWillLeave 方法添加样式类、执行动效；再通过 componentWillLeave 方法的回调函数，更新 TransitionGroup 容器的 state.children，触发子组件的实际移除行为。</p>
<p>当采用上述逻辑处理子组件的移除动效时，为着处理逻辑的统一，react-transition-group 针对 componentDidMount 或 componentDidUpdate 时创建的子组件也采用相同的处理逻辑。子组件的钩子函数 componentWillAppear, componentDidAppear, componentWillEnter, componentDidEnter, componentWillLeave, componentDidLeave 将分别得到执行。当独立使用  TransitionGroup 容器时，我们可以借助这些钩子函数操控节点的样式以触发 css 动效，或者组织 js 动效，或者实现懒加载等等。</p>
<p>在 TransitionGroup 容器的基础上，CSSTransitionGroupChild 组件用于装饰子组件，在 componentWillAppear 等钩子函数添加样式类以执行 css 动效，通过 setTimeout 或 transitionEnd 事件更新 TransitionGroup 容器的 state.children 属性。CSSTransitionGroup 组件用于将 props 配置上提，而不是通过 CSSTransitionGroupChild 给每个子组件外加一个壳子。</p>
<h2 id="react-transition-group-2-版本"><a href="#react-transition-group-2-版本" class="headerlink" title="react-transition-group 2 版本"></a>react-transition-group 2 版本</h2><h3 id="Transition"><a href="#Transition" class="headerlink" title="Transition"></a>Transition</h3><p>相比于 1 版本通过判断子组件的有无添加动效，react-transition-group 2 版本可通过向子组件传递状态值（props.children 以函数形式配置；若为ReactElement，则无任何作用）控制子组件的创建和删除过程，这一点和 react-motion 类库相仿。关于 react-motion，笔者将在后续文章中加以分析。</p>
<p>上述思路的简单实现是通过容器组件向子组件传递 props.status，用于判断动效是在执行中 transitionExcute，还是执行完成 transitionEnd。若执行完成，将触发移除组件的操作。为此，react-transition-group 2 提供了 Transition 容器组件，props.status 状态分别在子组件创建和移除阶段添置了两个值，合计四种状态，即 ENTERING, ENTERED, EXITING, EXITED 。ENTERING, ENTERED 状态针对新创建的子组件，EXITING, EXITED 状态针对待移除的子组件。Transition 组件内部实现的主要业务逻辑就是协调 ENTERING 到 ENTERED，EXITING 到 EXITED 状态的自动变更。对于不需要动效的场景，状态将直接置为 ENTERED, EXITED；在 Transition 组件中，作为动效开关的是 props.appear, props.enter, props.exit 属性。</p>
<p>除此之外，有必要区分组件在创建过程 onEnter 还是在移除过程 onExit，以便于控制组件的挂载状态。然而 onEnter, onExit 两个状态值不适用于动效结束时仍保留组件的场景。为此，Transition 组件使用 props.in 属性表示组件的显示状态，结合 props.unmountOnExit 属性即表示在动效执行完成后，不必移除组件。子组件不能通过获得的 status 值控制自身的挂载状态，Transition 容器通过将 status 置为 UNMOUNTED，并在其 render 方法中输出 null，以控制子组件的显隐。这样的设计也满足了对子组件挂载时机的微调。像 1 版本中那样，通常情况下，子组件往往而在。不同的是，在组件初始化时通过将 props.mountOnEnter 属性置为真值，且 props.in 为否值，子组件将不在视图显示；当更新组件时，props.in 属性首次切换为真值时，才将 status 置为 EXITED，以便在实际视图中创建子组件，从而启动动效。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constructor</span>(props, context) &#123;</span><br><span class="line">  <span class="keyword">super</span>(props, context);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> parentGroup = context.transitionGroup;</span><br><span class="line">  <span class="comment">// In the context of a TransitionGroup all enters are really appears</span></span><br><span class="line">  <span class="keyword">let</span> appear = parentGroup &amp;&amp; !parentGroup.isMounting ?</span><br><span class="line">    props.enter :</span><br><span class="line">    props.appear;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> initialStatus;</span><br><span class="line">  <span class="keyword">this</span>.nextStatus = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (props.in) &#123;<span class="comment">// in 为真值，创建并显示组件</span></span><br><span class="line">    <span class="keyword">if</span> (appear) &#123;<span class="comment">// appear 为真值，执行动效</span></span><br><span class="line">      initialStatus = EXITED;<span class="comment">// updateStatus 方法中满足 initialStatus 非 null 校验，以执行 performEnter 方法</span></span><br><span class="line">      <span class="keyword">this</span>.nextStatus = ENTERING;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;<span class="comment">// appear 为否值，不执行动效</span></span><br><span class="line">      initialStatus = ENTERED;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// mountOnEnter 为真值，意味着延迟挂载；unmountOnExit 为否值的情形，主要为着避过 updateStatus 中对 &#123; state: EXITED &#125; 的处理逻辑，即动效执行结束后移除组件</span></span><br><span class="line">    <span class="keyword">if</span> (props.unmountOnExit || props.mountOnEnter) &#123;</span><br><span class="line">      initialStatus = UNMOUNTED;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 悬空</span></span><br><span class="line">      initialStatus = EXITED;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.state = &#123; <span class="attr">status</span>: initialStatus &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.nextCallback = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">componentDidMount() &#123;</span><br><span class="line">  <span class="keyword">this</span>.updateStatus(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">componentWillReceiveProps(nextProps) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; status &#125; = <span class="keyword">this</span>.pendingState || <span class="keyword">this</span>.state;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (nextProps.in) &#123;</span><br><span class="line">    <span class="comment">// 子组件已被移除或初始化未被挂载，status 置为 EXITED，便于添加子组件</span></span><br><span class="line">    <span class="keyword">if</span> (status === UNMOUNTED) &#123;</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123; <span class="attr">status</span>: EXITED &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 子组件尚未在视图中，执行显示动效</span></span><br><span class="line">    <span class="keyword">if</span> (status !== ENTERING &amp;&amp; status !== ENTERED) &#123;</span><br><span class="line">      <span class="keyword">this</span>.nextStatus = ENTERING;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 子组件已在视图中，执行移除动效</span></span><br><span class="line">    <span class="keyword">if</span> (status === ENTERING || status === ENTERED) &#123;</span><br><span class="line">      <span class="keyword">this</span>.nextStatus = EXITING;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">componentDidUpdate() &#123;</span><br><span class="line">  <span class="keyword">this</span>.updateStatus();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">updateStatus(mounting = <span class="literal">false</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> nextStatus = <span class="keyword">this</span>.nextStatus;<span class="comment">// 只有两种可能，ENTERING 或 EXITING</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (nextStatus !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.nextStatus = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.cancelNextCallback();</span><br><span class="line">    <span class="keyword">const</span> node = ReactDOM.findDOMNode(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nextStatus === ENTERING) &#123;</span><br><span class="line">      <span class="keyword">this</span>.performEnter(node, mounting);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.performExit(node);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="comment">// 动效执行完成后 state 置为 EXITED 时，且 unmountOnExit 为真，移除子组件</span></span><br><span class="line">    <span class="keyword">this</span>.props.unmountOnExit &amp;&amp;</span><br><span class="line">    <span class="keyword">this</span>.state.status === EXITED</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; <span class="attr">status</span>: UNMOUNTED &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（当初始化时，props.in 置为否值，子组件将不予渲染或渲染后无动效；当更新时置为否值，子组件已在视图中，执行 performExit 方法，好启动 exit 动效。）</p>
<p>上述代码中，performEnter, performExit 方法用于操控容器组件在 props.timeout 时间后自动从 ENTERING 切换到 ENTERED 状态，或者从 EXITING 切换到 EXITED 状态。这两个方法均调用了 safeSetState 方法，该方法的意义是设置 pendingState 属性，以避免动效的多次执行；以及通过调用 onTransitionEnd 方法执行变更 status 的逻辑。onTransitionEnd 方法的延迟机制通过监听 transitionEnd 事件（借助于 props.addEventLinstener 配置）或者使用 setTimeout 执行回调实现，变更 status 状态的回调通过 setNextCallback 方法免于多次执行。</p>
<p>Transition 容器在根据 props.in, props.appear, props.enter, props.exit, props.mountOnEnter, props.unmountOnExit 属性自动处理 status 状态的同时，还设置了多个在适当时机执行的钩子函数，包含 props.onEnter, props.onEntering, props.onEntered, props.onExit, props.onExiting, props.onExited 配置项。</p>
<h3 id="CSSTransition"><a href="#CSSTransition" class="headerlink" title="CSSTransition"></a>CSSTransition</h3><p>在 react-transition-group 2 版本内部，props.onEnter 等钩子在实现 CSSTransition 组件时极有意义。因为 Transition 容器传给 props.children 函数的 status 只包含 enter, exit 相关状态，没有 appear 状态。而 onEnter, onEntering, onEntered 钩子的次参即为是否在 appear 状态中（通过 context.transitionGroup.isMounting 或 mounting 获知），CSSTransition 组件即在此基础上实现，通过钩子更新 props.children 对应节点的 class（依次由 <em>-appear, </em>-appear-active, <em>-enter, </em>-enter-active, <em>-enter-done, </em>-exit, <em>-exit-active, </em>-exit-done 变更，* 通过 props.classNames 设置，该属性也设置为对象）。与 1 版本相同，2 版本在类名变更的同时，访问了 node.scrollTop 促使浏览器重绘；也可以在 props.children 中执行 onEnter 等方法阻止 js 动效或懒加载等逻辑。CSSTransition 组件同样向上抛出 props.onEnter, props.onEntering, props.onEntered, props.onExit, props.onExiting, props.onExited 钩子。</p>
<h3 id="TransitionGroup"><a href="#TransitionGroup" class="headerlink" title="TransitionGroup"></a>TransitionGroup</h3><p>TransitionGroup 的处理逻辑和 1 版本相同，即通过 state.children 控制待渲染的元素，以实现 exit 动效执行时仍驻留子组件的场景。不同的是，1 版本会用 CSSTransitionGroupChild 包装子组件，2 版本需要用户传入 Transition 组件作为 TransitionGroup 的子组件。当然，因为 2 版本中，Transition 组件动效执行时机和组件渲染状态的弱关联，促使 TransitionGroup 容器的 componentWillReceiveProps 方法中更新 state.children 的逻辑也不一样。</p>
<p>TransitionGroup 的一般适用场景为当子组件添加时，执行 enter 动效；当子组件移除时，执行 exit 动效。在这样的场景中，子组件的渲染状态不受 TransitionGroup 控制，也即 TransitionGroup 容器对子组件的 props.in 属性的调控必须与子组件的渲染状态向匹配。在 TransitionGroup 容器初始化阶段，传入子组件的 props.in 属性必然为真值，因为在这阶段，子组件都会得到渲染。在更新阶段，当子组件移除时，通过设置 props.in 为否值，触发 exit 动效；当子组件 exit 动效执行阶段，子组件又被添加，通过设置 props.in 为真值，使 enter, exit 动效得以执行；当子组件 exit 动效执行完成、且组件已移除后，处理逻辑同 exit 动效执行阶段；当子组件维持原样，传入子组件的 props.in 属性维持原值，props.oEnter, props.onExit 属性则同步为子组件最新的 props 值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constructor</span>(props, context) &#123;</span><br><span class="line">  <span class="keyword">super</span>(props, context);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initial children should all be entering, dependent on appear</span></span><br><span class="line">  <span class="keyword">this</span>.state = &#123;</span><br><span class="line">    children: getChildMapping(props.children, child =&gt; &#123;</span><br><span class="line">      <span class="keyword">return</span> cloneElement(child, &#123;</span><br><span class="line">        onExited: <span class="keyword">this</span>.handleExited.bind(<span class="keyword">this</span>, child),</span><br><span class="line">        <span class="keyword">in</span>: <span class="literal">true</span>,</span><br><span class="line">        appear: <span class="keyword">this</span>.getProp(child, <span class="string">'appear'</span>),</span><br><span class="line">        enter: <span class="keyword">this</span>.getProp(child, <span class="string">'enter'</span>),</span><br><span class="line">        exit: <span class="keyword">this</span>.getProp(child, <span class="string">'exit'</span>),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;),</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">componentWillReceiveProps(nextProps) &#123;</span><br><span class="line">  <span class="keyword">let</span> prevChildMapping = <span class="keyword">this</span>.state.children;</span><br><span class="line">  <span class="keyword">let</span> nextChildMapping = getChildMapping(nextProps.children);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> children = mergeChildMappings(prevChildMapping, nextChildMapping);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Object</span>.keys(children).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> child = children[key]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isValidElement(child)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> hasPrev = key <span class="keyword">in</span> prevChildMapping;</span><br><span class="line">    <span class="keyword">const</span> hasNext = key <span class="keyword">in</span> nextChildMapping;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> prevChild = prevChildMapping[key];</span><br><span class="line">    <span class="comment">// child 在移除过程中</span></span><br><span class="line">    <span class="keyword">const</span> isLeaving = isValidElement(prevChild) &amp;&amp; !prevChild.props.in;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// child 新添加或者移除动效尚未执行完成，执行 enter 动效</span></span><br><span class="line">    <span class="keyword">if</span> (hasNext &amp;&amp; (!hasPrev || isLeaving)) &#123;</span><br><span class="line">      <span class="comment">// console.log('entering', key)</span></span><br><span class="line">      children[key] = cloneElement(child, &#123;</span><br><span class="line">        onExited: <span class="keyword">this</span>.handleExited.bind(<span class="keyword">this</span>, child),</span><br><span class="line">        <span class="keyword">in</span>: <span class="literal">true</span>,</span><br><span class="line">        exit: <span class="keyword">this</span>.getProp(child, <span class="string">'exit'</span>, nextProps),</span><br><span class="line">        enter: <span class="keyword">this</span>.getProp(child, <span class="string">'enter'</span>, nextProps),</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 组件已移除，执行 exit 动效</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!hasNext &amp;&amp; hasPrev &amp;&amp; !isLeaving) &#123;</span><br><span class="line">      <span class="comment">// console.log('leaving', key)</span></span><br><span class="line">      children[key] = cloneElement(child, &#123; <span class="attr">in</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 组件动效特性未作改变，保留原值</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (hasNext &amp;&amp; hasPrev &amp;&amp; isValidElement(prevChild)) &#123;</span><br><span class="line">      <span class="comment">// console.log('unchanged', key)</span></span><br><span class="line">      children[key] = cloneElement(child, &#123;</span><br><span class="line">        onExited: <span class="keyword">this</span>.handleExited.bind(<span class="keyword">this</span>, child),</span><br><span class="line">        <span class="keyword">in</span>: prevChild.props.in,</span><br><span class="line">        exit: <span class="keyword">this</span>.getProp(child, <span class="string">'exit'</span>, nextProps),</span><br><span class="line">        enter: <span class="keyword">this</span>.getProp(child, <span class="string">'enter'</span>, nextProps),</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.setState(&#123; children &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>handleExited 方法用于当子组件 exit 动效执行完成且移除后，更新 TransitionGroup 容器的 state.children 属性，附带调用原始传入子组件的 props.onExited 方法（实际传入子组件的 props.onExited 方法被改写为 handleExited 方法）。</p>
<p>在变更 state.children 的处理逻辑之外，TransitionGroup 向外提供 props.appear, props.enter, props.exit, props.component, props.childFactory 配置项。props.appear, props.enter, props.exit 为当子组件元素没有同名 props 属性时，使用 TransitionGroup 容器的 props 属性；props.component 为外层包裹元素（适配 react 中 props.children 不能置为数组的特性，react 16 可能不需要）；props.childFactory 用于装饰子元素。</p>
<p>2 版本没有提供 CSSTransitionGroup 组件，因为在 TransitionGroup 组件下挂载 CSSTransition 组件即能实现与 1 版本中 CSSTransitionGroup 相同的效果，通过调整节点的 class 实现动效。在这里，CSSTransition 组件作为特殊的 Transition 组件。除此而外，Transition, CSSTransition 组件都向外暴露 props.onEnter, props.onEntering, props.onEntered, props.onExit, props.onExiting, props.onExited 配置钩子，因此相较于 1 版本中通过 CSSTransitionGroup 自应用的 CSSTransitionGroupChild 组件，2 版本能对 css 动效实现更细微的控制。</p>
<p>此外，TransitionGroup 组件会通过 context 属性向 Transition 子组件传递 transitionGroup 属性，以使 Transition 子组件能够感知动效处于 appear 阶段还是 enter 阶段。Transition 组件又通过 getChildContext 方法，将其子孙组件的 transitionGroup 属性置为 null，其意义时，当父 Transition 嵌套子 Transition 时，子 Transition 不至于尝试通过 context.transitionGroup 属性判断动效在 appear 阶段还是 enter 阶段。</p>
<h3 id="ReplaceTransition"><a href="#ReplaceTransition" class="headerlink" title="ReplaceTransition"></a>ReplaceTransition</h3><p>2 版本中，ReplaceTransition 用于通过控制 props.in 切换显示两个子组件中的一个。因此实际使用过程中，需要有容器包裹，通过容器更新传入 ReplaceTransition 组件中的props.in；循环切换需要在容器中设置定时器（循环切换过程中，不支持其中任意一个子组件 exit 动效，适用场景相对较小）。ReplaceTransition 组价向外提供 props.onEnter, props.onEntering, props.onEntered, props.onExit, props.onExiting, props.onExited 等配置属性，前三个为第一个子组件 enter 动效相关钩子，后三个为第二个子组件 enter 动效相关钩子。其 ReplaceTransition 组价支持在 enter 发生过程中调用子组件的 props.onEnter, props.onEntering, props.onEntered, props.onExit, props.onExiting, props.onExited，前三个钩子为第一个子组件独有，后三个为第二个子组件独有。源码不作赘述。</p>
<h2 id="反思"><a href="#反思" class="headerlink" title="反思"></a>反思</h2><p>无论 1 版本的核心模块 TransitionGroup，还是 2 版本的核心模块 Transition，都通过容器管理子组件的动效执行过程。1 版本切入的视角在于通过判断子组件从列表中创建、移除的过程，触发调用子组件的 componentWillAppear 等方法，以管理动效。对于 css 动效，1 版本又通过包含特定 componentWillAppear 等实例方法的 CSSTransitionGroupChild 包装用户实际开发的子组件，从而对接上 TransitionGroup 容器，使子组件中的动效得到管理。2 版本在处理上更为细致，独立对待用户开发的动效组件，而不是视为列表形式。2 版本通过 Transition 容器将子组件可能包含的 enter, exit 动效抽象为 state.status，并传入子组件，由子组件自身通过 status 启用特定的动效；并且同样提供了以钩子方式（props.onEnter 等配置方法）管理动效的实现，2 版本自身的 CSSTransition 组件即通过钩子调节添加到节点上的 class。若说 1 版本还滞留于子组件从列表中移入移出的视点，2 版本的观察角度则从列表中脱离，实打实地介入了子组件动效执行周期的管理，will - excute - did，并向下注入执行状态。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/12/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><span class="page-number current">13</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/14/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpeg" alt="Alfred">
            
              <p class="site-author-name" itemprop="name">Alfred</p>
              <p class="site-description motion-element" itemprop="description">人苦不知足，既得陇，复望蜀</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">135</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    <span class="site-state-item-count">38</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    <span class="site-state-item-count">26</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Alfred-sg" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/xiu-fan-79/activities" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-globe"></i>知乎</a>
                  </span>
                
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Alfred</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Pisces</a> v6.0.2</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.0.2"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.2"></script>



  

  
    <script id="dsq-count-scr" src="https://alfred.disqus.com/count.js" async></script>
  

  





	





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->





  

  

  

  

  
  

  

  

  

  

</body>
</html>
