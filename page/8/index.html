<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.0.2" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.2">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.2" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.0.2',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="Hexo, NexT">


<meta name="description" content="人苦不知足，既得陇，复望蜀">
<meta property="og:type" content="website">
<meta property="og:title" content="修子范语">
<meta property="og:url" content="http://yoursite.com/page/8/index.html">
<meta property="og:site_name" content="修子范语">
<meta property="og:description" content="人苦不知足，既得陇，复望蜀">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="修子范语">
<meta name="twitter:description" content="人苦不知足，既得陇，复望蜀">






  <link rel="canonical" href="http://yoursite.com/page/8/">


  <title>修子范语</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">修子范语</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Alfredo's Notes</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/01/antd/react-component/dom-align/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/01/antd/react-component/dom-align/" itemprop="url">dom-align</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-01T00:00:00+08:00">2019-02-01</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/antd-组件库/" itemprop="url" rel="index"><span itemprop="name">antd 组件库</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/02/01/antd/react-component/dom-align/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/02/01/antd/react-component/dom-align/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="工具函数"><a href="#工具函数" class="headerlink" title="工具函数"></a>工具函数</h2><ul>
<li>utils.getWindow(node): 获取 node 节点所属的 window 对象。</li>
<li>utils.getDocument(node): 获取 node 节点所属的 document 对象。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/01/antd/react-component/rc-align/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/01/antd/react-component/rc-align/" itemprop="url">rc-align</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-01T00:00:00+08:00">2019-02-01</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/antd-组件库/" itemprop="url" rel="index"><span itemprop="name">antd 组件库</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/02/01/antd/react-component/rc-align/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/02/01/antd/react-component/rc-align/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="dom-align"><a href="#dom-align" class="headerlink" title="dom-align"></a>dom-align</h2><h3 id="工具函数"><a href="#工具函数" class="headerlink" title="工具函数"></a>工具函数</h3><ul>
<li>utils.getWindow(node): 获取 node 节点所属的 window 对象。</li>
<li><p>utils.getDocument(node): 获取 node 节点所属的 document 对象。</p>
</li>
<li><p>isAncestorFixed(element): 判断祖先元素是否固定定位。</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/31/react/react相关/react-router源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/31/react/react相关/react-router源码分析/" itemprop="url">react-router</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-31T00:00:00+08:00">2019-01-31</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端路由/" itemprop="url" rel="index"><span itemprop="name">前端路由</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/01/31/react/react相关/react-router源码分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/01/31/react/react相关/react-router源码分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="react-router"><a href="#react-router" class="headerlink" title="react-router"></a>react-router</h2><p>基于 <a href="http://xzfyu.com/2019/01/27/history%E6%BA%90%E7%A0%81/" target="_blank" rel="noopener">history</a> 创建的 history 对象、以及 <a href="https://github.com/jamiebuilds/create-react-context" target="_blank" rel="noopener">create-react-context</a> 为上下游组件传递 context 数据，上游的 Router 组件用于监听地址栏的变更，随后将 history 对象以及当前的 state.location 信息写入 context；下游的 Route 组件通过工具函数 matchPath 判断 location.pathname 是否匹配 props.path，以此渲染出内容。</p>
<p>在这种机制下，存在两个问题：如果 location.pathname 与多个 Route 匹配时，react-router 将会渲染出这几个 Route 的内容；如果嵌套使用的 Route 元素均需要与 location.pathname 当前的地址栏信息加以比较的话，那么这个 Route 元素的 props.path 属性也需要感知父 Route 元素的 props.path 信息。针对第一个问题，react-router 提供了 Switch 组件。借助 Switch 组件，react-router 将只渲染首个匹配的 Route 元素，且为子组件注入 props.computedMatch 属性（以避免 matchPath 的多次调用）。针对第二个问题，react-router 通过 Switch 组件或父 Route 组件向子组件注入 props.match 属性，再通过 match.path 设置子 Route 的 props.path 属性（参见 <a href="https://reacttraining.com/react-router/web/example/basic" target="_blank" rel="noopener">basic 示例</a>）。</p>
<p>除了改变子组件的 props.match 属性外，Switch 和 Route 组件均能改变子组件的 props.location 属性。react-router 以 <a href="https://reacttraining.com/react-router/web/example/animated-transitions" target="_blank" rel="noopener">Animated Transitions 示例</a> 指出 props.location 属性可应用于动效渲染场景。在示例中，react-router 使用指定 location 属性的 Switch 组件包裹前后两个页面级渲染内容，再经由指定 key 键为 location.key 的 CSSTransition 组件包裹（指定 key 键是为了在 CSSTransition 组件重绘期间，使该组件一前一后、卸载再挂载的机制切合视图上的移入移出动效），而后统一由 TransitionGroup 组件管理 CSSTransition 组件的动效切换过程。这样就可以实现：在地址栏变更过程中，前一个 CSSTransition 组件同步驻留，执行完隐藏动效后再移出；后一个 CSSTransition 组件执行完显示动效后再移入。</p>
<p>顺带指出的是，因为 Route 或 Switch 组件都可以指定动态的 props.location 属性，那就可以设想如下的黑魔法：自定义的、且与历史堆栈无甚关联的动态 location 属性将主导子 Route 的渲染状态。当然，这一黑魔法并不规范，理应避免使用。</p>
<p>在 Router 之外，react-router 还提供 MemoryRouter, StaticRouter 组件。MemoryRouter 组件可根据虚拟的缓存历史堆栈控制子 Route 的渲染状态，适用于测试或 native 环境。StaticRouter 组件适用于服务端渲染：react-router 会根据地址栏渲染出指定的内容，因此可以在 node 端设定 controller 对不同的前端路由统一发送 html 内容（通过 ReactDOMServer.renderToString 获得指定路由的 html 内容）；但是当地址栏与前端路由不匹配时，我们需要跳转到 404 页面，react-router 就会通过 StaticRouter 组件的机制在 ReactDOMServer.renderToString 方法执行期间，使用 content 引用对象收集待 404 页面地址，然后在 node 端进行重定向。引用对象 content 收集数据的方式有两种：第一种在虚拟跳转页面环节（为此，react-router 为 StaticRouter 组件提供了特定的 push, replace 方法实现）；第二种在待渲染页面 render 期间对 content 属性进行赋值。当然，这两种收集方式都在 ReactDOMServer.renderToString 方法执行期间完成。以上机制，可参考官方的 <a href="https://reacttraining.com/react-router/web/guides/server-rendering" target="_blank" rel="noopener">Server Rendering 示例</a>。</p>
<p>上一个段落的 ReactDOMServer.renderToString 方法执行期间，前端代码会虚拟地重定向到 404 页面；node 端再通过 context 感知到这一虚拟重定向过程，然后再发起真实的重定向。在这个过程中，虚拟重定向是由 Redirect 组件完成的。在 react-router4 中，Redirect 组件的机制就是在组件的生命周期中跳转页面、或者在渲染期间改变 context 的属性（服务端渲染时，将待跳转页面上报给 node 服务器），并无其他内容。因此，如果不需要重定向，就需要条件语句控制 Redirect 组件的渲染。参考 <a href="https://reacttraining.com/react-router/web/example/auth-workflow" target="_blank" rel="noopener">Redirects (Auth) 示例</a>。</p>
<p>在 Redirect 组件之外，借助 history 库封装的 block 方法，Prompt 组件用于拦截地址栏的变更，如默认会使用 window.confirm 提醒用户是否要进行跳转。Prompt 组件按两种条件决定是否需要对用户进行提示，其一是 props.when 属性，当其为真值进入条件二（因此可以将 state 状态赋值给 props.when 以设定条件）；其二是 props.message 属性，即 history 库中的 prompt，该值可以为函数，允许开发者根据待变更地址的 location, action 动态加以判断，是否需要提示用户。</p>
<p>我们用下图表示上文中组件的层级关系（虚线表示可有无可）：<br><img src="/2019/01/31/react/react相关/react-router源码分析/react-router层级关系.png"></p>
<p>以下列表简要概括各组价的输出能力和特点：</p>
<ul>
<li>StaticRouter: 服务器端渲染时，配合收集跳转页面地址并完成服务器端重定向。</li>
<li>MemoryRouter: native 环境使用虚拟历史堆栈实现前端路由。</li>
<li>Router: 将真实或虚拟的路由信息注入到子组件中，以控制 Route 内容的渲染。</li>
<li>Switch: 控制渲染首个匹配路由信息的 Route 内容。</li>
<li>Route: 设定单个路由规则，匹配时渲染内容。渲染内容可以是 children, Component, render 懒加载。其中，children 可以 React 元素，或 render props 形式。</li>
<li>Render: 作为 Route 下的渲染内容。</li>
<li>Redirect: 渲染时即重定向。</li>
<li>Prompt: 拦截地址栏变更。</li>
</ul>
<h3 id="RouterContext"><a href="#RouterContext" class="headerlink" title="__RouterContext"></a>__RouterContext</h3><p>基于 <a href="https://github.com/jamiebuilds/create-react-context" target="_blank" rel="noopener">create-react-context</a>，__RouterContext 用于为上下游组件传递 context。</p>
<h3 id="withRouter"><a href="#withRouter" class="headerlink" title="withRouter"></a>withRouter</h3><p>withRouter 装饰器将构造 HOC 组件，用于将 context 内容注入到子组件的 props 中。并且，HOC 组件基于 <a href="https://github.com/mridgway/hoist-non-react-statics" target="_blank" rel="noopener">hoist-non-react-statics</a>，拷贝了原始组件的非 react 类静态属性或方法。</p>
<h3 id="工具函数"><a href="#工具函数" class="headerlink" title="工具函数"></a>工具函数</h3><ul>
<li>Lifecycle: 生命周期方法管理组件。</li>
<li>generatePath(path, params): 基于 <a href="https://github.com/pillarjs/path-to-regexp" target="_blank" rel="noopener">path-to-regexp</a>，将路径规则 path 和路由参数 params 解析为实际的路径。实现上，根据路径规则的解析函数会以对象形式缓存在内存中。</li>
<li>matchPath(pathname, { path, exact, strict, sensitive }): 基于 <a href="https://github.com/pillarjs/path-to-regexp" target="_blank" rel="noopener">path-to-regexp</a>，将实际路径 pathname 解析为 { path, url, isExact, params } 形式。其中，path 为路径规则；url 为匹配的路径内容；isExact 指实际路径 path 和路径规则 pathname 是否相等；params 为路由参数。</li>
</ul>
<h2 id="react-router-config"><a href="#react-router-config" class="headerlink" title="react-router-config"></a>react-router-config</h2><p>react-router-config 输出如下两个工具函数：</p>
<ul>
<li>matchRoutes(routes, pathname): 从类树形结构的路由中获取当前匹配的路由节点分叉。主要针对 react-router4 没有在全局层面缓存全量的路由配置信息，路由配置散落在 Route 组件中。</li>
<li>renderRoutes(routes, extraProps, switchProps): 使用 Switch, Route 组件渲染单层结构的数组路由 routes。</li>
</ul>
<h2 id="react-router-dom"><a href="#react-router-dom" class="headerlink" title="react-router-dom"></a>react-router-dom</h2><p>基于 react-router 包，react-router-dom 针对浏览器环境提供了如下组件：</p>
<ul>
<li>BrowserRouter: 使用 history 库输出的 createBrowserHistory，构建前端路由。</li>
<li>HashRouter: 使用 history 库输出的 createBrowserHistory, 构建 hash 路由。</li>
<li>Link: 基于 __RouterContext，绘制 a 标签跳转链接。在配置 props.onClick 方法的情景中，可以采用采用浏览器机制跳转。</li>
<li>NavLink: 根据路由匹配情况，为 Link 元素设置特殊的样式。</li>
</ul>
<h2 id="react-router-native"><a href="#react-router-native" class="headerlink" title="react-router-native"></a>react-router-native</h2><p>基于 react-router 包，react-router-dom 针对 native 环境提供了如下组件：</p>
<ul>
<li>NativeRouter: 基于 MemoryRouter 组件，构建前端路由。默认的 props.getUserConfirmation 方法通过 react-native 输出的 Alert 实现。</li>
<li>BackButton: 基于 react-native 输出的 BackHandler 绑定 hardwareBackPress 事件，实现点击 back 按钮回退页面的功能。</li>
<li>Link: 通过为 props.Component 组件绑定 onPress 事件并渲染，实现页面跳转。</li>
<li>DeepLinking: 基于 react-native 输出的 Linking 绑定 url 事件，以使 Linking.openURL 调用过程中移除参数 url 中 ‘://‘ 及其前的内容。关于深度链接，可参看 <a href="https://www.jianshu.com/p/117a2cd510a6" target="_blank" rel="noopener">浅析移动应用深度链接 (Deeplinking)</a>， <a href="https://facebook.github.io/react-native/docs/linking.html" target="_blank" rel="noopener">Linking</a>。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文的写作基于反向演绎，缺少遇到问题时正向推理的顺畅感，又介于笔者水平有限，文中难免谬误，仍望海涵。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/27/react/react相关/history源码/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/27/react/react相关/history源码/" itemprop="url">history</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-27T00:00:00+08:00">2019-01-27</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端路由/" itemprop="url" rel="index"><span itemprop="name">前端路由</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/01/27/react/react相关/history源码/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/01/27/react/react相关/history源码/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>history 库基于 html5 的 history 接口，用于操控和观察浏览器地址栏的变更。本文分为两部分：介绍 html5 的 history 接口；再介绍 history 库的实现。</p>
<h2 id="history-接口"><a href="#history-接口" class="headerlink" title="history 接口"></a>history 接口</h2><p>为实现浏览器地址栏变更，又不至使页面刷新，html 提供了 history.pushState(state, title, url) 方法。该方法结合 ajax 请求一起使用，就可以实现地址栏变更时的局部刷新。实现详情可参阅 <a href="http://diveintohtml5.info/history.html" target="_blank" rel="noopener">MANIPULATING HISTORY FOR FUN &amp; PROFIT</a> 这篇文章。同时，这篇文章也指出，若想保证回退按钮也实现局部刷新，须监听 popstate 事件。以下整理的是 mozilla 开列的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/History" target="_blank" rel="noopener">history 文档</a>。</p>
<ul>
<li>history.length: 存储在回话历史堆栈中的元素数量。</li>
<li>history.state: 获取栈顶——历史堆栈入口的状态值。</li>
<li>history.back(): 前往上一页，浏览器的回退按钮可以模拟此方法。</li>
<li>history.forward(): 前往下一页，浏览器的前进按钮可以模拟此方法。</li>
<li>history.go(num): 前往历史堆栈中的指定页面。</li>
<li>history.pushState(state, title, url): 将数据压入历史堆栈中。state 数据量须小于 640kb，firefox 会将其保存到本地磁盘中。firefox 也会忽略 title 参数。这一过程将触发 popstate 事件，但不会触发 hashchange 事件。</li>
<li>history.replaceState(state, title, url): 替换历史堆栈入口的数据。</li>
<li>popstate: 当历史堆栈入口数据变更时，均会触发 popstate 事件，包含调用 history.back, history.forward, history.go 方法，以及点击前进、回退按钮。history.pushState, history.replaceState 方法不会触发 popstate 事件。</li>
<li>window.onpopstate = (event) =&gt; {}; window.addEventListener(‘popstate’, (event) =&gt; {}): 监听 popstate 事件。</li>
<li>hashchange: hash 路径变更，将会触发 hashchange 事件。</li>
<li>window.onhashchange = (event) =&gt; {}; window.addEventListener(‘hashchange’, (event) =&gt; {}): 监听 hashchange 事件。</li>
</ul>
<h2 id="history-库"><a href="#history-库" class="headerlink" title="history 库"></a>history 库</h2><p>history 库创建了一个虚拟的 history 对象，以操纵浏览器地址栏的变更（createBrowserHistory）、或者操纵 hash 路径的变更（createHashHistory）、或者管理内存中的虚拟历史堆栈（createMemoryHistory）。各 history 对象均含有如下属性或方法：</p>
<ul>
<li>push(path, state): 往历史堆栈中压入数据。</li>
<li>replace(path, state): 变更历史堆栈入口数据。</li>
<li>go, goBack, goForward: 根据历史堆栈信息进行跳页。</li>
<li>block(prompt): 根据条件 prompt 阻断地址栏变更。</li>
<li>listen((location, action) =&gt; {}): 监听地址栏变更。</li>
<li>length: 历史堆栈中的数据量。</li>
<li>action: history 前次执行的方法名，值包含 ‘POP’, ‘PUSH’, ‘REPLACE’。</li>
<li>location: 历史堆栈入口的数据内容，数据结构为 { pathname, search, hash, key, state }，通过 LocationUtils.createLocation 创建。</li>
</ul>
<p>监听函数 listener 会在地址栏变更后予以执行。实现上，history 先收集历史堆栈入口的变更数据，并写入虚拟的 history 对象中，然后再执行 listener。这一过程表现为 createBrowserHistory, createHashHistory, createMemoryHistory 模块中的 setState 函数。因此，通过 pushState, replaceState, go 方法，或者通过对 location 对象赋值变更地址栏后，就可以调用 setState 执行监听函数了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setState</span>(<span class="params">nextState</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">Object</span>.assign(history, nextState);</span><br><span class="line">  history.length = globalHistory.length;</span><br><span class="line">  transitionManager.notifyListeners(history.location, history.action);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>history 有两种阻断地址栏变更的方法：在变更前拦截；在变更后回滚。相对于变更地址栏的三种方式：对 location 对象直接赋值，或者调用 pushState, replaceState 方法，或者调用 go 方法。前两种方法，我们都知道地址栏将要变更为何值，因此 history 选择在变更前拦截；后一种方法，我们不知道地址栏将会变更为何值，因此 history 选择在变更后回滚。实现上，history 使用 transitionManager.confirmTransitionTo 包裹前两种方法的调用过程；通过监听 popstate, hashchange 事件获得变更后的 location 数据，同样使用 transitionManager.confirmTransitionTo 判断是否需要回滚，还是维持现状。回滚机制的典型实现如 createBrowserHistory, createHashHistory 模块中的 handlePop 函数等。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 回滚到前几页时，跳过回滚机制</span></span><br><span class="line"><span class="keyword">let</span> forceNextPop = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handlePop</span>(<span class="params">location</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (forceNextPop) &#123;</span><br><span class="line">    forceNextPop = <span class="literal">false</span>;</span><br><span class="line">    setState();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> action = <span class="string">'POP'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过 prompt 判断是否需要回滚</span></span><br><span class="line">    transitionManager.confirmTransitionTo(</span><br><span class="line">      location,</span><br><span class="line">      action,</span><br><span class="line">      getUserConfirmation,</span><br><span class="line">      ok =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">          <span class="comment">// 维持现状</span></span><br><span class="line">          setState(&#123; action, location &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 回滚</span></span><br><span class="line">          revertPop(location);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">revertPop</span>(<span class="params">fromLocation</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> toLocation = history.location;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> We could probably make this more reliable by</span></span><br><span class="line">  <span class="comment">// keeping a list of keys we've seen in sessionStorage.</span></span><br><span class="line">  <span class="comment">// Instead, we just default to 0 for keys we don't know.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// allKeys 缓存历史堆栈中的数据标识</span></span><br><span class="line">  <span class="keyword">let</span> toIndex = allKeys.indexOf(toLocation.key);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (toIndex === <span class="number">-1</span>) toIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> fromIndex = allKeys.indexOf(fromLocation.key);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fromIndex === <span class="number">-1</span>) fromIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> delta = toIndex - fromIndex;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (delta) &#123;</span><br><span class="line">    forceNextPop = <span class="literal">true</span>;</span><br><span class="line">    go(delta);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>transitionManager 由 createTransitionManager 模块创建，提供了如下四种方法：</p>
<ul>
<li>appendListener(fn)：添加 fn 监听函数，返回函数可用于移除添加的监听函数。</li>
<li>notifyListeners(…args)：执行所有已添加的监听函数。</li>
<li>setPrompt(nextPrompt)：字符串时为提示；函数形式 (location, action) =&gt; {} 既可用于判断变更条件是否达成，或者输出提示文案；布尔值作为变更条件判断的结果。</li>
<li>confirmTransitionTo(location, action, getUserConfirmation, callback)：变更地址栏时，通过 prompt 判断变更条件是否达成或者获取提示文案；若取得提示文案，由 getUserConfirmation = (prompt, callback) =&gt; {} 设定 callback 的调用机制，否则以变更条件达成与否的状态值作为 callback 的参数，并执行 callback 回调。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">confirmTransitionTo</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  location,</span></span></span><br><span class="line"><span class="function"><span class="params">  action,</span></span></span><br><span class="line"><span class="function"><span class="params">  getUserConfirmation,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> If another transition starts while we're still confirming</span></span><br><span class="line">  <span class="comment">// the previous one, we may end up in a weird state. Figure out the</span></span><br><span class="line">  <span class="comment">// best way to handle this.</span></span><br><span class="line">  <span class="keyword">if</span> (prompt != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> result =</span><br><span class="line">      <span class="keyword">typeof</span> prompt === <span class="string">'function'</span> ? prompt(location, action) : prompt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> result === <span class="string">'string'</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> getUserConfirmation === <span class="string">'function'</span>) &#123;</span><br><span class="line">        getUserConfirmation(result, callback);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        warning(</span><br><span class="line">          <span class="literal">false</span>,</span><br><span class="line">          <span class="string">'A history needs a getUserConfirmation function in order to use a prompt message'</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        callback(<span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Return false from a transition hook to cancel the transition.</span></span><br><span class="line">      callback(result !== <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    callback(<span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>基于以上触发监听函数、阻断地址栏变更的机制，下面我们一一揭开 createBrowserHistory, createHashHistory, createMemoryHistory 模块的面纱。</p>
<h3 id="createBrowserHistory"><a href="#createBrowserHistory" class="headerlink" title="createBrowserHistory"></a>createBrowserHistory</h3><p>createBrowserHistory 基于 html5 中的 pushState, replaceState 变更地址栏。地址栏变更内容不限于 hash 路径。当浏览器不支持 html5 的 history 接口时，createBrowserHistory 将直接变更 location.href 或者调用 location.replace 方法实现地址栏变更。</p>
<p>首先，createBrowserHistory 接受 props 参数。其中，props.forceRefresh 设定以刷新页面的形式变更地址栏；getUserConfirmation 配合 browserHistory.block 方法，可根据地址栏变更信息决定是否允许本次变更；props.keyLength 决定每条历史数据标识符 key 键的长度；props.basename 设置地址栏变更的基本路径。</p>
<p>其次，实现 push, replace 方法，用于变更历史入口。在支持 html5 history 接口的浏览器中，createBrowserHistory 将调用 setState 方法监听函数的执行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">push</span>(<span class="params">path, state</span>) </span>&#123;</span><br><span class="line">  warning(</span><br><span class="line">    !(</span><br><span class="line">      <span class="keyword">typeof</span> path === <span class="string">'object'</span> &amp;&amp;</span><br><span class="line">      path.state !== <span class="literal">undefined</span> &amp;&amp;</span><br><span class="line">      state !== <span class="literal">undefined</span></span><br><span class="line">    ),</span><br><span class="line">    <span class="string">'You should avoid providing a 2nd state argument to push when the 1st '</span> +</span><br><span class="line">      <span class="string">'argument is a location-like object that already has state; it is ignored'</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> action = <span class="string">'PUSH'</span>;</span><br><span class="line">  <span class="keyword">const</span> location = createLocation(path, state, createKey(), history.location);</span><br><span class="line"></span><br><span class="line">  transitionManager.confirmTransitionTo(</span><br><span class="line">    location,</span><br><span class="line">    action,</span><br><span class="line">    getUserConfirmation,</span><br><span class="line">    ok =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (!ok) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> href = createHref(location);</span><br><span class="line">      <span class="keyword">const</span> &#123; key, state &#125; = location;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (canUseHistory) &#123;</span><br><span class="line">        globalHistory.pushState(&#123; key, state &#125;, <span class="literal">null</span>, href);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (forceRefresh) &#123;</span><br><span class="line">          <span class="built_in">window</span>.location.href = href;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> prevIndex = allKeys.indexOf(history.location.key);</span><br><span class="line">          <span class="keyword">const</span> nextKeys = allKeys.slice(</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            prevIndex === <span class="number">-1</span> ? <span class="number">0</span> : prevIndex + <span class="number">1</span></span><br><span class="line">          );</span><br><span class="line"></span><br><span class="line">          nextKeys.push(location.key);</span><br><span class="line">          allKeys = nextKeys;</span><br><span class="line"></span><br><span class="line">          setState(&#123; action, location &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        warning(</span><br><span class="line">          state === <span class="literal">undefined</span>,</span><br><span class="line">          <span class="string">'Browser history cannot push state in browsers that do not support HTML5 history'</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="built_in">window</span>.location.href = href;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">replace</span>(<span class="params">path, state</span>) </span>&#123;</span><br><span class="line">  warning(</span><br><span class="line">    !(</span><br><span class="line">      <span class="keyword">typeof</span> path === <span class="string">'object'</span> &amp;&amp;</span><br><span class="line">      path.state !== <span class="literal">undefined</span> &amp;&amp;</span><br><span class="line">      state !== <span class="literal">undefined</span></span><br><span class="line">    ),</span><br><span class="line">    <span class="string">'You should avoid providing a 2nd state argument to replace when the 1st '</span> +</span><br><span class="line">      <span class="string">'argument is a location-like object that already has state; it is ignored'</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> action = <span class="string">'REPLACE'</span>;</span><br><span class="line">  <span class="keyword">const</span> location = createLocation(path, state, createKey(), history.location);</span><br><span class="line"></span><br><span class="line">  transitionManager.confirmTransitionTo(</span><br><span class="line">    location,</span><br><span class="line">    action,</span><br><span class="line">    getUserConfirmation,</span><br><span class="line">    ok =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (!ok) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> href = createHref(location);</span><br><span class="line">      <span class="keyword">const</span> &#123; key, state &#125; = location;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (canUseHistory) &#123;</span><br><span class="line">        globalHistory.replaceState(&#123; key, state &#125;, <span class="literal">null</span>, href);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (forceRefresh) &#123;</span><br><span class="line">          <span class="built_in">window</span>.location.replace(href);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> prevIndex = allKeys.indexOf(history.location.key);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (prevIndex !== <span class="number">-1</span>) allKeys[prevIndex] = location.key;</span><br><span class="line"></span><br><span class="line">          setState(&#123; action, location &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        warning(</span><br><span class="line">          state === <span class="literal">undefined</span>,</span><br><span class="line">          <span class="string">'Browser history cannot replace state in browsers that do not support HTML5 history'</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="built_in">window</span>.location.replace(href);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其次，基于原生的 history 对象实现 go, goBack, goForward 方法。此种变更地址栏的方式可以触发 popstate 或 hashchange 事件。</p>
<p>最后，实现 block 方法阻断地址栏变更；listen 方法监听地址栏变更。两者都会绑定 popstate 或 hashchange 事件的回调函数。通过这两个事件判断本次变更是否需要回滚、以及触发 listener 监听函数的执行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 作为事件的绑定函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handlePopState</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Ignore extraneous popstate events in WebKit.</span></span><br><span class="line">  <span class="keyword">if</span> (isExtraneousPopstateEvent(event)) <span class="keyword">return</span>;</span><br><span class="line">  handlePop(getDOMLocation(event.state));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleHashChange</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  handlePop(getDOMLocation(getHistoryState()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绑定或清理事件的处理函数</span></span><br><span class="line"><span class="keyword">let</span> listenerCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkDOMListeners</span>(<span class="params">delta</span>) </span>&#123;</span><br><span class="line">  listenerCount += delta;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (listenerCount === <span class="number">1</span> &amp;&amp; delta === <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="built_in">window</span>.addEventListener(PopStateEvent, handlePopState);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (needsHashChangeListener)</span><br><span class="line">      <span class="built_in">window</span>.addEventListener(HashChangeEvent, handleHashChange);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (listenerCount === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">window</span>.removeEventListener(PopStateEvent, handlePopState);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (needsHashChangeListener)</span><br><span class="line">      <span class="built_in">window</span>.removeEventListener(HashChangeEvent, handleHashChange);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 阻断地址栏变更</span></span><br><span class="line"><span class="keyword">let</span> isBlocked = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">block</span>(<span class="params">prompt = false</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> unblock = transitionManager.setPrompt(prompt);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!isBlocked) &#123;</span><br><span class="line">    checkDOMListeners(<span class="number">1</span>);</span><br><span class="line">    isBlocked = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isBlocked) &#123;</span><br><span class="line">      isBlocked = <span class="literal">false</span>;</span><br><span class="line">      checkDOMListeners(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> unblock();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听地址栏变更</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">listen</span>(<span class="params">listener</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> unlisten = transitionManager.appendListener(listener);</span><br><span class="line">  checkDOMListeners(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    checkDOMListeners(<span class="number">-1</span>);</span><br><span class="line">    unlisten();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="createHashHistory"><a href="#createHashHistory" class="headerlink" title="createHashHistory"></a>createHashHistory</h3><p>createHashHistory 的处理逻辑与 createBrowserHistory 相同，只不过 createHashHistory 着眼于 hash 路径的变更。</p>
<p>createHashHistory 的参数 props 仅接受 basename, getUserConfirmation, hashType 三个属性。createHashHistory 专有的 hashType 用于设置 hash 路径的编码解码策略，默认为 ‘slash’。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hash 路径的编码解码策略集合</span></span><br><span class="line"><span class="keyword">const</span> HashPathCoders = &#123;</span><br><span class="line">  hashbang: &#123;</span><br><span class="line">    encodePath: <span class="function"><span class="params">path</span> =&gt;</span></span><br><span class="line">      path.charAt(<span class="number">0</span>) === <span class="string">'!'</span> ? path : <span class="string">'!/'</span> + stripLeadingSlash(path),</span><br><span class="line">    decodePath: <span class="function"><span class="params">path</span> =&gt;</span> (path.charAt(<span class="number">0</span>) === <span class="string">'!'</span> ? path.substr(<span class="number">1</span>) : path)</span><br><span class="line">  &#125;,</span><br><span class="line">  noslash: &#123;</span><br><span class="line">    encodePath: stripLeadingSlash,</span><br><span class="line">    decodePath: addLeadingSlash</span><br><span class="line">  &#125;,</span><br><span class="line">  slash: &#123;</span><br><span class="line">    encodePath: addLeadingSlash,</span><br><span class="line">    decodePath: addLeadingSlash</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在 createHashHistory 模块中，变更 hash 路径基于 location.hash 赋值和 location.replace 方法。同时，createHashHistory 借助 hashchange 事件实现回滚，而上述两者变更 hash 路径的方式均会触发 hashchange 事件。因此，在 push, replace 方法的实现中，待变更的地址将会写入 ignorePath 缓存中，以在 handleHashChange 绑定函数对此变更不作回滚操作。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleHashChange</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> path = getHashPath();</span><br><span class="line">  <span class="keyword">const</span> encodedPath = encodePath(path);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (path !== encodedPath) &#123;</span><br><span class="line">    <span class="comment">// Ensure we always have a properly-encoded hash.</span></span><br><span class="line">    replaceHashPath(encodedPath);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> location = getDOMLocation();</span><br><span class="line">    <span class="keyword">const</span> prevLocation = history.location;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!forceNextPop &amp;&amp; locationsAreEqual(prevLocation, location)) <span class="keyword">return</span>; <span class="comment">// A hashchange doesn't always == location change.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ignorePath === createPath(location)) <span class="keyword">return</span>; <span class="comment">// Ignore this change; we already setState in push/replace.</span></span><br><span class="line"></span><br><span class="line">    ignorePath = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    handlePop(location);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="createMemoryHistory"><a href="#createMemoryHistory" class="headerlink" title="createMemoryHistory"></a>createMemoryHistory</h3><p>createMemoryHistory 用于在内存中创建完全虚拟的历史堆栈，只缓存历史记录，但与真实的地址栏无关（不会引起地址栏变更，不会和原生的 history 对象保持同步），也与 popstate, hashchange 事件无关。</p>
<p>createMemoryHistory 的参数 props 接受 getUserConfirmation, initialEntries, initialIndex, keyLength 属性。其中，props.initialEntries 指定最初的历史堆栈内容 history.entries；props.initialIndex 指定最初的索引值 history.index。push, replace 方法均将改变 history.entries 历史堆栈内容；go, goBack, goForward 均基于  history.entries 历史堆栈内容，以改变 history.index 及 history.location。实现参见源码。</p>
<h3 id="工具函数"><a href="#工具函数" class="headerlink" title="工具函数"></a>工具函数</h3><h4 id="PathUtils"><a href="#PathUtils" class="headerlink" title="PathUtils"></a>PathUtils</h4><p>路径相关操作。</p>
<ul>
<li>addLeadingSlash(path)：酌情为 path 路径添加前缀 ‘/‘。</li>
<li>stripLeadingSlash(path)：酌情为 path 路径剔除前缀 ‘/‘。</li>
<li>hasBasename(path, prefix)：判断路径 path 是否包含前缀 prefix。</li>
<li>stripBasename(path, prefix)：酌情为 path 路径剔除前缀 prefix。</li>
<li>stripTrailingSlash(path)：酌情为 path 路径剔除后缀 ‘/‘。</li>
<li>parsePath(path)：将字符串路径 path 转换为 { pathname, search, hash } 对象。</li>
<li>createPath(location)：将 { pathname, search, hash } 对象转换为字符串路径 path。</li>
</ul>
<h4 id="LocationUtils"><a href="#LocationUtils" class="headerlink" title="LocationUtils"></a>LocationUtils</h4><p>location 对象相关操作，基于 resolve-pathname, value-equal。</p>
<ul>
<li>createLocation(path, state, key, currentLocation) 构建 location = { pathname, search, hash, key, state } 对象，pathname 将根据 currentLocation 参数进行调整。</li>
<li>locationsAreEqual(a, b) 判断两个 location 对象是否相等。</li>
</ul>
<h4 id="DOMUtils"><a href="#DOMUtils" class="headerlink" title="DOMUtils"></a>DOMUtils</h4><p>DOM 环境判断。</p>
<ul>
<li>canUseDOM 是否可以操作节点。</li>
<li>getConfirmation(message, callback) 使用 window.confirm 弹出确认框，callback 的参数可用于判断用户是否点击确认按键。</li>
<li>supportsHistory 判断浏览器平台是否支持 HTML5 history API。</li>
<li>supportsPopStateOnHashChange 判断浏览器平台是否会在 hash 路径变更时触发 popstate 事件。</li>
<li>supportsGoWithoutReloadUsingHash 使用 go(n) 变更 hash 路径时是否不会页面刷新。</li>
<li>isExtraneousPopstateEvent 判断 popstate 事件是否由无关的操作引起。iOS 平台 chrome 浏览器点击回退按钮会触发 state 为 undefined 的 popstate 事件。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/15/react/react16源码/scheduler/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/15/react/react16源码/scheduler/" itemprop="url">scheduler 源码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-15T00:00:00+08:00">2019-01-15</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/react/" itemprop="url" rel="index"><span itemprop="name">react</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/01/15/react/react16源码/scheduler/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/01/15/react/react16源码/scheduler/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>scheduler 模块用于管理重绘完成后回调的执行逻辑。在 scheduler 中，requestHostCallback 函数用于实现在重绘完成后、视线程的空闲程度以及任务预设的超时时间，以在特定的时机执行任务。在 requestHostCallback 的基础上，scheduler 使用双向链表构建含有优先级的原子任务节点，再输出添加并执行任务节点、打断任务节点执行的 api。</p>
<h2 id="requestHostCallback"><a href="#requestHostCallback" class="headerlink" title="requestHostCallback"></a>requestHostCallback</h2><p>scheduler 模块支持三种方式实现 requestHostCallback, cancelHostCallback, shouldYieldToHost, getCurrentTime 函数：一、通过 window._schedMock 或 global._schedMock 数组注入；二、通过 setTimeout 实现（实现上当 requestHostCallback 的首参 —— 任务函数尚在执行过程中，scheduler 将 requestHostCallback 作为 setTimeout 的回调函数，以使在新添加任务函数间接添加到 macrotasks 队列中，可参看源码）；三、基于 MessageChannel, requestAnimationFrame 实现（MessageChannel 用于探知线程是否空闲，requestAnimationFrame 用于与重绘机制契合）。本文着重介绍第三种方式，并用 rAF 指代 requestAnimationFrame。</p>
<p>基于 MessageChannel, requestAnimationFrame 实现的上述四种函数的功能点为：</p>
<table>
<thead>
<tr>
<th>函数名</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td>requestHostCallback(callback, absoluteTimeout)</td>
<td>在重绘完成后执行任务，并与线程的空闲程度相契合，详情见下文</td>
</tr>
<tr>
<td>cancelHostCallback</td>
<td>用于取消任务</td>
</tr>
<tr>
<td>shouldYieldToHost</td>
<td>用于判断任务是否超时、需要被打断</td>
</tr>
<tr>
<td>getCurrentTime</td>
<td>使用 performance 或 Date 对象获取当前时间</td>
</tr>
</tbody>
</table>
<p>requestHostCallback 执行的流程图为：</p>
<img src="/2019/01/15/react/react16源码/scheduler/requestHostCallback流程图.png">
<p>上图中所用的缓存值有：</p>
<table>
<thead>
<tr>
<th>缓存</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td>scheduledHostCallback</td>
<td>待执行的回调，即上图中的任务，会被刷新</td>
</tr>
<tr>
<td>timeoutTime</td>
<td>任务允许的超时时间点</td>
</tr>
<tr>
<td>isAnimationFrameScheduled</td>
<td>rAF 轮询启动状态</td>
</tr>
<tr>
<td>isMessageEventScheduled</td>
<td>消息发送中标识</td>
</tr>
<tr>
<td>isFlushingHostCallback</td>
<td>任务执行中标识</td>
</tr>
<tr>
<td>activeFrameTime</td>
<td>任务允许的超时时间点</td>
</tr>
<tr>
<td>timeoutTime</td>
<td>一帧的期望执行时长，预设为 33 ms，在视图刷新过快时会更新，值将变小</td>
</tr>
<tr>
<td>previousFrameTime</td>
<td>前一帧执行时长</td>
</tr>
<tr>
<td>frameDeadline</td>
<td>下一帧期望完成时间点，用于判断重绘后 js 线程是否空闲，还是长期占用</td>
</tr>
</tbody>
</table>
<p>实现机制上，scheduler 首先实现 requestAnimationFrameWithTimeout 函数。该函数封装 requestAnimationFrame 函数，以使任务在重绘完后才予执行；但如果一些视图操作在后台执行，requestAnimationFrame 的回调将得不到执行，因此 scheduler 使用 setTimeout 兜底。流程图中启动 rAF 轮询就是指调用 requestAnimationFrameWithTimeout； animateTick 作为 requestAnimationFrameWithTimeout 回调。在 animateTick 的实现中，若 scheduledHostCallback 非 null，scheduler 将持续调用 requestAnimationFrameWithTimeout。因此本文将这一过程称为 rAF 轮询。</p>
<p>scheduler 考虑了重绘完成后、线程可能处于紧张的场景，因此所添加的任务并没有直接作为 requestAnimationFrameWithTimeout 的回调。scheduler 使用 MessageChannel 添加 macrotasks 队列作桥接，等待线程空闲，然后再执行任务。在 animateTick 中，scheduler 将计算下一帧期望完成时间点 previousFrameTime，然后通过 port.postMessage 方法发送消息。等到 port1 接受到消息时，schdulear 将 previousFrameTime 与 currentTime 作比较：当 previousFrameTime 小于等于 currentTime 时，scheduler 认为线程不是空闲的，对于超时的任务将立即执行，对于未超时的任务将在下次重绘后予以处理；当 previousFrameTime 大于 currentTime 时，线程就是空闲的，scheduler 将立即执行。这一处理机制在 port1.onMessage 监听函数中实现（作为 macrotasks，port1 接受消息的时机将随着线程的空闲程度起变化）。</p>
<p>有了上述的处理逻辑，scheduler 在外围制作 requestHostCallback(callback, absoluteTimeout) 接口：当前如果有任务正在执行中（意为当前没有重绘任务，重绘线程是空闲的）或者所添加的任务需要立即执行，scheduler 直接调用 port.postMessage 发送消息，跳过 rAF 轮询，以使任务得到即时执行；否则，如果 rAF 轮询未启动，调用 requestAnimationFrameWithTimeout(animationTick) 启动轮询。</p>
<p>在 requestHostCallback 接口之外，cancelHostCallback 通过 scheduledHostCallback 置为 null，以中断任务的执行；shouldYieldToHost 用于比较 frameDeadline 是否小于等于 currentTime（在一帧时间外），以此推断线程是否空闲，好添加并处理新任务。以下是 requestHostCallback 函数实现的源码。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> requestAnimationFrameWithTimeout = <span class="function"><span class="keyword">function</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// schedule rAF and also a setTimeout</span></span><br><span class="line">  rAFID = localRequestAnimationFrame(<span class="function"><span class="keyword">function</span>(<span class="params">timestamp</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// cancel the setTimeout</span></span><br><span class="line">    localClearTimeout(rAFTimeoutID);</span><br><span class="line">    callback(timestamp);</span><br><span class="line">  &#125;);</span><br><span class="line">  rAFTimeoutID = localSetTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// cancel the requestAnimationFrame</span></span><br><span class="line">    localCancelAnimationFrame(rAFID);</span><br><span class="line">    callback(getCurrentTime());</span><br><span class="line">  &#125;, ANIMATION_FRAME_TIMEOUT);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> channel = <span class="keyword">new</span> MessageChannel();</span><br><span class="line"><span class="keyword">var</span> port = channel.port2;</span><br><span class="line">channel.port1.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  isMessageEventScheduled = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> prevScheduledCallback = scheduledHostCallback;</span><br><span class="line">  <span class="keyword">var</span> prevTimeoutTime = timeoutTime;</span><br><span class="line">  scheduledHostCallback = <span class="literal">null</span>;</span><br><span class="line">  timeoutTime = <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> currentTime = getCurrentTime();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> didTimeout = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 线程不空闲</span></span><br><span class="line">  <span class="keyword">if</span> (frameDeadline - currentTime &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// There's no time left in this idle period. Check if the callback has</span></span><br><span class="line">    <span class="comment">// a timeout and whether it's been exceeded.</span></span><br><span class="line">    <span class="keyword">if</span> (prevTimeoutTime !== <span class="number">-1</span> &amp;&amp; prevTimeoutTime &lt;= currentTime) &#123;</span><br><span class="line">      <span class="comment">// Exceeded the timeout. Invoke the callback even though there's no</span></span><br><span class="line">      <span class="comment">// time left.</span></span><br><span class="line">      didTimeout = <span class="literal">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// No timeout.</span></span><br><span class="line">      <span class="keyword">if</span> (!isAnimationFrameScheduled) &#123;</span><br><span class="line">        <span class="comment">// Schedule another animation callback so we retry later.</span></span><br><span class="line">        isAnimationFrameScheduled = <span class="literal">true</span>;</span><br><span class="line">        requestAnimationFrameWithTimeout(animationTick);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Exit without invoking the callback.</span></span><br><span class="line">      scheduledHostCallback = prevScheduledCallback;</span><br><span class="line">      timeoutTime = prevTimeoutTime;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (prevScheduledCallback !== <span class="literal">null</span>) &#123;</span><br><span class="line">    isFlushingHostCallback = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      prevScheduledCallback(didTimeout);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      isFlushingHostCallback = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> animationTick = <span class="function"><span class="keyword">function</span>(<span class="params">rafTime</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (scheduledHostCallback !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Eagerly schedule the next animation callback at the beginning of the</span></span><br><span class="line">    <span class="comment">// frame. If the scheduler queue is not empty at the end of the frame, it</span></span><br><span class="line">    <span class="comment">// will continue flushing inside that callback. If the queue *is* empty,</span></span><br><span class="line">    <span class="comment">// then it will exit immediately. Posting the callback at the start of the</span></span><br><span class="line">    <span class="comment">// frame ensures it's fired within the earliest possible frame. If we</span></span><br><span class="line">    <span class="comment">// waited until the end of the frame to post the callback, we risk the</span></span><br><span class="line">    <span class="comment">// browser skipping a frame and not firing the callback until the frame</span></span><br><span class="line">    <span class="comment">// after that.</span></span><br><span class="line">    requestAnimationFrameWithTimeout(animationTick);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// No pending work. Exit.</span></span><br><span class="line">    isAnimationFrameScheduled = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> nextFrameTime = rafTime - frameDeadline + activeFrameTime;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    nextFrameTime &lt; activeFrameTime &amp;&amp;</span><br><span class="line">    previousFrameTime &lt; activeFrameTime</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">if</span> (nextFrameTime &lt; <span class="number">8</span>) &#123;</span><br><span class="line">      <span class="comment">// Defensive coding. We don't support higher frame rates than 120hz.</span></span><br><span class="line">      <span class="comment">// If the calculated frame time gets lower than 8, it is probably a bug.</span></span><br><span class="line">      nextFrameTime = <span class="number">8</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// If one frame goes long, then the next one can be short to catch up.</span></span><br><span class="line">    <span class="comment">// If two frames are short in a row, then that's an indication that we</span></span><br><span class="line">    <span class="comment">// actually have a higher frame rate than what we're currently optimizing.</span></span><br><span class="line">    <span class="comment">// We adjust our heuristic dynamically accordingly. For example, if we're</span></span><br><span class="line">    <span class="comment">// running on 120hz display or 90hz VR display.</span></span><br><span class="line">    <span class="comment">// Take the max of the two in case one of them was an anomaly due to</span></span><br><span class="line">    <span class="comment">// missed frame deadlines.</span></span><br><span class="line">    activeFrameTime =</span><br><span class="line">      nextFrameTime &lt; previousFrameTime ? previousFrameTime : nextFrameTime;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    previousFrameTime = nextFrameTime;</span><br><span class="line">  &#125;</span><br><span class="line">  frameDeadline = rafTime + activeFrameTime;</span><br><span class="line">  <span class="keyword">if</span> (!isMessageEventScheduled) &#123;</span><br><span class="line">    isMessageEventScheduled = <span class="literal">true</span>;</span><br><span class="line">    port.postMessage(<span class="literal">undefined</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">requestHostCallback = <span class="function"><span class="keyword">function</span>(<span class="params">callback, absoluteTimeout</span>) </span>&#123;</span><br><span class="line">  scheduledHostCallback = callback;</span><br><span class="line">  timeoutTime = absoluteTimeout;</span><br><span class="line">  <span class="keyword">if</span> (isFlushingHostCallback || absoluteTimeout &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// Don't wait for the next frame. Continue working ASAP, in a new event.</span></span><br><span class="line">    port.postMessage(<span class="literal">undefined</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isAnimationFrameScheduled) &#123;</span><br><span class="line">    <span class="comment">// If rAF didn't already schedule one, we need to schedule a frame.</span></span><br><span class="line">    <span class="comment">// <span class="doctag">TODO:</span> If this rAF doesn't materialize because the browser throttles, we</span></span><br><span class="line">    <span class="comment">// might want to still have setTimeout trigger rIC as a backup to ensure</span></span><br><span class="line">    <span class="comment">// that we keep performing work.</span></span><br><span class="line">    isAnimationFrameScheduled = <span class="literal">true</span>;</span><br><span class="line">    requestAnimationFrameWithTimeout(animationTick);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="scheduler"><a href="#scheduler" class="headerlink" title="scheduler"></a>scheduler</h2><h3 id="callbackNode-及其执行机制"><a href="#callbackNode-及其执行机制" class="headerlink" title="callbackNode 及其执行机制"></a>callbackNode 及其执行机制</h3><p>scheduler 以首尾相连的双向链表缓存 callbackNode，每个任务节点的 previous 属性指向上一个任务节点（firstCallbackNode 的 previous 属性指向 lastCallbackNode），next 属性指向下一个任务节点（lastCallbackNode 的 next 属性指向 firstCallbackNode）。链表中的 callbackNode 以优先级（以超时时间 expirationTime 属性表示）进行排序。以双向链表构建的数据，只需要缓存 firstCallbackNode 首任务节点。</p>
<p>scheduler 针对 callbackNode 设定五种优先级，分别是 ImmediatePriority, UserBlockingPriority, NormalPriority, LowPriority, IdlePriority。优先级会影响超时时间，以上五个优先级的超时时间分别为 -1, 250, 5000, 10000, 1073741823。因此对于 ImmediatePriority 优先级的任务节点，在使用 requestHostCallback 函数处理的过程中，该任务节点就不需要经过 rAF 回调机制，而是会经由 MessageChannel 直接被处理。</p>
<p>在 callbackNode 任务节点中，callback 属性为待执行的函数，priorityLevel 为执行优先级，expirationTime 为允许的超时时间点（以当前时间 + 超时时间的方式计算）。因为 requestHostCallback 每次调用时都会刷新 scheduledHostCallback 缓存，callbackNode.callback 并不能直接作为 requestHostCallback 的参数，那样会在两次调用过程中，造成前一个任务丢失。scheduler 实际使用 flushWork 函数作为 requestHostCallback 的参数（在 ensureHostCallbackIsScheduled 函数中处理），便于批量执行双向链表中的 callbackNode.callback 函数，也不至使任务丢失。</p>
<p>flushWork 函数基于 flushFirstCallback, flushImmediateWork，以下是这三个函数的实现机制：</p>
<p>flushFirstCallback 从双向链表中取出首个任务节点并执行。若首个任务节点的 callback 返回函数，使用该函数构建新的 callbackNode 任务节点，并将该任务节点插入双向链表中：若该任务节点的优先级最高、且不只包含一个任务节点，调用 ensureHostCallbackIsScheduled，在下一次重绘后酌情执行双向链表中的任务节点；否则只将新创建的任务节点添加到双向链表中。</p>
<p>基于 flushFirstCallback，flushImmediateWork 函数用于执行双向链表中所有优先级为 ImmediatePriority 的任务节点。如果双向链表不只包含优先级为 ImmediatePriority 的任务节点，flushImmediateWork 将调用 ensureHostCallbackIsScheduled 等待下次重绘后执行剩余的任务节点。</p>
<p>flushWork 作为 requestHostCallback 函数的参数，获得的首个实参 didTimeout 为是否超时的标识。如果超时，flushWork 通过调用 flushFirstCallback 批量执行所有未超时的任务节点；若果没有超时，flushWork 将在下一帧未完成前（通过 shouldYieldToHost 函数判断）尽可能地执行任务节点。等上述条件逻辑执行完成后，如果双向链表非空，调用 ensureHostCallbackIsScheduled 等待下次重绘后执行剩余的任务节点。特别的，当双向链表中还存在 ImmediatePriority 优先级的任务节点，flushWork 将调用 flushImmediateWork 批量执行这些任务节点。</p>
<p>因为 scheduler 使用首个任务节点的超时时间点作为 requestHostCallback 函数的次参（在 ensureHostCallbackIsScheduled 函数中处理）。因此，如果首个任务节点的优先级为 ImmediatePriority，flushWork 所获得参数 didTimeout 也将是否值，其执行逻辑将是执行所有优先级为 ImmediatePriority 的任务节点，再调用 ensureHostCallbackIsScheduled 等待下一次重绘时执行其余任务节点。如果首个任务节点的优先级为 UserBlockingPriority 等，flushWork 将执行同优先级的任务节点，再调用 ensureHostCallbackIsScheduled 等待下一次重绘时执行其余任务节点。所有对不同优先级的任务节点，scheduler 采用分段执行的策略。</p>
<table>
<thead>
<tr>
<th>缓存</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td>currentPriorityLevel</td>
<td>执行中任务节点的优先级，默认为 NormalPriority</td>
</tr>
<tr>
<td>currentExpirationTime</td>
<td>执行中任务节点的超时时间点</td>
</tr>
<tr>
<td>enableSchedulerDebugging</td>
<td>debug 模式？</td>
</tr>
<tr>
<td>isExecutingCallback</td>
<td>任务节点正在批量执行中标识</td>
</tr>
<tr>
<td>isHostCallbackScheduled</td>
<td>requestHostCallback 已执行并开启 rAF 轮询标识</td>
</tr>
<tr>
<td>isSchedulerPaused</td>
<td>scheduler 是否被打断，将不会执行任务节点，由接口层更新该值</td>
</tr>
</tbody>
</table>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ensureHostCallbackIsScheduled</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isExecutingCallback) &#123;</span><br><span class="line">    <span class="comment">// Don't schedule work yet; wait until the next time we yield.</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Schedule the host callback using the earliest expiration in the list.</span></span><br><span class="line">  <span class="keyword">var</span> expirationTime = firstCallbackNode.expirationTime;</span><br><span class="line">  <span class="keyword">if</span> (!isHostCallbackScheduled) &#123;</span><br><span class="line">    isHostCallbackScheduled = <span class="literal">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Cancel the existing host callback.</span></span><br><span class="line">    cancelHostCallback();</span><br><span class="line">  &#125;</span><br><span class="line">  requestHostCallback(flushWork, expirationTime);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushFirstCallback</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> flushedNode = firstCallbackNode;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Remove the node from the list before calling the callback. That way the</span></span><br><span class="line">  <span class="comment">// list is in a consistent state even if the callback throws.</span></span><br><span class="line">  <span class="keyword">var</span> next = firstCallbackNode.next;</span><br><span class="line">  <span class="keyword">if</span> (firstCallbackNode === next) &#123;</span><br><span class="line">    <span class="comment">// This is the last callback in the list.</span></span><br><span class="line">    firstCallbackNode = <span class="literal">null</span>;</span><br><span class="line">    next = <span class="literal">null</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> lastCallbackNode = firstCallbackNode.previous;</span><br><span class="line">    firstCallbackNode = lastCallbackNode.next = next;</span><br><span class="line">    next.previous = lastCallbackNode;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  flushedNode.next = flushedNode.previous = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Now it's safe to call the callback.</span></span><br><span class="line">  <span class="keyword">var</span> callback = flushedNode.callback;</span><br><span class="line">  <span class="keyword">var</span> expirationTime = flushedNode.expirationTime;</span><br><span class="line">  <span class="keyword">var</span> priorityLevel = flushedNode.priorityLevel;</span><br><span class="line">  <span class="keyword">var</span> previousPriorityLevel = currentPriorityLevel;</span><br><span class="line">  <span class="keyword">var</span> previousExpirationTime = currentExpirationTime;</span><br><span class="line">  currentPriorityLevel = priorityLevel;</span><br><span class="line">  currentExpirationTime = expirationTime;</span><br><span class="line">  <span class="keyword">var</span> continuationCallback;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    continuationCallback = callback();</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    currentPriorityLevel = previousPriorityLevel;</span><br><span class="line">    currentExpirationTime = previousExpirationTime;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// A callback may return a continuation. The continuation should be scheduled</span></span><br><span class="line">  <span class="comment">// with the same priority and expiration as the just-finished callback.</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> continuationCallback === <span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="keyword">var</span> continuationNode: CallbackNode = &#123;</span><br><span class="line">      callback: continuationCallback,</span><br><span class="line">      priorityLevel,</span><br><span class="line">      expirationTime,</span><br><span class="line">      next: <span class="literal">null</span>,</span><br><span class="line">      previous: <span class="literal">null</span>,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Insert the new callback into the list, sorted by its expiration. This is</span></span><br><span class="line">    <span class="comment">// almost the same as the code in `scheduleCallback`, except the callback</span></span><br><span class="line">    <span class="comment">// is inserted into the list *before* callbacks of equal expiration instead</span></span><br><span class="line">    <span class="comment">// of after.</span></span><br><span class="line">    <span class="keyword">if</span> (firstCallbackNode === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// This is the first callback in the list.</span></span><br><span class="line">      firstCallbackNode = continuationNode.next = continuationNode.previous = continuationNode;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">var</span> nextAfterContinuation = <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">var</span> node = firstCallbackNode;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (node.expirationTime &gt;= expirationTime) &#123;</span><br><span class="line">          <span class="comment">// This callback expires at or after the continuation. We will insert</span></span><br><span class="line">          <span class="comment">// the continuation *before* this callback.</span></span><br><span class="line">          nextAfterContinuation = node;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        node = node.next;</span><br><span class="line">      &#125; <span class="keyword">while</span> (node !== firstCallbackNode);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (nextAfterContinuation === <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// No equal or lower priority callback was found, which means the new</span></span><br><span class="line">        <span class="comment">// callback is the lowest priority callback in the list.</span></span><br><span class="line">        nextAfterContinuation = firstCallbackNode;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nextAfterContinuation === firstCallbackNode) &#123;</span><br><span class="line">        <span class="comment">// The new callback is the highest priority callback in the list.</span></span><br><span class="line">        firstCallbackNode = continuationNode;</span><br><span class="line">        ensureHostCallbackIsScheduled();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">var</span> previous = nextAfterContinuation.previous;</span><br><span class="line">      previous.next = nextAfterContinuation.previous = continuationNode;</span><br><span class="line">      continuationNode.next = nextAfterContinuation;</span><br><span class="line">      continuationNode.previous = previous;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushImmediateWork</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="comment">// Confirm we've exited the outer most event handler</span></span><br><span class="line">    currentEventStartTime === <span class="number">-1</span> &amp;&amp;</span><br><span class="line">    firstCallbackNode !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">    firstCallbackNode.priorityLevel === ImmediatePriority</span><br><span class="line">  ) &#123;</span><br><span class="line">    isExecutingCallback = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        flushFirstCallback();</span><br><span class="line">      &#125; <span class="keyword">while</span> (</span><br><span class="line">        <span class="comment">// Keep flushing until there are no more immediate callbacks</span></span><br><span class="line">        firstCallbackNode !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        firstCallbackNode.priorityLevel === ImmediatePriority</span><br><span class="line">      );</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      isExecutingCallback = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (firstCallbackNode !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="comment">// There's still work remaining. Request another callback.</span></span><br><span class="line">        ensureHostCallbackIsScheduled();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        isHostCallbackScheduled = <span class="literal">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flushWork</span>(<span class="params">didTimeout</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Exit right away if we're currently paused</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (enableSchedulerDebugging &amp;&amp; isSchedulerPaused) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  isExecutingCallback = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">const</span> previousDidTimeout = currentDidTimeout;</span><br><span class="line">  currentDidTimeout = didTimeout;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (didTimeout) &#123;</span><br><span class="line">      <span class="comment">// Flush all the expired callbacks without yielding.</span></span><br><span class="line">      <span class="keyword">while</span> (</span><br><span class="line">        firstCallbackNode !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">        !(enableSchedulerDebugging &amp;&amp; isSchedulerPaused)</span><br><span class="line">      ) &#123;</span><br><span class="line">        <span class="comment">// TODO Wrap i nfeature flag</span></span><br><span class="line">        <span class="comment">// Read the current time. Flush all the callbacks that expire at or</span></span><br><span class="line">        <span class="comment">// earlier than that time. Then read the current time again and repeat.</span></span><br><span class="line">        <span class="comment">// This optimizes for as few performance.now calls as possible.</span></span><br><span class="line">        <span class="keyword">var</span> currentTime = getCurrentTime();</span><br><span class="line">        <span class="keyword">if</span> (firstCallbackNode.expirationTime &lt;= currentTime) &#123;</span><br><span class="line">          <span class="keyword">do</span> &#123;</span><br><span class="line">            flushFirstCallback();</span><br><span class="line">          &#125; <span class="keyword">while</span> (</span><br><span class="line">            firstCallbackNode !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">            firstCallbackNode.expirationTime &lt;= currentTime &amp;&amp;</span><br><span class="line">            !(enableSchedulerDebugging &amp;&amp; isSchedulerPaused)</span><br><span class="line">          );</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Keep flushing callbacks until we run out of time in the frame.</span></span><br><span class="line">      <span class="keyword">if</span> (firstCallbackNode !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (enableSchedulerDebugging &amp;&amp; isSchedulerPaused) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          flushFirstCallback();</span><br><span class="line">        &#125; <span class="keyword">while</span> (firstCallbackNode !== <span class="literal">null</span> &amp;&amp; !shouldYieldToHost());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    isExecutingCallback = <span class="literal">false</span>;</span><br><span class="line">    currentDidTimeout = previousDidTimeout;</span><br><span class="line">    <span class="keyword">if</span> (firstCallbackNode !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// There's still work remaining. Request another callback.</span></span><br><span class="line">      ensureHostCallbackIsScheduled();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      isHostCallbackScheduled = <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Before exiting, flush all the immediate work that was scheduled.</span></span><br><span class="line">    flushImmediateWork();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="apis"><a href="#apis" class="headerlink" title="apis"></a>apis</h3><h4 id="unstable-scheduleCallback"><a href="#unstable-scheduleCallback" class="headerlink" title="unstable_scheduleCallback"></a>unstable_scheduleCallback</h4><p>unstable_scheduleCallback(callback, deprecated_options) 基于 currentPriorityLevel 优先级计算超时时间点，将 callback 构建为一个 callbackNode 任务节点，并将该节点插入双向链表，启用 ensureHostCallbackIsScheduled 等待重绘后执行任务节点。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unstable_scheduleCallback</span>(<span class="params">callback, deprecated_options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> startTime =</span><br><span class="line">    currentEventStartTime !== <span class="number">-1</span> ? currentEventStartTime : getCurrentTime();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> expirationTime;</span><br><span class="line">  <span class="keyword">if</span> (</span><br><span class="line">    <span class="keyword">typeof</span> deprecated_options === <span class="string">'object'</span> &amp;&amp;</span><br><span class="line">    deprecated_options !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">    <span class="keyword">typeof</span> deprecated_options.timeout === <span class="string">'number'</span></span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="comment">// <span class="doctag">FIXME:</span> Remove this branch once we lift expiration times out of React.</span></span><br><span class="line">    expirationTime = startTime + deprecated_options.timeout;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (currentPriorityLevel) &#123;</span><br><span class="line">      <span class="keyword">case</span> ImmediatePriority:</span><br><span class="line">        expirationTime = startTime + IMMEDIATE_PRIORITY_TIMEOUT;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> UserBlockingPriority:</span><br><span class="line">        expirationTime = startTime + USER_BLOCKING_PRIORITY;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> IdlePriority:</span><br><span class="line">        expirationTime = startTime + IDLE_PRIORITY;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> LowPriority:</span><br><span class="line">        expirationTime = startTime + LOW_PRIORITY_TIMEOUT;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> NormalPriority:</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        expirationTime = startTime + NORMAL_PRIORITY_TIMEOUT;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> newNode = &#123;</span><br><span class="line">    callback,</span><br><span class="line">    priorityLevel: currentPriorityLevel,</span><br><span class="line">    expirationTime,</span><br><span class="line">    next: <span class="literal">null</span>,</span><br><span class="line">    previous: <span class="literal">null</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Insert the new callback into the list, ordered first by expiration, then</span></span><br><span class="line">  <span class="comment">// by insertion. So the new callback is inserted any other callback with</span></span><br><span class="line">  <span class="comment">// equal expiration.</span></span><br><span class="line">  <span class="keyword">if</span> (firstCallbackNode === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// This is the first callback in the list.</span></span><br><span class="line">    firstCallbackNode = newNode.next = newNode.previous = newNode;</span><br><span class="line">    ensureHostCallbackIsScheduled();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> next = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">var</span> node = firstCallbackNode;</span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (node.expirationTime &gt; expirationTime) &#123;</span><br><span class="line">        <span class="comment">// The new callback expires before this one.</span></span><br><span class="line">        next = node;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      node = node.next;</span><br><span class="line">    &#125; <span class="keyword">while</span> (node !== firstCallbackNode);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// No callback with a later expiration was found, which means the new</span></span><br><span class="line">      <span class="comment">// callback has the latest expiration in the list.</span></span><br><span class="line">      next = firstCallbackNode;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (next === firstCallbackNode) &#123;</span><br><span class="line">      <span class="comment">// The new callback has the earliest expiration in the entire list.</span></span><br><span class="line">      firstCallbackNode = newNode;</span><br><span class="line">      ensureHostCallbackIsScheduled();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> previous = next.previous;</span><br><span class="line">    previous.next = next.previous = newNode;</span><br><span class="line">    newNode.next = next;</span><br><span class="line">    newNode.previous = previous;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> newNode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="unstable-runWithPriority"><a href="#unstable-runWithPriority" class="headerlink" title="unstable_runWithPriority"></a>unstable_runWithPriority</h4><p>unstable_runWithPriority(priorityLevel, eventHandler) 将 currentPriorityLevel 缓存设置为 priorityLevel，随后再执行 eventHandler，最后调用 flushImmediateWork 函数执行所有优先级为 ImmediatePriority 的任务节点，其余任务节点等待下次重绘后再执行。可以设想，当 eventHandler 为 unstable_scheduleCallback 函数时，将影响所添加任务节点的优先级，并立即执行 ImmediatePriority 优先级的任务。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unstable_runWithPriority</span>(<span class="params">priorityLevel, eventHandler</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (priorityLevel) &#123;</span><br><span class="line">    <span class="keyword">case</span> ImmediatePriority:</span><br><span class="line">    <span class="keyword">case</span> UserBlockingPriority:</span><br><span class="line">    <span class="keyword">case</span> NormalPriority:</span><br><span class="line">    <span class="keyword">case</span> LowPriority:</span><br><span class="line">    <span class="keyword">case</span> IdlePriority:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      priorityLevel = NormalPriority;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> previousPriorityLevel = currentPriorityLevel;</span><br><span class="line">  <span class="keyword">var</span> previousEventStartTime = currentEventStartTime;</span><br><span class="line">  currentPriorityLevel = priorityLevel;</span><br><span class="line">  currentEventStartTime = getCurrentTime();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> eventHandler();</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    currentPriorityLevel = previousPriorityLevel;</span><br><span class="line">    currentEventStartTime = previousEventStartTime;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Before exiting, flush all the immediate work that was scheduled.</span></span><br><span class="line">    flushImmediateWork();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="unstable-wrapCallback"><a href="#unstable-wrapCallback" class="headerlink" title="unstable_wrapCallback"></a>unstable_wrapCallback</h4><p>unstable_wrapCallback(callback) 记录当前的优先级 currentPriorityLevel，返回函数处理效果如 unstable_runWithPriority，对于 callback 中新添加的任务节点将使用所记录的 currentPriorityLevel 作为优先级。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unstable_wrapCallback</span>(<span class="params">callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> parentPriorityLevel = currentPriorityLevel;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// This is a fork of runWithPriority, inlined for performance.</span></span><br><span class="line">    <span class="keyword">var</span> previousPriorityLevel = currentPriorityLevel;</span><br><span class="line">    <span class="keyword">var</span> previousEventStartTime = currentEventStartTime;</span><br><span class="line">    currentPriorityLevel = parentPriorityLevel;</span><br><span class="line">    currentEventStartTime = getCurrentTime();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> callback.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      currentPriorityLevel = previousPriorityLevel;</span><br><span class="line">      currentEventStartTime = previousEventStartTime;</span><br><span class="line">      flushImmediateWork();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><ul>
<li>unstable_pauseExecution 通过将 isSchedulerPaused 置为 true，打断 scheduler 处理任务节点。</li>
<li>unstable_continueExecution 取消打断状态，使 scheduler 恢复处理任务节点。</li>
<li>unstable_getFirstCallbackNode 获取双向链表中的首个任务节点。</li>
<li>unstable_cancelCallback(callbackNode) 从双向链表中移除指定任务节点。</li>
<li>unstable_getCurrentPriorityLevel 获取当前优先级 currentPriorityLevel 缓存。</li>
<li>unstable_shouldYield 是否需要被打断。</li>
<li>unstable_now 获取当前时间。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">unstable_shouldYield</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    !currentDidTimeout &amp;&amp;</span><br><span class="line">    ((firstCallbackNode !== <span class="literal">null</span> &amp;&amp;</span><br><span class="line">      firstCallbackNode.expirationTime &lt; currentExpirationTime) ||</span><br><span class="line">      shouldYieldToHost())</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>scheduler 模块代码简短，逻辑复杂，在这篇文章中，难免有理解不当的地方。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/14/react/react16源码/React/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/14/react/react16源码/React/" itemprop="url">react api 整理</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-14T00:00:00+08:00">2019-01-14</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/react/" itemprop="url" rel="index"><span itemprop="name">react</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/01/14/react/react16源码/React/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/01/14/react/react16源码/React/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文档意在整理 react 顶层 api 的内容和实现，可参阅<a href="https://reactjs.org/docs/react-api.html" target="_blank" rel="noopener">react 官方文档</a>。React 包主要提供 api 接口，功能上的核心逻辑点通常由 react-dom 等包实现。</p>
<h2 id="组件"><a href="#组件" class="headerlink" title="组件"></a>组件</h2><p>React 组件可将视图内容拆分为独立的、可复用的单元，以便在组件的模块制作过程中独立实现视图逻辑和业务逻辑。在 es6 语法背景下，React 组件可基于 React.Component, React.PureComponent 类加以制作。如果没有使用 es6 语法，可以使用 <a href="https://reactjs.org/docs/react-without-es6.html" target="_blank" rel="noopener">create-react-class</a> 库。除此以外，也可以编写函数式组件。该函数式组件能用 React.memo 加以包裹。</p>
<p>在源码中，React.Component, React.PureComponent 类由 ReactBaseClasses 模块提供。</p>
<h3 id="Component"><a href="#Component" class="headerlink" title="Component"></a>Component</h3><p>Component(props, context, updater) 基类在构造函数中初始化 props, context, refs, updater 实例属性，并包含 isReactComponent, setState, forceUpdate 原型方法。其中，updater 属性在实例化阶段将赋值为默认的 ReactNoopUpdateQueue，渲染阶段在注入实际的 updater。setState, forceUpdate 原型方法基于 updater.enqueueSetState, updater.enqueueForceUpdate 构建。</p>
<h3 id="PureComponent"><a href="#PureComponent" class="headerlink" title="PureComponent"></a>PureComponent</h3><p>PureComponent(props, context, updater) 与 Component 基类拥有相同的实例属性，其原型对象也通过桥接函数赋值的形式重新构造、且混入了 Component 基类的原型方法，除此之外，PureComponent 还具有 isPureReactComponent 原型方法。</p>
<h3 id="生命周期"><a href="#生命周期" class="headerlink" title="生命周期"></a>生命周期</h3><p>可参考 <a href="http://projects.wojtekmaj.pl/react-lifecycle-methods-diagram/" target="_blank" rel="noopener">React 组件生命周期</a></p>
<ol>
<li>挂载阶段：<ul>
<li>constructor(props): 实例化。</li>
<li>static getDeriverdStateFromProps 从 props 中获取 state。</li>
<li>render 渲染。</li>
<li>componentDidMount: 完成挂载。</li>
</ul>
</li>
<li>更新阶段：<ul>
<li>static getDeriverdStateFromProps 从 props 中获取 state。</li>
<li>shouldComponentUpdate 判断是否需要重绘。</li>
<li>rendere 渲染。</li>
<li>getShapshotBeforeUpdate 获取快照。</li>
<li>componentDidUpdate 渲染完成后回调。</li>
</ul>
</li>
<li>卸载阶段：<ul>
<li>componentWillUnmount 即将卸载。</li>
</ul>
</li>
<li>错误处理：<ul>
<li>static getDerivedStateFromError 从错误中获取 state。</li>
<li>componentDidCatch 捕获错误并进行处理。</li>
</ul>
</li>
</ol>
<h3 id="React-memo"><a href="#React-memo" class="headerlink" title="React.memo"></a>React.memo</h3><p>React.memo(funcComponent, compare) 用于创建高阶组件，使函数式组件具有如 PureComponent 的效果。在默认情况下，它会浅比较接受到的 props，当然，在提供 compare(prevProps, nextProps) 参数的场景中，你也可以定制重绘时机。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">MyComponent</span>(<span class="params">props</span>)</span>&#123;&#125;;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">areEqual</span>(<span class="params">prevProps, nextProps</span>)</span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> React.memo(MyComponent, areEqual);</span><br></pre></td></tr></table></figure>
<p>实现上，memo 函数会构建类 React 元素数据如 { $$typeof, type, compare }。其中，$$typeof 为来自 shared/ReactSymbols 包下的常量 REACT_MEMO_TYPE；type 为首参函数式组件；compare 即次参对比函数。</p>
<h2 id="元素"><a href="#元素" class="headerlink" title="元素"></a>元素</h2><p>React 元素可使用 JSX 语法书写，也可以使用 createElement, createFactory 方法构建。<a href="https://github.com/mlmorg/react-hyperscript" target="_blank" rel="noopener">react-hyperscript</a>, <a href="https://github.com/ohanhi/hyperscript-helpers" target="_blank" rel="noopener">hyperscript-helpers</a> 这两个类库也提供了创建 React 元素的便捷语法糖。</p>
<p>除了 createElement, createFactory 方法以外，React 还提供 cloneElementAndReplaceKey, cloneElement, isValidElement 用于克隆元素或者校验元素。这些方法均由 ReactElement 模块输出。而 React.children 用于处理对子元素的操作。</p>
<h3 id="Element"><a href="#Element" class="headerlink" title="Element"></a>Element</h3><p>ReactElement(type, key, ref, self, source, owner, props) 作为创建元素的工厂函数，将构建 element 常量并返回。其中，element 包含可枚举可赋值的 $$typeof, type, key, ref, props, _owner 属性，$$typeof 属性为特定常量 REACT_ELEMENT_TYPE。在开发环境中，element 又包含 _store 存储校验标识（_store.validated），不可枚举不可赋值的 _self, _source 属性；且 element, element.props 均使用 Object.freeze 冻结。</p>
<p>createElement(type, config, children) 使用特定的自定义或内置组件 type 创建元素。参数 config 通过 key, ref, <strong>self, </strong>source 配置元素的 key, ref, self, source 属性，其余属性将作为元素的 props。children 用于配置元素下割的子元素。在创建元素时，ReactCurrentOwner.current 将作为元素的 _owner 属性。ReactCurrentOwner.current 值为渲染过程中的 Fiber 实例。</p>
<p>createFactory(type) 为特定的组件创建工厂函数。</p>
<p>cloneAndReplaceKey(oldElement, newKey) 使用 oldElement 组件构造器 oldElement.type 以及 ref, props, _owner, _self, _source 属性构建新的元素，该元素的 key 属性指定为 newKey。</p>
<p>cloneElement(element, config, children) 与 cloneAndReplaceKey 不同的是，该方法在克隆元素时可以重新配置 key, ref, props, children 属性。如果重置 ref 属性时，克隆元素的 _owner 属性也将同步更新为渲染过程中的 ReactCurrentOwner.current。</p>
<p>isValidElement(object) 通过校验参数 object 是否为对象且其 $$typeof 属性为 REACT_ELEMENT_TYPE，以判断是否 React 元素。</p>
<h3 id="Children"><a href="#Children" class="headerlink" title="Children"></a>Children</h3><p>forEach(children, forEachFunc, forEachContext) 遍历子元素，执行 forEachFunc 函数。</p>
<p>map(children, func, context) 遍历子元素，执行 func 函数。功能点同 forEach 方法，但是返回数组。</p>
<p>toArray(children) 将子元素转化为数组。</p>
<p>count(children) 计算子元素的数目。</p>
<p>only((children)) 校验参数 children 是否单一的 React 元素，并返回。</p>
<p>实现上，React 以 traverseAllChildren(children, callback, traverseContext) 函数作为遍历子元素的 api。traverseAllChildren 函数通过递归调用 traverseAllChildrenImpl(children, nameSoFar, callback, traverseContext) 遍历子元素，并校验子元素集合不能由 Map, Object 对象构建。对于回调的执行机制，React 会先使用 getPooledTraverseContext(mapResult, keyPrefix, mapFunction, mapContext) 将 forEach 方法的参数 forEachFunc, forEachContext 或者 map 方法的参数 func, context 组装成 traverseContext 对象（该对象还包含用于收集子元素的数组 mapResult 和元素 key 键的公共前缀 keyPrefix 属性）。在 traverseContext 对象的基础上，React 对 forEach, map 构建了单独的回调包装函数 forEachSingleChild, mapSingleChildIntoContext，以处理特定的逻辑。具体实现可参阅源码。</p>
<p>多个元素在渲染时可使用 React.Fragment 组件包裹，那样就不必创建额外的 dom 节点。React 输出的 Fragment 组件直接来自于 shared/ReactSymbols 包下的常量 REACT_FRAGMENT_TYPE。 </p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;React.Fragment&gt;</span><br><span class="line">  Some text.</span><br><span class="line">  &lt;h2&gt;A heading&lt;<span class="regexp">/h2&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>React.Fragment&gt;</span><br></pre></td></tr></table></figure>
<h2 id="Refs"><a href="#Refs" class="headerlink" title="Refs"></a>Refs</h2><h3 id="createRef"><a href="#createRef" class="headerlink" title="createRef"></a>createRef</h3><p>React.createRef 创建 refObject 对象，该对象可以作为 React 元素的 ref 属性，以此引用指定的 React 元素。React 包下只创建 refObject 对象并使用 Object.seal 加以密封，核心逻辑由其他包提供。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyComponent</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props)&#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">this</span>.input = React.createRef();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentDidMount()&#123;</span><br><span class="line">    <span class="keyword">this</span>.input.current.focus();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render()&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">'text'</span> <span class="attr">ref</span>=<span class="string">&#123;this.input&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="forwardRef"><a href="#forwardRef" class="headerlink" title="forwardRef"></a>forwardRef</h3><p>React.forwardRef 通过创建组件的方式将其所接受的 ref 引用配置长传给其子孙组件。forwardRef 有两个应用场景：为函数式组件指定引用；为高阶组件指定引用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">cosnt FancyButton = React.forwardRef(<span class="function">(<span class="params">props, ref</span>) =&gt;</span> (</span><br><span class="line">  &lt;button ref=&#123;ref&#125; className=<span class="string">'FancyButton'</span>&gt;</span><br><span class="line">    &#123;props.children&#125;</span><br><span class="line">  &lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">));</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">const ref = React.createRef();</span></span><br><span class="line"><span class="regexp">&lt;FancyButton ref=&#123;ref&#125;&gt;Click me!&lt;/</span>FancyButton&gt;;</span><br></pre></td></tr></table></figure>
<p>上述代码可将创建的 refObject 对象通过 forwardRef 的次参传入函数式组件，以便引用原生 dom 组件。虽然这样创建 ref 引用会增加 FancyButton 与其父元素的层级关联，造成一定的复杂度，但是当 FancyButton 组件被多个应用级组件所使用时，且这些应用级组件都要细微地操作 button 节点，通过 forwardRef 长传 ref 引用就必不可少了。</p>
<p>在制作高阶组件时，同样可以使用 React.forwardRef 将 ref 引用转变为特定的 props 属性并传入高阶组件中，那样被包裹的组件就可以使用该 props 属性设置 ref 引用了。代码实现如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logProps</span>(<span class="params">Component</span>)</span>&#123;</span><br><span class="line">  <span class="class"><span class="keyword">class</span> <span class="title">LogProps</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">    componentDidUpdate(prevProps)&#123;</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'old props:'</span>, prevProps);</span><br><span class="line">      <span class="built_in">console</span>.log(<span class="string">'new props:'</span>, <span class="keyword">this</span>.props);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    render()&#123;</span><br><span class="line">      <span class="keyword">const</span> &#123;forwardedRef, ...rest&#125; = <span class="keyword">this</span>.props;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">Component</span> <span class="attr">ref</span>=<span class="string">&#123;forwardedRef&#125;</span> &#123;<span class="attr">...rest</span>&#125; /&gt;</span></span></span><br><span class="line"><span class="xml">    &#125;</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  return React.forwardRef((props, ref) =&gt; &#123;</span></span><br><span class="line">    return &lt;LogProps &#123;...props&#125; forwaredRef=&#123;ref&#125; /&gt;;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在实现中，forwardRef 将校验参数是否为函数且包含两个参数（通过 length 属性校验）等，最终返回类 React 元素结构如 { $$typeof, render }。其中，$$typeof 为常量 REACT_FORWARD_REF_TYPE，render 即 forwardRef 的参数。</p>
<h2 id="Suspense"><a href="#Suspense" class="headerlink" title="Suspense"></a>Suspense</h2><p>React.Suspense 支持在某事件执行完成后渲染组件。目前只支持一种应用场景：通过 React.lazy 动态加载组件，在组件加载完成后，再行渲染。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> LazyComponent  = React.lazy(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">import</span>(<span class="string">'./OtherComponent.js'</span>));</span><br><span class="line"></span><br><span class="line">&lt;Suspense fallback=&#123;&lt;div&gt;loading...&lt;<span class="regexp">/div&gt;&#125;&gt;</span></span><br><span class="line"><span class="regexp">  &lt;LazyComponent&gt;</span></span><br><span class="line"><span class="regexp">&lt;/</span>Suspense&gt;</span><br></pre></td></tr></table></figure>
<p>在 OtherComponent 组件加载过程中，React 将使用 fallback 渲染元素；当 OtherComponent 加载完成后，视图将显示 OtherComponent 组件。Suspense 组件内允许渲染多个懒加载组件。在组件加载失败的场景中，可以构建实现了 getDerivedStateFromError(error) 静态方法以及 componentDidCatch(error, info) 生命周期方法的 ErrorBoundary 组件捕获错误并加以处理。</p>
<p>使用 React.lazy 动态加载的组件，不止可以作为 Suspense 组件的子元素，还可以作为 Route 组件的 component，以在路由层面实现动态加载。</p>
<p>在实现上，React.lazy 方法将构建类 React 元素的数据结构如 { $$typeof, _ctor, _status, _result }。其中，$$typeof 为常量 REACT_LAZY_TYPE，_ctor 为 React.lazy 接受的参数。React 输出的 Suspense 组件直接来自于 shared/ReactSymbols 包下的常量 REACT_SUSPENSE_TYPE。 </p>
<h2 id="createContext"><a href="#createContext" class="headerlink" title="createContext"></a>createContext</h2><p>Context 可视为 React 组件树的全局数据（比如验权后的用户信息、网页的主题风格、显示的语言），用于向子孙组件透传数据，而不必通过 props 属性逐层传递、或者将在顶层组件中将实际消费数据的子组件作为 children 传入中介组件。</p>
<p>Context 使用的方式为：</p>
<ol>
<li>使用 React.createContext(defaultValue) 创建 Context 对象。当 React 组件订阅了该 Context 对象时，该组件将从就近且匹配的 Provider 中读取 Context 对象。如果没有匹配的 Provider，那就会使用 defaultValue。</li>
<li>Context.Provider 以父组件的形式作为 Context 对象的提供者，当其重绘时，将迫使订阅数据的组件相应重绘。</li>
<li>在自定义组件中添加 contextType 静态属性，当其值为 Context 对象时，就可以通过组件实例的 context.value 访问实际透传的数据。</li>
<li>第 3 步也可以替代为第 4 步，使用 Context.Consumer 作为数据的消费者，其下可以用 value =&gt; ReactNode 的形式编写函数式组件。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ThemeContext = React.createContext(<span class="string">'light'</span>);</span><br><span class="line"><span class="keyword">const</span> UserContext = React.createContext(&#123; <span class="attr">name</span>: <span class="string">'Guest'</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">App</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  render()&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; signedInUser, theme &#125; = <span class="keyword">this</span>.props;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;ThemeContext.Provider value=&#123;theme&#125;&gt;</span><br><span class="line">        &lt;UserContext.Provider value=&#123;signedInUser&#125;&gt;</span><br><span class="line">          &lt;Layout /&gt;</span><br><span class="line">        &lt;<span class="regexp">/UserContext.Provider&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>ThemeContext.Provider&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Layout</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;Sidebar /&gt;</span><br><span class="line">      &lt;Context /&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">function Context()&#123;</span></span><br><span class="line"><span class="regexp">  return (</span></span><br><span class="line"><span class="regexp">    &lt;ThemeContext.Consumer&gt;</span></span><br><span class="line"><span class="regexp">      &#123;theme =&gt; (</span></span><br><span class="line"><span class="regexp">        &lt;UserContext.Consumer&gt;</span></span><br><span class="line"><span class="regexp">          &#123;user =&gt; (</span></span><br><span class="line"><span class="regexp">            &lt;ProfilePage user=&#123;user&#125; theme=&#123;theme&#125; /</span>&gt;</span><br><span class="line">          )&#125;</span><br><span class="line">        &lt;<span class="regexp">/UserContext.Consumer&gt;</span></span><br><span class="line"><span class="regexp">      )&#125;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>ThemeContext.Consumer&gt;</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实现上，createContext(defaultValue, calculateChangeBits) 方法会创建类 React 元素数据如 { $$typeof, _calculateChangedBits, _currentValue, _currentValue2, _threadCount, Provider, Consumer }。其中，$$typeof 为常量 REACT_CONTEXT_TYPE。Context.Provider 创建类 React 元素数据如 { $$typeof, _context }。其中，$$typeof 为常量 REACT_PROVIDER_TYPE；_context 即引用 Context 对象。Context.Consumer 在生产环境中就是Context 引用对象，开发环境将校验不能使用嵌套形式编码如 Context.Consumer.Provider, Context.Consumer.Consumer。</p>
<h2 id="ReactHooks"><a href="#ReactHooks" class="headerlink" title="ReactHooks"></a>ReactHooks</h2><p>借助于 <a href="https://reactjs.org/docs/high-order-components.html" target="_blank" rel="noopener">HOC</a> 或者 <a href="https://reactjs.org/docs/render-props.html" target="_blank" rel="noopener">render props</a>，你可以整合组件内的可重用逻辑。比如当弹窗 Modal 组件内包含多个可切换的表单组件时，可以使用 render props 将表单的渲染函数传入 Modal 中。但是这样处理却会破坏组件的结构，容易造成 wrapper 装饰器层叠套用较深，在层叠组件中维护组件的状态。使用 ReactHooks 后，我们可以提取状态处理逻辑，这样可以对状态处理逻辑进行独立测试和复用，且不会改变组件的层级。在多个组件中，共用钩子也是较为方便的。</p>
<p>在编写组件时，随着项目的逐步发展，组件的逻辑将变得极为复杂，比如 componentDidMount 方法内既会包含数据获取的操作，又会包含事件绑定，同时，相同功能点的处理逻辑（事件绑定和解绑）会散落在多个生命周期中。这样就会包含多个执行逻辑，也使代码不易测试、容易出错。借助状态管理器，我们可以将部分执行逻辑写入 store 中，然而这样会引入过多的抽象，执行逻辑也分散在多个模块中，也使组件不便于重用。使用 ReactHooks 后，我们可以基于功能点将彼此相关的处理逻辑拆分为多个小函数，而不是割裂性地分布在组件的多个生命周期中。</p>
<p>如同 Svelte, Angular, Glimer 所展示的，提前预编译组件在未来拥有极高的潜力。React 最近在尝试使用 <a href="https://prepack.io" target="_blank" rel="noopener">Prepack</a> 在编译时预处理组件，并且已经看见了一些眉目。然而类组件会使这些优化进展缓慢，同时，类也不能很好的压缩，并使热加载变得不可靠。使用 ReactHooks 后，我们可以使用更多的 React 特性，且不必借助类组件的形式。</p>
<p>从效果上看，ReactHooks 为函数式组件提供状态管理以及相关生命周期特性。</p>
<p>在 React 包中，除却必要的校验外，ReactHooks 提供的 api 都将间接调用 ReactCurrentOwner.currentDispatcher 的同名方法。</p>
<h3 id="State-Hook"><a href="#State-Hook" class="headerlink" title="State Hook"></a>State Hook</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useState &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Example</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [count, setCount] = useState(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;div&gt;</span><br><span class="line">      &lt;p&gt;You clicked &#123;count&#125; times&lt;<span class="regexp">/p&gt;</span></span><br><span class="line"><span class="regexp">      &lt;button onClick=&#123;() =&gt; setCount(count + 1)&#125;&gt;</span></span><br><span class="line"><span class="regexp">        Click me</span></span><br><span class="line"><span class="regexp">      &lt;/</span>button&gt;</span><br><span class="line">    &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>useState 将声明一个状态变量，作为返回数组的首项，该状态变量受到 React 机制的保护，只能通过第二个数组项 setCount 进行修改（其功能点一如类组件中使用的 setState 方法）。useState 的参数为状态的初始值，不限于对象形式。如果要使用两个状态，可调用 useState 两次达成。如前所述，useState 以数组形式返回一对值，前一个是当前的状态，后一个是用于变更状态的函数。</p>
<p>useState 的首参也可以是函数，初始状态由函数的返回值提供。</p>
<h3 id="Effect-Hook"><a href="#Effect-Hook" class="headerlink" title="Effect Hook"></a>Effect Hook</h3><p>Effect Hook 用于组织副作用逻辑，包含远程数据获取、事件绑定、节点操作、日志打印等。假设有针对组件状态的处理逻辑，在类组件的编程形式中，我们需要在 componentDidMount, componentDidUpdate 生命周期中两次组织同一个处理逻辑。当使用 Effect Hook 时，我们只需要组织一次这个处理逻辑。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useState, useEffect &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">FriendStatus</span>(<span class="params">props</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [isOnline, setIsOnline] = useState(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleStatusChange</span>(<span class="params">status</span>)</span>&#123;</span><br><span class="line">    setIsOnline(status.isOnline);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    ChatAPI.subscribeToFriendStatus(props.friend.id, handleStatusChange);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      ChatAPI.unsubscribeToFriendStatus(props.friend.id, handleStatusChange);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isOnline === <span class="literal">null</span>)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Loading...'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> isOnline ? <span class="string">'Online'</span> : <span class="string">'Offline'</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>效果上，useEffect(effect, inputs) 等同于告知 React 在组件渲染完成后需要执行 effect 副作用（React 会记录这个副作用函数，并在组件渲染完成后调用）；参数 inputs 以数组形式告知 React 当某些数据变更时，才执行副作用（可以是函数式组件内的任何变量或属性，并在 effect 中有所使用）。在函数式组件中使用 useEffect，其意义在于便捷地通过 useState 访问状态；同时，每次重绘将会构建新的 effect，其效果等同于每次渲染都会调度不同的副作用，属于一次性消费。与 componentDidMount, componentDidUpdate 不同的是，useEffect 副作用不会阻塞视图更新。useLayoutEffect 方法与 useEffect 类似，可用于测算布局。</p>
<p>当所需执行的副作用为事件订阅类时，在组件卸载时，我们需要解绑事件，以防内存溢出。当 effect 返回函数（比如用于解绑事件）时，React 会在组件即将更新时执行这个函数。以下是</p>
<p>基于 useEffect，我们可以将相同功能点的处理逻辑写在一个 effect 中，组件内使用多个 effect 涵盖不同的功能点，而不是像类组件那样使相同功能点的处理逻辑散落在不同生命周期中。同时，我们也不需要在 componentDidUpdate 编写一套 props 变更的处理逻辑，因为 useEffect 在组件重置后均会得到调用。</p>
<h3 id="Custom-Hook"><a href="#Custom-Hook" class="headerlink" title="Custom Hook"></a>Custom Hook</h3><p>自定义 hook 允许在不同组件重用状态处理逻辑</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; useState, useEffect &#125; <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useFriendStatus</span>(<span class="params">friendID</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [isOnline, setIsOnline] = useState(<span class="literal">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleStatusChange</span>(<span class="params">status</span>) </span>&#123;</span><br><span class="line">    setIsOnline(status.isOnline);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    ChatAPI.subscribeToFriendStatus(friendID, handleStatusChange);</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      ChatAPI.unsubscribeFromFriendStatus(friendID, handleStatusChange);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> isOnline;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">FriendStatus</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> isOnline = useFriendStatus(props.friend.id);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isOnline === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">'Loading...'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> isOnline ? <span class="string">'Online'</span> : <span class="string">'Offline'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">FriendListItem</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> isOnline = useFriendStatus(props.friend.id);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;li style=&#123;&#123; <span class="attr">color</span>: isOnline ? <span class="string">'green'</span> : <span class="string">'black'</span> &#125;&#125;&gt;</span><br><span class="line">      &#123;props.friend.name&#125;</span><br><span class="line">    &lt;<span class="regexp">/li&gt;</span></span><br><span class="line"><span class="regexp">  );</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>自定义 hook 名需要使用 ‘use’ 起始，这样才能满足 <a href="https://www.npmjs.com/package/eslint-plugin-react-hooks" target="_blank" rel="noopener">eslint-plugin-react-hooks</a>，React 也能侦测出这是一个 hook。其次，在不同组件中使用的自定义 hook，会构建不同的 state。</p>
<h3 id="useReducer"><a href="#useReducer" class="headerlink" title="useReducer"></a>useReducer</h3><p>当组件的状态管理略显复杂时，React 提供 useReducer 钩子以 Redux 风格管理状态。</p>
<p>useReducer 方法的首参为 reducer，次参为 initialState，尾参为 initialAction 如 {type: ‘reset’, payload: initialCount}。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">todosReducer</span>(<span class="params">state, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="string">'add'</span>:</span><br><span class="line">      <span class="keyword">return</span> [...state, &#123;</span><br><span class="line">        text: action.text,</span><br><span class="line">        completed: <span class="literal">false</span></span><br><span class="line">      &#125;];</span><br><span class="line">    <span class="comment">// ... other actions ...</span></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useReducer</span>(<span class="params">reducer, initialState</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [state, setState] = useState(initialState);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> nextState = reducer(state, action);</span><br><span class="line">    setState(nextState);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [state, dispatch];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Todos</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> [todos, dispatch] = useReducer(todosReducer, []);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleAddClick</span>(<span class="params">text</span>) </span>&#123;</span><br><span class="line">    dispatch(&#123; <span class="attr">type</span>: <span class="string">'add'</span>, text &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><ul>
<li>useContext(context): 使用 React.createContext 创建的 context 对象作为参数，从就近的 Provider 中获取 context 对象。当 context 对象在 Provider 中更新时，组件将重绘。</li>
<li>useCallback(() =&gt; { doSomething(realInputs) }, inputs): 当 inputs 数组数据变更时，执行 doSomething 回调。useCallback(fn, inputs) 等价于 useMemo(() =&gt; fn, inputs)。</li>
<li>useMemo(() =&gt; { computeExpensiveValue(realInputs) }, inputs): 当 inputs 数组数据变更时，执行 computeExpensiveValue 函数，重新计算新值。</li>
<li>useRef(initialValue): 将使用接受的首参构建引用，通过 current 属性访问。该 ref 引用将在组件的生命周期中得到维持。</li>
<li>useImperativeMethods(ref, createInstance, [inputs]): 用于对外导出操纵子元素的 ref 引用方法，只能配合 forwardRef 方法使用。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// useRef</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">TextInputWithFocusButton</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> inputEl = useRef(<span class="literal">null</span>);</span><br><span class="line">  <span class="keyword">const</span> onButtonClick = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// `current` points to the mounted text input element</span></span><br><span class="line">    inputEl.current.focus();</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;&gt;</span><br><span class="line">      &lt;input ref=&#123;inputEl&#125; type=<span class="string">"text"</span> /&gt;</span><br><span class="line">      &lt;button onClick=&#123;onButtonClick&#125;&gt;Focus the input&lt;<span class="regexp">/button&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// useImperativeMethods</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">FancyInput</span>(<span class="params">props, ref</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> inputRef = useRef();</span><br><span class="line">  useImperativeMethods(ref, () =&gt; (&#123;</span><br><span class="line">    focus: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      inputRef.current.focus();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;));</span><br><span class="line">  <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">input</span> <span class="attr">ref</span>=<span class="string">&#123;inputRef&#125;</span> <span class="attr">...</span> /&gt;</span>;</span></span><br><span class="line"><span class="xml">&#125;</span></span><br><span class="line"><span class="xml">FancyInput = forwardRef(FancyInput);</span></span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/08/antd/react-component/rc-utils/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/08/antd/react-component/rc-utils/" itemprop="url">rc-utils</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-08T00:00:00+08:00">2019-01-08</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/antd-组件库/" itemprop="url" rel="index"><span itemprop="name">antd 组件库</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/01/08/antd/react-component/rc-utils/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/01/08/antd/react-component/rc-utils/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>rc-utils 是绘制 <a href="https://github.com/react-component" target="_blank" rel="noopener">react-component</a> 组件所使用的工具库。</p>
<h2 id="Portal"><a href="#Portal" class="headerlink" title="Portal"></a>Portal</h2><p>使用 react16 中的 ReactDOM.createPortal 将浮层组件渲染到指定节点中。</p>
<table>
<thead>
<tr>
<th>prop 属性</th>
<th>意义</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>autoMount</td>
<td>componentDidMount, componentDidUpdate 生命周期是否自动渲染浮层组件</td>
<td>true</td>
</tr>
<tr>
<td>children</td>
<td>浮层组件，ReactElement</td>
<td>undefined</td>
</tr>
<tr>
<td>didUpdate</td>
<td>componentDidUpdate 生命周期重绘时的回调函数</td>
<td>undefined</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>实例属性</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td>container</td>
<td>浮层组件的父节点</td>
</tr>
</tbody>
</table>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">'prop-types'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Portal</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> propTypes = &#123;</span><br><span class="line">    getContainer: PropTypes.func.isRequired,</span><br><span class="line">    children: PropTypes.node.isRequired,</span><br><span class="line">    didUpdate: PropTypes.func,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">this</span>.createContainer();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentDidUpdate(prevProps) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; didUpdate &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">if</span> (didUpdate) &#123;</span><br><span class="line">      didUpdate(prevProps);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentWillUnmount() &#123;</span><br><span class="line">    <span class="keyword">this</span>.removeContainer();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  createContainer() &#123;</span><br><span class="line">    <span class="keyword">this</span>._container = <span class="keyword">this</span>.props.getContainer();</span><br><span class="line">    <span class="keyword">this</span>.forceUpdate();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  removeContainer() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._container) &#123;</span><br><span class="line">      <span class="keyword">this</span>._container.parentNode.removeChild(<span class="keyword">this</span>._container);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>._container) &#123;</span><br><span class="line">      <span class="keyword">return</span> ReactDOM.createPortal(<span class="keyword">this</span>.props.children, <span class="keyword">this</span>._container);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ContainerRender"><a href="#ContainerRender" class="headerlink" title="ContainerRender"></a>ContainerRender</h2><p>使用 <a href="https://zhuanlan.zhihu.com/p/29880992?utm_source=wechat_session&amp;utm_medium=social&amp;from=singlemessage" target="_blank" rel="noopener">ReactDOM.unstable_renderSubtreeIntoContainer</a> 将组件渲染到指定节点中，通常用于渲染浮层。下文以浮层组件指代渲染到指定节点中的组件。</p>
<table>
<thead>
<tr>
<th>prop 属性</th>
<th>意义</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>autoMount</td>
<td>componentDidMount, componentDidUpdate 生命周期是否自动渲染浮层组件</td>
<td>true</td>
</tr>
<tr>
<td>autoDestroy</td>
<td>componentWillUnmount 生命周期是否自动卸载浮层组件</td>
<td>true</td>
</tr>
<tr>
<td>visible</td>
<td>是否显示浮层组件</td>
<td>undefined</td>
</tr>
<tr>
<td>forceRender</td>
<td>ContainerRender 或子组件重绘过程中，是否重绘浮层组件</td>
<td>false</td>
</tr>
<tr>
<td>parent</td>
<td>渲染过程中的虚拟父节点，需要使用者主动将浮层组价记录到 parent._component；parent._component 为真值时将重绘浮层组件</td>
<td>undefined</td>
</tr>
<tr>
<td>getComponent</td>
<td>函数形式，用于渲染浮层组件</td>
<td>undefined</td>
</tr>
<tr>
<td>getContainer</td>
<td>函数形式，用于指定浮层组件的父节点，需要临时创建</td>
<td>undefined</td>
</tr>
<tr>
<td>children</td>
<td>渲染过程中的虚拟子节点，函数形式 ({ renderComponent, removeContainer }) =&gt; {}</td>
<td>undefined</td>
</tr>
</tbody>
</table>
<table>
<thead>
<tr>
<th>实例方法及属性</th>
<th>意义</th>
</tr>
</thead>
<tbody>
<tr>
<td>renderComponent(props, ready)</td>
<td>渲染浮层组件，props 将注入到浮层组件中，ready 为渲染完成后的回调</td>
</tr>
<tr>
<td>removeContainer</td>
<td>移除浮层组件并其父节点</td>
</tr>
<tr>
<td>container</td>
<td>浮层组件的父节点</td>
</tr>
</tbody>
</table>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> PropTypes <span class="keyword">from</span> <span class="string">'prop-types'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">ContainerRender</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> propTypes = &#123;</span><br><span class="line">    autoMount: PropTypes.bool,</span><br><span class="line">    autoDestroy: PropTypes.bool,</span><br><span class="line">    visible: PropTypes.bool,</span><br><span class="line">    forceRender: PropTypes.bool,</span><br><span class="line">    parent: PropTypes.any,</span><br><span class="line">    getComponent: PropTypes.func.isRequired,</span><br><span class="line">    getContainer: PropTypes.func.isRequired,</span><br><span class="line">    children: PropTypes.func.isRequired,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> defaultProps = &#123;</span><br><span class="line">    autoMount: <span class="literal">true</span>,</span><br><span class="line">    autoDestroy: <span class="literal">true</span>,</span><br><span class="line">    forceRender: <span class="literal">false</span>,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.props.autoMount) &#123;</span><br><span class="line">      <span class="keyword">this</span>.renderComponent();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentDidUpdate() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.props.autoMount) &#123;</span><br><span class="line">      <span class="keyword">this</span>.renderComponent();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentWillUnmount() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.props.autoDestroy) &#123;</span><br><span class="line">      <span class="keyword">this</span>.removeContainer();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  removeContainer = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.container) &#123;</span><br><span class="line">      ReactDOM.unmountComponentAtNode(<span class="keyword">this</span>.container);</span><br><span class="line">      <span class="keyword">this</span>.container.parentNode.removeChild(<span class="keyword">this</span>.container);</span><br><span class="line">      <span class="keyword">this</span>.container = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  renderComponent = <span class="function">(<span class="params">props, ready</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; visible, getComponent, forceRender, getContainer, parent &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">if</span> (visible || parent._component || forceRender) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!<span class="keyword">this</span>.container) &#123;</span><br><span class="line">        <span class="keyword">this</span>.container = getContainer();</span><br><span class="line">      &#125;</span><br><span class="line">      ReactDOM.unstable_renderSubtreeIntoContainer(</span><br><span class="line">        parent,</span><br><span class="line">        getComponent(props),</span><br><span class="line">        <span class="keyword">this</span>.container,</span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">callback</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (ready) &#123;</span><br><span class="line">            ready.call(<span class="keyword">this</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.props.children(&#123;</span><br><span class="line">      renderComponent: <span class="keyword">this</span>.renderComponent,</span><br><span class="line">      removeContainer: <span class="keyword">this</span>.removeContainer,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Chilren"><a href="#Chilren" class="headerlink" title="Chilren"></a>Chilren</h2><ul>
<li>Chilren/mapSelf(children): 将成组的 ReactElement 转换为 React16 支持渲染的数组形式。关于使用 jsx 语法书写的成组的 ReactElement，也可以使用 React.Fragment 组件进行渲染。</li>
<li>Children/toArray(children): 将成组的 ReactElement 转换为数组，效果同 mapSelf 函数。</li>
</ul>
<h2 id="Dom"><a href="#Dom" class="headerlink" title="Dom"></a>Dom</h2><ul>
<li>Dom/addEventListenerWrap(target, eventType, cb, option): 借助 <a href="https://github.com/yiminghe/add-dom-event-listener" target="_blank" rel="noopener">add-dom-event-listener</a> 为节点绑定事件处理函数，返回解绑函数。cb 回调将尝试使用 ReactDOM.unstable_batchedUpdates 调用，以批处理形式更新组件状态。</li>
<li>Dom/canUseDom: 校验是否支持 dom 节点操作。</li>
<li>Dom/class: 输出 hasClass(node, className), addClass(node, className), removeClass(node, className) 函数以操作节点的样式类。</li>
<li>Dom/contains(root, n): 校验 root 节点下是否包含 n 节点。</li>
<li>Dom/css: 支撑样式操作，参见下文。</li>
<li>Dom/focus: 焦点操作，参见下文。</li>
<li>Dom/support: 输出 animation, transition 变量，以判断平台支持的 animationend, transitionend 事件名；如不支持，变量的值为 false。</li>
<li>getScrollBarSize(fresh): 计算滚动条宽度，fresh 为真值时重新计算，否则返回缓存。</li>
</ul>
<h3 id="css"><a href="#css" class="headerlink" title="css"></a>css</h3><p>样式操作函数集。</p>
<ul>
<li>get(node, name): 获取节点的指定样式。</li>
<li>set(node, name, value): 设置节点的指定样式，次参支持对象形式。</li>
<li>getOuterWidth(el): 获取节点的宽度（offsetWidth 属性）；document.body 返回 document.documentElement.clientWidth 属性。</li>
<li>getOuterHeight(el): 获取节点的高度（offsetHeight 属性）；document.body 返回 window.innerHeight 或 document.documentElement.clientHeight 属性。</li>
<li>getDocSize: 获取文档的宽高。</li>
<li>getClientSize: 获取文档的宽高。</li>
<li>getScroll: 获取文档的滚动偏移量。</li>
<li>getOffset(node): 获取元素的滚动偏移量。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* eslint-disable no-nested-ternary */</span></span><br><span class="line"><span class="keyword">const</span> PIXEL_PATTERN = <span class="regexp">/margin|padding|width|height|max|min|offset/</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> removePixel = &#123;</span><br><span class="line">  left: <span class="literal">true</span>,</span><br><span class="line">  top: <span class="literal">true</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> floatMap = &#123;</span><br><span class="line">  cssFloat: <span class="number">1</span>,</span><br><span class="line">  styleFloat: <span class="number">1</span>,</span><br><span class="line">  float: <span class="number">1</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getComputedStyle</span>(<span class="params">node</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> node.nodeType === <span class="number">1</span> ?</span><br><span class="line">    node.ownerDocument.defaultView.getComputedStyle(node, <span class="literal">null</span>) : &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getStyleValue</span>(<span class="params">node, type, value</span>) </span>&#123;</span><br><span class="line">  type = type.toLowerCase();</span><br><span class="line">  <span class="keyword">if</span> (value === <span class="string">'auto'</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (type === <span class="string">'height'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> node.offsetHeight;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (type === <span class="string">'width'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> node.offsetWidth;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!(type <span class="keyword">in</span> removePixel)) &#123;</span><br><span class="line">    removePixel[type] = PIXEL_PATTERN.test(type);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> removePixel[type] ? (<span class="built_in">parseFloat</span>(value) || <span class="number">0</span>) : value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">get</span>(<span class="params">node, name</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> length = <span class="built_in">arguments</span>.length;</span><br><span class="line">  <span class="keyword">const</span> style = getComputedStyle(node);</span><br><span class="line"></span><br><span class="line">  name = floatMap[name] ? <span class="string">'cssFloat'</span> <span class="keyword">in</span> node.style ? <span class="string">'cssFloat'</span> : <span class="string">'styleFloat'</span> : name;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> (length === <span class="number">1</span>) ? style : getStyleValue(node, name, style[name] || node.style[name]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">set</span>(<span class="params">node, name, value</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> length = <span class="built_in">arguments</span>.length;</span><br><span class="line">  name = floatMap[name] ? <span class="string">'cssFloat'</span> <span class="keyword">in</span> node.style ? <span class="string">'cssFloat'</span> : <span class="string">'styleFloat'</span> : name;</span><br><span class="line">  <span class="keyword">if</span> (length === <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'number'</span> &amp;&amp; PIXEL_PATTERN.test(name)) &#123;</span><br><span class="line">      value = <span class="string">`<span class="subst">$&#123;value&#125;</span>px`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    node.style[name] = value; <span class="comment">// Number</span></span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> x <span class="keyword">in</span> name) &#123;</span><br><span class="line">    <span class="keyword">if</span> (name.hasOwnProperty(x)) &#123;</span><br><span class="line">      <span class="keyword">set</span>(node, x, name[x]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return getComputedStyle(node);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export function getOuterWidth(el) &#123;</span><br><span class="line">  <span class="keyword">if</span> (el === <span class="built_in">document</span>.body) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">document</span>.documentElement.clientWidth;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> el.offsetWidth;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getOuterHeight</span>(<span class="params">el</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (el === <span class="built_in">document</span>.body) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">window</span>.innerHeight || <span class="built_in">document</span>.documentElement.clientHeight;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> el.offsetHeight;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getDocSize</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> width = <span class="built_in">Math</span>.max(<span class="built_in">document</span>.documentElement.scrollWidth, <span class="built_in">document</span>.body.scrollWidth);</span><br><span class="line">  <span class="keyword">const</span> height = <span class="built_in">Math</span>.max(<span class="built_in">document</span>.documentElement.scrollHeight, <span class="built_in">document</span>.body.scrollHeight);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    width,</span><br><span class="line">    height,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getClientSize</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> width = <span class="built_in">document</span>.documentElement.clientWidth;</span><br><span class="line">  <span class="keyword">const</span> height = <span class="built_in">window</span>.innerHeight || <span class="built_in">document</span>.documentElement.clientHeight;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    width,</span><br><span class="line">    height,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getScroll</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    scrollLeft: <span class="built_in">Math</span>.max(<span class="built_in">document</span>.documentElement.scrollLeft, <span class="built_in">document</span>.body.scrollLeft),</span><br><span class="line">    scrollTop: <span class="built_in">Math</span>.max(<span class="built_in">document</span>.documentElement.scrollTop, <span class="built_in">document</span>.body.scrollTop),</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getOffset</span>(<span class="params">node</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> box = node.getBoundingClientRect();</span><br><span class="line">  <span class="keyword">const</span> docElem = <span class="built_in">document</span>.documentElement;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// &lt; ie8 不支持 win.pageXOffset, 则使用 docElem.scrollLeft</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    left: box.left + (<span class="built_in">window</span>.pageXOffset || docElem.scrollLeft) -</span><br><span class="line">      (docElem.clientLeft || <span class="built_in">document</span>.body.clientLeft || <span class="number">0</span>),</span><br><span class="line">    top: box.top + (<span class="built_in">window</span>.pageYOffset || docElem.scrollTop) -</span><br><span class="line">      (docElem.clientTop || <span class="built_in">document</span>.body.clientTop || <span class="number">0</span>),</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="focus"><a href="#focus" class="headerlink" title="focus"></a>focus</h3><p>焦点操作集。</p>
<ul>
<li>getFocusNodeList(node): 获取指定节点下可聚焦的节点。</li>
<li>saveLastFocusNode: 缓存最后一个聚焦节点。</li>
<li>clearLastFocusNode: 清除最后一个聚焦节点。</li>
<li>backLastFocusNode: 重新聚焦最后一个聚焦节点。</li>
<li>limitTabRange(node, e): 指定节点中点击 tab 按键时，支持从尾部可聚焦节点切换顶部可聚焦节点、或者从顶部可聚焦节点切换尾部可聚焦节点（同时按 shift 键）。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hidden</span>(<span class="params">node</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> node.style.display === <span class="string">'none'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">visible</span>(<span class="params">node</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (node) &#123;</span><br><span class="line">    <span class="keyword">if</span> (node === <span class="built_in">document</span>.body) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (hidden(node)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    node = node.parentNode;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">focusable</span>(<span class="params">node</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> nodeName = node.nodeName.toLowerCase();</span><br><span class="line">  <span class="keyword">const</span> tabIndex = <span class="built_in">parseInt</span>(node.getAttribute(<span class="string">'tabindex'</span>), <span class="number">10</span>);</span><br><span class="line">  <span class="keyword">const</span> hasTabIndex = !<span class="built_in">isNaN</span>(tabIndex) &amp;&amp; tabIndex &gt; <span class="number">-1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (visible(node)) &#123;</span><br><span class="line">    <span class="keyword">if</span> ([<span class="string">'input'</span>, <span class="string">'select'</span>, <span class="string">'textarea'</span>, <span class="string">'button'</span>].indexOf(nodeName) &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> !node.disabled;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (nodeName === <span class="string">'a'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> (node.getAttribute(<span class="string">'href'</span>) || hasTabIndex);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> node.isContentEditable || hasTabIndex;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">getFocusNodeList</span>(<span class="params">node</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> res = [].slice.call(node.querySelectorAll(<span class="string">'*'</span>), <span class="number">0</span>).filter(<span class="function">(<span class="params">child</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> focusable(child);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">if</span> (focusable(node)) &#123;</span><br><span class="line">    res.unshift(node);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> res;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> lastFocusElement = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">saveLastFocusNode</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  lastFocusElement = <span class="built_in">document</span>.activeElement;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">clearLastFocusNode</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  lastFocusElement = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">backLastFocusNode</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (lastFocusElement) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 元素可能已经被移动了</span></span><br><span class="line">      lastFocusElement.focus();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* eslint-disable no-empty */</span></span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="comment">// empty</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">/* eslint-enable no-empty */</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">limitTabRange</span>(<span class="params">node, e</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (e.keyCode === <span class="number">9</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> tabNodeList = getFocusNodeList(node);</span><br><span class="line">    <span class="keyword">const</span> lastTabNode = tabNodeList[e.shiftKey ? <span class="number">0</span> : tabNodeList.length - <span class="number">1</span>];</span><br><span class="line">    <span class="keyword">const</span> leavingTab = (lastTabNode === <span class="built_in">document</span>.activeElement || node === <span class="built_in">document</span>.activeElement);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (leavingTab) &#123;</span><br><span class="line">      <span class="keyword">const</span> target = tabNodeList[e.shiftKey ? tabNodeList.length - <span class="number">1</span> : <span class="number">0</span>];</span><br><span class="line">      target.focus();</span><br><span class="line">      e.preventDefault();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="getScrollBarSize"><a href="#getScrollBarSize" class="headerlink" title="getScrollBarSize"></a>getScrollBarSize</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> cached;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">getScrollBarSize</span>(<span class="params">fresh</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (fresh || cached === <span class="literal">undefined</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> inner = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span><br><span class="line">    inner.style.width = <span class="string">'100%'</span>;</span><br><span class="line">    inner.style.height = <span class="string">'200px'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> outer = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span><br><span class="line">    <span class="keyword">const</span> outerStyle = outer.style;</span><br><span class="line"></span><br><span class="line">    outerStyle.position = <span class="string">'absolute'</span>;</span><br><span class="line">    outerStyle.top = <span class="number">0</span>;</span><br><span class="line">    outerStyle.left = <span class="number">0</span>;</span><br><span class="line">    outerStyle.pointerEvents = <span class="string">'none'</span>;</span><br><span class="line">    outerStyle.visibility = <span class="string">'hidden'</span>;</span><br><span class="line">    outerStyle.width = <span class="string">'200px'</span>;</span><br><span class="line">    outerStyle.height = <span class="string">'150px'</span>;</span><br><span class="line">    outerStyle.overflow = <span class="string">'hidden'</span>;</span><br><span class="line"></span><br><span class="line">    outer.appendChild(inner);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(outer);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> widthContained = inner.offsetWidth;</span><br><span class="line">    outer.style.overflow = <span class="string">'scroll'</span>;</span><br><span class="line">    <span class="keyword">let</span> widthScroll = inner.offsetWidth;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (widthContained === widthScroll) &#123;</span><br><span class="line">      widthScroll = outer.clientWidth;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">document</span>.body.removeChild(outer);</span><br><span class="line"></span><br><span class="line">    cached = widthContained - widthScroll;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> cached;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="KeyCode"><a href="#KeyCode" class="headerlink" title="KeyCode"></a>KeyCode</h2><p>按键映射，及判断按键类型。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * @ignore</span></span><br><span class="line"><span class="comment"> * some key-codes definition and utils from closure-library</span></span><br><span class="line"><span class="comment"> * @author yiminghe@gmail.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> KeyCode = &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * MAC_ENTER</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  MAC_ENTER: <span class="number">3</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * BACKSPACE</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  BACKSPACE: <span class="number">8</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * TAB</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  TAB: <span class="number">9</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * NUMLOCK on FF/Safari Mac</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  NUM_CENTER: <span class="number">12</span>, <span class="comment">// NUMLOCK on FF/Safari Mac</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * ENTER</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  ENTER: <span class="number">13</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * SHIFT</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  SHIFT: <span class="number">16</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * CTRL</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  CTRL: <span class="number">17</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * ALT</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  ALT: <span class="number">18</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * PAUSE</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  PAUSE: <span class="number">19</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * CAPS_LOCK</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  CAPS_LOCK: <span class="number">20</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * ESC</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  ESC: <span class="number">27</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * SPACE</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  SPACE: <span class="number">32</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * PAGE_UP</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  PAGE_UP: <span class="number">33</span>, <span class="comment">// also NUM_NORTH_EAST</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * PAGE_DOWN</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  PAGE_DOWN: <span class="number">34</span>, <span class="comment">// also NUM_SOUTH_EAST</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * END</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  END: <span class="number">35</span>, <span class="comment">// also NUM_SOUTH_WEST</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * HOME</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  HOME: <span class="number">36</span>, <span class="comment">// also NUM_NORTH_WEST</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * LEFT</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  LEFT: <span class="number">37</span>, <span class="comment">// also NUM_WEST</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * UP</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  UP: <span class="number">38</span>, <span class="comment">// also NUM_NORTH</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * RIGHT</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  RIGHT: <span class="number">39</span>, <span class="comment">// also NUM_EAST</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * DOWN</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  DOWN: <span class="number">40</span>, <span class="comment">// also NUM_SOUTH</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * PRINT_SCREEN</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  PRINT_SCREEN: <span class="number">44</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * INSERT</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  INSERT: <span class="number">45</span>, <span class="comment">// also NUM_INSERT</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * DELETE</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  DELETE: <span class="number">46</span>, <span class="comment">// also NUM_DELETE</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * ZERO</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  ZERO: <span class="number">48</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * ONE</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  ONE: <span class="number">49</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * TWO</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  TWO: <span class="number">50</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * THREE</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  THREE: <span class="number">51</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * FOUR</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  FOUR: <span class="number">52</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * FIVE</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  FIVE: <span class="number">53</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * SIX</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  SIX: <span class="number">54</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * SEVEN</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  SEVEN: <span class="number">55</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * EIGHT</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  EIGHT: <span class="number">56</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * NINE</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  NINE: <span class="number">57</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * QUESTION_MARK</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  QUESTION_MARK: <span class="number">63</span>, <span class="comment">// needs localization</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * A</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  A: <span class="number">65</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * B</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  B: <span class="number">66</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * C</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  C: <span class="number">67</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * D</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  D: <span class="number">68</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * E</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  E: <span class="number">69</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * F</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  F: <span class="number">70</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * G</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  G: <span class="number">71</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * H</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  H: <span class="number">72</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * I</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  I: <span class="number">73</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * J</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  J: <span class="number">74</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * K</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  K: <span class="number">75</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * L</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  L: <span class="number">76</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * M</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  M: <span class="number">77</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * N</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  N: <span class="number">78</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * O</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  O: <span class="number">79</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * P</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  P: <span class="number">80</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Q</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  Q: <span class="number">81</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * R</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  R: <span class="number">82</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * S</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  S: <span class="number">83</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * T</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  T: <span class="number">84</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * U</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  U: <span class="number">85</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * V</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  V: <span class="number">86</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * W</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  W: <span class="number">87</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * X</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  X: <span class="number">88</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Y</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  Y: <span class="number">89</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Z</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  Z: <span class="number">90</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * META</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  META: <span class="number">91</span>, <span class="comment">// WIN_KEY_LEFT</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * WIN_KEY_RIGHT</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  WIN_KEY_RIGHT: <span class="number">92</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * CONTEXT_MENU</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  CONTEXT_MENU: <span class="number">93</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * NUM_ZERO</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  NUM_ZERO: <span class="number">96</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * NUM_ONE</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  NUM_ONE: <span class="number">97</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * NUM_TWO</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  NUM_TWO: <span class="number">98</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * NUM_THREE</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  NUM_THREE: <span class="number">99</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * NUM_FOUR</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  NUM_FOUR: <span class="number">100</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * NUM_FIVE</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  NUM_FIVE: <span class="number">101</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * NUM_SIX</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  NUM_SIX: <span class="number">102</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * NUM_SEVEN</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  NUM_SEVEN: <span class="number">103</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * NUM_EIGHT</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  NUM_EIGHT: <span class="number">104</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * NUM_NINE</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  NUM_NINE: <span class="number">105</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * NUM_MULTIPLY</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  NUM_MULTIPLY: <span class="number">106</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * NUM_PLUS</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  NUM_PLUS: <span class="number">107</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * NUM_MINUS</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  NUM_MINUS: <span class="number">109</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * NUM_PERIOD</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  NUM_PERIOD: <span class="number">110</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * NUM_DIVISION</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  NUM_DIVISION: <span class="number">111</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * F1</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  F1: <span class="number">112</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * F2</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  F2: <span class="number">113</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * F3</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  F3: <span class="number">114</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * F4</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  F4: <span class="number">115</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * F5</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  F5: <span class="number">116</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * F6</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  F6: <span class="number">117</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * F7</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  F7: <span class="number">118</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * F8</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  F8: <span class="number">119</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * F9</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  F9: <span class="number">120</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * F10</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  F10: <span class="number">121</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * F11</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  F11: <span class="number">122</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * F12</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  F12: <span class="number">123</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * NUMLOCK</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  NUMLOCK: <span class="number">144</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * SEMICOLON</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  SEMICOLON: <span class="number">186</span>, <span class="comment">// needs localization</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * DASH</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  DASH: <span class="number">189</span>, <span class="comment">// needs localization</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * EQUALS</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  EQUALS: <span class="number">187</span>, <span class="comment">// needs localization</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * COMMA</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  COMMA: <span class="number">188</span>, <span class="comment">// needs localization</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * PERIOD</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  PERIOD: <span class="number">190</span>, <span class="comment">// needs localization</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * SLASH</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  SLASH: <span class="number">191</span>, <span class="comment">// needs localization</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * APOSTROPHE</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  APOSTROPHE: <span class="number">192</span>, <span class="comment">// needs localization</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * SINGLE_QUOTE</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  SINGLE_QUOTE: <span class="number">222</span>, <span class="comment">// needs localization</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * OPEN_SQUARE_BRACKET</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  OPEN_SQUARE_BRACKET: <span class="number">219</span>, <span class="comment">// needs localization</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * BACKSLASH</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  BACKSLASH: <span class="number">220</span>, <span class="comment">// needs localization</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * CLOSE_SQUARE_BRACKET</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  CLOSE_SQUARE_BRACKET: <span class="number">221</span>, <span class="comment">// needs localization</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * WIN_KEY</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  WIN_KEY: <span class="number">224</span>,</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * MAC_FF_META</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  MAC_FF_META: <span class="number">224</span>, <span class="comment">// Firefox (Gecko) fires this for the meta key instead of 91</span></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * WIN_IME</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  WIN_IME: <span class="number">229</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> whether text and modified key is entered at the same time.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">KeyCode.isTextModifyingKeyEvent = <span class="function"><span class="keyword">function</span> <span class="title">isTextModifyingKeyEvent</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> keyCode = e.keyCode;</span><br><span class="line">  <span class="keyword">if</span> (e.altKey &amp;&amp; !e.ctrlKey || e.metaKey ||</span><br><span class="line">      <span class="comment">// Function keys don't generate text</span></span><br><span class="line">    keyCode &gt;= KeyCode.F1 &amp;&amp; keyCode &lt;= KeyCode.F12) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The following keys are quite harmless, even in combination with</span></span><br><span class="line">  <span class="comment">// CTRL, ALT or SHIFT.</span></span><br><span class="line">  <span class="keyword">switch</span> (keyCode) &#123;</span><br><span class="line">    <span class="keyword">case</span> KeyCode.ALT:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.CAPS_LOCK:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.CONTEXT_MENU:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.CTRL:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.DOWN:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.END:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.ESC:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.HOME:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.INSERT:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.LEFT:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.MAC_FF_META:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.META:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.NUMLOCK:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.NUM_CENTER:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.PAGE_DOWN:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.PAGE_UP:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.PAUSE:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.PRINT_SCREEN:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.RIGHT:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.SHIFT:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.UP:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.WIN_KEY:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.WIN_KEY_RIGHT:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> whether character is entered.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">KeyCode.isCharacterKey = <span class="function"><span class="keyword">function</span> <span class="title">isCharacterKey</span>(<span class="params">keyCode</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (keyCode &gt;= KeyCode.ZERO &amp;&amp;</span><br><span class="line">    keyCode &lt;= KeyCode.NINE) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (keyCode &gt;= KeyCode.NUM_ZERO &amp;&amp;</span><br><span class="line">    keyCode &lt;= KeyCode.NUM_MULTIPLY) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (keyCode &gt;= KeyCode.A &amp;&amp;</span><br><span class="line">    keyCode &lt;= KeyCode.Z) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Safari sends zero key code for non-latin characters.</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">window</span>.navigation.userAgent.indexOf(<span class="string">'WebKit'</span>) !== <span class="number">-1</span> &amp;&amp; keyCode === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (keyCode) &#123;</span><br><span class="line">    <span class="keyword">case</span> KeyCode.SPACE:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.QUESTION_MARK:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.NUM_PLUS:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.NUM_MINUS:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.NUM_PERIOD:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.NUM_DIVISION:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.SEMICOLON:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.DASH:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.EQUALS:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.COMMA:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.PERIOD:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.SLASH:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.APOSTROPHE:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.SINGLE_QUOTE:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.OPEN_SQUARE_BRACKET:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.BACKSLASH:</span><br><span class="line">    <span class="keyword">case</span> KeyCode.CLOSE_SQUARE_BRACKET:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> KeyCode;</span><br></pre></td></tr></table></figure>
<h2 id="pickAttrs"><a href="#pickAttrs" class="headerlink" title="pickAttrs"></a>pickAttrs</h2><p>获取节点的指定属性、以及 ‘data-‘|’aria-‘ 前缀的属性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* eslint-disable max-len */</span></span><br><span class="line"><span class="keyword">const</span> attributes = <span class="string">`accept acceptCharset accessKey action allowFullScreen allowTransparency</span></span><br><span class="line"><span class="string">    alt async autoComplete autoFocus autoPlay capture cellPadding cellSpacing challenge</span></span><br><span class="line"><span class="string">    charSet checked classID className colSpan cols content contentEditable contextMenu</span></span><br><span class="line"><span class="string">    controls coords crossOrigin data dateTime default defer dir disabled download draggable</span></span><br><span class="line"><span class="string">    encType form formAction formEncType formMethod formNoValidate formTarget frameBorder</span></span><br><span class="line"><span class="string">    headers height hidden high href hrefLang htmlFor httpEquiv icon id inputMode integrity</span></span><br><span class="line"><span class="string">    is keyParams keyType kind label lang list loop low manifest marginHeight marginWidth max maxLength media</span></span><br><span class="line"><span class="string">    mediaGroup method min minLength multiple muted name noValidate nonce open</span></span><br><span class="line"><span class="string">    optimum pattern placeholder poster preload radioGroup readOnly rel required</span></span><br><span class="line"><span class="string">    reversed role rowSpan rows sandbox scope scoped scrolling seamless selected</span></span><br><span class="line"><span class="string">    shape size sizes span spellCheck src srcDoc srcLang srcSet start step style</span></span><br><span class="line"><span class="string">    summary tabIndex target title type useMap value width wmode wrap`</span></span><br><span class="line">        .replace(<span class="regexp">/\s+/g</span>, <span class="string">' '</span>).replace(<span class="regexp">/\t|\n|\r/g</span>, <span class="string">''</span>).split(<span class="string">' '</span>);</span><br><span class="line"><span class="keyword">const</span> eventsName = <span class="string">`onCopy onCut onPaste onCompositionEnd onCompositionStart onCompositionUpdate onKeyDown</span></span><br><span class="line"><span class="string">    onKeyPress onKeyUp onFocus onBlur onChange onInput onSubmit onClick onContextMenu onDoubleClick</span></span><br><span class="line"><span class="string">    onDrag onDragEnd onDragEnter onDragExit onDragLeave onDragOver onDragStart onDrop onMouseDown</span></span><br><span class="line"><span class="string">    onMouseEnter onMouseLeave onMouseMove onMouseOut onMouseOver onMouseUp onSelect onTouchCancel</span></span><br><span class="line"><span class="string">    onTouchEnd onTouchMove onTouchStart onScroll onWheel onAbort onCanPlay onCanPlayThrough</span></span><br><span class="line"><span class="string">    onDurationChange onEmptied onEncrypted onEnded onError onLoadedData onLoadedMetadata</span></span><br><span class="line"><span class="string">    onLoadStart onPause onPlay onPlaying onProgress onRateChange onSeeked onSeeking onStalled onSuspend onTimeUpdate onVolumeChange onWaiting onLoad onError`</span></span><br><span class="line">        .replace(<span class="regexp">/\s+/g</span>, <span class="string">' '</span>).replace(<span class="regexp">/\t|\n|\r/g</span>, <span class="string">''</span>).split(<span class="string">' '</span>);</span><br><span class="line"><span class="comment">/* eslint-enable max-len */</span></span><br><span class="line"><span class="keyword">const</span> attrsPrefix = [<span class="string">'data'</span>, <span class="string">'aria'</span>];</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">pickAttrs</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> attrs = &#123;&#125;;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> props) &#123;</span><br><span class="line">    <span class="keyword">if</span> (attributes.indexOf(key) &gt; <span class="number">-1</span> || eventsName.indexOf(key) &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">      attrs[key] = props[key];</span><br><span class="line">    <span class="comment">/* eslint-disable no-loop-func */</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (attrsPrefix.map(<span class="function">(<span class="params">prefix</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">`^<span class="subst">$&#123;prefix&#125;</span>`</span>);</span><br><span class="line">    &#125;).some(<span class="function">(<span class="params">reg</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> key.replace(reg, <span class="string">''</span>) !== key;</span><br><span class="line">    &#125;)) &#123;</span><br><span class="line">    <span class="comment">/* eslint-enable no-loop-func */</span></span><br><span class="line">      attrs[key] = props[key];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> attrs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><ul>
<li>createChainedFunction(…funcs): 创建任务链函数，逐个调用 funcs 函数。</li>
<li>diff(obj1, obj2, depth = 10, path = [], diffList = createArray()): 对比数据，数据内容不等的将塞入 diffList = [{ value1, value2, path }] 中，默认的 diffList 拥有 format, toString 方法进行格式转换或转变为 json 数据。该函数支持嵌套数据对比。</li>
<li>guid: 以当前时间生成 guid。</li>
<li>deprecated(props, instead, component): 提示 prop 已被移除。</li>
<li>warn(msg): 开发环境下提示。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/01/antd/react-component/rc-animate/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/01/antd/react-component/rc-animate/" itemprop="url">rc-animate</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-01T00:00:00+08:00">2019-01-01</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/antd-组件库/" itemprop="url" rel="index"><span itemprop="name">antd 组件库</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/01/01/antd/react-component/rc-animate/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/01/01/antd/react-component/rc-animate/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>rc-animate 同 <a href="https://github.com/reactjs/react-transition-group" target="_blank" rel="noopener">react-transition-group</a>，都用于实现元素的移入移出动效。rc-animate 提供两种动效处理方式，Animate 组件用于处理多元素的移入移出动效，包含 css 和 js 动效；CSSMotion 用于处理单元素的动效，只能处理 css 动效。本文第一部分将介绍 Animate 组件；第二部分将介绍 CSSMotion 组件。</p>
<h2 id="Animate"><a href="#Animate" class="headerlink" title="Animate"></a>Animate</h2><img src="/2019/01/01/antd/react-component/rc-animate/动效视图特征.png">
<p>上图即为多元素移入移出动效的视图特征：</p>
<ol>
<li>child1, child3 元素初始化即显现在视图中，该过程将呈现 appear 动效。</li>
<li>child2 元素在下一个渲染过程中将移入视图，该过程将呈现 enter 动效。</li>
<li>child3 元素在下一个渲染过程中将移出视图，该过程将呈现 leave 动效。</li>
</ol>
<p>因为动效有时延，我们需要致力于解决如下问题：</p>
<ol>
<li>若 child2 在 child1 元素的 appear 动效还未完成时移入，child1 需要继续执行 appear 动效。对此，我们可以用内部状态记录动效执行中的元素，从而不打断动效的执行过程。若 child2 元素的 enter 动效执行期间，视图中再添加 child4, child5，也作相同处理。</li>
<li>若 child3 即将移出视图，先将 child3 保存在内部状态中，等 leave 动效执行完成后，再移除 child3。</li>
</ol>
<p>在 rc-animate 中，上述两个状态表现为 Animate 组件的 currentlyAnimatingKeys 实例属性和 state.children。在 Animate 的 componentWillReceiveProps 生命周期中，将通过 currentlyAnimatingKeys 判断动效是否还在执行阶段，以便在 state.children 中保留该元素。当然，在 componentWillReceiveProps 生命周期，主要的处理逻辑为：根据元素移入移出视图情况更新 state.children，并使用 keysToEnter, keysToLeave 属性记录哪些元素需要执行 enter 或者 leave 动效。对问题 2 的解答也就是在动效完成后更新 state.children。</p>
<p>我们可以将 Animate 看成是动效调节器。不计 enter 动效，Animate 首先将在 componentWillReceiveProps 生命周期计算 child 元素需要执行何种动效，然后在 componentDidUpdate 生命周期执行该动效。实际执行的动效与 child 元素挂钩，那样就可以支持不同元素的展示动效多样化。在 rc-animate 中，AnimateChild 就可以理解成不同元素的动效驱动器。通过 props 定义 child 待执行的动效，由 AnimateChild 提供 componentWillAppear, componentWillEnter, componentWillLeave 方法执行具体的动效，且与 Animate 完成对接。AnimateChild 和 Animate 对接表现为，在 Animate 的 componentDidUpdate 生命周期，最终将调用 AnimateChild 的上述方法。下图是 rc-animate 动效执行的时序图。</p>
<img src="/2019/01/01/antd/react-component/rc-animate/rc-animate时序图.png">
<h3 id="Animate-1"><a href="#Animate-1" class="headerlink" title="Animate"></a>Animate</h3><p>作为动效调节器，Animate 组件用于控制全局层面的动效特征。Animate 以 currentlyAnimatingKeys 实例属性记录正在执行动效的元素；keysToEnter, keysToLeave 实例属性记录待显示隐藏的元素；并在动效执行前后通过更新 state.children 的方式控制子元素的渲染状况；在此过程中，将在动效完成后的回调中执行全局意义的绑定函数，如 props.onAppear, props.onEnter, prop.onLeave, props.onEnd 方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animate</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * didMount 生命周期执行子元素的 appear 动效</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">const</span> showProp = <span class="keyword">this</span>.props.showProp;</span><br><span class="line">    <span class="keyword">let</span> children = <span class="keyword">this</span>.state.children;</span><br><span class="line">    <span class="keyword">if</span> (showProp) &#123;</span><br><span class="line">      children = children.filter(<span class="function">(<span class="params">child</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> !!child.props[showProp];</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    children.forEach(<span class="function">(<span class="params">child</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (child) &#123;</span><br><span class="line">        <span class="keyword">this</span>.performAppear(child.key);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * componentWillReceiveProps 生命周期感知子元素的显示状态变更</span></span><br><span class="line"><span class="comment">   *  1. 更新 state.children 显示子元素以执行 enter, leave 动效</span></span><br><span class="line"><span class="comment">   *  2. 以 this.keysToEnter, this.keysToLeave 收集待执行 enter, leave 动效的元素</span></span><br><span class="line"><span class="comment">   *     以便在 componentDidUpdate 实际执行动效；在动效执行完成后，触发回调显示或移除视图上的子元素</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  componentWillReceiveProps(nextProps) &#123;</span><br><span class="line">    <span class="keyword">this</span>.nextProps = nextProps;</span><br><span class="line">    <span class="keyword">const</span> nextChildren = toArrayChildren(getChildrenFromProps(nextProps));</span><br><span class="line">    <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="comment">// exclusive needs immediate response</span></span><br><span class="line">    <span class="keyword">if</span> (props.exclusive) &#123;</span><br><span class="line">      <span class="built_in">Object</span>.keys(<span class="keyword">this</span>.currentlyAnimatingKeys).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.stop(key);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> showProp = props.showProp;</span><br><span class="line">    <span class="keyword">const</span> currentlyAnimatingKeys = <span class="keyword">this</span>.currentlyAnimatingKeys;</span><br><span class="line">    <span class="comment">// last props children if exclusive</span></span><br><span class="line">    <span class="keyword">const</span> currentChildren = props.exclusive ?</span><br><span class="line">      toArrayChildren(getChildrenFromProps(props)) :</span><br><span class="line">      <span class="keyword">this</span>.state.children;</span><br><span class="line">    <span class="comment">// in case destroy in showProp mode</span></span><br><span class="line">    <span class="keyword">let</span> newChildren = [];</span><br><span class="line">    <span class="keyword">if</span> (showProp) &#123;</span><br><span class="line">      currentChildren.forEach(<span class="function">(<span class="params">currentChild</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> nextChild = currentChild &amp;&amp; findChildInChildrenByKey(nextChildren, currentChild.key);</span><br><span class="line">        <span class="keyword">let</span> newChild;</span><br><span class="line">        <span class="keyword">if</span> ((!nextChild || !nextChild.props[showProp]) &amp;&amp; currentChild.props[showProp]) &#123;</span><br><span class="line">          newChild = React.cloneElement(nextChild || currentChild, &#123;</span><br><span class="line">            [showProp]: <span class="literal">true</span>,</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          newChild = nextChild;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (newChild) &#123;</span><br><span class="line">          newChildren.push(newChild);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      nextChildren.forEach(<span class="function">(<span class="params">nextChild</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!nextChild || !findChildInChildrenByKey(currentChildren, nextChild.key)) &#123;</span><br><span class="line">          newChildren.push(nextChild);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      newChildren = mergeChildren(</span><br><span class="line">        currentChildren,</span><br><span class="line">        nextChildren</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// need render to avoid update</span></span><br><span class="line">    <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">      children: newChildren,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    nextChildren.forEach(<span class="function">(<span class="params">child</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> key = child &amp;&amp; child.key;</span><br><span class="line">      <span class="keyword">if</span> (child &amp;&amp; currentlyAnimatingKeys[key]) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> hasPrev = child &amp;&amp; findChildInChildrenByKey(currentChildren, key);</span><br><span class="line">      <span class="keyword">if</span> (showProp) &#123;</span><br><span class="line">        <span class="keyword">const</span> showInNext = child.props[showProp];</span><br><span class="line">        <span class="keyword">if</span> (hasPrev) &#123;</span><br><span class="line">          <span class="keyword">const</span> showInNow = findShownChildInChildrenByKey(currentChildren, key, showProp);</span><br><span class="line">          <span class="keyword">if</span> (!showInNow &amp;&amp; showInNext) &#123;</span><br><span class="line">            <span class="keyword">this</span>.keysToEnter.push(key);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (showInNext) &#123;</span><br><span class="line">          <span class="keyword">this</span>.keysToEnter.push(key);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!hasPrev) &#123;</span><br><span class="line">        <span class="keyword">this</span>.keysToEnter.push(key);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    currentChildren.forEach(<span class="function">(<span class="params">child</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> key = child &amp;&amp; child.key;</span><br><span class="line">      <span class="keyword">if</span> (child &amp;&amp; currentlyAnimatingKeys[key]) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> hasNext = child &amp;&amp; findChildInChildrenByKey(nextChildren, key);</span><br><span class="line">      <span class="keyword">if</span> (showProp) &#123;</span><br><span class="line">        <span class="keyword">const</span> showInNow = child.props[showProp];</span><br><span class="line">        <span class="keyword">if</span> (hasNext) &#123;</span><br><span class="line">          <span class="keyword">const</span> showInNext = findShownChildInChildrenByKey(nextChildren, key, showProp);</span><br><span class="line">          <span class="keyword">if</span> (!showInNext &amp;&amp; showInNow) &#123;</span><br><span class="line">            <span class="keyword">this</span>.keysToLeave.push(key);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (showInNow) &#123;</span><br><span class="line">          <span class="keyword">this</span>.keysToLeave.push(key);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!hasNext) &#123;</span><br><span class="line">        <span class="keyword">this</span>.keysToLeave.push(key);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * componentDidUpdate 生命周期执行子元素的 enter, leave 动效</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  componentDidUpdate() &#123;</span><br><span class="line">    <span class="keyword">const</span> keysToEnter = <span class="keyword">this</span>.keysToEnter;</span><br><span class="line">    <span class="keyword">this</span>.keysToEnter = [];</span><br><span class="line">    keysToEnter.forEach(<span class="keyword">this</span>.performEnter);</span><br><span class="line">    <span class="keyword">const</span> keysToLeave = <span class="keyword">this</span>.keysToLeave;</span><br><span class="line">    <span class="keyword">this</span>.keysToLeave = [];</span><br><span class="line">    keysToLeave.forEach(<span class="keyword">this</span>.performLeave);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 实际调用 AnimateChild 组件的 componentWillEnter 方法执行动效</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  performEnter = <span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// may already remove by exclusive</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.childrenRefs[key]) &#123;</span><br><span class="line">      <span class="keyword">this</span>.currentlyAnimatingKeys[key] = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">this</span>.childrenRefs[key].componentWillEnter(</span><br><span class="line">        <span class="keyword">this</span>.handleDoneAdding.bind(<span class="keyword">this</span>, key, <span class="string">'enter'</span>)</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  performAppear = <span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.childrenRefs[key]) &#123;</span><br><span class="line">      <span class="keyword">this</span>.currentlyAnimatingKeys[key] = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">this</span>.childrenRefs[key].componentWillAppear(</span><br><span class="line">        <span class="keyword">this</span>.handleDoneAdding.bind(<span class="keyword">this</span>, key, <span class="string">'appear'</span>)</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * enter, appear 动效执行完成后的回调</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  handleDoneAdding = <span class="function">(<span class="params">key, type</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">delete</span> <span class="keyword">this</span>.currentlyAnimatingKeys[key];</span><br><span class="line">    <span class="comment">// if update on exclusive mode, skip check</span></span><br><span class="line">    <span class="keyword">if</span> (props.exclusive &amp;&amp; props !== <span class="keyword">this</span>.nextProps) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> currentChildren = toArrayChildren(getChildrenFromProps(props));</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.isValidChildByKey(currentChildren, key)) &#123;</span><br><span class="line">      <span class="comment">// exclusive will not need this</span></span><br><span class="line">      <span class="keyword">this</span>.performLeave(key);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">'appear'</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (animUtil.allowAppearCallback(props)) &#123;</span><br><span class="line">        props.onAppear(key);</span><br><span class="line">        props.onEnd(key, <span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (animUtil.allowEnterCallback(props)) &#123;</span><br><span class="line">      props.onEnter(key);</span><br><span class="line">      props.onEnd(key, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  performLeave = <span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// may already remove by exclusive</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.childrenRefs[key]) &#123;</span><br><span class="line">      <span class="keyword">this</span>.currentlyAnimatingKeys[key] = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">this</span>.childrenRefs[key].componentWillLeave(<span class="keyword">this</span>.handleDoneLeaving.bind(<span class="keyword">this</span>, key));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleDoneLeaving = <span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">delete</span> <span class="keyword">this</span>.currentlyAnimatingKeys[key];</span><br><span class="line">    <span class="comment">// if update on exclusive mode, skip check</span></span><br><span class="line">    <span class="keyword">if</span> (props.exclusive &amp;&amp; props !== <span class="keyword">this</span>.nextProps) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> currentChildren = toArrayChildren(getChildrenFromProps(props));</span><br><span class="line">    <span class="comment">// in case state change is too fast</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.isValidChildByKey(currentChildren, key)) &#123;</span><br><span class="line">      <span class="keyword">this</span>.performEnter(key);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> end = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (animUtil.allowLeaveCallback(props)) &#123;</span><br><span class="line">          props.onLeave(key);</span><br><span class="line">          props.onEnd(key, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">if</span> (!isSameChildren(<span class="keyword">this</span>.state.children,</span><br><span class="line">        currentChildren, props.showProp)) &#123;</span><br><span class="line">        <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">          children: currentChildren,</span><br><span class="line">        &#125;, end);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        end();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">this</span>.nextProps = props;</span><br><span class="line">    <span class="keyword">const</span> stateChildren = <span class="keyword">this</span>.state.children;</span><br><span class="line">    <span class="keyword">let</span> children = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (stateChildren) &#123;</span><br><span class="line">      children = stateChildren.map(<span class="function">(<span class="params">child</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (child === <span class="literal">null</span> || child === <span class="literal">undefined</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> child;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!child.key) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'must set key for &lt;rc-animate&gt; children'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">          &lt;AnimateChild</span><br><span class="line">            key=&#123;child.key&#125;</span><br><span class="line">            ref=&#123;node =&gt; &#123; <span class="keyword">this</span>.childrenRefs[child.key] = node &#125;&#125;</span><br><span class="line">            animation=&#123;props.animation&#125;</span><br><span class="line">            transitionName=&#123;props.transitionName&#125;</span><br><span class="line">            transitionEnter=&#123;props.transitionEnter&#125;</span><br><span class="line">            transitionAppear=&#123;props.transitionAppear&#125;</span><br><span class="line">            transitionLeave=&#123;props.transitionLeave&#125;</span><br><span class="line">          &gt;</span><br><span class="line">            &#123;child&#125;</span><br><span class="line">          &lt;<span class="regexp">/AnimateChild&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">      &#125;);</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    const Component = props.component;</span></span><br><span class="line"><span class="regexp">    if (Component) &#123;</span></span><br><span class="line"><span class="regexp">      let passedProps = props;</span></span><br><span class="line"><span class="regexp">      if (typeof Component === 'string') &#123;</span></span><br><span class="line"><span class="regexp">        passedProps = &#123;</span></span><br><span class="line"><span class="regexp">          className: props.className,</span></span><br><span class="line"><span class="regexp">          style: props.style,</span></span><br><span class="line"><span class="regexp">          ...props.componentProps,</span></span><br><span class="line"><span class="regexp">        &#125;;</span></span><br><span class="line"><span class="regexp">      &#125;</span></span><br><span class="line"><span class="regexp">      return &lt;Component &#123;...passedProps&#125;&gt;&#123;children&#125;&lt;/</span>Component&gt;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> children[<span class="number">0</span>] || <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AnimateChild"><a href="#AnimateChild" class="headerlink" title="AnimateChild"></a>AnimateChild</h3><p>如上文所说，AnimateChild 组件用于实现元素的具体动效。支持的动效包含 css3 动效和 js 动效。其中，css3 动效通过 props.transitionName, props.transitionEnter, props.transitionAppear, props.transitionLeave 属性加以配置；js 动效通过 props.animation 动效方法集 { appear?, enter?, leave? } 加以配置，动效可使用 jQuery 操作节点的方式实现。AnimateChild 组件接受的 props 属性均由用户端通过 Animate 动效调节器注入。在 AnimateChild 组件中，驱动动效的方法直接表现为 transition 实例方法，而 stop 实例方法用于中止动效。</p>
<p>通过源码，我们可以发现，当用户以字符串配置 props.transitionName 属性时，执行 appear 动效的节点将获得的样式类为 <code>${transitionName}-appear</code>, <code>${transitionName}-appear-active</code> 形式。当以对象配置 props.transitionName 属性时，节点获得的样式类前缀 <code>${transitionName}-appear</code> 将被替换为 <code>${transitionName.appear}</code>。props.transitionEnter, props.transitionAppear, props.transitionLeave 属性用于启动或关闭动效。在 css 动效的优先级后，节点将执行 props.animate.appear 动效。以下是动效的实现源码，AnimateChild 组件的 componentWillEnter, componentWillAppear, componentWillLeave 实例方法均基于 transition 方法实现。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnimateChild</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 实际执行 css 或 js 动效</span></span><br><span class="line"><span class="comment">   * @param &#123;string&#125; animationType 动效类型，值为 'appear', 'enter', 'leave' 中的一个</span></span><br><span class="line"><span class="comment">   * @param &#123;function&#125; finishCallback 回调函数，在动效完成后执行</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  transition(animationType, finishCallback) &#123;</span><br><span class="line">    <span class="keyword">const</span> node = ReactDOM.findDOMNode(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">const</span> transitionName = props.transitionName;</span><br><span class="line">    <span class="keyword">const</span> nameIsObj = <span class="keyword">typeof</span> transitionName === <span class="string">'object'</span>;</span><br><span class="line">    <span class="keyword">this</span>.stop();</span><br><span class="line">    <span class="keyword">const</span> end = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.stopper = <span class="literal">null</span>;</span><br><span class="line">      finishCallback();</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> ((isCssAnimationSupported || !props.animation[animationType]) &amp;&amp;</span><br><span class="line">      transitionName &amp;&amp; props[transitionMap[animationType]]) &#123;</span><br><span class="line">      <span class="keyword">const</span> name = nameIsObj ? transitionName[animationType] : <span class="string">`<span class="subst">$&#123;transitionName&#125;</span>-<span class="subst">$&#123;animationType&#125;</span>`</span>;</span><br><span class="line">      <span class="keyword">let</span> activeName = <span class="string">`<span class="subst">$&#123;name&#125;</span>-active`</span>;</span><br><span class="line">      <span class="keyword">if</span> (nameIsObj &amp;&amp; transitionName[<span class="string">`<span class="subst">$&#123;animationType&#125;</span>Active`</span>]) &#123;</span><br><span class="line">        activeName = transitionName[<span class="string">`<span class="subst">$&#123;animationType&#125;</span>Active`</span>];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.stopper = cssAnimate(node, &#123;</span><br><span class="line">        name,</span><br><span class="line">        active: activeName,</span><br><span class="line">      &#125;, end);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.stopper = props.animation[animationType](node, end);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 关闭动效</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  stop() &#123;</span><br><span class="line">    <span class="keyword">const</span> stopper = <span class="keyword">this</span>.stopper;</span><br><span class="line">    <span class="keyword">if</span> (stopper) &#123;</span><br><span class="line">      <span class="keyword">this</span>.stopper = <span class="literal">null</span>;</span><br><span class="line">      stopper.stop();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="css-动效"><a href="#css-动效" class="headerlink" title="css 动效"></a>css 动效</h3><p>rc-animate 库的 css 动效通过 css-animation 库实现，其直接构成 AnimateChild 组件中使用的 cssAnimate 函数。</p>
<p>css-animation 库先行侦测浏览器环境支持的 transition, animate 事件（webkit 等前缀）。若支持这两类事件，直接对节点绑定这两类事件的处理函数；若不支持，使用 setTimeout 构造虚拟事件。以下是 css-animation 库侦测浏览器支持事件的源码实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> START_EVENT_NAME_MAP = &#123;</span><br><span class="line">  transitionstart: &#123;</span><br><span class="line">    transition: <span class="string">'transitionstart'</span>,</span><br><span class="line">    WebkitTransition: <span class="string">'webkitTransitionStart'</span>,</span><br><span class="line">    MozTransition: <span class="string">'mozTransitionStart'</span>,</span><br><span class="line">    OTransition: <span class="string">'oTransitionStart'</span>,</span><br><span class="line">    msTransition: <span class="string">'MSTransitionStart'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  animationstart: &#123;</span><br><span class="line">    animation: <span class="string">'animationstart'</span>,</span><br><span class="line">    WebkitAnimation: <span class="string">'webkitAnimationStart'</span>,</span><br><span class="line">    MozAnimation: <span class="string">'mozAnimationStart'</span>,</span><br><span class="line">    OAnimation: <span class="string">'oAnimationStart'</span>,</span><br><span class="line">    msAnimation: <span class="string">'MSAnimationStart'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> END_EVENT_NAME_MAP = &#123;</span><br><span class="line">  transitionend: &#123;</span><br><span class="line">    transition: <span class="string">'transitionend'</span>,</span><br><span class="line">    WebkitTransition: <span class="string">'webkitTransitionEnd'</span>,</span><br><span class="line">    MozTransition: <span class="string">'mozTransitionEnd'</span>,</span><br><span class="line">    OTransition: <span class="string">'oTransitionEnd'</span>,</span><br><span class="line">    msTransition: <span class="string">'MSTransitionEnd'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  animationend: &#123;</span><br><span class="line">    animation: <span class="string">'animationend'</span>,</span><br><span class="line">    WebkitAnimation: <span class="string">'webkitAnimationEnd'</span>,</span><br><span class="line">    MozAnimation: <span class="string">'mozAnimationEnd'</span>,</span><br><span class="line">    OAnimation: <span class="string">'oAnimationEnd'</span>,</span><br><span class="line">    msAnimation: <span class="string">'MSAnimationEnd'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> startEvents = [];</span><br><span class="line"><span class="keyword">const</span> endEvents = [];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">detectEvents</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> testEl = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span><br><span class="line">  <span class="keyword">const</span> style = testEl.style;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!(<span class="string">'AnimationEvent'</span> <span class="keyword">in</span> <span class="built_in">window</span>)) &#123;</span><br><span class="line">    <span class="keyword">delete</span> START_EVENT_NAME_MAP.animationstart.animation;</span><br><span class="line">    <span class="keyword">delete</span> END_EVENT_NAME_MAP.animationend.animation;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!(<span class="string">'TransitionEvent'</span> <span class="keyword">in</span> <span class="built_in">window</span>)) &#123;</span><br><span class="line">    <span class="keyword">delete</span> START_EVENT_NAME_MAP.transitionstart.transition;</span><br><span class="line">    <span class="keyword">delete</span> END_EVENT_NAME_MAP.transitionend.transition;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">process</span>(<span class="params">EVENT_NAME_MAP, events</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 遍历 transition, animate 类目</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> baseEventName <span class="keyword">in</span> EVENT_NAME_MAP) &#123;</span><br><span class="line">      <span class="keyword">if</span> (EVENT_NAME_MAP.hasOwnProperty(baseEventName)) &#123;</span><br><span class="line">        <span class="keyword">const</span> baseEvents = EVENT_NAME_MAP[baseEventName];</span><br><span class="line">        <span class="comment">// 遍历特定浏览器的事件前缀名，将支持的事件存入 startEvents, endEvents 数组中</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> styleName <span class="keyword">in</span> baseEvents) &#123;</span><br><span class="line">          <span class="keyword">if</span> (styleName <span class="keyword">in</span> style) &#123;</span><br><span class="line">            events.push(baseEvents[styleName]);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  process(START_EVENT_NAME_MAP, startEvents);</span><br><span class="line">  process(END_EVENT_NAME_MAP, endEvents);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">window</span> !== <span class="string">'undefined'</span> &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">document</span> !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">  detectEvents();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同常见的 css 动效实现，css-animation 库首先为节点添加 transitionName 样式类；30 ms 后又为节点添加 <code>${transitionName}-active</code> 样式类；并在动效执行完成后，通过绑定事件为节点移除前两个样式类；若事件无效，css-animation 将使用定时器移除样式类。以下是这段逻辑的实现代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cssAnimation = <span class="function">(<span class="params">node, transitionName, endCallback</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> nameIsObj = <span class="keyword">typeof</span> transitionName === <span class="string">'object'</span>;</span><br><span class="line">  <span class="keyword">const</span> className = nameIsObj ? transitionName.name : transitionName;</span><br><span class="line">  <span class="keyword">const</span> activeClassName = nameIsObj ? transitionName.active : <span class="string">`<span class="subst">$&#123;transitionName&#125;</span>-active`</span>;</span><br><span class="line">  <span class="keyword">let</span> end = endCallback;</span><br><span class="line">  <span class="keyword">let</span> start;</span><br><span class="line">  <span class="keyword">let</span> active;</span><br><span class="line">  <span class="comment">// 函数 classes 由 component-classes 提供，针对多平台处理样式类列表</span></span><br><span class="line">  <span class="keyword">const</span> nodeClasses = classes(node);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (endCallback &amp;&amp; <span class="built_in">Object</span>.prototype.toString.call(endCallback) === <span class="string">'[object Object]'</span>) &#123;</span><br><span class="line">    end = endCallback.end;</span><br><span class="line">    start = endCallback.start;</span><br><span class="line">    active = endCallback.active;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (node.rcEndListener) &#123;</span><br><span class="line">    node.rcEndListener();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 回调中移除样式类</span></span><br><span class="line">  node.rcEndListener = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (e &amp;&amp; e.target !== node) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (node.rcAnimTimeout) &#123;</span><br><span class="line">      clearTimeout(node.rcAnimTimeout);</span><br><span class="line">      node.rcAnimTimeout = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// clearBrowserBugTimeout 函数用于清除 fixBrowserByTimeout 函数设置的定时器</span></span><br><span class="line">    clearBrowserBugTimeout(node);</span><br><span class="line"></span><br><span class="line">    nodeClasses.remove(className);</span><br><span class="line">    nodeClasses.remove(activeClassName);</span><br><span class="line"></span><br><span class="line">    Event.removeEndEventListener(node, node.rcEndListener);</span><br><span class="line">    node.rcEndListener = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (end) &#123;</span><br><span class="line">      end();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  Event.addEndEventListener(node, node.rcEndListener);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (start) &#123;</span><br><span class="line">    start();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加样式类，执行动效</span></span><br><span class="line">  nodeClasses.add(className);</span><br><span class="line"></span><br><span class="line">  node.rcAnimTimeout = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    node.rcAnimTimeout = <span class="literal">null</span>;</span><br><span class="line">    nodeClasses.add(activeClassName);</span><br><span class="line">    <span class="keyword">if</span> (active) &#123;</span><br><span class="line">      setTimeout(active, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fixBrowserByTimeout 函数使用定时器执行 node.rcEndListener 方法，以清除动效相关的样式类</span></span><br><span class="line">    <span class="comment">// 常态下使用绑定事件清除样式类，fixBrowserByTimeout 用于针对浏览器在绑定事件上的 bug</span></span><br><span class="line">    fixBrowserByTimeout(node);</span><br><span class="line">  &#125;, <span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    stop() &#123;</span><br><span class="line">      <span class="keyword">if</span> (node.rcEndListener) &#123;</span><br><span class="line">        node.rcEndListener();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="CSSMotion"><a href="#CSSMotion" class="headerlink" title="CSSMotion"></a>CSSMotion</h2><p>CSSMotion 组件实现 css 动效的处理逻辑如同上文所说，即在元素显现时添加 <code>${transitionName}-appear</code>, <code>${transitionName}-appear-active</code> 样式类，在动效完成后，再移除这两个样式类；enter, leave 动效同此。在 CSSMotion 组件中，变量 props.transitionName 实际表现为配置项 props.motionName。</p>
<p>在处理样式类变更逻辑上，CSSMotion 组件内部使用 state.status 状态表示动效的类型，state.statusActive 状态表示动效是否在执行阶段，state.newStatus 状态表示是否需要执行新的动效，state.statusStyle 状态表示动效执行期间附加的样式。父子组件交互层面，CSSMotion 组件通过接受 props 属性影响内部子组件的显示动效：初始化 props.visible 和 props.motionAppear 均为真值时执行 appear 动效；当 props.visible 由 false 转为 true 且 props.motionEnter 为真值时执行 enter 动效；当 props.visible 由 true 转为 false 且 props.motionLeave 为真值时执行 leave 动效。state.statusStyle 样式由 props.onAppearStart, props.onEnterStart, props.onLeaveStart, props.onAppearActive, props.onEnterActive, props.onLeaveActive, props.onAppearEnd, props.onEnterEnd, props.onLeaveEnd 监听函数计算获得，顾名思义，这些函数的执行时机分别为动效起始、执行和结束阶段。state.status, state.statusActive, state.statusStyle 最终将影响函数式子组件获得的 props 参数。</p>
<p>CSSMotion 组件的处理流程为：</p>
<ol>
<li>通过 getDerivedStateFromProps 静态方法计算 state.status，划定元素将执行何种动效；同时将 state.newStatus 置为真值，表示元素将执行新的动效；且将 state.statusActive 置为否值，表示动效处于等待执行状态。</li>
<li>componentDidMount, componentDidUpdate 生命周期调用 onDomUpdate 实例方法，为元素绑定动效完成后的回调函数，并启动动效的实际处理逻辑。</li>
<li>动效的实际处理逻辑通过 updateStatus 实例方法启动，以 appear 动效为例，首先调用 props.onAppearStart 方法计算元素的样式，以更新注入子组件的 state.statusStyle，将 state.newStatus 置为否值；其次在回调中调用 updateActiveStatus 实例方法，在下一帧渲染过程调用 props.onAppearActive 方法更新 state.statusStyle 样式，且将 state.statusActive 置为真值，以启动 css 动效；当动效执行完成后，通过绑定函数执行 onMotionEnd 实例方法，即通过 props.onAppearEnd 计算 state.statusStyle 样式，且重置 state.status 状态，以指示子组件动效已执行完成。</li>
<li>componentWillUnmount 生命周期解绑监听函数。</li>
</ol>
<p>以下 CSSMotion 组件的源码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CSSMotion</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 通过更新 state.status 状态指定子组件需要执行哪种动效</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> getDerivedStateFromProps(props, &#123; prevProps &#125;) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isSupportTransition(props)) <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">      visible, motionAppear, motionEnter, motionLeave,</span><br><span class="line">      motionLeaveImmediately,</span><br><span class="line">    &#125; = props;</span><br><span class="line">    <span class="keyword">const</span> newState = &#123;</span><br><span class="line">      prevProps: props,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Appear</span></span><br><span class="line">    <span class="keyword">if</span> (!prevProps &amp;&amp; visible &amp;&amp; motionAppear) &#123;</span><br><span class="line">      newState.status = STATUS_APPEAR;</span><br><span class="line">      newState.statusActive = <span class="literal">false</span>;</span><br><span class="line">      newState.newStatus = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Enter</span></span><br><span class="line">    <span class="keyword">if</span> (prevProps &amp;&amp; !prevProps.visible &amp;&amp; visible &amp;&amp; motionEnter) &#123;</span><br><span class="line">      newState.status = STATUS_ENTER;</span><br><span class="line">      newState.statusActive = <span class="literal">false</span>;</span><br><span class="line">      newState.newStatus = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Leave</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      (prevProps &amp;&amp; prevProps.visible &amp;&amp; !visible &amp;&amp; motionLeave) ||</span><br><span class="line">      (!prevProps &amp;&amp; motionLeaveImmediately &amp;&amp; !visible &amp;&amp; motionLeave)</span><br><span class="line">    ) &#123;</span><br><span class="line">      newState.status = STATUS_LEAVE;</span><br><span class="line">      newState.statusActive = <span class="literal">false</span>;</span><br><span class="line">      newState.newStatus = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> newState;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * componentDidMount, componentDidUpdate 生命周期驱动动效的实际处理逻辑</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  onDomUpdate = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; status, newStatus &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">      onAppearStart, onEnterStart, onLeaveStart,</span><br><span class="line">      onAppearActive, onEnterActive, onLeaveActive,</span><br><span class="line">      motionAppear, motionEnter, motionLeave,</span><br><span class="line">    &#125; = <span class="keyword">this</span>.props;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isSupportTransition(<span class="keyword">this</span>.props)) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绑定 onMotionEnd 回调函数；动效完成后，执行 onMotionEnd 实例方法</span></span><br><span class="line">    <span class="keyword">const</span> $ele = ReactDOM.findDOMNode(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.$ele !== $ele) &#123;</span><br><span class="line">      <span class="keyword">this</span>.removeEventListener(<span class="keyword">this</span>.$ele);</span><br><span class="line">      <span class="keyword">this</span>.addEventListener($ele);</span><br><span class="line">      <span class="keyword">this</span>.$ele = $ele;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 首次执行 updateStatus 实例方法将通过 props.onAppearStart 计算注入子元素的样式</span></span><br><span class="line">    <span class="comment">// 其次执行 updateActiveStatus 实例方法将 state.statusActive 以启动动效</span></span><br><span class="line">    <span class="keyword">if</span> (newStatus &amp;&amp; status === STATUS_APPEAR &amp;&amp; motionAppear) &#123;</span><br><span class="line">      <span class="keyword">this</span>.updateStatus(onAppearStart, <span class="literal">null</span>, <span class="literal">null</span>, () =&gt; &#123;</span><br><span class="line">        <span class="keyword">this</span>.updateActiveStatus(onAppearActive, STATUS_APPEAR);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newStatus &amp;&amp; status === STATUS_ENTER &amp;&amp; motionEnter) &#123;</span><br><span class="line">      <span class="keyword">this</span>.updateStatus(onEnterStart, <span class="literal">null</span>, <span class="literal">null</span>, () =&gt; &#123;</span><br><span class="line">        <span class="keyword">this</span>.updateActiveStatus(onEnterActive, STATUS_ENTER);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newStatus &amp;&amp; status === STATUS_LEAVE &amp;&amp; motionLeave) &#123;</span><br><span class="line">      <span class="keyword">this</span>.updateStatus(onLeaveStart, <span class="literal">null</span>, <span class="literal">null</span>, () =&gt; &#123;</span><br><span class="line">        <span class="keyword">this</span>.updateActiveStatus(onLeaveActive, STATUS_LEAVE);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 调用 props.onAppearStart 等方法计算注入子元素的样式，并在下一帧渲染时调用 callback</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  updateStatus = <span class="function">(<span class="params">styleFunc, additionalState, event, callback</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> statusStyle = styleFunc ? styleFunc(ReactDOM.findDOMNode(<span class="keyword">this</span>), event) : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (statusStyle === <span class="literal">false</span> || <span class="keyword">this</span>._destroyed) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> nextStep;</span><br><span class="line">    <span class="keyword">if</span> (callback) &#123;</span><br><span class="line">      nextStep = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.nextFrame(callback);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">      statusStyle: <span class="keyword">typeof</span> statusStyle === <span class="string">'object'</span> ? statusStyle : <span class="literal">null</span>,</span><br><span class="line">      newStatus: <span class="literal">false</span>,</span><br><span class="line">      ...additionalState,</span><br><span class="line">    &#125;, nextStep); <span class="comment">// Trigger before next frame &amp; after `componentDidMount`</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 将 state.statusActive 置为真值，以启动 css 动效</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  updateActiveStatus = <span class="function">(<span class="params">styleFunc, currentStatus</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// this.nextFrame 使用 raf 库实现下一帧渲染</span></span><br><span class="line">    <span class="keyword">this</span>.nextFrame(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; status &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">      <span class="keyword">if</span> (status !== currentStatus) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.updateStatus(styleFunc, &#123; <span class="attr">statusActive</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 动效执行完成后回调，更新 state.status 以清除注入子元素的样式</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  onMotionEnd = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; status, statusActive &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">    <span class="keyword">const</span> &#123; onAppearEnd, onEnterEnd, onLeaveEnd &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">if</span> (status === STATUS_APPEAR &amp;&amp; statusActive) &#123;</span><br><span class="line">      <span class="keyword">this</span>.updateStatus(onAppearEnd, &#123; <span class="attr">status</span>: STATUS_NONE &#125;, event);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (status === STATUS_ENTER &amp;&amp; statusActive) &#123;</span><br><span class="line">      <span class="keyword">this</span>.updateStatus(onEnterEnd, &#123; <span class="attr">status</span>: STATUS_NONE &#125;, event);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (status === STATUS_LEAVE &amp;&amp; statusActive) &#123;</span><br><span class="line">      <span class="keyword">this</span>.updateStatus(onLeaveEnd, &#123; <span class="attr">status</span>: STATUS_NONE &#125;, event);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; status, statusActive, statusStyle &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">    <span class="keyword">const</span> &#123; children, motionName, visible, removeOnLeave, leavedClassName &#125; = <span class="keyword">this</span>.props;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!children) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (status === STATUS_NONE || !isSupportTransition(<span class="keyword">this</span>.props)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (visible) &#123;</span><br><span class="line">        <span class="keyword">return</span> children(&#123;&#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!removeOnLeave) &#123;</span><br><span class="line">        <span class="keyword">return</span> children(&#123; <span class="attr">className</span>: leavedClassName &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 子组件以函数式组价形式接受样式类和样式</span></span><br><span class="line">    <span class="keyword">return</span> children(&#123;</span><br><span class="line">      className: classNames(&#123;</span><br><span class="line">        [getTransitionName(motionName, status)]: status !== STATUS_NONE,</span><br><span class="line">        [getTransitionName(motionName, <span class="string">`<span class="subst">$&#123;status&#125;</span>-active`</span>)]: status !== STATUS_NONE &amp;&amp; statusActive,</span><br><span class="line">        [motionName]: <span class="keyword">typeof</span> motionName === <span class="string">'string'</span>,</span><br><span class="line">      &#125;),</span><br><span class="line">      style: statusStyle,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/12/10/antd/Menu/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/12/10/antd/Menu/" itemprop="url">Menu</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-12-10T00:00:00+08:00">2018-12-10</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/antd-组件库/" itemprop="url" rel="index"><span itemprop="name">antd 组件库</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/12/10/antd/Menu/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/12/10/antd/Menu/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>antd 中的 Menu 组件用于绘制菜单栏，其实现基于 <a href="https://github.com/react-component/menu" target="_blank" rel="noopener">rc-menu</a>。本文第一部分介绍菜单栏实现的整体结构；第二部分介绍 rc-menu；第三部分介绍 Menu 组件。</p>
<p>需要声明的是，本文使用 RcMenu 指代 rc-menu 输出的 Menu 组件或其实例，使用 Menu 指代 antd 输出的 Menu 组件或其实例、或抽象意义的菜单栏组件，余同。</p>
<h2 id="整体结构"><a href="#整体结构" class="headerlink" title="整体结构"></a>整体结构</h2><p>在视图上，菜单栏分为水平布局和垂直布局两种，又支持层叠嵌套（如主菜单 Menu 嵌套子菜单 SubMenu）；子菜单的展开形式分为内嵌和浮层两种。Menu 组件通过 props.mode 区分所采用的模式：vertical 为垂直模式；horizontal 为水平模式；inline 为内嵌模式。菜单栏的垂直布局和水平布局借助样式实现。在水平布局中，超出菜单栏宽度的菜单项需要合并展示，这部分处理逻辑由 rc-menu 中的 DomWrap 组件实现。</p>
<p>在内容上，主菜单和子菜单相仿，功能上有交集。在 rc-menu 中，主菜单 Menu 和子菜单 SubMenu 均通过 SubPopupMenu 组件绘制内容，SubPopupMenu 又使用 DomWrap 控制水平布局时的元素展示。SubPopupMenu 自有的处理逻辑为：控制菜单栏的激活状态（通过 componentDidUpdate, onKeyDown, onItemHover 方法达成，详见下文）。用过 antd 的同学应该了解，Menu 组件下可使用 SubMenu, MenuItem, MenuItemGroup 绘制子菜单或菜单项，父子元素之间就会有状态管理方面的通信需求。针对这个问题，SubPopupMenu 使用 React.clone 方法将父组件实现的状态管理函数或其 props 属性注入到子组件中，从而串联了主菜单与子菜单、主菜单与菜单项、以及子菜单与菜单项。</p>
<p>菜单栏的状态管理分为三种：菜单项的激活状态、菜单项的选中状态、子菜单的展开折叠状态。rc-menu 借助 <a href="https://github.com/yesmeck/mini-store" target="_blank" rel="noopener">mini-store</a> 管理这些状态：activeKey 激活的菜单项，selectedKeys 选中的菜单项，openKeys 展开的子菜单。如上文所说，activeKey 由 SubPopupMenu 处理其更新逻辑。selectedKeys, openKeys 均由 RcMenu 处理其更新逻辑。交互层面，当 props.selectedKeys, props.openKeys 变更时，RcMenu 提供的 updateMiniStore 方法将负责更新 store 中的存储数据；当用户行为发生时，RcMenu 提供的 onSelect, onDeSelect, onOpenChange 方法将负责更新 store 中的存储数据，这些方法又通过 SubPopupMenu 长传到 SubMenu, MenuItem, MenuItemGroup 中。简而言之，RcMenu 既通过 props 接受使用者传入的菜单栏整体配置数据，又集成了 selectedKeys, openKeys 的状态管理函数。</p>
<p>在 RcMenu 提供 onSelect, onDeSelect, onOpenChange 方法和 SubPopupMenu 提供的 onItemHover 方法的基础上，子菜单 RcSubMenu 既将 onSelect, onDeSelect 透传给菜单项，又使用 onOpenChange 控制展开折叠状态，onItemHover 更新激活状态。不同于主菜单，子菜单需要以内嵌或浮层形式表现内容，且需要在展开与折叠过程中显示动效。借助 <a href="https://github.com/react-component/trigger" target="_blank" rel="noopener">rc-trigger</a>、<a href="https://github.com/react-component/animate" target="_blank" rel="noopener">rc-animate</a> 库，RcSubMenu 集成了浮层显示功能和动效展示逻辑。即，通过 props.mode 判断菜单栏是否采用 inline 模式，RcSubMenu 将以浮层形式绘制子菜单内容；子菜单展开与折叠过程中所采用的动效，取决于顶层容器 Menu 主菜单接受 props 配置。</p>
<p>菜单项 RcMenuItem 通过 props 接受 RcMenu 提供的 onSelect, onDeSelect 方法和 SubPopupMenu 提供的 onItemHover 方法，以便在点击事件、鼠标移入移出时更新 store 中的状态。在 RcMenuItem 的基础上，RcMenuItemGroup 用于绘制成组的菜单项。</p>
<p>下图是 rc-menu 的整体结构:<br><img src="/2018/12/10/antd/Menu/rc-menu整体结构.png"></p>
<p>在 rc-menu 实现状态管理的基础上，antd 提供的 Menu 组件用于桥接侧边栏和菜单栏的关联性，维护内置的动效显示，以及样式处理。详见下文。</p>
<h2 id="rc-menu"><a href="#rc-menu" class="headerlink" title="rc-menu"></a>rc-menu</h2><p>rc-menu 的类图为：<br><img src="/2018/12/10/antd/Menu/rc-menu类图.png"></p>
<p>rc-menu 中的状态管理：</p>
<ol>
<li>selectedKeys 选中的菜单项：由 RcMenu 提供 onSelect, onDeselect 方法加以管理。onSelect, onDeselect 方法将长传到 RcMenuItem 组件，以便在 RcMenuItem 的 onKeyDown, onClick 行为中更新状态。同时，在 RcMenu 的 componentDidUpdate 生命周期中，也将 props.selectedKeys 更新状态值。</li>
<li>openKeys 展开的子菜单：由 RcMenu 提供 onOpenChange 方法加以管理。onOpenChange 方法将长传到 RcSubMenu 组件并封装为 RcSubMenu.triggerOpenChange 方法，以便在 RcSubMenu 的 onKeyDown, onTitleClick, onPopupVisibleChange 行为中更新状态。同时，在 RcMenu 的 componentDidUpdate 生命周期中，也将 props.openKeys 更新状态值。</li>
<li>activeKey 激活的菜单项：由辅助函数 updateActiveKey 加以管理。updateActiveKey 函数被 SubPopupMenu 的 componentDidUpdate, onItemHover 方法调用。其中，onItemHover 方法将长传到 RcSubMenu 或 RcMenuItem 组件，以便在 RcSubMenu 的 onTitleMouseEnter, onTitleMouseLeave 行为或 RcMenuItem 的 onMouseEnter, onMouseLeave 行为中更新状态。</li>
<li>defaultActiveFirst 是否激活首个菜单项，辅助计算激活的菜单项：由辅助函数 updateDefaultActiveFirst 加以管理。updateDefaultActiveFirst 函数被 RcSubMenu 的 constructor, onKeyDown, onMouseEnter, onTitleClick 方法调用。其中，constructor 将视 RcSubMenu 接受的 props.defaultActiveFirst 设置状态；onKeyDown 将状态更新为 true；onMouseEnter, onTitleClick 均更新为 false。</li>
</ol>
<p>rc-menu 中的 key 键用于辅助状态管理。key 键仅对于子菜单或菜单项才有效。在默认情况下，SubPopupMenu 会以 ‘0-menu-‘ 作为前缀，递归创建子菜单或菜单项的 key 键，并设置为该子菜单或菜单项的 props.eventKey。当菜单项作为子菜单的元素时，那么菜单项的 key 键就以子菜单的 props.eventKey 作为前缀。当使用者为子菜单或菜单项设置了 key 键时，rc-menu 将以它作为该子菜单或菜单项的 props.eventKey 键。因此，相同的 key 键是不被允许的。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当 SubPopupMenu 作为 RcMenu 的直系子元素时，返回 '0-menu-'</span></span><br><span class="line"><span class="comment">// 其余情况获取子菜单或菜单项的 props.eventKey</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getEventKey</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> props.eventKey || <span class="string">'0-menu-'</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 自动创建 key 键并返回，或者返回使用者设置的 key 键</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getKeyFromChildrenIndex</span>(<span class="params">child, menuEventKey, index</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> prefix = menuEventKey || <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">return</span> child.key || <span class="string">`<span class="subst">$&#123;prefix&#125;</span>item_<span class="subst">$&#123;index&#125;</span>`</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 store 中，selectedKeys, openKeys 以 key 键作为数组项；activeKey, defaultActiveFirst 以 key 键作为属性名。当用户行为发生时，key 键将被封装到对象中，通过逐级调用 props 方法，冒泡给 RcMenu 实例的 onOpenChange, onSelect, onDeselect 或者 SubPopupMenu 实例的 onItemHover 方法，最终改变 store 的状态。需要说明的是，菜单项的 onClick 也会逐级调用 props 方法，以数组形式拼接子菜单的 key 键，最终冒泡给 RcMenu 接受的 props.onClick 方法。而 RcMenu 接受的 props.onDestory 方法，则是逐级向下传递，最终在每个菜单项的 componentWillUnmount 生命周期中，均执行 onDestory 方法，参数即菜单项的 key 键。特别的，RcMenu 实现的 onKeyDown 实例方法将逐级往下调用 SubPopupMenu, RcSubMenu, RcMenuItem 中的 onKeyDown 方法。在这个过程中，SubPopupMenu 构建的 onKeyDown 实例方法也将在 DomWrap 组件被绑定为视图元素 onKeyDown 事件发生时的执行函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Menu</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 以引用形式调用，可依次改变选中的菜单项</span></span><br><span class="line">  <span class="comment">// 当遇到子菜单时，先展开子菜单，再选中子菜单项</span></span><br><span class="line">  onKeyDown = <span class="function">(<span class="params">e, callback</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// this.innerMenu.getWrappedInstance 用于获得 Menu 下直系子元素 —— SubPopupMenu 实例</span></span><br><span class="line">    <span class="keyword">this</span>.innerMenu.getWrappedInstance().onKeyDown(e, callback);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubPopupMenu</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  onKeyDown = <span class="function">(<span class="params">e, callback</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> keyCode = e.keyCode;</span><br><span class="line">    <span class="keyword">let</span> handled;</span><br><span class="line">    <span class="comment">// 依次选中菜单项或展开子菜单</span></span><br><span class="line">    <span class="keyword">this</span>.getFlatInstanceArray().forEach(<span class="function">(<span class="params">obj</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (obj &amp;&amp; obj.props.active &amp;&amp; obj.onKeyDown) &#123;</span><br><span class="line">        handled = obj.onKeyDown(e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">if</span> (handled) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> activeItem = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (keyCode === KeyCode.UP || keyCode === KeyCode.DOWN) &#123;</span><br><span class="line">      activeItem = <span class="keyword">this</span>.step(keyCode === KeyCode.UP ? <span class="number">-1</span> : <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (activeItem) &#123;</span><br><span class="line">      e.preventDefault();</span><br><span class="line">      updateActiveKey(<span class="keyword">this</span>.props.store, getEventKey(<span class="keyword">this</span>.props), activeItem.props.eventKey);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> callback === <span class="string">'function'</span>) &#123;</span><br><span class="line">        callback(activeItem);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubMenu</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  onKeyDown = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> keyCode = e.keyCode;</span><br><span class="line">    <span class="keyword">const</span> menu = <span class="keyword">this</span>.menuInstance;</span><br><span class="line">    <span class="keyword">const</span> &#123; isOpen, store &#125; = <span class="keyword">this</span>.props;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 展开子菜单，更新 defaultActiveFirst 状态</span></span><br><span class="line">    <span class="keyword">if</span> (keyCode === KeyCode.ENTER) &#123;</span><br><span class="line">      <span class="keyword">this</span>.onTitleClick(e);</span><br><span class="line">      updateDefaultActiveFirst(store, <span class="keyword">this</span>.props.eventKey, <span class="literal">true</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (keyCode === KeyCode.RIGHT) &#123;</span><br><span class="line">      <span class="comment">// 展开状态，选中子菜单项；menu 为 SubMenu 下直系子元素 —— SubPopupMenu 实例</span></span><br><span class="line">      <span class="keyword">if</span> (isOpen) &#123;</span><br><span class="line">        menu.onKeyDown(e);</span><br><span class="line">      <span class="comment">// 未展开状态，展开子菜单并更新 defaultActiveFirst 状态</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.triggerOpenChange(<span class="literal">true</span>);</span><br><span class="line">        updateDefaultActiveFirst(store, <span class="keyword">this</span>.props.eventKey, <span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (keyCode === KeyCode.LEFT) &#123;</span><br><span class="line">      <span class="keyword">let</span> handled;</span><br><span class="line">      <span class="keyword">if</span> (isOpen) &#123;</span><br><span class="line">        handled = menu.onKeyDown(e);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!handled) &#123;</span><br><span class="line">        <span class="keyword">this</span>.triggerOpenChange(<span class="literal">false</span>);</span><br><span class="line">        handled = <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> handled;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isOpen &amp;&amp; (keyCode === KeyCode.UP || keyCode === KeyCode.DOWN)) &#123;</span><br><span class="line">      <span class="keyword">return</span> menu.onKeyDown(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MenuItem</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  onKeyDown = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> keyCode = e.keyCode;</span><br><span class="line">    <span class="keyword">if</span> (keyCode === KeyCode.ENTER) &#123;</span><br><span class="line">      <span class="keyword">this</span>.onClick(e);<span class="comment">// 更新菜单的选中状态</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上介绍了 rc-menu 中的状态管理和事件处理逻辑，下面将扼要地介绍 rc-menu 中的各组件。</p>
<h3 id="SubPopupMenu"><a href="#SubPopupMenu" class="headerlink" title="SubPopupMenu"></a>SubPopupMenu</h3><p>SubPopupMenu 对激活状态的管理可参见上文，可参见上文及源码。这里只介绍 SubPopupMenu 的层级关系。</p>
<p>SubPopupMenu 可以作为 RcMenu 或 RcSubMenu 的直系子元素，其下可渲染 RcSubMenu 或 RcMenuItem 元素。在其实现中，既将 RcMenu 接受的 props 菜单栏整体配置项注入到子元素；又将 RcMenu 或 SubPopupMenu 提供的状态管理函数（均封装为 SubPopupMenu 的实例方法）注入 RcSubMenu 或 RcMenuItem。上述过程，见于 renderCommonMenuItem 方法，该方法由 renderMenuItem 直接调用。</p>
<p>renderMenuItem 方法的实现与 ref 引用处理一样，两者均让人心生纳闷：前者没有实现的必要；后者在 componentDidMount 生命周期管理实例引用，当菜单内容变化时仍会以缓存持有引用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubPopupMenu</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  renderCommonMenuItem = <span class="function">(<span class="params">child, i, extraProps</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> state = <span class="keyword">this</span>.props.store.getState();</span><br><span class="line">    <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">const</span> key = getKeyFromChildrenIndex(child, props.eventKey, i);<span class="comment">// 创建或获取 key 键</span></span><br><span class="line">    <span class="keyword">const</span> childProps = child.props;</span><br><span class="line">    <span class="keyword">const</span> isActive = key === state.activeKey;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 混入菜单栏整体配置或状态管理函数、事件绑定函数</span></span><br><span class="line">    <span class="keyword">const</span> newChildProps = &#123;</span><br><span class="line">      mode: childProps.mode || props.mode,</span><br><span class="line">      level: props.level,</span><br><span class="line">      inlineIndent: props.inlineIndent,</span><br><span class="line">      renderMenuItem: <span class="keyword">this</span>.renderMenuItem,</span><br><span class="line">      rootPrefixCls: props.prefixCls,</span><br><span class="line">      index: i,</span><br><span class="line">      parentMenu: props.parentMenu,</span><br><span class="line">      <span class="comment">// customized ref function, need to be invoked manually in child's componentDidMount</span></span><br><span class="line">      manualRef: childProps.disabled ? <span class="literal">undefined</span> :</span><br><span class="line">        createChainedFunction(child.ref, saveRef.bind(<span class="keyword">this</span>)),</span><br><span class="line">      eventKey: key,</span><br><span class="line">      active: !childProps.disabled &amp;&amp; isActive,</span><br><span class="line">      multiple: props.multiple,</span><br><span class="line">      onClick: <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">        (childProps.onClick || noop)(e);</span><br><span class="line">        <span class="keyword">this</span>.onClick(e);</span><br><span class="line">      &#125;,</span><br><span class="line">      onItemHover: <span class="keyword">this</span>.onItemHover,</span><br><span class="line">      openTransitionName: <span class="keyword">this</span>.getOpenTransitionName(),</span><br><span class="line">      openAnimation: props.openAnimation,</span><br><span class="line">      subMenuOpenDelay: props.subMenuOpenDelay,</span><br><span class="line">      subMenuCloseDelay: props.subMenuCloseDelay,</span><br><span class="line">      forceSubMenuRender: props.forceSubMenuRender,</span><br><span class="line">      onOpenChange: <span class="keyword">this</span>.onOpenChange,</span><br><span class="line">      onDeselect: <span class="keyword">this</span>.onDeselect,</span><br><span class="line">      onSelect: <span class="keyword">this</span>.onSelect,</span><br><span class="line">      builtinPlacements: props.builtinPlacements,</span><br><span class="line">      itemIcon: childProps.itemIcon || <span class="keyword">this</span>.props.itemIcon,</span><br><span class="line">      expandIcon: childProps.expandIcon || <span class="keyword">this</span>.props.expandIcon,</span><br><span class="line">      ...extraProps,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (props.mode === <span class="string">'inline'</span>) &#123;</span><br><span class="line">      newChildProps.triggerSubMenuAction = <span class="string">'click'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> React.cloneElement(child, newChildProps);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="comment">// props 处理及解构</span></span><br><span class="line">    <span class="comment">// renderMenuItem 将调用 renderCommonMenuItem 渲染子元素</span></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;DOMWrap &#123;...props&#125; prefixCls=&#123;prefixCls&#125; mode=&#123;mode&#125; tag=<span class="string">"ul"</span> level=&#123;level&#125; </span><br><span class="line">        theme=&#123;theme&#125; hiddenClassName=&#123;<span class="string">`<span class="subst">$&#123;prefixCls&#125;</span>-hidden`</span>&#125; visible=&#123;visible&#125;</span><br><span class="line">        overflowedIndicator=&#123;overflowedIndicator&#125; &#123;...domProps&#125;&gt;</span><br><span class="line">        &#123;</span><br><span class="line">          React.Children.map(props.children, (c, i) =&gt; </span><br><span class="line">            <span class="keyword">this</span>.renderMenuItem(c, i, eventKey || <span class="string">'0-menu-'</span>)</span><br><span class="line">          )</span><br><span class="line">        &#125;</span><br><span class="line">      &lt;<span class="regexp">/DOMWrap&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<h3 id="DomWrap"><a href="#DomWrap" class="headerlink" title="DomWrap"></a>DomWrap</h3><p>对于水平布局的菜单栏，DOMWrap 借助 <a href="https://github.com/que-etc/resize-observer-polyfill" target="_blank" rel="noopener">resize-observer-polyfill</a>，<a href="http://javascript.ruanyifeng.com/dom/mutationobserver.html" target="_blank" rel="noopener">MutationObserver</a> ，当 DOMWrap 实例或其子元素的 dom 内容或尺寸调整时，重新加以渲染。这样，在 DOMWrap 中就可以计算最后一个待显示的菜单项，并将这个菜单项和其余菜单项以 SubMenu 形式合并展示。其处理逻辑有：</p>
<ol>
<li>在 componentDidMount 生命周期为 DOMWrap 实例及其子元素绑定 dom 变更的监听函数。</li>
<li>当 dom 变更时，由监听函数调用 setChildrenWidthAndResize 实例方法。setChildrenWidthAndResize 先计算菜单项全显示时的总宽度，再将该宽度和菜单栏实际宽度对比，由此更新 state.lastVisibleIndex（最后一个待显示的菜单项的索引）。</li>
<li>在重绘阶段，DomWrap 将在每个已显示的菜单项后插入一个不予显示的 SubMenu 组件（其样式类带有 ‘overflowed-submenu’ 后缀，eventKey 为 ‘overflowed-indicator’ 后缀）；而待合并的菜单项将会用一个显示的 SubMenu 组件包裹，这样在点击时就可以显示浮层。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DOMWrap</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">this</span>.setChildrenWidthAndResize();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.props.level === <span class="number">1</span> &amp;&amp; <span class="keyword">this</span>.props.mode === <span class="string">'horizontal'</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> menuUl = ReactDOM.findDOMNode(<span class="keyword">this</span>);</span><br><span class="line">      <span class="keyword">if</span> (!menuUl) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.resizeObserver = <span class="keyword">new</span> ResizeObserver(<span class="function"><span class="params">entries</span> =&gt;</span> &#123;</span><br><span class="line">        entries.forEach(<span class="keyword">this</span>.setChildrenWidthAndResize);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 为 DOMWrap 及其子元素绑定监听函数</span></span><br><span class="line">      [].slice.call(menuUl.children).concat(menuUl).forEach(<span class="function"><span class="params">el</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.resizeObserver.observe(el);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 当子元素列表改变时，重新为子元素绑定监听函数，避免触发不必要的回调</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> MutationObserver !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">        <span class="keyword">this</span>.mutationObserver = <span class="keyword">new</span> MutationObserver(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">this</span>.resizeObserver.disconnect();</span><br><span class="line">          [].slice.call(menuUl.children).concat(menuUl).forEach(<span class="function"><span class="params">el</span> =&gt;</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.resizeObserver.observe(el);</span><br><span class="line">          &#125;);</span><br><span class="line">          <span class="keyword">this</span>.setChildrenWidthAndResize();</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">this</span>.mutationObserver.observe(</span><br><span class="line">          menuUl,</span><br><span class="line">          &#123; <span class="attr">attributes</span>: <span class="literal">false</span>, <span class="attr">childList</span>: <span class="literal">true</span>, <span class="attr">subTree</span>: <span class="literal">false</span> &#125;</span><br><span class="line">        );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getOverflowedSubMenuItem = <span class="function">(<span class="params">keyPrefix, overflowedItems, renderPlaceholder</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// this.props.overflowedIndicator 通常是 '...'</span></span><br><span class="line">    <span class="keyword">const</span> &#123; overflowedIndicator, level, mode, prefixCls, theme, <span class="attr">style</span>: propStyle &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">if</span> (level !== <span class="number">1</span> || mode !== <span class="string">'horizontal'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> copy = <span class="keyword">this</span>.props.children[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">const</span> &#123; <span class="attr">children</span>: throwAway, title, eventKey, ...rest &#125; = copy.props;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> style = &#123; ...propStyle &#125;;</span><br><span class="line">    <span class="keyword">let</span> key = <span class="string">`<span class="subst">$&#123;keyPrefix&#125;</span>-overflowed-indicator`</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (overflowedItems.length === <span class="number">0</span> &amp;&amp; renderPlaceholder !== <span class="literal">true</span>) &#123;</span><br><span class="line">      style = &#123;</span><br><span class="line">        ...style,</span><br><span class="line">        display: <span class="string">'none'</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (renderPlaceholder) &#123;</span><br><span class="line">      style = &#123;</span><br><span class="line">        ...style,</span><br><span class="line">        visibility: <span class="string">'hidden'</span>,</span><br><span class="line">        position: <span class="string">'absolute'</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">      key = <span class="string">`<span class="subst">$&#123;key&#125;</span>-placeholder`</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> popupClassName = theme ? <span class="string">`<span class="subst">$&#123;prefixCls&#125;</span>-<span class="subst">$&#123;theme&#125;</span>`</span> : <span class="string">''</span>;</span><br><span class="line">    <span class="keyword">const</span> props = &#123;&#125;;</span><br><span class="line">    menuAllProps.forEach(<span class="function"><span class="params">k</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (rest[k] !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">        props[k] = rest[k];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;SubMenu title=&#123;overflowedIndicator&#125; className=&#123;<span class="string">`<span class="subst">$&#123;prefixCls&#125;</span>-overflowed-submenu`</span>&#125;</span><br><span class="line">        popupClassName=&#123;popupClassName&#125; &#123;...props&#125; key=&#123;key&#125;</span><br><span class="line">        eventKey=&#123;<span class="string">`<span class="subst">$&#123;keyPrefix&#125;</span>-overflowed-indicator`</span>&#125; disabled=&#123;<span class="literal">false</span>&#125; style=&#123;style&#125;&gt;</span><br><span class="line">        &#123;overflowedItems&#125;</span><br><span class="line">      &lt;<span class="regexp">/SubMenu&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  renderChildren(children) &#123;</span></span><br><span class="line"><span class="regexp">    const &#123; lastVisibleIndex &#125; = this.state;</span></span><br><span class="line"><span class="regexp">    return (children || []).reduce((acc, childNode, index) =&gt; &#123;</span></span><br><span class="line"><span class="regexp">      let item = childNode;</span></span><br><span class="line"><span class="regexp">      if (this.props.mode === 'horizontal') &#123;</span></span><br><span class="line"><span class="regexp">        let overflowed = this.getOverflowedSubMenuItem(childNode.props.eventKey, []);</span></span><br><span class="line"><span class="regexp">        if (lastVisibleIndex !== undefined &amp;&amp;</span></span><br><span class="line"><span class="regexp">          this.props.className.indexOf(`$&#123;this.props.prefixCls&#125;-root`) !== -1</span></span><br><span class="line"><span class="regexp">        ) &#123;</span></span><br><span class="line"><span class="regexp">          if (index &gt; lastVisibleIndex) &#123;</span></span><br><span class="line"><span class="regexp">            /</span><span class="regexp">/ 修改 eventKey 是为了防止隐藏状态下还会触发 openkeys 事件</span></span><br><span class="line"><span class="regexp">            item = React.cloneElement(childNode, &#123;</span></span><br><span class="line"><span class="regexp">              style: &#123; display: 'none' &#125;,</span></span><br><span class="line"><span class="regexp">              eventKey: `$&#123;childNode.props.eventKey&#125;-hidden`,</span></span><br><span class="line"><span class="regexp">              className: `$&#123;childNode.className&#125; $&#123;MENUITEM_OVERFLOWED_CLASSNAME&#125;`</span></span><br><span class="line"><span class="regexp">            &#125;);</span></span><br><span class="line"><span class="regexp">          &#125;</span></span><br><span class="line"><span class="regexp">          if (index === lastVisibleIndex + 1) &#123;</span></span><br><span class="line"><span class="regexp">            this.overflowedItems = children.slice(lastVisibleIndex + 1).map(c =&gt; &#123;</span></span><br><span class="line"><span class="regexp">              return React.cloneElement(c, &#123; </span></span><br><span class="line"><span class="regexp">                key: c.props.eventKey, </span></span><br><span class="line"><span class="regexp">                mode: 'vertical-left' </span></span><br><span class="line"><span class="regexp">              &#125;);</span></span><br><span class="line"><span class="regexp">            &#125;);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">            overflowed = this.getOverflowedSubMenuItem(</span></span><br><span class="line"><span class="regexp">              childNode.props.eventKey,</span></span><br><span class="line"><span class="regexp">              this.overflowedItems,</span></span><br><span class="line"><span class="regexp">            );</span></span><br><span class="line"><span class="regexp">          &#125;</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">        const ret = [...acc, overflowed, item];</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">        if (index === children.length - 1) &#123;</span></span><br><span class="line"><span class="regexp">          /</span><span class="regexp">/ 设置占位符，以计算 overflowed indicator 的宽度</span></span><br><span class="line"><span class="regexp">          ret.push(this.getOverflowedSubMenuItem(childNode.props.eventKey, [], true));</span></span><br><span class="line"><span class="regexp">        &#125;</span></span><br><span class="line"><span class="regexp">        return ret;</span></span><br><span class="line"><span class="regexp">      &#125;</span></span><br><span class="line"><span class="regexp">      return [...acc, item];</span></span><br><span class="line"><span class="regexp">    &#125;, []);</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  render() &#123;</span></span><br><span class="line"><span class="regexp">    /</span><span class="regexp">/ Tag 即 this.props.tag，默认为 ul</span></span><br><span class="line"><span class="regexp">    return (</span></span><br><span class="line"><span class="regexp">      &lt;Tag &#123;...rest&#125;&gt;</span></span><br><span class="line"><span class="regexp">        &#123;this.renderChildren(this.props.children)&#125;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>Tag&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="SubMenu"><a href="#SubMenu" class="headerlink" title="SubMenu"></a>SubMenu</h3><p>除了上文提到的，SubMenu 的处理逻辑还包含：</p>
<ol>
<li>通过 store 获取 props.isOpen 子菜单是否展开, props.active 子菜单是否激活, props.selectedKeys 辅助计算子菜单或子菜单项是否被选中。三者均影响样式。</li>
<li>组件层级上，SubMenu 根据菜单栏是否采用 inline 模式，以决定使用 Trigger 组件（rc-trigger 提供）包裹子元素，或者单纯绘制子元素；继而使用 Animate 组件（rc-animate 提供）绘制子元素，子元素均统一由 SubPopupMenu 组件渲染。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Menu</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 获取传入子组件的 props.openTransitionName 属性</span></span><br><span class="line">  getOpenTransitionName = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">let</span> transitionName = props.openTransitionName;</span><br><span class="line">    <span class="keyword">const</span> animationName = props.openAnimation;</span><br><span class="line">    <span class="keyword">if</span> (!transitionName &amp;&amp; <span class="keyword">typeof</span> animationName === <span class="string">'string'</span>) &#123;</span><br><span class="line">      transitionName = <span class="string">`<span class="subst">$&#123;props.prefixCls&#125;</span>-open-<span class="subst">$&#123;animationName&#125;</span>`</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> transitionName;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SubMenu</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  renderChildren(children) &#123;</span><br><span class="line">    <span class="comment">// 构建 baseProps，按条件只绘制空内容...</span></span><br><span class="line">    <span class="keyword">const</span> animProps = &#123;&#125;;</span><br><span class="line">    <span class="keyword">const</span> transitionAppear = haveRendered || !baseProps.visible || !baseProps.mode === <span class="string">'inline'</span>;</span><br><span class="line">    <span class="keyword">if</span> (baseProps.openTransitionName) &#123;</span><br><span class="line">      animProps.transitionName = baseProps.openTransitionName;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">typeof</span> baseProps.openAnimation === <span class="string">'object'</span>) &#123;</span><br><span class="line">      animProps.animation = &#123; ...baseProps.openAnimation &#125;;</span><br><span class="line">      <span class="keyword">if</span> (!transitionAppear) &#123;</span><br><span class="line">        <span class="keyword">delete</span> animProps.animation.appear;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;Animate &#123;...animProps&#125; showProp=<span class="string">"visible"</span> component=<span class="string">""</span> transitionAppear=&#123;transitionAppear&#125;&gt;</span><br><span class="line">        &lt;SubPopupMenu &#123;...baseProps&#125; id=&#123;<span class="keyword">this</span>._menuId&#125;&gt;&#123;children&#125;&lt;<span class="regexp">/SubPopupMenu&gt;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>Animate&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="comment">// props 处理及结构...</span></span><br><span class="line">    <span class="keyword">const</span> isOpen = props.isOpen;</span><br><span class="line">    <span class="keyword">const</span> isInlineMode = props.mode === <span class="string">'inline'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 展开按钮</span></span><br><span class="line">    <span class="keyword">let</span> icon = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (props.mode !== <span class="string">'horizontal'</span>) &#123;</span><br><span class="line">      icon = <span class="keyword">this</span>.props.expandIcon; <span class="comment">// ReactNode</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="keyword">this</span>.props.expandIcon === <span class="string">'function'</span>)</span><br><span class="line">        icon = React.createElement(<span class="keyword">this</span>.props.expandIcon, &#123; ...this.props &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> title = (</span><br><span class="line">      &lt;div ref=&#123;<span class="keyword">this</span>.saveSubMenuTitle&#125; style=&#123;style&#125; className=&#123;<span class="string">`<span class="subst">$&#123;prefixCls&#125;</span>-title`</span>&#125;</span><br><span class="line">        &#123;...titleMouseEvents&#125; &#123;...titleClickEvents&#125; aria-expanded=&#123;isOpen&#125;</span><br><span class="line">        &#123;...ariaOwns&#125; aria-haspopup=<span class="string">"true"</span></span><br><span class="line">        title=&#123;<span class="keyword">typeof</span> props.title === <span class="string">'string'</span> ? props.title : <span class="literal">undefined</span>&#125;&gt;</span><br><span class="line">        &#123;props.title&#125;</span><br><span class="line">        &#123;icon || &lt;i className=&#123;`$&#123;prefixCls&#125;-arrow`&#125; /&gt;&#125;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">const</span> children = <span class="keyword">this</span>.renderChildren(props.children);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;li &#123;...props&#125; &#123;...mouseEvents&#125; className=&#123;className&#125; role=<span class="string">"menuitem"</span>&gt;</span><br><span class="line">        &#123;isInlineMode &amp;&amp; title&#125;</span><br><span class="line">        &#123;isInlineMode &amp;&amp; children&#125;</span><br><span class="line">        &#123;!isInlineMode &amp;&amp; (</span><br><span class="line">          &lt;Trigger prefixCls=&#123;prefixCls&#125;</span><br><span class="line">            popupClassName=&#123;<span class="string">`<span class="subst">$&#123;prefixCls&#125;</span>-popup <span class="subst">$&#123;popupClassName&#125;</span>`</span>&#125;</span><br><span class="line">            getPopupContainer=&#123;getPopupContainer&#125;</span><br><span class="line">            builtinPlacements=&#123;<span class="built_in">Object</span>.assign(&#123;&#125;, placements, builtinPlacements)&#125;</span><br><span class="line">            popupPlacement=&#123;popupPlacement&#125; popupVisible=&#123;isOpen&#125;</span><br><span class="line">            popupAlign=&#123;popupAlign&#125; popup=&#123;children&#125;</span><br><span class="line">            action=&#123;disabled ? [] : [triggerSubMenuAction]&#125;</span><br><span class="line">            mouseEnterDelay=&#123;subMenuOpenDelay&#125;</span><br><span class="line">            mouseLeaveDelay=&#123;subMenuCloseDelay&#125;</span><br><span class="line">            onPopupVisibleChange=&#123;<span class="keyword">this</span>.onPopupVisibleChange&#125;</span><br><span class="line">            forceRender=&#123;forceSubMenuRender&#125;&gt;</span><br><span class="line">            &#123;title&#125;</span><br><span class="line">          &lt;<span class="regexp">/Trigger&gt;</span></span><br><span class="line"><span class="regexp">        )&#125;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>li&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>Menu 用于绘制主菜单，参见上文或源码。</p>
<p>MenuItem 用于绘制菜单项，将根据 store 中的 activeKey, selectedKeys 渲染样式。除了常规的事件处理函数之外，当菜单项被激活时，MenuItem 将借助 <a href="http://yiminghe.me/dom-scroll-into-view/" target="_blank" rel="noopener">dom-scroll-into-view</a> 使屏幕滚动到指定区域。MenuItem 与 SubMenu 一样，也将使用 props.level 菜单项的层级计算左边距。</p>
<p>MenuItemGroup 用于绘制成组的菜单项，并且带有标题。在 MenuItemGroup 中，实际绘制菜单项所需的 props.renderMenuItem 方法由 SubPopupMenu 提供。</p>
<p>Divider 用于绘制分割线。</p>
<h2 id="Menu"><a href="#Menu" class="headerlink" title="Menu"></a>Menu</h2><h3 id="Menu-1"><a href="#Menu-1" class="headerlink" title="Menu"></a>Menu</h3><p>Menu 作为菜单的容器，其上桥接 Sider 布局组件传入的 context.siderCollapsed, context.collapsedWidth；其下为子菜单或菜单项注入 context.inlineCollapsed, context.antdMenuTheme。其中，context.siderCollapsed 表示侧边栏是否折叠；context.collapsedWidth 表示侧边栏宽度；context.inlineCollapsed 表示内嵌模式的菜单是否折叠，或者侧边栏是否折叠；context.antdMenuTheme 表示菜单所采用的样式风格。</p>
<p>组件层级上，Menu 使用 RcMenu 绘制内容。当传入 props.openKeys 时，Menu 将表现为受控组件，其内置的 state.openKeys 将根据 props.openKeys 作调整，使用者也可以通过 props.onOpenChange 实时获取到实时展开的菜单项；当没有传入 props.openKeys 时，Menu 将表现为非受控组件，state.openKeys 将根据用户行为更新。</p>
<p>在非内嵌模式下，Menu 为 RcMenu 绑定 onClick = this.handleClick 实例方法，以在当用户点击菜单栏的空白区域或子菜单项时，可隐藏弹出的浮层。</p>
<p>在动效处理上，当菜单栏由 inline 模式切换到其他模式或者在 inline 模式下收起菜单（实际菜单需要垂直布局显示）时，先需显示 inline 模式下子菜单的折叠动效，在动效执行完成后，再转换成其他模式（介于 rc-menu 没有针对动效时延的处理）。Menu 使用 switchingModeFromInline 实例属性记录模式转换及折叠状态切换。在此基础上，getRealMenuMode 用于计算菜单实际采用的显示模式，再由 getMenuOpenAnimation 获得待显示的功效。当动效执行完成时，handleTransitionEnd 实例方法将重置 switchingModeFromInline 缓存。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> cssAnimation <span class="keyword">from</span> <span class="string">'css-animation'</span>;</span><br><span class="line"><span class="keyword">import</span> raf <span class="keyword">from</span> <span class="string">'raf'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">animate</span>(<span class="params">node: HTMLElement, show: boolean, done: (</span>) =&gt; <span class="title">void</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> height: number;</span><br><span class="line">  <span class="keyword">let</span> requestAnimationFrameId: number;</span><br><span class="line">  <span class="keyword">return</span> cssAnimation(node, <span class="string">'ant-motion-collapse'</span>, &#123;</span><br><span class="line">    start() &#123;</span><br><span class="line">      <span class="keyword">if</span> (!show) &#123;</span><br><span class="line">        node.style.height = <span class="string">`<span class="subst">$&#123;node.offsetHeight&#125;</span>px`</span>;</span><br><span class="line">        node.style.opacity = <span class="string">'1'</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        height = node.offsetHeight;</span><br><span class="line">        node.style.height = <span class="string">'0px'</span>;</span><br><span class="line">        node.style.opacity = <span class="string">'0'</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    active() &#123;</span><br><span class="line">      <span class="keyword">if</span> (requestAnimationFrameId) &#123;</span><br><span class="line">        raf.cancel(requestAnimationFrameId);</span><br><span class="line">      &#125;</span><br><span class="line">      requestAnimationFrameId = raf(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        node.style.height = <span class="string">`<span class="subst">$&#123;show ? height : <span class="number">0</span>&#125;</span>px`</span>;</span><br><span class="line">        node.style.opacity = show ? <span class="string">'1'</span> : <span class="string">'0'</span>;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    end() &#123;</span><br><span class="line">      <span class="keyword">if</span> (requestAnimationFrameId) &#123;</span><br><span class="line">        raf.cancel(requestAnimationFrameId);</span><br><span class="line">      &#125;</span><br><span class="line">      node.style.height = <span class="string">''</span>;</span><br><span class="line">      node.style.opacity = <span class="string">''</span>;</span><br><span class="line">      done();</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> animation = &#123;</span><br><span class="line">  enter(node: HTMLElement, <span class="attr">done</span>: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">void</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> animate(node, <span class="literal">true</span>, done);</span><br><span class="line">  &#125;,</span><br><span class="line">  leave(node: HTMLElement, <span class="attr">done</span>: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">void</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> animate(node, <span class="literal">false</span>, done);</span><br><span class="line">  &#125;,</span><br><span class="line">  appear(node: HTMLElement, <span class="attr">done</span>: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">void</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> animate(node, <span class="literal">true</span>, done);</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Menu</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span>&lt;<span class="title">MenuProps</span>, <span class="title">MenuState</span>&gt; </span>&#123;</span><br><span class="line">  componentWillReceiveProps(nextProps: MenuProps, <span class="attr">nextContext</span>: SiderContext) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.props.mode === <span class="string">'inline'</span> &amp;&amp;</span><br><span class="line">        nextProps.mode !== <span class="string">'inline'</span>) &#123;</span><br><span class="line">      <span class="keyword">this</span>.switchingModeFromInline = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">'openKeys'</span> <span class="keyword">in</span> nextProps) &#123;</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123; <span class="attr">openKeys</span>: nextProps.openKeys! &#125;);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((nextProps.inlineCollapsed &amp;&amp; !<span class="keyword">this</span>.props.inlineCollapsed) ||</span><br><span class="line">        (nextContext.siderCollapsed &amp;&amp; !<span class="keyword">this</span>.context.siderCollapsed)) &#123;</span><br><span class="line">      <span class="keyword">this</span>.switchingModeFromInline = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">this</span>.inlineOpenKeys = <span class="keyword">this</span>.state.openKeys;<span class="comment">// 缓存 inline 模式展开的菜单项</span></span><br><span class="line">      <span class="keyword">this</span>.setState(&#123; <span class="attr">openKeys</span>: [] &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ((!nextProps.inlineCollapsed &amp;&amp; <span class="keyword">this</span>.props.inlineCollapsed) ||</span><br><span class="line">        (!nextContext.siderCollapsed &amp;&amp; <span class="keyword">this</span>.context.siderCollapsed)) &#123;</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123; <span class="attr">openKeys</span>: <span class="keyword">this</span>.inlineOpenKeys &#125;);</span><br><span class="line">      <span class="keyword">this</span>.inlineOpenKeys = [];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Restore vertical mode when menu is collapsed responsively when mounted</span></span><br><span class="line">  <span class="comment">// https://github.com/ant-design/ant-design/issues/13104</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> not a perfect solution, looking a new way to avoid setting switchingModeFromInline in this situation</span></span><br><span class="line">  <span class="comment">// 折叠状态刷新页面，因为未执行动效，switchingModeFromInline 仍为真，显示为 inline 模式</span></span><br><span class="line">  handleMouseEnter = <span class="function">(<span class="params">e: MouseEvent</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.restoreModeVerticalFromInline();</span><br><span class="line">    <span class="keyword">const</span> &#123; onMouseEnter &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">if</span> (onMouseEnter) &#123;</span><br><span class="line">      onMouseEnter(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleTransitionEnd = <span class="function">(<span class="params">e: TransitionEvent</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// when inlineCollapsed menu width animation finished</span></span><br><span class="line">    <span class="comment">// https://github.com/ant-design/ant-design/issues/12864</span></span><br><span class="line">    <span class="keyword">const</span> widthCollapsed = e.propertyName === <span class="string">'width'</span> &amp;&amp; e.target === e.currentTarget;</span><br><span class="line">    <span class="comment">// Fix for &lt;Menu style=&#123;&#123; width: '100%' &#125;&#125; /&gt;, the width transition won't trigger when menu is collapsed</span></span><br><span class="line">    <span class="comment">// https://github.com/ant-design/ant-design-pro/issues/2783</span></span><br><span class="line">    <span class="keyword">const</span> iconScaled = e.propertyName === <span class="string">'font-size'</span> &amp;&amp; (e.target <span class="keyword">as</span> HTMLElement).className.indexOf(<span class="string">'anticon'</span>) &gt;= <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (widthCollapsed || iconScaled) &#123;</span><br><span class="line">      <span class="keyword">this</span>.restoreModeVerticalFromInline();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 重置 switchingModeFromInline，并重绘菜单</span></span><br><span class="line">  restoreModeVerticalFromInline() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.switchingModeFromInline) &#123;</span><br><span class="line">      <span class="keyword">this</span>.switchingModeFromInline = <span class="literal">false</span>;</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123;&#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 是否折叠，取决于侧边栏的折叠情况、内嵌模式的折叠情况</span></span><br><span class="line">  getInlineCollapsed() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; inlineCollapsed &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.context.siderCollapsed !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.context.siderCollapsed;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> inlineCollapsed;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 由 inline 模式转换成其他模式时，首先保持 inline 模式，目的是执行子菜单折叠动效</span></span><br><span class="line">  <span class="comment">// 在 inline 模式下，收起菜单也将先保持 inline 模式</span></span><br><span class="line">  getRealMenuMode() &#123;</span><br><span class="line">    <span class="keyword">const</span> inlineCollapsed = <span class="keyword">this</span>.getInlineCollapsed();</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.switchingModeFromInline &amp;&amp; inlineCollapsed) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">'inline'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> &#123; mode &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">return</span> inlineCollapsed ? <span class="string">'vertical'</span> : mode;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  getMenuOpenAnimation(menuMode: MenuMode) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; openAnimation, openTransitionName &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">let</span> menuOpenAnimation = openAnimation || openTransitionName;</span><br><span class="line">    <span class="keyword">if</span> (openAnimation === <span class="literal">undefined</span> &amp;&amp; openTransitionName === <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (menuMode) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'horizontal'</span>:</span><br><span class="line">          menuOpenAnimation = <span class="string">'slide-up'</span>;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'vertical'</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'vertical-left'</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'vertical-right'</span>:</span><br><span class="line">          <span class="comment">// When mode switch from inline submenu should hide without animation</span></span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">this</span>.switchingModeFromInline) &#123;</span><br><span class="line">            menuOpenAnimation = <span class="string">''</span>;</span><br><span class="line">            <span class="keyword">this</span>.switchingModeFromInline = <span class="literal">false</span>;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            menuOpenAnimation = <span class="string">'zoom-big'</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'inline'</span>:</span><br><span class="line">          menuOpenAnimation = animation;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> menuOpenAnimation;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="SubMenu-1"><a href="#SubMenu-1" class="headerlink" title="SubMenu"></a>SubMenu</h3><p>SubMenu 使用 RcSubMenu 绘制子菜单。逻辑上，SubMenu 通过 context.antdMenuTheme 设置子菜单的主题样式；又实现 onKeyDown 方法，以桥接 SubPopupMenu 和 RcSubMenu 中的同名方法（参见上文）。</p>
<h3 id="MenuItem"><a href="#MenuItem" class="headerlink" title="MenuItem"></a>MenuItem</h3><p>MenuItem 使用 RcMenuItem 绘制菜单项。逻辑上，MenuItem 既像 SubMenu 那样实现了 onKeyDown 方法；又使用 Tooltip 绘制气泡框。当 context.inlineCollapsed 为 true 且 props.level 为 1（菜单项层级为1）时，将使用<a href="https://ant.design/components/tooltip-cn/" target="_blank" rel="noopener">气泡框组件</a>绘制子元素。</p>
<h3 id="样式处理"><a href="#样式处理" class="headerlink" title="样式处理"></a>样式处理</h3><ol>
<li>菜单折叠前后展示样式：</li>
</ol>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.@&#123;menu-prefix-cls&#125;</span> &#123;</span><br><span class="line">  <span class="selector-tag">&amp;</span><span class="selector-tag">-item</span>,</span><br><span class="line">  <span class="selector-tag">&amp;</span><span class="selector-tag">-submenu-title</span> &#123;</span><br><span class="line">    <span class="attribute">cursor</span>: pointer;</span><br><span class="line">    <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">padding</span>: <span class="number">0</span> <span class="number">20px</span>;</span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">    <span class="attribute">white-space</span>: nowrap;</span><br><span class="line">    <span class="attribute">transition</span>: color .<span class="number">3s</span> <span class="variable">@ease-in-out</span>, border-color .<span class="number">3s</span> <span class="variable">@ease-in-out</span>, background .<span class="number">3s</span> <span class="variable">@ease-in-out</span>, padding .<span class="number">15s</span> <span class="variable">@ease-in-out</span>;</span><br><span class="line">    <span class="selector-class">.@&#123;iconfont-css-prefix&#125;</span> &#123;</span><br><span class="line">      <span class="attribute">min-width</span>: <span class="number">14px</span>;</span><br><span class="line">      <span class="attribute">margin-right</span>: <span class="number">10px</span>;</span><br><span class="line">      <span class="attribute">font-size</span>: <span class="variable">@font-size-base</span>;</span><br><span class="line">      <span class="attribute">transition</span>: font-size .<span class="number">15s</span> <span class="variable">@ease-out</span>, margin .<span class="number">3s</span> <span class="variable">@ease-in-out</span>;</span><br><span class="line">      + <span class="selector-tag">span</span> &#123;</span><br><span class="line">        <span class="attribute">transition</span>: opacity .<span class="number">3s</span> <span class="variable">@ease-in-out</span>, width .<span class="number">3s</span> <span class="variable">@ease-in-out</span>;</span><br><span class="line">        <span class="attribute">opacity</span>: <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="selector-tag">&amp;</span><span class="selector-tag">-inline-collapsed</span> &#123;</span><br><span class="line">    <span class="attribute">width</span>: <span class="variable">@menu-collapsed-width</span>;</span><br><span class="line">    &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-item</span>,</span><br><span class="line">    &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-item-group</span> &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-item-group-list</span> &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-item</span>,</span><br><span class="line">    &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-item-group</span> &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-item-group-list</span> &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu</span> &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu-title</span>,</span><br><span class="line">    &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu</span> &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu-title</span> &#123;</span><br><span class="line">      <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">      <span class="attribute">text-overflow</span>: clip;<span class="comment">// 裁剪超出文本</span></span><br><span class="line">      <span class="attribute">padding</span>: <span class="number">0</span> (<span class="variable">@menu-collapsed-width</span> - <span class="number">16px</span>) / <span class="number">2</span> <span class="meta">!important</span>;</span><br><span class="line">      <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu-arrow</span> &#123;<span class="comment">// 隐藏展开折叠图标</span></span><br><span class="line">        <span class="attribute">display</span>: none;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="selector-class">.@&#123;iconfont-css-prefix&#125;</span> &#123;</span><br><span class="line">        <span class="attribute">font-size</span>: <span class="number">16px</span>;</span><br><span class="line">        <span class="attribute">line-height</span>: <span class="variable">@menu-item-height</span>;</span><br><span class="line">        <span class="attribute">margin</span>: <span class="number">0</span>;</span><br><span class="line">        + <span class="selector-tag">span</span> &#123;<span class="comment">// 隐藏文本</span></span><br><span class="line">          <span class="attribute">max-width</span>: <span class="number">0</span>;</span><br><span class="line">          <span class="attribute">display</span>: inline-block;</span><br><span class="line">          <span class="attribute">opacity</span>: <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>子菜单浮层：</li>
</ol>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.@&#123;menu-prefix-cls&#125;</span> &#123;</span><br><span class="line">  <span class="selector-tag">&amp;</span><span class="selector-tag">-submenu</span> &#123;</span><br><span class="line">    <span class="selector-tag">&amp;</span><span class="selector-tag">-popup</span> &#123;</span><br><span class="line">      <span class="attribute">position</span>: absolute;</span><br><span class="line">      <span class="attribute">border-radius</span>: <span class="variable">@border-radius-base</span>;</span><br><span class="line">      <span class="attribute">z-index</span>: <span class="variable">@zindex-dropdown</span>;</span><br><span class="line">      <span class="attribute">background</span>: <span class="variable">@menu-popup-bg</span>;</span><br><span class="line"></span><br><span class="line">      <span class="selector-class">.submenu-title-wrapper</span> &#123;</span><br><span class="line">        <span class="attribute">padding-right</span>: <span class="number">20px</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="selector-tag">&amp;</span><span class="selector-pseudo">:before</span> &#123;</span><br><span class="line">        <span class="attribute">position</span>: absolute;</span><br><span class="line">        <span class="attribute">top</span>: -<span class="number">7px</span>;</span><br><span class="line">        <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">        <span class="attribute">right</span>: <span class="number">0</span>;</span><br><span class="line">        <span class="attribute">bottom</span>: <span class="number">0</span>;</span><br><span class="line">        <span class="attribute">content</span>: <span class="string">' '</span>;</span><br><span class="line">        <span class="attribute">opacity</span>: .<span class="number">0001</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>折叠按钮旋转动效：</li>
</ol>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.@&#123;menu-prefix-cls&#125;</span> &#123;</span><br><span class="line">  <span class="selector-tag">&amp;</span><span class="selector-tag">-submenu</span> &#123;<span class="selector-tag">&amp;</span><span class="selector-tag">-vertical</span>,</span><br><span class="line">    <span class="selector-tag">&amp;</span><span class="selector-tag">-vertical-left</span>,</span><br><span class="line">    <span class="selector-tag">&amp;</span><span class="selector-tag">-vertical-right</span>,</span><br><span class="line">    <span class="selector-tag">&amp;</span><span class="selector-tag">-inline</span> &#123;</span><br><span class="line">      &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu-title</span> <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu-arrow</span> &#123;</span><br><span class="line">        <span class="attribute">transition</span>: transform .<span class="number">3s</span> <span class="variable">@ease-in-out</span>;</span><br><span class="line">        <span class="attribute">position</span>: absolute;</span><br><span class="line">        <span class="attribute">top</span>: <span class="number">50%</span>;</span><br><span class="line">        <span class="attribute">right</span>: <span class="number">16px</span>;</span><br><span class="line">        <span class="attribute">width</span>: <span class="number">10px</span>;</span><br><span class="line">        <span class="selector-tag">&amp;</span><span class="selector-pseudo">:before</span>,</span><br><span class="line">        <span class="selector-tag">&amp;</span><span class="selector-pseudo">:after</span> &#123;</span><br><span class="line">          <span class="attribute">content</span>: <span class="string">""</span>;</span><br><span class="line">          <span class="attribute">position</span>: absolute;</span><br><span class="line">          <span class="attribute">vertical-align</span>: baseline;</span><br><span class="line">          <span class="attribute">background</span>: <span class="number">#fff</span>;</span><br><span class="line">          <span class="attribute">background-image</span>: linear-gradient(to right, <span class="variable">@menu-item-color</span>, <span class="variable">@menu-item-color</span>);<span class="comment">// 渐变</span></span><br><span class="line">          <span class="attribute">width</span>: <span class="number">6px</span>;</span><br><span class="line">          <span class="attribute">height</span>: <span class="number">1.5px</span>;</span><br><span class="line">          <span class="attribute">border-radius</span>: <span class="number">2px</span>;</span><br><span class="line">          <span class="attribute">transition</span>: background .<span class="number">3s</span> <span class="variable">@ease-in-out</span>, transform .<span class="number">3s</span> <span class="variable">@ease-in-out</span>, top .<span class="number">3s</span> <span class="variable">@ease-in-out</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="selector-tag">&amp;</span><span class="selector-pseudo">:before</span> &#123;</span><br><span class="line">          <span class="attribute">transform</span>: rotate(<span class="number">45deg</span>) translateY(-<span class="number">2px</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="selector-tag">&amp;</span><span class="selector-pseudo">:after</span> &#123;</span><br><span class="line">          <span class="attribute">transform</span>: rotate(-<span class="number">45deg</span>) translateY(<span class="number">2px</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu-title</span><span class="selector-pseudo">:hover</span> <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu-arrow</span> &#123;</span><br><span class="line">        <span class="selector-tag">&amp;</span><span class="selector-pseudo">:after</span>,</span><br><span class="line">        <span class="selector-tag">&amp;</span><span class="selector-pseudo">:before</span> &#123;</span><br><span class="line">          <span class="attribute">background</span>: linear-gradient(to right, <span class="variable">@menu-highlight-color</span>, <span class="variable">@menu-highlight-color</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="selector-tag">&amp;</span><span class="selector-tag">-inline</span> &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu-title</span> <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu-arrow</span> &#123;</span><br><span class="line">      <span class="selector-tag">&amp;</span><span class="selector-pseudo">:before</span> &#123;</span><br><span class="line">        <span class="attribute">transform</span>: rotate(-<span class="number">45deg</span>) translateX(<span class="number">2px</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="selector-tag">&amp;</span><span class="selector-pseudo">:after</span> &#123;</span><br><span class="line">        <span class="attribute">transform</span>: rotate(<span class="number">45deg</span>) translateX(-<span class="number">2px</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="selector-tag">&amp;</span><span class="selector-tag">-open</span> &#123;</span><br><span class="line">      <span class="selector-tag">&amp;</span><span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu-inline</span> &gt; <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu-title</span> <span class="selector-class">.@&#123;menu-prefix-cls&#125;</span><span class="selector-tag">-submenu-arrow</span> &#123;</span><br><span class="line">        <span class="attribute">transform</span>: translateY(-<span class="number">2px</span>);</span><br><span class="line">        <span class="selector-tag">&amp;</span><span class="selector-pseudo">:after</span> &#123;</span><br><span class="line">          <span class="attribute">transform</span>: rotate(-<span class="number">45deg</span>) translateX(-<span class="number">2px</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="selector-tag">&amp;</span><span class="selector-pseudo">:before</span> &#123;</span><br><span class="line">          <span class="attribute">transform</span>: rotate(<span class="number">45deg</span>) translateX(<span class="number">2px</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ol start="4">
<li>清除浮动：</li>
</ol>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.clearfix</span>() &#123;</span><br><span class="line">  <span class="attribute">zoom</span>: <span class="number">1</span>;</span><br><span class="line">  <span class="selector-tag">&amp;</span><span class="selector-pseudo">:before</span>,</span><br><span class="line">  <span class="selector-tag">&amp;</span><span class="selector-pseudo">:after</span> &#123;</span><br><span class="line">    <span class="attribute">content</span>: <span class="string">""</span>;</span><br><span class="line">    <span class="attribute">display</span>: table;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-tag">&amp;</span><span class="selector-pseudo">:after</span> &#123;</span><br><span class="line">    <span class="attribute">clear</span>: both;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.@&#123;menu-prefix-cls&#125;</span> &#123;</span><br><span class="line">  <span class="selector-class">.clearfix</span>;</span><br><span class="line"></span><br><span class="line">  <span class="selector-tag">&amp;</span><span class="selector-tag">-horizontal</span> &#123;</span><br><span class="line">    <span class="selector-tag">&amp;</span><span class="selector-pseudo">:after</span> &#123;</span><br><span class="line">      <span class="attribute">content</span>: <span class="string">"\20"</span>;</span><br><span class="line">      <span class="attribute">display</span>: block;</span><br><span class="line">      <span class="attribute">height</span>: <span class="number">0</span>;</span><br><span class="line">      <span class="attribute">clear</span>: both;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>本文对子菜单的浮层显示和菜单栏的动效处理仍有不足。关于 rc-animate, rc-trigger，笔者将在后续的文章中加以分析。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/27/antd/Radio, Checkbox/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/27/antd/Radio, Checkbox/" itemprop="url">Radio, Checkbox</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-27T00:00:00+08:00">2018-11-27</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/antd-组件库/" itemprop="url" rel="index"><span itemprop="name">antd 组件库</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/27/antd/Radio, Checkbox/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/27/antd/Radio, Checkbox/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>antd 中的 Radio, Checkbox 组件均基于 rc-checkbox 实现。本文第一部分将介绍 <a href="https://github.com/react-component/checkbox" target="_blank" rel="noopener">rc-checkbox</a>，余下两部分再介绍 Radio, Checkbox 组件。</p>
<h2 id="rc-checkbox"><a href="#rc-checkbox" class="headerlink" title="rc-checkbox"></a>rc-checkbox</h2><p>rc-checkbox 输出 Checkbox 组件。其处理逻辑较为简单，包含样式类转换、多余 props 剔除等。元素层级上，rc-checkbox 使用 span 包裹 input 节点和内层 span 节点（该 span 节点将绘制可见的单选框样式）。样式类转换指 span 元素的样式类包含或可能包含 props.prefixCls, props.className, <code>${props.prefixCls}-checked</code>, <code>${props.prefixCls}-disabled</code>；input 节点的样式类为 <code>${props.prefixCls}-input</code>；内层 span 节点的样式类为 <code>${props.prefixCls}-inner</code>。多余 props 剔除指 input 元素只接受 name, id, type, readOnly, disabled, tabIndex, checked, onClick, onFocus, onBlur, onChange, autoFocus, value, ‘aria-<em>‘, ‘data-</em>‘, role 属性。其中，checked 由 Checkbox 组件的 state.checked 设定；onChange 设置为 Checkbox 组件的 handleChange 方法。当 input 节点数据变更时，props.onChange 接受到的数据先经由 Checkbox 组件转换。以下是其实现。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">handleChange = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; props &#125; = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">if</span> (props.disabled) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!(<span class="string">'checked'</span> <span class="keyword">in</span> props)) &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">      checked: e.target.checked,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  props.onChange(&#123;</span><br><span class="line">    target: &#123;</span><br><span class="line">      ...props,</span><br><span class="line">      checked: e.target.checked,</span><br><span class="line">    &#125;,</span><br><span class="line">    stopPropagation() &#123;</span><br><span class="line">      e.stopPropagation();</span><br><span class="line">    &#125;,</span><br><span class="line">    preventDefault() &#123;</span><br><span class="line">      e.preventDefault();</span><br><span class="line">    &#125;,</span><br><span class="line">    nativeEvent: e.nativeEvent,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="Radio-组件"><a href="#Radio-组件" class="headerlink" title="Radio 组件"></a>Radio 组件</h2><p>antd 提供三种单选框组件：单选框 Radio, 单选框组合 RadioGroup, 单选框按钮 RadioButton。</p>
<p>Radio 组件的特殊处理逻辑为：通过 context.radioGroup = { name, onChange, value, disabled } 获得 RadioGroup 组件注入的数据，以与单选框组合完成交互。</p>
<p>Radio 组件的元素层级关系为 label 元素和 RcCheckbox 组件。以下 less 样式中，.@{radio-prefix-cls} 即 RcCheckbox 组件绘制的外层 span 元素；.@{radio-inner-prefix-cls} 即 RcCheckbox 组件绘制的内层 span 元素。Radio 组件呈现在视图上的样式以内层 span 元素及其 span:after 伪类内容绘制，选中时 span:after 设置 opacity: 1 样式。以下是 less 代码。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.@&#123;radio-prefix-cls&#125;</span> &#123;</span><br><span class="line">  <span class="selector-tag">&amp;</span><span class="selector-tag">-inner</span> &#123;</span><br><span class="line">    <span class="selector-tag">&amp;</span><span class="selector-pseudo">:after</span> &#123;</span><br><span class="line">      <span class="variable">@radio-dot-size:</span> <span class="variable">@radio-size</span> - <span class="number">8px</span>;</span><br><span class="line">      <span class="attribute">position</span>: absolute;</span><br><span class="line">      <span class="attribute">width</span>: <span class="variable">@radio-dot-size</span>;</span><br><span class="line">      <span class="attribute">height</span>: <span class="variable">@radio-dot-size</span>;</span><br><span class="line">      <span class="attribute">left</span>: (<span class="variable">@radio-size</span> - <span class="variable">@radio-dot-size</span>) / <span class="number">2</span> - <span class="number">1px</span>;</span><br><span class="line">      <span class="attribute">top</span>: (<span class="variable">@radio-size</span> - <span class="variable">@radio-dot-size</span>) / <span class="number">2</span> - <span class="number">1px</span>;</span><br><span class="line">      <span class="attribute">border-radius</span>: <span class="variable">@radio-dot-size</span>;</span><br><span class="line">      <span class="attribute">display</span>: table;</span><br><span class="line">      <span class="attribute">border-top</span>: <span class="number">0</span>;</span><br><span class="line">      <span class="attribute">border-left</span>: <span class="number">0</span>;</span><br><span class="line">      <span class="attribute">content</span>: <span class="string">' '</span>;</span><br><span class="line">      <span class="attribute">background-color</span>: <span class="variable">@radio-dot-color</span>;</span><br><span class="line">      <span class="attribute">opacity</span>: <span class="number">0</span>;</span><br><span class="line">      <span class="attribute">transform</span>: scale(<span class="number">0</span>);</span><br><span class="line">      <span class="attribute">transition</span>: all <span class="variable">@radio-duration</span> <span class="variable">@ease-in-out-circ</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="attribute">position</span>: relative;</span><br><span class="line">    <span class="attribute">top</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">left</span>: <span class="number">0</span>;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">    <span class="attribute">width</span>: <span class="variable">@radio-size</span>;</span><br><span class="line">    <span class="attribute">height</span>: <span class="variable">@radio-size</span>;</span><br><span class="line">    <span class="attribute">border-width</span>: <span class="number">1px</span>;</span><br><span class="line">    <span class="attribute">border-style</span>: solid;</span><br><span class="line">    <span class="attribute">border-radius</span>: <span class="number">100px</span>;</span><br><span class="line">    <span class="attribute">border-color</span>: <span class="variable">@border-color-base</span>;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="variable">@radio-button-bg</span>;</span><br><span class="line">    <span class="attribute">transition</span>: all <span class="variable">@radio-duration</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.@&#123;radio-prefix-cls&#125;</span><span class="selector-tag">-checked</span> &#123;</span><br><span class="line">  <span class="selector-class">.@&#123;radio-inner-prefix-cls&#125;</span> &#123;</span><br><span class="line">    <span class="attribute">border-color</span>: <span class="variable">@radio-dot-color</span>;</span><br><span class="line">    <span class="selector-tag">&amp;</span><span class="selector-pseudo">:after</span> &#123;</span><br><span class="line">      <span class="attribute">transform</span>: scale(.<span class="number">875</span>);</span><br><span class="line">      <span class="attribute">opacity</span>: <span class="number">1</span>;</span><br><span class="line">      <span class="attribute">transition</span>: all <span class="variable">@radio-duration</span> <span class="variable">@ease-in-out-circ</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>RadioButton 组件的渲染过程无甚特别之处，主要是默认将 props.prefixCls 设定为 ‘ant-radio-button’。</p>
<p>RadioGroup 组件接受 props.options 作为选项配置内容（props.options 数组项内容可以是字符串或对象）；并将 radioGroup 作为 context 内容传入子孙组件中。</p>
<h2 id="Checkbox"><a href="#Checkbox" class="headerlink" title="Checkbox"></a>Checkbox</h2><p>antd 提供两种复选框组件：复选框 Checkbox, 复选框组合 CheckboxGroup。</p>
<p>Checkbox 组件与 Radio 组件的实现无异，只是其接受的 context 数据内容为 checkboxGroup = { toggleOption, value, disabled } 属性。其中，toggleOption 用于影响 Checkbox 组件的 onChange 绑定函数，即改变 CheckboxGroup 组件的 state.value 状态；value 用于判断当前 Checkbox 组件是否处于选中状态。</p>
<p>CheckboxGroup 组件也与 RadioGroup 组件无异，只是其实现 toggleOption 方法，用于在复选框勾选或取消勾选时，实时更新 state.value 值，并调用 props.onChange 方法；并通过 context 注入到子孙组件中。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/7/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><span class="page-number current">8</span><a class="page-number" href="/page/9/">9</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/9/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpeg" alt="Alfred">
            
              <p class="site-author-name" itemprop="name">Alfred</p>
              <p class="site-description motion-element" itemprop="description">人苦不知足，既得陇，复望蜀</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">119</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    <span class="site-state-item-count">36</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    <span class="site-state-item-count">26</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Alfred-sg" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/xiu-fan-79/activities" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-globe"></i>知乎</a>
                  </span>
                
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Alfred</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Pisces</a> v6.0.2</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.0.2"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.2"></script>



  

  
    <script id="dsq-count-scr" src="https://alfred.disqus.com/count.js" async></script>
  

  





	





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->





  

  

  

  

  
  

  

  

  

  

</body>
</html>
