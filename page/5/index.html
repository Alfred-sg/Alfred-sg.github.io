<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.0.2" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.2">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.2" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.0.2',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="Hexo, NexT">


<meta name="description" content="人苦不知足，既得陇，复望蜀">
<meta property="og:type" content="website">
<meta property="og:title" content="修子范语">
<meta property="og:url" content="http://yoursite.com/page/5/index.html">
<meta property="og:site_name" content="修子范语">
<meta property="og:description" content="人苦不知足，既得陇，复望蜀">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="修子范语">
<meta name="twitter:description" content="人苦不知足，既得陇，复望蜀">






  <link rel="canonical" href="http://yoursite.com/page/5/">


  <title>修子范语</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">修子范语</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Alfredo's Notes</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>
        </li>
      

      
    </ul>
  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/03/03/frontend/浏览器渲染机制及性能优化/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/03/03/frontend/浏览器渲染机制及性能优化/" itemprop="url">浏览器渲染机制及性能优化</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-03-03T00:00:00+08:00">2019-03-03</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端/" itemprop="url" rel="index"><span itemprop="name">前端</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/03/03/frontend/浏览器渲染机制及性能优化/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/03/03/frontend/浏览器渲染机制及性能优化/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="网页渲染机制"><a href="#网页渲染机制" class="headerlink" title="网页渲染机制"></a>网页渲染机制</h2><p>网页渲染过程包含页面加载和页面渲染两个过程。页面加载过程指的是从服务器请求资源并构建 DOM 树的过程。网页渲染过程指的是通过 DOM 树渲染出视图内容。这两个过程有重合内容，因为异步加载的 js 脚本可能会修改 DOM 结构。</p>
<p>在 webkit 中，针对不同类型的资源，会有多个加载类进行处理。其大体策略为：先从本地缓存池中查找资源；如果找不到，再从网络上获取以 url 为标识的资源。缓存分为两种：其一是内存缓存，其二是磁盘缓存。页面资源通常是同步加载；以同步模式加载 js 资源时会打断 DOM 树的构建。</p>
<p>浏览器首先加载网页内容，使用 html 解释器将网页转变成一系列的 token，再根据 token 构建 DOM 树。当一个可见的 DOM 节点（不包含 head 元素和 display 置为 none 的节点）插入到 DOM 树时，浏览器就会构建一个 RenderObject 节点并将其插入到 Render 树中（Render 树即 RenderObject 节点构成的树）。Render 树包含节点的样式信息，可以简单地理解为由 DOM + CSS 构成（css 样式会经由 css 解释器计算出各元素的样式，然后再将挂到 RenderObject 节点上）。Render 树将交由排版引擎处理，计算出每一个 RenderObject 节点的大小和位置等信息；然后再交由渲染引擎完成页面内容的绘制。</p>
<img src="/2019/03/03/frontend/浏览器渲染机制及性能优化/RenderTree.png">
<p>在 Render 树之外，为方便处理 Positioning（定位），Clipping（裁剪），Overflow-scroll（页內滚动），CSS Transform/Opacity/Animation/Filter，Mask or Reflection，Z-indexing（Z排序）等，浏览器还会生成  Layer 树。比如根节点从属于一个 RenderLayer 节点，绝对定位的节点从属于另一个 RenderLayer 节点，这样就能有效地处理视图元素的层次结构。如果某 DOM 节点没有对应的 RenderLayer，就从属于父节点的 RenderLayer。</p>
<img src="/2019/03/03/frontend/浏览器渲染机制及性能优化/LayerTree.png">
<p>Layer 树会交由浏览器渲染引擎处理。渲染引擎首先以一个布局信息不够明确的矩形绘制 RenderLayer 节点；再向下遍历子 RenderLayer 节点，并完成相关的 RenderObject 节点的绘制；然后向上递归并调整 RenderLayer 节点的布局（即回流）。可以理解的是，Render 树决定了网页的内容，Layer 树决定了网页的层次结构。RenderLayer 布局由 CPU 处理，并将位图作为纹理上传给 GPU，由 GPU 绘制内容并缓存（缓存的意义在于避免重绘）。完整过程如下：</p>
<img src="/2019/03/03/frontend/浏览器渲染机制及性能优化/RenderFlow.png">
<p>对于网页中的 js 脚本，浏览器首先会使用 js 引擎解释脚本，然后再通过 DOM 接口和 CSSOM 接口修改网页内容和样式，最终也以影响 Render 树的方式干预绘制过程。</p>
<p>在 chrome 浏览器中，F12 开发者工具 - more tools - Layers、rendering 插件可用于查看网页层级及渲染性能。</p>
<h2 id="Navigation-Timing"><a href="#Navigation-Timing" class="headerlink" title="Navigation Timing"></a>Navigation Timing</h2><p>Navigation Timing 说明了当用户在键入 url 后，浏览器中所发生的行为过程，主要包含：unload（卸载前一份文档），redirect（重定向），App Cache（重用缓存资源），DNS（DNS 查询） ，TCP（建立 TCP 连接），Request（请求网络资源），Processing（DOM 构建），onload（资源加载完成）。见下图：</p>
<img src="/2019/03/03/frontend/浏览器渲染机制及性能优化/NavigationTiming.png">
<p>Performance API 可用于分析网页的渲染性能，如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> performanceTest = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; timing &#125; = performance;</span><br><span class="line">  <span class="keyword">const</span> readyStart = timing.fetchStart - timing.navigationStart;</span><br><span class="line">  <span class="keyword">const</span> redirectTime = timing.redirectEnd - timing.redirectStart;</span><br><span class="line">  <span class="keyword">const</span> appcacheTime = timing.domainLookupStart - timing.fetchStart;</span><br><span class="line">  <span class="keyword">const</span> unloadEventTime = timing.unloadEventEnd - timing.unloadEventStart;</span><br><span class="line">  <span class="keyword">const</span> lookupDomainTime = timing.domainLookupEnd - timing.domainLookupStart;</span><br><span class="line">  <span class="keyword">const</span> connectTime = timing.connectEnd - timing.connectStart;</span><br><span class="line">  <span class="keyword">const</span> requestTime = timing.reponseEnd - timing.requestStart;</span><br><span class="line">  <span class="keyword">const</span> initDomTreeTime = timing.domInteractive - timing.reponseEnd;</span><br><span class="line">  <span class="keyword">const</span> domReadyTime = timing.domComplete - timing.domInteractive;</span><br><span class="line">  <span class="keyword">const</span> loadEventTime = timing.loadEventEnd - timing.loadEventStart;</span><br><span class="line">  <span class="keyword">const</span> loadTime = timing.loadEventEnd - timing.navigationStart;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`准备新页面时间耗时：<span class="subst">$&#123;readyStart&#125;</span>`</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`redirect 重定向耗时：<span class="subst">$&#123;redirectTime&#125;</span>`</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`Appcache 耗时：<span class="subst">$&#123;appcacheTime&#125;</span>`</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`unload 前文档耗时：<span class="subst">$&#123;unloadEventTime&#125;</span>`</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`DNS 查询耗时：<span class="subst">$&#123;lookupDomainTime&#125;</span>`</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`TCP 连接耗时：<span class="subst">$&#123;connectTime&#125;</span>`</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`request 请求耗时：<span class="subst">$&#123;requestTime&#125;</span>`</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`请求完毕至 DOM 加载：<span class="subst">$&#123;initDomTreeTime&#125;</span>`</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`解析 DOM 树耗时：<span class="subst">$&#123;domReadyTime&#125;</span>`</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`load 事件耗时：<span class="subst">$&#123;domReadyTime&#125;</span>`</span>);</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`加载时间耗时：<span class="subst">$&#123;loadTime&#125;</span>`</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="单资源加载过程"><a href="#单资源加载过程" class="headerlink" title="单资源加载过程"></a>单资源加载过程</h3><p>点开浏览器 Network 面板，鼠标悬浮在某资源的 waterfall 区域，可以查看某一资源的加载过程。如下图：</p>
<img src="/2019/03/03/frontend/浏览器渲染机制及性能优化/download.png">
<ul>
<li>Queuing：请求排队中。在 HTTP 1 上，浏览器仅允许每个源拥有六个 TCP 连接；若请求的资源为低优先级资源，将让位给高优先级的样式或脚本资源</li>
<li>Stalled：请求等待发送所用的时间，包含代理协商所用的任何时间</li>
<li>DNS Lookup：执行 DNS 查询所用的时间。页面上的每一个新域都需要完整的往返才能执行 DNS 查询</li>
<li>Initial Connection：建立连接所用的时间，包括 TCP 握手/重试和协商 SSL 的时间</li>
<li>SSL：完成 SSL 握手所用的时间</li>
<li>Request Sent：发出网络请求所用的时间</li>
<li>Waiting(TTFB)：等待初始响应所用的时间，也称为至第一字节的响应时间</li>
<li>Content Download：接收响应数据所用的时间</li>
</ul>
<p>performance.getEntries() 可用于获取页面所有资源的 performance timing 情况。</p>
<h2 id="回流、重绘"><a href="#回流、重绘" class="headerlink" title="回流、重绘"></a>回流、重绘</h2><p>回流（重排）指的是，当元素的布局或显示等信息改变时，引起 Render 树部分或整体的重新构建，即网页布局的调整。重绘指的是，Render 树中节点属性的更新。因此，回流必然会引起重绘，重绘不一定引起回流。与布局无关的元素属性操作将只引起重绘，否则将同时引起回流和重绘。可能引起回流、重绘的行为如下：</p>
<ul>
<li>添加、删除元素（回流+重绘）</li>
<li>隐藏元素：display:none（回流+重绘）；visibility:hidden（只重绘，不回流）</li>
<li>移动元素：改变 top,left（不一定引起回流）；将元素移动到另一个父元素中（回流+重绘）等</li>
<li>改变 style：布局相关属性如 padding, border-width, font-size（回流+重绘）；布局无关属性（只重绘，不回流）。可查看 <a href="https://csstriggers.com/" target="_blank" rel="noopener">https://csstriggers.com/</a> 以获取更多信息</li>
<li>用户操作：改变浏览器大小，改变浏览器的字体大小等（回流+重绘）</li>
</ul>
<p>回流的开销比重绘大。如果 body 顶部插入一个节点，将引起整个 body 的回流；如果尾部插入一个节点，将只引起部分内容的回流，因此开销较小。浏览器为提升回流、重绘的性能，会构建队列以执行批量处理。但是，访问节点的 offsetTop, scrollTop, clientTop, width, height 类属性或调用了 getComputedStyle 方法，将迫使浏览器提前执行队列以获得最新的样式。减少回流、重绘的方法如下：</p>
<ol>
<li>className 或 cssText 批量更新样式，避免单属性操作引起的频繁回流或重绘</li>
<li>新创建的元素改完样式后，再插入文档；或者先将节点的 display 属性置为 none，调整样式后再置回显示状态</li>
<li>使用变量缓存元素的样式，避免频繁读取元素的样式，致使浏览器提前执行回流队列（以计算元素的布局信息）</li>
<li>指定图片的宽高，避免新加载的图片调整大小时引起的回流</li>
<li>[慎用]使频繁回流、重绘的元素单独有一个 RenderLayer：借助 video 元素、WebGL、Canvas、CSS3 3D、CSS滤镜、z-index 大于某个相邻节点的元素都会有独立的 RenderLayer，比如通过添加 transform: translateZ(0);<br>backface-visibility: hidden; 样式即可。</li>
</ol>
<p>回流、重绘可借助 dynaTrace（测试ie）、Speed Tracer（测试Chrome） 测试。</p>
<h2 id="性能分析"><a href="#性能分析" class="headerlink" title="性能分析"></a>性能分析</h2><h3 id="performance"><a href="#performance" class="headerlink" title="performance"></a>performance</h3><p>Performance API 除了可以用于分析网页渲染过程的性能外，也可以用于分析某个方法的执行性能等。</p>
<ul>
<li>performance.memory：内存占用的具体数据</li>
<li>performance.now()：获取从 navigationStart 到当前时间的时间，可用于计算方法的执行时间</li>
<li>performance.mark(markName)：给相应的视点做标记</li>
<li>performance.measure(name, startMark, endMark)：计算方法的执行时间</li>
<li>performance.getEntriesByName(name)：获取指定 measure</li>
<li>performance.clearMarks()：清除标记</li>
<li>performance.clearMeasures()：清除 measure</li>
</ul>
<h3 id="profile"><a href="#profile" class="headerlink" title="profile"></a>profile</h3><p>console.profile() 或 console.profileEnd() 可用于分析 js 脚本的内存、cpu 占用情况。以下代码为使用 performance，profile 监控某方法执行性能的示例（）。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> analyse = <span class="function">(<span class="params">fn, options</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; measureName &#125; = options;</span><br><span class="line"></span><br><span class="line">  performance.mark(<span class="string">`<span class="subst">$&#123;measureName&#125;</span>-start`</span>);</span><br><span class="line">  <span class="built_in">console</span>.profile();</span><br><span class="line"></span><br><span class="line">  fn();</span><br><span class="line"></span><br><span class="line">  <span class="built_in">console</span>.profileEnd();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 标记一个结束点</span></span><br><span class="line">  performance.mark(<span class="string">`<span class="subst">$&#123;measureName&#125;</span>-end`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 标记开始点和结束点之间的时间戳</span></span><br><span class="line">  performance.measure(</span><br><span class="line">    measureName,</span><br><span class="line">    <span class="string">`<span class="subst">$&#123;measureName&#125;</span>-start`</span>,</span><br><span class="line">    <span class="string">`<span class="subst">$&#123;measureName&#125;</span>-end`</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取所有名称为mySetTimeout的measures</span></span><br><span class="line">  <span class="keyword">const</span> measures = performance.getEntriesByName(measureName);</span><br><span class="line">  <span class="keyword">const</span> measure = measures[<span class="number">0</span>];</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">`<span class="subst">$&#123;measureName&#125;</span> milliseconds: <span class="subst">$&#123;measure.duration&#125;</span>`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清除标记</span></span><br><span class="line">  performance.clearMarks();</span><br><span class="line">  performance.clearMeasures();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">analyse(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; <span class="number">1000</span>; i++)&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(i + <span class="number">1</span>);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  measureName: <span class="string">'cycle'</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="分析工具"><a href="#分析工具" class="headerlink" title="分析工具"></a>分析工具</h3><ul>
<li>chrome 浏览器的 Page Speed 扩展工具能帮助我们查看网页加载性能，并给出有效的建议。</li>
</ul>
<h2 id="性能优化"><a href="#性能优化" class="headerlink" title="性能优化"></a>性能优化</h2><p>YSlow 性能优化原则主要包含网络加载类、页面渲染类、css 优化类、js 执行类、缓存类、图片类、架构协议类等几大类。概要性总结如下：</p>
<h3 id="网络加载类"><a href="#网络加载类" class="headerlink" title="网络加载类"></a>网络加载类</h3><ol>
<li>减少 http 请求次数，可以利用构建工具合并文件、使用雪碧图等。原因是浏览器同域资源的请求数有所限制。</li>
<li>减小 http 请求大小，可以利用构建工具压缩混淆 js 脚本或 css 样式，使用 base64 图片等。</li>
<li>避免使用 style 或 script 标签直接引入代码块，使用外部文件引入（这样做会增加请求数，手机端可以酌情引入样式、代码块）。</li>
<li>避免空的 href 和 src。原因是渲染过程中仍会引起加载动作。</li>
<li><p>为 html 指定 Cache-Control 或 Expires 以缓存页面。如 </p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Cache-Control"</span> <span class="attr">content</span>=<span class="string">"max-age=7200"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"Expires"</span> <span class="attr">content</span>=<span class="string">"Mon, 20 Jul 2019 23:00:00 GMT"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>为 html 指定 Etag 或 Last-Modified 以缓存页面。对于未修改的文件，浏览器会从本地缓存中读取。如</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"last-modified"</span> <span class="attr">content</span>=<span class="string">"Mon, 20 Jul 2019 23:00:00 GMT"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>避免重定向，每次重定向会消耗大约 600 毫秒的时间。</p>
</li>
<li>使用静态资源粉鱼存放来增加并行下载数。原因还是浏览器同域资源的请求数有所限制。</li>
<li>使用 CDN 内容分发网络。CDN 可以提升静态资源的加载速度。</li>
<li>使用 CDN Combo，即将多个文件请求打包成一个文件，这样可以服用同一个 http 请求，加快资源下载速度。 </li>
<li>使用 ajax 缓存：针对 get 请求，消息头添加 Expires，可以缓存响应。</li>
<li>使用 get 请求。原因是 post 请求先发送文件头，再发送 http 正文；get 请求只发送文件头。</li>
<li>减少 cookie 的大小并进行 cookie 隔离（即使用不同域名存放静态资源，这样就隔离了 cookie）；设置合适的域级别和有效期。</li>
<li>减小 favicon.ico 的大小并缓存。</li>
<li>推荐使用异步 js 资源；异步的 js 资源不会阻塞文档解析。</li>
<li>合理拆分 css 及 js 资源，避免阻塞渲染。</li>
<li>避免在 import 方式加载 css 资源。原因是 import 方式需等解析到 @import 时才会加载指定的 css 资源，会大大延后 css 渲染完成的时间。</li>
<li>通过 Content-Encoding: gzip 响应头压缩资源。以下是基于 nginx 压缩文件。<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">etag</span> <span class="string">on;</span> <span class="comment"># 开启etag验证</span></span><br><span class="line"><span class="string">expires</span> <span class="number">7</span><span class="string">d;</span> <span class="comment"># 设置缓存过期时间为7天</span></span><br><span class="line"><span class="string">gzip</span> <span class="string">on;</span> <span class="comment"># 压缩资源</span></span><br><span class="line"><span class="string">gzip_types</span> <span class="string">text/plain</span> <span class="string">application/javascriptapplication/x-javascripttext/css</span> <span class="string">application/xml</span> <span class="string">text/javascriptapplication/x-httpd-php</span> <span class="string">application/vnd.ms-fontobject</span> <span class="string">font/ttf</span> <span class="string">font/opentype</span> <span class="string">font/x-woff</span> <span class="string">image/svg+xml;</span> <span class="comment"># 压缩资源类型（压缩图片会占用后台资源，效果也不佳）</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="页面渲染类"><a href="#页面渲染类" class="headerlink" title="页面渲染类"></a>页面渲染类</h3><ol>
<li>把 css 资源放在 html 顶部，保证浏览器尽早完成页面渲染。</li>
<li>把 js 资源放在 html 尾部，避免加载和解析 js 过程中阻塞页面渲染。</li>
<li>避免在 html 中直接缩放图片。原因是缩放图片的动作会引起重排重绘。</li>
<li>减少 dom 节点的数量和深度，以提升 dom 树构建的速度。</li>
<li>避免使用 table, iframe 等慢元素。原因是 table 会等到它的 dom 树全部生成后再一次性插入页面中；iframe 内资源的下载过程会阻塞父页面静态资源的下载及 css, dom 树的解析。</li>
<li>避免运行耗时的 js；采用预加载方式加载资源，即当浏览器空闲候，再预加载资源（包含跳转页面的资源、新版本的资源等）。</li>
<li>避免使用运行较慢的 css 表达式或滤镜。</li>
</ol>
<h3 id="移动端优化策略"><a href="#移动端优化策略" class="headerlink" title="移动端优化策略"></a>移动端优化策略</h3><h4 id="网络加载类-1"><a href="#网络加载类-1" class="headerlink" title="网络加载类"></a>网络加载类</h4><ol>
<li>首屏数据提前请求，避免 js 文件加载后再请求数据。</li>
<li>首屏加载和按需加载，非首屏内容滚屏加载，保证首屏内容最小化。</li>
<li>模块化资源异步并行下载，可借助 webpack 达成 dynamic-import 实现。</li>
<li>inline 首屏必要的 css 和 js，避免页面出现空白。</li>
<li><p>设置文件资源的 DNS 预解析，让浏览器提前解析获取静态资源的主机 IP，避免等到请求时才发起 DNS 解析请求。如</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">http-equiv</span>=<span class="string">"x-dns-prefetch-control"</span> <span class="attr">content</span>=<span class="string">"on"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">link</span> <span class="attr">rel</span>=<span class="string">"dns-prefetch"</span> <span class="attr">href</span>=<span class="string">"//cdn.domain.com"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>资源预加载。</p>
</li>
<li>保证 html 内容在 1KB 以内。TCP 网络传输的最大传输单元（Maximum Transimission Unit，MTU）为 1500B，即一个 RTT（Round-Tip Time，网络请求往返时间）内可以传输的数据量最大为 1500 字节。保证 html 内容在 1KB 以内，可以使 html 在一个 RTT 内加载完成。</li>
</ol>
<h4 id="缓存类"><a href="#缓存类" class="headerlink" title="缓存类"></a>缓存类</h4><ol>
<li>合理利用浏览器缓存，Cache-Control, Expires, Etag, Last-Modified 以及 localStorage 等，尽可能减少网络请求。</li>
<li>静态资源离线方案？？？</li>
<li>尝试使用 <a href="https://segmentfault.com/a/1190000012311882" target="_blank" rel="noopener">AMP HTML</a>？？？</li>
</ol>
<h4 id="图片类"><a href="#图片类" class="headerlink" title="图片类"></a>图片类</h4><ol>
<li>压缩图片，合理使用 base64 图片。</li>
<li>使用更高压缩比格式的图片，如 webp 等。</li>
<li><p>图片懒加载。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">img</span> <span class="attr">data-src</span>=<span class="string">"//cdn.domain.com/path/photo.js"</span> <span class="attr">alt</span>=<span class="string">"懒加载"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 media query 或 srcset 根据不同屏幕加载不同大小的图片。</p>
</li>
<li><p>使用 iconfront 代替图片图标。可使用 <a href="https://www.iconfont.cn/" target="_blank" rel="noopener">阿里矢量图标库</a> 制作图标。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">font-face</span> &#123;</span><br><span class="line">  <span class="attribute">font-family</span>: iconfront;</span><br><span class="line">  <span class="attribute">src</span>: <span class="built_in">url</span>(<span class="string">"./iconfront.eot"</span>);</span><br><span class="line">  <span class="attribute">src</span>: <span class="built_in">url</span>(<span class="string">"./iconfront.eot?#iefix"</span>) <span class="built_in">format</span>(<span class="string">"eot"</span>),</span><br><span class="line">       <span class="built_in">url</span>(<span class="string">"./iconfront.woff"</span>) <span class="built_in">format</span>(<span class="string">"woff"</span>),</span><br><span class="line">       <span class="built_in">url</span>(<span class="string">"./iconfront.ttf"</span>) <span class="built_in">format</span>(<span class="string">"truetype"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>限制图片大小：推荐 10KB 以内，不能超过 30KB。</p>
</li>
</ol>
<h4 id="脚本类"><a href="#脚本类" class="headerlink" title="脚本类"></a>脚本类</h4><ol>
<li>尽量使用 id 选择器。原因选择 id 元素时执行速度最快。</li>
<li>尽量缓存 dom 对象，避免每次使用时需要从 dom 树中重新查找。</li>
<li>尽量使用事件代理，避免直接使用事件绑定。这样可以避免不必要的内存泄露及需要动态添加元素的事件绑定问题。</li>
<li>使用 touchstart 代替 click。因为移动端 touchstart 事件和 click 事件之间存在 300 毫秒的延时。</li>
<li>避免 touchmove, scroll 链接事件处理，事件触发频繁容易使页面卡顿，可每隔 16ms （60 帧的真间隔为 16.7ms）再触发事件。</li>
<li>避免使用 eval, with，使用 join 代替连接符 +，推荐使用 es6 的模板字符串。这样更安全。</li>
<li>尽量使用 es6+ 的特性来编程。这样更安全高效。</li>
</ol>
<h4 id="渲染类"><a href="#渲染类" class="headerlink" title="渲染类"></a>渲染类</h4><ol>
<li><p>使用 viewport 固定品目渲染，可以加载渲染过程，同时可以避免缩放导致的重排重绘。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"</span> /&gt;</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>避免各种形式的重排重绘。</p>
</li>
<li>使用 css3 动画，使用 transform: translateZ(0) 开启 GPU 加速，让动画更流畅。</li>
<li>合理使用 canvas 和 requestAnimationFrame 等更高效的动画实现方式，避免 setTimeout, setInterval 等方式直接处理连续动画。</li>
<li>使用 svg 代替图片，因为 svg 内容更小，结构更方便调整。</li>
<li>避免 float 比较耗时的布局方式，推荐使用固定布局或弹性布局。</li>
<li>避免过多的 font-size 声明，这样会增加字体的大小计算。</li>
</ol>
<h4 id="架构协议类"><a href="#架构协议类" class="headerlink" title="架构协议类"></a>架构协议类</h4><ol>
<li>尝试使用 SPDY 和 http2 协议。SPDY 协议可复用连接，以加快传输过程，缩短资源加载时间。</li>
<li>使用后端数据渲染（数据回填到 html 中），这样可以避免空白页的出现，同时可以解决移动端 SEO 问题。</li>
<li>使用 Native View 代替 DOM，以便将页面内容渲染提升到接近客户端 Native 应用级别。</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://www.nowamagic.net/academy/detail/48110562" target="_blank" rel="noopener">Render树、RenderObject与RenderLayer</a><br><a href="https://segmentfault.com/a/1190000015808716" target="_blank" rel="noopener">webkit渲染机制浅析</a><br><a href="https://developers.google.cn/web/tools/chrome-devtools/network-performance/understanding-resource-timing" target="_blank" rel="noopener">了解 Resource Timing</a><br><a href="https://blog.csdn.net/xingsilong/article/details/80624765" target="_blank" rel="noopener">页面呈现、重绘、回流</a><br><a href="https://www.cnblogs.com/bldxh/p/6857324.html" target="_blank" rel="noopener">Performance — 前端性能监控利器</a><br><a href="https://blog.csdn.net/qq_40128367/article/details/82920370" target="_blank" rel="noopener">首屏时间从12.67s到1.06s，我是如何做到的？</a><br><a href="https://www.cnblogs.com/xianyulaodi/p/5755079.html" target="_blank" rel="noopener">雅虎前端优化的35条军规</a><br><a href="http://www.barretlee.com/blog/2016/04/01/optimization-in-taobao-homepage/" target="_blank" rel="noopener">淘宝首页性能优化实践</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/26/网站制作/nginx/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/26/网站制作/nginx/" itemprop="url">nginx</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-26T00:00:00+08:00">2019-02-26</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/网站制作/" itemprop="url" rel="index"><span itemprop="name">网站制作</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/02/26/网站制作/nginx/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/02/26/网站制作/nginx/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="步骤"><a href="#步骤" class="headerlink" title="步骤"></a>步骤</h2><ol>
<li><a href="http://nginx.org/en/download.html" target="_blank" rel="noopener">nginx主站</a> 下载 nginx</li>
<li>cd 到 nginx 目录，start nginx 启动</li>
<li>修改 conf/nginx.conf 全局配置，nginx -s reload 重启</li>
</ol>
<h2 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h2><p>start nginx 启动<br>nginx -s stop 强制退出<br>nginx -s quit 平滑退出<br>nginx -s reload 修改配置后，平滑重启</p>
<p>taskkill /F /IM nginx.exe &gt; null 强制杀死 nginx 进程<br>taskkill /fi “imagename nginx.exe” 查看 nginx 进程</p>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">worker_process</span> <span class="number">1</span><span class="string">;</span></span><br><span class="line"></span><br><span class="line"><span class="string">events</span> <span class="string">&#123;</span></span><br><span class="line">  <span class="string">worker_connection</span> <span class="number">1024</span><span class="string">;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="string">http</span> <span class="string">&#123;</span></span><br><span class="line">  <span class="string">include</span> <span class="string">mime.types;</span> <span class="comment"># 缺失会导致 css 解析无效</span></span><br><span class="line">  <span class="string">default_type</span> <span class="string">application/octet-stream;</span></span><br><span class="line"></span><br><span class="line">  <span class="string">gzip</span> <span class="string">on;</span></span><br><span class="line"></span><br><span class="line">  <span class="string">server</span> <span class="string">&#123;</span></span><br><span class="line">    <span class="string">listen</span> <span class="number">80</span><span class="string">;</span></span><br><span class="line">    <span class="string">server_name</span> <span class="string">localhost;</span></span><br><span class="line">    <span class="string">root</span> <span class="attr">D:/git/test;</span></span><br><span class="line">  <span class="string">&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.cnblogs.com/fengff/p/8892590.html" target="_blank" rel="noopener">Nginx安装及配置详解</a><br><a href="https://blog.csdn.net/wangzhenyu177/article/details/78679053" target="_blank" rel="noopener">nginx常用配置—-作为web服务端</a><br><a href="http://nginx.org/en/docs/windows.html" target="_blank" rel="noopener">nginx for Windows</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/25/antd/react-component/rc-trigger/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/25/antd/react-component/rc-trigger/" itemprop="url">rc-trigger</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-25T00:00:00+08:00">2019-02-25</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/antd-组件库/" itemprop="url" rel="index"><span itemprop="name">antd 组件库</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/02/25/antd/react-component/rc-trigger/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/02/25/antd/react-component/rc-trigger/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>rc-trigger 集成了弹层显示隐藏的处理逻辑，以便在操作挂载元素时显示和隐藏弹层。简单的使用场景如：当鼠标移入帮助符号时，显示文本提示；当鼠标移出时，隐藏文本提示。rc-trigger 的组件层级如下：</p>
<img src="/2019/02/25/antd/react-component/rc-trigger/层级结构.png">
<p>为适配弹层的多种处理逻辑，rc-trigger 统一在弹层触发元素外围以虚拟组件 Trigger 的形式组织弹层显示隐藏的处理逻辑。为使弹层不受触发元素位置及大小的影响，rc-trigger 统一将弹层插入到 document 根节点中：Popup 组件既用于绘制蒙层，又用于组织弹层的动效以及调整弹层的位置；PopupInner 对接 Trigger，弹层实际内容外围挂载鼠标移入移出事件对弹层的影响；LazyRenderBox 根据 props.visible 等属性，决定是否需要绘制弹层实际内容，还是绘制空的 div 元素；popup 用于渲染弹层的实际内容。</p>
<p>作为对外交互组件，Trigger 实现了系列方法管理着弹层的显示隐藏状态 state.popupVisible，该值即作为 LazyRenderBox 组件获得的 props.visible 属性。rc-trigger 针对弹层的显示隐藏状态，有两种事件处理逻辑：以指定的事件操纵触发元素时显示弹层；或者如鼠标移出弹层时隐藏弹层。因为这两种事件处理逻辑都与弹层的显示隐藏状态有关，所以都在 Trigger 组件内实现。Trigger 组件向下对接 PopupInner 组件，为其注入 props.onMouseLeave 等方法以操纵弹层的显隐。Trigger 组件内部实现 onClick 等方法，这样就可以在点击触发元素时显示弹层。最终，Trigger 组件对外透出可配置的 props 属性，以满足开发者的特定处理逻辑。同样的，为使 Popup 组件中实现的弹层动效处理逻辑、弹层调整方式可配置，Trigger 组件的 props 属性覆盖了弹层动效、位置相关的配置项。</p>
<p>这样的处理机制有其一般性，即在构造抽象组件时，在父组件中实现抽象组件层级的视图状态和状态管理方法，并将子组件中使用的状态管理方法透传到子组件中，以使透传的状态管理方法和子组件的渲染内容相互绑定；再由父组件对外提供可配置项，既可以定制父组件的处理逻辑，也可以定制子组件的处理逻辑，从而满足开发者的特定需求。</p>
<p>对于 Trigger 组件的处理逻辑，小结如下：</p>
<ol>
<li>渲染时将弹层插入 document 根节点。</li>
<li>通过 props.action, props.showAction, props.hideAction 指定切换弹层显示隐藏状态的事件；在 Trigger 组件中实现诸如 onClick 等方法以切换弹层的显示隐藏状态。</li>
<li>在 Trigger 组件中实现 onPopupMouseLeave 等方法，透传到 PopupInner 组件中，以使鼠标移出弹层时隐藏弹层。</li>
<li>Trigger 将弹层动效、位置调整相关属性传入 Popup 组件中。</li>
</ol>
<h2 id="弹层渲染"><a href="#弹层渲染" class="headerlink" title="弹层渲染"></a>弹层渲染</h2><p>当使用 react16 框架，弹层渲染实际借助于 ReactDOM.createPortal 方法，由 rc-utils 提供 Protal 组件；当没有使用 react16 框架，弹层渲染通过 rc-utils 提供的 ContainerRender 组件完成。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 没有指定 props.getPopupContainer 时，弹层在根节点中创建 div 元素并完成渲染</span></span><br><span class="line">getContainer = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; props &#125; = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">const</span> popupContainer = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span><br><span class="line">  <span class="comment">// Make sure default popup container will never cause scrollbar appearing</span></span><br><span class="line">  <span class="comment">// https://github.com/react-component/trigger/issues/41</span></span><br><span class="line">  popupContainer.style.position = <span class="string">'absolute'</span>;</span><br><span class="line">  popupContainer.style.top = <span class="string">'0'</span>;</span><br><span class="line">  popupContainer.style.left = <span class="string">'0'</span>;</span><br><span class="line">  popupContainer.style.width = <span class="string">'100%'</span>;</span><br><span class="line">  <span class="keyword">const</span> mountNode = props.getPopupContainer ?</span><br><span class="line">    props.getPopupContainer(findDOMNode(<span class="keyword">this</span>)) : props.getDocument().body;</span><br><span class="line">  mountNode.appendChild(popupContainer);</span><br><span class="line">  <span class="keyword">return</span> popupContainer;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">render()&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// getComponent 渲染 Popup 等弹层组件</span></span><br><span class="line">  <span class="keyword">if</span> (!IS_REACT_16) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;ContainerRender</span><br><span class="line">        parent=&#123;<span class="keyword">this</span>&#125;</span><br><span class="line">        visible=&#123;popupVisible&#125;</span><br><span class="line">        autoMount=&#123;<span class="literal">false</span>&#125;</span><br><span class="line">        forceRender=&#123;forceRender&#125;</span><br><span class="line">        getComponent=&#123;<span class="keyword">this</span>.getComponent&#125;</span><br><span class="line">        getContainer=&#123;<span class="keyword">this</span>.getContainer&#125;</span><br><span class="line">      &gt;</span><br><span class="line">        &#123;(&#123; renderComponent &#125;) =&gt; &#123;</span><br><span class="line">          <span class="keyword">this</span>.renderComponent = renderComponent;</span><br><span class="line">          <span class="keyword">return</span> trigger;</span><br><span class="line">        &#125;&#125;</span><br><span class="line">      &lt;<span class="regexp">/ContainerRender&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  let portal;</span></span><br><span class="line"><span class="regexp">  /</span><span class="regexp">/ prevent unmounting after it's rendered</span></span><br><span class="line"><span class="regexp">  if (popupVisible || this._component || forceRender) &#123;</span></span><br><span class="line"><span class="regexp">    portal = (</span></span><br><span class="line"><span class="regexp">      &lt;Portal</span></span><br><span class="line"><span class="regexp">        key="portal"</span></span><br><span class="line"><span class="regexp">        getContainer=&#123;this.getContainer&#125;</span></span><br><span class="line"><span class="regexp">        didUpdate=&#123;this.handlePortalUpdate&#125;</span></span><br><span class="line"><span class="regexp">      &gt;</span></span><br><span class="line"><span class="regexp">        &#123;this.getComponent()&#125;</span></span><br><span class="line"><span class="regexp">      &lt;/</span>Portal&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [</span><br><span class="line">    trigger,</span><br><span class="line">    portal,</span><br><span class="line">  ];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="触发元素的绑定事件"><a href="#触发元素的绑定事件" class="headerlink" title="触发元素的绑定事件"></a>触发元素的绑定事件</h2><p>触发元素上可绑定的事件包含 ‘onClick’, ‘onMouseDown’, ‘onTouchStart’, ‘onMouseEnter’, ‘onMouseLeave’, ‘onFocus’, ‘onBlur’, ‘onContextMenu’。props.action, props.showAction, props.hideAction 就允许开发者以数组形式指定触发元素上绑定的事件。同时，Trigger 组件中实现了 isClickToShow 等方法用于判断开发者指定在触发元素的绑定事件。若 isClickToShow 方法返回真值时，那么触发元素上绑定的 onClick 方法就可以调用 Trigger 组件的内置处理逻辑，以显示或隐藏弹层；否则，触发元素上绑定的 onClick 方法就只能调用开发者传给 Trigger 组件或触发元素 children 的 props.onClick。其他事件的处理机制与此类同。</p>
<p>在实现上，rc-trigger 有两层处理逻辑：若所处理的事件不影响弹层的显示隐藏状态，将 createTwoChains 创建的兜底函数作为绑定函数，直接调用外层 Trigger 元素或 children 触发元素的 props 同名方法；若影响，使用内置的 onClick 方法作为事件的绑定函数，以切换弹层的显示隐藏状态。下面就是兜底函数和内置绑定函数的实现，内置绑定函数仅以 onClick 作为示例：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 事件的兜底处理函数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// const ALL_HANDLERS = ['onClick', 'onMouseDown', 'onTouchStart', 'onMouseEnter', </span></span><br><span class="line"><span class="comment">// 'onMouseLeave', 'onFocus', 'onBlur', 'onContextMenu'];</span></span><br><span class="line">componentWillMount() &#123;</span><br><span class="line">  ALL_HANDLERS.forEach(<span class="function">(<span class="params">h</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>[<span class="string">`fire<span class="subst">$&#123;h&#125;</span>`</span>] = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.fireEvents(h, e);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 先调用触发元素 children 的 props 方法，再调用 Trigger 元素的 props 方法</span></span><br><span class="line">fireEvents(type, e) &#123;</span><br><span class="line">  <span class="keyword">const</span> childCallback = <span class="keyword">this</span>.props.children.props[type];</span><br><span class="line">  <span class="keyword">if</span> (childCallback) &#123;</span><br><span class="line">    childCallback(e);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> callback = <span class="keyword">this</span>.props[type];</span><br><span class="line">  <span class="keyword">if</span> (callback) &#123;</span><br><span class="line">    callback(e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 在 render 时作为触发元素 children 实际绑定的方法</span></span><br><span class="line">createTwoChains(event) &#123;</span><br><span class="line">  <span class="keyword">const</span> childPros = <span class="keyword">this</span>.props.children.props;</span><br><span class="line">  <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">  <span class="keyword">if</span> (childPros[event] &amp;&amp; props[event]) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>[<span class="string">`fire<span class="subst">$&#123;event&#125;</span>`</span>];</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> childPros[event] || props[event];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 通过事件显隐弹层</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 实时或延迟显隐弹窗</span></span><br><span class="line">delaySetPopupVisible(visible, delayS, event) &#123;</span><br><span class="line">  <span class="keyword">const</span> delay = delayS * <span class="number">1000</span>;</span><br><span class="line">  <span class="keyword">this</span>.clearDelayTimer();</span><br><span class="line">  <span class="keyword">if</span> (delay) &#123;</span><br><span class="line">    <span class="keyword">const</span> point = event ? &#123; <span class="attr">pageX</span>: event.pageX, <span class="attr">pageY</span>: event.pageY &#125; : <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.delayTimer = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.setPopupVisible(visible, point);</span><br><span class="line">      <span class="keyword">this</span>.clearDelayTimer();</span><br><span class="line">    &#125;, delay);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.setPopupVisible(visible, event);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">onClick = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.fireEvents(<span class="string">'onClick'</span>, event);</span><br><span class="line">  <span class="comment">// focus will trigger click</span></span><br><span class="line">  <span class="comment">// 聚焦时快速点击，不必隐藏弹层</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.focusTime) &#123;</span><br><span class="line">    <span class="keyword">let</span> preTime;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.preClickTime &amp;&amp; <span class="keyword">this</span>.preTouchTime) &#123;</span><br><span class="line">      preTime = <span class="built_in">Math</span>.min(<span class="keyword">this</span>.preClickTime, <span class="keyword">this</span>.preTouchTime);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.preClickTime) &#123;</span><br><span class="line">      preTime = <span class="keyword">this</span>.preClickTime;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="keyword">this</span>.preTouchTime) &#123;</span><br><span class="line">      preTime = <span class="keyword">this</span>.preTouchTime;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Math</span>.abs(preTime - <span class="keyword">this</span>.focusTime) &lt; <span class="number">20</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.focusTime = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.preClickTime = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">this</span>.preTouchTime = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (event &amp;&amp; event.preventDefault) &#123;</span><br><span class="line">    event.preventDefault();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> nextVisible = !<span class="keyword">this</span>.state.popupVisible;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.isClickToHide() &amp;&amp; !nextVisible || nextVisible &amp;&amp; <span class="keyword">this</span>.isClickToShow()) &#123;</span><br><span class="line">    <span class="keyword">this</span>.setPopupVisible(!<span class="keyword">this</span>.state.popupVisible, event);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">onMouseDown = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.fireEvents(<span class="string">'onMouseDown'</span>, e);</span><br><span class="line">  <span class="keyword">this</span>.preClickTime = <span class="built_in">Date</span>.now();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">onTouchStart = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.fireEvents(<span class="string">'onTouchStart'</span>, e);</span><br><span class="line">  <span class="keyword">this</span>.preTouchTime = <span class="built_in">Date</span>.now();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">onFocus = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.fireEvents(<span class="string">'onFocus'</span>, e);</span><br><span class="line">  <span class="comment">// incase focusin and focusout</span></span><br><span class="line">  <span class="keyword">this</span>.clearDelayTimer();</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.isFocusToShow()) &#123;</span><br><span class="line">    <span class="keyword">this</span>.focusTime = <span class="built_in">Date</span>.now();</span><br><span class="line">    <span class="keyword">this</span>.delaySetPopupVisible(<span class="literal">true</span>, <span class="keyword">this</span>.props.focusDelay);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="弹层的绑定事件"><a href="#弹层的绑定事件" class="headerlink" title="弹层的绑定事件"></a>弹层的绑定事件</h2><p>当弹层已经显示时，rc-trigger 既支持在文档被点击时隐藏弹层，又支持在鼠标移出弹层时隐藏弹层。因此，Trigger 组件中有两种相关的处理逻辑：对于文档中挂载的事件，Trigger 组件在 componentDidUpdate 生命周期中对 document 节点绑定事件，所绑定的事件不限于点击，还包含文档滚动、窗口失焦；对于弹层挂载的事件，Trigger 组件实现了 onPopupMouseEnter, onPopupMouseLeave, onPopupMouseDown 方法，并透传给 PopupInner 组件，作为该组件渲染内容的绑定函数。其实现如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 1. 文档绑定事件处理函数</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据可操控弹层显隐的事件，对 document 或 window 绑定事件处理函数</span></span><br><span class="line">componentDidUpdate(_, prevState) &#123;</span><br><span class="line">  <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">  <span class="keyword">const</span> state = <span class="keyword">this</span>.state;</span><br><span class="line">  <span class="keyword">const</span> triggerAfterPopupVisibleChange = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (prevState.popupVisible !== state.popupVisible) &#123;</span><br><span class="line">      props.afterPopupVisibleChange(state.popupVisible);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">if</span> (!IS_REACT_16) &#123;</span><br><span class="line">    <span class="keyword">this</span>.renderComponent(<span class="literal">null</span>, triggerAfterPopupVisibleChange);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.prevPopupVisible = prevState.popupVisible;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// We must listen to `mousedown` or `touchstart`, edge case:</span></span><br><span class="line">  <span class="comment">// https://github.com/ant-design/ant-design/issues/5804</span></span><br><span class="line">  <span class="comment">// https://github.com/react-component/calendar/issues/250</span></span><br><span class="line">  <span class="comment">// https://github.com/react-component/trigger/issues/50</span></span><br><span class="line">  <span class="keyword">if</span> (state.popupVisible) &#123;</span><br><span class="line">    <span class="keyword">let</span> currentDocument;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.clickOutsideHandler &amp;&amp; (<span class="keyword">this</span>.isClickToHide() || <span class="keyword">this</span>.isContextMenuToShow())) &#123;</span><br><span class="line">      currentDocument = props.getDocument();</span><br><span class="line">      <span class="keyword">this</span>.clickOutsideHandler = addEventListener(currentDocument,</span><br><span class="line">        <span class="string">'mousedown'</span>, <span class="keyword">this</span>.onDocumentClick);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// always hide on mobile</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.touchOutsideHandler) &#123;</span><br><span class="line">      currentDocument = currentDocument || props.getDocument();</span><br><span class="line">      <span class="keyword">this</span>.touchOutsideHandler = addEventListener(currentDocument,</span><br><span class="line">        <span class="string">'touchstart'</span>, <span class="keyword">this</span>.onDocumentClick);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// close popup when trigger type contains 'onContextMenu' and document is scrolling.</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.contextMenuOutsideHandler1 &amp;&amp; <span class="keyword">this</span>.isContextMenuToShow()) &#123;</span><br><span class="line">      currentDocument = currentDocument || props.getDocument();</span><br><span class="line">      <span class="keyword">this</span>.contextMenuOutsideHandler1 = addEventListener(currentDocument,</span><br><span class="line">        <span class="string">'scroll'</span>, <span class="keyword">this</span>.onContextMenuClose);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// close popup when trigger type contains 'onContextMenu' and window is blur.</span></span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.contextMenuOutsideHandler2 &amp;&amp; <span class="keyword">this</span>.isContextMenuToShow()) &#123;</span><br><span class="line">      <span class="keyword">this</span>.contextMenuOutsideHandler2 = addEventListener(<span class="built_in">window</span>,</span><br><span class="line">        <span class="string">'blur'</span>, <span class="keyword">this</span>.onContextMenuClose);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.clearOutsideHandler();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当蒙层可关闭时，点击文档关闭弹层</span></span><br><span class="line">onDocumentClick = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.props.mask &amp;&amp; !<span class="keyword">this</span>.props.maskClosable) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> target = event.target;</span><br><span class="line">  <span class="keyword">const</span> root = findDOMNode(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">if</span> (!contains(root, target) &amp;&amp; !<span class="keyword">this</span>.hasPopupMouseDown) &#123;</span><br><span class="line">    <span class="keyword">this</span>.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 鼠标右键可显示弹层时，通过文档滚动、窗口失焦可隐藏弹层</span></span><br><span class="line">onContextMenuClose = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.isContextMenuToShow()) &#123;</span><br><span class="line">    <span class="keyword">this</span>.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">close() &#123;</span><br><span class="line">  <span class="keyword">this</span>.setPopupVisible(<span class="literal">false</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2. 弹层绑定事件处理函数</span></span><br><span class="line"></span><br><span class="line">onPopupMouseEnter = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">this</span>.clearDelayTimer();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 当鼠标移出弹层时，隐藏弹层</span></span><br><span class="line"><span class="comment">// this._component 即 Popup 组件实例</span></span><br><span class="line"><span class="comment">// this._component.getPopupDomNode 用于获取 PopupInner 组件绘制的节点内容</span></span><br><span class="line">onPopupMouseLeave = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// https://github.com/react-component/trigger/pull/13</span></span><br><span class="line">  <span class="comment">// react bug?</span></span><br><span class="line">  <span class="keyword">if</span> (e.relatedTarget &amp;&amp; !e.relatedTarget.setTimeout &amp;&amp;</span><br><span class="line">    <span class="keyword">this</span>._component &amp;&amp;</span><br><span class="line">    <span class="keyword">this</span>._component.getPopupDomNode &amp;&amp;</span><br><span class="line">    contains(<span class="keyword">this</span>._component.getPopupDomNode(), e.relatedTarget)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.delaySetPopupVisible(<span class="literal">false</span>, <span class="keyword">this</span>.props.mouseLeaveDelay);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 点击弹层变更 Trigger 实例的 hasPopupMouseDown 属性，以指定文档点击区域不是弹层内部</span></span><br><span class="line"><span class="comment">// 当弹层相互嵌套时，向上递归调用 onPopupMouseDown 方法也用于阻止祖先弹层的隐藏</span></span><br><span class="line">onPopupMouseDown = <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; rcTrigger = &#123;&#125; &#125; = <span class="keyword">this</span>.context;</span><br><span class="line">  <span class="keyword">this</span>.hasPopupMouseDown = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  clearTimeout(<span class="keyword">this</span>.mouseDownTimeout);</span><br><span class="line">  <span class="keyword">this</span>.mouseDownTimeout = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.hasPopupMouseDown = <span class="literal">false</span>;</span><br><span class="line">  &#125;, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (rcTrigger.onPopupMouseDown) &#123;</span><br><span class="line">    rcTrigger.onPopupMouseDown(...args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="弹层位置调整及动效"><a href="#弹层位置调整及动效" class="headerlink" title="弹层位置调整及动效"></a>弹层位置调整及动效</h2><h3 id="位置调整"><a href="#位置调整" class="headerlink" title="位置调整"></a>位置调整</h3><p>弹层的位置调整基于 rc-align 类库。在实现上，通过将 props.alignPoint 置为真值，弹层位置即可根据鼠标移动情况进行调整；默认情况下，弹层位置取决于触发元素的显示位置。Trigger 将动态计算鼠标的位置 state.point，随后将 props.align 注入到 Popup 组件。若 Popup 组件接受的 props.align 为否值，弹层位置即取决于触发元素的显示位置；否则，由鼠标位置决定。在位置调整过程中，Trigger 组件接受的 props.onPopupAlign 可用于监听弹层位置的调整状况，以便于动态微调。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取实际注入 dom-align 类库的 alignConfig 配置，用于调整弹层位置</span></span><br><span class="line"><span class="comment">// 参见 https://github.com/yiminghe/dom-align</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAlignFromPlacement</span>(<span class="params">builtinPlacements, placementStr, align</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> baseAlign = builtinPlacements[placementStr] || &#123;&#125;;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    ...baseAlign,</span><br><span class="line">    ...align,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Trigger</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">// props.builtinPlacements 内置多种弹层放置策略，实际使用 props.popupPlacement 放置策略</span></span><br><span class="line">  <span class="comment">// props.popupAlign 作为 dom-align 库获得的 alignConfig 配置，用于调整位置</span></span><br><span class="line">  getPopupAlign() &#123;</span><br><span class="line">    <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">const</span> &#123; popupPlacement, popupAlign, builtinPlacements &#125; = props;</span><br><span class="line">    <span class="keyword">if</span> (popupPlacement &amp;&amp; builtinPlacements) &#123;</span><br><span class="line">      <span class="keyword">return</span> getAlignFromPlacement(builtinPlacements, popupPlacement, popupAlign);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> popupAlign;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 当 props.alignPoint 为真值，Popup 组件获得的 props.align 即为 state.point</span></span><br><span class="line">  <span class="comment">// 意义是弹层的定位位置将根据鼠标位置进行调整</span></span><br><span class="line">  setPoint = <span class="function">(<span class="params">point</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; alignPoint &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">if</span> (!alignPoint || !point) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">      point: &#123;</span><br><span class="line">        pageX: point.pageX,</span><br><span class="line">        pageY: point.pageY,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Popup</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 位置调整时调用</span></span><br><span class="line">  onAlign = <span class="function">(<span class="params">popupDomNode, align</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">const</span> currentAlignClassName = props.getClassNameFromAlign(align);</span><br><span class="line">    <span class="comment">// FIX: https://github.com/react-component/trigger/issues/56</span></span><br><span class="line">    <span class="comment">// FIX: https://github.com/react-component/tooltip/issues/79</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.currentAlignClassName !== currentAlignClassName) &#123;</span><br><span class="line">      <span class="keyword">this</span>.currentAlignClassName = currentAlignClassName;</span><br><span class="line">      popupDomNode.className = <span class="keyword">this</span>.getClassName(currentAlignClassName);</span><br><span class="line">    &#125;</span><br><span class="line">    props.onAlign(popupDomNode, align);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取弹层的定位位置，有两种可能：根据鼠标调整，或者触发元素的位置</span></span><br><span class="line">  getAlignTarget = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; point &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">if</span> (point) &#123;</span><br><span class="line">      <span class="keyword">return</span> point;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// getTargetElement 方法由 Trigger 注入，用于获取 Trigger 元素</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.getTargetElement;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 使用 Align 虚拟组件包裹实际渲染内容，调整弹层的显示位置</span></span><br><span class="line">  getPopupElement() &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    &lt;Align target=&#123;<span class="keyword">this</span>.getAlignTarget()&#125; key=<span class="string">"popup"</span> ref=&#123;<span class="keyword">this</span>.saveAlignRef&#125;</span><br><span class="line">      monitorWindowResize align=&#123;align&#125; onAlign=&#123;<span class="keyword">this</span>.onAlign&#125;&gt;</span><br><span class="line">      &lt;PopupInner visible &#123;...popupInnerProps&#125;&gt;</span><br><span class="line">        &#123;children&#125;</span><br><span class="line">      &lt;<span class="regexp">/PopupInner&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>Align&gt;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="动态伸缩"><a href="#动态伸缩" class="headerlink" title="动态伸缩"></a>动态伸缩</h3><p>当指定 props.stretch 为真时，弹层大小可根据触发元素动态伸缩。这一机制在 Popup 组件中实现，即通过 setStretchSize 方法计算触发元素的宽高，在 render 阶段（getPopupElement 方法执行过程中）影响弹层的 style。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">componentDidMount() &#123;</span><br><span class="line">  <span class="keyword">this</span>.rootNode = <span class="keyword">this</span>.getPopupDomNode();</span><br><span class="line">  <span class="keyword">this</span>.setStretchSize();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">componentDidUpdate() &#123;</span><br><span class="line">  <span class="keyword">this</span>.setStretchSize();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setStretchSize = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; stretch, getRootDomNode, visible &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">  <span class="keyword">const</span> &#123; stretchChecked, targetHeight, targetWidth &#125; = <span class="keyword">this</span>.state;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!stretch || !visible) &#123;</span><br><span class="line">    <span class="keyword">if</span> (stretchChecked) &#123;</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123; <span class="attr">stretchChecked</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> $ele = getRootDomNode();</span><br><span class="line">  <span class="keyword">if</span> (!$ele) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> height = $ele.offsetHeight;</span><br><span class="line">  <span class="keyword">const</span> width = $ele.offsetWidth;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (targetHeight !== height || targetWidth !== width || !stretchChecked) &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">      stretchChecked: <span class="literal">true</span>,</span><br><span class="line">      targetHeight: height,</span><br><span class="line">      targetWidth: width,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="弹层动效"><a href="#弹层动效" class="headerlink" title="弹层动效"></a>弹层动效</h3><p>弹层的动效基于 rc-animate 类库实现：包含蒙层和弹层实际内容的动效。动效可配置项都通过 Trigger 组件的 props.popupAnimation, props.popupTransitionName, props.maskAnimation, props.maskTransitionName 属性向外对接，又通过 Popup 组件的 getMaskTransitionName, getTransitionName 方法转化，然后完成渲染。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// rc-trigger 不支持 js 动效，将 animation 转化成 transitionName</span></span><br><span class="line"><span class="comment">// 以影响 rc-animate 类库输出的 Animate 组件</span></span><br><span class="line">getMaskTransitionName() &#123;</span><br><span class="line">  <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">  <span class="keyword">let</span> transitionName = props.maskTransitionName;</span><br><span class="line">  <span class="keyword">const</span> animation = props.maskAnimation;</span><br><span class="line">  <span class="keyword">if</span> (!transitionName &amp;&amp; animation) &#123;</span><br><span class="line">    transitionName = <span class="string">`<span class="subst">$&#123;props.prefixCls&#125;</span>-<span class="subst">$&#123;animation&#125;</span>`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> transitionName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getTransitionName() &#123;</span><br><span class="line">  <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">  <span class="keyword">let</span> transitionName = props.transitionName;</span><br><span class="line">  <span class="keyword">if</span> (!transitionName &amp;&amp; props.animation) &#123;</span><br><span class="line">    transitionName = <span class="string">`<span class="subst">$&#123;props.prefixCls&#125;</span>-<span class="subst">$&#123;props.animation&#125;</span>`</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> transitionName;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 渲染弹层内容</span></span><br><span class="line">getPopupElement() &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">if</span> (destroyPopupOnHide) &#123;</span><br><span class="line">    <span class="keyword">return</span> (</span><br><span class="line">      &lt;Animate component=<span class="string">""</span> exclusive transitionAppear</span><br><span class="line">        transitionName=&#123;<span class="keyword">this</span>.getTransitionName()&#125;&gt;</span><br><span class="line">        &#123;visible ? (</span><br><span class="line">          &lt;Align target=&#123;<span class="keyword">this</span>.getAlignTarget()&#125; key=<span class="string">"popup"</span> ref=&#123;<span class="keyword">this</span>.saveAlignRef&#125;</span><br><span class="line">            monitorWindowResize align=&#123;align&#125; onAlign=&#123;<span class="keyword">this</span>.onAlign&#125;&gt;</span><br><span class="line">            &lt;PopupInner visible &#123;...popupInnerProps&#125;&gt;</span><br><span class="line">              &#123;children&#125;</span><br><span class="line">            &lt;<span class="regexp">/PopupInner&gt;</span></span><br><span class="line"><span class="regexp">          &lt;/</span>Align&gt;</span><br><span class="line">        ) : <span class="literal">null</span>&#125;</span><br><span class="line">      &lt;<span class="regexp">/Animate&gt;</span></span><br><span class="line"><span class="regexp">    );</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  return (</span></span><br><span class="line"><span class="regexp">    &lt;Animate component="" exclusive transitionAppear</span></span><br><span class="line"><span class="regexp">      transitionName=&#123;this.getTransitionName()&#125; showProp="xVisible"&gt;</span></span><br><span class="line"><span class="regexp">      &lt;Align target=&#123;this.getAlignTarget()&#125; key="popup" ref=&#123;this.saveAlignRef&#125;</span></span><br><span class="line"><span class="regexp">        monitorWindowResize xVisible=&#123;visible&#125; childrenProps=&#123;&#123; visible: 'xVisible' &#125;&#125;</span></span><br><span class="line"><span class="regexp">        disabled=&#123;!visible&#125; align=&#123;align&#125; onAlign=&#123;this.onAlign&#125;&gt;</span></span><br><span class="line"><span class="regexp">        &lt;PopupInner hiddenClassName=&#123;hiddenClassName&#125; &#123;...popupInnerProps&#125;&gt;</span></span><br><span class="line"><span class="regexp">          &#123;children&#125;</span></span><br><span class="line"><span class="regexp">        &lt;/</span>PopupInner&gt;</span><br><span class="line">      &lt;<span class="regexp">/Align&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>Animate&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 渲染弹层内容</span></span><br><span class="line">getMaskElement() &#123;</span><br><span class="line">  <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">  <span class="keyword">let</span> maskElement;</span><br><span class="line">  <span class="keyword">if</span> (props.mask) &#123;</span><br><span class="line">    <span class="keyword">const</span> maskTransition = <span class="keyword">this</span>.getMaskTransitionName();</span><br><span class="line">    <span class="comment">// getZIndexStyle 方法用于获取用户配置的 zIndex</span></span><br><span class="line">    maskElement = (</span><br><span class="line">      &lt;LazyRenderBox style=&#123;<span class="keyword">this</span>.getZIndexStyle()&#125; key=<span class="string">"mask"</span></span><br><span class="line">        className=&#123;<span class="string">`<span class="subst">$&#123;props.prefixCls&#125;</span>-mask`</span>&#125;</span><br><span class="line">        hiddenClassName=&#123;<span class="string">`<span class="subst">$&#123;props.prefixCls&#125;</span>-mask-hidden`</span>&#125;</span><br><span class="line">        visible=&#123;props.visible&#125;/&gt;</span><br><span class="line">    );</span><br><span class="line">    <span class="keyword">if</span> (maskTransition) &#123;</span><br><span class="line">      maskElement = (</span><br><span class="line">        &lt;Animate key=<span class="string">"mask"</span> showProp=<span class="string">"visible"</span> transitionAppear</span><br><span class="line">          component=<span class="string">""</span> transitionName=&#123;maskTransition&#125;&gt;</span><br><span class="line">          &#123;maskElement&#125;</span><br><span class="line">        &lt;<span class="regexp">/Animate&gt;</span></span><br><span class="line"><span class="regexp">      );</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">  &#125;</span></span><br><span class="line"><span class="regexp">  return maskElement;</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/24/随笔/换种角度/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/24/随笔/换种角度/" itemprop="url">换种角度</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-24T00:00:00+08:00">2019-02-24</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/随笔/" itemprop="url" rel="index"><span itemprop="name">随笔</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/02/24/随笔/换种角度/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/02/24/随笔/换种角度/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>视图层有两种要素：页面元素和用户行为。作为可见的实体，页面元素根据用户行为施加的影响，变化着形态。假使把页面元素比作我们自学生时代就接触的弹簧，按照实验数据抽象的弹性系数就是页面元素自有的属性，施加的外力就是用户针对该节点的操作，click 或 change 之流。我们可以仿照胡克定律的方式，使用数学函数阐述视图层的变化，如 view = handler(action)。与自然现象那种冥冥中的物理机制不同的是，在人为的视图层机制中，handler 是可控的。我们既可以在 node.onClick 中看见 handler 的影子，又可以在 node.addEventListener(‘onClick’, handler) 看见 handler 的影子。当我们以弹性系数是弹簧固有的物理特征这种方式思忖这两种实现时，我们就能意识到：前一种方式是较为直观的，施加哪种影响，产生哪种变化，比如先作力的合成，再计算力的影响；后一种是可量化的、轻耦合的，不限于物质实体而抽象物理机制，再使用这套物理机制演绎物质实体的表现，比如先作力的分解，再叠加力的影响。这样我们就可以认为，作为平台的浏览器提供了力学定律，前端开发者定义了物质实体的物理特征，用户施加了作用力，继而使物质实体发生了变化。以这种方式理解浏览器的事件机制既是我个人的一种癖好，又可以拉近与浏览器实现的亲近感。在延伸面上，我们还可以把事件委托看成是”隔山打牛“这种武侠招式的浏览器表现，不是很有趣吗？</p>
<p>有什么在妨碍我们看清浏览器的实现机制就是 view = handler(action) 呢？在浏览器中，页面元素被抽象成了具有样式属性且富有层次结构的节点。在内存中驻留的节点属性就像实时变化的运动量那样，让我们不能直观地感受到输入输出模型，而是更容易只看到等式的右半部分：在 handler(action) 执行过程中，node 节点的形态发生着变化。让我们再聚焦于脚蹬自行车这种”隔山打牛“的情景，我们想必会直观地认为在 handler(action) 执行过程中，脚踏板、链条、轮轴、车轮都在运动，而不能定位到输入输出模型。一个 handler(action) 过程中的多节点变化不正是这样的吗？我们书写的代码不也正是这样的吗？因此而论，就像我们基于力学定律阐释脚蹬自行车这一物理过程一样，view = handler(action) 就是我们的力学定律，节点的种种变化就是我们的物理过程。也因此，在单输入单输出模型下，基于操作节点的前端编码方式就退化成了学生时代的解题，或者我们找到了学生时代解题的意义。以下就是单输入输出模型中常见的任务流处理方式：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">x1 = f1(x0);</span><br><span class="line">x2 = f2(x1);</span><br><span class="line"><span class="comment">// ...</span></span><br></pre></td></tr></table></figure>
<p>当我们再把眼光投向多输入多输出模型，或者整体构造比自行车复杂得多的现代汽车，面向过程的思考方式势必会让我们遭遇分岔的支路。这时候，面向对象的方式就隆重登场了。在面向对象的思维方式中，实体的状态变更可以归结为实体自有的特征，如前文提到的弹性系数。环绕弹性系数，弹簧拉伸长度和受力的机制都可以内化为实体的状态及方法。如果实体的特征仅止于此，以面向对象的方式对实体进行建模看似是不必要的。我们可以感知到面向过程的方式在这样一种单输入单输出模型上的便利性和清晰性。当然，当实体并不止于单方面的特征，面向对象的方式就会优于面向过程的方式。在这方面，我们以自带搜索表单和编辑弹窗的列表组件加以说明。如果我们以面向对象的方式封装每个组件的状态和行为，每个组件即构成交互网络中的一个节点，其所缺的就是上下游节点的通信方式。作为上游的列表组件，既可以集成弹窗的显示隐藏状态以及操纵弹窗显示隐藏的方法；又可以直接调用弹窗组件的显示隐藏方法。列表组件和搜索表单的交互方式也是一样的。因此，面向对象的方式更像一个节点网络，每个节点都各自组织节点内部的状态和行为，节点之间又通过交互接口完成通信。这和面向过程的方式有着着眼点上的不同：面向过程聚焦于输入输出流的传递和变更，更适合在单任务流串联各实体变化的脉络轨线；面向对象在于对单实体的丰富特征进行抽象，然后在节点网络中组织上下游的通信，更适合机制复杂的系统。</p>
<img src="/2019/02/24/随笔/换种角度/节点网络.png">
<p>在面向对象的编码方式中，除了 uml 类图之外，通过节点网络阐述各节点的组织关系以及各节点的内在特征也许是可行的。我们知道，以类实现的实体之间可以有依赖、聚合、继承关系，比如列表组件聚合了搜索表单和编辑弹窗，这三个组件可能都依赖了状态管理类、继承自实现生命周期管理方法的基类组件。状态管理类可视为 mobx 等类库在组件状态管理上提供的解决方案；基类组件可视为 react 等框架在视图层提供的抽象。当我们在业务层面在进一步抽象，就可以针对列表组件分别抽象两个类去封装其与搜索表单和编辑弹窗的状态管理和交互逻辑，以避免代码的重复书写。为此，typescript 像 java 那样提供了抽象类、接口、多重继承、私有属性等，为我们以面向对象的方式编写前端代码提供了许多弹药。正如这篇文章旨在于换种角度思考编程、盘活思路，这里不对具体的编码实现作深入，遗留下来的可探讨、可推敲空间仍在于展开问题，或者寻找提升编程技术的切入点。当然，这样会显得虎头蛇尾、泛泛而谈，也是笔者编程造诣不够精深的佐证吧。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/08/css/css 总汇/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/08/css/css 总汇/" itemprop="url">css 总汇</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-08T00:00:00+08:00">2019-02-08</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/css/" itemprop="url" rel="index"><span itemprop="name">css</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/02/08/css/css 总汇/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/02/08/css/css 总汇/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="选择器"><a href="#选择器" class="headerlink" title="选择器"></a>选择器</h2><h3 id="基本选择器"><a href="#基本选择器" class="headerlink" title="基本选择器"></a>基本选择器</h3><table>
<thead>
<tr>
<th>选择器</th>
<th>意义</th>
<th>版本</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>*</td>
<td>通用选择器</td>
<td>2.1</td>
<td>*</td>
</tr>
<tr>
<td>E</td>
<td>标签选择器</td>
<td>1</td>
<td>p</td>
</tr>
<tr>
<td>.class</td>
<td>类选择器</td>
<td>1</td>
<td>.nav</td>
</tr>
<tr>
<td>#id</td>
<td>ID选择器</td>
<td>1</td>
<td>#wrapper</td>
</tr>
<tr>
<td>E[attr]</td>
<td>属性选择器，匹配带 ‘data-url’ 属性的 a 元素</td>
<td>2.1</td>
<td>a[data-url]</td>
</tr>
<tr>
<td>E[attr=val]</td>
<td>属性选择器，匹配 type 属性为 ‘text’ 的 input 元素</td>
<td>2.1</td>
<td>input[type=’text’]</td>
</tr>
<tr>
<td>E[attr~=val]</td>
<td>属性选择器，匹配 keywords 属性包含 ‘round’ 的 div 元素</td>
<td>2.1</td>
<td>div[keywords~=’round’]</td>
</tr>
<tr>
<td>E[attr=val]</td>
<td>属性选择器，匹配 lang 属性以 ‘zh’ 开始的 label 元素</td>
<td>2.1</td>
<td>label[lang=’zh’]</td>
</tr>
<tr>
<td>E[attr^=val]</td>
<td>属性选择器，匹配 href 属性以 ‘http://‘ 开始的 a 元素</td>
<td>3</td>
<td>a[href^=’http://‘]</td>
</tr>
<tr>
<td>E[attr$=val]</td>
<td>属性选择器，匹配 src 属性以 ‘.png’ 结尾的 img 元素</td>
<td>3</td>
<td>img[src$=’.png’]</td>
</tr>
<tr>
<td>E[attr*=val]</td>
<td>属性选择器，匹配 href 属性中包含 ‘baidu.com’ 的 a 元素</td>
<td>3</td>
<td>a[href*=’baidu.com’]</td>
</tr>
<tr>
<td>E F</td>
<td>后代选择器</td>
<td>1</td>
<td>.blog p</td>
</tr>
<tr>
<td>E&gt;F</td>
<td>子选择器</td>
<td>2.1</td>
<td>.nav &gt; button</td>
</tr>
<tr>
<td>E+F</td>
<td>相邻兄弟选择器</td>
<td>2.1</td>
<td>label + input</td>
</tr>
<tr>
<td>E~F</td>
<td>兄弟选择器</td>
<td>3</td>
<td>header ~ div</td>
</tr>
<tr>
<td>S1, S2</td>
<td>选择器分组</td>
<td>1</td>
<td>input, select, textarea</td>
</tr>
</tbody>
</table>
<h3 id="伪类选择器"><a href="#伪类选择器" class="headerlink" title="伪类选择器"></a>伪类选择器</h3><table>
<thead>
<tr>
<th>选择器</th>
<th>意义</th>
<th>版本</th>
<th>示例</th>
</tr>
</thead>
<tbody>
<tr>
<td>:link</td>
<td>动态伪类，匹配未访问过的链接</td>
<td>1</td>
<td>a:link</td>
</tr>
<tr>
<td>:visited</td>
<td>动态伪类，匹配被访问过的链接</td>
<td>1</td>
<td>a:visited</td>
</tr>
<tr>
<td>:hover</td>
<td>动态伪类，匹配鼠标悬浮的元素</td>
<td>1</td>
<td>div:hover</td>
</tr>
<tr>
<td>:active</td>
<td>动态伪类，匹配鼠标按下的元素</td>
<td>1</td>
<td>a:active</td>
</tr>
<tr>
<td>:focus</td>
<td>动态伪类，匹配获得焦点的元素</td>
<td>2.1</td>
<td>input:focus</td>
</tr>
<tr>
<td>:target</td>
<td>目标伪类，匹配活动的锚</td>
<td>2.1</td>
<td>#tab1:target</td>
</tr>
<tr>
<td>:lang(val)</td>
<td>语言伪类，匹配指定 lang 属性的元素</td>
<td>2.1</td>
<td>p:lang(zh)</td>
</tr>
<tr>
<td>:enabled</td>
<td>状态伪类，匹配启用的元素</td>
<td>3</td>
<td>input:enabled</td>
</tr>
<tr>
<td>:disabled</td>
<td>状态伪类，匹配禁用的元素</td>
<td>3</td>
<td>input:disabled</td>
</tr>
<tr>
<td>:checked</td>
<td>状态伪类，匹配选中的元素</td>
<td>3</td>
<td>input:checked</td>
</tr>
<tr>
<td>:root</td>
<td>结构性伪类，文档根元素</td>
<td>3</td>
<td>:root</td>
</tr>
<tr>
<td>:nth-child(n)</td>
<td>结构性伪类，匹配父元素的第 n 个子元素</td>
<td>3</td>
<td>:nth-child</td>
</tr>
<tr>
<td>:nth-last-child(n)</td>
<td>结构性伪类，匹配父元素的倒数第 n 个子元素</td>
<td>3</td>
<td>:nth-last-child</td>
</tr>
<tr>
<td>:nth-of-type(n)</td>
<td>结构性伪类，匹配父元素的第 n 个相同子元素</td>
<td>3</td>
<td>:nth-of-type</td>
</tr>
<tr>
<td>:nth-last-of-type(n)</td>
<td>结构性伪类，匹配父元素的倒数第 n 个相同子元素</td>
<td>3</td>
<td>:nth-last-of-type</td>
</tr>
<tr>
<td>:first-child</td>
<td>结构性伪类，匹配父元素的第一个子元素</td>
<td>3</td>
<td>:first-child</td>
</tr>
<tr>
<td>:last-child</td>
<td>结构性伪类，匹配父元素的最后一个子元素</td>
<td>3</td>
<td>:last-child</td>
</tr>
<tr>
<td>:first-of-type</td>
<td>结构性伪类，匹配父元素的第一个相同子元素</td>
<td>3</td>
<td>:first-of-type</td>
</tr>
<tr>
<td>:last-of-type</td>
<td>结构性伪类，匹配父元素的最后一个相同子元素</td>
<td>3</td>
<td>:last-of-type</td>
</tr>
<tr>
<td>:only-child</td>
<td>结构性伪类，匹配父元素的唯一一个子元素</td>
<td>3</td>
<td>:only-child</td>
</tr>
<tr>
<td>:only-of-type</td>
<td>结构性伪类，匹配父元素的唯一一个相同子元素</td>
<td>3</td>
<td>:only-of-type</td>
</tr>
<tr>
<td>:empty</td>
<td>结构性伪类，匹配没有子元素的元素</td>
<td>3</td>
<td>:empty</td>
</tr>
<tr>
<td>::first-line</td>
<td>伪元素，匹配元素文本内容的首行</td>
<td>1</td>
<td>p::first-line</td>
</tr>
<tr>
<td>::first-letter</td>
<td>伪元素，匹配元素文本内容的首字母</td>
<td>1</td>
<td>p::first-letter</td>
</tr>
<tr>
<td>::before</td>
<td>伪元素，匹配元素之前的内容</td>
<td>2.1</td>
<td>div::before</td>
</tr>
<tr>
<td>::after</td>
<td>伪元素，匹配元素之后的内容</td>
<td>2.1</td>
<td>div::after</td>
</tr>
</tbody>
</table>
<h3 id="选择器权重"><a href="#选择器权重" class="headerlink" title="选择器权重"></a>选择器权重</h3><p>选择器分为 4 个优先级，分别是：内联样式；ID 选择器；类、伪类，属性选择器；元素，伪元素。其权重通常是 1000, 100, 10, 1。需要注明的是，11 个类选择器的权重并不会超过 1 个 ID 选择器。除此之外，!important 可将对应规则的权重提升到最高。</p>
<h2 id="响应式开发"><a href="#响应式开发" class="headerlink" title="响应式开发"></a>响应式开发</h2><h3 id="viewport"><a href="#viewport" class="headerlink" title="viewport"></a>viewport</h3><p>在介绍响应式开发前，先须理清如下三个概念，各设备的物理像素和设备像素比也见于下表：</p>
<ul>
<li>物理像素：屏幕实际的像素点。</li>
<li>设备独立像素：逻辑像素，用于定义应用的 UI。</li>
<li>屏幕像素比：物理像素和设备独立像素的比值。</li>
</ul>
<table>
<thead>
<tr>
<th>设备名称</th>
<th>物理像素</th>
<th>设备独立像素</th>
<th>屏幕像素比</th>
</tr>
</thead>
<tbody>
<tr>
<td>iPhone 7, 6, 6S</td>
<td>750*1334</td>
<td>373*667</td>
<td>2</td>
</tr>
<tr>
<td>iPhone 7 plus, 6S plus, 6 plus</td>
<td>1080*1920</td>
<td>414*736</td>
<td>3</td>
</tr>
<tr>
<td>iPhone 5, 5S, 5C, 5E</td>
<td>640*1136</td>
<td>320*568</td>
<td>2</td>
</tr>
<tr>
<td>iPhone 4</td>
<td>640*960</td>
<td>320*480</td>
<td>2</td>
</tr>
<tr>
<td>iPod Touch</td>
<td>640*1136</td>
<td>320*568</td>
<td>2</td>
</tr>
<tr>
<td>Galaxy S7, S7 edge, S6</td>
<td>1440*2560</td>
<td>360*640</td>
<td>4</td>
</tr>
<tr>
<td>Galaxy S5, S4</td>
<td>1080*1920</td>
<td>360*640</td>
<td>3</td>
</tr>
<tr>
<td>Galaxy S4 mini</td>
<td>540*960</td>
<td>360*640</td>
<td>1.5</td>
</tr>
<tr>
<td>Galaxy S3</td>
<td>720*1280</td>
<td>360*640</td>
<td>2</td>
</tr>
<tr>
<td>Galaxy Note 4</td>
<td>1440*2560</td>
<td>360*640</td>
<td>4</td>
</tr>
<tr>
<td>Galaxy Note 3</td>
<td>1080*1920</td>
<td>360*640</td>
<td>3</td>
</tr>
<tr>
<td>Galaxy Note 2</td>
<td>720*1280</td>
<td>360*640</td>
<td>2</td>
</tr>
<tr>
<td>Mi 4, 3</td>
<td>1080*1920</td>
<td>360*640</td>
<td>3</td>
</tr>
<tr>
<td>HTC One</td>
<td>1080*1920</td>
<td>360*640</td>
<td>3</td>
</tr>
<tr>
<td>Sony Xperia 23</td>
<td>1080*1920</td>
<td>360*640</td>
<td>3</td>
</tr>
<tr>
<td>Lenovo K900</td>
<td>1080*1920</td>
<td>360*640</td>
<td>3</td>
</tr>
<tr>
<td>ZTE Grand S</td>
<td>1080*1920</td>
<td>360*640</td>
<td>3</td>
</tr>
<tr>
<td>iPad Pro</td>
<td>2048*2732</td>
<td>1024*1366</td>
<td>2</td>
</tr>
<tr>
<td>iPad 3, 4, Air, Air2</td>
<td>1536*2048</td>
<td>768*1024</td>
<td>2</td>
</tr>
<tr>
<td>iPad mini 2, 3</td>
<td>1536*2048</td>
<td>768*1024</td>
<td>2</td>
</tr>
<tr>
<td>iPad mini</td>
<td>768*1024</td>
<td>768*1024</td>
<td>1</td>
</tr>
</tbody>
</table>
<p>大多数设备的视口宽度都为 980 px，通过设置 <meta name="viewport" content="width=device-width, initial-scale=1"> 可调整视口（viewport）的宽度。关于视口的概念，可参考 <a href="https://www.cnblogs.com/2050/p/3877280.html" target="_blank" rel="noopener">移动前端开发之viewport的深入理解</a>。其中，meta 标签包含的属性含义如下：</p>
<ul>
<li>width：设置 viewport 宽度。</li>
<li>initial-scale：设置 viewport 初始缩放值。</li>
<li>minimum-scale：设置 viewport 最小缩放值。</li>
<li>maximum-scale：设置 viewport 最大缩放值。</li>
<li>height：设置 viewport 高度。</li>
<li>user-scalable：是否允许用户缩放。</li>
</ul>
<h3 id="flex-布局"><a href="#flex-布局" class="headerlink" title="flex 布局"></a>flex 布局</h3><p>flex 弹性布局示意图：</p>

<p>在 flex 容器内，水平轴称为交叉轴，垂直轴称为主轴；容器内分布 flex 项目。flex 容器包含以下属性：</p>
<table>
<thead>
<tr>
<th>属性名称</th>
<th>意义</th>
<th>可选值</th>
</tr>
</thead>
<tbody>
<tr>
<td>flex-direction</td>
<td>决定 item 排列方向</td>
<td>row 从左至右；column 从上到下；row-reverse；column-reverse</td>
</tr>
<tr>
<td>flex-wrap</td>
<td>决定 item 换行方式</td>
<td>nowrap 不换行；wrap；wrap-reverse 第一行在下面</td>
</tr>
<tr>
<td>justify-content</td>
<td>决定 item 在主轴上的对齐方式</td>
<td>flex-start；flex-end；center；space-between 两端对齐；space-around 沿轴线均匀分布</td>
</tr>
<tr>
<td>align-items</td>
<td>决定 item 在交叉轴上的对齐方式</td>
<td>flex-start；flex-end；center；baseline；stretch 当 item 未设置高度时，item 将与容器等高度</td>
</tr>
<tr>
<td>align-content</td>
<td>决定多行 item 的对齐方式</td>
<td>flex-start；flex-end；center；space-between；space-around；stretch</td>
</tr>
</tbody>
</table>
<p>flex 项目包含如下属性：</p>
<table>
<thead>
<tr>
<th>属性名称</th>
<th>意义</th>
<th>可选值</th>
</tr>
</thead>
<tbody>
<tr>
<td>order</td>
<td>决定 item 排列顺序，默认值为 0</td>
<td>-</td>
</tr>
<tr>
<td>flex-grow</td>
<td>决定 item 放大比例，默认值为 0</td>
<td>-</td>
</tr>
<tr>
<td>flex-shrink</td>
<td>决定 item 缩小比例，默认值为 1</td>
<td>-</td>
</tr>
<tr>
<td>flex-basis</td>
<td>决定 item 在主轴上占据的空间，默认值为 auto</td>
<td>-</td>
</tr>
<tr>
<td>align-self</td>
<td>决定 item 在交叉轴上的对齐方式</td>
<td>auto；flex-start；flex-end；center；baseline；stretch</td>
</tr>
</tbody>
</table>
<p>关于 flex 布局，可参考 <a href="https://www.cnblogs.com/nuannuan7362/p/5823381.html" target="_blank" rel="noopener">flex弹性布局学习总结</a>。</p>
<h3 id="媒体查询"><a href="#媒体查询" class="headerlink" title="媒体查询"></a>媒体查询</h3><p>媒体查询可以定义在 css 中，也可以定义在 link 元素的 media 属性内。后一种方法始终会加载 css 样式，通过 media 属性决定是否应用 css 样式。</p>
<p>媒体查询可使用如下属性，并可加以 min- 或 max- 前缀：</p>
<ul>
<li>width：视口的宽度。</li>
<li>height：视口的高度。</li>
<li>aspect-ratio：视口的宽高比。</li>
<li>orientation：设备横竖屏，值为 portrait 或 landscape。</li>
<li>resolution：设备分辨率，值可以是每英寸 dpi 或每厘米 dpcm。</li>
</ul>
<p>媒体查询以 @media 起始；以 not 为逻辑非，’,’ 号为逻辑或。@media 后可使用不同的媒体类型或媒体属性。媒体类型包含：all 所有媒体类型；print 打印设备；screen 显示器；speech 辅助设备。</p>
<h3 id="rem"><a href="#rem" class="headerlink" title="rem"></a>rem</h3><p>css 中的计量单位有 px, pt, em, rem 等。em 相对当前元素的字体大小；rem 相对根元素的字体大小。使用 rem 制作响应式页面，先须根据屏幕大小调整切换根元素的字体大小。关于如何动态调整根元素的字体大小，可参考 <a href="https://github.com/amfe/lib-flexible" target="_blank" rel="noopener">lib-flexible</a>。</p>
<h3 id="多列布局"><a href="#多列布局" class="headerlink" title="多列布局"></a>多列布局</h3><p>在 css3 中，文本可采用多列布局，其中施以影响的样式有：</p>
<ul>
<li>column-count：设定列数。</li>
<li>column-width：设定列宽度。</li>
<li>column-gap：设定列间距。</li>
<li>column-rule：设定列间距的样式规则。</li>
</ul>
<h2 id="动效"><a href="#动效" class="headerlink" title="动效"></a>动效</h2><h3 id="transform-转换"><a href="#transform-转换" class="headerlink" title="transform 转换"></a>transform 转换</h3><ul>
<li>translate(x, y)：平移。</li>
<li>translate3d(x, y, z)：平移。</li>
<li>translateX(x)：平移。</li>
<li>translateY(y)：平移。</li>
<li>translateZ(z)：平移。</li>
<li>scale(x, y)：缩放。</li>
<li>scale3d(x, y, z)：缩放。</li>
<li>scaleX(x)：缩放。</li>
<li>scaleY(y)：缩放。</li>
<li>scaleZ(z)：缩放。</li>
<li>rotate(angle)：旋转。</li>
<li>rotate3d(x, y, z, angle)：旋转。</li>
<li>rotateX(angle)：旋转。</li>
<li>rotateY(angle)：旋转。</li>
<li>rotateZ(angle)：旋转。</li>
<li>skew(x-angle, y-angle)：倾斜变形。</li>
<li>skewX(angle)：倾斜变形。</li>
<li>skewY(angle)：倾斜变形。</li>
<li>matrix(n, n, n, n, n, n)：自定义转换。</li>
<li>matrix3d(n, n, n, n, n, n, n, n, n, n, n, n, n, n, n, n)：自定义转换。</li>
<li>prespective(n)：透视图。</li>
</ul>
<h3 id="transition-过渡"><a href="#transition-过渡" class="headerlink" title="transition 过渡"></a>transition 过渡</h3><p>transition 在指定 css 属性发生变化时，开始执行动效。它的格式以及包含的属性如下：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">transition</span>: <span class="selector-tag">transition-property</span> <span class="selector-tag">transition-duration</span> <span class="selector-tag">transition-timing-function</span> <span class="selector-tag">transition-delay</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>transition-property：指定将发生变化的 css 属性。</li>
<li>transition-duration：指定动效执行的时长。</li>
<li>transition-timing-function：指定动效的速度曲线。可能的值包含：linea 以相同的速度执行动效，等同于贝济埃曲线（0.0, 0.0, 1.0, 1.0）；ease 以逐渐变慢的速度执行动效，等同于贝济埃曲线（0.25, 1.0, 0.25, 1.0）；ease-in 以慢速开始执行动效，等同于贝济埃曲线（0.42, 0.0, 1.0, 1.0）；ease-out 以慢速结束执行动效，等同于贝济埃曲线（0.0, 0.0, 0.58, 1.0）；ease-in-out 以慢速开始并结束执行动效，等同于贝济埃曲线（0.42, 0.0, 0.58, 1.0）；cubic-bezier(n, n, n, n) 自定义时间曲线，即自定义贝济埃曲线。</li>
<li>transition-delay：指定动效的延迟时间。</li>
</ul>
<h3 id="animation-动画"><a href="#animation-动画" class="headerlink" title="animation 动画"></a>animation 动画</h3><p>animation 适用于块状和内联元素。它的格式以及包含的属性如下：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-tag">animation</span>: <span class="selector-tag">animation-name</span> <span class="selector-tag">animation-duration</span> <span class="selector-tag">animation-timing-function</span> <span class="selector-tag">animation-delay</span> <span class="selector-tag">animation-iteration-count</span> <span class="selector-tag">animation-direction</span>;</span><br></pre></td></tr></table></figure>
<ul>
<li>animation-name：值可以为 @keyframes 创建的动画名称，默认值为 none，即不会有任何动画效果。</li>
<li>animation-duration：动画播放时长。</li>
<li>animation-timing-function：指定动画的速度曲线，值可以是 linea, ease, ease-in, ease-out, ease-in-out, cubic-bezier(n, n, n, n)。</li>
<li>animation-delay：动画的延迟时间。</li>
<li>animation-iteration-count：动画的播放次数。</li>
<li>animation-direction：动画的播放方向，默认值为 normal。当指定为 alternate 时，偶数次向前播放，奇数次向后播放。</li>
</ul>
<h2 id="常用特性"><a href="#常用特性" class="headerlink" title="常用特性"></a>常用特性</h2><h3 id="开放字体格式-WOFF"><a href="#开放字体格式-WOFF" class="headerlink" title="开放字体格式 WOFF"></a>开放字体格式 WOFF</h3><p>通过 css3 中的 @font-face 可使用开放字体格式（Web Open Font Format，简称 WOFF）。@font-face 规则如下：</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@<span class="keyword">font-face</span> &#123;</span><br><span class="line">  <span class="attribute">font-family</span>: &lt;开放字体格式名&gt;;</span><br><span class="line">  <span class="attribute">src</span>: &lt;字体路径&gt; [&lt;字体格式&gt;] [,&lt;字体路径&gt; [&lt;字体格式&gt;]] *;</span><br><span class="line">  [font-weight: &lt;字体粗细&gt;]; </span><br><span class="line">  <span class="selector-attr">[font-style: &lt;字体样式&gt;]</span>; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">@<span class="keyword">font-face</span> &#123;</span><br><span class="line">  <span class="attribute">font-family</span>: <span class="string">'fontello'</span>;</span><br><span class="line">  <span class="attribute">src</span>: <span class="built_in">url</span>(<span class="string">'./font/fontello.eot?69798120'</span>);</span><br><span class="line">  <span class="attribute">src</span>: <span class="built_in">url</span>(<span class="string">'./font/fontello.eot?69798120#iefix'</span>) <span class="built_in">format</span>(<span class="string">'embedded-open-type'</span>),</span><br><span class="line">    <span class="built_in">url</span>(<span class="string">'./font/fontello.woff?69798120'</span>) <span class="built_in">format</span>(<span class="string">'woff'</span>),</span><br><span class="line">    <span class="built_in">url</span>(<span class="string">'./font/fontello.tff?69798120'</span>) <span class="built_in">format</span>(<span class="string">'truetype'</span>),</span><br><span class="line">    <span class="built_in">url</span>(<span class="string">'./font/fontello.svg?69798120#fontello'</span>) <span class="built_in">format</span>(<span class="string">'svg'</span>);</span><br><span class="line">  <span class="attribute">font-weight</span>: normal; </span><br><span class="line">  <span class="attribute">font-style</span>: normal; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>字体格式包含如下值：</p>
<ul>
<li>.tff：TrueType 格式，是 windows, mac 上常见的字体。</li>
<li>.otf: OpenType 格式，一种原始的字体。</li>
<li>.woff: Web Open Font Format 格式，Web 字体中最佳格式，TrueType/OpenType 格式的压缩版。</li>
<li>.eot：Embedded Open Type 格式，可以从 TrueType 创建此格式的字体，IE 专用格式，支持此字体的浏览器有 IE4+。</li>
<li>.svg：SVG 格式。</li>
</ul>
<p>@font-face 可用于加载字体图标 IconFont。字体图标可参考 <a href="https://www.cnblogs.com/hjvsdr/p/6639649.html" target="_blank" rel="noopener">iconfont字体图标的使用方法–超简单!</a>。</p>
<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><ul>
<li>background-color：指定背景色。</li>
<li>background-position：指定背景图像的位置。</li>
<li>background-size：指定背景图像的尺寸，值可以指定背景的宽度和高度，也可以是 cover 使背景图像覆盖背景区域，超出部分将会裁剪, contain 使背景图像适应背景区域。</li>
<li>background-repeat：指定是否重复背景图像。</li>
<li>background-origin：指定背景的定位区域，值可以是 padding, padding-box, border, border-box, content, content-box，即从内边距或外边距开始。</li>
<li>background-clip：指定背景的绘制区域，指定区域将被裁剪，值可以是 border-box, padding-box, content-box。</li>
<li>background-attachment：指定背景图像是否固定或者随着页面的其余部分滚动。</li>
<li>background-image：指定背景图像。</li>
</ul>
<h3 id="颜色"><a href="#颜色" class="headerlink" title="颜色"></a>颜色</h3><p>颜色取值可以指定颜色名称，如 black；或 HEX 以十六进制表示颜色，如 #000000；或 RGB 记法，如 rgb(0, 0, 0)；或 RGBA 记法，alpha 为透明度，如 rgba(0, 0, 0, 0.5)；或 HSL 记法，如 hsl(360, 50%, 50%)；或 HSLA 记法，如 hsla(360, 50%, 50%, 0.5)；或 transparent 全透明色彩；或 currentcolor 当前标签继承的文字颜色。</p>
<p>颜色也可以设置渐变。linear-gradient 线性渐变，如 linear-gradient(direction, color-stop1, color-stop2, …)；或 radial-gradient 径向渐变，如 radial-gradient(position, shape size, start-color, …, last-color)。</p>
<p>也可以使用 opacity 指定透明度。</p>
<h3 id="文字效果"><a href="#文字效果" class="headerlink" title="文字效果"></a>文字效果</h3><ul>
<li>text-shadow：字体阴影，格式如 text-shadow: h-shadow v-shadow blur color。其中，h-shadow 为水平阴影的位置；v-shadow 为垂直阴影的位置；blur 模糊的距离；color 阴影的颜色。</li>
<li>text-overflow：指定文本溢出的处理方式。值可以是 clip 裁剪；ellipsis 省略号显示；string 指定字符串替代被裁剪的文本。</li>
<li>word-wrap：指定长单词或 url 地址是否自动换行，值可以是 normal, break-word。normal 在允许的断字点换行；break-word 在长单词或 url 地址内部进行换行。</li>
<li>word-break：指定自动换行的处理方式，值可以是 normal, break-all, keep-all。normal 默认的换行方式；break-all 允许在单次内换行；keep-all 只能在半角空格或连字符处换行。</li>
</ul>
<h3 id="边框"><a href="#边框" class="headerlink" title="边框"></a>边框</h3><ul>
<li>border-width：指定边框的宽度。</li>
<li>border-style：指定边框样式。</li>
<li>border-color：指定边框颜色。</li>
<li>border-radius：指定圆角边框。</li>
<li>border-image：指定边框背景图像。</li>
<li>box-shadow：指定边框阴影。格式如 box-shadow: h-shadow v-shadow blur spread color inset。</li>
</ul>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>box-sizing：盒模式。<br>calc：函数计算样式。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/03/读书笔记/移动Web高效开发实践/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/03/读书笔记/移动Web高效开发实践/" itemprop="url">移动Web高效开发实践</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-03T00:00:00+08:00">2019-02-03</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/读书笔记/" itemprop="url" rel="index"><span itemprop="name">读书笔记</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/02/03/读书笔记/移动Web高效开发实践/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/02/03/读书笔记/移动Web高效开发实践/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>本文档主要用于汇总待整理的问题点，后续将以文章形式逐条剖析。</p>
<h2 id="开发环境或工具"><a href="#开发环境或工具" class="headerlink" title="开发环境或工具"></a>开发环境或工具</h2><ul>
<li>NProxy：web 代理工具，参考 <a href="http://www.cnblogs.com/wenber/p/3893308.html" target="_blank" rel="noopener">前端调试利器—nproxy</a>。</li>
<li>http-server：搭建 http 服务器，参考 <a href="https://www.cnblogs.com/Janejxt/p/9394989.html" target="_blank" rel="noopener">本地搭建http-server服务器</a>。</li>
<li>caniuse：查询浏览器对样式的支持度。</li>
<li>modernizr：嵌入脚本，检测浏览器对样式或特征的支持度。</li>
</ul>
<h2 id="html5"><a href="#html5" class="headerlink" title="html5"></a>html5</h2><ul>
<li>布局元素：Header, Nav, Article, Section, Aside, Footer。</li>
<li>input[type=?]：search, tel, url, email, date, color, number, range, datetime, month, week。</li>
<li>input[?=]：required, pattern, autofocus, form, placeholder。</li>
<li>新元素：progress 进度条, meter 标尺。</li>
<li>新属性：contenteditable 使元素可编辑。</li>
<li>audio 音频、video 视频：包含 controls 展示默认控件, autoplay, loop 循环播放, preload 预加载, volumn 音量属性，通过 source 元素加载音频、视频；可以用 api 形式操作音频。</li>
<li>navigator.geolocation.getCurrentPosition(success, error, options)：获取当前地理位置。</li>
<li>navigator.mediaDevices.getUserMedia(contraints).then(success).catch(error)：调用摄像头拍照，success 回调的参数 stream 可通过 window.URL.createObjectURL(stream) 赋值给 video 元素的 src 属性。</li>
<li>deviceorientation 事件：可监听设备旋转角度的变化，绕上下坐标旋转称为 alpha 弧度，绕左右坐标称为 beta，绕前后坐标旋转称为 gamma。</li>
<li>devicemotion 事件：可监听设备移动的距离以及旋转角度的变化。</li>
<li>离线存储：以 ‘.mainfest’ 或 ‘.appcache’ 描述文件设定待存储的资源目录，html 指定 mainfest 属性关联该描述文件，这样可以在断网状态下加载本地缓存的资源。结合 LocalStorage，可以缓存本地用户填写的数据。除此之外，service worker 可以用指定的方式加载本地缓存。关于 service worker，可参考 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/Service_Worker_API" target="_blank" rel="noopener">Service Worker API</a>, <a href="https://www.jianshu.com/p/0e2dee4c77bc" target="_blank" rel="noopener">构建 Web 应用之 Service Worker 初探</a>, <a href="https://www.cnblogs.com/dojo-lzz/p/8047336.html" target="_blank" rel="noopener">Web离线应用解决方案——ServiceWorker</a>。</li>
<li>LocalStorage, SessionStorage：本地存储。</li>
<li>IndexedDB：浏览器本地的结构化数据库，使用 new LocalDB(dbName, tableName) 创建。</li>
<li>Canvas 画布。</li>
<li>SVG 矢量图。</li>
<li>WebGL 三维图像。渲染引擎可参考 <a href="https://github.com/pixijs/pixi.js" target="_blank" rel="noopener">pixi.js</a>。</li>
<li>window.postMessage(message, target, [transfer])：跨域传送。</li>
<li>xhr2：添加 ontimeout, onprogress 方法，可传送 FormData 数据。</li>
<li>EventSource：创建 EventSource 对象接受服务端主动推送的消息。</li>
<li>WebSocket 全双工通信。</li>
<li>WebRTC 实时通信。</li>
<li>drag, drop 拖拽。</li>
<li><a href="http://xzfyu.com/2019/01/27/history%E6%BA%90%E7%A0%81/" target="_blank" rel="noopener">history api</a>。</li>
<li>web workers 多线程。</li>
<li>performance api 网站性能。</li>
<li>microdata：参考 <a href="https://lepture.com/zh/2015/fe-microdata" target="_blank" rel="noopener">前端的基礎修養：Microdata</a>。</li>
</ul>
<h2 id="css"><a href="#css" class="headerlink" title="css"></a>css</h2><p>参考 <a href="http://xzfyu.com/2019/02/08/css/css%20%E6%80%BB%E6%B1%87/" target="_blank" rel="noopener">css 总汇</a>。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/01/antd/react-component/dom-align/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/01/antd/react-component/dom-align/" itemprop="url">dom-align</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-01T00:00:00+08:00">2019-02-01</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/antd-组件库/" itemprop="url" rel="index"><span itemprop="name">antd 组件库</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/02/01/antd/react-component/dom-align/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/02/01/antd/react-component/dom-align/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="工具函数"><a href="#工具函数" class="headerlink" title="工具函数"></a>工具函数</h2><ul>
<li>utils.getWindow(node): 获取 node 节点所属的 window 对象。</li>
<li>utils.getDocument(node): 获取 node 节点所属的 document 对象。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/02/01/antd/react-component/rc-align/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/02/01/antd/react-component/rc-align/" itemprop="url">rc-align</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-02-01T00:00:00+08:00">2019-02-01</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/antd-组件库/" itemprop="url" rel="index"><span itemprop="name">antd 组件库</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/02/01/antd/react-component/rc-align/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/02/01/antd/react-component/rc-align/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="dom-align"><a href="#dom-align" class="headerlink" title="dom-align"></a>dom-align</h2><h3 id="工具函数"><a href="#工具函数" class="headerlink" title="工具函数"></a>工具函数</h3><ul>
<li>utils.getWindow(node): 获取 node 节点所属的 window 对象。</li>
<li><p>utils.getDocument(node): 获取 node 节点所属的 document 对象。</p>
</li>
<li><p>isAncestorFixed(element): 判断祖先元素是否固定定位。</p>
</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/31/react/react相关/react-router源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/31/react/react相关/react-router源码分析/" itemprop="url">react-router</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-31T00:00:00+08:00">2019-01-31</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端路由/" itemprop="url" rel="index"><span itemprop="name">前端路由</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/01/31/react/react相关/react-router源码分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/01/31/react/react相关/react-router源码分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="react-router"><a href="#react-router" class="headerlink" title="react-router"></a>react-router</h2><p>基于 <a href="http://xzfyu.com/2019/01/27/history%E6%BA%90%E7%A0%81/" target="_blank" rel="noopener">history</a> 创建的 history 对象、以及 <a href="https://github.com/jamiebuilds/create-react-context" target="_blank" rel="noopener">create-react-context</a> 为上下游组件传递 context 数据，上游的 Router 组件用于监听地址栏的变更，随后将 history 对象以及当前的 state.location 信息写入 context；下游的 Route 组件通过工具函数 matchPath 判断 location.pathname 是否匹配 props.path，以此渲染出内容。</p>
<p>在这种机制下，存在两个问题：如果 location.pathname 与多个 Route 匹配时，react-router 将会渲染出这几个 Route 的内容；如果嵌套使用的 Route 元素均需要与 location.pathname 当前的地址栏信息加以比较的话，那么这个 Route 元素的 props.path 属性也需要感知父 Route 元素的 props.path 信息。针对第一个问题，react-router 提供了 Switch 组件。借助 Switch 组件，react-router 将只渲染首个匹配的 Route 元素，且为子组件注入 props.computedMatch 属性（以避免 matchPath 的多次调用）。针对第二个问题，react-router 通过 Switch 组件或父 Route 组件向子组件注入 props.match 属性，再通过 match.path 设置子 Route 的 props.path 属性（参见 <a href="https://reacttraining.com/react-router/web/example/basic" target="_blank" rel="noopener">basic 示例</a>）。</p>
<p>除了改变子组件的 props.match 属性外，Switch 和 Route 组件均能改变子组件的 props.location 属性。react-router 以 <a href="https://reacttraining.com/react-router/web/example/animated-transitions" target="_blank" rel="noopener">Animated Transitions 示例</a> 指出 props.location 属性可应用于动效渲染场景。在示例中，react-router 使用指定 location 属性的 Switch 组件包裹前后两个页面级渲染内容，再经由指定 key 键为 location.key 的 CSSTransition 组件包裹（指定 key 键是为了在 CSSTransition 组件重绘期间，使该组件一前一后、卸载再挂载的机制切合视图上的移入移出动效），而后统一由 TransitionGroup 组件管理 CSSTransition 组件的动效切换过程。这样就可以实现：在地址栏变更过程中，前一个 CSSTransition 组件同步驻留，执行完隐藏动效后再移出；后一个 CSSTransition 组件执行完显示动效后再移入。</p>
<p>顺带指出的是，因为 Route 或 Switch 组件都可以指定动态的 props.location 属性，那就可以设想如下的黑魔法：自定义的、且与历史堆栈无甚关联的动态 location 属性将主导子 Route 的渲染状态。当然，这一黑魔法并不规范，理应避免使用。</p>
<p>在 Router 之外，react-router 还提供 MemoryRouter, StaticRouter 组件。MemoryRouter 组件可根据虚拟的缓存历史堆栈控制子 Route 的渲染状态，适用于测试或 native 环境。StaticRouter 组件适用于服务端渲染：react-router 会根据地址栏渲染出指定的内容，因此可以在 node 端设定 controller 对不同的前端路由统一发送 html 内容（通过 ReactDOMServer.renderToString 获得指定路由的 html 内容）；但是当地址栏与前端路由不匹配时，我们需要跳转到 404 页面，react-router 就会通过 StaticRouter 组件的机制在 ReactDOMServer.renderToString 方法执行期间，使用 content 引用对象收集待 404 页面地址，然后在 node 端进行重定向。引用对象 content 收集数据的方式有两种：第一种在虚拟跳转页面环节（为此，react-router 为 StaticRouter 组件提供了特定的 push, replace 方法实现）；第二种在待渲染页面 render 期间对 content 属性进行赋值。当然，这两种收集方式都在 ReactDOMServer.renderToString 方法执行期间完成。以上机制，可参考官方的 <a href="https://reacttraining.com/react-router/web/guides/server-rendering" target="_blank" rel="noopener">Server Rendering 示例</a>。</p>
<p>上一个段落的 ReactDOMServer.renderToString 方法执行期间，前端代码会虚拟地重定向到 404 页面；node 端再通过 context 感知到这一虚拟重定向过程，然后再发起真实的重定向。在这个过程中，虚拟重定向是由 Redirect 组件完成的。在 react-router4 中，Redirect 组件的机制就是在组件的生命周期中跳转页面、或者在渲染期间改变 context 的属性（服务端渲染时，将待跳转页面上报给 node 服务器），并无其他内容。因此，如果不需要重定向，就需要条件语句控制 Redirect 组件的渲染。参考 <a href="https://reacttraining.com/react-router/web/example/auth-workflow" target="_blank" rel="noopener">Redirects (Auth) 示例</a>。</p>
<p>在 Redirect 组件之外，借助 history 库封装的 block 方法，Prompt 组件用于拦截地址栏的变更，如默认会使用 window.confirm 提醒用户是否要进行跳转。Prompt 组件按两种条件决定是否需要对用户进行提示，其一是 props.when 属性，当其为真值进入条件二（因此可以将 state 状态赋值给 props.when 以设定条件）；其二是 props.message 属性，即 history 库中的 prompt，该值可以为函数，允许开发者根据待变更地址的 location, action 动态加以判断，是否需要提示用户。</p>
<p>我们用下图表示上文中组件的层级关系（虚线表示可有无可）：<br><img src="/2019/01/31/react/react相关/react-router源码分析/react-router层级关系.png"></p>
<p>以下列表简要概括各组价的输出能力和特点：</p>
<ul>
<li>StaticRouter: 服务器端渲染时，配合收集跳转页面地址并完成服务器端重定向。</li>
<li>MemoryRouter: native 环境使用虚拟历史堆栈实现前端路由。</li>
<li>Router: 将真实或虚拟的路由信息注入到子组件中，以控制 Route 内容的渲染。</li>
<li>Switch: 控制渲染首个匹配路由信息的 Route 内容。</li>
<li>Route: 设定单个路由规则，匹配时渲染内容。渲染内容可以是 children, Component, render 懒加载。其中，children 可以 React 元素，或 render props 形式。</li>
<li>Render: 作为 Route 下的渲染内容。</li>
<li>Redirect: 渲染时即重定向。</li>
<li>Prompt: 拦截地址栏变更。</li>
</ul>
<h3 id="RouterContext"><a href="#RouterContext" class="headerlink" title="__RouterContext"></a>__RouterContext</h3><p>基于 <a href="https://github.com/jamiebuilds/create-react-context" target="_blank" rel="noopener">create-react-context</a>，__RouterContext 用于为上下游组件传递 context。</p>
<h3 id="withRouter"><a href="#withRouter" class="headerlink" title="withRouter"></a>withRouter</h3><p>withRouter 装饰器将构造 HOC 组件，用于将 context 内容注入到子组件的 props 中。并且，HOC 组件基于 <a href="https://github.com/mridgway/hoist-non-react-statics" target="_blank" rel="noopener">hoist-non-react-statics</a>，拷贝了原始组件的非 react 类静态属性或方法。</p>
<h3 id="工具函数"><a href="#工具函数" class="headerlink" title="工具函数"></a>工具函数</h3><ul>
<li>Lifecycle: 生命周期方法管理组件。</li>
<li>generatePath(path, params): 基于 <a href="https://github.com/pillarjs/path-to-regexp" target="_blank" rel="noopener">path-to-regexp</a>，将路径规则 path 和路由参数 params 解析为实际的路径。实现上，根据路径规则的解析函数会以对象形式缓存在内存中。</li>
<li>matchPath(pathname, { path, exact, strict, sensitive }): 基于 <a href="https://github.com/pillarjs/path-to-regexp" target="_blank" rel="noopener">path-to-regexp</a>，将实际路径 pathname 解析为 { path, url, isExact, params } 形式。其中，path 为路径规则；url 为匹配的路径内容；isExact 指实际路径 path 和路径规则 pathname 是否相等；params 为路由参数。</li>
</ul>
<h2 id="react-router-config"><a href="#react-router-config" class="headerlink" title="react-router-config"></a>react-router-config</h2><p>react-router-config 输出如下两个工具函数：</p>
<ul>
<li>matchRoutes(routes, pathname): 从类树形结构的路由中获取当前匹配的路由节点分叉。主要针对 react-router4 没有在全局层面缓存全量的路由配置信息，路由配置散落在 Route 组件中。</li>
<li>renderRoutes(routes, extraProps, switchProps): 使用 Switch, Route 组件渲染单层结构的数组路由 routes。</li>
</ul>
<h2 id="react-router-dom"><a href="#react-router-dom" class="headerlink" title="react-router-dom"></a>react-router-dom</h2><p>基于 react-router 包，react-router-dom 针对浏览器环境提供了如下组件：</p>
<ul>
<li>BrowserRouter: 使用 history 库输出的 createBrowserHistory，构建前端路由。</li>
<li>HashRouter: 使用 history 库输出的 createBrowserHistory, 构建 hash 路由。</li>
<li>Link: 基于 __RouterContext，绘制 a 标签跳转链接。在配置 props.onClick 方法的情景中，可以采用采用浏览器机制跳转。</li>
<li>NavLink: 根据路由匹配情况，为 Link 元素设置特殊的样式。</li>
</ul>
<h2 id="react-router-native"><a href="#react-router-native" class="headerlink" title="react-router-native"></a>react-router-native</h2><p>基于 react-router 包，react-router-dom 针对 native 环境提供了如下组件：</p>
<ul>
<li>NativeRouter: 基于 MemoryRouter 组件，构建前端路由。默认的 props.getUserConfirmation 方法通过 react-native 输出的 Alert 实现。</li>
<li>BackButton: 基于 react-native 输出的 BackHandler 绑定 hardwareBackPress 事件，实现点击 back 按钮回退页面的功能。</li>
<li>Link: 通过为 props.Component 组件绑定 onPress 事件并渲染，实现页面跳转。</li>
<li>DeepLinking: 基于 react-native 输出的 Linking 绑定 url 事件，以使 Linking.openURL 调用过程中移除参数 url 中 ‘://‘ 及其前的内容。关于深度链接，可参看 <a href="https://www.jianshu.com/p/117a2cd510a6" target="_blank" rel="noopener">浅析移动应用深度链接 (Deeplinking)</a>， <a href="https://facebook.github.io/react-native/docs/linking.html" target="_blank" rel="noopener">Linking</a>。</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>本文的写作基于反向演绎，缺少遇到问题时正向推理的顺畅感，又介于笔者水平有限，文中难免谬误，仍望海涵。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/27/react/react相关/history源码/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/01/27/react/react相关/history源码/" itemprop="url">history</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-27T00:00:00+08:00">2019-01-27</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端路由/" itemprop="url" rel="index"><span itemprop="name">前端路由</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/01/27/react/react相关/history源码/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/01/27/react/react相关/history源码/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>history 库基于 html5 的 history 接口，用于操控和观察浏览器地址栏的变更。本文分为两部分：介绍 html5 的 history 接口；再介绍 history 库的实现。</p>
<h2 id="history-接口"><a href="#history-接口" class="headerlink" title="history 接口"></a>history 接口</h2><p>为实现浏览器地址栏变更，又不至使页面刷新，html 提供了 history.pushState(state, title, url) 方法。该方法结合 ajax 请求一起使用，就可以实现地址栏变更时的局部刷新。实现详情可参阅 <a href="http://diveintohtml5.info/history.html" target="_blank" rel="noopener">MANIPULATING HISTORY FOR FUN &amp; PROFIT</a> 这篇文章。同时，这篇文章也指出，若想保证回退按钮也实现局部刷新，须监听 popstate 事件。以下整理的是 mozilla 开列的 <a href="https://developer.mozilla.org/zh-CN/docs/Web/API/History" target="_blank" rel="noopener">history 文档</a>。</p>
<ul>
<li>history.length: 存储在回话历史堆栈中的元素数量。</li>
<li>history.state: 获取栈顶——历史堆栈入口的状态值。</li>
<li>history.back(): 前往上一页，浏览器的回退按钮可以模拟此方法。</li>
<li>history.forward(): 前往下一页，浏览器的前进按钮可以模拟此方法。</li>
<li>history.go(num): 前往历史堆栈中的指定页面。</li>
<li>history.pushState(state, title, url): 将数据压入历史堆栈中。state 数据量须小于 640kb，firefox 会将其保存到本地磁盘中。firefox 也会忽略 title 参数。这一过程将触发 popstate 事件，但不会触发 hashchange 事件。</li>
<li>history.replaceState(state, title, url): 替换历史堆栈入口的数据。</li>
<li>popstate: 当历史堆栈入口数据变更时，均会触发 popstate 事件，包含调用 history.back, history.forward, history.go 方法，以及点击前进、回退按钮。history.pushState, history.replaceState 方法不会触发 popstate 事件。</li>
<li>window.onpopstate = (event) =&gt; {}; window.addEventListener(‘popstate’, (event) =&gt; {}): 监听 popstate 事件。</li>
<li>hashchange: hash 路径变更，将会触发 hashchange 事件。</li>
<li>window.onhashchange = (event) =&gt; {}; window.addEventListener(‘hashchange’, (event) =&gt; {}): 监听 hashchange 事件。</li>
</ul>
<h2 id="history-库"><a href="#history-库" class="headerlink" title="history 库"></a>history 库</h2><p>history 库创建了一个虚拟的 history 对象，以操纵浏览器地址栏的变更（createBrowserHistory）、或者操纵 hash 路径的变更（createHashHistory）、或者管理内存中的虚拟历史堆栈（createMemoryHistory）。各 history 对象均含有如下属性或方法：</p>
<ul>
<li>push(path, state): 往历史堆栈中压入数据。</li>
<li>replace(path, state): 变更历史堆栈入口数据。</li>
<li>go, goBack, goForward: 根据历史堆栈信息进行跳页。</li>
<li>block(prompt): 根据条件 prompt 阻断地址栏变更。</li>
<li>listen((location, action) =&gt; {}): 监听地址栏变更。</li>
<li>length: 历史堆栈中的数据量。</li>
<li>action: history 前次执行的方法名，值包含 ‘POP’, ‘PUSH’, ‘REPLACE’。</li>
<li>location: 历史堆栈入口的数据内容，数据结构为 { pathname, search, hash, key, state }，通过 LocationUtils.createLocation 创建。</li>
</ul>
<p>监听函数 listener 会在地址栏变更后予以执行。实现上，history 先收集历史堆栈入口的变更数据，并写入虚拟的 history 对象中，然后再执行 listener。这一过程表现为 createBrowserHistory, createHashHistory, createMemoryHistory 模块中的 setState 函数。因此，通过 pushState, replaceState, go 方法，或者通过对 location 对象赋值变更地址栏后，就可以调用 setState 执行监听函数了。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setState</span>(<span class="params">nextState</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">Object</span>.assign(history, nextState);</span><br><span class="line">  history.length = globalHistory.length;</span><br><span class="line">  transitionManager.notifyListeners(history.location, history.action);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>history 有两种阻断地址栏变更的方法：在变更前拦截；在变更后回滚。相对于变更地址栏的三种方式：对 location 对象直接赋值，或者调用 pushState, replaceState 方法，或者调用 go 方法。前两种方法，我们都知道地址栏将要变更为何值，因此 history 选择在变更前拦截；后一种方法，我们不知道地址栏将会变更为何值，因此 history 选择在变更后回滚。实现上，history 使用 transitionManager.confirmTransitionTo 包裹前两种方法的调用过程；通过监听 popstate, hashchange 事件获得变更后的 location 数据，同样使用 transitionManager.confirmTransitionTo 判断是否需要回滚，还是维持现状。回滚机制的典型实现如 createBrowserHistory, createHashHistory 模块中的 handlePop 函数等。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 回滚到前几页时，跳过回滚机制</span></span><br><span class="line"><span class="keyword">let</span> forceNextPop = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handlePop</span>(<span class="params">location</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (forceNextPop) &#123;</span><br><span class="line">    forceNextPop = <span class="literal">false</span>;</span><br><span class="line">    setState();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> action = <span class="string">'POP'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 通过 prompt 判断是否需要回滚</span></span><br><span class="line">    transitionManager.confirmTransitionTo(</span><br><span class="line">      location,</span><br><span class="line">      action,</span><br><span class="line">      getUserConfirmation,</span><br><span class="line">      ok =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (ok) &#123;</span><br><span class="line">          <span class="comment">// 维持现状</span></span><br><span class="line">          setState(&#123; action, location &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// 回滚</span></span><br><span class="line">          revertPop(location);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">revertPop</span>(<span class="params">fromLocation</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> toLocation = history.location;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> We could probably make this more reliable by</span></span><br><span class="line">  <span class="comment">// keeping a list of keys we've seen in sessionStorage.</span></span><br><span class="line">  <span class="comment">// Instead, we just default to 0 for keys we don't know.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// allKeys 缓存历史堆栈中的数据标识</span></span><br><span class="line">  <span class="keyword">let</span> toIndex = allKeys.indexOf(toLocation.key);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (toIndex === <span class="number">-1</span>) toIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> fromIndex = allKeys.indexOf(fromLocation.key);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fromIndex === <span class="number">-1</span>) fromIndex = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> delta = toIndex - fromIndex;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (delta) &#123;</span><br><span class="line">    forceNextPop = <span class="literal">true</span>;</span><br><span class="line">    go(delta);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>transitionManager 由 createTransitionManager 模块创建，提供了如下四种方法：</p>
<ul>
<li>appendListener(fn)：添加 fn 监听函数，返回函数可用于移除添加的监听函数。</li>
<li>notifyListeners(…args)：执行所有已添加的监听函数。</li>
<li>setPrompt(nextPrompt)：字符串时为提示；函数形式 (location, action) =&gt; {} 既可用于判断变更条件是否达成，或者输出提示文案；布尔值作为变更条件判断的结果。</li>
<li>confirmTransitionTo(location, action, getUserConfirmation, callback)：变更地址栏时，通过 prompt 判断变更条件是否达成或者获取提示文案；若取得提示文案，由 getUserConfirmation = (prompt, callback) =&gt; {} 设定 callback 的调用机制，否则以变更条件达成与否的状态值作为 callback 的参数，并执行 callback 回调。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">confirmTransitionTo</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  location,</span></span></span><br><span class="line"><span class="function"><span class="params">  action,</span></span></span><br><span class="line"><span class="function"><span class="params">  getUserConfirmation,</span></span></span><br><span class="line"><span class="function"><span class="params">  callback</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> If another transition starts while we're still confirming</span></span><br><span class="line">  <span class="comment">// the previous one, we may end up in a weird state. Figure out the</span></span><br><span class="line">  <span class="comment">// best way to handle this.</span></span><br><span class="line">  <span class="keyword">if</span> (prompt != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">const</span> result =</span><br><span class="line">      <span class="keyword">typeof</span> prompt === <span class="string">'function'</span> ? prompt(location, action) : prompt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> result === <span class="string">'string'</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> getUserConfirmation === <span class="string">'function'</span>) &#123;</span><br><span class="line">        getUserConfirmation(result, callback);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        warning(</span><br><span class="line">          <span class="literal">false</span>,</span><br><span class="line">          <span class="string">'A history needs a getUserConfirmation function in order to use a prompt message'</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        callback(<span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// Return false from a transition hook to cancel the transition.</span></span><br><span class="line">      callback(result !== <span class="literal">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    callback(<span class="literal">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>基于以上触发监听函数、阻断地址栏变更的机制，下面我们一一揭开 createBrowserHistory, createHashHistory, createMemoryHistory 模块的面纱。</p>
<h3 id="createBrowserHistory"><a href="#createBrowserHistory" class="headerlink" title="createBrowserHistory"></a>createBrowserHistory</h3><p>createBrowserHistory 基于 html5 中的 pushState, replaceState 变更地址栏。地址栏变更内容不限于 hash 路径。当浏览器不支持 html5 的 history 接口时，createBrowserHistory 将直接变更 location.href 或者调用 location.replace 方法实现地址栏变更。</p>
<p>首先，createBrowserHistory 接受 props 参数。其中，props.forceRefresh 设定以刷新页面的形式变更地址栏；getUserConfirmation 配合 browserHistory.block 方法，可根据地址栏变更信息决定是否允许本次变更；props.keyLength 决定每条历史数据标识符 key 键的长度；props.basename 设置地址栏变更的基本路径。</p>
<p>其次，实现 push, replace 方法，用于变更历史入口。在支持 html5 history 接口的浏览器中，createBrowserHistory 将调用 setState 方法监听函数的执行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">push</span>(<span class="params">path, state</span>) </span>&#123;</span><br><span class="line">  warning(</span><br><span class="line">    !(</span><br><span class="line">      <span class="keyword">typeof</span> path === <span class="string">'object'</span> &amp;&amp;</span><br><span class="line">      path.state !== <span class="literal">undefined</span> &amp;&amp;</span><br><span class="line">      state !== <span class="literal">undefined</span></span><br><span class="line">    ),</span><br><span class="line">    <span class="string">'You should avoid providing a 2nd state argument to push when the 1st '</span> +</span><br><span class="line">      <span class="string">'argument is a location-like object that already has state; it is ignored'</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> action = <span class="string">'PUSH'</span>;</span><br><span class="line">  <span class="keyword">const</span> location = createLocation(path, state, createKey(), history.location);</span><br><span class="line"></span><br><span class="line">  transitionManager.confirmTransitionTo(</span><br><span class="line">    location,</span><br><span class="line">    action,</span><br><span class="line">    getUserConfirmation,</span><br><span class="line">    ok =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (!ok) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> href = createHref(location);</span><br><span class="line">      <span class="keyword">const</span> &#123; key, state &#125; = location;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (canUseHistory) &#123;</span><br><span class="line">        globalHistory.pushState(&#123; key, state &#125;, <span class="literal">null</span>, href);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (forceRefresh) &#123;</span><br><span class="line">          <span class="built_in">window</span>.location.href = href;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> prevIndex = allKeys.indexOf(history.location.key);</span><br><span class="line">          <span class="keyword">const</span> nextKeys = allKeys.slice(</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            prevIndex === <span class="number">-1</span> ? <span class="number">0</span> : prevIndex + <span class="number">1</span></span><br><span class="line">          );</span><br><span class="line"></span><br><span class="line">          nextKeys.push(location.key);</span><br><span class="line">          allKeys = nextKeys;</span><br><span class="line"></span><br><span class="line">          setState(&#123; action, location &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        warning(</span><br><span class="line">          state === <span class="literal">undefined</span>,</span><br><span class="line">          <span class="string">'Browser history cannot push state in browsers that do not support HTML5 history'</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="built_in">window</span>.location.href = href;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">replace</span>(<span class="params">path, state</span>) </span>&#123;</span><br><span class="line">  warning(</span><br><span class="line">    !(</span><br><span class="line">      <span class="keyword">typeof</span> path === <span class="string">'object'</span> &amp;&amp;</span><br><span class="line">      path.state !== <span class="literal">undefined</span> &amp;&amp;</span><br><span class="line">      state !== <span class="literal">undefined</span></span><br><span class="line">    ),</span><br><span class="line">    <span class="string">'You should avoid providing a 2nd state argument to replace when the 1st '</span> +</span><br><span class="line">      <span class="string">'argument is a location-like object that already has state; it is ignored'</span></span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> action = <span class="string">'REPLACE'</span>;</span><br><span class="line">  <span class="keyword">const</span> location = createLocation(path, state, createKey(), history.location);</span><br><span class="line"></span><br><span class="line">  transitionManager.confirmTransitionTo(</span><br><span class="line">    location,</span><br><span class="line">    action,</span><br><span class="line">    getUserConfirmation,</span><br><span class="line">    ok =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (!ok) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> href = createHref(location);</span><br><span class="line">      <span class="keyword">const</span> &#123; key, state &#125; = location;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (canUseHistory) &#123;</span><br><span class="line">        globalHistory.replaceState(&#123; key, state &#125;, <span class="literal">null</span>, href);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (forceRefresh) &#123;</span><br><span class="line">          <span class="built_in">window</span>.location.replace(href);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> prevIndex = allKeys.indexOf(history.location.key);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (prevIndex !== <span class="number">-1</span>) allKeys[prevIndex] = location.key;</span><br><span class="line"></span><br><span class="line">          setState(&#123; action, location &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        warning(</span><br><span class="line">          state === <span class="literal">undefined</span>,</span><br><span class="line">          <span class="string">'Browser history cannot replace state in browsers that do not support HTML5 history'</span></span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line">        <span class="built_in">window</span>.location.replace(href);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其次，基于原生的 history 对象实现 go, goBack, goForward 方法。此种变更地址栏的方式可以触发 popstate 或 hashchange 事件。</p>
<p>最后，实现 block 方法阻断地址栏变更；listen 方法监听地址栏变更。两者都会绑定 popstate 或 hashchange 事件的回调函数。通过这两个事件判断本次变更是否需要回滚、以及触发 listener 监听函数的执行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 作为事件的绑定函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handlePopState</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Ignore extraneous popstate events in WebKit.</span></span><br><span class="line">  <span class="keyword">if</span> (isExtraneousPopstateEvent(event)) <span class="keyword">return</span>;</span><br><span class="line">  handlePop(getDOMLocation(event.state));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleHashChange</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  handlePop(getDOMLocation(getHistoryState()));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 绑定或清理事件的处理函数</span></span><br><span class="line"><span class="keyword">let</span> listenerCount = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkDOMListeners</span>(<span class="params">delta</span>) </span>&#123;</span><br><span class="line">  listenerCount += delta;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (listenerCount === <span class="number">1</span> &amp;&amp; delta === <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="built_in">window</span>.addEventListener(PopStateEvent, handlePopState);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (needsHashChangeListener)</span><br><span class="line">      <span class="built_in">window</span>.addEventListener(HashChangeEvent, handleHashChange);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (listenerCount === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="built_in">window</span>.removeEventListener(PopStateEvent, handlePopState);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (needsHashChangeListener)</span><br><span class="line">      <span class="built_in">window</span>.removeEventListener(HashChangeEvent, handleHashChange);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 阻断地址栏变更</span></span><br><span class="line"><span class="keyword">let</span> isBlocked = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">block</span>(<span class="params">prompt = false</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> unblock = transitionManager.setPrompt(prompt);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!isBlocked) &#123;</span><br><span class="line">    checkDOMListeners(<span class="number">1</span>);</span><br><span class="line">    isBlocked = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isBlocked) &#123;</span><br><span class="line">      isBlocked = <span class="literal">false</span>;</span><br><span class="line">      checkDOMListeners(<span class="number">-1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> unblock();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听地址栏变更</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">listen</span>(<span class="params">listener</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> unlisten = transitionManager.appendListener(listener);</span><br><span class="line">  checkDOMListeners(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    checkDOMListeners(<span class="number">-1</span>);</span><br><span class="line">    unlisten();</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="createHashHistory"><a href="#createHashHistory" class="headerlink" title="createHashHistory"></a>createHashHistory</h3><p>createHashHistory 的处理逻辑与 createBrowserHistory 相同，只不过 createHashHistory 着眼于 hash 路径的变更。</p>
<p>createHashHistory 的参数 props 仅接受 basename, getUserConfirmation, hashType 三个属性。createHashHistory 专有的 hashType 用于设置 hash 路径的编码解码策略，默认为 ‘slash’。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// hash 路径的编码解码策略集合</span></span><br><span class="line"><span class="keyword">const</span> HashPathCoders = &#123;</span><br><span class="line">  hashbang: &#123;</span><br><span class="line">    encodePath: <span class="function"><span class="params">path</span> =&gt;</span></span><br><span class="line">      path.charAt(<span class="number">0</span>) === <span class="string">'!'</span> ? path : <span class="string">'!/'</span> + stripLeadingSlash(path),</span><br><span class="line">    decodePath: <span class="function"><span class="params">path</span> =&gt;</span> (path.charAt(<span class="number">0</span>) === <span class="string">'!'</span> ? path.substr(<span class="number">1</span>) : path)</span><br><span class="line">  &#125;,</span><br><span class="line">  noslash: &#123;</span><br><span class="line">    encodePath: stripLeadingSlash,</span><br><span class="line">    decodePath: addLeadingSlash</span><br><span class="line">  &#125;,</span><br><span class="line">  slash: &#123;</span><br><span class="line">    encodePath: addLeadingSlash,</span><br><span class="line">    decodePath: addLeadingSlash</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>在 createHashHistory 模块中，变更 hash 路径基于 location.hash 赋值和 location.replace 方法。同时，createHashHistory 借助 hashchange 事件实现回滚，而上述两者变更 hash 路径的方式均会触发 hashchange 事件。因此，在 push, replace 方法的实现中，待变更的地址将会写入 ignorePath 缓存中，以在 handleHashChange 绑定函数对此变更不作回滚操作。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleHashChange</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> path = getHashPath();</span><br><span class="line">  <span class="keyword">const</span> encodedPath = encodePath(path);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (path !== encodedPath) &#123;</span><br><span class="line">    <span class="comment">// Ensure we always have a properly-encoded hash.</span></span><br><span class="line">    replaceHashPath(encodedPath);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> location = getDOMLocation();</span><br><span class="line">    <span class="keyword">const</span> prevLocation = history.location;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!forceNextPop &amp;&amp; locationsAreEqual(prevLocation, location)) <span class="keyword">return</span>; <span class="comment">// A hashchange doesn't always == location change.</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (ignorePath === createPath(location)) <span class="keyword">return</span>; <span class="comment">// Ignore this change; we already setState in push/replace.</span></span><br><span class="line"></span><br><span class="line">    ignorePath = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    handlePop(location);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="createMemoryHistory"><a href="#createMemoryHistory" class="headerlink" title="createMemoryHistory"></a>createMemoryHistory</h3><p>createMemoryHistory 用于在内存中创建完全虚拟的历史堆栈，只缓存历史记录，但与真实的地址栏无关（不会引起地址栏变更，不会和原生的 history 对象保持同步），也与 popstate, hashchange 事件无关。</p>
<p>createMemoryHistory 的参数 props 接受 getUserConfirmation, initialEntries, initialIndex, keyLength 属性。其中，props.initialEntries 指定最初的历史堆栈内容 history.entries；props.initialIndex 指定最初的索引值 history.index。push, replace 方法均将改变 history.entries 历史堆栈内容；go, goBack, goForward 均基于  history.entries 历史堆栈内容，以改变 history.index 及 history.location。实现参见源码。</p>
<h3 id="工具函数"><a href="#工具函数" class="headerlink" title="工具函数"></a>工具函数</h3><h4 id="PathUtils"><a href="#PathUtils" class="headerlink" title="PathUtils"></a>PathUtils</h4><p>路径相关操作。</p>
<ul>
<li>addLeadingSlash(path)：酌情为 path 路径添加前缀 ‘/‘。</li>
<li>stripLeadingSlash(path)：酌情为 path 路径剔除前缀 ‘/‘。</li>
<li>hasBasename(path, prefix)：判断路径 path 是否包含前缀 prefix。</li>
<li>stripBasename(path, prefix)：酌情为 path 路径剔除前缀 prefix。</li>
<li>stripTrailingSlash(path)：酌情为 path 路径剔除后缀 ‘/‘。</li>
<li>parsePath(path)：将字符串路径 path 转换为 { pathname, search, hash } 对象。</li>
<li>createPath(location)：将 { pathname, search, hash } 对象转换为字符串路径 path。</li>
</ul>
<h4 id="LocationUtils"><a href="#LocationUtils" class="headerlink" title="LocationUtils"></a>LocationUtils</h4><p>location 对象相关操作，基于 resolve-pathname, value-equal。</p>
<ul>
<li>createLocation(path, state, key, currentLocation) 构建 location = { pathname, search, hash, key, state } 对象，pathname 将根据 currentLocation 参数进行调整。</li>
<li>locationsAreEqual(a, b) 判断两个 location 对象是否相等。</li>
</ul>
<h4 id="DOMUtils"><a href="#DOMUtils" class="headerlink" title="DOMUtils"></a>DOMUtils</h4><p>DOM 环境判断。</p>
<ul>
<li>canUseDOM 是否可以操作节点。</li>
<li>getConfirmation(message, callback) 使用 window.confirm 弹出确认框，callback 的参数可用于判断用户是否点击确认按键。</li>
<li>supportsHistory 判断浏览器平台是否支持 HTML5 history API。</li>
<li>supportsPopStateOnHashChange 判断浏览器平台是否会在 hash 路径变更时触发 popstate 事件。</li>
<li>supportsGoWithoutReloadUsingHash 使用 go(n) 变更 hash 路径时是否不会页面刷新。</li>
<li>isExtraneousPopstateEvent 判断 popstate 事件是否由无关的操作引起。iOS 平台 chrome 浏览器点击回退按钮会触发 state 为 undefined 的 popstate 事件。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpeg" alt="Alfred">
            
              <p class="site-author-name" itemprop="name">Alfred</p>
              <p class="site-description motion-element" itemprop="description">人苦不知足，既得陇，复望蜀</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">95</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    <span class="site-state-item-count">31</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    <span class="site-state-item-count">26</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Alfred-sg" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/xiu-fan-79/activities" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-globe"></i>知乎</a>
                  </span>
                
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Alfred</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Pisces</a> v6.0.2</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.0.2"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.2"></script>



  

  
    <script id="dsq-count-scr" src="https://alfred.disqus.com/count.js" async></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  

  





	





  












  





  

  

  

  

  
  

  

  

  

  

</body>
</html>
