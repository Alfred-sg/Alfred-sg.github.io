<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.0.2" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.2">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.2" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.0.2',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="Hexo, NexT">


<meta name="description" content="人苦不知足，既得陇，复望蜀">
<meta property="og:type" content="website">
<meta property="og:title" content="修子范语">
<meta property="og:url" content="http://yoursite.com/page/9/index.html">
<meta property="og:site_name" content="修子范语">
<meta property="og:description" content="人苦不知足，既得陇，复望蜀">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="修子范语">
<meta name="twitter:description" content="人苦不知足，既得陇，复望蜀">






  <link rel="canonical" href="http://yoursite.com/page/9/">


  <title>修子范语</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">修子范语</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Alfredo's Notes</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/25/antd/Grid/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/25/antd/Grid/" itemprop="url">Grid 栅格</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-25T00:00:00+08:00">2018-11-25</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/antd-组件库/" itemprop="url" rel="index"><span itemprop="name">antd 组件库</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/25/antd/Grid/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/25/antd/Grid/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>antd 提供的 24 栅格系统由 Row, Col 组件实现。</p>
<h2 id="Row"><a href="#Row" class="headerlink" title="Row"></a>Row</h2><p>栅格布局组件 Row 用于设定整行 row 内各组 col 的布局风格。当 props.type 为 ‘flex’ 时，意味着整行采用 flex 布局。在 flex 布局的基础上，props.justify 通过 justify-content 样式影响各 col 元素的水平排列方式；props.align 通过 align-items 样式影响各 col 元素的垂直对齐方式。props.gutter 用于设定各 col 元素的间隔，间隔单位可以是 ‘px’ 或 ‘rem’。Row 支持以对象形式配置 props.gutter，如 { xs, sm, md, lg, xl, xxl }。其中，xs 为 576 px 以下屏幕；sm 为 576 - 768 px 尺寸屏幕；md 为 768 - 992 px 尺寸屏幕；lg 为 992 - 1200 px 尺寸屏幕；xl 为 1200 - 1600 px 尺寸屏幕；xxl 为 1600 px 以上屏幕；</p>
<p>在响应式处理上，Row 组件借助 <a href="https://github.com/WickyNilliams/enquire.js" target="_blank" rel="noopener">enquire.js</a> 库实现。其场景如以 { md: 8, lg: 16 } 对象配置 props.gutter，那么，当屏幕尺寸小于 768px 时，就需要将各 col 元素的间隔从 16 px 调整为 8px。Row 组件对这一场景的实现机制为，在 componentDidMount 生命周期使用 enquire.js 库绑定监听函数，以使得当屏幕尺寸变更时，state.screen 当前屏幕状态也会相应得到更新；随后在 render 阶段，由 getGutter 方法获得当前屏幕尺寸下的 col 元素间隔 gutter，并借助 <a href="https://github.com/jamiebuilds/create-react-context" target="_blank" rel="noopener">create-react-context</a> 库将 gutter 注入到 Col 组件中。以下是该机制实现的源码。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">componentDidMount() &#123;</span><br><span class="line">  <span class="built_in">Object</span>.keys(responsiveMap)</span><br><span class="line">    .map(<span class="function">(<span class="params">screen: Breakpoint</span>) =&gt;</span> enquire.register(responsiveMap[screen], &#123;</span><br><span class="line">        match: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="keyword">this</span>.props.gutter !== <span class="string">'object'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">this</span>.setState(<span class="function">(<span class="params">prevState</span>) =&gt;</span> (&#123;</span><br><span class="line">            screens: &#123;</span><br><span class="line">              ...prevState.screens,</span><br><span class="line">              [screen]: <span class="literal">true</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;));</span><br><span class="line">        &#125;,</span><br><span class="line">        unmatch: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="keyword">this</span>.props.gutter !== <span class="string">'object'</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">this</span>.setState(<span class="function">(<span class="params">prevState</span>) =&gt;</span> (&#123;</span><br><span class="line">            screens: &#123;</span><br><span class="line">              ...prevState.screens,</span><br><span class="line">              [screen]: <span class="literal">false</span>,</span><br><span class="line">            &#125;,</span><br><span class="line">          &#125;));</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="comment">// Keep a empty destory to avoid triggering unmatch when unregister</span></span><br><span class="line">        destroy() &#123;&#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">    ));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">getGutter(): number | <span class="literal">undefined</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; gutter &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> gutter === <span class="string">'object'</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt;= responsiveArray.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> breakpoint: Breakpoint = responsiveArray[i];</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.state.screens[breakpoint] &amp;&amp; gutter[breakpoint] !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> gutter[breakpoint];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> gutter <span class="keyword">as</span> number;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在样式处理方面，整行 row 采用 border-box 盒模型，相对定位，并嵌套使用 .clearfix 样式规则以清除浮动以及 :before, :after 伪类的内容。其余均较为简单，可参见<a href="https://github.com/ant-design/ant-design/blob/master/components/form/style/index.less" target="_blank" rel="noopener">源码</a>。</p>
<h2 id="Col"><a href="#Col" class="headerlink" title="Col"></a>Col</h2><p>Col 组件主要通过样式类以设定 col 元素的大小和偏移情况。如当配置了 props.offset 属性为 4 时，将相应添加 ant-col-xs-offset-4, ant-col-sm-offset-4, ant-col-md-offset-4, ant-col-lg-offset-4, ant-col-xl-offset-4, ant-col-xll-offset-4 样式类。因此，Col 组件的逻辑主要是将 props 转化成样式类，其实现的重点仍在于 less 样式文件。</p>
<p>当然，各 col 元素的间隔 gutter 由 Row 组件传入。以下是其源码实现，RowContext 通过 create-react-context 库创建，即通过 context 属性传递数据，但只有 Col 组件能加以访问。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Row</span></span><br><span class="line">render() &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;RowContext.Provider value=&#123;&#123; gutter &#125;&#125;&gt;</span><br><span class="line">      &lt;div &#123;...otherProps&#125; className=&#123;classes&#125; style=&#123;rowStyle&#125;&gt;</span><br><span class="line">        &#123;children&#125;</span><br><span class="line">      &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>RowContext.Provider&gt;</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Col</span></span><br><span class="line">render() &#123;</span><br><span class="line">  <span class="keyword">return</span> (</span><br><span class="line">    &lt;RowContext.Consumer&gt;</span><br><span class="line">      &#123;(&#123; gutter &#125;) =&gt; &#123;</span><br><span class="line">        <span class="keyword">let</span> style = others.style;</span><br><span class="line">        <span class="keyword">if</span> (gutter <span class="keyword">as</span> number &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          style = &#123;</span><br><span class="line">            paddingLeft: (gutter <span class="keyword">as</span> number) / <span class="number">2</span>,</span><br><span class="line">            paddingRight: (gutter <span class="keyword">as</span> number) / <span class="number">2</span>,</span><br><span class="line">            ...style,</span><br><span class="line">          &#125;;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> &lt;div &#123;...others&#125; style=&#123;style&#125; className=&#123;classes&#125;&gt;&#123;children&#125;&lt;/div&gt;;</span><br><span class="line">      &#125;&#125;</span><br><span class="line">    &lt;<span class="regexp">/RowContext.Consumer&gt;</span></span><br><span class="line"><span class="regexp">  )</span></span><br><span class="line"><span class="regexp">&#125;</span></span><br></pre></td></tr></table></figure>
<p>在 less 文件中，antd 使用自调用的混合函数创建从 .ant-col-1 到 .ant-col-24 的样式规则。以下是相关源码。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// style/theme/default.less</span></span><br><span class="line"><span class="variable">@grid-columns:</span> <span class="number">24</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// mixin.less</span></span><br><span class="line"><span class="comment">// index 由 1 到 24，构建样式规则</span></span><br><span class="line"><span class="selector-class">.make-grid-columns</span>() &#123;</span><br><span class="line">  <span class="selector-class">.col</span>(<span class="variable">@index</span>) &#123;</span><br><span class="line">    <span class="variable">@item:</span> <span class="string">~".@&#123;ant-prefix&#125;-col-@&#123;index&#125;, .@&#123;ant-prefix&#125;-col-xs-@&#123;index&#125;, .@&#123;ant-prefix&#125;-col-sm-@&#123;index&#125;, .@&#123;ant-prefix&#125;-col-md-@&#123;index&#125;, .@&#123;ant-prefix&#125;-col-lg-@&#123;index&#125;"</span>;</span><br><span class="line">    <span class="selector-class">.col</span>((<span class="variable">@index</span> + <span class="number">1</span>), <span class="variable">@item</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.col</span>(<span class="variable">@index</span>, <span class="variable">@list</span>) <span class="keyword">when</span> (<span class="variable">@index</span> =&lt; <span class="variable">@grid-columns</span>) &#123;</span><br><span class="line">    <span class="variable">@item:</span> <span class="string">~".@&#123;ant-prefix&#125;-col-@&#123;index&#125;, .@&#123;ant-prefix&#125;-col-xs-@&#123;index&#125;, .@&#123;ant-prefix&#125;-col-sm-@&#123;index&#125;, .@&#123;ant-prefix&#125;-col-md-@&#123;index&#125;, .@&#123;ant-prefix&#125;-col-lg-@&#123;index&#125;"</span>;</span><br><span class="line">    <span class="selector-class">.col</span>((<span class="variable">@index</span> + <span class="number">1</span>), <span class="string">~"@&#123;list&#125;, @&#123;item&#125;"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.col</span>(<span class="variable">@index</span>, <span class="variable">@list</span>) <span class="keyword">when</span> (<span class="variable">@index</span> &gt; <span class="variable">@grid-columns</span>) &#123;</span><br><span class="line">    <span class="variable">@&#123;list&#125;</span> &#123;</span><br><span class="line">      <span class="attribute">position</span>: relative;</span><br><span class="line">      <span class="comment">// Prevent columns from collapsing when empty</span></span><br><span class="line">      <span class="attribute">min-height</span>: <span class="number">1px</span>;</span><br><span class="line">      <span class="attribute">padding-left</span>: (<span class="variable">@grid-gutter-width</span> / <span class="number">2</span>);</span><br><span class="line">      <span class="attribute">padding-right</span>: (<span class="variable">@grid-gutter-width</span> / <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.col</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.float-grid-columns</span>(<span class="variable">@class</span>) &#123;</span><br><span class="line">  <span class="selector-class">.col</span>(<span class="variable">@index</span>) &#123; <span class="comment">// initial</span></span><br><span class="line">    <span class="variable">@item:</span> <span class="string">~".@&#123;ant-prefix&#125;-col@&#123;class&#125;-@&#123;index&#125;"</span>;</span><br><span class="line">    <span class="selector-class">.col</span>((<span class="variable">@index</span> + <span class="number">1</span>), <span class="variable">@item</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.col</span>(<span class="variable">@index</span>, <span class="variable">@list</span>) <span class="keyword">when</span> (<span class="variable">@index</span> =&lt; <span class="variable">@grid-columns</span>) &#123; <span class="comment">// general</span></span><br><span class="line">    <span class="variable">@item:</span> <span class="string">~".@&#123;ant-prefix&#125;-col@&#123;class&#125;-@&#123;index&#125;"</span>;</span><br><span class="line">    <span class="selector-class">.col</span>((<span class="variable">@index</span> + <span class="number">1</span>), <span class="string">~"@&#123;list&#125;, @&#123;item&#125;"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.col</span>(<span class="variable">@index</span>, <span class="variable">@list</span>) <span class="keyword">when</span> (<span class="variable">@index</span> &gt; <span class="variable">@grid-columns</span>) &#123; <span class="comment">// terminal</span></span><br><span class="line">    <span class="variable">@&#123;list&#125;</span> &#123;</span><br><span class="line">      <span class="attribute">float</span>: left;</span><br><span class="line">      <span class="attribute">flex</span>: <span class="number">0</span> <span class="number">0</span> auto;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.col</span>(<span class="number">1</span>); <span class="comment">// kickstart it</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// index 由 24 到 1，构建样式规则</span></span><br><span class="line"><span class="selector-class">.loop-grid-columns</span>(<span class="variable">@index</span>, <span class="variable">@class</span>) <span class="keyword">when</span> (<span class="variable">@index</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="selector-class">.@&#123;ant-prefix&#125;</span><span class="selector-tag">-col</span><span class="variable">@&#123;class&#125;</span><span class="selector-tag">-</span><span class="variable">@&#123;index&#125;</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">    <span class="attribute">box-sizing</span>: border-box;</span><br><span class="line">    <span class="attribute">width</span>: percentage((<span class="variable">@index</span> / <span class="variable">@grid-columns</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.@&#123;ant-prefix&#125;</span><span class="selector-tag">-col</span><span class="variable">@&#123;class&#125;</span><span class="selector-tag">-push-</span><span class="variable">@&#123;index&#125;</span> &#123;</span><br><span class="line">    <span class="attribute">left</span>: percentage((<span class="variable">@index</span> / <span class="variable">@grid-columns</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.@&#123;ant-prefix&#125;</span><span class="selector-tag">-col</span><span class="variable">@&#123;class&#125;</span><span class="selector-tag">-pull-</span><span class="variable">@&#123;index&#125;</span> &#123;</span><br><span class="line">    <span class="attribute">right</span>: percentage((<span class="variable">@index</span> / <span class="variable">@grid-columns</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.@&#123;ant-prefix&#125;</span><span class="selector-tag">-col</span><span class="variable">@&#123;class&#125;</span><span class="selector-tag">-offset-</span><span class="variable">@&#123;index&#125;</span> &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: percentage((<span class="variable">@index</span> / <span class="variable">@grid-columns</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.@&#123;ant-prefix&#125;</span><span class="selector-tag">-col</span><span class="variable">@&#123;class&#125;</span><span class="selector-tag">-order-</span><span class="variable">@&#123;index&#125;</span> &#123;</span><br><span class="line">    <span class="attribute">order</span>: <span class="variable">@index</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.loop-grid-columns</span>((<span class="variable">@index</span> - <span class="number">1</span>), <span class="variable">@class</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.loop-grid-columns</span>(<span class="variable">@index</span>, <span class="variable">@class</span>) <span class="keyword">when</span> (<span class="variable">@index</span> = <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="selector-class">.@&#123;ant-prefix&#125;</span><span class="selector-tag">-col</span><span class="variable">@&#123;class&#125;</span><span class="selector-tag">-</span><span class="variable">@&#123;index&#125;</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: none;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.@&#123;ant-prefix&#125;</span><span class="selector-tag">-col-push-</span><span class="variable">@&#123;index&#125;</span> &#123;</span><br><span class="line">    <span class="attribute">left</span>: auto;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.@&#123;ant-prefix&#125;</span><span class="selector-tag">-col-pull-</span><span class="variable">@&#123;index&#125;</span> &#123;</span><br><span class="line">    <span class="attribute">right</span>: auto;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.@&#123;ant-prefix&#125;</span><span class="selector-tag">-col</span><span class="variable">@&#123;class&#125;</span><span class="selector-tag">-push-</span><span class="variable">@&#123;index&#125;</span> &#123;</span><br><span class="line">    <span class="attribute">left</span>: auto;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.@&#123;ant-prefix&#125;</span><span class="selector-tag">-col</span><span class="variable">@&#123;class&#125;</span><span class="selector-tag">-pull-</span><span class="variable">@&#123;index&#125;</span> &#123;</span><br><span class="line">    <span class="attribute">right</span>: auto;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.@&#123;ant-prefix&#125;</span><span class="selector-tag">-col</span><span class="variable">@&#123;class&#125;</span><span class="selector-tag">-offset-</span><span class="variable">@&#123;index&#125;</span> &#123;</span><br><span class="line">    <span class="attribute">margin-left</span>: <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.@&#123;ant-prefix&#125;</span><span class="selector-tag">-col</span><span class="variable">@&#123;class&#125;</span><span class="selector-tag">-order-</span><span class="variable">@&#123;index&#125;</span> &#123;</span><br><span class="line">    <span class="attribute">order</span>: <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.make-grid</span>(<span class="variable">@class</span>: <span class="string">~''</span>) &#123;</span><br><span class="line">  <span class="selector-class">.float-grid-columns</span>(<span class="variable">@class</span>);</span><br><span class="line">  <span class="selector-class">.loop-grid-columns</span>(<span class="variable">@grid-columns</span>, <span class="variable">@class</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// index.less</span></span><br><span class="line"><span class="selector-class">.make-grid-columns</span>();</span><br><span class="line"><span class="selector-class">.make-grid</span>();</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.make-grid</span>(-xs);</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span> (<span class="attribute">min-width</span>: <span class="variable">@screen-sm-min</span>) &#123;</span><br><span class="line">  <span class="selector-class">.make-grid</span>(-sm);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span> (<span class="attribute">min-width</span>: <span class="variable">@screen-md-min</span>) &#123;</span><br><span class="line">  <span class="selector-class">.make-grid</span>(-md);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span> (<span class="attribute">min-width</span>: <span class="variable">@screen-lg-min</span>) &#123;</span><br><span class="line">  <span class="selector-class">.make-grid</span>(-lg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span> (<span class="attribute">min-width</span>: <span class="variable">@screen-xl-min</span>) &#123;</span><br><span class="line">  <span class="selector-class">.make-grid</span>(-xl);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">@media</span> (<span class="attribute">min-width</span>: <span class="variable">@screen-xxl-min</span>) &#123;</span><br><span class="line">  <span class="selector-class">.make-grid</span>(-xxl);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/25/antd/Layout/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/25/antd/Layout/" itemprop="url">Layout 布局</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-25T00:00:00+08:00">2018-11-25</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/antd-组件库/" itemprop="url" rel="index"><span itemprop="name">antd 组件库</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/25/antd/Layout/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/25/antd/Layout/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>antd 提供 Layout, Header, Sider, Content, Footer 组件用于划定页面布局。实现上，侧边栏 Sider 组件比较特殊，将在第一部分加以介绍；其余组件均将在第一部分加以介绍。</p>
<h2 id="Layout"><a href="#Layout" class="headerlink" title="Layout"></a>Layout</h2><p>布局容器 Layout, 顶部布局 Header, 内容部分 Content, 底部布局 Footer 在实现上大体相当：都是通过 generator(props) = BasicComponent =&gt; Adapter 创建高阶组件 Adapter，再由该高阶组件将 props.prefixCls 注入到 BasicComponent 中。</p>
<p>作为 Layout 组件的 BasicComponent，BasicLayout 组件以 state.siders 记录侧边栏的 id，并允许在子组件中使用 context.siderHook 添加或移除侧边栏，其意义是触发 BasicLayout 组件重绘并判断是否需要添加 .ant-layout-has-sider 样式类。作为 Header, Content, Footer 组件的 BasicComponent，Basic 组件只用于拼接 props.prefixCls, props.className，以构成新的样式类。</p>
<p>Header, Sider, Content, Footer 组件只能作为 Layout 的子组件这一特征，由 less 文件约定，即如果当上述组件不作为 Layout 的子组件时，其样式将得不到正常展示。</p>
<h2 id="Sider"><a href="#Sider" class="headerlink" title="Sider"></a>Sider</h2><p>侧边栏 Sider 组件用于设定布局，其内容可由 <a href="https://ant.design/components/menu-cn/" target="_blank" rel="noopener">Menu 组件</a> 绘制。在 componentDidMount, componentWillUnmount 生命周期中，侧边栏组件也将通过 context.siderHook.addSider, context.siderHook.removeSider 方法，以添加或移除 Layout 容器中记录的侧边栏 id。侧边栏组件既可以根据折叠状态切换按钮展开或折叠（通过 props.collapsible 或 props.collapsedWidth = 0 开启）；也可以根据屏幕尺寸响应式展开或折叠（通过 props.breakpoint 属性开启），其实现借助 window.matchMedia 方法。子组件可通过 context.siderCollapsed 获得侧边栏的展开和折叠状态。以下是响应式展开或折叠功能的实现。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// matchMedia polyfill for</span></span><br><span class="line"><span class="comment">// https://github.com/WickyNilliams/enquire.js/issues/82</span></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">window</span> !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> matchMediaPolyfill = <span class="function">(<span class="params">mediaQuery: string</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      media: mediaQuery,</span><br><span class="line">      matches: <span class="literal">false</span>,</span><br><span class="line">      addListener() &#123;</span><br><span class="line">      &#125;,</span><br><span class="line">      removeListener() &#123;</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="built_in">window</span>.matchMedia = <span class="built_in">window</span>.matchMedia || matchMediaPolyfill;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sider</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span>&lt;<span class="title">SiderProps</span>, <span class="title">SiderState</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(props: SiderProps) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> matchMedia;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">window</span> !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">      matchMedia = <span class="built_in">window</span>.matchMedia;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (matchMedia &amp;&amp; props.breakpoint &amp;&amp; props.breakpoint <span class="keyword">in</span> dimensionMap) &#123;</span><br><span class="line">      <span class="keyword">this</span>.mql = matchMedia(<span class="string">`(max-width: <span class="subst">$&#123;dimensionMap[props.breakpoint]&#125;</span>)`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.mql) &#123;</span><br><span class="line">      <span class="keyword">this</span>.mql.addListener(<span class="keyword">this</span>.responsiveHandler);</span><br><span class="line">      <span class="keyword">this</span>.responsiveHandler(<span class="keyword">this</span>.mql);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  responsiveHandler = <span class="function">(<span class="params">mql: MediaQueryListEvent | MediaQueryList</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; <span class="attr">below</span>: mql.matches &#125;);</span><br><span class="line">    <span class="keyword">const</span> &#123; onBreakpoint &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">if</span> (onBreakpoint) &#123;</span><br><span class="line">      onBreakpoint(mql.matches);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.state.collapsed !== mql.matches) &#123;</span><br><span class="line">      <span class="keyword">this</span>.setCollapsed(mql.matches, <span class="string">'responsive'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setCollapsed = <span class="function">(<span class="params">collapsed: boolean, type: CollapseType</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(<span class="string">'collapsed'</span> <span class="keyword">in</span> <span class="keyword">this</span>.props)) &#123;</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">        collapsed,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> &#123; onCollapse &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">if</span> (onCollapse) &#123;</span><br><span class="line">      onCollapse(collapsed, type);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>侧边栏组件的断点 props.breakpoint 包含五种可能：xs 为 480px；sm 为 576px；md 为 768px；lg 为 992px；xl 为 1200px；xxl 为 1600px。当设置了 props.breakpoint 时，就能实现响应式展开与折叠功能。</p>
<p>当 props.collapsedWidth 设置为 0，折叠状态切换按钮为 bars 类型。默认的折叠状态切换按钮为 left 或 right 类型。此外，可以使用 props.trigger 设置自定义折叠状态切换按钮。</p>
<p>侧边栏的主题样式通过设置样式类实现，如 ant-layout-sider-light。</p>
<p>侧边栏组件使用 <a href="https://github.com/reactjs/react-lifecycles-compat" target="_blank" rel="noopener">react-lifecycles-compat</a> 封装，以在低版本的 react 中书写 static getDerivedStateFromProps, getSnapshotBeforeUpdate 生命周期方法。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/17/css/less 使用指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/17/css/less 使用指南/" itemprop="url">less 使用指南</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-17T00:00:00+08:00">2018-11-17</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/css/" itemprop="url" rel="index"><span itemprop="name">css</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/17/css/less 使用指南/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/17/css/less 使用指南/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>这篇文章本不打算发布在知乎平台。但是在汇总笔者所不常用的 less 语法时，笔者又小小费了点脑筋，推想了一下 less 的实现（这样有助于从更高的维度去看待很多功能实现）。因此，笔者就希望能在一个更开阔的平台上得到一些回馈和纠错性意见。之所以要汇总 less 语法，那是因为要推究网页、组件库改变样式主题的实现。</p>
<h2 id="导入"><a href="#导入" class="headerlink" title="导入"></a>导入</h2><figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">@import</span> <span class="string">"library"</span>; <span class="comment">// library.less</span></span><br><span class="line"><span class="keyword">@import</span> <span class="string">"typo.css"</span>;</span><br></pre></td></tr></table></figure>
<h3 id="导入关键字"><a href="#导入关键字" class="headerlink" title="导入关键字"></a>导入关键字</h3><p>导入关键字使用形式如 @import (optional, reference) “foo.less”。</p>
<p>所包含的关键字有：</p>
<ol>
<li>reference: 导入的样式文件将作为参考，其所包含的选择器将不会呈现在输出文件，却可以使用 mixin 混入或 extend 扩展将原选择器的样式添加到新的选择器中。reference 的应用场景如，@import (reference) bootstrap.less 样式，使用混入或扩展关键字只将 .navbar all 相关选择器的样式输出。推想其实现如，以内存形式缓存编译后的样式文件，被引用时才注入到输出文件中。</li>
<li>inline: 全量复制 css 文件，不作处理（less 在某些地方不支持注释；且在不修改 css 的情形下，less 也不支持全部的 css hacks）。</li>
<li>less: 以 less 文件形式处理导入的样式文件，不管文件扩展名。</li>
<li>css: 以 css 文件形式处理导入的样式文件，不管文件扩展名。</li>
<li>once: 样式文件只导入一次，默认。</li>
<li>multiple：样式文件导入多次。</li>
<li>optional: 样式文件不存在时不会报错。</li>
</ol>
<h2 id="嵌套规则"><a href="#嵌套规则" class="headerlink" title="嵌套规则"></a>嵌套规则</h2><p>使用嵌套形式书写样式文件时，&amp; 表示父选择器。</p>
<p>less 将使用父选择器名替换 &amp;。特殊的，使用 &amp; 能改变选择器的顺序；当有多个父选择器时，&amp; 依次解析为这几个父选择器。</p>
<p>推想其实现如，以块 {} 为编译单元，以 selectors 缓存 {} 前选择器，以 content 缓存 {} 内容并作解析，将样式写入 output；然后递归调用前述过程，传入父 selectors, content，解析子块时再将父 selector 添加到子 selector 前，将样式写入 output。嵌套规则以树形结构组织，但样式写入 output 时为扁平化结构。单个 &amp; 可以使用父 selector；多个 &amp;，可先构建两维数组，每个数组项为父 selector 的有序列表，然后遍历两维数组进行替换。若 &amp; 在选择器的尾部，编译时无需在子选择器前添加父选择器，而只将 &amp; 替换为父选择器。</p>
<ol>
<li><p>多个父选择器</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="selector-tag">p</span>, <span class="selector-tag">a</span> &#123;</span><br><span class="line">  <span class="selector-tag">&amp;</span> + <span class="selector-tag">&amp;</span> &#123;</span><br><span class="line">    <span class="attribute">border-top</span>: <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="selector-tag">p</span> + <span class="selector-tag">p</span>,</span><br><span class="line"><span class="selector-tag">p</span> + <span class="selector-tag">a</span>,</span><br><span class="line"><span class="selector-tag">a</span> + <span class="selector-tag">p</span>,</span><br><span class="line"><span class="selector-tag">a</span> + <span class="selector-tag">a</span> &#123;</span><br><span class="line">  <span class="attribute">border-top</span>: <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>改变选择器的顺序</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="selector-class">.header</span> &#123;</span><br><span class="line">  <span class="selector-class">.menu</span> &#123;</span><br><span class="line">    <span class="selector-class">.no-borderradius</span> <span class="selector-tag">&amp;</span> &#123;</span><br><span class="line">      <span class="attribute">background-image</span>: url(<span class="string">'images/button-background.png'</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="selector-class">.no-borderradius</span> <span class="selector-class">.header</span> <span class="selector-class">.menu</span> &#123;</span><br><span class="line">  <span class="attribute">background-image</span>: url(<span class="string">'images/button-background.png'</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h2><p>less 中变量使用 @variableName: variableValue 形式声明；@variableName 或 @{variableName} 形式使用。变量可用于选择器的名称，样式属性的名称，样式属性的值，url，import 语句等。</p>
<p>less 允许使用变量去定义另一个变量的名称，即 @@variablename2 形式声明变量 variablename1。</p>
<p>less 允许先使用变量，再声明变量。推想其实现如，同 js 一样会将声明提前，并保留在内存中，以精确的值替换掉使用的变量，文件解析完成后，再释放内存。</p>
<p>变量有作用域，就近定义的优先。推想其编译过程，块将解析为函数，当在块中再度遇到相同的变量名，注入函数的实参就会被改变，最终输出也因而改变。其实现可能譬如模板引擎。</p>
<p>变量的一大用途包含，通过变量设置网页样式的主题。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@var:</span> red;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#page</span> &#123;</span><br><span class="line">  <span class="variable">@var:</span> white;</span><br><span class="line">  <span class="selector-id">#header</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: <span class="variable">@var</span>; <span class="comment">// white</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="变量与混合"><a href="#变量与混合" class="headerlink" title="变量与混合"></a>变量与混合</h3><p>变量可以存储分离的规则集，其下可包含属性、嵌套规则集、变量声明、混合等。分离的规则集在块 {} 中以函数形式使用，该块内就可以使用分离的规则集内所声明的变量、样式属性和混合。</p>
<p>推想其实现如，将分离规则集解析为函数，在快内使用时再行植入。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="variable">@detached-ruleset:</span> &#123;</span><br><span class="line">  <span class="selector-class">.mixin</span>() &#123;</span><br><span class="line">    <span class="attribute">font-family</span>: <span class="string">"Comic Sans MS"</span>;</span><br><span class="line">    <span class="attribute">background-color</span>: <span class="number">#AA86EE</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.cont</span> &#123;</span><br><span class="line">  <span class="variable">@detached-ruleset</span>();</span><br><span class="line">  <span class="selector-class">.mixin</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="selector-class">.cont</span> &#123;</span><br><span class="line">  <span class="attribute">font-family</span>: <span class="string">"Comic Sans MS"</span>;</span><br><span class="line">  <span class="attribute">background-color</span>: <span class="number">#AA86EE</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="操作符"><a href="#操作符" class="headerlink" title="操作符"></a>操作符</h2><p>算数运算符 +, -, *, / 可作用于变量、颜色、数值，less 将尝试获得单位。推想其实现，首先将变量替换为实际的值，然后匹配到操作符，解析操作符前后数值的单位并获得最终单位，使用最终单位修正数值，数值计算并输出。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@conversion-1:</span> <span class="number">5cm</span> + <span class="number">10mm</span>; <span class="comment">// 输出 6cm</span></span><br><span class="line"><span class="variable">@conversion-2:</span> <span class="number">2</span> - <span class="number">3cm</span> - <span class="number">5mm</span>; <span class="comment">// 输出 1.5cm</span></span><br><span class="line"><span class="variable">@incompatible-units:</span> <span class="number">2</span> + <span class="number">5px</span> - <span class="number">3cm</span>; <span class="comment">// 输出 4px</span></span><br><span class="line"><span class="variable">@base:</span> <span class="number">5%</span>;</span><br><span class="line"><span class="variable">@filler:</span> <span class="variable">@base</span> * <span class="number">2</span>; <span class="comment">// 输出 10%</span></span><br><span class="line"><span class="variable">@other:</span> <span class="variable">@base</span> + <span class="variable">@filler</span>; <span class="comment">// 输出 15%</span></span><br></pre></td></tr></table></figure>
<h2 id="转义"><a href="#转义" class="headerlink" title="转义"></a>转义</h2><p>任何 ~”anything” 或 ~’anything’ 语句内，单双引号内容都将被保留，可用于规避 ‘//‘, ‘/<em> </em>/‘被误认为注释。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.weird-element</span> &#123;</span><br><span class="line">  <span class="attribute">content</span>: <span class="string">~"^//* some horrible but needed css hack"</span>;<span class="comment">// 输出 content: ^//* some horrible but needed css hack;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="混合"><a href="#混合" class="headerlink" title="混合"></a>混合</h2><p>混合能将某个类或 id 选择器中的样式添加到另一个选择器中，其书写形式如 css 中为类或 id 选择器添加样式，其下可包含选择器（当子选择器为类或 id 选择器时，该子选择器构成另一个混合，可以直接使用；这样，父选择器也称为命名空间）。</p>
<p>当 guard 应用于命名空间时，当且仅当 guard 条件返回真值，才能使用由命名空间定义的混合。参见 guard。</p>
<p>使用混合时添加 !important 关键字，混合下所有样式都将添加 !important。</p>
<p>特别，当类或 id 选择器以 () 结尾时，选择器将不会在输出文件中有所表现，而只是在使用时会将样式混入到其他选择器中。() 中可以添加参数（以 ‘,’ 或 ‘;’ 分割参数），使函数具有函数特征，且支持多态。混合函数使用时可以借助参数名指定参数的值，这样就无关参数的位置；且使用时，@arguments 将包含所有参数；参数支持解构语法如 … 或 @rest…。混合函数的参数可以是复杂的样式规则。</p>
<p>在混合函数中声明的变量，可以在使用混合的块中访问。但是块中若有同名变量，以块中声明的变量优先。</p>
<p>推想其实现如，编译结束后类或 id 选择器构成的混合将保留在内存中，对于 () 结尾的选择器将以函数形式保存，使用时调用函数，这样就不会有样式输出。且保留在内存中的函数是在解析到 () 时构建的，这样就使得 less 语法上呈现多态，编译出来的函数可以使用控制语句处理函数体内参数的多态特征。</p>
<ol>
<li><p>命名空间，不输出混合。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="selector-id">#bundle</span>() &#123;</span><br><span class="line">  <span class="selector-class">.button</span> &#123;</span><br><span class="line">    <span class="attribute">display</span>: block;</span><br><span class="line">    <span class="attribute">border</span>: <span class="number">1px</span> solid black;</span><br><span class="line">    <span class="attribute">background-color</span>: grey;</span><br><span class="line">    <span class="selector-tag">&amp;</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">      <span class="attribute">background-color</span>: white</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="selector-class">.tab</span> &#123; ... &#125;</span><br><span class="line">  <span class="selector-class">.citation</span> &#123; ... &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-id">#header</span> <span class="selector-tag">a</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: orange;</span><br><span class="line">  <span class="selector-id">#bundle</span> &gt; <span class="selector-class">.button</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="selector-id">#header</span> <span class="selector-tag">a</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: orange;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">  <span class="attribute">border</span>: <span class="number">1px</span> solid black;</span><br><span class="line">  <span class="attribute">background-color</span>: grey;</span><br><span class="line">  <span class="selector-tag">&amp;</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">background-color</span>: white</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 !important</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="selector-class">.foo</span> (<span class="variable">@bg</span>: <span class="number">#f5f5f5</span>, <span class="variable">@color</span>: <span class="number">#900</span>) &#123;</span><br><span class="line">  <span class="attribute">background</span>: <span class="variable">@bg</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="variable">@color</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.important</span> &#123;</span><br><span class="line">  <span class="selector-class">.foo</span>() !important;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="selector-class">.important</span> &#123;</span><br><span class="line">  <span class="attribute">background</span>: <span class="number">#f5f5f5</span> <span class="meta">!important</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#900</span> <span class="meta">!important</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>混合函数支持多态</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="selector-class">.mixin</span>(dark; <span class="variable">@color</span>) &#123;</span><br><span class="line">  <span class="attribute">color</span>: darken(<span class="variable">@color</span>, <span class="number">10%</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.mixin</span>(light; <span class="variable">@color</span>) &#123;</span><br><span class="line">  <span class="attribute">color</span>: lighten(<span class="variable">@color</span>, <span class="number">10%</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.mixin</span>(<span class="variable">@_</span>; <span class="variable">@color</span>) &#123;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">@switch:</span> light;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.class</span> &#123;</span><br><span class="line">  <span class="selector-class">.mixin</span>(<span class="variable">@switch</span>; <span class="number">#888</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="selector-class">.class</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#a2a2a2</span>;</span><br><span class="line">  <span class="attribute">display</span>: block;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>混合函数中定义的变量，可以在使用时引用</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="selector-class">.mixin</span>() &#123;</span><br><span class="line">  <span class="variable">@width:</span>  <span class="number">100%</span>;</span><br><span class="line">  <span class="variable">@height:</span> <span class="number">200px</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.caller</span> &#123;</span><br><span class="line">  <span class="selector-class">.mixin</span>();</span><br><span class="line">  <span class="attribute">width</span>:  <span class="variable">@width</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="variable">@height</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="selector-class">.caller</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>:  <span class="number">100%</span>;</span><br><span class="line">  <span class="attribute">height</span>: <span class="number">200px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h2><p>扩展 :extend 是 less 提供的伪类，使用形式如 .big-bag:extend(.bag) 将使 .big-bag 拥有 .bag 的样式。</p>
<p>使用 all 关键字如 .replacement:extend(.test all)，将把 .test 替换为 .replacement，再行输出另一份样式规则。</p>
<p>推想其实现如，selector1:extend(selector2) 伪类前后内容解析为映射形式，在将 selector2 的样式规则赋值给 selector1。</p>
<ol>
<li>all 关键字<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="selector-class">.a</span><span class="selector-class">.b</span><span class="selector-class">.test</span>,</span><br><span class="line"><span class="selector-class">.test</span><span class="selector-class">.c</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: orange;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.test</span> &#123;</span><br><span class="line">  <span class="selector-tag">&amp;</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: green;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.replacement</span><span class="selector-pseudo">:extend(.test</span> <span class="keyword">all</span>) &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="selector-class">.a</span><span class="selector-class">.b</span><span class="selector-class">.test</span>,</span><br><span class="line"><span class="selector-class">.test</span><span class="selector-class">.c</span>,</span><br><span class="line"><span class="selector-class">.a</span><span class="selector-class">.b</span><span class="selector-class">.replacement</span>,</span><br><span class="line"><span class="selector-class">.replacement</span><span class="selector-class">.c</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: orange;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.test</span><span class="selector-pseudo">:hover</span>,</span><br><span class="line"><span class="selector-class">.replacement</span><span class="selector-pseudo">:hover</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: green;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="扩展和指令"><a href="#扩展和指令" class="headerlink" title="扩展和指令"></a>扩展和指令</h3><p>若 extend 伪类在 @media 指令中定义，那么 less 将在 @media 指令内查找匹配的选择器。若 extend 伪类在顶层定义，less 将能匹配到所有 @media 指令中的选择器。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="keyword">@media</span> print &#123;</span><br><span class="line">  <span class="selector-class">.screenClass</span><span class="selector-pseudo">:extend(.selector)</span> &#123;&#125; <span class="comment">// extend inside media</span></span><br><span class="line">  <span class="selector-class">.selector</span> &#123; <span class="comment">// this will be matched - it is in the same media</span></span><br><span class="line">    <span class="attribute">color</span>: black;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="keyword">@media</span> print &#123;</span><br><span class="line">  <span class="selector-class">.selector</span>,</span><br><span class="line">  <span class="selector-class">.screenClass</span> &#123; <span class="comment">/*  ruleset inside the same media was extended */</span></span><br><span class="line">    <span class="attribute">color</span>: black;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="嵌套指令"><a href="#嵌套指令" class="headerlink" title="嵌套指令"></a>嵌套指令</h2><p>嵌套指令会冒泡到顶层。对于条件指令如 @Media, @supports, @document 等，条件指令上的父选择器会被植入条件指令内；对于非条件指令如 @font-face, @keyframes 等，条件指令上的父选择器会被忽略。</p>
<ol>
<li><p>条件指令</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="selector-class">.screen-color</span> &#123;</span><br><span class="line">  <span class="keyword">@media</span> screen &#123;</span><br><span class="line">    <span class="attribute">color</span>: green;</span><br><span class="line">    <span class="keyword">@media</span> (<span class="attribute">min-width</span>: <span class="number">768px</span>) &#123;</span><br><span class="line">      <span class="attribute">color</span>: red;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="keyword">@media</span> screen &#123;</span><br><span class="line">  <span class="selector-class">.screen-color</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: green;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@media</span> screen and (<span class="attribute">min-width</span>: <span class="number">768px</span>) &#123;</span><br><span class="line">  <span class="selector-class">.screen-color</span> &#123;</span><br><span class="line">    <span class="attribute">color</span>: red;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>非条件指令</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="selector-id">#a</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: blue;</span><br><span class="line">  <span class="keyword">@font-face</span> &#123;</span><br><span class="line">    <span class="attribute">src</span>: made-up-url;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="selector-id">#a</span> &#123;</span><br><span class="line">  <span class="attribute">color</span>: blue;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">@font-face</span> &#123;</span><br><span class="line">  <span class="attribute">src</span>: made-up-url;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="guard"><a href="#guard" class="headerlink" title="guard"></a>guard</h2><p>guard 用于指定条件，在满足该条件时，才会有样式输出。使用形式如 when (@var = value)，即当 @var 变量或参数等于 value 时，才满足条件。when 条件内可包含比较运算符如 =, &lt;, &gt;, &lt;=, &gt;=，以及逻辑运算符 and, and not，内置的类型检查函数如 iscolor, isnumber, isstring, iskeyword, isurl, ispixel, ispercentage, isem, isunit。</p>
<p>当使用 guard 递归构建 mixin 时，可以形成循环。</p>
<ol>
<li><p>逻辑运算符</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="selector-class">.mixin</span> (<span class="variable">@a</span>) <span class="keyword">when</span> (<span class="variable">@a</span> &gt; <span class="number">50%</span>) <span class="keyword">and</span> (<span class="variable">@a</span> &gt; <span class="number">5px</span>)&#123;</span><br><span class="line"><span class="attribute">font-size</span>: <span class="number">14px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.mixin</span> (<span class="variable">@a</span>) <span class="keyword">when</span> <span class="keyword">not</span> (<span class="variable">@a</span> &lt; <span class="number">50%</span>) <span class="keyword">and</span> <span class="keyword">not</span> (<span class="variable">@a</span> &lt; <span class="number">5px</span>)&#123;</span><br><span class="line"><span class="attribute">font-size</span>: <span class="number">20px</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.mixin</span> (<span class="variable">@a</span>) &#123;</span><br><span class="line">  <span class="attribute">color</span>: <span class="variable">@a</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.class1</span> &#123; <span class="selector-class">.mixin</span>(<span class="number">#FF0000</span>) &#125;</span><br><span class="line"><span class="selector-class">.class2</span> &#123; <span class="selector-class">.mixin</span>(<span class="number">#555</span>) &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="selector-class">.class1</span> &#123;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">20px</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#FF0000</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.class2</span> &#123;</span><br><span class="line">  <span class="attribute">font-size</span>: <span class="number">20px</span>;</span><br><span class="line">  <span class="attribute">color</span>: <span class="number">#555</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>循环</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="selector-class">.cont</span>(<span class="variable">@count</span>) <span class="keyword">when</span> (<span class="variable">@count</span> &gt; <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="selector-class">.cont</span>((<span class="variable">@count</span> - <span class="number">1</span>));</span><br><span class="line">  <span class="attribute">width</span>: (<span class="number">25px</span> * <span class="variable">@count</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-tag">div</span> &#123;</span><br><span class="line">  <span class="selector-class">.cont</span>(<span class="number">3</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="selector-tag">div</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">25px</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">50px</span>;</span><br><span class="line">  <span class="attribute">width</span>: <span class="number">75px</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="合并"><a href="#合并" class="headerlink" title="合并"></a>合并</h2><ol>
<li><p>使用 ‘,’ 串联多个样式属性</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="selector-class">.myfunc</span>() &#123;</span><br><span class="line">  <span class="selector-tag">box-shadow</span>+: <span class="selector-tag">5px</span> <span class="selector-tag">5px</span> <span class="selector-tag">5px</span> <span class="selector-tag">grey</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.class</span> &#123;</span><br><span class="line">  <span class="selector-class">.myfunc</span>();</span><br><span class="line">  <span class="selector-tag">box-shadow</span>+: <span class="selector-tag">0</span> <span class="selector-tag">0</span> <span class="selector-tag">5px</span> <span class="selector-id">#f78181</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="selector-class">.class</span> &#123;</span><br><span class="line">  <span class="attribute">box-shadow</span>: <span class="number">5px</span> <span class="number">5px</span> <span class="number">5px</span> grey, <span class="number">0</span> <span class="number">0</span> <span class="number">5px</span> <span class="number">#f78181</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>使用空格串联多个样式属性</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="selector-class">.mixin</span>() &#123;</span><br><span class="line">  <span class="selector-tag">transform</span>+<span class="selector-tag">_</span>: <span class="selector-tag">scale</span>(<span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="selector-class">.class</span> &#123;</span><br><span class="line">  <span class="selector-class">.mixin</span>();</span><br><span class="line">  <span class="selector-tag">transform</span>+<span class="selector-tag">_</span>: <span class="selector-tag">rotate</span>(<span class="number">2deg</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line"><span class="selector-class">.class</span> &#123;</span><br><span class="line">  <span class="attribute">transform</span>: scale(<span class="number">1</span>) rotate(<span class="number">2deg</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="函数"><a href="#函数" class="headerlink" title="函数"></a>函数</h2><p>推想其实现如，由 less 提供上下文环境，并通过该上下文环境输出内置函数。颜色函数的实现是笔者鞭长莫及的。</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">@base:</span> <span class="number">#f04615</span>;</span><br><span class="line"><span class="variable">@width:</span> <span class="number">0.5</span>;</span><br><span class="line"></span><br><span class="line"><span class="selector-class">.class</span> &#123;</span><br><span class="line">  <span class="attribute">width</span>: percentage(<span class="variable">@width</span>);</span><br><span class="line">  <span class="attribute">color</span>: saturate(<span class="variable">@base</span>, <span class="number">5%</span>);</span><br><span class="line">  <span class="attribute">background-color</span>: spin(lighten(<span class="variable">@base</span>, <span class="number">25%</span>), <span class="number">8</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="其他函数"><a href="#其他函数" class="headerlink" title="其他函数"></a>其他函数</h3><ol>
<li>color: 颜色转换函数。</li>
<li>image-size: 从文件中获取图像的宽度及高度，可作为 image-size 样式的值。</li>
<li>image-width : 从文件中获取图像的宽度。</li>
<li>image-height: 从文件中获取图像的高度。</li>
<li>convert: 单位转换，如 convert(10cm, mm)。</li>
<li>data-uri: 用于嵌入资源，data-uri(url, mimeType)。</li>
<li>unit: 可用于指定单位，unit(dimension, unit)。</li>
<li>get-unit: 可用于获取单位，如 get-unit(30px)。</li>
<li>svg-gradient: 可用于转换颜色，</li>
<li>if: 按条件返回指定的值，if(condition, value1, value2)，当 condition 成立时，返回 value1，否则返回 value2。</li>
</ol>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="selector-class">.style</span> &#123;</span><br><span class="line">  <span class="variable">@style:</span> orange, green <span class="number">30%</span>, <span class="number">#DAA520</span>;</span><br><span class="line">  <span class="attribute">background-image</span>: svg-gradient(ellipse, <span class="variable">@style</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="字符串函数"><a href="#字符串函数" class="headerlink" title="字符串函数"></a>字符串函数</h3><ol>
<li>escape: 对特殊字符使用URL编码来对字符串或信息进行编码。</li>
<li>e: 去除字符串的引号。</li>
<li>%: format 函数，用于转化字符串，如 %(string，arguments …)。</li>
<li>replace: 用于替换字符串，如 replace(string, pattern, replacement, flags)。</li>
</ol>
<h3 id="列表函数"><a href="#列表函数" class="headerlink" title="列表函数"></a>列表函数</h3><ol>
<li>length: 用于获取列表的长度，如 @list: “audi”, “benz”, “toyota”, “honda”; length(@list)。</li>
<li>extract: 用于获取列表中指定位置的值，如 @list: “audi”, “benz”, “toyota”, “honda”; length(@list, 2)。</li>
</ol>
<h3 id="数学函数"><a href="#数学函数" class="headerlink" title="数学函数"></a>数学函数</h3><ol>
<li>ceil: 向上取整。</li>
<li>floor: 向下取整。</li>
<li>percentage: 将浮点数转换为百分比字符串。</li>
<li>round: 四舍五入。</li>
<li>sqrt: 获取平方根。</li>
<li>abs: 取绝对值，如 abs(30ft) 将获得 30ft。</li>
<li>sin, asin, cos, acos, tan, atan: 计算正弦、反正弦等。</li>
<li>pi: 返回 pi 的值。</li>
<li>pow: 计算幂。</li>
<li>mod: 计算首参相对次参的模。</li>
<li>min: 计算最小值，如 min(70,30,45,20)。</li>
<li>max: 计算最大值。</li>
</ol>
<h3 id="类型函数"><a href="#类型函数" class="headerlink" title="类型函数"></a>类型函数</h3><p>类型函数包含 iscolor, isnumber, isstring, iskeyword, isurl, ispixel, ispercentage, isem, isunit, isruleset，返回布尔值。</p>
<h3 id="颜色定义函数"><a href="#颜色定义函数" class="headerlink" title="颜色定义函数"></a>颜色定义函数</h3><p>颜色定义函数包含 rgb(red, green, blue), rgba(red, green, blue, alpha), argb, hsl, hsla, hsv, hsva，具体可以参看 <a href="https://www.w3cschool.cn/less/less_color_defination_functions.html" target="_blank" rel="noopener">Less 颜色定义函数</a>。</p>
<h3 id="颜色通道函数"><a href="#颜色通道函数" class="headerlink" title="颜色通道函数"></a>颜色通道函数</h3><ol>
<li>hue: 在 HSL 颜色空间中，提取颜色对象的色调通道。</li>
<li>saturation: 在 HSL 颜色空间中，提取彩色对象的饱和通道。</li>
<li>lightness: 在 HSL 颜色空间中，从颜色对象提取亮度通道。</li>
<li>hsvhue: 在 HSV 色彩空间中，提取色彩对象的色调通道。</li>
<li>hsvsaturation: 在 HSL 颜色空间中，提取彩色对象的饱和通道。</li>
<li>hsvvalue: 在 HSL 颜色空间中，提取颜色对象的值通道。</li>
<li>red: 提取彩色对象的红色通道。</li>
<li>green: 提取彩色对象的绿色通道。</li>
<li>blue: 提取彩色对象的蓝色通道。</li>
<li>alpha: 提取颜色对象的 alpha 通道。</li>
<li>luma: 计算颜色对象的亮度值。</li>
<li>luminance: 在没有伽马校正的情况下计算亮度值。</li>
</ol>
<h3 id="颜色操作函数"><a href="#颜色操作函数" class="headerlink" title="颜色操作函数"></a>颜色操作函数</h3><ol>
<li>saturate: 改变颜色的强度或饱和度，如 saturate(color, amount)。</li>
<li>desaturate: 降低颜色的强度或饱和度。</li>
<li>lighten: 增加颜色的亮度，如 lighten(color, amount)。</li>
<li>darken: 降低颜色的亮度。</li>
<li>fadein: 增加颜色的不透明度，如 fadein(color, amount)。</li>
<li>fadeout: 降低颜色的不透明度。</li>
<li>fade: 设置颜色的不透明度，如 fade(color, amount)。</li>
<li>spin: 旋转颜色的角度，如 spin(color, angle)。</li>
<li>mix: 混合两种颜色以及不透明度，如 mix(color1, color2, weight)，参数 weight 为权重。</li>
<li>tint: 混合颜色和白色，如 tint(color, weight)。</li>
<li>shade: 混合颜色和黑色。</li>
<li>greyscale: 丢弃颜色的饱和度，如 greyscale(color)。</li>
<li>contrast: 设置颜色的对比度，如 contrast(color, dark, light, amount)。</li>
</ol>
<h3 id="颜色混合函数"><a href="#颜色混合函数" class="headerlink" title="颜色混合函数"></a>颜色混合函数</h3><ol>
<li>multiply: 两种RGB通道颜色相乘，然后除以 255 以得到较暗的颜色作为结果。</li>
<li>screen: 获取两种颜色中更明亮的颜色。</li>
<li>overlay: 结合 multiply, screen 的效果生成结果，使光通道更轻，暗通道更暗。</li>
<li>softlight: 工作方式类似于 overlay 函数，但它仅使用颜色的一部分，其中柔和地突出显示其他颜色。</li>
<li>hardlight: 与 overlay 函数类似，但颜色的作用相反。 它使用第二个参数执行 overlay()函数，以确定是否应该执行乘法或屏幕操作。</li>
<li>difference: 从首参颜色中减去次参颜色，负值将反转。</li>
<li>exclusion: 类似于 difference 函数，但具有较低的对比度。</li>
<li>average: 计算两种颜色的均值。</li>
<li>negation: 与 difference 函数相反，从次参颜色减去首参颜色。</li>
</ol>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://lesscss.cn/features/" target="_blank" rel="noopener">less 语言特性</a><br><a href="https://www.w3cschool.cn/less/" target="_blank" rel="noopener">less 教程</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/11/antd/Input/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/11/antd/Input/" itemprop="url">antd-Input 组件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-11T00:00:00+08:00">2018-11-11</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/antd-组件库/" itemprop="url" rel="index"><span itemprop="name">antd 组件库</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/11/antd/Input/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/11/antd/Input/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Input-组件"><a href="#Input-组件" class="headerlink" title="Input 组件"></a>Input 组件</h2><p>Input 组件只关乎布局，其余均为常规处理。props.addonBefore 为前置标签，props.addonAfter 为后置标签，props.prefix 前缀图标，props.suffix 后缀图标。参看官方图例：</p>
<img src="/2018/11/11/antd/Input/Input组件布局.png">
<p>Input 组件在 render 方法执行阶段将绘制出 input 原生组件。鉴于 react 的实现机制，对于 input 原生组件的处理，有受控组件和非手空组件的区别。受控组件即根据组件的 state 变化渲染 input 节点的值，非受控组件只允许组件渲染出 input 节点的默认值，而其实时值将根据用户的操作行为加以改变。ant design 中的 Input 组件对于受控组件和非受控组件的处理，即是当开发者同时传入 props.value 和 props.defaultValue，props.value 的优先级高于 props.defaultValue，且当 props.value 为 undefined 或 null，均会以空字符串渲染 input 节点的值。</p>
<p>在事件的绑定函数方面，常规的绑定函数均会透传到 input 原生组件上，而 props.onPressEnter, props.onKeyDown 两个绑定函数均会以 inputInstance.handleKeyDown 方法的形式挂载为 input 原生组件的 onKeyDown 绑定函数（inputInstance 为 Input 组件的实例）。</p>
<p>此外，inputInstance 实例内置 focus, blur, select 方法，其功用如 inputInstance.focus 可以在校验表单时使校验失败的输入框组件获得焦点。inputInstance.input 属性用于访问 input 原生节点。</p>
<p>在样式处理方面，笔者将作专文加以阐述。</p>
<h2 id="TextArea-组件"><a href="#TextArea-组件" class="headerlink" title="TextArea 组件"></a>TextArea 组件</h2><p>TextArea 组件用于绘制 textarea 原生节点。不同于使用前后标签、前后图标影响渲染输入框组件的布局，TextArea 组件只包含 textarea 节点，没有其他布局元素。</p>
<p>TextArea 组件的特殊处理逻辑是，textarea 节点的高度随用户输入内容而改变，受控于 props.autosize = { minRows?, maxRows? } 属性。其实现原理为：</p>
<ol>
<li>使用插入文档的隐藏文本框节点计算单行文本的高度，再由 minRows, maxRows 计算文本框的最大最小高度，并计算文本框的高度。计算获得的文本框即 textareaStyles 变量。</li>
<li>调用组件实例的 setState 方法，更新 state.textareaStyles，最终构成组件实例的 resizeTextarea 方法。对于受控组件，将在componentWillReceiveProps 生命周期中判断组件获得的 props.value 是否更新，再使用 window.requestAnimationFrame 方式调用 resizeTextarea 方法，以调整文本框的高度。对于非受控组件，在 onChange 事件发生时调用 resizeTextarea 方法。</li>
</ol>
<p>calculateNodeHeight 函数计算文本框高度源码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> HIDDEN_TEXTAREA_STYLE = <span class="string">`</span></span><br><span class="line"><span class="string">  min-height:0 !important;</span></span><br><span class="line"><span class="string">  max-height:none !important;</span></span><br><span class="line"><span class="string">  height:0 !important;</span></span><br><span class="line"><span class="string">  visibility:hidden !important;</span></span><br><span class="line"><span class="string">  overflow:hidden !important;</span></span><br><span class="line"><span class="string">  position:absolute !important;</span></span><br><span class="line"><span class="string">  z-index:-1000 !important;</span></span><br><span class="line"><span class="string">  top:0 !important;</span></span><br><span class="line"><span class="string">  right:0 !important</span></span><br><span class="line"><span class="string">`</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> SIZING_STYLE = [</span><br><span class="line">  <span class="string">'letter-spacing'</span>,</span><br><span class="line">  <span class="string">'line-height'</span>,</span><br><span class="line">  <span class="string">'padding-top'</span>,</span><br><span class="line">  <span class="string">'padding-bottom'</span>,</span><br><span class="line">  <span class="string">'font-family'</span>,</span><br><span class="line">  <span class="string">'font-weight'</span>,</span><br><span class="line">  <span class="string">'font-size'</span>,</span><br><span class="line">  <span class="string">'text-rendering'</span>,</span><br><span class="line">  <span class="string">'text-transform'</span>,</span><br><span class="line">  <span class="string">'width'</span>,</span><br><span class="line">  <span class="string">'text-indent'</span>,</span><br><span class="line">  <span class="string">'padding-left'</span>,</span><br><span class="line">  <span class="string">'padding-right'</span>,</span><br><span class="line">  <span class="string">'border-width'</span>,</span><br><span class="line">  <span class="string">'box-sizing'</span>,</span><br><span class="line">];</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> computedStyleCache: &#123;[key: string]: NodeType&#125; = &#123;&#125;;</span><br><span class="line"><span class="keyword">let</span> hiddenTextarea: HTMLTextAreaElement;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">calculateNodeStyling</span>(<span class="params">node: HTMLElement, useCache = false</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> nodeRef = (</span><br><span class="line">    node.getAttribute(<span class="string">'id'</span>) ||</span><br><span class="line">    node.getAttribute(<span class="string">'data-reactid'</span>) ||</span><br><span class="line">    node.getAttribute(<span class="string">'name'</span>)</span><br><span class="line">  ) <span class="keyword">as</span> string;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (useCache &amp;&amp; computedStyleCache[nodeRef]) &#123;</span><br><span class="line">    <span class="keyword">return</span> computedStyleCache[nodeRef];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> style = <span class="built_in">window</span>.getComputedStyle(node);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> boxSizing = (</span><br><span class="line">    style.getPropertyValue(<span class="string">'box-sizing'</span>) ||</span><br><span class="line">    style.getPropertyValue(<span class="string">'-moz-box-sizing'</span>) ||</span><br><span class="line">    style.getPropertyValue(<span class="string">'-webkit-box-sizing'</span>)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> paddingSize = (</span><br><span class="line">    <span class="built_in">parseFloat</span>(style.getPropertyValue(<span class="string">'padding-bottom'</span>)) +</span><br><span class="line">    <span class="built_in">parseFloat</span>(style.getPropertyValue(<span class="string">'padding-top'</span>))</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> borderSize = (</span><br><span class="line">    <span class="built_in">parseFloat</span>(style.getPropertyValue(<span class="string">'border-bottom-width'</span>)) +</span><br><span class="line">    <span class="built_in">parseFloat</span>(style.getPropertyValue(<span class="string">'border-top-width'</span>))</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> sizingStyle = SIZING_STYLE</span><br><span class="line">    .map(<span class="function"><span class="params">name</span> =&gt;</span> <span class="string">`<span class="subst">$&#123;name&#125;</span>:<span class="subst">$&#123;style.getPropertyValue(name)&#125;</span>`</span>)</span><br><span class="line">    .join(<span class="string">';'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> nodeInfo: NodeType = &#123;</span><br><span class="line">    sizingStyle,</span><br><span class="line">    paddingSize,</span><br><span class="line">    borderSize,</span><br><span class="line">    boxSizing,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (useCache &amp;&amp; nodeRef) &#123;</span><br><span class="line">    computedStyleCache[nodeRef] = nodeInfo;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> nodeInfo;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">calculateNodeHeight</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  uiTextNode: HTMLTextAreaElement,</span></span></span><br><span class="line"><span class="function"><span class="params">  useCache = false,</span></span></span><br><span class="line"><span class="function"><span class="params">  minRows: number | null = null,</span></span></span><br><span class="line"><span class="function"><span class="params">  maxRows: number | null = null,</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!hiddenTextarea) &#123;</span><br><span class="line">    hiddenTextarea = <span class="built_in">document</span>.createElement(<span class="string">'textarea'</span>);</span><br><span class="line">    <span class="built_in">document</span>.body.appendChild(hiddenTextarea);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Fix wrap="off" issue</span></span><br><span class="line">  <span class="comment">// https://github.com/ant-design/ant-design/issues/6577</span></span><br><span class="line">  <span class="keyword">if</span> (uiTextNode.getAttribute(<span class="string">'wrap'</span>)) &#123;</span><br><span class="line">    hiddenTextarea.setAttribute(<span class="string">'wrap'</span>, uiTextNode.getAttribute(<span class="string">'wrap'</span>) <span class="keyword">as</span> string);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    hiddenTextarea.removeAttribute(<span class="string">'wrap'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将影响文本框节点高度的样式属性拷贝给隐藏节点</span></span><br><span class="line">  <span class="comment">// overflow 样式属性置为 hidden，以此将滚动条排除在外</span></span><br><span class="line">  <span class="keyword">let</span> &#123;</span><br><span class="line">    paddingSize, borderSize,</span><br><span class="line">    boxSizing, sizingStyle,</span><br><span class="line">  &#125; = calculateNodeStyling(uiTextNode, useCache);</span><br><span class="line">  hiddenTextarea.setAttribute(<span class="string">'style'</span>, <span class="string">`<span class="subst">$&#123;sizingStyle&#125;</span>;<span class="subst">$&#123;HIDDEN_TEXTAREA_STYLE&#125;</span>`</span>);</span><br><span class="line">  hiddenTextarea.value = uiTextNode.value || uiTextNode.placeholder || <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> minHeight = <span class="built_in">Number</span>.MIN_SAFE_INTEGER;</span><br><span class="line">  <span class="keyword">let</span> maxHeight = <span class="built_in">Number</span>.MAX_SAFE_INTEGER;</span><br><span class="line">  <span class="keyword">let</span> height = hiddenTextarea.scrollHeight;<span class="comment">// 以隐藏节点计算文本框高度</span></span><br><span class="line">  <span class="keyword">let</span> overflowY: any;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据盒模式调整高度</span></span><br><span class="line">  <span class="keyword">if</span> (boxSizing === <span class="string">'border-box'</span>) &#123;</span><br><span class="line">    height = height + borderSize;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (boxSizing === <span class="string">'content-box'</span>) &#123;</span><br><span class="line">    height = height - paddingSize;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (minRows !== <span class="literal">null</span> || maxRows !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// 计算文本框单行高度</span></span><br><span class="line">    hiddenTextarea.value = <span class="string">' '</span>;</span><br><span class="line">    <span class="keyword">let</span> singleRowHeight = hiddenTextarea.scrollHeight - paddingSize;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (minRows !== <span class="literal">null</span>) &#123;</span><br><span class="line">      minHeight = singleRowHeight * minRows;</span><br><span class="line">      <span class="keyword">if</span> (boxSizing === <span class="string">'border-box'</span>) &#123;</span><br><span class="line">        minHeight = minHeight + paddingSize + borderSize;</span><br><span class="line">      &#125;</span><br><span class="line">      height = <span class="built_in">Math</span>.max(minHeight, height);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (maxRows !== <span class="literal">null</span>) &#123;</span><br><span class="line">      maxHeight = singleRowHeight * maxRows;</span><br><span class="line">      <span class="keyword">if</span> (boxSizing === <span class="string">'border-box'</span>) &#123;</span><br><span class="line">        maxHeight = maxHeight + paddingSize + borderSize;</span><br><span class="line">      &#125;</span><br><span class="line">      overflowY = height &gt; maxHeight ? <span class="string">''</span> : <span class="string">'hidden'</span>;</span><br><span class="line">      height = <span class="built_in">Math</span>.min(maxHeight, height);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!maxRows) &#123;</span><br><span class="line">    overflowY = <span class="string">'hidden'</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> &#123; height, minHeight, maxHeight, overflowY &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>setState 更新文本框高度源码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 不打断本次渲染，在下一次渲染调整文本框的样式</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">onNextFrame</span>(<span class="params">cb: (</span>) =&gt; <span class="title">void</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">window</span>.requestAnimationFrame) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">window</span>.requestAnimationFrame(cb);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">window</span>.setTimeout(cb, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clearNextFrameAction</span>(<span class="params">nextFrameId: number</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">window</span>.cancelAnimationFrame) &#123;</span><br><span class="line">    <span class="built_in">window</span>.cancelAnimationFrame(nextFrameId);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">window</span>.clearTimeout(nextFrameId);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">TextArea</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span>&lt;<span class="title">TextAreaProps</span>, <span class="title">TextAreaState</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> defaultProps = &#123;</span><br><span class="line">    prefixCls: <span class="string">'ant-input'</span>,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  nextFrameActionId: number;</span><br><span class="line"></span><br><span class="line">  state = &#123;</span><br><span class="line">    textareaStyles: &#123;&#125;,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">this</span>.resizeTextarea();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  componentWillReceiveProps(nextProps: TextAreaProps) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.props.value !== nextProps.value) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">this</span>.nextFrameActionId) &#123;</span><br><span class="line">        clearNextFrameAction(<span class="keyword">this</span>.nextFrameActionId);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.nextFrameActionId = onNextFrame(<span class="keyword">this</span>.resizeTextarea);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  resizeTextarea = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; autosize &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">if</span> (!autosize || !<span class="keyword">this</span>.textAreaRef) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> minRows = autosize ? (autosize <span class="keyword">as</span> AutoSizeType).minRows : <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">const</span> maxRows = autosize ? (autosize <span class="keyword">as</span> AutoSizeType).maxRows : <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">const</span> textareaStyles = calculateNodeHeight(<span class="keyword">this</span>.textAreaRef, <span class="literal">false</span>, minRows, maxRows);</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; textareaStyles &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleTextareaChange = <span class="function">(<span class="params">e: React.ChangeEvent&lt;HTMLTextAreaElement&gt;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!(<span class="string">'value'</span> <span class="keyword">in</span> <span class="keyword">this</span>.props)) &#123;</span><br><span class="line">      <span class="keyword">this</span>.resizeTextarea();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> &#123; onChange &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">if</span> (onChange) &#123;</span><br><span class="line">      onChange(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 余略</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Search"><a href="#Search" class="headerlink" title="Search"></a>Search</h2><p>Search 组件基于 Input 组件制作，其特殊处理是在 inputInstance.onPressEnter 方法执行过程中调用 props.onSearch 方法，适用于远程搜索之类的场景；Search 组件还提供 props.enterButton 属性用于配置输入框的后缀图标，默认使用 search 图标，可渲染文本或按钮。实现请参考 ant design 源码。</p>
<h2 id="Group"><a href="#Group" class="headerlink" title="Group"></a>Group</h2><p>Group 组件主要以样式控制多个表单项组件 props.children 的成组渲染。实现请参考 ant design 源码。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/11/工程化/http-proxy-middleware源码解读/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/11/工程化/http-proxy-middleware源码解读/" itemprop="url">http-proxy-middleware 源码解读</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-11T00:00:00+08:00">2018-11-11</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端工程化/" itemprop="url" rel="index"><span itemprop="name">前端工程化</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/11/工程化/http-proxy-middleware源码解读/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/11/工程化/http-proxy-middleware源码解读/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>http-proxy-middleware 库借助于 <a href="http://xzfyu.com/2018/11/09/%E5%B7%A5%E7%A8%8B%E5%8C%96/node-http-proxy%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" target="_blank" rel="noopener">node-http-proxy</a>，用于将 node 服务器接收到的请求转发到目标服务器，实现代理服务器的功能。</p>
<h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><p>可以推想，使用 node-http-proxy 创建代理服务器 proxyServer 后，通过全局注册的转发规则获取到客户端请求 req 需要发送到的目标地址，再通过调用 proxyServer.web, proxyServer.ws 方法转发请求。</p>
<h3 id="转发规则"><a href="#转发规则" class="headerlink" title="转发规则"></a>转发规则</h3><p>从原理层面简单的归纳转发规则，就是客户端请求路径到目标服务器地址的映射关系。node-http-proxy 库将转发规则分为两部分加以配置，context 用于匹配需要转发的客户端请求，options.target 用于设定目标服务器的 host；option.router 根据客户端请求重新设定目标服务器的 host（这样，根据不同的请求，可以设定多个目标服务器）；option.pathRewrite 用于辅助将客户端请求路径转化为目标服务器地址。</p>
<h4 id="context"><a href="#context" class="headerlink" title="context"></a>context</h4><p>context 表示待转发请求的目录名。当客户端请求以 context 起始时，则该请求将被转发。如 context 设置为 ‘/api’，客户端所有以 ‘/api’ 起始的请求都会被转发；默认值为 ‘/‘，意为客户端发送的所有请求都会被转发。node-http-proxy 库使用 createConfig 解析获得 context；matchContext 函数校验客户端请求是否需要转发。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析获取 context，需要代理的请求 url 前缀</span></span><br><span class="line"><span class="comment"> * @param &#123;string|object|function&#125; context 作为 HttpProxyMiddleware 接口传入 createConfig 函数的参数</span></span><br><span class="line"><span class="comment"> * @param &#123;undefined|object&#125; opts 作为 HttpProxyMiddleware 接口传入 createConfig 函数的参数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createConfig</span> (<span class="params">context, opts</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> config = &#123;</span><br><span class="line">    context: <span class="literal">undefined</span>,</span><br><span class="line">    options: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// context 作为 opts 传入，config.context 使用默认值</span></span><br><span class="line">  <span class="keyword">if</span> (isContextless(context, opts)) &#123;</span><br><span class="line">    config.context = <span class="string">'/'</span></span><br><span class="line">    config.options = _.assign(config.options, context)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// context 以 url 形式配置，可同时配置 context, options.target</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isStringShortHand(context)) &#123;</span><br><span class="line">    <span class="keyword">var</span> oUrl = url.parse(context)</span><br><span class="line">    <span class="keyword">var</span> target = [oUrl.protocol, <span class="string">'//'</span>, oUrl.host].join(<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line">    config.context = oUrl.pathname || <span class="string">'/'</span></span><br><span class="line">    config.options = _.assign(config.options, &#123; <span class="attr">target</span>: target &#125;, opts)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oUrl.protocol === <span class="string">'ws:'</span> || oUrl.protocol === <span class="string">'wss:'</span>) &#123;</span><br><span class="line">      config.options.ws = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    config.context = context</span><br><span class="line">    config.options = _.assign(config.options, opts)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 配置 Logger 实例</span></span><br><span class="line">  configureLogger(config.options)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!config.options.target) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(ERRORS.ERR_CONFIG_FACTORY_TARGET_MISSING)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> config</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析获取 context，需要代理的请求 url 前缀</span></span><br><span class="line"><span class="comment"> * @param &#123;string|function&#125; context 需要代理的请求 url 前缀</span></span><br><span class="line"><span class="comment"> * @param &#123;object&#125; uri 客户端请求的 uri，即 req.originalUrl 或 req.url</span></span><br><span class="line"><span class="comment"> * @param &#123;object&#125; req 客户端请求 req</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">matchContext</span> (<span class="params">context, uri, req</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// context 为字符串路径，校验 url 是否以 context 起始</span></span><br><span class="line">  <span class="keyword">if</span> (isStringPath(context)) &#123;</span><br><span class="line">    <span class="keyword">return</span> matchSingleStringPath(context, uri)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// context 为 glob 模式的字符串路径（通过 is-glob 模块判断），校验  url 是否匹配 context（通过 micromatch 判断）</span></span><br><span class="line">  <span class="comment">// [glob 介绍](https://blog.csdn.net/Free_Wind22/article/details/78344166)</span></span><br><span class="line">  <span class="keyword">if</span> (isGlobPath(context)) &#123;</span><br><span class="line">    <span class="keyword">return</span> matchSingleGlobPath(context, uri)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 遍历 context，调用 matchSingleStringPath, matchSingleGlobPath 作校验</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(context)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (context.every(isStringPath)) &#123;</span><br><span class="line">      <span class="keyword">return</span> matchMultiPath(context, uri)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (context.every(isGlobPath)) &#123;</span><br><span class="line">      <span class="keyword">return</span> matchMultiGlobPath(context, uri)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(ERRORS.ERR_CONTEXT_MATCHER_INVALID_ARRAY)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// context 自定义函数，用于校验客户端请求是否需要转发</span></span><br><span class="line">  <span class="keyword">if</span> (_.isFunction(context)) &#123;</span><br><span class="line">    <span class="keyword">var</span> pathname = getUrlPathName(uri)</span><br><span class="line">    <span class="keyword">return</span> context(pathname, req)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(ERRORS.ERR_CONTEXT_MATCHER_GENERIC)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="target"><a href="#target" class="headerlink" title="target"></a>target</h4><p>target 表示目标服务器的 host。在 createConfig 函数的源码中，可以看到，target 即能通过 url 形式的 context 设定，又能通过 options.target 选项设定。当然，这样是作为全局配置设定的；同 node-http-proxy 库，http-proxy-middleware 也可以在具体的请求发生时作特殊处理。这后半分的内容，是通过全局配置 options.router 达成的。在 http-proxy-middleware 处理客户端请求的过程中，getTarget 函数将通过 options.router 获取目标服务器的 host。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取目标服务器的 host</span></span><br><span class="line"><span class="comment"> * @param &#123;object&#125; req 客户端请求 req</span></span><br><span class="line"><span class="comment"> * @param &#123;object&#125; config 即 HttpProxyMiddleware 接口的 options 参数，获取 options.router</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTarget</span> (<span class="params">req, config</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> newTarget</span><br><span class="line">  <span class="keyword">var</span> router = config.router</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (_.isPlainObject(router)) &#123;</span><br><span class="line">    newTarget = getTargetFromProxyTable(req, router)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_.isFunction(router)) &#123;</span><br><span class="line">    newTarget = router(req)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> newTarget</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTargetFromProxyTable</span> (<span class="params">req, table</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> result</span><br><span class="line">  <span class="keyword">var</span> host = req.headers.host</span><br><span class="line">  <span class="keyword">var</span> path = req.url</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> hostAndPath = host + path<span class="comment">// 客户端请求路径</span></span><br><span class="line"></span><br><span class="line">  _.forIn(table, <span class="function"><span class="keyword">function</span> (<span class="params">value, key</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// containsPath(str) 函数，判断 str 是否包含 '/'</span></span><br><span class="line">    <span class="keyword">if</span> (containsPath(key)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (hostAndPath.indexOf(key) &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">        result = table[key]</span><br><span class="line">        logger.debug(<span class="string">'[HPM] Router table match: "%s"'</span>, key)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (key === host) &#123;</span><br><span class="line">        result = table[key]</span><br><span class="line">        logger.debug(<span class="string">'[HPM] Router table match: "%s"'</span>, host)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="pathRewrite"><a href="#pathRewrite" class="headerlink" title="pathRewrite"></a>pathRewrite</h4><p>在 http-proxy-middleware 库中，options.pathRewrite 用于将客户端请求路径转化为目标服务器的路径（pathname 部分），既可以是 map 映射，也可以函数。createPathRewriter 函数将根据 options.pathRewrite 生成路径转化器 pathRewriter 函数；而 pathRewriter 用于将实际的客户端请求地址转化为目标服务器的路径。当 options.pathRewrite 为对象 key-value 时，pathRewriter 将把匹配 key 的客户端请求转化为 value 路径；当 options.pathRewrite 为函数时，将由客户端请求 req.url 获取目标服务器路径。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成 pathRewriter 函数</span></span><br><span class="line"><span class="comment"> * @param &#123;object|function&#125; rewriteConfig 即 HttpProxyMiddleware 接口的 options.pathRewrite 配置项</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createPathRewriter</span> (<span class="params">rewriteConfig</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> rulesCache</span><br><span class="line"></span><br><span class="line">  <span class="comment">// isValidRewriteConfig 函数用于校验 options.pathRewrite</span></span><br><span class="line">  <span class="keyword">if</span> (!isValidRewriteConfig(rewriteConfig)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (_.isFunction(rewriteConfig)) &#123;</span><br><span class="line">    <span class="keyword">var</span> customRewriteFn = rewriteConfig</span><br><span class="line">    <span class="keyword">return</span> customRewriteFn</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    rulesCache = parsePathRewriteRules(rewriteConfig)</span><br><span class="line">    <span class="keyword">return</span> rewritePath</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 参数 path 为 req.url</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">rewritePath</span> (<span class="params">path</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = path</span><br><span class="line"></span><br><span class="line">    _.forEach(rulesCache, <span class="function"><span class="keyword">function</span> (<span class="params">rule</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (rule.regex.test(path)) &#123;</span><br><span class="line">        result = result.replace(rule.regex, rule.value)</span><br><span class="line">        logger.debug(<span class="string">'[HPM] Rewriting path from "%s" to "%s"'</span>, path, result)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parsePathRewriteRules</span> (<span class="params">rewriteConfig</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> rules = []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (_.isPlainObject(rewriteConfig)) &#123;</span><br><span class="line">    _.forIn(rewriteConfig, <span class="function"><span class="keyword">function</span> (<span class="params">value, key</span>) </span>&#123;</span><br><span class="line">      rules.push(&#123;</span><br><span class="line">        regex: <span class="keyword">new</span> <span class="built_in">RegExp</span>(key),</span><br><span class="line">        value: rewriteConfig[key]</span><br><span class="line">      &#125;)</span><br><span class="line">      logger.info(<span class="string">'[HPM] Proxy rewrite rule created: "%s" ~&gt; "%s"'</span>, key, rewriteConfig[key])</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> rules</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="整体流程"><a href="#整体流程" class="headerlink" title="整体流程"></a>整体流程</h3><p>这部分将串联转发规则的解析和应用，是为 http-proxy-middleware 库的整体工作流程。</p>
<ol>
<li>解析 context，options 配置，获得全局注册的 context, options.target；并配置 Logger 实例。</li>
<li>使用 node-http-proxy 库常见代理服务器 proxy。</li>
<li>根据 options.pathRewrite 生成路径转化器 pathRewriter。</li>
<li>为代理服务器绑定事件。</li>
<li>创建转发 http, https, websocket 请求的代理中间件。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">HttpProxyMiddleware</span> (<span class="params">context, opts</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// https://github.com/chimurai/http-proxy-middleware/issues/57</span></span><br><span class="line">  <span class="keyword">var</span> wsUpgradeDebounced = _.debounce(handleUpgrade)</span><br><span class="line">  <span class="keyword">var</span> wsInitialized = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">var</span> config = configFactory.createConfig(context, opts)</span><br><span class="line">  <span class="keyword">var</span> proxyOptions = config.options</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> proxy = httpProxy.createProxyServer(&#123;&#125;)</span><br><span class="line">  logger.info(<span class="string">'[HPM] Proxy created:'</span>, config.context, <span class="string">' -&gt; '</span>, proxyOptions.target)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> pathRewriter = PathRewriter.create(proxyOptions.pathRewrite)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 为代理服务器绑定事件</span></span><br><span class="line">  handlers.init(proxy, proxyOptions)</span><br><span class="line"></span><br><span class="line">  proxy.on(<span class="string">'error'</span>, logError)</span><br><span class="line"></span><br><span class="line">  middleware.upgrade = wsUpgradeDebounced</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> middleware</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 实际的代理中间件</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">middleware</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (shouldProxy(config.context, req)) &#123;</span><br><span class="line">      <span class="keyword">var</span> activeProxyOptions = prepareProxyRequest(req)</span><br><span class="line">      proxy.web(req, res, activeProxyOptions)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      next()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (proxyOptions.ws === <span class="literal">true</span>) &#123;</span><br><span class="line">      catchUpgradeRequest(req.connection.server)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">catchUpgradeRequest</span> (<span class="params">server</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!wsInitialized) &#123;</span><br><span class="line">      server.on(<span class="string">'upgrade'</span>, wsUpgradeDebounced)</span><br><span class="line">      wsInitialized = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 转发 websocket 请求</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleUpgrade</span> (<span class="params">req, socket, head</span>) </span>&#123;</span><br><span class="line">    wsInitialized = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shouldProxy(config.context, req)) &#123;</span><br><span class="line">      <span class="keyword">var</span> activeProxyOptions = prepareProxyRequest(req)</span><br><span class="line">      proxy.ws(req, socket, head, activeProxyOptions)</span><br><span class="line">      logger.info(<span class="string">'[HPM] Upgrading to WebSocket'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断请求是否需要转发</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">shouldProxy</span> (<span class="params">context, req</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> path = (req.originalUrl || req.url)</span><br><span class="line">    <span class="keyword">return</span> contextMatcher.match(context, path, req)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 转发请求</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">prepareProxyRequest</span> (<span class="params">req</span>) </span>&#123;</span><br><span class="line">    req.url = (req.originalUrl || req.url)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> originalPath = req.url</span><br><span class="line">    <span class="keyword">var</span> newProxyOptions = _.assign(&#123;&#125;, proxyOptions)</span><br><span class="line"></span><br><span class="line">    __applyRouter(req, newProxyOptions)</span><br><span class="line">    __applyPathRewrite(req, pathRewriter)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (proxyOptions.logLevel === <span class="string">'debug'</span>) &#123;</span><br><span class="line">      <span class="comment">// getArrow 返回的标识，用于区分 options.router, options.pathRewrite 的作用与否</span></span><br><span class="line">      <span class="comment">// '-&gt;' options.router, options.pathRewrite 均未作用</span></span><br><span class="line">      <span class="comment">// '=&gt;' options.router 作用, options.pathRewrite 未作用</span></span><br><span class="line">      <span class="comment">// '~&gt;' options.router 未作用, options.pathRewrite 作用</span></span><br><span class="line">      <span class="comment">// '≈&gt;' options.router, options.pathRewrite 均作用</span></span><br><span class="line">      <span class="keyword">var</span> arrow = getArrow(originalPath, req.url, proxyOptions.target, newProxyOptions.target)</span><br><span class="line">      logger.debug(<span class="string">'[HPM] %s %s %s %s'</span>, req.method, originalPath, arrow, newProxyOptions.target)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> newProxyOptions</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据请求获取目标服务器的 host</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__applyRouter</span> (<span class="params">req, options</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> newTarget</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.router) &#123;</span><br><span class="line">      newTarget = Router.getTarget(req, options)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (newTarget) &#123;</span><br><span class="line">        logger.debug(<span class="string">'[HPM] Router new target: %s -&gt; "%s"'</span>, options.target, newTarget)</span><br><span class="line">        options.target = newTarget</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将目标服务器路径写入 req.url</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__applyPathRewrite</span> (<span class="params">req, pathRewriter</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pathRewriter) &#123;</span><br><span class="line">      <span class="keyword">var</span> path = pathRewriter(req.url, req)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> path === <span class="string">'string'</span>) &#123;</span><br><span class="line">        req.url = path</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logger.info(<span class="string">'[HPM] pathRewrite: No rewritten path found. (%s)'</span>, req.url)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">logError</span> (<span class="params">err, req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> hostname = (req.headers &amp;&amp; req.headers.host) || (req.hostname || req.host)</span><br><span class="line">    <span class="keyword">var</span> target = proxyOptions.target.host || proxyOptions.target</span><br><span class="line">    <span class="keyword">var</span> errorMessage = <span class="string">'[HPM] Error occurred while trying to proxy request %s from %s to %s (%s) (%s)'</span></span><br><span class="line">    <span class="keyword">var</span> errReference = <span class="string">'https://nodejs.org/api/errors.html#errors_common_system_errors'</span></span><br><span class="line"></span><br><span class="line">    logger.error(errorMessage, req.url, hostname, target, err.code, errReference)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><h4 id="logger"><a href="#logger" class="headerlink" title="logger"></a>logger</h4><p>http-proxy-middleware 库使用单例模式创建 Logger 实例，并提供 setProvider 函数切换打印日志的 console 函数；setLevel 方法用于设定日志级别；继而由 Logger 实例提供 log, error, info, warn, debug 方法，这些方法在调用过程都会校验当前执行的方法是否符合当前日志级别，同时会允许首参以 %s 设定占位符，以注入次参等。</p>
<p>因日志模块在 node 服务器中广为应用，这里贴出 http-proxy-middleware 库中的代码实现。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> loggerInstance</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> defaultProvider = &#123;</span><br><span class="line">  log: <span class="built_in">console</span>.log,</span><br><span class="line">  debug: <span class="built_in">console</span>.log, </span><br><span class="line">  info: <span class="built_in">console</span>.info,</span><br><span class="line">  warn: <span class="built_in">console</span>.warn,</span><br><span class="line">  error: <span class="built_in">console</span>.error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> LEVELS = &#123;</span><br><span class="line">  debug: <span class="number">10</span>,</span><br><span class="line">  info: <span class="number">20</span>,</span><br><span class="line">  warn: <span class="number">30</span>,</span><br><span class="line">  error: <span class="number">50</span>,</span><br><span class="line">  silent: <span class="number">80</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Logger</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> logLevel</span><br><span class="line">  <span class="keyword">var</span> provider</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> api = &#123;</span><br><span class="line">    log: log,</span><br><span class="line">    debug: debug,</span><br><span class="line">    info: info,</span><br><span class="line">    warn: warn,</span><br><span class="line">    error: error,</span><br><span class="line">    setLevel: <span class="function"><span class="keyword">function</span> (<span class="params">v</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (isValidLevel(v)) &#123;<span class="comment">// isValidLevel 校验 v 是否 debug, info, warn, error, slient 中的一个</span></span><br><span class="line">        logLevel = v</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    setProvider: <span class="function"><span class="keyword">function</span> (<span class="params">fn</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (fn &amp;&amp; isValidProvider(fn)) &#123;<span class="comment">// isValidProvider 校验 fn 是否函数</span></span><br><span class="line">        provider = fn(defaultProvider)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  init()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> api</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">init</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    api.setLevel(<span class="string">'info'</span>)</span><br><span class="line">    api.setProvider(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> defaultProvider</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">log</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    provider.log(_interpolate.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">debug</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (_showLevel(<span class="string">'debug'</span>)) &#123;</span><br><span class="line">      provider.debug(_interpolate.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">info</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (_showLevel(<span class="string">'info'</span>)) &#123;</span><br><span class="line">      provider.info(_interpolate.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">warn</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (_showLevel(<span class="string">'warn'</span>)) &#123;</span><br><span class="line">      provider.warn(_interpolate.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">error</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (_showLevel(<span class="string">'error'</span>)) &#123;</span><br><span class="line">      provider.error(_interpolate.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 校验调用的方法是否在当前允许的日志级别下</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_showLevel</span> (<span class="params">showLevel</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">var</span> currentLogLevel = LEVELS[logLevel]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (currentLogLevel &amp;&amp; (currentLogLevel &lt;= LEVELS[showLevel])) &#123;</span><br><span class="line">      result = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 参数转化，允许首参以 %s 形式设置占位符</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_interpolate</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> fn = _.spread(util.format)</span><br><span class="line">    <span class="keyword">var</span> result = fn(_.slice(<span class="built_in">arguments</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  getInstance: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!loggerInstance) &#123;</span><br><span class="line">      loggerInstance = <span class="keyword">new</span> Logger()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> loggerInstance</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="事件绑定"><a href="#事件绑定" class="headerlink" title="事件绑定"></a>事件绑定</h4><p>解析 options.onError, options.onProxyReq, options.onProxyReqWs, options.onProxyRes, options.onOpen, options.onClose，并绑定为代理服务器的事件。</p>
<p>默认的绑定函数为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// onError 绑定函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defaultErrorHandler</span> (<span class="params">err, req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> host = (req.headers &amp;&amp; req.headers.host)</span><br><span class="line">  <span class="keyword">var</span> code = err.code</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (res.writeHead &amp;&amp; !res.headersSent) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/HPE_INVALID/</span>.test(code)) &#123;</span><br><span class="line">      res.writeHead(<span class="number">502</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'ECONNRESET'</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'ENOTFOUND'</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'ECONNREFUSED'</span>:</span><br><span class="line">          res.writeHead(<span class="number">504</span>)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">default</span>: res.writeHead(<span class="number">500</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  res.end(<span class="string">'Error occured while trying to proxy to: '</span> + host + req.url)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// onClose 绑定函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logClose</span> (<span class="params">req, socket, head</span>) </span>&#123;</span><br><span class="line">  logger.info(<span class="string">'[HPM] Client disconnected'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><h3 id="webpack-dev-server"><a href="#webpack-dev-server" class="headerlink" title="webpack-dev-server"></a>webpack-dev-server</h3><p>webpack-dev-server 库会创建 express 服务器，其服务器代理的实现就是解析配置项，并挂载 http-proxy-middleware 中间件。主要逻辑在 features.proxy 方法中实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> features = &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  proxy: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (options.proxy) &#123;</span><br><span class="line">      <span class="comment">// 解析配置</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(options.proxy)) &#123;</span><br><span class="line">        options.proxy = <span class="built_in">Object</span>.keys(options.proxy).map(<span class="function">(<span class="params">context</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">let</span> proxyOptions;</span><br><span class="line">          <span class="keyword">const</span> correctedContext = context</span><br><span class="line">            .replace(<span class="regexp">/^\*$/</span>, <span class="string">'**'</span>)</span><br><span class="line">            .replace(<span class="regexp">/\/\*$/</span>, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">typeof</span> options.proxy[context] === <span class="string">'string'</span>) &#123;</span><br><span class="line">            proxyOptions = &#123;</span><br><span class="line">              context: correctedContext,</span><br><span class="line">              target: options.proxy[context]</span><br><span class="line">            &#125;;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            proxyOptions = <span class="built_in">Object</span>.assign(&#123;&#125;, options.proxy[context]);</span><br><span class="line">            proxyOptions.context = correctedContext;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 日志级别</span></span><br><span class="line">          proxyOptions.logLevel = proxyOptions.logLevel || <span class="string">'warn'</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">return</span> proxyOptions;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 获得 proxy 中间件</span></span><br><span class="line">      <span class="keyword">const</span> getProxyMiddleware = <span class="function">(<span class="params">proxyConfig</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> context = proxyConfig.context || proxyConfig.path;</span><br><span class="line">        <span class="keyword">if</span> (proxyConfig.target) &#123;</span><br><span class="line">          <span class="keyword">return</span> httpProxyMiddleware(context, proxyConfig);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 以配置项挂载多个中间件</span></span><br><span class="line">      options.proxy.forEach(<span class="function">(<span class="params">proxyConfigOrCallback</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> proxyConfig;</span><br><span class="line">        <span class="keyword">let</span> proxyMiddleware;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> proxyConfigOrCallback === <span class="string">'function'</span>) &#123;</span><br><span class="line">          proxyConfig = proxyConfigOrCallback();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          proxyConfig = proxyConfigOrCallback;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        proxyMiddleware = getProxyMiddleware(proxyConfig);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (proxyConfig.ws) &#123;</span><br><span class="line">          websocketProxies.push(proxyMiddleware);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        app.use(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">typeof</span> proxyConfigOrCallback === <span class="string">'function'</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> newProxyConfig = proxyConfigOrCallback();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (newProxyConfig !== proxyConfig) &#123;</span><br><span class="line">              proxyConfig = newProxyConfig;</span><br><span class="line">              proxyMiddleware = getProxyMiddleware(proxyConfig);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">const</span> bypass = <span class="keyword">typeof</span> proxyConfig.bypass === <span class="string">'function'</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">const</span> bypassUrl = (bypass &amp;&amp; proxyConfig.bypass(req, res, proxyConfig)) || <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 转发到本地服务器</span></span><br><span class="line">          <span class="keyword">if</span> (bypassUrl) &#123;</span><br><span class="line">            req.url = bypassUrl;</span><br><span class="line"></span><br><span class="line">            next();</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (proxyMiddleware) &#123;</span><br><span class="line">            <span class="keyword">return</span> proxyMiddleware(req, res, next);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            next();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/11/设计模式/适配器模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/11/设计模式/适配器模式/" itemprop="url">适配器模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-11T00:00:00+08:00">2018-11-11</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/设计模式/" itemprop="url" rel="index"><span itemprop="name">设计模式</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/11/设计模式/适配器模式/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/11/设计模式/适配器模式/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/09/工程化/node-http-proxy源码解读/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/09/工程化/node-http-proxy源码解读/" itemprop="url">node-http-proxy 源码解读</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-09T00:00:00+08:00">2018-11-09</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端工程化/" itemprop="url" rel="index"><span itemprop="name">前端工程化</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/09/工程化/node-http-proxy源码解读/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/09/工程化/node-http-proxy源码解读/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>node-http-proxy 模块用于转发 http 请求，其实现的大致原理为使用 http 或 https 模块搭建 node 代理服务器，将客户端发送的请求数据转发到目标服务器，再将响应输送到客户端。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="整体流程"><a href="#整体流程" class="headerlink" title="整体流程"></a>整体流程</h3><p>同 koa 的中间件机制相仿，node-http-proxy 模块内部组装任务队列，在请求转发的过程中，将任务队列中的处理函数逐个执行。处理函数的意义通常是封装消息头，当然，最后一个处理函数用于转发请求、输出响应。</p>
<p>同常见的 ajax 模块，node-http-proxy 模块接受全局配置的 options，同时，在某个具体的请求中，又接受特定的配置项 opts。而客户端发送的请求可能是 http, https 请求，也可能是 websocket 请求，node-http-proxy 模块必须实现对这两类请求的不同处理。</p>
<p>上述三点，实际的代码体现在 createRightProxy 高阶函数中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数 type 用于区分请求类型，'web' 为普通 http, https 请求，'ws' 为 websocket 请求</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createRightProxy</span>(<span class="params">type</span>) </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 参数 options 为全局配置项</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">req, res <span class="regexp">/*, [head], [opts] */</span></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// passes 任务队列</span></span><br><span class="line">      <span class="keyword">var</span> passes = (type === <span class="string">'ws'</span>) ? <span class="keyword">this</span>.wsPasses : <span class="keyword">this</span>.webPasses,</span><br><span class="line">          args = [].slice.call(<span class="built_in">arguments</span>),</span><br><span class="line">          cntr = args.length - <span class="number">1</span>,</span><br><span class="line">          head, cbl;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 解析回调函数</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="keyword">typeof</span> args[cntr] === <span class="string">'function'</span>) &#123;</span><br><span class="line">        cbl = args[cntr];</span><br><span class="line">        cntr--;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 混入该请求中特定的配置项 opts</span></span><br><span class="line">      <span class="keyword">var</span> requestOptions = options;</span><br><span class="line">      <span class="keyword">if</span>(</span><br><span class="line">        !(args[cntr] <span class="keyword">instanceof</span> Buffer) &amp;&amp;</span><br><span class="line">        args[cntr] !== res</span><br><span class="line">      ) &#123;</span><br><span class="line">        requestOptions = extend(&#123;&#125;, options);</span><br><span class="line">        extend(requestOptions, args[cntr]);</span><br><span class="line">        cntr--;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// head</span></span><br><span class="line">      <span class="keyword">if</span>(args[cntr] <span class="keyword">instanceof</span> Buffer) &#123;</span><br><span class="line">        head = args[cntr];</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 请求的目标地址</span></span><br><span class="line">      [<span class="string">'target'</span>, <span class="string">'forward'</span>].forEach(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> requestOptions[e] === <span class="string">'string'</span>)</span><br><span class="line">          requestOptions[e] = parse_url(requestOptions[e]);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!requestOptions.target &amp;&amp; !requestOptions.forward) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.emit(<span class="string">'error'</span>, <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Must provide a proper URL as target'</span>));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 挨个执行任务队列，处理消息头，转发请求</span></span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i &lt; passes.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(passes[i](req, res, requestOptions, head, <span class="keyword">this</span>, cbl)) &#123;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此，createRightProxy(‘web’)(options), createRightProxy(‘ws’)(options) 就能用于创建实际的请求转发函数。在 node-http-proxy 模块中，这两个函数分别表现为 ProxyServer 实例的 web, ws 方法。其中，proxyServer.web 方法作为 http 或 https 服务器 listen 方法的回调函数，proxyServer.ws 方法作为 ‘upgrade’ 事件的绑定函数，从而能对接上客户端 ajax 请求、websocket 请求的执行时机。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProxyServer</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建转发 http, https; websocket 请求的处理函数</span></span><br><span class="line">  <span class="keyword">this</span>.web = <span class="keyword">this</span>.proxyRequest           = createRightProxy(<span class="string">'web'</span>)(options);</span><br><span class="line">  <span class="keyword">this</span>.ws  = <span class="keyword">this</span>.proxyWebsocketRequest  = createRightProxy(<span class="string">'ws'</span>)(options);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 任务队列，用于处理消息头、转发请求</span></span><br><span class="line">  <span class="keyword">this</span>.webPasses = <span class="built_in">Object</span>.keys(web).map(<span class="function"><span class="keyword">function</span>(<span class="params">pass</span>) </span>&#123;<span class="comment">// this.web 方法执行过程中调用的任务队列</span></span><br><span class="line">    <span class="keyword">return</span> web[pass];</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">this</span>.wsPasses = <span class="built_in">Object</span>.keys(ws).map(<span class="function"><span class="keyword">function</span>(<span class="params">pass</span>) </span>&#123;<span class="comment">// this.ws 方法执行过程中调用的任务队列</span></span><br><span class="line">    <span class="keyword">return</span> ws[pass];</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ProxyServer.prototype.listen = <span class="function"><span class="keyword">function</span>(<span class="params">port, hostname</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> self    = <span class="keyword">this</span>,</span><br><span class="line">      closure = <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123; self.web(req, res); &#125;;<span class="comment">// 转发 http, https 请求</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>._server  = <span class="keyword">this</span>.options.ssl ?</span><br><span class="line">    https.createServer(<span class="keyword">this</span>.options.ssl, closure) :</span><br><span class="line">    http.createServer(closure);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 转发 websocket 请求</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">this</span>.options.ws) &#123;</span><br><span class="line">    <span class="keyword">this</span>._server.on(<span class="string">'upgrade'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, socket, head</span>) </span>&#123; self.ws(req, socket, head); &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>._server.listen(port, hostname);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>以上不涉及任务队列的具体实现，却构成了 node-http-proxy 模块整体处理流程。除外而外，ProxyServer 还提供 before(type, passName, callback), after(type, passName, callback) 原型方法，用于在任务队列的某个具体处理函数之前或之后插入一个处理函数 callback。</p>
<h3 id="http-https-请求"><a href="#http-https-请求" class="headerlink" title="http, https 请求"></a>http, https 请求</h3><p>this.webPasses 任务队列包含如下四种处理函数：deleteLength, timeout, XHeaders, stream。</p>
<ol>
<li>deleteLength 函数：针对 DELETE 或 OPTIONS，且 headers[‘content-length’] 未设置的情形，将 headers[‘content-length’] 置为 0，并删除 headers[‘transfer-encoding’] 消息头。</li>
<li>timeout 函数：若设置了 options.timeout，调用 req.socket.setTimeout(options.timeout) 设置超时时间。</li>
<li>XHeaders 函数：设置 ‘x-forwarded-for’, ‘x-forwarded-port’, ‘x-forwarded-proto’, ‘x-forwarded-host’ 消息头，包含客户端和代理服务器的地址、端口、协议等内容（以 ‘,’ 拼接 req.headers 同名属性即客户端内容、和代理服务器内容）。其中，’x-forwarded-host’ 消息头只包含 req.headers.host，即代理服务器的主机名。由配置项 options.xfwd 启用 ‘x-forwarded-*’ 消息头的设置。</li>
<li>stream 函数：实际转发请求的处理函数。下文将作详解。</li>
</ol>
<p>stream 函数的处理流程为：</p>
<ol>
<li>调用 common.setupOutgoing 方法生成代理请求的配置项。</li>
<li>通过 options.forward, options.target 区分 ‘forward’ 和 ‘target’ 两种模式。在 ‘forward’ 模式下，只通过代理请求转发到目标服务器，输送给客户端的仍是代理服务器的响应。’target’ 模式下，不只可以处理目标服务器的响应，且可监听许多事件对代理请求等作出处理。’forward’ 和 ‘target’ 模式可以并行存在，即同时指定 options.forward, options.target。</li>
</ol>
<p>首先，common.setupOutgoing 的实现如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成代理请求的配置项，将作为 http.request 的参数</span></span><br><span class="line"><span class="comment"> * @param &#123;object&#125; outgoing 即 options.ssl 或 &#123;&#125;</span></span><br><span class="line"><span class="comment"> * @param &#123;object&#125; options 即 options</span></span><br><span class="line"><span class="comment"> * @param &#123;object&#125; req 即实际的请求</span></span><br><span class="line"><span class="comment"> * @param &#123;string|undefined&#125; forward 用于区分 'forward' 和 'target' 模式。值为 'forward' 或 undefined</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">common.setupOutgoing = <span class="function"><span class="keyword">function</span>(<span class="params">outgoing, options, req, forward</span>) </span>&#123;</span><br><span class="line">  outgoing.port = options[forward || <span class="string">'target'</span>].port ||</span><br><span class="line">                  (isSSL.test(options[forward || <span class="string">'target'</span>].protocol) ? <span class="number">443</span> : <span class="number">80</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// http://nodejs.cn/api/http.html#http_http_request_options_callback</span></span><br><span class="line">  <span class="comment">// host, host: 目标服务器的域名或 IP 地址</span></span><br><span class="line">  <span class="comment">// socketPath: Unix 域 Socket（使用 host:port 或 socketPath）</span></span><br><span class="line">  <span class="comment">// ca: ca 证书</span></span><br><span class="line">  [<span class="string">'host'</span>, <span class="string">'hostname'</span>, <span class="string">'socketPath'</span>, <span class="string">'pfx'</span>, <span class="string">'key'</span>,</span><br><span class="line">    <span class="string">'passphrase'</span>, <span class="string">'cert'</span>, <span class="string">'ca'</span>, <span class="string">'ciphers'</span>, <span class="string">'secureProtocol'</span>].forEach(</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123; outgoing[e] = options[forward || <span class="string">'target'</span>][e]; &#125;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 请求方法</span></span><br><span class="line">  outgoing.method = options.method || req.method;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 请求头</span></span><br><span class="line">  outgoing.headers = extend(&#123;&#125;, req.headers);</span><br><span class="line">  <span class="keyword">if</span> (options.headers)&#123;</span><br><span class="line">    extend(outgoing.headers, options.headers);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 基本身份验证，如 'user:password' 用来计算 Authorization 请求头</span></span><br><span class="line">  <span class="keyword">if</span> (options.auth) &#123;</span><br><span class="line">    outgoing.auth = options.auth;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (options.ca) &#123;</span><br><span class="line">    outgoing.ca = options.ca;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isSSL.test(options[forward || <span class="string">'target'</span>].protocol)) &#123;</span><br><span class="line">    outgoing.rejectUnauthorized = (<span class="keyword">typeof</span> options.secure === <span class="string">"undefined"</span>) ? <span class="literal">true</span> : options.secure;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// http://nodejs.cn/api/http.html#http_new_agent_options</span></span><br><span class="line">  <span class="comment">// 长连接时设置 options.agent = &#123; keepAlive, keepAliveMsecs &#125;</span></span><br><span class="line">  outgoing.agent = options.agent || <span class="literal">false</span>;</span><br><span class="line">  outgoing.localAddress = options.localAddress;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 不是长连接，设置 outgoing.headers.connection 请求头</span></span><br><span class="line">  <span class="keyword">if</span> (!outgoing.agent) &#123;</span><br><span class="line">    outgoing.headers = outgoing.headers || &#123;&#125;;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> outgoing.headers.connection !== <span class="string">'string'</span></span><br><span class="line">        || !upgradeHeader.test(outgoing.headers.connection)</span><br><span class="line">       ) &#123; outgoing.headers.connection = <span class="string">'close'</span>; &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 最终的请求路径由 options['forward'|'target'], req.url 拼接产生，可根据 options 配置设定某项是否启用</span></span><br><span class="line">  <span class="keyword">var</span> target = options[forward || <span class="string">'target'</span>];</span><br><span class="line">  <span class="keyword">var</span> targetPath = target &amp;&amp; options.prependPath !== <span class="literal">false</span></span><br><span class="line">    ? (target.path || <span class="string">''</span>) : <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">var</span> outgoingPath = !options.toProxy</span><br><span class="line">    ? (url.parse(req.url).path || <span class="string">''</span>) : req.url;</span><br><span class="line">  outgoingPath = !options.ignorePath ? outgoingPath : <span class="string">''</span>;</span><br><span class="line">  outgoing.path = common.urlJoin(targetPath, outgoingPath);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (options.changeOrigin) &#123;</span><br><span class="line">    outgoing.headers.host =</span><br><span class="line">      <span class="comment">// 通过 requires-port 模块校验在使用某种协议的情况下，是否需要在 url 上拼接端口号</span></span><br><span class="line">      required(outgoing.port, options[forward || <span class="string">'target'</span>].protocol) &amp;&amp; !hasPort(outgoing.host)</span><br><span class="line">        ? outgoing.host + <span class="string">':'</span> + outgoing.port</span><br><span class="line">        : outgoing.host;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> outgoing;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>其次，stream 的实现如下：</p>
<ol>
<li>调用 [http|https].request(outgoing) 创建代理请求。outgoing 由 common.setupOutgoing 函数获得。</li>
<li>调用 (options.buffer || req).pipe(forwardReq) 方法转发代理请求。</li>
<li>target 模式下，调用 web-outgoing 模块中的函数处理代理响应。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stream</span>(<span class="params">req, res, options, _, server, clb</span>) </span>&#123;</span><br><span class="line">  server.emit(<span class="string">'start'</span>, req, res, options.target || options.forward);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// options.followRedirects 是否使用 follow-redirects 重定向</span></span><br><span class="line">  <span class="keyword">var</span> agents = options.followRedirects ? followRedirects : nativeAgents;</span><br><span class="line">  <span class="keyword">var</span> http = agents.http;</span><br><span class="line">  <span class="keyword">var</span> https = agents.https;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(options.forward) &#123;</span><br><span class="line">    <span class="comment">// 生成代理请求</span></span><br><span class="line">    <span class="keyword">var</span> forwardReq = (options.forward.protocol === <span class="string">'https:'</span> ? https : http).request(</span><br><span class="line">      common.setupOutgoing(options.ssl || &#123;&#125;, options, req, <span class="string">'forward'</span>)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> forwardError = createErrorHandler(forwardReq, options.forward);</span><br><span class="line">    req.on(<span class="string">'error'</span>, forwardError);</span><br><span class="line">    forwardReq.on(<span class="string">'error'</span>, forwardError);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转发代理请求</span></span><br><span class="line">    (options.buffer || req).pipe(forwardReq);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 非 target 模式，返回响应</span></span><br><span class="line">    <span class="keyword">if</span>(!options.target) &#123; <span class="keyword">return</span> res.end(); &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 生成代理请求</span></span><br><span class="line">  <span class="keyword">var</span> proxyReq = (options.target.protocol === <span class="string">'https:'</span> ? https : http).request(</span><br><span class="line">    common.setupOutgoing(options.ssl || &#123;&#125;, options, req)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  proxyReq.on(<span class="string">'socket'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">socket</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(server) &#123; server.emit(<span class="string">'proxyReq'</span>, proxyReq, req, res, options); &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(options.proxyTimeout) &#123;</span><br><span class="line">    proxyReq.setTimeout(options.proxyTimeout, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        proxyReq.abort();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  req.on(<span class="string">'aborted'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    proxyReq.abort();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> proxyError = createErrorHandler(proxyReq, options.target);</span><br><span class="line">  req.on(<span class="string">'error'</span>, proxyError);</span><br><span class="line">  proxyReq.on(<span class="string">'error'</span>, proxyError);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">createErrorHandler</span>(<span class="params">proxyReq, url</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">proxyError</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (req.socket.destroyed &amp;&amp; err.code === <span class="string">'ECONNRESET'</span>) &#123;</span><br><span class="line">        server.emit(<span class="string">'econnreset'</span>, err, req, res, url);</span><br><span class="line">        <span class="keyword">return</span> proxyReq.abort();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (clb) &#123;</span><br><span class="line">        clb(err, req, res, url);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        server.emit(<span class="string">'error'</span>, err, req, res, url);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 转发代理请求</span></span><br><span class="line">  (options.buffer || req).pipe(proxyReq);</span><br><span class="line"></span><br><span class="line">  proxyReq.on(<span class="string">'response'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">proxyRes</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(server) &#123; server.emit(<span class="string">'proxyRes'</span>, proxyRes, req, res); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用 web-outgoing 模块中的函数处理代理响应</span></span><br><span class="line">    <span class="keyword">if</span>(!res.headersSent &amp;&amp; !options.selfHandleResponse) &#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i &lt; web_o.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(web_o[i](req, res, proxyRes, options)) &#123; <span class="keyword">break</span>; &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// http://nodejs.cn/api/http.html#http_response_finished</span></span><br><span class="line">    <span class="keyword">if</span> (!res.finished) &#123;</span><br><span class="line">      <span class="comment">// 通过事件处理代理响应</span></span><br><span class="line">      proxyRes.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (server) server.emit(<span class="string">'end'</span>, req, res, proxyRes);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 由 node-http-proxy 模块处理代理响应的情境下，返回响应</span></span><br><span class="line">      <span class="keyword">if</span> (!options.selfHandleResponse) proxyRes.pipe(res);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (server) server.emit(<span class="string">'end'</span>, req, res, proxyRes);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，再来看一下 web-outgoing 模块对代理响应的处理（实现查看源码）：</p>
<ol>
<li>removeChunked 函数：当使用 http/1.0 时（通过 req.httpVersion === ‘1.0’ 判断，客户端决定），移除代理响应的 headers[‘transfer-encoding’]。</li>
<li>setConnection 函数：当使用 http/1.0 时，代理响应的 headers.connection 设为 req.headers.connection || ‘close’；当使用非 http/2.0 时，且 proxyRes.headers.connection 为否，将 代理响应的 headers.connection 设为 req.headers.connection || ‘keep-alive’。</li>
<li>setRedirectHostRewrite 函数：根据 options.hostRewrite 或 options.autoRewrite 或 options.protocolRewrite 重写重定向地址 proxyRes.headers.location。代理相应的状态码须匹配 /^201|30(1|2|7|8)$/ 正则，且 proxyRes.headers.location 须与目标服务器同域名。</li>
<li>writeHeaders 函数：将代理响应的消息头写入实际响应 res 的消息头中。下文将作详解。</li>
<li>writeStatusCode 函数：将代理响应的 statusCode, statusMessage 写入返回给客户端的响应 res 中。</li>
</ol>
<p>setRedirectHostRewrite 函数的代码实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeHeaders</span>(<span class="params">req, res, proxyRes, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> rewriteCookieDomainConfig = options.cookieDomainRewrite,</span><br><span class="line">      rewriteCookiePathConfig = options.cookiePathRewrite,</span><br><span class="line">      preserveHeaderKeyCase = options.preserveHeaderKeyCase,</span><br><span class="line">      rawHeaderKeyMap,</span><br><span class="line">      setHeader = <span class="function"><span class="keyword">function</span>(<span class="params">key, header</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (header == <span class="literal">undefined</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (rewriteCookieDomainConfig &amp;&amp; key.toLowerCase() === <span class="string">'set-cookie'</span>) &#123;</span><br><span class="line">          header = common.rewriteCookieProperty(header, rewriteCookieDomainConfig, <span class="string">'domain'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (rewriteCookiePathConfig &amp;&amp; key.toLowerCase() === <span class="string">'set-cookie'</span>) &#123;</span><br><span class="line">          header = common.rewriteCookieProperty(header, rewriteCookiePathConfig, <span class="string">'path'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        res.setHeader(<span class="built_in">String</span>(key).trim(), header);</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> rewriteCookieDomainConfig === <span class="string">'string'</span>) &#123; <span class="comment">//also test for ''</span></span><br><span class="line">    rewriteCookieDomainConfig = &#123; <span class="string">'*'</span>: rewriteCookieDomainConfig &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> rewriteCookiePathConfig === <span class="string">'string'</span>) &#123; <span class="comment">//also test for ''</span></span><br><span class="line">    rewriteCookiePathConfig = &#123; <span class="string">'*'</span>: rewriteCookiePathConfig &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// http://nodejs.cn/api/http.html#http_message_rawheaders</span></span><br><span class="line">  <span class="keyword">if</span> (preserveHeaderKeyCase &amp;&amp; proxyRes.rawHeaders != <span class="literal">undefined</span>) &#123;</span><br><span class="line">    rawHeaderKeyMap = &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; proxyRes.rawHeaders.length; i += <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> key = proxyRes.rawHeaders[i];</span><br><span class="line">      rawHeaderKeyMap[key.toLowerCase()] = key;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Object</span>.keys(proxyRes.headers).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> header = proxyRes.headers[key];</span><br><span class="line">    <span class="keyword">if</span> (preserveHeaderKeyCase &amp;&amp; rawHeaderKeyMap) &#123;</span><br><span class="line">      key = rawHeaderKeyMap[key] || key;</span><br><span class="line">    &#125;</span><br><span class="line">    setHeader(key, header);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据 options.cookieDomainRewrite, options.cookiePathRewrite 重写 res.headers.cookie 中的 domain, path 属性</span></span><br><span class="line"><span class="comment">// cookie.domain 表示 cookie 所在的域</span></span><br><span class="line"><span class="comment">// cookie.path 表示 cookie 所在的目录</span></span><br><span class="line"><span class="comment">// 参考 [理解cookie的path和domain属性](https://www.cnblogs.com/chris-oil/p/3869803.html)</span></span><br><span class="line">common.rewriteCookieProperty = <span class="function"><span class="keyword">function</span> <span class="title">rewriteCookieProperty</span>(<span class="params">header, config, property</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(header)) &#123;</span><br><span class="line">    <span class="keyword">return</span> header.map(<span class="function"><span class="keyword">function</span> (<span class="params">headerElement</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> rewriteCookieProperty(headerElement, config, property);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> header.replace(<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">"(;\\s*"</span> + property + <span class="string">"=)([^;]+)"</span>, <span class="string">'i'</span>), <span class="function"><span class="keyword">function</span>(<span class="params">match, prefix, previousValue</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> newValue;</span><br><span class="line">    <span class="keyword">if</span> (previousValue <span class="keyword">in</span> config) &#123;</span><br><span class="line">      newValue = config[previousValue];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">'*'</span> <span class="keyword">in</span> config) &#123;</span><br><span class="line">      newValue = config[<span class="string">'*'</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> match;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (newValue) &#123;</span><br><span class="line">      <span class="keyword">return</span> prefix + newValue;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="websocket-请求"><a href="#websocket-请求" class="headerlink" title="websocket 请求"></a>websocket 请求</h3><p>this.wsPasses 任务队列包含如下四种处理函数：checkMethodAndHeader, XHeaders, stream。</p>
<ol>
<li>checkMethodAndHeader 函数：websocket 请求的请求方式必须是 get，且 headers.upgrade 请求头必须是 ‘websocket’，checkMethodAndHeader 函数用于校验请求方式和 headers.upgrade 请求头。</li>
<li>XHeaders 函数：设置 ‘x-forwarded-for’, ‘x-forwarded-port’, ‘x-forwarded-proto’ 消息头，包含客户端和代理服务器的地址、端口、协议等内容（以 ‘,’ 拼接 req.headers 同名属性即客户端内容、和代理服务器内容）。由配置项 options.xfwd 启用 ‘x-forwarded-*’ 消息头的设置。</li>
<li>stream 函数：实际转发请求的处理函数。下文将作详解。</li>
</ol>
<p>stream 函数的处理流程为：</p>
<ol>
<li>调用 common.setupOutgoing 方法生成代理请求的配置项。</li>
<li>调用 [http|https].request(outgoing) 创建代理请求 proxyReq。</li>
<li>调用 proxyReq.end 发送代理请求。 </li>
<li>监听 response 事件，修改消息头后将响应发送给客户端。</li>
<li>监听 upgrade 事件，更换协议后，调用 proxySocket.pipe(socket).pipe(proxySocket) 再次发送代理请求。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">common.setupSocket = <span class="function"><span class="keyword">function</span>(<span class="params">socket</span>) </span>&#123;</span><br><span class="line">  socket.setTimeout(<span class="number">0</span>);</span><br><span class="line">  socket.setNoDelay(<span class="literal">true</span>);</span><br><span class="line">  socket.setKeepAlive(<span class="literal">true</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> socket;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stream</span>(<span class="params">req, socket, options, head, server, clb</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 添加请求头内容</span></span><br><span class="line">  <span class="keyword">var</span> createHttpHeader = <span class="function"><span class="keyword">function</span>(<span class="params">line, headers</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.keys(headers).reduce(<span class="function"><span class="keyword">function</span> (<span class="params">head, key</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> value = headers[key];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(value)) &#123;</span><br><span class="line">        head.push(key + <span class="string">': '</span> + value);</span><br><span class="line">        <span class="keyword">return</span> head;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; value.length; i++) &#123;</span><br><span class="line">        head.push(key + <span class="string">': '</span> + value[i]);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> head;</span><br><span class="line">    &#125;, [line])</span><br><span class="line">    .join(<span class="string">'\r\n'</span>) + <span class="string">'\r\n\r\n'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  common.setupSocket(socket);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (head &amp;&amp; head.length) socket.unshift(head);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建代理请求</span></span><br><span class="line">  <span class="keyword">var</span> proxyReq = (common.isSSL.test(options.target.protocol) ? https : http).request(</span><br><span class="line">    common.setupOutgoing(options.ssl || &#123;&#125;, options, req)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (server) &#123; server.emit(<span class="string">'proxyReqWs'</span>, proxyReq, req, socket, options, head); &#125;</span><br><span class="line"></span><br><span class="line">  proxyReq.on(<span class="string">'error'</span>, onOutgoingError);</span><br><span class="line">  proxyReq.on(<span class="string">'response'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 属性响应到客户端</span></span><br><span class="line">    <span class="keyword">if</span> (!res.upgrade) &#123;</span><br><span class="line">      socket.write(createHttpHeader(<span class="string">'HTTP/'</span> + res.httpVersion + <span class="string">' '</span> + res.statusCode + <span class="string">' '</span> + res.statusMessage, res.headers));</span><br><span class="line">      res.pipe(socket);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  proxyReq.on(<span class="string">'upgrade'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">proxyRes, proxySocket, proxyHead</span>) </span>&#123;</span><br><span class="line">    proxySocket.on(<span class="string">'error'</span>, onOutgoingError);</span><br><span class="line"></span><br><span class="line">    proxySocket.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      server.emit(<span class="string">'close'</span>, proxyRes, proxySocket, proxyHead);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    socket.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      proxySocket.end();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    common.setupSocket(proxySocket);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (proxyHead &amp;&amp; proxyHead.length) proxySocket.unshift(proxyHead);</span><br><span class="line"></span><br><span class="line">    socket.write(createHttpHeader(<span class="string">'HTTP/1.1 101 Switching Protocols'</span>, proxyRes.headers));</span><br><span class="line"></span><br><span class="line">    proxySocket.pipe(socket).pipe(proxySocket);<span class="comment">// 再次发送代理请求？</span></span><br><span class="line"></span><br><span class="line">    server.emit(<span class="string">'open'</span>, proxySocket);</span><br><span class="line">    server.emit(<span class="string">'proxySocket'</span>, proxySocket);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> proxyReq.end(); <span class="comment">// 发送代理请求</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">onOutgoingError</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (clb) &#123;</span><br><span class="line">      clb(err, req, socket);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      server.emit(<span class="string">'error'</span>, err, req, socket);</span><br><span class="line">    &#125;</span><br><span class="line">    socket.end();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><h3 id="http-proxy-middleware"><a href="#http-proxy-middleware" class="headerlink" title="http-proxy-middleware"></a>http-proxy-middleware</h3><p>参见 <a href="http://xzfyu.com/2018/11/11/%E5%B7%A5%E7%A8%8B%E5%8C%96/http-proxy-middleware%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" target="_blank" rel="noopener">http-proxy-middleware 源码解读</a>。</p>
<h3 id="nokit-filter-proxy"><a href="#nokit-filter-proxy" class="headerlink" title="nokit-filter-proxy"></a>nokit-filter-proxy</h3><p>nokit-filter-proxy 库用于为 <a href="https://github.com/nokitjs/nokit" target="_blank" rel="noopener">nokit</a> 服务器添加代理功能。鉴于前端构建工具 dawn 使用 nokit 搭建本地调试服务器，nokit-filter-proxy 库也用于为 dn-middleware-server 中间件实现代理功能。</p>
<p>同 http-proxy-middleware 库，nokit-filter-proxy 借助 node-http-proxy 实现服务器代理的都是先校验请求路径是否匹配转发策略，拦截并转发请求。nokit-filter-proxy 通过绑定 onRequest 事件函数，实现请求的拦截和转发。详见源码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> httpProxy = <span class="built_in">require</span>(<span class="string">"http-proxy"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProxyFilter</span>(<span class="params">server</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">var</span> utils = self.utils = server.require(<span class="string">"$./core/utils"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// proxy 配置，作为请求路径转发规则</span></span><br><span class="line">  self.configs = server.configs.proxy || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 作为代理服务器的配置项</span></span><br><span class="line">  self.configs.options = self.configs.options || &#123;&#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 代理请求设置 'x-forwarded-for', 'x-forwarded-port', 'x-forwarded-proto', 'x-forwarded-host' 消息头</span></span><br><span class="line">  <span class="keyword">if</span> (utils.isNull(self.configs.options.xfwd)) &#123;</span><br><span class="line">    self.configs.options.xfwd = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 代理请求设置 headers.host 消息头</span></span><br><span class="line">  <span class="keyword">if</span> (utils.isNull(self.configs.options.changeOrigin)) &#123;</span><br><span class="line">    self.configs.options.changeOrigin = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 请求路径转发规则，key - value 形式，key 为客户端请求路径正则，value 为目标服务器路径</span></span><br><span class="line">  self.configs.rules = self.configs.rules || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建代理服务器  </span></span><br><span class="line">  self.proxy = httpProxy.createProxyServer(self.configs.options);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 转发代理请求前，使用 headers 配置修改代理请求的消息头</span></span><br><span class="line">  self.onProxyReqHandler = self.onProxyReqHandler.bind(self);</span><br><span class="line">  self.proxy.on(<span class="string">"proxyReq"</span>, self.onProxyReqHandler);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ProxyFilter.prototype.onProxyReqHandler = <span class="function"><span class="keyword">function</span>(<span class="params">proxyReq, req, res, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">if</span> (!self.configs.headers) <span class="keyword">return</span>;</span><br><span class="line">  self.utils.each(self.configs.headers, <span class="function"><span class="keyword">function</span>(<span class="params">name, value</span>) </span>&#123;</span><br><span class="line">    proxyReq.setHeader(name, value);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// self.matchRule 根据 rules 配置，解析出请求路径转发规则</span></span><br><span class="line">ProxyFilter.prototype.matchRule = <span class="function"><span class="keyword">function</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">var</span> rule = <span class="literal">null</span>;</span><br><span class="line">  self.utils.each(self.configs.rules, <span class="function"><span class="keyword">function</span>(<span class="params">exprText, target</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> expr = <span class="keyword">new</span> <span class="built_in">RegExp</span>(exprText);</span><br><span class="line">    <span class="keyword">if</span> (expr.test(url)) &#123;</span><br><span class="line">      <span class="keyword">var</span> urlParts = expr.exec(url);</span><br><span class="line">      rule = &#123;</span><br><span class="line">        url: urlParts.length &gt; <span class="number">1</span> ? urlParts[<span class="number">1</span>] : url,</span><br><span class="line">        target: target</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> rule;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ProxyFilter.prototype.onRequest = <span class="function"><span class="keyword">function</span>(<span class="params">context, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">var</span> res = context.res,</span><br><span class="line">    req = context.req;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> rule = self.matchRule(req.url);</span><br><span class="line">  <span class="keyword">if</span> (!rule) <span class="keyword">return</span> next();</span><br><span class="line">  req.url = rule.url || <span class="string">"/"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 转发代理请求</span></span><br><span class="line">  self.proxy.web(req, res, &#123;</span><br><span class="line">    <span class="string">"target"</span>: rule.target</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>这两篇文章都是在笔者整理完 proxy 设计模式后整理的。鉴于本人水平有限，文章难免错谬，仍望读者不吝赐教。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/06/设计模式/代理模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/06/设计模式/代理模式/" itemprop="url">代理模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-06T00:00:00+08:00">2018-11-06</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/设计模式/" itemprop="url" rel="index"><span itemprop="name">设计模式</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/06/设计模式/代理模式/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/06/设计模式/代理模式/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>代理模式(proxy pattern) 的主要处理逻辑为，构建代理对象以桥接对实际对象的访问。因此，可以在访问过程中构建附加的间接性操作如请求处理、权限校验、内务处理(housekeeping task)等，也可以为多种实际对象提供统一的接口。</p>
<p>《设计模式:可复用面向对象软件的基础》中的说法是：</p>
<blockquote class="blockquote-center"><p>Provide a surrogate or placeholder for another object to control access to it.</p>
</blockquote>
<p>维基百科的说法是：</p>
<blockquote class="blockquote-center"><p>A proxy, in its most general form, is a class functioning as an interface to something else. A proxy is a wrapper or agent object that is being called by the client to access the real serving object behind the scenes. Use of the proxy can simply be forwarding to the real object, or can provide additional logic. In the proxy extra functionality can be provided, for example caching when operations on the real object are resource intensive, or checking preconditions before operations on the real object are invoked.</p>
</blockquote>
<p>使用代理模式的场景：</p>
<ol>
<li>远程代理(remote proxy): 为一个远程服务对象提供本地表现，通过本地方法调用远程服务。</li>
<li>虚代理(virtual proxy): 在代理中延迟创建一个开销很大的对象。如在图片代理对象的实现过程中，draw 方法执行前才创建实际所需的图片对象。</li>
<li>保护代理(protection proxy): 访问对象前执行权限校验。</li>
<li>智能指引(smart reference): 访问实际的对象时执行附加操作，如对引用计数，当没被引用时，释放内存；首次引用时，将持久对象装入内存等。</li>
</ol>
<h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><img src="/2018/11/06/设计模式/代理模式/proxy.png">
<ul>
<li>Proxy: 以引用形式持有实体，接口与 Subject 相同，以便于使用代理对象替代实体，并控制对实体的访问。必要时，可以在代理对象中创建或删除实体。<ul>
<li>remote proxy 负责对请求及其参数进行编码，并向远程服务器发送请求。</li>
<li>virtual proxy 负责缓存实体的附加信息，以便延迟创建实体。</li>
<li>protection proxy 负责校验请求是否有特定的访问权限。</li>
</ul>
</li>
<li>Subject 定义 RealSubject, Proxy 的公共接口，因此在需要使用 RealSubject 的场景中都可以使用 Proxy 代替。</li>
<li>RealSubject 定义 Proxy 所代表的实体。</li>
</ul>
<h2 id="经典实现"><a href="#经典实现" class="headerlink" title="经典实现"></a>经典实现</h2><p>使用代理模式为多种类型的字段提供统一的接口，在 FieldProxy 实例 setValue 方法执行过程中，我们也能添加诸如数据校验等处理函数。这里只展示代理模式实现的一种方式，而不推敲代理模式在字段处理上的意义。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Field</span> </span>&#123;</span><br><span class="line">  type;<span class="comment">// 字段类型</span></span><br><span class="line">  name;<span class="comment">// 字段 code</span></span><br><span class="line">  title;<span class="comment">// 字段名</span></span><br><span class="line">  required;<span class="comment">// 字段是否必填</span></span><br><span class="line">  value;<span class="comment">// 字段的值</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(props)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; name, title, required &#125; = props;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">    <span class="keyword">this</span>.title = title;</span><br><span class="line">    <span class="keyword">this</span>.required = required;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setValue(value)&#123;</span><br><span class="line">    <span class="keyword">this</span>.value = value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Input</span> <span class="keyword">extends</span> <span class="title">Field</span> </span>&#123;</span><br><span class="line">  type = <span class="string">'input'</span>;</span><br><span class="line">  placeholder;</span><br><span class="line">  maxLength;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(props)&#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">const</span> &#123; placeholder, maxLength &#125; = props;</span><br><span class="line">    <span class="keyword">this</span>.placeholder = placeholder;</span><br><span class="line">    <span class="keyword">this</span>.maxLength = maxLength;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// textarea</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Textarea</span> <span class="keyword">extends</span> <span class="title">Field</span> </span>&#123;</span><br><span class="line">  type = <span class="string">'textarea'</span>;</span><br><span class="line">  placeholder;</span><br><span class="line">  maxLength;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(props)&#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">const</span> &#123; placeholder, maxLength &#125; = props;</span><br><span class="line">    <span class="keyword">this</span>.placeholder = placeholder;</span><br><span class="line">    <span class="keyword">this</span>.maxLength = maxLength;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// radio</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Radio</span> <span class="keyword">extends</span> <span class="title">Field</span> </span>&#123;</span><br><span class="line">  type = <span class="string">'radio'</span>;</span><br><span class="line">  options;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(props)&#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">const</span> &#123; options &#125; = props;</span><br><span class="line">    <span class="keyword">this</span>.options = options;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// checkbox</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Checkbox</span> <span class="keyword">extends</span> <span class="title">Field</span> </span>&#123;</span><br><span class="line">  type = <span class="string">'checkbox'</span>;</span><br><span class="line">  options;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(props)&#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">const</span> &#123; options &#125; = props;</span><br><span class="line">    <span class="keyword">this</span>.options = options;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// select</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Select</span> <span class="keyword">extends</span> <span class="title">Field</span> </span>&#123;</span><br><span class="line">  type = <span class="string">'select'</span>;</span><br><span class="line">  placeholder;</span><br><span class="line">  options;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(props)&#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">const</span> &#123; options &#125; = props;</span><br><span class="line">    <span class="keyword">this</span>.placeholder = placeholder;</span><br><span class="line">    <span class="keyword">this</span>.options = options;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Fields = &#123;</span><br><span class="line">  <span class="string">'input'</span>: Input,</span><br><span class="line">  <span class="string">'textarea'</span>: Textarea,</span><br><span class="line">  <span class="string">'radio'</span>: Radio,</span><br><span class="line">  <span class="string">'checkbox'</span>: Checkbox,</span><br><span class="line">  <span class="string">'select'</span>: Select,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FieldProxy</span> </span>&#123;</span><br><span class="line">  field;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(props)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; type, ...others &#125; = props;</span><br><span class="line">    <span class="keyword">this</span>.field = <span class="keyword">new</span> Fields[type](others);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setValue(value)&#123;</span><br><span class="line">    <span class="keyword">this</span>.field.setValue(value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="js中的代理模式"><a href="#js中的代理模式" class="headerlink" title="js中的代理模式"></a>js中的代理模式</h2><h3 id="图片缓存"><a href="#图片缓存" class="headerlink" title="图片缓存"></a>图片缓存</h3><p>图片缓存的目的是在远程图片加载的时延过程中，预先以本地图片或占位符代替；在远程图片加载完成之后，再使用 img 节点展示实际的图片。</p>
<p>备注：RealSubject 和 Proxy 使用相同的接口这种情况，在 js 中，可以在自调用匿名函数实现，实例属性可使用闭包缓存。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实际加载图片</span></span><br><span class="line"><span class="keyword">const</span> loadImage = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">let</span> imgNode = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(imgNode);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">src</span>)</span>&#123;</span><br><span class="line">    imgNode.src = src;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> handler = &#123;</span><br><span class="line">  apply: <span class="function"><span class="keyword">function</span>(<span class="params">target, thisBinding, args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> src = args[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">let</span> img = <span class="keyword">new</span> Image;</span><br><span class="line">    img.src = src;</span><br><span class="line">    img.onLoad = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      target(src);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    target(<span class="string">'local_image.gif'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 代理加载图片</span></span><br><span class="line"><span class="keyword">const</span> loadImageProxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(loadImage, handler);</span><br><span class="line"></span><br><span class="line">loadImageProxy(<span class="string">'remote_image.png'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="惰性加载"><a href="#惰性加载" class="headerlink" title="惰性加载"></a>惰性加载</h3><p>跟代理图片类似，加载 js 脚本也会有一定的时延，这就会造成使用某个类库前，js 脚本还未加载完成，所使用的方法也是 undefined。这时，可使用虚拟代理模拟类库，缓存执行方法，等到 js 脚本加载完成之后，再使用缓存执行实际的方法。</p>
<p>曾探在《Javascript 设计模式与开发实践》一书中，以 minConsole 类库为例，按下 F2 键加载所需的 js 脚本，在此之前，使用代理。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> miniConsole = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">let</span> cache = [];</span><br><span class="line">  <span class="keyword">let</span> handler = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( e.keyCode === <span class="number">113</span> )&#123;</span><br><span class="line">      <span class="keyword">let</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</span><br><span class="line">      script.onLoad = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="comment">// 加载完成后，执行缓存的待执行函数</span></span><br><span class="line">        cache.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn());</span><br><span class="line">      &#125;</span><br><span class="line">      script.src = <span class="string">'miniConsole.js'</span>;</span><br><span class="line">      <span class="built_in">document</span>.getElementByTagName(<span class="string">'head'</span>)[<span class="number">0</span>].appendChild(imgNode);</span><br><span class="line">      <span class="built_in">document</span>.body.removeEventListener(<span class="string">'keydown'</span>, handler);<span class="comment">// 单次加载</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">document</span>.body.addEventListener(<span class="string">'keydown'</span>, handler, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 代理对象，缓存待执行函数</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    log(...args)&#123;</span><br><span class="line">      cache.push(miniConsole.bind(miniConsole, ...args));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>
<h3 id="合并http请求"><a href="#合并http请求" class="headerlink" title="合并http请求"></a>合并http请求</h3><p>搜索组件每次改变值时都会调用远程接口，使用代理模式可延迟调用远程接口，以使交互请求不至频繁。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doSearch</span>(<span class="params">content</span>)</span>&#123;</span><br><span class="line">  <span class="keyword">get</span>(content);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">let cache;</span><br><span class="line">let timer = null;</span><br><span class="line"></span><br><span class="line">const handler = &#123;</span><br><span class="line">  apply: <span class="function"><span class="keyword">function</span>(<span class="params">target, thisBinding, args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> content = args[<span class="number">0</span>];</span><br><span class="line">    cache = content;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( timer ) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    timer = setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      doSearch(cache);</span><br><span class="line">      cache = <span class="literal">null</span>;</span><br><span class="line">      timer = <span class="literal">null</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> doSearchProxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(doSearch, handler);</span><br></pre></td></tr></table></figure>
<h3 id="缓存代理"><a href="#缓存代理" class="headerlink" title="缓存代理"></a>缓存代理</h3><p>前端缓存代理包含：对于计算复杂的过程，在入参相同的情况下，可使用缓存的计算结果代替实际的执行计算；对于频繁的 ajax 调用，也可以使用缓存，避免远程调用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> cache;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">complexCompute</span>(<span class="params">...args</span>)</span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> handler = &#123;</span><br><span class="line">  apply: <span class="function"><span class="keyword">function</span>(<span class="params">target, thisBinding, args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> cacheKey = args.join(<span class="string">','</span>);</span><br><span class="line">    <span class="keyword">if</span> ( cache[cacheKey] ) <span class="keyword">return</span> cache[cacheKey];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> result = complexCompute(...args);</span><br><span class="line">    cache[cacheKey] = result;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> complexComputeProxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(complexCompute, handler);</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>[设计模式:可复用面向对象软件的基础]<br>[Javascript 设计模式和开发实践 - 曾探]<br><a href="https://java-design-patterns.com/patterns/proxy/" target="_blank" rel="noopener">java-design-patterns: proxy</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/04/antd/Form/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/04/antd/Form/" itemprop="url">antd-Form 组件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-04T00:00:00+08:00">2018-11-04</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/antd-组件库/" itemprop="url" rel="index"><span itemprop="name">antd 组件库</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/04/antd/Form/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/11/04/antd/Form/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>ant design 中的 Form 组件基于 rc-form 实现。本文第一部分将介绍 rc-form 库；第二部分再介绍 ant design 中的 Form 组件。</p>
<h2 id="rc-form"><a href="#rc-form" class="headerlink" title="rc-form"></a>rc-form</h2><p>常规收集表单数据并作校验，只需以 store 实时记录表单数据，校验后重绘表单。这样的思路以业务代码为例，就是，以数据模型 model 集成数据处理操作，再通过 setState 将 model 中的实时数据注入组件中，并驱动组件重绘（除了 setState 方法以外，也可以使用 forceUpdate 方法重绘组件，并在 render 阶段重新访问 model  中的实时数据）。从业务角度对数据及其操作进行建模，必然着眼于实际的业务场景，其类结构也会和数据表有千丝万缕的联系；而表单中的数据更具一般性特征，即能对应多个数据表，对其进行抽象也须从视图层入手。可以推想的是，抽象的表单数据模型必然包含字段名和字段的值构成的映射 valuesMap，字段名和校验结果构成的映射 errorsMap，以及字段名和校验状态构成的映射 validatingMap，这样才能绘制出表单中的字段项。</p>
<p>在 rc-form 中，上述数据模型的具体实现为 FieldsStore 类。如前所述，FieldsStore 实例与视图层的交互逻辑为，在用户行为驱动字段项的数据改变时，即时存储表单数据及校验文案，继而调用表单组件实例的 forceUpdate 方法强制重绘；在绘制过程中，再从 FieldsStore 实例读取实时的表单数据、校验文案及校验状态。建模方面，FieldsStore 实例以 fields 属性存储表单的实时数据，其结构为键值对形式 { [name]: { value, errors, validating, dirty, touched } } 。其中，name 为字段名；value 为字段的值；errors 为校验结果；validating 为校验状态；dirty 为脏值标识（当字段的值已作变更、但未作校验时，那么脏值标识就为 true；已作校验则置为 false）；touched 为更新标识，即用户行为触发时，字段值已作收集标识，收集的值通常是更新后的值 （若 FieldsStore 实例在 onChange 发生时收集数据，touched 标识也意味着数据已作变更。当然，如果此时用户再将数据更新为初始值，touched 标识将依旧为 true，并不能反映表单数据的更新状态。但是在一般情况下，可以根据 touched 标识判断表单数据是否有过更改）。</p>
<p>除了实时更新的数据外，驱动校验需要校验规则 validateRules、触发事件 validateTrigger；字段的初始值 initialValue（当字段的值还没存入 fields 中时，以初始值替代）；从 event 对象获取字段的值，也跟 dom 节点的类型相关，如 input, radio, checkbox 类型，可以借助 getValueFromEvent 函数从 event 对象获取的字段的值；注入字段组件的值需要作特殊的数据转换，其一 radio 原生组件通过 props.checked 接受字段的实时值，其二对于自定义组件，不只接受实时值的 props 属性是特殊的，收集的数据和注入组件中的数据也会存在结果差异，这可以借助 getValueProps 函数作转换操作；在某些场合下，收集的表单数据需要经过特殊转换（使用案例：<a href="https://codepen.io/afc163/pen/JJVXzG?editors=001" target="_blank" rel="noopener">全选按钮</a>），这可以借助 normalize 函数实现。FieldsStore 实例使用 fieldsMeta 属性存储这些元数据，其结构为 { [name]: { validate, initialValue, getValueFromEvent, valuePropName, getValueProps, normalize } }。其中，validate 包含 validateRules, validateTrigger。</p>
<p>与业务实体不同的是，FieldsStore 实例仅止于存储字段的表单数据和元数据，提供一些便捷的访问器操作，却没有包含数据校验等操作，也没有关联上表单及字段组件。对于用户自定义表单组件，需要提供获取、更新及校验表单数据的方法，以便组织与远程接口密切相关的交互逻辑。对于字段组件，校验规则等与指定字段强关联的配置项适合在使用字段组件时通过 props 注入；同时，在字段组件的值发生变更时，需要收集该字段的值及启动对该字段的校验，因此需要将特定的绑定函数添加到 props 中。这些字段元数据写入 FieldsStore 就适合在绘制字段组件的过程中实现，因此就需要特定的方法用于装饰字段组件或其 props 属性。在 rc-form 中，BaseForm 用于实现这部分功能。</p>
<p>想要为用户自定义组件注入工具函数，可以使用 HOC 高阶组件将工具函数配置为自定义子组件的 props  形式实现。BaseForm 就是这样的高阶组件。在 BaseForm 的 render  阶段，将为用户自定义组件注入 props.form 操纵表单的工具函数集。工具函数集中包含 getFieldValue, getFieldsValue, getFieldError, getFieldsError, isFieldsValidating, isFieldValidating, isFieldTouched, isFieldsTouched 方法用于获取字段的值、校验文案、校验状态、是否更新标识等；setFieldsInitialValue 方法用于设置字段的初始值；setFieldsValue 方法用于设置字段的值；setFields 方法用于设置表单的实时数据，包含字段的值及校验文案等；resetFields 方法用于重置表单；validateFields 方法用于校验表单；getFieldProps 方法用于转换传入字段组件的 props 数据（包含特定的绑定函数），并收集字段组件的元数据；getFieldDecorator 方法基于 getFieldProps 方法，不同于 getFieldProps 方法用于装饰字段组件的 props，getFieldDecorator 用于直接装饰字段组件，这样就可以直接获取并封装传入字段组件实例的 props.onChange 等属性或方法；getFieldInstance 方法用于获取字段实例。</p>
<p>关于校验文案和校验状态的绘制，参见本文的第二部分。</p>
<p>以时序图的方式表达 rc-form 的工作流程为：<br><img src="/2018/11/04/antd/Form/rc-form时序图.png"></p>
<p>rc-form 的类图结构为：<br><img src="/2018/11/04/antd/Form/rc-form类图.png"></p>
<h3 id="FieldsStore"><a href="#FieldsStore" class="headerlink" title="FieldsStore"></a>FieldsStore</h3><p>如上文所述，FieldsStore 基本用作表单字段元数据和实时数据的存储器。此外，rc-form 支持以嵌套结构定义字段名，即使用 ‘.’, ‘[|]’ 作为分割符，如 ‘a.b’ 意味着 a 对象下的 b 属性；’c[0]’ 意味着 c 数组的首项。这一机制借助于 <a href="https://github.com/lodash/lodash" target="_blank" rel="noopener">lodash</a> 类库的 <a href="https://github.com/lodash/lodash/blob/master/set.js" target="_blank" rel="noopener">set</a>, <a href="https://github.com/lodash/lodash/blob/master/get.js" target="_blank" rel="noopener">get</a> 方法和内置的 flattenFields 函数实现的。并且，FieldsStore 提供 isValidNestedFieldName 方法用于校验表单中的字段名不能作为其他字段名的成员。</p>
<p>flattenFields(maybeNestedFields, isLeafNode, errorMessage) 函数用于将嵌套数据扁平化，如将 { a: { b: 1 } } 转化成 { ‘a.b’: 1 }。参数 maybeNestedFields 即嵌套数据；参数 isLeafNode 用于校验扁平化后的数据成员的合理性；参数 errorMessage 校验不合理时的警告文案。其实现如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">treeTraverse</span>(<span class="params">path = <span class="string">''</span>, tree, isLeafNode, errorMessage, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (isLeafNode(path, tree)) &#123;</span><br><span class="line">    callback(path, tree);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tree === <span class="literal">undefined</span> || tree === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="comment">// Do nothing</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(tree)) &#123;</span><br><span class="line">    tree.forEach(<span class="function">(<span class="params">subTree, index</span>) =&gt;</span> treeTraverse(</span><br><span class="line">      <span class="string">`<span class="subst">$&#123;path&#125;</span>[<span class="subst">$&#123;index&#125;</span>]`</span>,</span><br><span class="line">      subTree,</span><br><span class="line">      isLeafNode,</span><br><span class="line">      errorMessage,</span><br><span class="line">      callback</span><br><span class="line">    ));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123; <span class="comment">// It's object and not a leaf node</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> tree !== <span class="string">'object'</span>) &#123;</span><br><span class="line">      warning(<span class="literal">false</span>, errorMessage);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">Object</span>.keys(tree).forEach(<span class="function"><span class="params">subTreeKey</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> subTree = tree[subTreeKey];</span><br><span class="line">      treeTraverse(</span><br><span class="line">        <span class="string">`<span class="subst">$&#123;path&#125;</span><span class="subst">$&#123;path ? <span class="string">'.'</span> : <span class="string">''</span>&#125;</span><span class="subst">$&#123;subTreeKey&#125;</span>`</span>,</span><br><span class="line">        subTree,</span><br><span class="line">        isLeafNode,</span><br><span class="line">        errorMessage,</span><br><span class="line">        callback</span><br><span class="line">      );</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">flattenFields</span>(<span class="params">maybeNestedFields, isLeafNode, errorMessage</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> fields = &#123;&#125;;</span><br><span class="line">  treeTraverse(<span class="literal">undefined</span>, maybeNestedFields, isLeafNode, errorMessage, (path, node) =&gt; &#123;</span><br><span class="line">    fields[path] = node;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> fields;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>元数据以 this.fieldsMeta = { [name]: { validate, hidden, getValueFromEvent, initialValue, valuePropName, getValueProps, normalize } } 形式存储（name 为字段名，下同）。以下是字段元数据中各属性的意义。</p>
<ul>
<li>validate 校验规则和触发事件，[{ rules, trigger }] 形式。</li>
<li>hidden 设置为 true 时，getFieldsValue, getFieldsError 等方法将无法获取该字段的数据及校验信息等实时数据。本文假设设置了 hidden 为 true 的字段为虚拟隐藏项。</li>
<li>getValueFromEvent(event) 用于从 event 对象中获取字段的值。</li>
<li>initialValue 字段的初始值。</li>
<li>valuePropName 约定字段的值以何种 props 属性注入字段组件中。</li>
<li>getValueProps(value) 用于转化字段的值，输出 props 以注入字段组件中。</li>
<li>normalize(newValue, oldValue, values) 用于转换存入 FieldsStore  实例的字段值。</li>
</ul>
<p>实时数据以 this.fields = { [name]: { value, errors, validating, dirty, touched } } 形式存储。以下是字段实时数据中各属性的意义。</p>
<ul>
<li>value 字段的值。</li>
<li>errors 校验文案，数组形式。</li>
<li>validating 校验状态。</li>
<li>dirty 脏值标识。真值时意味着字段数据已作变更，但未作校验。</li>
<li>touched 更新标识。真值时意味着用户行为已促使字段数据发生了变更。</li>
</ul>
<p>对于元数据，rc-form 实现的访问器机制极为简单，即通过 setFieldMeta(name, meta) 赋值或更新某个字段的元数据，通过 getFieldMeta(name) 获取某个字段的元数据。辅助方法 getAllFieldsName 用于获取 this.feildsMeta 中所有字段名列表。同时，元数据是在字段组件渲染阶段创建的，其存在与否也意味字段组件是否呈现在视图中。实例方法 flattenRegisteredFields(fields) 即基于此实现，既校验与参数 fields 数据的字段组件是否已渲染，又将 fields 数据扁平化。特别的，setFieldsInitialValue(initialValues) 实例方法首先将参数 initialValues 注入为 flattenRegisteredFields 方法的参数以校验相关的字段组件是否以渲染，再将初始值写入 feildsMeta 属性中。因此，针对元数据的操作包含 setFieldMeta, getFieldMeta, setFieldsInitialValue 以及下文的 clearField 四种。</p>
<p>对于实时数据，rc-form 实现的访问器机制较为复杂。其一，未经用户操作字段组件或开发者显示调用 setFields 赋值表单数据，字段的实时数据将不存在 fields 属性中（下文将这些字段称为未收集字段）；其二，既需要支持全量更新表单的实时数据，又需要支持部分更新表单的实时数据；其三，字段中的实时数据成员需要单独获取。以上第一条，使得 FieldsStore 并不存在 getFields 方法，而是先通过 getNotCollectedFields 方法获取未收集字段的初始值，再构建 getNestedAllFields 方法遍历 fields 中的字段以获取到收集到的实时数据；第二条，FieldsStore 提供 updateFields(fields) 方法用于全量更新实时数据，setFields(fields) 用于部分更新实时数据；第三条，使 FieldsStore 在 getField(name) 获取字段的实时数据以外，还提供 getFieldMember(name, member) 用于获取实时数据的成员，并以此构建了 isFieldValidating, isFieldTouched 方法，用于获取字段的校验状态和更新状态。</p>
<p>当然，表单除了更新数据和单字段实时数据获取以外，还有对实时数据如表单数据、校验信息和校验状态的全量获取。为此，FieldsStore 先行提供了辅助函数。其中，getAllFieldsName 基于 fieldsMeta 元数据，获取表单的全量字段名；getValidFieldsName 方法用于获取剔除虚拟隐藏项后的字段名列表；getValidFieldsFullName(maybePartialName) 方法基于 getValidFieldsName，所有以 maybePartialName 起始或等值的字段名列表，但不包含虚拟隐藏项。在此基础上，getNestedField(name, getter) 方法将获取所有以 name 起始或等值的字段名列表，并使用 reduce 方法加以遍历，通过 getter(name) 函数如 getFieldError 等实例方法，以获取字段数据或校验信息。不同于 getNestedField 先使用 getValidFieldsFullName 方法获取匹配的字段名列表，getNestedFields(names, getter) 则直接使用 reduce 遍历参数 names 或剔除虚拟隐藏项后的字段名列表，以获取字段数据或校验信息。</p>
<p>由于字段值的特殊性，即当实时数据尚未存入 fields 时，须以 fieldsMeta 中的初始值代替。因此，FieldsStore 提供了 getValueFromFields(name, fields) 用于从参数 fields 中的实时值或 fieldsMeta 元数据中的初始值。</p>
<p>有了这些辅助函数，FieldsStore 才得以实现：</p>
<ul>
<li>getFieldValue(name) 用于获取匹配字段的值（匹配字段指以 name 起始或与 name 等值的字段，下同）。</li>
<li>getFieldError(name) 用于获取匹配字段的校验信息。</li>
<li>isFieldValidating(name) 用于获取匹配字段的校验状态。</li>
<li>isFieldTouched(name) 用于获取匹配字段的更新标识。</li>
<li>getFieldsValue(names) 用于获取指定字段或表单的全量值数据，但不包含虚拟隐藏项；</li>
<li>getFieldsError(names) 用于获取指定字段或表单的全量校验信息，但不包含虚拟隐藏项。</li>
<li>isFieldsValidating(names) 用于获取指定字段或表单的全量校验状态，但不包含虚拟隐藏项。</li>
<li>isFieldsTouched(names) 用于获取指定字段或表单的全量更新标识，但不包含虚拟隐藏项。</li>
</ul>
<p>除此以外，FieldsStore 中与 BaseForm 交互相关的方法还包含：</p>
<ul>
<li>getFieldValuePropValue(fieldMeta) 基于参数 fieldMeta 获取注入字段组件的 props 属性。该 props 属性为字段的值内容，可经由 fieldMeta.valuePropName, fieldMeta.getValueProps(value) 处理，通过 BaseForm 实例的 getFieldProps 方法注入字段组件。</li>
<li>getAllValues 根据 fieldsMeta 属性获取表单的全量数据，包含虚拟隐藏项。</li>
<li>setFieldsInitialValue 见上文，设置字段的初始值。</li>
<li>updateFields(fields) 见上文，全量更新表单的实时数据。</li>
<li>setFields(fields) 见上文，部分更新表单的实时数据。</li>
<li>resetFields(ns) 方法只输出匹配字段或全部字段的空值（这些字段的实时数据均已收集），本身并不改变 fields 存储的数据。</li>
<li>clearField(name) 用于清除字段的元数据和实时数据。</li>
</ul>
<h3 id="BaseForm"><a href="#BaseForm" class="headerlink" title="BaseForm"></a>BaseForm</h3><p>如上文所说，BaseForm 作为自定义组件的外层容器，它用于为字段组件绑定数据收集和校验的方法，以更新 FieldsStore 实例存储的实时数据，同时将操作表单的工具函数集通过 props 注入到用户自定义表单中。其实现为：</p>
<p>首先，通过 createBaseForm(option, mixins) 创建装饰函数。装饰函数可以为用户自定义表单组件包裹上 HOC 容器，即 BaseForm 组件。参数 option 能为 HOC 组件提供 validateMessages, onFieldsChange, onValuesChange, mapProps, mapPropsToFields, fieldNameProp, fieldMetaProp, fieldDataProp, formPropName, name 配置项，参数 mixins 为混入 HOC 组件的实例方法。</p>
<ul>
<li>validateMessages 用于更改 <a href="https://github.com/yiminghe/async-validator" target="_blank" rel="noopener">async-validator</a> 库的配置文案。</li>
<li>onFieldsChange(props, changedFields, oldFields) 当 BaseForm 组件实例的 setFields 方法执行时被调用，包含用户行为促使数据收集或校验时，开发者显式调用 setFields, setFieldsValue, resetFields 时，BaseForm 机制 saveRef 方法执行阶段恢复实时数据时（见下文）。</li>
<li>onValuesChange(props, changedValues, oldValues) 当用户行为触发表单数据收集或校验时（在 onFieldsChange 方法前执行），或开发者显示调用 setFieldsValue 方法时（在 onFieldsChange 方法后执行），都将调用 onValuesChange 函数。</li>
<li>mapProps({ [formPropName] }, restProps) 用于修改注入自定义表单组件的 props。{ [formPropName] } 即 BaseForm 组件实例注入用户自定义组件的表单操作函数集；执行上下文为 BaseForm 组件实例。</li>
<li>mapPropsToFields(props) 将 BaseForm 组件实例获得的 props 转化为 FieldsStore 构造器的参数 fields，通常用于将状态管理器中的 store 数据转换为表单所需的 fields。</li>
<li>fieldNameProp 作为字段组件接受字段名的 props 属性名，其值默认为字段名或表单名加字段名的形式，因此可以通过访问字段组件实例的 props 获取到字段名。</li>
<li>fieldMetaProp 作为字段组件接受元数据的 props 属性名，因此可以通过访问字段组件实例的 props 获取到该字段的元数据。</li>
<li>fieldDataProp 作为字段组件接受实时数据的 props 属性名，因此可以通过访问字段组件实例的 props 获取到该字段的实时数据。</li>
<li>formPropName 作为自定义表单组件接受表单操作函数集的 props 属性名，默认为 ‘form’。</li>
<li>name 表单名。</li>
</ul>
<p>其次，在 BaseForm 组件实例的 getInitialState 阶段，将调用 option.mapPropsToFields 以获得初始 fields，并创建 FieldsStore 实例（备注：在 BaseForm 组件的 componentWillReceiveProps 生命周期中，也将调用 option.mapPropsToFields 获取 fields，以便使用 FieldsStore 实例的 updateFields 全量更新缓存数据）。除此而外，getInitialState 方法还将创建 instances, cachedBind, clearedFieldMetaCache, renderFields, domFields 缓存，并为 BaseForm 组件注入 getFieldsValue, getFieldValue, setFieldsInitialValue, getFieldsError, getFieldError, isFieldValidating, isFieldsValidating, isFieldsTouched, isFieldTouched 实例方法（意义见上文）。</p>
<ul>
<li>instances 缓存字段组件实例。</li>
<li>cachedBind 缓存绑定函数（包含收集和校验字段的实例方法 onCollect, onCollectValidate）及 saveRef 引用函数。</li>
<li>clearedFieldMetaCache 缓存待移除字段的实时数据和元数据。getFieldProps 方法执行时清除 clearedFieldMetaCache[name] 缓存数据。saveRef 方法执行时将根据字段组件的渲染状态，尝试使用 clearedFieldMetaCache[name] 恢复 FieldsStore 实例中的实时数据和元数据，在清除 clearedFieldMetaCache[name] 缓存；或者将 FieldsStore 实例中的实时数据和元数据存入 clearedFieldMetaCache[name] 缓存。见下文。</li>
<li>renderFields 缓存 getFieldProps 方法已执行标识。</li>
<li>domFields 缓存字段组件实例仍在视图中展示的标识。</li>
</ul>
<p>其次，执行 render 方法，将表单操作函数集通过 props 注入用户自定义组件。因此，在用户自定义组件中，开发者可以获取表单的实时数据，或者更新表单数据，或者校验表单，以完成特定渲染。以下是开发者可调用的方法。</p>
<ul>
<li>setFields(maybeNestedFields, callback) 以参数 maybeNestedFields 部分更新 FieldsStore 实例中的实时数据，并执行 option.onFieldsChange 方法，再调用 forceUpdate 重绘表单并执行回调。</li>
<li>setFieldsValue(changedValues, callback) 基于 setFields 方法，更新表单数据，并执行 option.onValuesChange 方法。若 changedValues 中相关的字段组件未作渲染，予以警告提示。</li>
<li>resetFields(ns) 基于 setFields 方法，重置匹配字段的表单数据或全量表单数据，并清除相关字段的 clearedFieldMetaCache 缓存。</li>
<li>validateFields(ns, opt, cb) 基于 validateFieldsInternal，校验匹配字段的表单数据或全量表单数据。参数 opt 作为 validateFieldsInternal 的参数 options，cb 为校验完成后的回调。</li>
<li>getFieldInstance(name)，获取字段组件实例。</li>
</ul>
<p>其次，在渲染字段组件的过程中，BaseForm 提供 getFieldProps 实例方法用于装饰注入字段组件的 props，以及 getFieldDecorator 实例方法用于装饰字段组件。</p>
<ul>
<li>getFieldProps(name, usersFieldOption) 首先将清理 clearedFieldMetaCache 缓存，其次为 FieldsStore 实例收集字段的元数据，如转换校验规则；最终将输出转化后的 props 以用于字段组件的渲染。相关 props 属性包含：指定字段组件的 ref 引用函数为 BaseForm 内置的 saveRef 实例方法；为字段组件绑定 onCollect, onCollectValidate 实例方法，以在用户行为发生时收集或校验表单数据；将元数据 { [fieldMetaProp]: fieldMeta }，实时数据 { [fieldDataProp]: field }，字段名 { [fieldNameProp]: name } 注入字段组件实例。</li>
<li>getFieldDecorator(name, fieldOption) 基于 getFieldProps 方法，直接装饰字段组件，以获得开发者设定在字段组件实例上的 ref 引用函数及 props.onChange 等绑定函数等，并以 fieldMeta.ref, fieldMeta.originalProps 形式存入元数据中。这样就能在 BaseForm 实例的 saveRef 执行过程中，可以调用开发者设定在字段组件实例上的 ref 引用函数；在 BaseForm 实例的 onCollect, onCollectValidate 执行过程中，可以调用开发者设定在字段组件实例上的 onChange 绑定函数。getFieldDecorator 函数也将使用初始值绘制字段项。</li>
</ul>
<p>为字段组件绑定的 onCollect, onCollectValidate 方法均基于 onCollectCommon(name, action, args) 实例方法。其执行逻辑为：在 action 事件触发时，首先调用开发者配置的绑定函数 fieldMeta[action] 或 fieldMeta.originalProps[action]，其次通过 fieldMeta.getValueFromEvent 从 event 对象获取字段的值或者取值，其次执行挂载于表单上的 option.onValuesChange 绑定函数，最终返回 { name, field, fieldMeta }。下面是 onCollect, onCollectValidate 方法的简要实现逻辑。</p>
<ul>
<li>onCollect(name_, action, …args) 基于 setFields 方法，在事件触发时，实时更新 FieldsStore 实例存储的实时数据。</li>
<li>onCollectValidate(name_, action, …args) 基于 validateFieldsInternal, setFields 方法，在事件触发时，既实时更新 FieldsStore 实例存储的实时数据，又实时校验字段。</li>
</ul>
<p>对于字段组件，BaseForm 有一种缓存刷新机制。当字段组件实例从视图中移除时，须得调用 FieldsStore 实例的 clearField 方法以清除缓存的实时数据和元数据。这一过程通常在 ref 引用函数内执行，通过参数 —— 组件实例的真值情况判断字段组件是否已作销毁。而当字段组件更新时，react 16 的机制会在 getFieldProps 方法执行之后，调用两次 ref 引用函数，第一次 ref 引用函数的参数为否值，表示前一个实例需要被销毁；第二次 ref 引用函数的参数为真值，表示创建新的字段组件实例。当执行第一次 ref 引用函数时，FieldsStore 实例的实时数据和元数据都将被销毁。这样，即便字段组件仍旧在视图中有所表现，元数据如校验规则的丢失也将使促使字段组件在值变更时无法得到正常的校验。鉴于此，BaseForm 提供 clearedFieldMetaCache 属性缓存待移除字段的实时数据和元数据，且在第二次执行 ref 引用函数时尝试恢复 FieldsStore 实例中的相应数据。</p>
<ul>
<li>saveRef(name, _, component) 作为 BaseForm 为字段组件提供的引用函数，其在字段组件挂载、卸载、重绘阶段都会被调用。可根据参数 component 判断组件的渲染状态。当 component 为空值，使用 clearedFieldMetaCache[name] = { field, meta } 收集字段的元数据和表单数据，并清除 FieldsStore 实例中的相关数据，清理 instances[name], cachedBind[name] 等缓存；若 component 为字段组件实例，domFields[name] 缓存标记将置为真值，instances[name] 将缓存字段组件实例，并尝试使用 clearedFieldMetaCache 缓存以恢复 FieldsStore 实例中的相关数据，等恢复完成后，再行清理 clearedFieldMetaCache[name] 缓存。</li>
<li>recoverClearedField(name) 通过 clearedFieldMetaCache[name] 缓存恢复 FieldsStore 实例存储的字段实时数据和元数据，完成后清除 clearedFieldMetaCache[name] 缓存。</li>
</ul>
<p>字段数据缓存并恢复机制的相关源码为：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">getFieldProps(name, usersFieldOption = &#123;&#125;) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!name) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Must call `getFieldProps` with valid name string!'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    warning(</span><br><span class="line">      <span class="keyword">this</span>.fieldsStore.isValidNestedFieldName(name),</span><br><span class="line">      <span class="string">'One field name cannot be part of another, e.g. `a` and `a.b`.'</span></span><br><span class="line">    );</span><br><span class="line">    warning(</span><br><span class="line">      !(<span class="string">'exclusive'</span> <span class="keyword">in</span> usersFieldOption),</span><br><span class="line">      <span class="string">'`option.exclusive` of `getFieldProps`|`getFieldDecorator` had been remove.'</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">delete</span> <span class="keyword">this</span>.clearedFieldMetaCache[name];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> fieldOption = &#123;</span><br><span class="line">    name,</span><br><span class="line">    trigger: DEFAULT_TRIGGER,</span><br><span class="line">    valuePropName: <span class="string">'value'</span>,</span><br><span class="line">    validate: [],</span><br><span class="line">    ...usersFieldOption,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    rules,</span><br><span class="line">    trigger,</span><br><span class="line">    validateTrigger = trigger,</span><br><span class="line">    validate,</span><br><span class="line">  &#125; = fieldOption;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> fieldMeta = <span class="keyword">this</span>.fieldsStore.getFieldMeta(name);</span><br><span class="line">  <span class="keyword">if</span> (<span class="string">'initialValue'</span> <span class="keyword">in</span> fieldOption) &#123;</span><br><span class="line">    fieldMeta.initialValue = fieldOption.initialValue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> inputProps = &#123;</span><br><span class="line">    ...this.fieldsStore.getFieldValuePropValue(fieldOption),</span><br><span class="line">    ref: <span class="keyword">this</span>.getCacheBind(name, <span class="string">`<span class="subst">$&#123;name&#125;</span>__ref`</span>, <span class="keyword">this</span>.saveRef),</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">if</span> (fieldNameProp) &#123;</span><br><span class="line">    inputProps[fieldNameProp] = formName ? <span class="string">`<span class="subst">$&#123;formName&#125;</span>_<span class="subst">$&#123;name&#125;</span>`</span> : name;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> validateRules = normalizeValidateRules(validate, rules, validateTrigger);</span><br><span class="line">  <span class="keyword">const</span> validateTriggers = getValidateTriggers(validateRules);</span><br><span class="line">  validateTriggers.forEach(<span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (inputProps[action]) <span class="keyword">return</span>;</span><br><span class="line">    inputProps[action] = <span class="keyword">this</span>.getCacheBind(name, action, <span class="keyword">this</span>.onCollectValidate);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// make sure that the value will be collect</span></span><br><span class="line">  <span class="keyword">if</span> (trigger &amp;&amp; validateTriggers.indexOf(trigger) === <span class="number">-1</span>) &#123;</span><br><span class="line">    inputProps[trigger] = <span class="keyword">this</span>.getCacheBind(name, trigger, <span class="keyword">this</span>.onCollect);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> meta = &#123;</span><br><span class="line">    ...fieldMeta,</span><br><span class="line">    ...fieldOption,</span><br><span class="line">    validate: validateRules,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">this</span>.fieldsStore.setFieldMeta(name, meta);</span><br><span class="line">  <span class="keyword">if</span> (fieldMetaProp) &#123;</span><br><span class="line">    inputProps[fieldMetaProp] = meta;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fieldDataProp) &#123;</span><br><span class="line">    inputProps[fieldDataProp] = <span class="keyword">this</span>.fieldsStore.getField(name);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This field is rende#f81d22, record it</span></span><br><span class="line">  <span class="keyword">this</span>.renderFields[name] = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> inputProps;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">saveRef(name, _, component) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!component) &#123;</span><br><span class="line">    <span class="comment">// after destroy, delete data</span></span><br><span class="line">    <span class="keyword">this</span>.clearedFieldMetaCache[name] = &#123;</span><br><span class="line">      field: <span class="keyword">this</span>.fieldsStore.getField(name),</span><br><span class="line">      meta: <span class="keyword">this</span>.fieldsStore.getFieldMeta(name),</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">this</span>.clearField(name);</span><br><span class="line">    <span class="keyword">delete</span> <span class="keyword">this</span>.domFields[name];</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.domFields[name] = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">this</span>.recoverClearedField(name);</span><br><span class="line">  <span class="keyword">const</span> fieldMeta = <span class="keyword">this</span>.fieldsStore.getFieldMeta(name);</span><br><span class="line">  <span class="keyword">if</span> (fieldMeta) &#123;</span><br><span class="line">    <span class="keyword">const</span> ref = fieldMeta.ref;</span><br><span class="line">    <span class="keyword">if</span> (ref) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> ref === <span class="string">'string'</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`can not set ref string for <span class="subst">$&#123;name&#125;</span>`</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      ref(component);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.instances[name] = component;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">recoverClearedField(name) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.clearedFieldMetaCache[name]) &#123;</span><br><span class="line">    <span class="keyword">this</span>.fieldsStore.setFields(&#123;</span><br><span class="line">      [name]: <span class="keyword">this</span>.clearedFieldMetaCache[name].field,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">this</span>.fieldsStore.setFieldMeta(name, <span class="keyword">this</span>.clearedFieldMetaCache[name].meta);</span><br><span class="line">    <span class="keyword">delete</span> <span class="keyword">this</span>.clearedFieldMetaCache[name];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>其次，在 BaseForm 组件的 componentDidMount, componentDidUpdate 生命周期中，将调用 cleanUpUselessFields 实例方法，以根据 renderFields, domFields 缓存判断字段组件渲染状态，如字段组件未作渲染，调用 clearField 实例方法清理 FieldsStore 实例存储的字段实时数据和元数据、以及 instances[name], cachedBind[name] 缓存。</p>
<p>以上功能的实现基于 getCacheBind, getRules, validateFieldsInternal 实例方法。其中，getRules(fieldMeta, action) 用于从 fieldMeta 元数据中获取指定事件的校验规则。下面是 getCacheBind, validateFieldsInternal 方法的简要实现逻辑及相关源码。</p>
<ul>
<li>getCacheBind(name, action, fn) 以 cachedBind[name][action] = { fn, oriFn } 形式缓存 onCollect, onCollectValidate, saveRef 方法，便于使用 name 进行查找。</li>
<li>validateFieldsInternal(fields, { fieldNames, action, options }, callback) 校验指定字段。可复用之前的校验结果，收集待校验的字段并予以校验，转化校验文案并执行 callback 回调。若异步校验期间字段的值发生改变，将得到校验已过期文案。在校验起始阶段，调用 setFields 记录校验中状态；校验结束阶段，调用 setFields 记录校验结果。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">getCacheBind(name, action, fn) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="keyword">this</span>.cachedBind[name]) &#123;</span><br><span class="line">    <span class="keyword">this</span>.cachedBind[name] = &#123;&#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> cache = <span class="keyword">this</span>.cachedBind[name];</span><br><span class="line">  <span class="keyword">if</span> (!cache[action] || cache[action].oriFn !== fn) &#123;</span><br><span class="line">    cache[action] = &#123;</span><br><span class="line">      fn: fn.bind(<span class="keyword">this</span>, name, action),</span><br><span class="line">      oriFn: fn,</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> cache[action].fn;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">validateFieldsInternal(fields, &#123;</span><br><span class="line">  fieldNames,</span><br><span class="line">  action,</span><br><span class="line">  options = &#123;&#125;,</span><br><span class="line">&#125;, callback) &#123;</span><br><span class="line">  <span class="keyword">const</span> allRules = &#123;&#125;;</span><br><span class="line">  <span class="keyword">const</span> allValues = &#123;&#125;;</span><br><span class="line">  <span class="keyword">const</span> allFields = &#123;&#125;;</span><br><span class="line">  <span class="keyword">const</span> alreadyErrors = &#123;&#125;;</span><br><span class="line">  fields.forEach(<span class="function">(<span class="params">field</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> name = field.name;</span><br><span class="line">    <span class="keyword">if</span> (options.force !== <span class="literal">true</span> &amp;&amp; field.dirty === <span class="literal">false</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (field.errors) &#123;</span><br><span class="line">        <span class="keyword">set</span>(alreadyErrors, name, &#123; errors: field.errors &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> fieldMeta = <span class="keyword">this</span>.fieldsStore.getFieldMeta(name);</span><br><span class="line">    <span class="keyword">const</span> newField = &#123;</span><br><span class="line">      ...field,</span><br><span class="line">    &#125;;</span><br><span class="line">    newField.errors = <span class="literal">undefined</span>;</span><br><span class="line">    newField.validating = <span class="literal">true</span>;</span><br><span class="line">    newField.dirty = <span class="literal">true</span>;</span><br><span class="line">    allRules[name] = <span class="keyword">this</span>.getRules(fieldMeta, action);</span><br><span class="line">    allValues[name] = newField.value;</span><br><span class="line">    allFields[name] = newField;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">this</span>.setFields(allFields);</span><br><span class="line">  <span class="comment">// in case normalize</span></span><br><span class="line">  <span class="built_in">Object</span>.keys(allValues).forEach(<span class="function">(<span class="params">f</span>) =&gt;</span> &#123;</span><br><span class="line">    allValues[f] = <span class="keyword">this</span>.fieldsStore.getFieldValue(f);</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">if</span> (callback &amp;&amp; isEmptyObject(allFields)) &#123;</span><br><span class="line">    callback(isEmptyObject(alreadyErrors) ? <span class="literal">null</span> : alreadyErrors,</span><br><span class="line">      <span class="keyword">this</span>.fieldsStore.getFieldsValue(fieldNames));</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> validator = <span class="keyword">new</span> AsyncValidator(allRules);</span><br><span class="line">  <span class="keyword">if</span> (validateMessages) &#123;</span><br><span class="line">    validator.messages(validateMessages);</span><br><span class="line">  &#125;</span><br><span class="line">  validator.validate(allValues, options, (errors) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> errorsGroup = &#123;</span><br><span class="line">      ...alreadyErrors,</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> (errors &amp;&amp; errors.length) &#123;</span><br><span class="line">      errors.forEach(<span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> fieldName = e.field;</span><br><span class="line">        <span class="keyword">const</span> field = <span class="keyword">get</span>(errorsGroup, fieldName);</span><br><span class="line">        if (typeof field !== 'object' || Array.isArray(field)) &#123;</span><br><span class="line">          <span class="keyword">set</span>(errorsGroup, fieldName, &#123; errors: [] &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">const</span> fieldErrors = <span class="keyword">get</span>(errorsGroup, fieldName.concat('.errors'));</span><br><span class="line">        fieldErrors.push(e);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    const expired = [];</span><br><span class="line">    const nowAllFields = &#123;&#125;;</span><br><span class="line">    <span class="built_in">Object</span>.keys(allRules).forEach(<span class="function">(<span class="params">name</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> fieldErrors = <span class="keyword">get</span>(errorsGroup, name);</span><br><span class="line">      const nowField = this.fieldsStore.getField(name);</span><br><span class="line">      // avoid concurrency problems</span><br><span class="line">      if (nowField.value !== allValues[name]) &#123;</span><br><span class="line">        expired.push(&#123;</span><br><span class="line">          name,</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        nowField.errors = fieldErrors &amp;&amp; fieldErrors.errors;</span><br><span class="line">        nowField.value = allValues[name];</span><br><span class="line">        nowField.validating = <span class="literal">false</span>;</span><br><span class="line">        nowField.dirty = <span class="literal">false</span>;</span><br><span class="line">        nowAllFields[name] = nowField;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">this</span>.setFields(nowAllFields);</span><br><span class="line">    <span class="keyword">if</span> (callback) &#123;</span><br><span class="line">      <span class="keyword">if</span> (expired.length) &#123;</span><br><span class="line">        expired.forEach(<span class="function">(<span class="params">&#123; name &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">const</span> fieldErrors = [&#123;</span><br><span class="line">            message: <span class="string">`<span class="subst">$&#123;name&#125;</span> need to revalidate`</span>,</span><br><span class="line">            field: name,</span><br><span class="line">          &#125;];</span><br><span class="line">          <span class="keyword">set</span>(errorsGroup, name, &#123;</span><br><span class="line">            expired: <span class="literal">true</span>,</span><br><span class="line">            errors: fieldErrors,</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      callback(isEmptyObject(errorsGroup) ? <span class="literal">null</span> : errorsGroup,</span><br><span class="line">        <span class="keyword">this</span>.fieldsStore.getFieldsValue(fieldNames));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><ol>
<li><p>createForm(options) 基于 createBaseForm，为 HOC 组件注入默认的 getForm 方法，将 form 表单操作函数工具集通过 props 注入到用户自定义表单组件中。form 中含有的方法，参见上文。</p>
</li>
<li><p>createDOMForm(option) 基于 createBaseForm，在传递给用户自定义表单组件的 props.form 混入 validateFieldsAndScroll 方法，校验失败时滚动到首个错误字段处。该方法引用了 react-dom，只适用于浏览器平台，不适用于手机端。</p>
<ul>
<li>validateFieldsAndScroll(ns, opt, cb) 基于 dom-scroll-into-view 库实现，首先通过 getBoundingClientRect 获得校验失败字段的 top 值，其次通过 getComputedStyle 或 style 属性获得字段节点首个滚动的父元素，最后调用 dom-scroll-into-view 库提供的 api 滚动页面。</li>
</ul>
</li>
<li><p>FormScope 以组件形式提供接口。option 配置项通过 props 传入，在 render 阶段调用 createDOMForm，并将 form 传入函数组件 children 中。</p>
</li>
<li><p>createFormField 生成 Field 实例。</p>
</li>
</ol>
<h2 id="antd-Form-组件"><a href="#antd-Form-组件" class="headerlink" title="antd-Form 组件"></a>antd-Form 组件</h2><h3 id="Form-组件"><a href="#Form-组件" class="headerlink" title="Form 组件"></a>Form 组件</h3><p>Form 组件本身并不承载逻辑，而是通过 props.className, props.prefixCls, props.layout, props.hideRequiredMark, props.onSubmit 设定注入 form 原生节点的样式类及绑定函数，以影响表单内部节点渲染时的样式。同时，Form 组件将为子组件传入 context.vertical 以区分是水平布局，还是垂直布局。</p>
<p>Form 组件拥有 Item 静态属性指向 FormItem 组件；createFormField 静态方法指向 rc-form 提供的同名方法；createForm 静态方法调用 rc-form 提供的 createBaseForm 方法，用于装饰用户自定义表单组件。</p>
<h3 id="FormItem-组件"><a href="#FormItem-组件" class="headerlink" title="FormItem 组件"></a>FormItem 组件</h3><p>FormItem 组件用于设定表单项的布局，其可配置的 props 属性包含必填标记 hideRequiredMark, 字段名 label, 校验文案 help, 额外内容 extra。</p>
<p>同受控组件和非受控组件，FormItem 组件提供两种使用方式：其一，当未设定校验信息相关的 props 属性时，FormItem 组件将自动根据内部字段组件实例的状况渲染校验文案及校验状态；其二，当设定校验信息相关的 props 属性时，FormItem 组件将根据开发者传入的 props 渲染校验文案及校验状态。在第一种使用方式下，FormItem 组件只可以包含一个字段组件；在第二种使用方式下，FormItem 组件中可以包含多个字段组件，布局也更为灵活。这里说的相关 props 属性包含：校验文案 help, 校验状态 validateStatus（用于绘制反馈图标）, 必填标识 required, 字段名 id（影响点击 label 时聚焦哪个字段元素）。</p>
<p>那么，FormItem 又是怎样自动收集字段组件的校验数据呢？因为在 BaseForm  组件提供的 getFieldProp 方法，字段的字段名、元数据和实时数据都将作为特殊的 props 属性传入到字段组件中，所以作为字段组件容器的 FormItem，就可以通过这些特殊的 props 属性判断子组件实例是不是一个字段组件实例，当其为字段组件实例时，进一步收集实时的校验信息，从校验规则中获取是否必填标识，以完成渲染。</p>
<p>此外，FormItem 可以使用 props.labelCol, props.wrapperCol 属性栅格化布局标签组件和字段组件，其实现借助于 antd 提供的 Row, Col 组件。当点击标签 label 时，FormItem 提供的绑定函数能为字段组件获得焦点。这里不再多加介绍。</p>
<p>获取字段组件实例的相关源码为：<br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">getControls(children: React.ReactNode, <span class="attr">recursively</span>: boolean) &#123;</span><br><span class="line">  <span class="keyword">let</span> controls: React.ReactElement&lt;any&gt;[] = [];</span><br><span class="line">  <span class="keyword">const</span> childrenArray = React.Children.toArray(children);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; childrenArray.length; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!recursively &amp;&amp; controls.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> child = childrenArray[i] <span class="keyword">as</span> React.ReactElement&lt;any&gt;;</span><br><span class="line">    <span class="keyword">if</span> (child.type &amp;&amp;</span><br><span class="line">      (child.type <span class="keyword">as</span> any === FormItem || (child.type <span class="keyword">as</span> any).displayName === <span class="string">'FormItem'</span>)) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!child.props) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (FIELD_META_PROP <span class="keyword">in</span> child.props) &#123; <span class="comment">// And means FIELD_DATA_PROP in child.props, too.</span></span><br><span class="line">      controls.push(child);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.props.children) &#123;</span><br><span class="line">      controls = controls.concat(<span class="keyword">this</span>.getControls(child.props.children, recursively));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> controls;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上即简要分析了 ant-desing 中 Form 组件的实现，文中难免有谬误或思考上的不足处，仍望读者海涵。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/10/react/react相关/react-jsonschema-form源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/10/react/react相关/react-jsonschema-form源码分析/" itemprop="url">react-jsonschema-form源码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-10T00:00:00+08:00">2018-10-10</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/类库/" itemprop="url" rel="index"><span itemprop="name">类库</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/10/10/react/react相关/react-jsonschema-form源码分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/10/10/react/react相关/react-jsonschema-form源码分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/8/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/8/">8</a><span class="page-number current">9</span><a class="page-number" href="/page/10/">10</a><span class="space">&hellip;</span><a class="page-number" href="/page/12/">12</a><a class="extend next" rel="next" href="/page/10/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpeg" alt="Alfred">
            
              <p class="site-author-name" itemprop="name">Alfred</p>
              <p class="site-description motion-element" itemprop="description">人苦不知足，既得陇，复望蜀</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">119</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    <span class="site-state-item-count">36</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    <span class="site-state-item-count">26</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Alfred-sg" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/xiu-fan-79/activities" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-globe"></i>知乎</a>
                  </span>
                
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Alfred</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Pisces</a> v6.0.2</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.0.2"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.2"></script>



  

  
    <script id="dsq-count-scr" src="https://alfred.disqus.com/count.js" async></script>
  

  





	





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->





  

  

  

  

  
  

  

  

  

  

</body>
</html>
