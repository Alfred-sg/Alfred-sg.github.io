<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.0.2" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.2">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.2" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.0.2',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="Hexo, NexT">


<meta name="description" content="人苦不知足，既得陇，复望蜀">
<meta property="og:type" content="website">
<meta property="og:title" content="修子范语">
<meta property="og:url" content="http://yoursite.com/page/12/index.html">
<meta property="og:site_name" content="修子范语">
<meta property="og:description" content="人苦不知足，既得陇，复望蜀">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="修子范语">
<meta name="twitter:description" content="人苦不知足，既得陇，复望蜀">






  <link rel="canonical" href="http://yoursite.com/page/12/">


  <title>修子范语</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">修子范语</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Alfredo's Notes</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/24/Js/flow使用指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/24/Js/flow使用指南/" itemprop="url">flow使用指南</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-24T00:00:00+08:00">2018-02-24</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端工程化/" itemprop="url" rel="index"><span itemprop="name">前端工程化</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/24/Js/flow使用指南/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/02/24/Js/flow使用指南/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>flow 是 facebook 推出的 js 代码类型检查工具。</p>
<p>flow 可借助 babel 编译，添加 babel-preset-flow 即可；babel-preset-react 包含 babel-preset-flow。或者借助安装 flow-bin 启动类型检查，flow-remove-types 移除类型标记。</p>
<p>通过在脚本前添加 // @flow 或 /<em> @flow </em>/ 将文件标注为需要类型校验的，否则将会跳过 flow 校验（除非执行 flow check –all 命令校验所有文件）。</p>
<h2 id="类型标注-Type-Annotations"><a href="#类型标注-Type-Annotations" class="headerlink" title="类型标注/Type Annotations"></a>类型标注/Type Annotations</h2><h3 id="基础类型-Primitive-Types"><a href="#基础类型-Primitive-Types" class="headerlink" title="基础类型/Primitive Types"></a>基础类型/Primitive Types</h3><p>flow 支持校验的基础数据类型包含 boolean, string, number, null, undefined（在 flow 中，使用 void 标注）。es6 的 symbol 类型尚不支持。</p>
<p>boolean, string, number 字面量使用小写形式标注类型；包装对象如 new Number(10) 使用大写形式标注类型。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">method</span>(<span class="params">x: number, y: string, z: boolean</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">method(<span class="number">3.14</span>, <span class="string">"hello"</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">method</span>(<span class="params">x: Number, y: String, z: Boolean</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">method(<span class="keyword">new</span> <span class="built_in">Number</span>(<span class="number">42</span>), <span class="keyword">new</span> <span class="built_in">String</span>(<span class="string">"world"</span>), <span class="keyword">new</span> <span class="built_in">Boolean</span>(<span class="literal">false</span>));</span><br></pre></td></tr></table></figure>
<h3 id="字面量类型-Literal-Types"><a href="#字面量类型-Literal-Types" class="headerlink" title="字面量类型/Literal Types"></a>字面量类型/Literal Types</h3><p>flow 允许使用字面量作为类型标注，约定仅接受该字面量，如 value: 2 将仅接受数值 2，其他报错。</p>
<h3 id="混合类型-Mixed-Types、任意类型-Any-types"><a href="#混合类型-Mixed-Types、任意类型-Any-types" class="headerlink" title="混合类型/Mixed Types、任意类型/Any types"></a>混合类型/Mixed Types、任意类型/Any types</h3><p>使用 mixed 标注可接受任意类型数据，但在使用时需显示校验类型。</p>
<p>使用 any 标注可接受任意类型数据，且在使用时也跳过校验。若作为对象，其下的所有属性均采用 any 类型形式。需要避免使用 any 类型。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stringify</span>(<span class="params">value: mixed</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// $ExpectError</span></span><br><span class="line">  <span class="keyword">return</span> <span class="string">""</span> + value; <span class="comment">// Error!</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stringify(<span class="string">"foo"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stringify</span>(<span class="params">value: mixed</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'string'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span> + value; <span class="comment">// Works!</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">""</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">stringify(<span class="string">"foo"</span>);</span><br></pre></td></tr></table></figure>
<h3 id="数组-Array-Types"><a href="#数组-Array-Types" class="headerlink" title="数组/Array Types"></a>数组/Array Types</h3><p>数组通过 Array<type> 或 Type[] 标注，元素的类型必须一致，但可以是 undefined 或 null，如 Array<number> 或 number[]。</number></type></p>
<h3 id="元祖-Tuple-Types"><a href="#元祖-Tuple-Types" class="headerlink" title="元祖/Tuple Types"></a>元祖/Tuple Types</h3><p>元祖通过 [type, type, type] 形式标注，即元素的类型单独标注，且元素不能增删，因此不能使用 push, pop 等数组原型方法，但可以使用 join 等方法，不同长度的元祖不能相互赋值，元祖和数组之间也不能相互赋值，如 [number, boolean, void]，该元祖标识可接受赋值如 [1, true]。</p>
<h3 id="函数-Function-Types"><a href="#函数-Function-Types" class="headerlink" title="函数/Function Types"></a>函数/Function Types</h3><p>flow 可标注函数入参和返回值，如 function concat(a: string, b: string): string { return a + b; }。</p>
<p>可选参数通过 ‘?’ 后缀标注，如 function acceptsOptionalString(value?: string) { }，参数可以是 undefined。</p>
<p>默认参数可使用如下形式 function method(value: string = “default”) { /<em> … </em>/ }，参数可以是 undefined，但不能为 null。</p>
<p>解构参数通过数组类型标注，如 function method(…args: Array<number>) { }。</number></p>
<p>函数类型校验或者通过添加设定入参返回值标注，或者通过添加设定 Funtion 标注，如 function method(func: () =&gt; mixed) { } 或 function method(func: Function) { }。</p>
<h3 id="对象-Object-Types"><a href="#对象-Object-Types" class="headerlink" title="对象/Object Types"></a>对象/Object Types</h3><p>对象通过 { propname: Type } 形式标注，如 var obj2: { foo: number, bar: boolean, baz: string, } = { foo: 1, bar: true, baz: ‘three’, }。</p>
<p>可选属性通过 ‘?’ 后缀标注，如 { propertyName?: string }，propertyName 属性可以是 undefined。</p>
<h3 id="类-Class-Types"><a href="#类-Class-Types" class="headerlink" title="类/Class Types"></a>类/Class Types</h3><p>类本身可作为类型标识。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> myInstance: MyClass = <span class="keyword">new</span> MyClass();</span><br></pre></td></tr></table></figure>
<p>在类中，方法标识同函数，属性在使用前必须先标识。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line">  prop: number;</span><br><span class="line">  method(): <span class="keyword">void</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.prop = <span class="number">42</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>类支持泛型标识。将泛型标识的类作为标识时，必须为所有泛型传递参数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>&lt;<span class="title">A</span>, <span class="title">B</span>, <span class="title">C</span>&gt; </span>&#123;</span><br><span class="line">  property: A;</span><br><span class="line">  method(val: B): C &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span>&lt;<span class="title">A</span>, <span class="title">B</span>, <span class="title">C</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(arg1: A, arg2: B, arg3: C) &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> val: MyClass&lt;number, boolean, string&gt; = <span class="keyword">new</span> MyClass(<span class="number">1</span>, <span class="literal">true</span>, <span class="string">'three'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="接口-Interface-Types"><a href="#接口-Interface-Types" class="headerlink" title="接口/Interface Types"></a>接口/Interface Types</h3><h4 id="接口作为类型标识"><a href="#接口作为类型标识" class="headerlink" title="接口作为类型标识"></a>接口作为类型标识</h4><p>接口可作为类型校验标识（结构类型校验/Structural typing，非名义类型校验/Nominal typing ）。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line">interface Serializable &#123;</span><br><span class="line">  serialize(): string;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;</span><br><span class="line">  serialize() &#123; <span class="keyword">return</span> <span class="string">'[Foo]'</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Bar</span> </span>&#123;</span><br><span class="line">  serialize() &#123; <span class="keyword">return</span> <span class="string">'[Bar]'</span>; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> foo: Serializable = <span class="keyword">new</span> Foo(); <span class="comment">// Works!</span></span><br><span class="line"><span class="keyword">const</span> bar: Serializable = <span class="keyword">new</span> Bar(); <span class="comment">// Works!</span></span><br></pre></td></tr></table></figure>
<p>接口类型通过 ‘+’, ‘-‘ 符号设置只读、只写属性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 当接口作为类型标识</span></span><br><span class="line">interface MyInterface &#123;</span><br><span class="line">  +readOnly: number | string;</span><br><span class="line">  -writeOnly: number | string;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> value: MyInterface = &#123; </span><br><span class="line">  readOnly: <span class="number">3</span>,<span class="comment">// 可读，不可写</span></span><br><span class="line">  writeOnly: number | string<span class="comment">// 可写，不可读</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="接口作为类实现标准"><a href="#接口作为类实现标准" class="headerlink" title="接口作为类实现标准"></a>接口作为类实现标准</h4><p>接口用于类实现/implements，一个类可以实现多个接口。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">interface MyInterface &#123;</span><br><span class="line">  method(value: string): number;</span><br><span class="line">  property?: string;</span><br><span class="line">  [key: string]: number;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用泛型</span></span><br><span class="line">interface MyInterface&lt;A, B, C&gt; &#123;</span><br><span class="line">  foo: A;</span><br><span class="line">  bar: B;</span><br><span class="line">  baz: C;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="泛型-Generic-Types"><a href="#泛型-Generic-Types" class="headerlink" title="泛型/Generic Types"></a>泛型/Generic Types</h3><p>泛型用于在运行时注入特定的类型。以类型标识的变量使用接口中未声明的属性时，须先作校验属性是否存在。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 函数中使用泛型</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">method</span>&lt;<span class="title">T</span>&gt;(<span class="params">value: T</span>): <span class="title">T</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> value;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类使用泛型</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Class</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  prop: T;</span><br><span class="line">  <span class="keyword">constructor</span>(param: T) &#123; &#125;</span><br><span class="line">  method(): T &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 类型别名使用泛型</span></span><br><span class="line">type TypeAlias&lt;T&gt; = &#123;</span><br><span class="line">  key: T</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 接口使用泛型</span></span><br><span class="line">interface Interface&lt;T&gt; &#123;</span><br><span class="line">  prop: T</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logFoo</span>&lt;<span class="title">T</span>: </span>&#123; foo: string &#125;&gt;(obj: T): T &#123;</span><br><span class="line">  <span class="built_in">console</span>.log(obj.foo); <span class="comment">// Works!</span></span><br><span class="line">  <span class="keyword">return</span> obj;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logFoo(&#123; <span class="attr">foo</span>: <span class="string">'foo'</span>, <span class="attr">bar</span>: <span class="string">'bar'</span> &#125;);  <span class="comment">// Works!</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// @flow</span></span><br><span class="line">type Item&lt;T: number = <span class="number">1</span>&gt; = &#123;</span><br><span class="line">  prop: T,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> foo: Item&lt;&gt; = &#123; <span class="attr">prop</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="keyword">let</span> bar: Item&lt;<span class="number">2</span>&gt; = &#123; <span class="attr">prop</span>: <span class="number">2</span> &#125;;</span><br></pre></td></tr></table></figure>
<h3 id="可能的类型-Maybe-types"><a href="#可能的类型-Maybe-types" class="headerlink" title="可能的类型/Maybe types"></a>可能的类型/Maybe types</h3><p>可能的类型通过 ‘?’ 前缀标注，如 ?string，其值可以是 null 或 undefined。</p>
<h3 id="联合类型-Union-Types"><a href="#联合类型-Union-Types" class="headerlink" title="联合类型/Union Types"></a>联合类型/Union Types</h3><p>联合类型使用 ype1 | Type2 | … | TypeN 标注，被标识数据应满足其中一个类型校验。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 联合类型在处理响应的情景中使用，'| ... |'用于避免 success, error 属性冲突</span></span><br><span class="line"><span class="comment">// @flow</span></span><br><span class="line">type Success = &#123;| success: <span class="literal">true</span>, <span class="attr">value</span>: boolean |&#125;;</span><br><span class="line">type Failed  = &#123;| error: <span class="literal">true</span>, <span class="attr">message</span>: string |&#125;;</span><br><span class="line"></span><br><span class="line">type Response = Success | Failed;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleResponse</span>(<span class="params">response: Response</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (response.success) &#123;</span><br><span class="line">    <span class="keyword">var</span> value: boolean = response.value; <span class="comment">// Works!</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> error: string = response.error; <span class="comment">// Works!</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="交叉类型-Intersection-Types"><a href="#交叉类型-Intersection-Types" class="headerlink" title="交叉类型/Intersection Types"></a>交叉类型/Intersection Types</h3><p>交叉类型使用 Type1 &amp; Type2 &amp; … &amp; TypeN 标识，被标识数据应满足所有类型校验，需要由开发者避免类型冲突。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line">type A = &#123; <span class="attr">a</span>: number &#125;;</span><br><span class="line">type B = &#123; <span class="attr">b</span>: boolean &#125;;</span><br><span class="line">type C = &#123; <span class="attr">c</span>: string &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">method</span>(<span class="params">value: A &amp; B &amp; C</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">method(&#123; <span class="attr">a</span>: <span class="number">1</span> &#125;); <span class="comment">// Error!</span></span><br><span class="line">method(&#123; <span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>: <span class="literal">true</span> &#125;); <span class="comment">// Error!</span></span><br><span class="line">method(&#123; <span class="attr">a</span>: <span class="number">1</span>, <span class="attr">b</span>: <span class="literal">true</span>, <span class="attr">c</span>: <span class="string">'three'</span> &#125;); <span class="comment">// Works!</span></span><br></pre></td></tr></table></figure>
<h3 id="类型别名-Type-Aliases"><a href="#类型别名-Type-Aliases" class="headerlink" title="类型别名/Type Aliases"></a>类型别名/Type Aliases</h3><p>为常用的类型设置别名，采用如右形式语法 type Alias = Type。设置别名后，方便复用该类型。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">type NumberAlias = number;</span><br><span class="line">type ObjectAlias = &#123;</span><br><span class="line">  property: string,</span><br><span class="line">  method(): number,</span><br><span class="line">&#125;;</span><br><span class="line">type UnionAlias = <span class="number">1</span> | <span class="number">2</span> | <span class="number">3</span>;</span><br><span class="line">type AliasAlias = ObjectAlias;</span><br><span class="line">type GenericsObjectAlias&lt;A, B, C&gt; = &#123;</span><br><span class="line">  property: A,</span><br><span class="line">  method(val: B): C,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> val: ObjectAlias = &#123; <span class="comment">/* ... */</span> &#125;;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">method</span>(<span class="params">val: ObjectAlias</span>) </span>&#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123; <span class="keyword">constructor</span>(val: ObjectAlias) &#123; <span class="comment">/* ... */</span> &#125; &#125;</span><br><span class="line"><span class="keyword">var</span> myObject: GenericsObjectAlias&lt;number, boolean, string&gt; = &#123;</span><br><span class="line">  property: <span class="number">1</span>,</span><br><span class="line">  method(val: boolean): string &#123; <span class="keyword">return</span> <span class="string">''</span>; &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="不透明的类型别名-Opaque-Type-Aliases"><a href="#不透明的类型别名-Opaque-Type-Aliases" class="headerlink" title="不透明的类型别名/Opaque Type Aliases"></a>不透明的类型别名/Opaque Type Aliases</h4><p>不透明的类型别名不允许在定义该类型别名的文件外使用其基础类型，如 opaque type Alias = Type; 或 opaque type Alias: SuperType = Type 用于约定父类型，Type 必须是 SuperType的子类型，且在声明文件外使用该父类型校验。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 示例 1</span></span><br><span class="line"><span class="comment">// exports.js</span></span><br><span class="line"><span class="keyword">export</span> opaque type NumberAlias = number;</span><br><span class="line"></span><br><span class="line"><span class="comment">// imports.js</span></span><br><span class="line"><span class="keyword">import</span> type &#123;NumberAlias&#125; <span class="keyword">from</span> <span class="string">'./exports'</span>;</span><br><span class="line"></span><br><span class="line">(<span class="number">0</span>: NumberAlias) <span class="comment">// Error: 0 is not a NumberAlias!</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">convert</span>(<span class="params">x: NumberAlias</span>): <span class="title">number</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> x; <span class="comment">// Error: x is not a number!</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例 2</span></span><br><span class="line"><span class="comment">// exports.js</span></span><br><span class="line"><span class="keyword">export</span> opaque type ID: string = string;</span><br><span class="line"></span><br><span class="line"><span class="comment">// imports.js</span></span><br><span class="line"><span class="keyword">import</span> type &#123;ID&#125; <span class="keyword">from</span> <span class="string">'./exports'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">formatID</span>(<span class="params">x: ID</span>): <span class="title">string</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"ID: "</span> + x; <span class="comment">// Ok! IDs are strings.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">toID</span>(<span class="params">x: string</span>): <span class="title">ID</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> x; <span class="comment">// Error: strings are not IDs.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例 3 - 泛型</span></span><br><span class="line"><span class="comment">// @flow</span></span><br><span class="line">opaque type MyObject&lt;A, B, C&gt;: &#123; <span class="attr">foo</span>: A, <span class="attr">bar</span>: B &#125; = &#123;</span><br><span class="line">  foo: A,</span><br><span class="line">  bar: B,</span><br><span class="line">  baz: C,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> val: MyObject&lt;number, boolean, string&gt; = &#123;</span><br><span class="line">  foo: <span class="number">1</span>,</span><br><span class="line">  bar: <span class="literal">true</span>,</span><br><span class="line">  baz: <span class="string">'three'</span>,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例 4 - 使用声明</span></span><br><span class="line">declare opaque type Foo;</span><br><span class="line">declare opaque type PositiveNumber: number;</span><br></pre></td></tr></table></figure>
<h3 id="typeof"><a href="#typeof" class="headerlink" title="typeof"></a>typeof</h3><p>typeof 操作符返回 flow 的数据类型，可能是开发者设置的类型标识。对基本类型，typeof 操作符返回名义类型；对类，typeof 操作符返回结构类型。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="keyword">let</span> num1 = <span class="number">42</span>;</span><br><span class="line"><span class="keyword">let</span> num2: <span class="keyword">typeof</span> num1 = <span class="number">3.14</span>;     <span class="comment">// Works!</span></span><br><span class="line"><span class="keyword">let</span> num3: <span class="keyword">typeof</span> num1 = <span class="string">'world'</span>;  <span class="comment">// Error!</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> bool1 = <span class="literal">true</span>;</span><br><span class="line"><span class="keyword">let</span> bool2: <span class="keyword">typeof</span> bool1 = <span class="literal">false</span>;  <span class="comment">// Works!</span></span><br><span class="line"><span class="keyword">let</span> bool3: <span class="keyword">typeof</span> bool1 = <span class="number">42</span>;     <span class="comment">// Error!</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> str1 = <span class="string">'hello'</span>;</span><br><span class="line"><span class="keyword">let</span> str2: <span class="keyword">typeof</span> str1 = <span class="string">'world'</span>; <span class="comment">// Works!</span></span><br><span class="line"><span class="keyword">let</span> str3: <span class="keyword">typeof</span> str1 = <span class="literal">false</span>;   <span class="comment">// Error!</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123;</span><br><span class="line">  method(val: number) &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">YourClass</span> </span>&#123;</span><br><span class="line">  method(val: number) &#123; <span class="comment">/* ... */</span> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> test1: <span class="keyword">typeof</span> MyClass = YourClass; <span class="comment">// Error!</span></span><br><span class="line"><span class="keyword">let</span> test1: <span class="keyword">typeof</span> MyClass = MyClass;   <span class="comment">// Works!</span></span><br></pre></td></tr></table></figure>
<h3 id="类型断言-Type-Casting-Expressions"><a href="#类型断言-Type-Casting-Expressions" class="headerlink" title="类型断言/Type Casting Expressions"></a>类型断言/Type Casting Expressions</h3><p>类型断言可使用 (value: Type) 语法，flow 尝试将 value 转换为 Type 类型，且不作类型校验。</p>
<p>flow 中只允许相关类型转换，由低级到高级，即 42 能转换到 number，不能转换到 string，number 类型不能转换为 42。通过 any 关键字可以将 42 从数值型转换到字符串型。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="keyword">let</span> value = <span class="number">42</span>;</span><br><span class="line"></span><br><span class="line">(value: number); <span class="comment">// Works!</span></span><br><span class="line">(value: string); <span class="comment">// Error!</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> newValue = ((value: any): string);</span><br><span class="line"></span><br><span class="line">(newValue: number); <span class="comment">// Error!</span></span><br><span class="line">(newValue: string); <span class="comment">// Works!</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cloneObject</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> clone = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Object</span>.keys(obj).forEach(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">    clone[key] = obj[key];</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> ((clone: any): <span class="keyword">typeof</span> obj); <span class="comment">// &lt;&lt;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> clone = cloneObject(&#123;</span><br><span class="line">  foo: <span class="number">1</span>,</span><br><span class="line">  bar: <span class="literal">true</span>,</span><br><span class="line">  baz: <span class="string">'three'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">(clone.foo: <span class="number">1</span>);       <span class="comment">// Works!</span></span><br><span class="line">(clone.bar: <span class="literal">true</span>);    <span class="comment">// Works!</span></span><br><span class="line">(clone.baz: <span class="string">'three'</span>); <span class="comment">// Works!</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">cloneObject</span>(<span class="params">obj</span>) </span>&#123;</span><br><span class="line">  (obj: &#123; [key: string]: mixed &#125;); <span class="comment">// &lt;&lt;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> clone = &#123;&#125;;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  <span class="keyword">return</span> ((clone: any): <span class="keyword">typeof</span> obj);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> clone = cloneObject(&#123;</span><br><span class="line">  foo: <span class="number">1</span>,</span><br><span class="line">  bar: <span class="literal">true</span>,</span><br><span class="line">  baz: <span class="string">'three'</span></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">(clone.foo: <span class="number">1</span>);       <span class="comment">// Works!</span></span><br><span class="line">(clone.bar: <span class="literal">true</span>);    <span class="comment">// Works!</span></span><br><span class="line">(clone.baz: <span class="string">'three'</span>); <span class="comment">// Works!</span></span><br></pre></td></tr></table></figure>
<h3 id="工具类型-Utility-Types"><a href="#工具类型-Utility-Types" class="headerlink" title="工具类型/Utility Types"></a>工具类型/Utility Types</h3><h4 id="Keys"><a href="#Keys" class="headerlink" title="$Keys"></a>$Keys<t></t></h4><p>$Keys<t> 以对象或类型的属性构建联合类型。</t></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="keyword">const</span> countries = &#123;</span><br><span class="line">  US: <span class="string">"United States"</span>,</span><br><span class="line">  IT: <span class="string">"Italy"</span>,</span><br><span class="line">  FR: <span class="string">"France"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">type Country = $Keys&lt;<span class="keyword">typeof</span> countries&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> italy: Country = <span class="string">'IT'</span>;</span><br><span class="line"><span class="keyword">const</span> nope: Country = <span class="string">'nope'</span>; <span class="comment">// 'nope' is not a Country</span></span><br></pre></td></tr></table></figure>
<h4 id="Values"><a href="#Values" class="headerlink" title="$Values"></a>$Values<t></t></h4><p>$Values<t> 以对象或类型的值构建联合类型。</t></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line">type Props = &#123;</span><br><span class="line">  name: string,</span><br><span class="line">  age: number,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// The following two types are equivalent:</span></span><br><span class="line">type PropValues = string | number;</span><br><span class="line">type Prop$Values = $Values&lt;Props&gt;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> name: Prop$Values = <span class="string">'Jon'</span>;  <span class="comment">// OK</span></span><br><span class="line"><span class="keyword">const</span> age: Prop$Values = <span class="number">42</span>;  <span class="comment">// OK</span></span><br><span class="line"><span class="keyword">const</span> fn: Prop$Values = <span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;;  <span class="comment">// Error!</span></span><br></pre></td></tr></table></figure>
<h4 id="ReadOnly"><a href="#ReadOnly" class="headerlink" title="$ReadOnly"></a>$ReadOnly<t></t></h4><p>$ReadOnly<t> 用于将对象或类型的属性转化为只读属性。</t></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// The following two types are equivalent:</span></span><br><span class="line">type ReadOnlyObj = &#123;</span><br><span class="line">  +key: any,  <span class="comment">// read-only field, marked by the `+` annotation</span></span><br><span class="line">&#125;;</span><br><span class="line">type ReadOnlyObj = $ReadOnly&lt;&#123;</span><br><span class="line">  key: any,</span><br><span class="line">&#125;&gt;;</span><br></pre></td></tr></table></figure>
<h4 id="Exact"><a href="#Exact" class="headerlink" title="$Exact"></a>$Exact<t></t></h4><p>$Exact&lt;{name: string}&gt; 语法和 {| name: string |} 等价，用于避免对象属性冲突。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line">type ExactUser = $Exact&lt;&#123;<span class="attr">name</span>: string&#125;&gt;;</span><br><span class="line">type ExactUserShorthand = &#123;| name: string |&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> user2 = &#123;<span class="attr">name</span>: <span class="string">'John Wilkes Booth'</span>&#125;;</span><br><span class="line"><span class="comment">// These will both be satisfied because they are equivalent</span></span><br><span class="line">(user2: ExactUser);</span><br><span class="line">(user2: ExactUserShorthand);</span><br></pre></td></tr></table></figure>
<h4 id="Diff-lt-A-B-gt"><a href="#Diff-lt-A-B-gt" class="headerlink" title="$Diff&lt;A, B&gt;"></a>$Diff&lt;A, B&gt;</h4><p>$Diff&lt;A, B&gt; 语法中，待校验数据须包含 A 仅有的属性，能包含 B 有的属性，且 B 中不能有 A 没有的属性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line">type Props = &#123; <span class="attr">name</span>: string, <span class="attr">age</span>: number &#125;;</span><br><span class="line">type DefaultProps = &#123; <span class="attr">age</span>: number &#125;;</span><br><span class="line">type RequiredProps = $Diff&lt;Props, DefaultProps&gt;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setProps</span>(<span class="params">props: RequiredProps</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setProps(&#123; <span class="attr">name</span>: <span class="string">'foo'</span> &#125;);</span><br><span class="line">setProps(&#123; <span class="attr">name</span>: <span class="string">'foo'</span>, <span class="attr">age</span>: <span class="number">42</span>, <span class="attr">baz</span>: <span class="literal">false</span> &#125;); <span class="comment">// you can pass extra props too</span></span><br><span class="line">setProps(&#123; <span class="attr">age</span>: <span class="number">42</span> &#125;); <span class="comment">// error, name is required</span></span><br></pre></td></tr></table></figure>
<h4 id="Rest-lt-A-B-gt"><a href="#Rest-lt-A-B-gt" class="headerlink" title="$Rest&lt;A, B&gt;"></a>$Rest&lt;A, B&gt;</h4><p>$Rest&lt;A, B&gt; 语法中，待校验数据只能包含 A 仅有的属性，不能包含 B 有的属性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line">type Props = &#123; <span class="attr">name</span>: string, <span class="attr">age</span>: number &#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> props: Props = &#123;<span class="attr">name</span>: <span class="string">'Jon'</span>, <span class="attr">age</span>: <span class="number">42</span>&#125;;</span><br><span class="line"><span class="keyword">const</span> &#123;age, ...otherProps&#125; = props;</span><br><span class="line">(otherProps: $Rest&lt;Props, &#123;|age: number|&#125;&gt;);</span><br><span class="line">otherProps.age;  <span class="comment">// Error</span></span><br></pre></td></tr></table></figure>
<h4 id="PropertyType-lt-T-k-gt"><a href="#PropertyType-lt-T-k-gt" class="headerlink" title="$PropertyType&lt;T, k&gt;"></a>$PropertyType&lt;T, k&gt;</h4><p>$PropertyType&lt;T, k&gt; 语法用于获取特定属性的类型。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Tooltip</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  props: &#123;</span><br><span class="line">    text: string,</span><br><span class="line">    onMouseOver: <span class="function">(<span class="params">&#123;x: number, y: number&#125;</span>) =&gt;</span> <span class="keyword">void</span></span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> someProps: $PropertyType&lt;Tooltip, <span class="string">'props'</span>&gt; = &#123;</span><br><span class="line">  text: <span class="string">'foo'</span>,</span><br><span class="line">  onMouseOver: <span class="function">(<span class="params">data: &#123;x: number, y: number&#125;</span>) =&gt;</span> <span class="literal">undefined</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> otherProps: $PropertyType&lt;Tooltip, <span class="string">'props'</span>&gt; = &#123;</span><br><span class="line">  text: <span class="string">'foo'</span></span><br><span class="line">  <span class="comment">// Missing the `onMouseOver` definition</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="ElementType-lt-T-k-gt"><a href="#ElementType-lt-T-k-gt" class="headerlink" title="$ElementType&lt;T, k&gt;"></a>$ElementType&lt;T, k&gt;</h4><p>$ElementType&lt;T, k&gt; 语法用于获取特定元素的类型，包含数组项、元祖项、对象属性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Using objects:</span></span><br><span class="line">type Obj = &#123;</span><br><span class="line">  name: string,</span><br><span class="line">  age: number,</span><br><span class="line">&#125;</span><br><span class="line">(<span class="string">'Jon'</span>: $ElementType&lt;Obj, <span class="string">'name'</span>&gt;);</span><br><span class="line">(<span class="number">42</span>: $ElementType&lt;Obj, <span class="string">'age'</span>&gt;);</span><br><span class="line">(<span class="literal">true</span>: $ElementType&lt;Obj, <span class="string">'name'</span>&gt;); <span class="comment">// Nope, `name` is not a boolean</span></span><br><span class="line">(<span class="literal">true</span>: $ElementType&lt;Obj, <span class="string">'other'</span>&gt;); <span class="comment">// Nope, property `other` is not in Obj</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Using tuples:</span></span><br><span class="line">type Tuple = [boolean, string];</span><br><span class="line">(<span class="literal">true</span>: $ElementType&lt;Tuple, <span class="number">0</span>&gt;);</span><br><span class="line">(<span class="string">'foo'</span>: $ElementType&lt;Tuple, <span class="number">1</span>&gt;);</span><br><span class="line">(<span class="string">'bar'</span>: $ElementType&lt;Tuple, <span class="number">2</span>&gt;); <span class="comment">// Nope, can't access position 2</span></span><br></pre></td></tr></table></figure>
<h4 id="ObjMap-lt-T-F-gt"><a href="#ObjMap-lt-T-F-gt" class="headerlink" title="$ObjMap&lt;T, F&gt;"></a>$ObjMap&lt;T, F&gt;</h4><p>$ObjMap&lt;T, F&gt; 遍历 T 对象或类型，以函数 F 重新构建属性类型。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// let's write a function type that takes a `() =&gt; V` and returns a `V` (its return type)</span></span><br><span class="line">type ExtractReturnType = &lt;V&gt;(() =&gt; V) =&gt; V</span><br><span class="line"></span><br><span class="line">function run&lt;A, O: &#123;[key: string]: () =&gt; A&#125;&gt;(o: O): $ObjMap&lt;O, ExtractReturnType&gt; &#123;</span><br><span class="line">  return Object.keys(o).reduce((acc, k) =&gt; Object.assign(acc, &#123; [k]: o[k]() &#125;), &#123;&#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const o = &#123;</span><br><span class="line">  a: () =&gt; true,</span><br><span class="line">  b: () =&gt; 'foo'</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">(run(o).a: boolean); // Ok</span><br><span class="line">(run(o).b: string);  // Ok</span><br><span class="line">// $ExpectError</span><br><span class="line">(run(o).b: boolean); // Nope, b is a string</span><br><span class="line">// $ExpectError</span><br><span class="line">run(o).c;</span><br></pre></td></tr></table></figure>
<h4 id="TupleMap-lt-T-F-gt"><a href="#TupleMap-lt-T-F-gt" class="headerlink" title="$TupleMap&lt;T, F&gt;"></a>$TupleMap&lt;T, F&gt;</h4><p>$TupleMap&lt;T, F&gt; 遍历 T 元祖或类型，以函数 F 重新构建元祖项。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line">type ExtractReturnType = &lt;V&gt;(() =&gt; V) =&gt; V</span><br><span class="line"></span><br><span class="line">function run&lt;A, I: Array&lt;() =&gt; A&gt;&gt;(iter: I): $TupleMap&lt;I, ExtractReturnType&gt; &#123;</span><br><span class="line">  return iter.map(fn =&gt; fn());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const arr = [() =&gt; 'foo', () =&gt; 'bar'];</span><br><span class="line">(run(arr)[0]: string); // OK</span><br><span class="line">(run(arr)[1]: string); // OK</span><br><span class="line">(run(arr)[1]: boolean); // Error</span><br></pre></td></tr></table></figure>
<h4 id="Call"><a href="#Call" class="headerlink" title="$Call"></a>$Call<f></f></h4><p>$Call<f> 调用 F 函数，函数返回值用于校验类型，参数在 F 后添加。</f></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="comment">// Takes an object type, returns the type of its `prop` key</span></span><br><span class="line">type ExtractPropType = &lt;T&gt;(&#123;prop: T&#125;) =&gt; T;</span><br><span class="line">type Obj = &#123;prop: number&#125;;</span><br><span class="line">type PropType = $Call&lt;ExtractPropType, Obj&gt;;  // Call `ExtractPropType` with `Obj` as an argument</span><br><span class="line">type Nope = $Call&lt;ExtractPropType, &#123;nope: number&#125;&gt;;  // Error: argument doesn't match `Obj`.</span><br><span class="line"></span><br><span class="line">(5: PropType); // OK</span><br><span class="line">(true: PropType);  // Error: PropType is a number</span><br><span class="line">(5: Nope);  // Error</span><br></pre></td></tr></table></figure>
<h4 id="Class"><a href="#Class" class="headerlink" title="Class"></a>Class<t></t></h4><p>Class<t> 指用类 T 校验类型。</t></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Store</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ExtendedStore</span> <span class="keyword">extends</span> <span class="title">Store</span> </span>&#123;&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Model</span> </span>&#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeStore</span>(<span class="params">storeClass: Class&lt;Store&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> storeClass();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">(makeStore(Store): Store);</span><br><span class="line">(makeStore(ExtendedStore): Store);</span><br><span class="line">(makeStore(Model): Model); <span class="comment">// error</span></span><br><span class="line">(makeStore(ExtendedStore): Model); <span class="comment">// Flow infers the return type</span></span><br></pre></td></tr></table></figure>
<h4 id><a href="#" class="headerlink" title="*"></a>*</h4><ul>
<li>用于以占位符形式指明存在类型/Existential Type。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeParamStore</span>&lt;<span class="title">T</span>&gt;(<span class="params">storeClass: Class&lt;ParamStore&lt;T&gt;&gt;, data: T</span>): * </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> storeClass(data);</span><br><span class="line">&#125;</span><br><span class="line">(makeParamStore(ParamStore, <span class="number">1</span>): ParamStore&lt;number&gt;);</span><br><span class="line">(makeParamStore(ParamStore, <span class="number">1</span>): ParamStore&lt;boolean&gt;); <span class="comment">// failed because of the second parameter</span></span><br></pre></td></tr></table></figure>
<h3 id="模块-Module-Types"><a href="#模块-Module-Types" class="headerlink" title="模块/Module Types"></a>模块/Module Types</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Foo</span> </span>&#123;&#125;;</span><br><span class="line"><span class="keyword">export</span> type MyObject = &#123; <span class="comment">/* ... */</span> &#125;;</span><br><span class="line"><span class="keyword">export</span> interface MyInterface &#123; <span class="comment">/* ... */</span> &#125;;</span><br><span class="line"><span class="keyword">export</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClass</span> </span>&#123; <span class="comment">/* ... */</span> &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// @flow</span></span><br><span class="line"><span class="keyword">import</span> type Foo, &#123;MyObject, MyInterface&#125; <span class="keyword">from</span> <span class="string">'./exports'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="keyword">typeof</span> &#123;MyClass&#125; <span class="keyword">from</span> <span class="string">'./exports'</span>;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/21/读书笔记/Pro Git读书笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/21/读书笔记/Pro Git读书笔记/" itemprop="url">Pro Git 笔记</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-21T00:00:00+08:00">2018-02-21</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/读书笔记/" itemprop="url" rel="index"><span itemprop="name">读书笔记</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/21/读书笔记/Pro Git读书笔记/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/02/21/读书笔记/Pro Git读书笔记/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Getting-Started"><a href="#Getting-Started" class="headerlink" title="Getting Started"></a>Getting Started</h2><h3 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h3><p>git 版本管理通过 SHA-1 哈希算法为工作区的文件生成快照实现，存放于本地暂存区或版本库中（.git 目录下保存所有快照信息）。hash 算法基于文件内容和目录结构，git 保存的信息都通过 hash 值(SHA-1 哈希算法校验和/SHA-1 checksum)进行索引。修改工作区/working tree 的文件后(modified)，通过 git add 命令提交到暂存区/staging range(staged)，再通过 git commit 命令提交到版本库/git directory(commited)；若文件未变更，将沿用原有的快照。因此本地多版本管理不需要远程交互。</p>
<p>当文件提交到暂存区时(stage)，git 会为每个文件计算校验和/checksum，在 git 仓库中保存 blob 对象以引用文件快照，校验和将保存到暂存区中。当提交到版本库时(commit)，git 会计算目录的校验和并构建树对象(blod 文件对象将以索引形式存储在树对象中)，随后创建提交对象，该提交对象包含作者名、电邮、message、指向上述树对象的指针、指向之前提交版本的指针。git 仓库可理解为存储系列提交对象的单链表结构(以哈希算法的校验和值作为索引)。在多分支开发的特殊情况下，提交对象会转变为树形结构(单链表可视为只有主干的树)，即多个提交对象的 parent 指针可以指向同一个提交对象父节点，提交历史产生分叉。在提交对象模型的基础上，git 分支就是指向某个提交对象的移动指针(通过校验和指向提交对象，文件形式存储)，其提交历史来自于提交对象模型，形成单链表结构。多分支管理、及单分支的回滚和提交动作均衍生于树结构的提交对象模型，分支仅承担着指向改变的任务；创建新分支即是创建一个指向当前提交对象的指针；提交时，创建新的提交对象，并改变当前分支的指向。在 git 中，HEAD 指针用于指向当前工作的分支，通过改变 HEAD 指针的指向即为切换分支操作。需要说明的是，当切换回较旧的分支时，不只改变了 HEAD 指针的指向，同时也使工作目录变更为该分支指向的提交对象，即资源快照。多分支开发时，新的提交对象将作为提交对象模型的叶子节点，这一过程也可以通过 HEAD 指针感知当前的提交对象属于哪个分支。因此在 git 中，分支不是多次提交记录的集合，而是在抽象所有提交记录为单一的模型后、衍伸而来的理念。遵照这样的设计，master 分支和其他分支拥有相同的特征，只是 master 分支会在 git 仓库初始化时被创建。</p>
<p>在 git 中，HEAD 指针指向版本库，INDEX 指针指向暂存区，版本库和暂存区都存储在 .git 文件夹中。因此，git add 命令将工作区内容复制到暂存区/INDEX。git commit 将暂存区内容复制到版本库/HEAD。git status 比较工作区、暂存区、版本库内容是否相同，若工作区和暂存区内容不相同，提示 not staged，需要通过 git add 暂存；若暂存区和版本库内容不同，提示 not committed，需要通过 git commit 提交。执行 git checkout, git clone 命令时，先将 HEAD 指针指向切换的分支，再将版本库内容复制到暂存区，再将暂存区内容复制到工作区。</p>
<p>git 提供了 git reset <checksum> 命令，执行该命令，不仅改变 HEAD 指针的指向，同时将工作分支指向 checksum 提交对象上。如果 HEAD 指向 master 分支，运行 git reset 9e5e64a 将会使 master 指向 9e5e64a，将撤销 9e5e64a 之后的提交，也可以用于重置 9e5e64a 之后的提交；git reset 命令默认将暂存区内容也替换为 9e5e64a 指向的提交对象，这和显式执行 git reset –mixed 命令相同。git reset –soft 命令只将版本库中内容替换为指定的提交对象。git reset –hard 命令可同时将版本库、暂存区和工作区内容替换为指定的提交对象。使用 git reset <filepath> 或 git reset <checksum> <filepath> 命令将目标从提交对象转向 filepath 路径指定的文件或目录，操作是从指定的提交对象中获取内容，复制到暂存区。</filepath></checksum></filepath></checksum></p>
<p>在 git checkout 命令执行过程中，会比较工作区和暂存区的差别，并尝试合并，这是 git reset 命令所没有的操作。当执行 git checkout <filepath> 命令时，该命令不仅会影响暂存区，同时会尝试合并工作区，这也是 git reset 命令所没有的操作。</filepath></p>
<p>合并/merge 分支时，会向上遍历文档对象模型，寻找共同的祖先节点作为合并基础。若待合并分支的提交/commit 动作在当前工作分支(work-in-progress branch)之后产生，当前分支将采用快进/fast-forward 方式修改，即将当前分支指向待合并分支的提交对象，指针右移。合并分叉分支时，即待合并的两个分支为同时开发，将获取这两个分支的提交对象，以及他们共同祖先节点的提交对象作为合并基础，作三方合并(three-way merge)，最终将构建出新的提交对象(该提交对象有两个父节点，使文档对象模型由树结构转变为合流结构)。若两个分叉分支同时对同一块区域做更改，git 不会自动合并，将产生一个合并冲突(merge conflict)，并阻止 git 的后续执行流程，如构建新的提交对象等，git 还会为冲突文件注入标准的冲突解决标记(standard conflict-resolution markers)。通过 git status 命令可查看冲突文件。冲突解决标记中，以 &lt;&lt;&lt;&lt;&lt;&lt;&lt; HEAD 起始部分为当前工作分支内容，以 &gt;&gt;&gt;&gt;&gt;&gt;&gt; branchname 结束部分为待合并分支内容，中间以 =======。解决冲突后，需要依序提交到暂存区和版本库中，将产生一条合并记录，可能包含冲突解决记录。合并分支可使用 git mergetool 命令，启用图形化合并工具，参看 Git Branching。</p>
<p>git merge 合并发生冲突时，暂存区/stages 下缓存着共同祖先版本/stage-0，当前工作版本/stage-1，待合并的版本/stage-2。通过 git show :1|2|3:<conflictfilename> &gt; fileName 可以以拷贝形式导出冲突的共同祖先文件等。其中，:1|2|3:<conflictfilename> 为各冲突文件 bolb 对象相关 SHA-1 值的简写形式，:1:<conflictfilename> 为祖先冲突文件，:2:<conflictfilename> 为工作分支文件，:3:<conflictfilename> 为待合并文件。导出三份拷贝文件后，手工修复冲突，可使用 git merge-file 命令合并冲突文件，使用 git diff 命令可比较冲突结果与待比较文件的差异，git clean 命令用于清理为合并拷贝出来的文件。</conflictfilename></conflictfilename></conflictfilename></conflictfilename></conflictfilename></p>
<p>另外，在合并发生冲突时，使用 git checkout –conflict=diff3 命令可以查看不止于当前工作分支的冲突文件和待合并的冲突文件，还包含共同祖先的冲突文件。默认只查看当前工作分支的冲突文件和待合并的冲突文件，即 git checkout –conflict=merge 命令。使用 git config –global merge.conflictstyle diff3 命令，将全局的合并方案改成 diff3。git checkout –ours 合并时使用当前工作分支文件内容；git checkout –theirs 合并时使用待合并分支文件内容。git 在合并过程中，会将合并成功的文件提交到暂存区，因此 git diff 命令可以查看冲突文件；解决冲突后，仍可使用 git diff 或 git log –cc -p -1 命令查看解决冲突后的文件。</p>
<p>若想撤销文件合并，可使用 git reset –hard HEAD~ 命令将合并取消，提交记录返回到合并前；或者使用 git revert -m 1 basebranch 命令撤销合并，将提交对象撤回到 basebranch 分支内容。需要注意的是，git revert -m 1 basebranch 命令将无法合并待合并分支起始的提交内容，针对这一问题，可使用 git revert <checksum> 撤销还原。<br>参看 Git Tools。</checksum></p>
<p>远程引用(remote references)是对远程仓库中分支、标签等的引用或指针。更恰当的说，引用内容即为远程分支中的提交对象模型，单链表形式。远程跟踪分支(remote-tracking branches)将远程分支的引用保存在本地，不受用户影响，git fetch|pull|push 操作时更新引用，使本地 shortname/branchname 指向远程服务器的同名分支。远程引用采用 shortname/branchname 形式命名分支。当 git clone 命令执行时，将在本地创建 origin/master 分支和 master 分支，两者均指向相同的提交对象模型。当用户在 master 分支开发并提交时，另一用户将自己的代码 push 到远程 master 分支上，本地 origin/master 的指向将不作改变；假使在这时候执行 git fetch 命令，将抓取远程仓库新添加的提交对象，本地 origin/master 也将右移、指向另一用户创建的提交对象上，提交对象模型转化为树形结构。</p>
<p>变基/rebase 是 git 中除了 merge 以外整合两个分支的另一种方式。当提交历史呈分叉状态，可以将其中一个分叉的提交记录基于合并基础、提取为更新补丁，再将其合并到另一个分叉中，这个过程就是变基。变基命令在提取为补丁的分支上执行行，因此需要切换到该分支如 patch 分支，然后执行 git rebase basebaranch 命令，提取补丁并以该补丁产生新的提交对象(patch 分支指向该提交对象)，此时分叉的提交历史将转变为单链表形式，而 basebaranch 分支的指向仍保持不变。切换到 basebaranch 分支，再执行 git merge patch 命令，可以将 basebaranch 分支的指针右移，指向 rebase 命令新创建的提交对象。经过上述步骤后，整个开叉分支的整合操作也就完成了，patch 分支的提交对象将被抹去，但 patch 分支仍然存在，需要手动删除。变基同合并比较，最大的优点即是使提交历史呈线性状态，而不是分叉、合流结构。在开源项目中贡献代码通常采用变基命令。使用 git rebase basebranch patch 命令执行变基操作时，可以不用将工作分支切换到 patch 上，即提取 patch 分支的修改补丁，基于修改补丁在 basebranch 分支上创建新的提交对象。执行 git rebase –onto basebranch patch1 patch2 命令，获取 patch2 分支不同于 patch1 分支的修改补丁，基于修改补丁再在 basebranch 分支上创建新的提交对象。</p>
<p>执行变基操作有一条原则，即不能在你的本地仓库执行变基操作。变基操作能改变本地仓库的提交历史，进而影响远程仓库的提交记录，但是对于协作者而言，在分支开叉时拉取编程变更，又在变基后拉取远程变更，他本地远程引用的提交记录中即会保留变基前的开叉，又会有变基后新增的提交对象。git 变基的实现原理是，在每次提交时，git 不只计算本次提交的校验和，还会计算本次修改内容的校验和 patch-id。通过 patch-id，git 能分辨出新增的本地修改。在本地分支上，使用 git rebase remote/branch 命令将本地修改变基到远程引用，同时本地的提交历史将转变为单链表结构，这能解决前述变基前后的操作同时提交到远程仓库的问题。</p>
<p>除了合并和变基以外，git 支持拣选/cherry-pick 操作，其意义以校验和获取某次提交补丁，再应用到当前工作分支上。因为操作时间的不同，通过拣选在当前分支创建的提交会重新计算校验和。具体命令如 git cherry-pick e43a6fd3e94888d76779ad79fb568ed180e5fcdf。其中，e43a6fd3e94888d76779ad79fb568ed180e5fcdf 为之前提交对象的校验和/checksum，作为提交对象的索引。</p>
<p>参考：<br><a href="https://git-scm.com/book/zh/v2/Git-分支-分支简介" target="_blank" rel="noopener">分支简介</a><br><a href="https://git-scm.com/book/zh/v2/Git-分支-分支的新建与合并" target="_blank" rel="noopener">分支的新建与合并</a><br><a href="https://git-scm.com/book/zh/v2/Git-分支-变基" target="_blank" rel="noopener">变基</a><br><a href="https://git-scm.com/book/zh/v2/Git-工具-重置揭密" target="_blank" rel="noopener">重置揭密</a></p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><p>git 配置分为三类，系统级，用户级，和项目级；优先级从右到左。git config 命令中，–system 选项指定系统级，–global 选项指定用户级，两者均没有为项目级。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">git config --list <span class="comment"># 查看配置</span></span><br><span class="line">git config user.name <span class="comment"># 查看用户配置</span></span><br><span class="line">git config --global user.name &lt;name&gt; <span class="comment"># 指定用户</span></span><br><span class="line">git config --global user.email &lt;email&gt; <span class="comment"># 指定邮箱</span></span><br><span class="line">git config --global core.editor emacs <span class="comment"># 指定编辑器，默认为系统自带编辑器，可选 vim, emacs, notepad++</span></span><br><span class="line">git config --global commit.template &lt;filepath&gt; <span class="comment"># 以 filepath 文件作为提交信息模板，打开编辑器时作为前缀</span></span><br><span class="line">git config --global core.pager <span class="string">''</span> <span class="comment"># 设置 git log|diff 命令的分页器，可选值 more, less。'' 空字符串为完整显示</span></span><br><span class="line">git config --global user.signingkey &lt;gpg-key-id&gt; <span class="comment"># 设置 GPG 签署密钥，影响 git tag -s &lt;tag-name&gt; 命令</span></span><br><span class="line">git config --global core.excludesfile &lt;filepath&gt; <span class="comment"># 设置忽略的文件</span></span><br><span class="line">git config --global help.autocorrect 1 <span class="comment"># 输入命令有误时，0.1s 后自动执行模糊匹配的命令</span></span><br><span class="line">git config --global credential.helper cache <span class="comment"># 将 https 推送需要的用户密码缓存在内存中，时效为几分钟</span></span><br><span class="line">git config --global color.ui <span class="literal">false</span> <span class="comment"># 禁用有彩色输出</span></span><br><span class="line">git config --global color.[diff|branch|interactive|status].meta <span class="string">"blue black bold"</span> <span class="comment"># 设置命令的颜色</span></span><br><span class="line">git config --global core.autocrlf <span class="literal">true</span> <span class="comment"># Windows 使用回车（CR）和换行（LF）两个字符来结束一行，而 Mac 和 Linux 只使用换行（LF）一个字符。core.autocrlf 设置为 true，提交时自动将回车和换行转换成换行，检出时将换行转换成回车和换行。core.autocrlf 设置为 input，提交时自动把回车和换行转换成换行，检出时不转换</span></span><br><span class="line">git config --global core.whitespace \</span><br><span class="line">  trailing-space,space-before-tab,indent-with-non-tab <span class="comment"># 空格检测。默认开启项 blank-at-eol，查找行尾的空格；blank-at-eof，盯住文件底部的空行；space-before-tab，警惕行头 tab 前面的空格。默认关闭项 indent-with-non-tab，揪出以空格而非 tab 开头的行（你可以用 tabwidth 选项控制它）；tab-in-indent，监视在行头表示缩进的 tab；cr-at-eol，告诉 Git 忽略行尾的回车。git diff 时将应用空格检测；git apply --whitespace=warn &lt;patch&gt; 应用补丁时检测空格；git apply --whitespace=fix &lt;patch&gt; 自动修复；git rebase --whitespace=fix 变基时自动修复</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 别名</span></span><br><span class="line">git config --global alias.co checkout <span class="comment"># git co 将等价于 git checkout</span></span><br><span class="line">git config --global alias.br branch</span><br><span class="line">git config --global alias.ci commit</span><br><span class="line">git config --global alias.st status</span><br><span class="line">git config --global alias.unstage <span class="string">'reset HEAD --'</span> <span class="comment"># git unstage 将等价于 git reset Head -- </span></span><br><span class="line">git config --global alias.last <span class="string">'log -1 HEAD'</span> <span class="comment"># git last 查看最后一次提交信息</span></span><br><span class="line">git config --global alias.visual <span class="string">'!npm'</span> <span class="comment"># git visual 将调用外部命令 npm</span></span><br><span class="line"></span><br><span class="line">git config --global pull.rebase <span class="literal">true</span> <span class="comment"># 更改 pull.rebase 的默认配置</span></span><br><span class="line">git config --global merge.conflictstyle diff3 <span class="comment"># 以 diff3 方式查看冲突文件，包含当前工作分支、待合并分支、共同祖先分支的冲突文件内容</span></span><br><span class="line"></span><br><span class="line">git config --system receive.fsckObjects <span class="literal">true</span> <span class="comment"># 推送生效前检验每个对象的有效性以及 SHA-1 检验和是否保持一致</span></span><br><span class="line">git config --system receive.denyNonFastForwards <span class="literal">true</span> <span class="comment"># 禁用强制更新 git push -f</span></span><br><span class="line">git config --system receive.denyDeletes <span class="literal">true</span> <span class="comment"># 避免删除远程分支后，再推送本地分支</span></span><br></pre></td></tr></table></figure>
<h3 id="帮助"><a href="#帮助" class="headerlink" title="帮助"></a>帮助</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">help</span> config <span class="comment"># 打印 git config 命令的完整手册</span></span><br><span class="line">man git-confgi <span class="comment"># 同上</span></span><br><span class="line">git-config -h|--<span class="built_in">help</span> <span class="comment"># 简要帮助信息</span></span><br></pre></td></tr></table></figure>
<h3 id="疑问"><a href="#疑问" class="headerlink" title="疑问"></a>疑问</h3><ol>
<li>保存快照不吃磁盘空间吗？git 命令在运行时比较文件差异，如 add, commit？那执行效率如何提升？</li>
<li>数据库怎样存储历史版本数据？</li>
<li>游戏在用户端以补丁形式下载并更新，若代码使用 git 管理，怎样做到根据文件差异只做局部封信，而不是全量下载并更新？同样的，git pull 等命令怎样做到效率地只修改局部资源？</li>
<li>在多分支开发，又相继合并到 master 分支的情形下，提交对象链表会形成怎样的构造？根据提交时间形成单链表形式？</li>
<li>git reset 命令执行后，如何改变提交历史，新的提交对之前提交历史的影响？如重置第三次提交，新的提交会在第一次提交之后创建提交对象，还是在之前创建提交对象？</li>
<li>git checkout 命令可以针对某次提交对象，即可以执行 git checkout <checksum> 命令？</checksum></li>
</ol>
<h2 id="Git-Basics"><a href="#Git-Basics" class="headerlink" title="Git Basics"></a>Git Basics</h2><h3 id="创建本地仓库"><a href="#创建本地仓库" class="headerlink" title="创建本地仓库"></a>创建本地仓库</h3><p>创建 git 本地仓库，指定 git init 或 git clone <url> [projectName] 命令（projectName 用于指定本地目录名）。git clone 将拷贝远程仓库的所有版本及所有文件（当服务器磁盘损坏时，方便使用本地仓库的命令将远程仓库的资源回滚到拷贝前），创建 .git 目录，并检出最新分支。git clone 时，可使用 https 协议 或 git:// 起始的 SSH 协议。</url></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git init <span class="comment"># 创建 git 本地仓库</span></span><br><span class="line">git <span class="built_in">clone</span> &lt;url&gt; [projectName] <span class="comment"># 克隆远程仓库，指定远程仓库的简称默认为 origin，且本地 master 分支将跟踪/track 远程 master，可使用 git pull|push 命令</span></span><br></pre></td></tr></table></figure>
<h3 id="文件状态"><a href="#文件状态" class="headerlink" title="文件状态"></a>文件状态</h3><p>工作区的文件状态有两种，已追踪/tracked, 未追踪/untracked。暂存区的最新快照中包含某文件，该文件即被追踪；若不包含，该文件即未追踪。已追踪文件又分为三种状态，未变更/unmodified, 已变更/modified, 已提交到暂存区/staged。在切换分支时，git 会校验工作区的文件改动是否提交到版本库中，未提交，则阻止切换，用以防止丢失工作区的改动。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">git status <span class="comment"># 获取文件状态</span></span><br><span class="line">git status -s|--short <span class="comment"># 文件状态扼要信息。?? 未追踪文件，A 新增文件提交到到暂存区，M 修改文件提交到暂存区，MM 暂存区和工作区文件状态</span></span><br><span class="line">git diff <span class="comment"># 工作区和暂存区文件差异，显示文件更新细节，包括添加的行、删除的行，合称为文件更新补丁/patch</span></span><br><span class="line">git diff --staged|--cached <span class="comment"># 暂存区和版本库文件差异</span></span><br><span class="line">git difftool <span class="comment"># 使用 Araxis, emerge, vimdiff 等软件以图形化或其他格式显示文件差异</span></span><br><span class="line">git difftool -tool-help <span class="comment"># 查看系统支持的 git diff 插件</span></span><br><span class="line">git add &lt;files&gt; <span class="comment"># 工作区文件提交到暂存区，将产生暂存区的历史快照/historical snapshort。参数为文件或目录路径</span></span><br><span class="line">git commit <span class="comment"># 暂存区快照提交版本去，需由命令行编辑器设置 message，# 起始内容将被忽略。命令行编辑器中默认以 # 添加 git status 输出内容。-v 选项可用于注入 git diff 完整信息</span></span><br><span class="line">git commit -m <span class="string">'message'</span> <span class="comment"># 设置 message 并提交</span></span><br><span class="line">git commit -a <span class="comment"># 直接将工作区中已追踪的文件提交到版本库，跳过暂存区</span></span><br><span class="line">git rm &lt;pattern&gt; <span class="comment"># 暂存区删除文件，工作区也作相应删除，需要提交到版本库。直接删除工作区中文件，不会影响暂存区</span></span><br><span class="line">git rm -f|--force &lt;pattern&gt; <span class="comment"># 修改后文件提交到暂存区，与版本库中文件有差异，需使用 -f 选项强制删除</span></span><br><span class="line">git rm --cached &lt;pattern&gt; <span class="comment"># 暂存区删除文件，但保留工作区文件，适用于未配置 .gitignore 的文件</span></span><br><span class="line">git mv file_from file_to <span class="comment"># 移动文件，可实现文件重命名。重命名时，等同于 mv file_from file_to; git rm file_from; git add file_to。git 没有显式追踪文件移动操作，通过执行的命令获知用户重命名行为</span></span><br></pre></td></tr></table></figure>
<h3 id="gitignore"><a href="#gitignore" class="headerlink" title=".gitignore"></a>.gitignore</h3><p>.gitignore 配置文件，即忽略文件列表。可设置多个 .gitignore 文件，当前文件所在目录自底向上获取 .gitignore 文件，作为优先级顺序。编写 .gitignore 文件可使用标准 glob 模式(shell 中简易正则，* 零或多个任意字符，** 任意中间目录，其余同正则)；空行或 ‘#’ 开头将被忽略；’/‘ 开头相对于工程目录；’/‘ 结尾匹配目录；’!’ 开头置否值。</p>
<h3 id="commit-历史记录"><a href="#commit-历史记录" class="headerlink" title="commit 历史记录"></a>commit 历史记录</h3><p>无论本地仓库，还是克隆下来的远程仓库，都可以使用 git log 命令查看提交记录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> <span class="comment"># 显示提交记录，反序排列，包含 SHA-1 哈希算法校验和(作为索引), 作者, 日期, message</span></span><br><span class="line">git <span class="built_in">log</span> -p|--patch <span class="comment"># 显示内容差异</span></span><br><span class="line">git <span class="built_in">log</span> --<span class="built_in">stat</span> <span class="comment"># 显示每次更新的文件修改统计信息</span></span><br><span class="line">git <span class="built_in">log</span> --shortstat <span class="comment"># 只显示 --stat 中最后的行数修改添加移除统计</span></span><br><span class="line">git <span class="built_in">log</span> --name-only <span class="comment"># 仅在提交信息后显示已修改的文件清单</span></span><br><span class="line">git <span class="built_in">log</span> --name-status <span class="comment"># 显示新增、修改、删除的文件清单</span></span><br><span class="line">git <span class="built_in">log</span> --abbrev-commit <span class="comment"># 仅显示 SHA-1 的前几个字符，而非所有的 40 个字符</span></span><br><span class="line">git <span class="built_in">log</span> --relative-date <span class="comment"># 使用较短的相对时间显示，如 '2 weeks ago'</span></span><br><span class="line">git <span class="built_in">log</span> --graph <span class="comment"># 显示 ASCII 图形表示的分支合并历史</span></span><br><span class="line">git <span class="built_in">log</span> --pretty=oneline <span class="comment"># 指定显示格式，--pretty 选项的可选值为 oneline, short, full, fuller, format。其中，oneline 以一行展示提交信息</span></span><br><span class="line">git <span class="built_in">log</span> --pretty=format:<span class="string">"%h - %an, %ar : %s"</span> <span class="comment"># 指定输出信息的模板字符串，用于提取分析报告。占位符包含 %H 提交对象/commit的完整哈希字串, %h 提交对象的简短哈希字串, %T 树对象/tree的完整哈希字串, %t, %P 父对象/parent的完整哈希字串, %p, %an 作者, %ae 作者的邮箱, %ad 作者修订日期, %ar 作者的相对修订日期, %cn 提交者, %ce, %cd, %cr, %s 说明</span></span><br><span class="line">git <span class="built_in">log</span> --oneline <span class="comment"># --pretty=oneline --abbrev-commit 简写形式</span></span><br><span class="line">git <span class="built_in">log</span> -&lt;n&gt; <span class="comment"># -n 指定只显示最后两次提交记录，如 -2。通常不需要使用。因为 git log 显示采用分页形式，用户只能看到第一页</span></span><br><span class="line">git <span class="built_in">log</span> --since|--after=2.weeks <span class="comment"># --since 选项指定起始时间，可用相对时间或绝对时间，如 '2 years 1 day 3 minutes ago'</span></span><br><span class="line">git <span class="built_in">log</span> --until|--before=<span class="string">"2008-01-15"</span> <span class="comment"># 同上，指定结束时间</span></span><br><span class="line">git <span class="built_in">log</span> --author=authorname <span class="comment"># 过滤作者</span></span><br><span class="line">git <span class="built_in">log</span> --committer=committername <span class="comment"># 过滤提交者</span></span><br><span class="line">git <span class="built_in">log</span> --grep=messagekey <span class="comment"># 按 message 中关键字检索，与 --author 合用时为或匹配，添加 --all-match 选项强制匹配 grep 指定关键字</span></span><br><span class="line">git <span class="built_in">log</span> -S function_name <span class="comment"># 指定字符串检索更改相应字符串的提交记录</span></span><br><span class="line">git <span class="built_in">log</span> --no-merges <span class="comment"># 不显示 merge 记录</span></span><br><span class="line">git <span class="built_in">log</span> --filename <span class="comment"># 作为最后一个选项，检索更改相应文件或目录的提交记录</span></span><br></pre></td></tr></table></figure>
<h3 id="撤销"><a href="#撤销" class="headerlink" title="撤销"></a>撤销</h3><p>撤销操作不能回滚，容易引起数据丢失。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git commit --amend <span class="comment"># 合并上一次提交记录，适用于文件漏提交等轻微改动场景。若暂存区文件未作更新，commit 快照将保持不变，只更改 message 或者连 message 也未作更改。只保留当前的提交记录；撤销上一次提交记录，即不会存在于提交记录中</span></span><br><span class="line">git reset HEAD &lt;filename&gt; <span class="comment"># 暂存区文件重置为提交前状态。执行 git status 命令，工作位已更改文件的状态为 unstaged。git reset 命令不加选项，只更改暂存区。git reset --hard 命令将可能导致工作区的当前进度全部丢失，相当危险</span></span><br><span class="line">git checkout -- &lt;file&gt; <span class="comment">#  使用暂存区的文件替换工作区的文件，即工作区文件回滚</span></span><br></pre></td></tr></table></figure>
<h3 id="远程协作"><a href="#远程协作" class="headerlink" title="远程协作"></a>远程协作</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">git remote <span class="comment"># 列出远程服务器的简称，默认为 origin</span></span><br><span class="line">git remote -v <span class="comment"># 列出远程服务器的简称和 url 列表，同一个项目可能指定了多个远程仓库。fetch, push 操作的服务器资源也可能不同，由远程仓库决定</span></span><br><span class="line">remote add &lt;shortname&gt; &lt;url&gt; <span class="comment"># 添加远程仓库</span></span><br><span class="line">git fetch &lt;shortname|url&gt; <span class="comment"># 抓取远程仓库资源，包含所有分支，并创建本地远程跟踪分支，却不会创建可修改、供开发的本地同名分支。只下载远程仓库资源，需手动 merge</span></span><br><span class="line">git pull <span class="comment"># 若本地分支跟踪远程分支，git pull 命令自动拉取远程仓库中指定的分支，并尝试 merge</span></span><br><span class="line">git pull &lt;remotename&gt; &lt;branchname&gt; <span class="comment"># 拉取远程分支资源，并尝试 merge。选项 remotename 指定远程仓库，branchname 指定分支</span></span><br><span class="line">git push <span class="comment"># 若本地分支跟踪远程分支，git push 将资源推送到远程仓库下的指定分支</span></span><br><span class="line">git push &lt;remotename&gt; &lt;branchname&gt; <span class="comment"># 推送资源到指定远程下的指定分支</span></span><br><span class="line">git remote show &lt;remotename&gt; <span class="comment"># 查看远程仓库 fetch|push 操作的 url，包含的分支，以及跟踪分支信息</span></span><br><span class="line">git remote rename shortname_before shortname_after <span class="comment"># 改写远程仓库的简称，同时改变分支名，如更新为 shortname_after/master</span></span><br><span class="line">git remote remove|rm &lt;remotename&gt; <span class="comment"># 本地移除某远程仓库，同时影响其下分支和配置，对远程仓库无影响</span></span><br></pre></td></tr></table></figure>
<h3 id="打标签"><a href="#打标签" class="headerlink" title="打标签"></a>打标签</h3><p>git 标签分为两种，轻量标签lightweight, 附注标签 annotated。轻量标签通过 git tag 不带选项创建，附注标签通过 git tag -a 创建。附注标签以对象形式存储在 git 数据库中，包含标签作者，电邮，日期，标签信息/message，并且可以使用 GPG 签名和验证。git tag 命令通常用来发布不再修改的版本(通过 git push <tagname> 命令)，且发布以后，不能再作修改，需要在本地创建新分支拉取标签资源，作适当修改后再发布。</tagname></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git tag <span class="comment"># 列出所有标签，以字母顺序罗列</span></span><br><span class="line">git tag -l|-list &lt;pattern&gt; <span class="comment"># 只罗列匹配的标签，如 git tag -l "v1.8.5*"。pattern 中若含有通配符，-l 选项不可缺失</span></span><br><span class="line">git tag &lt;tagname&gt; <span class="comment"># 创建轻量标签，git show &lt;tagname&gt; 时只显示 commit 信息</span></span><br><span class="line">git tag -a &lt;tagname&gt; -m <span class="string">"message"</span> <span class="comment"># 创建附注标签，git show &lt;tagname&gt; 时除显示 commit 信息外，还显示标签作者，电邮，日期，标签信息等</span></span><br><span class="line">git show &lt;tagname&gt; <span class="comment"># 查看标签信息及对应的提交信息</span></span><br><span class="line">git tag -a &lt;tagname&gt; &lt;checksum&gt; <span class="comment"># 提交后再打标签，选项 checksum 为 hash算法校验和，即快照的索引，可以只包含部分 hash 值</span></span><br><span class="line">git push origin &lt;tagname&gt; <span class="comment"># 将标签推送到远程共享服务器上</span></span><br><span class="line">git push --tags <span class="comment"># 将本地所有标签推送到服务器上</span></span><br><span class="line">git checkout &lt;tagname&gt; <span class="comment"># 检出标签，但不能真正检出标签，本地仓库会进入 "detached HEAD" 状态，提交将不从属于任何分支，只有 commit checksum 校验和能被 git 感知到</span></span><br><span class="line">git checkout -b &lt;branchnam&gt; &lt;tagname&gt; <span class="comment"># 在本地创建新分支，并拉取指定标签资源。修改后，重新创建标签并 push</span></span><br></pre></td></tr></table></figure>
<h3 id="疑问-1"><a href="#疑问-1" class="headerlink" title="疑问"></a>疑问</h3><ol>
<li>暂存区存在的意义？</li>
<li>强制删除的意义？</li>
<li>commit 提交记录以何种形式存储，才能实现快速检索？关于 git database？</li>
<li>本地版本库如何回滚？</li>
<li>git pull|push 只拉取或推送快照，还是所有历史记录？</li>
<li>git 远程服务器对版本管理的实现是否和本地相同，可否指定局域网中某台机器作为拉取资源的源头？</li>
<li>打标签只针对 commit 操作？且标签只针对不会再修改的版本？git push origin [tagname] 推送到共享服务器和 git push origin [branchname] 的差异？</li>
<li>切换分支时，为什么需要提交到版本库，而不是暂存库，这样就可以避免工作区的变更丢失了？</li>
</ol>
<h2 id="Git-Branching"><a href="#Git-Branching" class="headerlink" title="Git Branching"></a>Git Branching</h2><h3 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h3><p>分支原理见 Getting Started。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> --oneline --decorate <span class="comment"># --decorate 选项用于查询各个分支及 HEAD 指针指向哪个提交对象</span></span><br><span class="line">git <span class="built_in">log</span> --oneline --decorate --graph --all <span class="comment"># 查看提交历史的分叉情况，各个分支及 HEAD 指针的指向</span></span><br><span class="line">git branch <span class="comment"># 查看所有分支，带 '*' 的为当前分支</span></span><br><span class="line">git branch -v <span class="comment"># 查看所有分支最后一次提交记录</span></span><br><span class="line">git branch --merged <span class="comment"># 查看已合并到当前分支的所有分支</span></span><br><span class="line">git branch --no-merged <span class="comment"># 查看未合并到当前分支的所有分支</span></span><br><span class="line">git branch --merged &lt;branchname&gt; <span class="comment"># 查看已合并到 branchname 分支的所有分支</span></span><br><span class="line">git branch --no-merged &lt;branchname&gt; <span class="comment"># 查看未合并到 branchname 分支的所有分支</span></span><br><span class="line">git branch &lt;branchname&gt; <span class="comment"># 创建分支，但不切换分支</span></span><br><span class="line">git branch -d &lt;branchname&gt; <span class="comment"># 删除分支，branchname 未合并到当前分支，将不予删除</span></span><br><span class="line">git branch -D &lt;branchname&gt; <span class="comment"># 强制删除分支</span></span><br><span class="line">git checkout &lt;branchname&gt; <span class="comment"># 切换分支，即改变 HEAD 指针指向。修改文件但未提交到版本库的，git 将阻止切换</span></span><br><span class="line">git checkout -b &lt;branchname&gt; <span class="comment"># 创建并切换分支</span></span><br><span class="line">git merge &lt;branchname&gt; <span class="comment"># 将 branchname 分支合并到当前分支</span></span><br><span class="line">git status <span class="comment"># 查看冲突文件</span></span><br><span class="line">git mergetool <span class="comment"># 使用图形化工具解决冲突，默认使用 opendiff 工具，可选用工具包含 opendiff, kdiff3, tkdiff, xxdiff, meld, tortoisemerge, gvimdiff, diffuse, diffmerge, ecmerge, p4merge, araxis, bc3, codecompare, vimdiff, emerge</span></span><br><span class="line">git mergetool --tool-help <span class="comment"># 合并工具帮助信息</span></span><br></pre></td></tr></table></figure>
<h3 id="工作流"><a href="#工作流" class="headerlink" title="工作流"></a>工作流</h3><p>推荐使用的本地开发工作流/workflow 有两种，长期分支模式(Long-Running Branches)，特性分支模式(Topic Branches)。当然，这只是一种参考。</p>
<p>长期分支模式根据稳定性创建分支，需要较高稳定性的分支创建在前，较低稳定性的创建在后，如 master 分支先于 develop 分支，develop 分支先于 topic 分支，合并时依序将 topic 分支合并到 develop 分支，develop 分支合并到 master 分支。适用于大型项目，作为分支创建的基础结构，在每个分支可以再次使用特性分支模式。</p>
<p>特性分支模式适用于开发者想法多变的场景，比如在 master 分支基础创建 hotfix 分支，接着创建 hotfix_v2，同时开发 hotfix, hotfix_v2 分支，最终又启用 hotfix 分支；与此同时，开发过程中 master 分支不只产生了新的提交，后续又创建了实现新想法的 idea 分支，最后将 hotfix_v2, idea 分支合并到 master 分支。</p>
<h3 id="远程分支"><a href="#远程分支" class="headerlink" title="远程分支"></a>远程分支</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">git ls-remote &lt;shortname&gt; <span class="comment"># 查看远程引用清单</span></span><br><span class="line">git remote show &lt;shortname&gt; <span class="comment"># 查看远程引用详细信息</span></span><br><span class="line">git push &lt;shortname&gt; &lt;branch&gt; <span class="comment"># 将当前分支的提交内容推送到远程 branch 分支，git 自动将分支名扩展为 refs/heads/branch:refs/heads/branch，意为将本地 branch 分支推送并更新远程 branch 分支</span></span><br><span class="line">git push shortname localebranch:remotebranch <span class="comment"># 推送本地 localebranch 分支，将其作为远程 remotebranch 分支</span></span><br><span class="line">git merge shortname/branchname <span class="comment"># 将远程跟踪分支 shortname/branchname 合并到当前分支，合并前须 git fetch</span></span><br><span class="line">git checkout -b localebranch shortname/remotebranch <span class="comment"># 通过远程跟踪分支创建本地分支，自动跟踪远程分支，可使用 git pull|push 简化拉取、提交操作；且可以在命令行中使用 @&#123;upstream&#125; 或 @&#123;u&#125; 代替 shortname/remotebranch</span></span><br><span class="line">git checkout --track shortname/remotebranch <span class="comment"># 上一条命令的简写形式，创建 remotebranch 同名分支</span></span><br><span class="line">git checkout remotebranch <span class="comment"># 上一条命令的简写形式，条件是本地未存在 remotebranch 同名分支，远程存在</span></span><br><span class="line">git branch -u|--<span class="built_in">set</span>-upstream-to shortname/remotebranch <span class="comment"># 当前分支切换跟踪远程 remotebranch 分支。-u 选项可用于 pull, push 命令</span></span><br><span class="line">git branch -vv <span class="comment"># 查看本地分支在跟踪哪个远程分支，以及ahead, behind, up to date等提交状态。这条命令基于最后一次 fetch 的数据，命令本身没有连接服务器</span></span><br><span class="line">git fetch &lt;shortname|url&gt; <span class="comment"># 抓取远程仓库资源，包含所有分支，并创建本地远程跟踪分支，却不会创建可修改、供开发的本地同名分支。只下载远程仓库资源，不会更改工作区内容，需手动 merge</span></span><br><span class="line">git pull <span class="comment"># git fetch, git merge 命令的结合，拉取数据并合并</span></span><br><span class="line">git push origin --delete remotebranch <span class="comment"># 删除远程分支</span></span><br></pre></td></tr></table></figure>
<h3 id="变基"><a href="#变基" class="headerlink" title="变基"></a>变基</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git rebase &lt;basebranch&gt; <span class="comment"># 将当前分支以补丁形式在 basebranch 分支上创建新的提交对象。完成开叉分支的整合操作还需要在 basebranch 分支上 merge 当前分支</span></span><br><span class="line">git rebase &lt;basebranch&gt; &lt;topicbranch&gt; <span class="comment"># 同上，该命令不需要切换到 topicbranch 分支后执行</span></span><br><span class="line">git rebase --onto &lt;basebranch&gt; &lt;topicbranch1&gt; &lt;topicbranch2&gt; <span class="comment"># --onto 选项用于获取在 topicbranch2 分支内但不在 topicbranch1 内的文件修改补丁，并在 basebranch 分支上创建新的提交对象，即变基到 basebranch </span></span><br><span class="line">git rebase remote/branch <span class="comment"># 将本地修改变基到远程引用 remote/branch 分支上</span></span><br><span class="line">git pull --rebase remote/branch <span class="comment"># 等同 git fetch, get rebase remote/branch</span></span><br></pre></td></tr></table></figure>
<h2 id="Git-on-the-Server"><a href="#Git-on-the-Server" class="headerlink" title="Git on the Server"></a>Git on the Server</h2><h3 id="传输协议"><a href="#传输协议" class="headerlink" title="传输协议"></a>传输协议</h3><p>git 可以使用四种传输资料的协议：Local 本地协议，Http 协议，SSH 协议和 Git 协议。</p>
<p>Local 协议常见于协作者对同一个共享的文件系统(如一个挂载的 NFS)都有访问权限。git clone /opt/git/project.git 命令将采用硬链接或直接拷贝文件；git clone file:///opt/git/project.git 将触发用于网路传输资料的进程，传输效率较低；git remote add local_proj /opt/git/project.git 命令用于增加本地版本库。</p>
<p>Http 协议既支持像 git:// 协议一样设置匿名服务，也可以像 SSH 协议一样提供传输时的授权和加密。Git 协议，要么谁都可以克隆这个版本库，要么谁也不能。</p>
<h3 id="搭建-git-服务器"><a href="#搭建-git-服务器" class="headerlink" title="搭建 git 服务器"></a>搭建 git 服务器</h3><p>首先需要把现有 git 仓库导出为一个裸仓库，即不包含工作目录的仓库。这一过程通过 –bare 选项完成，具体命令为 git clone –bare my_project my_project.git。其次将裸仓库放在服务器上，若已在 git.example.com 搭好服务器，且需要在 /opt/git 目录下放置所有 git 仓库，通过执行 scp -r my_project.git <a href="mailto:user@git.example.com" target="_blank" rel="noopener">user@git.example.com</a>:/opt/git 复制裸仓库到 /opt/git 目录下。此时，对服务器 /opt/git 目录拥有可读权限的用户就可以通过 git clone <a href="mailto:user@git.example.com" target="_blank" rel="noopener">user@git.example.com</a>:/opt/git/my_project.git 克隆仓库。若在仓库中执行 git init –bare –shared 命令，可将仓库的权限设为可写(基于服务器文件系统权限)。连接服务器的权限通过服务器自有的 SSH 服务实现，创建访问账户也针对服务器，而不是 git 仓库。访问权限也可以在服务器创建 git 账户，然后将需要写权限的用户的 SSH 公钥加入 git 账户的 ~/.ssh/authorized_keys 文件中；或者让 SSH 服务器通过某个 LDAP 服务，或者其他已经设定好的集中授权机制，来进行授权。</p>
<p>生成 SSH 公钥通过以下步骤完成：通过 ssh-keygen 命令创建公钥(存放在 id_dsa.pub 文件中)和密钥(存放在 id_dsa 文件中)；将公钥复制到 git 账户的 ~/.ssh/authorized_keys 文件中(通过 git 服务器管理员完成，或自动化脚本实现)。</p>
<p>在服务器创建 git 账户时，将使所有获得授权的用户都能以系统用户 git 的身份登录服务器从而获得一个普通 shell，即能对服务器进行一定操作。若想对此加以限制，则需要修改 passwd 文件中(git 用户所对应)的 shell 值；或者通过 git 软件包自带的 git-shell 工具代替 bash 或 csh 作为用户的登录 shell，用户即不能通过登录 shell 执行非 git 命令(上述过程，通过 sudo chsh git 命令改变系统用户的登录 shell 实现)。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> --bare my_project my_project.git <span class="comment"># 通过 --bare 选项创建裸仓库</span></span><br><span class="line">cp -Rf my_project/.git my_project.git <span class="comment"># 同上</span></span><br><span class="line">git init --bare <span class="comment"># 新疆一个空仓库</span></span><br><span class="line">git init --bare --shared <span class="comment"># 新疆一个空仓库，并将仓库的权限设为可写</span></span><br></pre></td></tr></table></figure>
<h3 id="疑问-2"><a href="#疑问-2" class="headerlink" title="疑问"></a>疑问</h3><ol>
<li>协议相关知识再梳理？</li>
<li>搭建 git 服务器过程再梳理，包含守护进程、git-http-backend 脚本在Apache 服务器上的使用、GitWeb 网页查看、GitLab 服务器等？</li>
</ol>
<h2 id="Distributed-Git"><a href="#Distributed-Git" class="headerlink" title="Distributed Git"></a>Distributed Git</h2><h3 id="分布式工作流"><a href="#分布式工作流" class="headerlink" title="分布式工作流"></a>分布式工作流</h3><p>分布式工作流有三种，包含集中式工作流、集成管理者工作流、司令官和副官工作流。一般项目采用集中式工作流，当 A 用户提交了代码后，B 用户再次提交前，先须拉取代码并合并，然后才能提交；否则会报提交失败。集成管理者工作流通常在 github 开源代码中采用，即作为开源代码的贡献者，先须 fork 该项目，创建一个自己的仓库，更新提交后，发送消息给开源代码的维护者，等待维护者合并贡献者的代码并提交。司令官和副官工作流见于 linux 开发项目，普通开发者完成开发后，基于司令官的 master 执行变基操作；副官再将普通开发者的分支合并到自己的 master 分支上；司令官合并所有副官的 master 分支并提交。</p>
<h3 id="提交准则"><a href="#提交准则" class="headerlink" title="提交准则"></a>提交准则</h3><ol>
<li>避免空白错误。</li>
<li>尝试让每一个提交成为一个逻辑上的独立变更集，即针对每个问题，独立提交一次。</li>
<li>完善提交信息，使用 vim 编辑提交信息，推荐使用 标题 + 空行 + 正文 形式。</li>
</ol>
<h3 id="贡献代码"><a href="#贡献代码" class="headerlink" title="贡献代码"></a>贡献代码</h3><h4 id="私有小型团队"><a href="#私有小型团队" class="headerlink" title="私有小型团队"></a>私有小型团队</h4><p>用户 A 创建特性分支 feature1 并作修改后，再将特性分支合并到 master 分支上。用户 B 创建了特性分支 feature2 并作修改后，若在此时，用户 B 想把 feature2 内容合并到 master 分支并作提交，那他需要在 master 分支上执行 git fetch; git merge origin/master; git merge feature2 命令，即合并本地特性分支和远程协作者提交内容后，才可以正式提交代码。这样的工作流程最常见于实际项目中。</p>
<h4 id="私有大型团队"><a href="#私有大型团队" class="headerlink" title="私有大型团队"></a>私有大型团队</h4><p>用户 A 和 B 在特性分支 feature1 上工作，用户 B 和 C 在特性分支 feature2 上工作。工作流程采用了整合-管理者工作流程，即独立小组的工作只能被特定的工程师整合，主仓库的 master 分支只能被那些工程师更新。当 feature1, feature2 开发并测试完成后，再由整合者将两个分支的内容合并到 master 分支上。对于 feature1, feature2 的开发工作流程，同小型私有团队，即提交前先要合并协作者上传到远端的代码。</p>
<h4 id="派生的公开项目"><a href="#派生的公开项目" class="headerlink" title="派生的公开项目"></a>派生的公开项目</h4><p>首先 clone 项目，然后在本地创建 feature1 分支(使 master 分支保持干净，避免维护者不采用你的代码时，需要回滚 master 分支到最初 clone 时的状态)，fork 仓库(即派生项目)后提交到远程自己的同名仓库中。通知开源项目的维护者拉取你的改动，这通常被称为拉取请求(pull request)，可通过执行 git request-pull origin/master feature 命令告知维护者改动是在你 fork 的仓库的 feature 分支上完成的。</p>
<h4 id="通过邮件的公开项目"><a href="#通过邮件的公开项目" class="headerlink" title="通过邮件的公开项目"></a>通过邮件的公开项目</h4><p>有几个历史悠久的、大型的项目会通过一个开发者的邮件列表接受补丁。使用 git format-patch 来生成可以邮寄到列表的 mbox 格式的文件 - 它将每一个提交转换为一封电子邮件，提交信息的第一行作为主题，剩余信息与提交引入的补丁作为正文。-M 选项用于告诉 Git 查找重命名。通过 git config 设置 imap 区块的 folder = “[Gmail]/Drafts”, host = imaps://imap.gmail.com, user = <a href="mailto:user@gmail.com" target="_blank" rel="noopener">user@gmail.com</a>, pass = p4ssw0rd, port = 993, sslverify = false 属性(如果 IMAP 服务器不使用 SSL，无需设置 port, sslverify 属性，host 的值会是 imap:// 而不是 imaps://)；再执行 git imap-send 可以将补丁序列放在特定 IMAP 服务器的 Drafts 文件夹。或者通过 git config 设置 sendemail 区块的 smtpencryption = tls, smtpserver = smtp.gmail.com, smtpuser = <a href="mailto:user@gmail.com" target="_blank" rel="noopener">user@gmail.com</a>, smtpserverport = 587 属性；再执行 git send-email 通过 SMTP 服务器发送补丁。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git diff --check <span class="comment"># 检查空白错误。空白错误是指行尾的空格、Tab 制表符，和行首空格后跟 Tab 制表符的行为</span></span><br><span class="line">git format-patch -M origin/master <span class="comment"># 生成 .patch 扩展名的补丁文件，可以编辑该文件，添加额外信息</span></span><br><span class="line">cat *.patch |git imap-send <span class="comment"># 通过 IMAP 发送正确格式化的补丁</span></span><br><span class="line">git send-email *.patch <span class="comment"># 通过 SMTP 服务器发送补丁</span></span><br></pre></td></tr></table></figure>
<h3 id="维护项目"><a href="#维护项目" class="headerlink" title="维护项目"></a>维护项目</h3><h4 id="应用补丁"><a href="#应用补丁" class="headerlink" title="应用补丁"></a>应用补丁</h4><p>若补丁通过 git diff 生成，使用 git apply 命令可在当前工作分支中应用文件补丁。应用补丁前，使用 git apply –check 命令可检查补丁是否可以顺利应用。</p>
<p>若补丁通过 format-patch 生成，使用 git am 命令可以提取出 mbox 文件中的实际变更并应用，且自动创建新的提交。</p>
<h4 id="合并工作流"><a href="#合并工作流" class="headerlink" title="合并工作流"></a>合并工作流</h4><p>合并工作流，可以将特性分支逐次合并到 master 分支上；或者保持 master 分支的稳定性，再创建 develop 长期分支，将特性分支合并 develop 分支，等 develop 分支稳定后，再合并到 master 分支上；或者在 master 之外创建 next, pu(proposed updates，用于新工作), maint(maintenance backports，用于维护性向后移植工作) 分支，安全的特性分支先合并入 next 分支，再合并到 master 分支上。</p>
<h4 id="拣选"><a href="#拣选" class="headerlink" title="拣选"></a>拣选</h4><p>执行 git cherry-pick，见原理。</p>
<h4 id="重用冲突解决方案-reuse-recorded-resolution"><a href="#重用冲突解决方案-reuse-recorded-resolution" class="headerlink" title="重用冲突解决方案/reuse recorded resolution"></a>重用冲突解决方案/reuse recorded resolution</h4><p>执行 git config –global rerere.enabled true 缓存冲突解决方案。执行 git rerere 命令将从缓存中查找相似的冲突，并应用对应的解决方案。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">git apply *.patch <span class="comment"># 在当前分支中应用补丁</span></span><br><span class="line">git apply --check *.patch <span class="comment"># 检查补丁是否可被顺利应用</span></span><br><span class="line">git am *.patch <span class="comment"># 读取 mbox 文件实际变更并应用</span></span><br><span class="line">git am -3 *.patch <span class="comment"># -3 选项将使用三方合并应用补丁</span></span><br><span class="line">git am -3 -i mbox <span class="comment"># 使用交互模式应用多个补丁</span></span><br><span class="line">git am --resolved <span class="comment"># git am 报错后，手动解决冲突，执行下一个补丁的应用</span></span><br><span class="line">git am --skip <span class="comment"># 跳过当前补丁</span></span><br><span class="line">git am --abort <span class="comment"># 当前分支回退到应用补丁前状态，终止补丁应用</span></span><br><span class="line">git <span class="built_in">log</span> branch1 --not branch2 <span class="comment"># 找出仅属于 branch1 但不属于 branch2 的提交记录</span></span><br><span class="line">git diff branch <span class="comment"># 当前工作分支与 branch 分支比较差异</span></span><br><span class="line">git merge-base branch1 branch2 <span class="comment"># 找出 branch1 和 branch2 的共同祖先</span></span><br><span class="line">git diff branch1...branch2 <span class="comment"># 比较 branch1 的最新提交和两个分支的共同祖先之间的差异</span></span><br><span class="line">git cherry-pick &lt;checksum&gt; <span class="comment"># 以某个提交对象为基底在当前工作分支上创建新的提交对象，将重新计算校验和，如 git cherry-pick e43a6fd3e94888d76779ad79fb568ed180e5fcdf</span></span><br><span class="line">git config --global rerere.enabled <span class="literal">true</span> <span class="comment"># 开启冲突解决方案缓存</span></span><br><span class="line">git rerere <span class="comment"># 查找相似的冲突解决方案并应用</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 发布</span></span><br><span class="line">git tag -s &lt;version&gt; -m <span class="string">'message'</span> <span class="comment"># 打标签</span></span><br><span class="line">gpg --list-keys <span class="comment"># 查找 GPG 公钥</span></span><br><span class="line">gpg -a --<span class="built_in">export</span> &lt;gpgkey&gt; | git <span class="built_in">hash</span>-object -w --stdin <span class="comment"># git hash-object 命令以 blob 对象形式在 git 中导入公钥，并返回该 blob 对象的 SHA-1 值。该 SHA-1 值可以用于发布标签，如 git tag -a &lt;tagname&gt; &lt;sha-1&gt;</span></span><br><span class="line">git show &lt;tagname&gt; | gpg --import <span class="comment"># 开发者获取并导入公钥，用于贡献代码</span></span><br><span class="line">git describe &lt;branch&gt; <span class="comment"># 生成构建号，包含最近的标签名、自该标签之后的提交数目和你所描述的提交的部分 SHA-1 值</span></span><br><span class="line">git archive master --prefix=<span class="string">'project/'</span> | gzip &gt; `git describe master`.tar.gz <span class="comment"># 创建 .tar.gz 压缩包</span></span><br><span class="line">git archive master --prefix=<span class="string">'project/'</span> --format=zip &gt; `git describe master`.zip <span class="comment"># 创建 .zip 压缩包</span></span><br><span class="line">git shortlog --no-merges master --not v1.0.1 <span class="comment"># 生成自 v1.0.1 版本发布以来所有提交的总结</span></span><br></pre></td></tr></table></figure>
<p>疑问：</p>
<ol>
<li>公共项目的发布问题？</li>
</ol>
<h2 id="Github"><a href="#Github" class="headerlink" title="Github"></a>Github</h2><p>github 钩子和服务订制、API，参见：<br><a href="https://git-scm.com/book/zh/v2/GitHub-脚本-GitHub" target="_blank" rel="noopener">https://git-scm.com/book/zh/v2/GitHub-脚本-GitHub</a><br><a href="https://developer.github.com" target="_blank" rel="noopener">https://developer.github.com</a></p>
<h2 id="Git-Tools"><a href="#Git-Tools" class="headerlink" title="Git Tools"></a>Git Tools</h2><h3 id="选取提交记录"><a href="#选取提交记录" class="headerlink" title="选取提交记录"></a>选取提交记录</h3><p>根据提交对象的 SHA-1 值查看提交记录。引用日志只在本地生成，不能通过远程交互被协作者拷贝。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span> --abbrev-commit --pretty=oneline <span class="comment"># 获取简短且唯一的 SHA-1 值</span></span><br><span class="line">git show &lt;sha-1&gt;|&lt;branch&gt; <span class="comment"># 显示提交记录</span></span><br><span class="line">git rev-parse &lt;branch&gt; <span class="comment"># 获取最近一次提交的 SHA-1 值</span></span><br><span class="line">git reflog <span class="comment"># 查看引用日志，引用日志记录了最近几个月的 HEAD 和分支引用所指向的历史，包含提交对象的简短 SHA-1 值、HEAD 记录和提交信息</span></span><br><span class="line">git show HEAD@&#123;5&#125; <span class="comment"># 查看第五次提交记录</span></span><br><span class="line">git show &lt;branch&gt;@&#123;yesterday&#125; <span class="comment"># 查看 branch 分支昨天指向了哪个提交</span></span><br><span class="line">git show HEAD^ <span class="comment"># ^ 引用指上一次提交，HEAD^ 即上一次提交，HEAD^^ 即之前第二次提交</span></span><br><span class="line">git show &lt;sha-1&gt;^ <span class="comment"># 特定提交的上一次提交</span></span><br><span class="line">git show HEAD~ <span class="comment"># ~ 指父引用，~2 指之前第二次提交</span></span><br><span class="line">git show &lt;sha-1&gt;~num <span class="comment"># 特定提交前第 num 次提交</span></span><br><span class="line"></span><br><span class="line">git <span class="built_in">log</span> branch1..branch2 <span class="comment"># branch1..branch2 指在 branch2 分支中而不在 branch1 分支中的提交，branch2 留空，自动以 HEAD 填充，如 git log origin/master..HEAD 或 git log origin/master..。branch1..branch2可用于其他命令</span></span><br><span class="line">git <span class="built_in">log</span> refA refB ^refC <span class="comment"># 指定被 refA, refB 包含，但不被 refC 包含的提交记录</span></span><br><span class="line">git <span class="built_in">log</span> refA refB --not refC <span class="comment"># 同上</span></span><br><span class="line">git <span class="built_in">log</span> branch1...branch2 <span class="comment"># 选出不被两个分支同时包含的提交记录</span></span><br><span class="line">git <span class="built_in">log</span> --left-right branch1...branch2 <span class="comment"># 选出不被两个分支同时包含的提交记录，并显示提交对象属于 branch1 还是 branch2</span></span><br></pre></td></tr></table></figure>
<h3 id="交互式暂存"><a href="#交互式暂存" class="headerlink" title="交互式暂存"></a>交互式暂存</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git add -i|--interactive <span class="comment"># --interactive 选项用于开启交互式暂存命令行，执行后左侧显示已暂存的，右侧显示未暂存的；根据提示命令面板执行后续操作，如 1/status 显示状态, 2/update 提交到暂存区, 3/revert 从暂存区撤回, 4/add untracked 提交未追踪文件到暂存区, 5/patch 暂存补丁，可将部分修改提交到暂存区, 6/diff 查看已暂存内容的区别</span></span><br><span class="line">git add -p|--patch <span class="comment"># 暂存部分文件</span></span><br><span class="line">git reset --patch <span class="comment"># 部分重置文件</span></span><br><span class="line">git checkout --patch <span class="comment"># 部分检出文件</span></span><br><span class="line">git stash save --patch <span class="comment"># 部分暂存文件</span></span><br></pre></td></tr></table></figure>
<h3 id="储藏"><a href="#储藏" class="headerlink" title="储藏"></a>储藏</h3><p>通过 git stash 命令可以将工作区的改动储藏起来，却不是提交到暂存区；再使用 git stash apply 应用之前的储藏(可以在另一个分支上应用储藏；且当前分支做过修改后，仍可以应用储藏，必要时需解决冲突)。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">git stash <span class="comment"># 储藏工作区的改动，可用于切换分支前避免与远程代码的合并</span></span><br><span class="line">git stash save <span class="comment"># 同上</span></span><br><span class="line">git stash --keep-index <span class="comment"># 同上，--keep-index 选项将不储藏已使用 git add 暂存的内容</span></span><br><span class="line">git stash -u|--include-untracked <span class="comment"># 默认 git stash 不包含未追踪的文件，--include-untracked 选项将包含未追踪的文件</span></span><br><span class="line">git stash --patch <span class="comment"># 交互式地指引用户需要将那些改动储藏，那些改动保存在工作区</span></span><br><span class="line">git stash --all <span class="comment"># 移除修改，并储藏起来</span></span><br><span class="line">git stash list <span class="comment"># 查看所有储藏内容</span></span><br><span class="line">git stash apply <span class="comment"># 将储藏重新应用在工作分支上，默认为最近的储藏</span></span><br><span class="line">git stash apply stash@&#123;num&#125; <span class="comment"># 将第 num 次储藏应用在工作分支上，0 为最近的储藏</span></span><br><span class="line">git stash apply --index <span class="comment"># 应用储藏，同时应用暂存</span></span><br><span class="line">git stash branch &lt;branchname&gt; <span class="comment"># 创建一个新分支，检出储藏工作时所在的提交，重新在那应用工作，并扔掉储藏</span></span><br><span class="line">git stash drop stash@&#123;num&#125; <span class="comment"># 移除储藏</span></span><br><span class="line">git stash pop stash@&#123;num&#125; <span class="comment"># 应用并移除储藏</span></span><br></pre></td></tr></table></figure>
<h3 id="清理"><a href="#清理" class="headerlink" title="清理"></a>清理</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git clean <span class="comment"># 从工作目录中移除未被追踪的文件</span></span><br><span class="line">git clean -f -d <span class="comment"># 强制移除工作目录中所有未追踪的文件以及空的子目录</span></span><br><span class="line">git clean -d -n <span class="comment"># 移除项预览</span></span><br><span class="line">git clean -n -d -x <span class="comment"># git clean 默认不移除 .gitignore 中匹配的文件，-x 选项将移除该类文件</span></span><br><span class="line">git clean -x -i|--interactive <span class="comment"># 交互式执行 clean 命令</span></span><br></pre></td></tr></table></figure>
<h3 id="签署标签"><a href="#签署标签" class="headerlink" title="签署标签"></a>签署标签</h3><p>参考：<a href="https://git-scm.com/book/zh/v2/Git-工具-签署工作" target="_blank" rel="noopener">https://git-scm.com/book/zh/v2/Git-工具-签署工作</a></p>
<h3 id="搜索"><a href="#搜索" class="headerlink" title="搜索"></a>搜索</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git grep string/regexp <span class="comment"># 从提交历史或工作目录中查找匹配正则或字符串的内容，--and 选项用于设置更复杂字符串或正则匹配规则</span></span><br><span class="line">git grep string/regexp &lt;filepath&gt; &lt;version&gt; <span class="comment"># 指定文件或文件夹、版本号搜索</span></span><br><span class="line">git grep -n string/regexp <span class="comment"># 输出行号</span></span><br><span class="line">git grep -p string/regexp <span class="comment"># 查看匹配的行属于哪一个方法或函数</span></span><br><span class="line">git grep -count string/regexp <span class="comment"># 输出概要信息</span></span><br><span class="line">git grep --<span class="built_in">break</span> --heading string/regexp <span class="comment"># 使输出更易读</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 日志搜索</span></span><br><span class="line">git <span class="built_in">log</span> -string --oneline <span class="comment"># 从提交历史或 diff 内容中检索匹配字符串或正则的提交记录，-S 选项只查看新增和删除匹配内容的提交，-G 选项使用正则表达式检索</span></span><br><span class="line">git <span class="built_in">log</span> -L :string:filepath <span class="comment"># 行日志搜索，搜索特定文件中 string 变更的提交记录</span></span><br></pre></td></tr></table></figure>
<h3 id="重写历史"><a href="#重写历史" class="headerlink" title="重写历史"></a>重写历史</h3><p>git commit –amend 用于修改前一次提交。<br>git rebase -i 交互式修改多次提交记录，可拆分，可弃用，可合并，可重置等。须在本地环境中使用，提交到线上再调用变基，会使协作者变得不方便。<br>git filter-branch 使用脚本的方式改写大量提交记录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">git commit --amend <span class="comment"># 修改前一次提交记录，修改暂存区再执行该命令时可改变提交内容，否则只是改变提交信息</span></span><br><span class="line">git rebase -i HEAD~2^|HEAD~3 <span class="comment"># -i 选项开启交互式变基命令，将唤起编辑器，反序修改前三次提交，最后一次修改在前。因为之前的提交已提交，显示 p, pick 默认提交，修改为 r, reword 重写提交信息；e, edit 使用  git commit --amend 重置提交，可用于拆分提交；s, squash 将提交信息合并到之前执行 pick 命令的提交对象中，且将多次提交信息合并；f, fixup 同 squash，但丢弃提交信息，x, exec，唤起 shell 提交。弃用某次提交记录，可直接从 git rebase -i HEAD~2^|HEAD~3 显示的列表中删除</span></span><br><span class="line">git filter-branch --tree-filter <span class="string">'rm -f passwords.txt'</span> HEAD <span class="comment"># --tree-filter 选项在检出项目的每一个提交后运行指定的命令然后重新提交结果。--all 选项用于改写所有分支</span></span><br><span class="line">git filter-branch --subdirectory-filter trunk HEAD <span class="comment"># 让 trunk 子目录作为每一个提交的新的项目根目录</span></span><br><span class="line">git filter-branch --commit-filter <span class="string">'</span></span><br><span class="line"><span class="string">  if [ "$GIT_AUTHOR_EMAIL" = "schacon@localhost" ];</span></span><br><span class="line"><span class="string">  then</span></span><br><span class="line"><span class="string">    GIT_AUTHOR_NAME="Scott Chacon";</span></span><br><span class="line"><span class="string">    GIT_AUTHOR_EMAIL="schacon@example.com";</span></span><br><span class="line"><span class="string">    git commit-tree "$@";</span></span><br><span class="line"><span class="string">  else</span></span><br><span class="line"><span class="string">    git commit-tree "$@";</span></span><br><span class="line"><span class="string">  fi'</span> HEAD <span class="comment"># 修改多个项目的提交邮箱，且重写每个提交的校验和，不只匹配邮箱地址的提交</span></span><br></pre></td></tr></table></figure>
<h3 id="重置揭密"><a href="#重置揭密" class="headerlink" title="重置揭密"></a>重置揭密</h3><p>参考原理。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git cat-file -p HEAD <span class="comment"># 查看版本库当前提交信息</span></span><br><span class="line">git ls-tree -r HEAD <span class="comment"># 查看版本库中提交文件的 checksum 及其文件名</span></span><br><span class="line">git ls-files -s <span class="comment"># 查看暂存区中文件的 checksum 及其文件名</span></span><br><span class="line"></span><br><span class="line">git reset &lt;checksum&gt; <span class="comment"># 将版本库和暂存区内容替换为 checksum 指向的提交对象</span></span><br><span class="line">git reset --soft &lt;checksum&gt; <span class="comment"># 将版本库内容替换为 checksum 指向的提交对象</span></span><br><span class="line">git reset --mixed &lt;checksum&gt; <span class="comment"># 将版本库和暂存区内容替换为 checksum 指向的提交对象</span></span><br><span class="line">git reset --hard &lt;checksum&gt; <span class="comment"># 将版本库、暂存区和工作区内容替换为 checksum 指向的提交对象</span></span><br><span class="line">git reset &lt;filepath&gt; <span class="comment"># 从 HEAD 中获取 filepath 文件或目录，复制到暂存区</span></span><br><span class="line">git reset &lt;checksum&gt; &lt;filepath&gt; <span class="comment"># 从 checksum 中获取 filepath 文件或目录，复制到暂存区</span></span><br></pre></td></tr></table></figure>
<h3 id="高级合并"><a href="#高级合并" class="headerlink" title="高级合并"></a>高级合并</h3><p>合并前可以通过保存到临时分支或通过执行 git stash 命令储藏起来，避免合并对工作区的影响，使工作区内容丢失。</p>
<p>子树合并是项目某目录下包含一个子工程，同时 git 分支也包含一个从属于子工程的分支，从而引起子分支和子工程目录的合并操作。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">git merge --abort <span class="comment"># 退出合并，工作区内容恢复到合并前</span></span><br><span class="line">git reset --hard HEAD <span class="comment"># 退出合并，将版本库、暂存区和工作区内容重置到合并前</span></span><br><span class="line">git merge -Xignore-space-change <span class="comment"># 忽略任意数量的已有空白的修改</span></span><br><span class="line">git merge -Xignore-space-change <span class="comment"># 忽略所有空白修改</span></span><br><span class="line">git show :1:&lt;conflictFileName&gt; &gt; commonFileName <span class="comment"># 拷贝并导出冲突的共同祖先文件</span></span><br><span class="line">git show :2:&lt;conflictFileName&gt; &gt; oursFileName <span class="comment"># 拷贝并导出冲突的工作目录文件</span></span><br><span class="line">git show :3:&lt;conflictFileName&gt; &gt; theirsFileName <span class="comment"># 拷贝并导出冲突的待合并文件</span></span><br><span class="line">git ls-files -u <span class="comment"># 查看冲突文件的完整 SHA-1 值</span></span><br><span class="line">git merge-file -p \</span><br><span class="line">  oursFileName commonFileName theirsFileName &gt; fileName <span class="comment"># oursFileName, commonFileName, theirsFileName 拷贝的冲突文件手工解决冲突后，合并冲突文件</span></span><br><span class="line">git diff --ours <span class="comment"># 查看合并结果和当前工作分支的差别，-b 选项用于移除空格比较，--base 选项查看比较文件两边是如何改动的</span></span><br><span class="line">git diff --theirs <span class="comment"># 查看合并结果和待合并分支的差别</span></span><br><span class="line">git clean -f <span class="comment"># 清理为合并拷贝的文件，如 commonFileName 等</span></span><br><span class="line">git checkout --conflict=diff3 <span class="comment"># 查看工作分支、待合并分支、共同祖先分支的冲突文件</span></span><br><span class="line">git checkout --conflict=merge <span class="comment"># 默认，查看工作分支、待合并分支的冲突文件</span></span><br><span class="line">git checkout --ours <span class="comment"># 合并时使用当前工作分支文件内容</span></span><br><span class="line">git checkout --theirs <span class="comment"># 合并时使用待合并分支文件内容</span></span><br><span class="line">git <span class="built_in">log</span> --oneline --left-right branch1...branch2 <span class="comment"># 查看合并文件的提交记录来源</span></span><br><span class="line">git <span class="built_in">log</span> --oneline --left-right --merge <span class="comment"># 查看合并过程中，有冲突文件的提交记录来源</span></span><br><span class="line">git diff <span class="comment"># 查看冲突文件或冲突结果</span></span><br><span class="line">git <span class="built_in">log</span> --cc -p -1 <span class="comment"># 查看冲突结果</span></span><br><span class="line">git reset --hard HEAD~ <span class="comment"># 撤销合并，将版本库撤回到合并前状态</span></span><br><span class="line">git revert -m 1 basebranch <span class="comment"># 撤销合并，将提交对象撤回到 basebranch 分支内容。-m 1 标记指出 “mainline” 需要被保留下来的父结点。此时将无法合并待合并分支的内容</span></span><br><span class="line">git revert &lt;checksum&gt; <span class="comment"># 撤销 git revert -m 1 basebranch 命令</span></span><br><span class="line">git merge -Xours &lt;branch&gt; <span class="comment"># 选用当前工作分支内容进行合并</span></span><br><span class="line">git merge -Theirs &lt;branch&gt; <span class="comment"># 选用待合并分支内容进行合并</span></span><br><span class="line">git merge-file --ours &lt;filepath&gt; <span class="comment"># 选用当前工作分支内容进行合并</span></span><br><span class="line">git merge-file --theirs &lt;filepath&gt; <span class="comment"># 选用待合并分支内容进行合并</span></span><br><span class="line">git merge -s ours &lt;branch&gt; <span class="comment"># 假合并，直接将当前工作分支内容作为合并结果</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 子树合并</span></span><br><span class="line">git <span class="built_in">read</span>-tree --prefix=dirname/ -u sub_project_branch <span class="comment"># 将子工程分支的内容拷贝到 dirname 目录中</span></span><br><span class="line">git merge --squash -s recursive -Xsubtree=dirname sub_project_branch <span class="comment"># 将 sub_project_branch 分支内容合并到 dirname 目录中</span></span><br><span class="line">git diff-tree -p sub_project_branch <span class="comment"># 查看差异</span></span><br><span class="line">git diff-tree -p &lt;remote&gt;/&lt;branch&gt; <span class="comment"># 和远程引用相比较</span></span><br></pre></td></tr></table></figure>
<h3 id="rerere-命令"><a href="#rerere-命令" class="headerlink" title="rerere 命令"></a>rerere 命令</h3><p>通过 git config –global rerere.enabled true 命令开启 rerere 功能。rerere 记录冲突解决方案，自动解决冲突。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git config --global rerere.enabled <span class="literal">true</span> <span class="comment"># 开启 rerere 功能</span></span><br><span class="line">git rerere status <span class="comment"># 查看合并前的状态</span></span><br><span class="line">git rerere diff <span class="comment"># 查看解决前后的文件内容差异。冲突解决后，可查看 git rerere 将要记录的内容</span></span><br><span class="line">git ls-files -u <span class="comment"># 查看各冲突文件 checksum</span></span><br></pre></td></tr></table></figure>
<h3 id="使用-git-调试"><a href="#使用-git-调试" class="headerlink" title="使用 git 调试"></a>使用 git 调试</h3><p>使用 git blame 命令可以查看文件内容的历次更改，适用在确知某方法会引起 bug 的场景，可查看该方法的改动细节。</p>
<p>使用 git bisect 命令可以定位哪次提交引起了异常。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">git blame -L startLine,endLine filepath <span class="comment"># 查看 filepath 文件自 startLine 起始、到 endLine 行结束的变更记录。-L 选项用于限制行号。-C 选项会分析拷贝之后再重命名文件的原始出处</span></span><br><span class="line"></span><br><span class="line">git bisect start <span class="comment"># 启动二分查找</span></span><br><span class="line">git bisect bad <span class="comment"># 告知 git 当前提交有问题</span></span><br><span class="line">git bisect good &lt;checksum&gt; <span class="comment"># 告知 git 将 checksum 指向的提交对象标记为好的。由 git 告知用户在正常提交和错误提交之间有多少次提交，二次查找中间那次提交，通过 git bisect bad 或 git bisect good 标记好坏。git 会自动定位到提交中点，再由用户判断提交结果的好坏</span></span><br><span class="line">git bisect reset <span class="comment"># 重置 HEAD 指针</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过执行脚本定位 bug 来源。checksum1 是坏的提交，checksum2 是好的提交</span></span><br><span class="line">git bisect start &lt;checksum1&gt;|HEAD &lt;checksum2&gt;</span><br><span class="line">git bisect run filepath</span><br></pre></td></tr></table></figure>
<h3 id="子模块"><a href="#子模块" class="headerlink" title="子模块"></a>子模块</h3><p>子模块虽然在工程目录中创建了子目录，但是若不在该子目录中，git 并不会跟踪子模块的文件内容，而是将它看作该仓库中的一个特殊提交。子模块提交时标记为 160000 模式，意味着将一次提交记作一项目录记录，而非将它记录成一个子目录或者一个文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">git submodule add &lt;remoteurl&gt; &lt;dirname&gt; <span class="comment"># 克隆远程仓库，以远程仓库名创建文件夹，或者自定义文件夹。同时会添加 .gitmodules 文件，用于保存本地目录和远程仓库地址</span></span><br><span class="line">git config submodule.&lt;dirname&gt;.url &lt;url&gt; <span class="comment"># 重设远程仓库地址</span></span><br><span class="line">git diff --cached --submodule <span class="comment"># 查看子模块的文件差异</span></span><br><span class="line">git submodule init <span class="comment"># 子模块初始化</span></span><br><span class="line">git submodule update <span class="comment"># 获取远程仓库数据，并检出父项目中属于子模块的提交</span></span><br><span class="line">git <span class="built_in">clone</span> --recursive mainurl <span class="comment"># mainurl 为父项目的 url，同时更新子模块</span></span><br><span class="line">git submodule update --remote subproject <span class="comment"># 在父项目工作目录中进行更新，避免手动进入子模块抓取和合并</span></span><br><span class="line">git submodule update --remote --merge <span class="comment"># 合并</span></span><br><span class="line">git submodule update --remote --rebase <span class="comment"># 变基</span></span><br><span class="line">git submodule update --init <span class="comment"># 初始化拉取远程内容</span></span><br><span class="line">git <span class="built_in">log</span> -p --submodule <span class="comment"># 查看子模块的提交日志</span></span><br><span class="line">git push --recurse-submodules=check <span class="comment"># 推送时校验子项目有否提交</span></span><br><span class="line">git push --recurse-submodules=on-demand <span class="comment"># 推送子模块，或者子项目中执行 git push 命令</span></span><br><span class="line">git submodule foreach <span class="string">'git stash'</span> <span class="comment"># 在所有子模块中运行 git stash 命令</span></span><br><span class="line">git rm -r &lt;dirname&gt; <span class="comment"># 从暂存区移除子项目目录</span></span><br><span class="line">rm -Rf &lt;dirname&gt; <span class="comment"># 移除子项目目录</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 子模块命令别名</span></span><br><span class="line">git config alias.sdiff <span class="string">'!'</span><span class="string">"git diff &amp;&amp; git submodule foreach 'git diff'"</span></span><br><span class="line">git config alias.spush <span class="string">'push --recurse-submodules=on-demand'</span></span><br><span class="line">git config alias.supdate <span class="string">'submodule update --remote --merge'</span></span><br></pre></td></tr></table></figure>
<h3 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git bundle create bundlefilename HEAD &lt;branch&gt; <span class="comment"># 将 branch 分支所有提交数据打包到 bundlefilename 文件中</span></span><br><span class="line">git bundle create bundlefilename &lt;branch&gt; ^&lt;checksum&gt; <span class="comment"># 设定提交区间，并打包文件。提交区间可以用 ... 等符号操作</span></span><br><span class="line">git <span class="built_in">clone</span> bundlefilename dirname <span class="comment"># 将打包文件解压到 dirname 目录中</span></span><br><span class="line">git bundle verify bundlefilename <span class="comment"># 校验打包文件是不是合法的 Git 包</span></span><br><span class="line">git bundle list-heads bundlefilename <span class="comment"># 查看打包文件包含哪些提交对象和分支</span></span><br><span class="line">git fetch bundlefilename branch:<span class="built_in">local</span>-branch <span class="comment"># 将打包文件中的分支导入本地工程中</span></span><br></pre></td></tr></table></figure>
<h3 id="替换"><a href="#替换" class="headerlink" title="替换"></a>替换</h3><p>大型项目可分成一个短历史提交记录和一个长历史提交记录，短历史供新的开发者使用，后者给喜欢数据挖掘的人使用。制作短历史提交记录通过 git commit-tree 命令合并提交记录，再通过 git rebase 命令将必要的提交变基到刚创建的合并提交记录上，就可以制作短历史提交记录。执行 git replace 命令，可以查看长历史提交记录。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">git branch &lt;branch&gt; &lt;checksum&gt; <span class="comment"># 以提交对象 checksum 创建分支 branch</span></span><br><span class="line">git push remote localbranch:remotebranch <span class="comment"># 将本地 localbranch 分支推送到远程仓库 remote 下的 remotebranch 分支</span></span><br><span class="line">git commit-tree &lt;checksum&gt;^&#123;tree&#125; <span class="comment"># 将 checksum 提交对象及其前的提交合并为新的提交对象，返回新提交对象的 SHA-1 </span></span><br><span class="line">git rebase --onto checksum1 checksum2 <span class="comment"># 将 checksum2 后的提交变基到 checksum1 上，checksum1 后产生新的提交记录</span></span><br><span class="line">git replace checksum1 checksum2 <span class="comment"># 将 checksum1 及其前的提交记录替换为 checksum2 及其前的提交记录</span></span><br><span class="line">git cat-file -p &lt;checksum&gt; <span class="comment"># 查看 checksum 提交的提交树 SHA-1 值及其父提交</span></span><br></pre></td></tr></table></figure>
<h3 id="凭证存储"><a href="#凭证存储" class="headerlink" title="凭证存储"></a>凭证存储</h3><p>使用 SSH 连接远端，且设置了一个没有口令的密钥，这样就可以在不用输入用户名和密码的情况下安全连接远端。使用 HTTP 存储，每一个连接都需要输入用户名和密码。git 凭证机制默认不存储用户名和密码，’cache’ 模式内存中暂时存储用户名和密码，’store’ 模式将用户名和密码存储在磁盘中，mac 下 ‘osxkeychain’ 以加密方式将凭证缓存到系统用户的钥匙串，windows 下可借助 ‘winstore’ 工具以加密方式将凭证存储在磁盘中。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git config --global credential.helper cache|store <span class="comment"># 设置凭证存储模式</span></span><br><span class="line">git config --global credential.helper store --file &lt;path&gt; <span class="comment"># 设置存储目录</span></span><br><span class="line">git config --global credential.helper cache --timeout &lt;seconds&gt; <span class="comment"># 设置过期时间</span></span><br><span class="line">git credential fill <span class="comment"># 交互式设置凭证，通过 protocol/协议, host/主机名 设置</span></span><br></pre></td></tr></table></figure>
<h3 id="疑问-3"><a href="#疑问-3" class="headerlink" title="疑问"></a>疑问</h3><ol>
<li>获取某个特定的提交对象后，可否对该提交对象进行操作？</li>
<li>关于签署标签？</li>
<li>关于 git filter-branch？</li>
<li>关于子模块？</li>
</ol>
<h2 id="Customizing-Git"><a href="#Customizing-Git" class="headerlink" title="Customizing Git"></a>Customizing Git</h2><h3 id="自定义合并、比较工具"><a href="#自定义合并、比较工具" class="headerlink" title="自定义合并、比较工具"></a>自定义合并、比较工具</h3><p>借助 Perforce 图形化合并工具（P4Merge）来合并文件和解决冲突。</p>
<ol>
<li>下载 P4Merge。</li>
<li><p>创建一个名为 extMerge 的脚本包装 merge 命令，让它把参数转发给 p4merge 二进制文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /usr/local/bin/extMerge</span></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">/Applications/p4merge.app/Contents/MacOS/p4merge $*</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建一个名为 extDiff 的脚本包装 diff 命令，让它把参数转发给 p4merge 二进制文件。git 传递以下参数给 diff：path old-file old-hex old-mode new-file new-hex new-mode。实际仅需要 old-file 和 new-file 参数。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># cat /usr/local/bin/extDiff</span></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line">[ <span class="variable">$#</span> -eq 7 ] &amp;&amp; /usr/<span class="built_in">local</span>/bin/extMerge <span class="string">"<span class="variable">$2</span>"</span> <span class="string">"<span class="variable">$5</span>"</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使 extMerge, extDiff 脚本拥有可执行权限。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo chmod +x /usr/<span class="built_in">local</span>/bin/extMerge</span><br><span class="line">sudo chmod +x /usr/<span class="built_in">local</span>/bin/extDiff</span><br></pre></td></tr></table></figure>
</li>
<li><p>修改配置文件，自定义合并和比较文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git config --global merge.tool extMerge <span class="comment"># 通知 Git 该使用哪个合并工具</span></span><br><span class="line">git config --global mergetool.extMerge.cmd \</span><br><span class="line">  <span class="string">'extMerge \"$BASE\" \"$LOCAL\" \"$REMOTE\" \"$MERGED\"'</span> <span class="comment"># 规定命令运行的方式</span></span><br><span class="line">git config --global mergetool.extMerge.trustExitCode <span class="literal">false</span> <span class="comment"># 通知 Git 程序的返回值是否表示合并操作成功</span></span><br><span class="line">git config --global diff.external extDiff <span class="comment"># 通知 Git 该用什么命令做比较</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>使用 git diff <checksum1> <checksum2> 命令，将自动唤起 P4Merge 图形化工具。</checksum2></checksum1></p>
</li>
<li>使用 git mergetool 命令，将自动唤起 P4Merge 图形化工具。</li>
</ol>
<h3 id="git-属性"><a href="#git-属性" class="headerlink" title="git 属性"></a>git 属性</h3><p>通过 .gitattributes 文件或 .git/info/attributes 文件设置属性，可用于识别二进制文件、比较二进制文件。</p>
<h4 id="识别二进制文件"><a href="#识别二进制文件" class="headerlink" title="识别二进制文件"></a>识别二进制文件</h4><p>只需配置 .gitattributes 文件。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*.pbxproj binary <span class="comment"># 将 pbxproj 识别为二进制文件，git 将不会对其修改，如 CRLF 问题</span></span><br></pre></td></tr></table></figure></p>
<h4 id="比较-word-文件"><a href="#比较-word-文件" class="headerlink" title="比较 word 文件"></a>比较 word 文件</h4><p>比较二进制 Microsoft Word 文件步骤：</p>
<ol>
<li>下载 docx2txt。</li>
<li><p>编写可执行脚本，即 docx2txt 文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">docx2txt.pl <span class="variable">$1</span> -</span><br></pre></td></tr></table></figure>
</li>
<li><p>编辑配置。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git config diff.word.textconv docx2txt</span><br></pre></td></tr></table></figure>
</li>
<li><p>配置 .gitattributes 文件。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">*.docx diff=word <span class="comment"># 使用 “word” 过滤器，即借助 docx2txt 程序将 Word 文档转为可读文本文件</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h4 id="比较图像文件"><a href="#比较图像文件" class="headerlink" title="比较图像文件"></a>比较图像文件</h4><p>在比较时对图像文件运用一个过滤器(如 exiftool)，提炼出 EXIF 信息——这是在大部分图像格式中都有记录的一种元数据。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'*.png diff=exif'</span> &gt;&gt; .gitattributes</span><br><span class="line">git config diff.exif.textconv exiftool</span><br></pre></td></tr></table></figure>
<h4 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">test</span>/ <span class="built_in">export</span>-ignore <span class="comment"># .gitattributes 文件中设置不必导出的文件或文件夹</span></span><br><span class="line">LAST_COMMIT <span class="built_in">export</span>-subst <span class="comment"># 设置 LAST_COMMIT 文件用于接受提交记录，git commit 提交后，执行 git archive 命令，将提交记录导出到 LAST_COMMIT 文件中。LAST_COMMIT 文件内容如 'Last commit date: $Format:%cd by %aN$'</span></span><br><span class="line">database.xml merge=ours <span class="comment"># 设置合并策略，采用工作目录中的文件</span></span><br></pre></td></tr></table></figure>
<h3 id="git-钩子"><a href="#git-钩子" class="headerlink" title="git 钩子"></a>git 钩子</h3><p>git 钩子放置在 .git/hooks 子目录中。git init 初始化项目时有示例，可以用 Ruby 或 Python 编程。</p>
<h4 id="客户端钩子"><a href="#客户端钩子" class="headerlink" title="客户端钩子"></a>客户端钩子</h4><p>克隆远程仓库时不被复制。</p>
<ol>
<li>pre-commit 钩子在键入提交信息前运行。使用 git commit –no-verify 来绕过这个环节。</li>
<li>prepare-commit-msg 钩子在启动提交信息编辑器之前，默认信息被创建之后运行。</li>
<li>commit-msg 钩子在编辑器退出后运行。</li>
<li>post-commit 钩子在整个提交过程完成后运行。</li>
<li>applypatch-msg 钩子在应用补丁之前运行，git am 命令执行。</li>
<li>pre-applypatch 钩子在应用补丁之后、产生提交之前运行，git am 命令执行。</li>
<li>post-applypatch 钩子在提交产生之后运行，git am 命令执行。</li>
<li>pre-rebase 钩子在变基之前运行。</li>
<li>post-rewrite 钩子被那些会替换提交记录的命令调用，比如 git commit –amend 和 git rebase 命令。</li>
<li>post-checkout 钩子在检出之后运行。</li>
<li>post-merge 钩子在合并之后运行。</li>
<li>pre-push 钩子在推送之前运行。</li>
<li>re-auto-gc 钩子会在垃圾回收开始之前被调用。git 的一些日常操作在运行时，偶尔会调用 git gc –auto 进行垃圾回收。</li>
</ol>
<h4 id="服务器端钩子"><a href="#服务器端钩子" class="headerlink" title="服务器端钩子"></a>服务器端钩子</h4><ol>
<li>pre-receive 钩子在推送过程运行，同时向多个分支推送的情形下也只触发一次。</li>
<li>update 钩子在推送过程运行，同时向多个分支推送的情形下触发多次。</li>
<li>post-receive 钩子在整个过程完结以后运行，可以用来更新其他系统服务或者通知用户。它的用途包括给某个邮件列表发信，通知持续集成（continous integration）的服务器，或者更新问题追踪系统（ticket-tracking system） —— 甚至可以通过分析提交信息来决定某个问题（ticket）是否应该被开启，修改或者关闭。</li>
</ol>
<h3 id="疑问-4"><a href="#疑问-4" class="headerlink" title="疑问"></a>疑问</h3><ol>
<li>文件检出和暂存时设置过滤器，参考<a href="https://git-scm.com/book/zh/v2/自定义-Git-Git-属性" target="_blank" rel="noopener">git 属性</a>？</li>
<li>使用钩子，参考<a href="https://git-scm.com/book/zh/v2/自定义-Git-使用强制策略的一个例子" target="_blank" rel="noopener">使用强制策略的一个例子</a></li>
</ol>
<h2 id="Git-Internals"><a href="#Git-Internals" class="headerlink" title="Git Internals"></a>Git Internals</h2><p>从根本上来讲 git 是一个内容寻址（content-addressable）文件系统，并在此之上提供了一个版本控制系统的用户界面。</p>
<p>.git 目录包含：description 文件仅供 GitWeb 程序使用；config 文件包含项目特有的配置选项；info 目录包含一个全局性排除文件；hooks 目录包含客户端或服务端的钩子脚本；objects 目录存储所有数据内容；refs 目录存储指向数据（分支）的提交对象的指针；HEAD 文件指示目前被检出的分支；index 文件保存暂存区信息。</p>
<h3 id="git-对象"><a href="#git-对象" class="headerlink" title="git 对象"></a>git 对象</h3><p>git 是一个内容寻址文件系统。这意味着，git 的核心部分是一个简单的键值对数据库（key-value data store）。 你可以向该数据库插入任意类型的内容，它会返回一个键值，通过该键值可以在任意时刻再次检索（retrieve）该内容。 通过底层命令 hash-object 可将任意数据保存于 .git 目录，并返回相应的键值。在 git 中，文件内容存储为数据对象/blob object，文件目录存储为树对象/tree object。一个树对象包含了一条或多条树对象记录（tree entry），每条记录含有一个指向数据对象或者子树对象的 SHA-1 指针，以及相应的模式、类型、文件名信息。</p>
<p>通常，Git 根据某一时刻暂存区所表示的状态创建并记录一个对应的树对象。所以创建树对象时，先须把文件写入暂存区，以此获得树对象的校验和。但是，树对象的校验和不便于记忆，即不便于获取该树对象。在 git 中，使用提交对象定位树对象，以及该树对象的创建时间，即通过提交对象的校验和获取或存储树对象。提交对象的格式为，先指定一个顶层树对象，代表当前项目快照；然后是作者/提交者信息（依据 user.name 和 user.email 配置来设定，外加一个时间戳）；留空一行，最后是提交注释。</p>
<p>运行 git add 和 git commit 命令时，git 所做的实质工作——将被改写的文件保存为数据对象，更新暂存区，记录树对象，最后创建一个指明了顶层树对象和父提交的提交对象。数据对象、树对象和提交对象最初均以单独文件的形式保存在 .git/objects 目录下（首先转换为带有如 “blob #{content.length}\0” 等头部信息的内存数据，其次计算校验和，最后再写入 .git/objects 目录下）。</p>
<p>在存储文件对象时，为避免同一文件的不同版本保存多份，git 使用包文件存储，即保存最新版本的完整数据，其他版本保存与最新版本的差异。使用 git gc 命令可执行打包过程；git verify-pack 命令查看打包的内容。自动打包过程发生在 push 命令触发或本地包含太多不同版本的文件，大约需要 7000 个以上的松散对象或超过 50 个的包文件才能让 git 启动一次真正的 gc 命令（可通过修改 gc.auto 与 gc.autopacklimit 的设置来改动这些数值）。打包后，.git/refs 目录将清空，相应创建 .git/packed-refs 目录；更新引用时，再相应创建 .git/refs 目录下文件；查找分支引用先从 .git/refs 目录找起，其次 .git/packed-refs 目录</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">'test content'</span> | git <span class="built_in">hash</span>-object -w --stdin <span class="comment"># 写入数据。-w 选项指示 hash-object 命令存储数据对象；若不指定此选项，则该命令仅返回对应的键值； --stdin 选项则指示该命令从标准输入读取内容；若不指定此选项，则须在命令尾部给出待存储文件的路径。返回40位校验和，以前两位作为目录名，后38位作为文件名，存储在 .git/objects 目录中</span></span><br><span class="line">git <span class="built_in">hash</span>-object -w test.txt <span class="comment"># 写入数据</span></span><br><span class="line">git cat-file -p &lt;checksum&gt; <span class="comment"># 读取数据</span></span><br><span class="line">find .git/objects -<span class="built_in">type</span> f <span class="comment"># 查看 .git/objects 目录下文件列表</span></span><br><span class="line">git cat-file -p &lt;checksum&gt; &gt; &lt;filepath&gt; <span class="comment"># 将 .git/objects 目录下存储的某条数据导出到 filepath 文件中</span></span><br><span class="line">git cat-file -t &lt;checksum&gt; <span class="comment"># 查看 git 存储数据的对象类型，如返回 blob 或 tree</span></span><br><span class="line"></span><br><span class="line">git cat-file -p master^&#123;tree&#125; <span class="comment"># 查看树对象 master^&#123;tree&#125; 下的内容，可能包含 blob 或 tree 对象。master^&#123;tree&#125; 表示 master 分支上最新的提交所指向的树对象</span></span><br><span class="line">git cat-file -p &lt;checksum&gt; <span class="comment"># 查看树对象、提交对象下的内容，将获取最新版本的文件内容</span></span><br><span class="line">git update-index --add --cacheinfo 100644 \</span><br><span class="line">  83baae61804e65cc73a7201a7252750c76066a30 test.txt <span class="comment"># 通过 update-index 命令为 test.txt 文件创建暂存区，选项 --add 将文件存储到暂存区中；选项 --cacheinfo 将文件添加到 git 数据库，而非当前目录中；文件模式 100644 表示为普通文件，100755 为可执行文件，120000 为符号链接</span></span><br><span class="line">git update-index &lt;filepath&gt; <span class="comment"># 更新暂存区中文件</span></span><br><span class="line">git update-index --add &lt;filepath&gt; <span class="comment"># 添加暂存区中文件</span></span><br><span class="line">git write-tree <span class="comment"># 将暂存区内容写入树对象，返回树对象的 SHA-1 值</span></span><br><span class="line">git <span class="built_in">read</span>-tree &lt;checksum&gt; <span class="comment"># 将树对象读入暂存区</span></span><br><span class="line">git <span class="built_in">read</span>-tree --prefix=dirname &lt;checksum&gt; <span class="comment"># 将树对象读入暂存区，--prefix 选项将其作为子树存储在 dirname 目录下</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">'first commit'</span> | git commit-tree &lt;checksum&gt; <span class="comment"># 以树对象 checksum 创建提交对象，返回提交对象的校验和。创建的提交对象可通过 git log 查看</span></span><br></pre></td></tr></table></figure>
<h3 id="git-引用"><a href="#git-引用" class="headerlink" title="git 引用"></a>git 引用</h3><p>git 通过 .git/refs 目录下的文件存储提交对象的引用，以分支形式分类存储，不同分支创建不同的文件，同一文件下包含该分支的提交记录历史。</p>
<p>HEAD 引用通过 .git/HEAD 文件存储，文件内容如 ref: refs/heads/master，指向其他分支引用。</p>
<p>标签对象（tag object）非常类似于一个提交对象——它包含标签创建者信息、日期、注释信息，以及一个指针。 主要的区别在于，标签对象通常指向一个提交对象，而不是一个树对象。它像是一个永不移动的分支引用——永远指向同一个提交对象，分支引用指向的提交对象可以改写。所以标签对象可用于发布。另外要注意的是，标签对象并非必须指向某个提交对象；你可以对任意类型的 Git 对象打标签。标签对象存储在 .git/refs/tags 目录中，以标签名作为文件名。</p>
<p>.git/refs/remotes 目录下保存远程引用。远程引用和分支引用的主要区别在于，远程引用是只读的。虽然可以 git checkout 到某个远程引用，但是 git 并不会将 HEAD 引用指向该远程引用。因此，永远不能通过 commit 命令来更新远程引用，而只能通过 push 命令更新。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">git update-ref refs/heads/master 1a410efbd13591db07496601ebc7a059dd55cfe9 <span class="comment"># 在 master 分支中添加提交对象的校验和，比直接编辑文件更安全</span></span><br><span class="line">git symbolic-ref HEAD <span class="comment"># 查看 .git/HEAD 文件内容</span></span><br><span class="line">git symbolic-ref HEAD refs/heads/<span class="built_in">test</span> <span class="comment"># 修改 HEAD 引用的指向</span></span><br><span class="line">git update-ref refs/tags/v1.0 cac0cab538b970a37ea1e769cbbde608743bc96d <span class="comment"># 创建轻量标签</span></span><br><span class="line">git tag -a v1.1 1a410efbd13591db07496601ebc7a059dd55cfe9 -m <span class="string">'test tag'</span> <span class="comment"># -a 选项用于创建附注标签</span></span><br></pre></td></tr></table></figure>
<h3 id="引用规格"><a href="#引用规格" class="headerlink" title="引用规格"></a>引用规格</h3><p>引用规格/refspec 用于设定 fetch 命令的请求地址和拉取的分支，以小节形式存储在 .git/config 文件中。引用规格的格式由一个可选的 + 号和紧随其后的 <src>:<dst> 组成，其中 <src> 是一个模式（pattern），代表远程版本库中的引用；<dst> 是那些远程引用在本地所对应的位置。 + 号告诉 Git 即使在不能快进的情况下也要（强制）更新引用。</dst></src></dst></src></p>
<p>执行 git remote add origin <a href="https://github.com/schacon/simplegit-progit" target="_blank" rel="noopener">https://github.com/schacon/simplegit-progit</a> 命令，.git/config 文件将添加引用规格如下：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[remote <span class="string">"origin"</span>]</span><br><span class="line">	url = https://github.com/schacon/simplegit-progit</span><br><span class="line">	fetch = +refs/heads/*:refs/remotes/origin/* <span class="comment"># 当修改为 fetch = +refs/heads/master:refs/remotes/origin/master 时，将只抓取远程 master 分支（fetch 可以设置多个，以拉取不同分支的引用）；或者单次执行 git fetch origin master:refs/remotes/origin/mymaster 命令，将远程 master 分支拉到本地的 origin/mymaster 分支</span></span><br><span class="line">  <span class="comment"># push = refs/heads/master:refs/heads/qa/master 用于设置推送，或执行 git push origin master:refs/heads/qa/master 命令</span></span><br></pre></td></tr></table></figure></p>
<p>执行 git push origin :topic 命令可删除远程 topic 分支，因为 src 为空值，即代表删除。</p>
<h3 id="数据恢复"><a href="#数据恢复" class="headerlink" title="数据恢复"></a>数据恢复</h3><p>引用日志/reflog 记录每一次你改变 HEAD 时它的值。每一次提交或改变分支时，引用日志都会被更新。引用日志也可以通过 git update-ref 命令更新。git reflog 命令用于查看引用日志。引用日志存放在 .git/logs/ 目录中。</p>
<p>引用日志可用于找回丢失的提交，如 reset, rebase 命令导致丢失。通过 git branch <branch> <checksum> 命令创建新分支指向丢失的提交。</checksum></branch></p>
<p>当引用日志也同样丢失时，可以使用 git fsck –full 查看没有被引用的提交对象，即丢失的提交对象。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git reflog <span class="comment"># 查看引用日志</span></span><br><span class="line">git <span class="built_in">log</span> -g <span class="comment"># 以标准日志格式查看引用日志</span></span><br><span class="line">git count-objects -v <span class="comment"># 查看内存占用，size-pack 指以 kb 为大小的包文件</span></span><br></pre></td></tr></table></figure>
<h3 id="疑问："><a href="#疑问：" class="headerlink" title="疑问："></a>疑问：</h3><ol>
<li>git 的远程交互机制，参考<a href="https://git-scm.com/book/zh/v2/Git-内部原理-传输协议" target="_blank" rel="noopener">传输协议</a></li>
<li>移除git 数据库中的历史文件，参考<a href="https://git-scm.com/book/zh/v2/Git-内部原理-维护与数据恢复" target="_blank" rel="noopener">维护与数据恢复</a></li>
<li>git 环境变量，参考<a href="https://git-scm.com/book/zh/v2/Git-内部原理-环境变量" target="_blank" rel="noopener">环境变量</a></li>
</ol>
<p>参考：<br><a href="https://git-scm.com/book/zh/v2" target="_blank" rel="noopener">https://git-scm.com/book/zh/v2</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/13/手册/mocha使用指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/13/手册/mocha使用指南/" itemprop="url">mocha使用指南</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-13T18:50:11+08:00">2018-02-13</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端工程化/" itemprop="url" rel="index"><span itemprop="name">前端工程化</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/13/手册/mocha使用指南/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/02/13/手册/mocha使用指南/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>mocha 是一款可运行在 node 环境或浏览器上的测试框架。</p>
<p>mocha 本身没有实现断言库，可使用 chai, should.js, expect.js, better-assert, unexpected 等断言库或 node 内置的 assert 模块。断言库错误输出需有 actual, expected 属性。</p>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><h3 id="BDD"><a href="#BDD" class="headerlink" title="BDD"></a>BDD</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BDD 风格，describe/context, it/specify, before, after, beforeEach, afterEach</span></span><br><span class="line"><span class="keyword">var</span> assert = <span class="built_in">require</span>(<span class="string">'assert'</span>);</span><br><span class="line">describe(<span class="string">'Array'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;<span class="comment">// 测试套件</span></span><br><span class="line">  describe(<span class="string">'#indexOf()'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    it(<span class="string">'should return -1 when the value is not present'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;<span class="comment">// 测试单元</span></span><br><span class="line">      assert.equal([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>].indexOf(<span class="number">4</span>), <span class="number">-1</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="TDD"><a href="#TDD" class="headerlink" title="TDD"></a>TDD</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TDD 风格，suite, test, suiteSetup, suiteTeardown, setup, teardown</span></span><br><span class="line">suite(<span class="string">'Array'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  setup(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  suite(<span class="string">'#indexOf()'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    test(<span class="string">'should return -1 when not present'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      assert.equal(<span class="number">-1</span>, [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>].indexOf(<span class="number">4</span>));</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="EXPORTS"><a href="#EXPORTS" class="headerlink" title="EXPORTS"></a>EXPORTS</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// EXPORTS 风格，before, after, beforeEach, afterEach</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  before: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  <span class="string">'Array'</span>: &#123;<span class="comment">// 对象作为测试套件</span></span><br><span class="line">    <span class="string">'#indexOf()'</span>: &#123;</span><br><span class="line">      <span class="string">'should return -1 when not present'</span>: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;<span class="comment">// 函数为测试单元</span></span><br><span class="line">        [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>].indexOf(<span class="number">4</span>).should.equal(<span class="number">-1</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="QUNIT"><a href="#QUNIT" class="headerlink" title="QUNIT"></a>QUNIT</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// QUNIT 风格，suite, test, before, after, beforeEach, afterEach</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ok</span>(<span class="params">expr, msg</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!expr) <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(msg);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">suite(<span class="string">'Array'</span>);</span><br><span class="line"></span><br><span class="line">test(<span class="string">'#length'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> arr = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line">  ok(arr.length == <span class="number">3</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">test(<span class="string">'#indexOf()'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> arr = [<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>];</span><br><span class="line">  ok(arr.indexOf(<span class="number">1</span>) == <span class="number">0</span>);</span><br><span class="line">  ok(arr.indexOf(<span class="number">2</span>) == <span class="number">1</span>);</span><br><span class="line">  ok(arr.indexOf(<span class="number">3</span>) == <span class="number">2</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">suite(<span class="string">'String'</span>);</span><br><span class="line"></span><br><span class="line">test(<span class="string">'#length'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  ok(<span class="string">'foo'</span>.length == <span class="number">3</span>);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="REQUIRE"><a href="#REQUIRE" class="headerlink" title="REQUIRE"></a>REQUIRE</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// REQUIRE 风格，使用 require 注入</span></span><br><span class="line"><span class="keyword">var</span> testCase = <span class="built_in">require</span>(<span class="string">'mocha'</span>).describe;</span><br><span class="line"><span class="keyword">var</span> pre = <span class="built_in">require</span>(<span class="string">'mocha'</span>).before;</span><br><span class="line"><span class="keyword">var</span> assertions = <span class="built_in">require</span>(<span class="string">'mocha'</span>).it;</span><br><span class="line"><span class="keyword">var</span> assert = <span class="built_in">require</span>(<span class="string">'chai'</span>).assert;</span><br><span class="line"></span><br><span class="line">testCase(<span class="string">'Array'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  pre(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  testCase(<span class="string">'#indexOf()'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    assertions(<span class="string">'should return -1 when not present'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      assert.equal([<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>].indexOf(<span class="number">4</span>), <span class="number">-1</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h2><p>mocha 后跟测试文件名（可使用通配符），或将测试脚本放在 test 目录里，执行 mocha 命令测试 test 目录下的测试脚本（默认只执行第一层）。浏览器端使用 mocha.setup 方法配置 mocha。</p>
<p>选项（可以将命令行参数放在 mocha.opts 文件里，也可以 mocha.opts 文件里指定测试目录）：</p>
<ul>
<li>-u, –ui <name> 测试脚本编码风格，可选值 bdd|tdd|qunit|exports。</name></li>
<li>–recursive 使用 mocha 测试 test 目录下所有文件。</li>
<li>-g, –grep <pattern> 只测试匹配正则的 it 。</pattern></li>
<li>-f, –fgrep <string> 只测试包含字符串的 it。</string></li>
<li>-i, –invert 反转 grep, fgrep 选项。</li>
<li>–bail, -b 有一个测试脚本未通过时，就停止测试。</li>
<li>-d, –debug 启动 debug 模式。</li>
<li>–debug-brk enable node’s debugger breaking on the first line???</li>
<li>-gc, –expose-gc expose gc extension???</li>
<li>–harmony&lt;_classes,_generators,…&gt; all node –harmony* flags are available???</li>
<li>–es_staging 启用所有 staged 特征???</li>
<li>-S, –sort 排序测试文件。</li>
<li>–compilers <ext>:<module>,… 指定测编译器，如 mocha –compilers js:babel-core/register。若需使用 Map、Set 等，须在测试脚本前 import ‘babel-polyfill’。</module></ext></li>
<li>-r, –require <name> 加载特定的模块，如 ‘babel-polyfill’。</name></li>
<li>–file <file> 测试时加载指定文件。</file></li>
<li>–globals <names> 以 ‘,’ 分割形式注入全局变量。</names></li>
<li>-A, –async-only 测试脚本只能使用异步编程，回调或 promise 形式。</li>
<li>-w, –watch 监视文件变动，自动运行测试脚本。</li>
<li>-t, –timeout <ms> 指定测试时的超时时间，默认为 2000 ms。</ms></li>
<li>-s, –slow <ms> 高亮显示超过指定时间的测试报告，默认为 75 ms。</ms></li>
<li>–check-leaks 检测全局变量泄漏。</li>
<li>–growl, -G 将报告显示在桌面。</li>
<li>-R, –reporter <name> 指定报告打印形式，默认是 spec 格式，可选值 tap, dot, nyan, mochawesome 网页报告（须先安装 npm install –dev mochawesome）。</name></li>
<li>-O, –reporter-options &lt;k=v,k2=v2,…&gt;，打印选项。</li>
<li>–reporters 显示所有报告格式。</li>
<li>-c, –colors 显示颜色。</li>
<li>-C, –no-colors 不显示颜色。</li>
<li>–full-trace 显示完整的堆栈信息。</li>
<li>生成规格文件，如 mocha –recursive -R markdown &gt; spec.md 或 mocha –recursive -R doc &gt; spec.html。<br>…</li>
</ul>
<h2 id="特性"><a href="#特性" class="headerlink" title="特性"></a>特性</h2><h3 id="钩子函数"><a href="#钩子函数" class="headerlink" title="钩子函数"></a>钩子函数</h3><ul>
<li>before，在测试用例之前执行</li>
<li>after，在测试用例之后执行</li>
<li>beforeEach，在每个单元测试前执行</li>
<li>afterEach，在每个单元测试后执行</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 钩子允许在 describe 外围，回调将在测试脚本之前或之后执行</span></span><br><span class="line">beforeEach(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'before every test in every file'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'hooks'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 钩子函数以匿名函数使用，允许携带描述；命名函数不能</span></span><br><span class="line">  before(<span class="string">'some description'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// runs before all tests in this block</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 钩子支持同步或异步编程</span></span><br><span class="line">  beforeEach(<span class="function"><span class="keyword">function</span>(<span class="params">done</span>) </span>&#123;</span><br><span class="line">    db.clear(<span class="function"><span class="keyword">function</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (err) <span class="keyword">return</span> done(err);</span><br><span class="line">      db.save([tobi, loki, jane], done);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// test cases</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="异步测试"><a href="#异步测试" class="headerlink" title="异步测试"></a>异步测试</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 回调函数形式</span></span><br><span class="line">describe(<span class="string">'User'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  describe(<span class="string">'#save()'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    it(<span class="string">'should save without error'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">done</span>) </span>&#123;<span class="comment">// done 只能执行一次，两次及以上会报错</span></span><br><span class="line">      <span class="keyword">var</span> user = <span class="keyword">new</span> User(<span class="string">'Luna'</span>);</span><br><span class="line">      user.save(done);<span class="comment">// done 能自动识别并处理 err 错误</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// promise 形式</span></span><br><span class="line">describe(<span class="string">'#find()'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  it(<span class="string">'respond with matching records'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// db.find(&#123; type: 'User' &#125;) 返回 promise</span></span><br><span class="line">    <span class="keyword">return</span> db.find(&#123; <span class="attr">type</span>: <span class="string">'User'</span> &#125;).should.eventually.have.length(<span class="number">3</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// async 函数形式</span></span><br><span class="line">describe(<span class="string">'#find()'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  it(<span class="string">'responds with matching records'</span>, <span class="keyword">async</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> users = <span class="keyword">await</span> db.find(&#123; <span class="attr">type</span>: <span class="string">'User'</span> &#125;);</span><br><span class="line">    users.should.have.length(<span class="number">3</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="延迟执行"><a href="#延迟执行" class="headerlink" title="延迟执行"></a>延迟执行</h3><p>命令行选项 –delay 用于延迟，相应测试脚本使用 setTimeout 包裹。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// do some setup</span></span><br><span class="line"></span><br><span class="line">  describe(<span class="string">'my suite'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  run();</span><br><span class="line">&#125;, <span class="number">5000</span>);</span><br></pre></td></tr></table></figure>
<h3 id="搁置测试"><a href="#搁置测试" class="headerlink" title="搁置测试"></a>搁置测试</h3><p>使测试处于 pending 状态，仍然会打印报告。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">describe(<span class="string">'Array'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  describe(<span class="string">'#indexOf()'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// pending test below</span></span><br><span class="line">    it(<span class="string">'should return -1 when the value is not present'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="限制测试"><a href="#限制测试" class="headerlink" title="限制测试"></a>限制测试</h3><ul>
<li>describe, it 调用 only 方法将只运行指定测试脚本，添加的钩子仍会执行。</li>
<li>describe, it 调用 skip 方法将避免某些脚本的执行。skip 也可以在 mocha 运行过程中调用，或在钩子中调用，两者均使用 this.skip()。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// only 方法限制只执行某些测试脚本</span></span><br><span class="line">describe(<span class="string">'Array'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  describe.only(<span class="string">'#indexOf()'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    it.only(<span class="string">'should return -1 unless present'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// this test will be run</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    it(<span class="string">'should return the index when present'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// this test will not be run</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// skip 方法跳过执行指定测试脚本</span></span><br><span class="line">describe(<span class="string">'Array'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  describe(<span class="string">'#indexOf()'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    it.skip(<span class="string">'should return -1 unless present'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// this test will not be run</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    it(<span class="string">'should return the index when present'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// this test will be run</span></span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// mocha 运行时 skip</span></span><br><span class="line">it(<span class="string">'should only test in the correct environment'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="comment">/* check test environment */</span>) &#123;</span><br><span class="line">    <span class="comment">// make assertions</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.skip();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 钩子 skip</span></span><br><span class="line">before(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="comment">/* check test environment */</span>) &#123;</span><br><span class="line">    <span class="comment">// setup code</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.skip();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="实例方法"><a href="#实例方法" class="headerlink" title="实例方法"></a>实例方法</h3><ul>
<li>retries(num)，指定重复执行测试脚本 num 次，不推荐在单元测试中使用。</li>
<li>slow(time)，高亮显示超过指定时间的测试报告，默认为 75 ms。</li>
<li>timeout(time)，设定超时时间，可在 describe, it 或钩子 中调用。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// retries</span></span><br><span class="line">describe(<span class="string">'retries'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="comment">// Retry all tests in this suite up to 4 times</span></span><br><span class="line">  <span class="keyword">this</span>.retries(<span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">  beforeEach(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    browser.get(<span class="string">'http://www.yahoo.com'</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'should succeed on the 3rd try'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// Specify this test to only retry up to 2 times</span></span><br><span class="line">    <span class="keyword">this</span>.retries(<span class="number">2</span>);</span><br><span class="line">    expect($(<span class="string">'.foo'</span>).isDisplayed()).to.eventually.be.true;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// slow</span></span><br><span class="line">describe(<span class="string">'something slow'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.slow(<span class="number">10000</span>);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'should take long enough for me to go make a sandwich'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// timeout</span></span><br><span class="line">describe(<span class="string">'a suite of tests'</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.timeout(<span class="number">500</span>);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'should take less than 500ms'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">done</span>)</span>&#123;</span><br><span class="line">    setTimeout(done, <span class="number">300</span>);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it(<span class="string">'should take less than 500ms as well'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">done</span>)</span>&#123;</span><br><span class="line">    setTimeout(done, <span class="number">250</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/12/手册/chai使用指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/12/手册/chai使用指南/" itemprop="url">chai使用指南</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-12T19:12:35+08:00">2018-02-12</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端工程化/" itemprop="url" rel="index"><span itemprop="name">前端工程化</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/12/手册/chai使用指南/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/02/12/手册/chai使用指南/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>chai 是一款辅助 TDD 测试驱动开发, BDD 行为驱动开发 的断言库。</p>
<p>有关 TDD 和 BDD，可参考：<br><a href="https://www.cnblogs.com/Leo_wl/p/4780678.html" target="_blank" rel="noopener">开发人员看测试之TDD和BDD</a><br><a href="http://blog.jobbole.com/110560/" target="_blank" rel="noopener">TDD 已死？让我们再聊聊 TDD</a><br><a href="http://blog.csdn.net/dc_726/article/details/49688379" target="_blank" rel="noopener">BDD敏捷开发入门与实战</a></p>
<p>chai 的 TDD 模块只包含 assert 一种， BDD 模块包含 except, should 两种。</p>
<h3 id="配置"><a href="#配置" class="headerlink" title="配置"></a>配置</h3><ul>
<li>chai.config.includeStack = false，错误输出中是否包含堆栈信息</li>
<li>chai.config.showDiff = true，是否显示 diff</li>
<li>chai.config.truncateThreshold = 40，错误输出中 actual, expexted 打印字符串上限???</li>
</ul>
<h2 id="api手册"><a href="#api手册" class="headerlink" title="api手册"></a>api手册</h2><h3 id="TDD测试"><a href="#TDD测试" class="headerlink" title="TDD测试"></a>TDD测试</h3><h4 id="assert"><a href="#assert" class="headerlink" title="assert"></a>assert</h4><p>类似 node 的同名模块。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> assert = <span class="built_in">require</span>(<span class="string">'chai'</span>).assert</span><br><span class="line">  , foo = <span class="string">'bar'</span></span><br><span class="line">  , beverages = &#123; <span class="attr">tea</span>: [ <span class="string">'chai'</span>, <span class="string">'matcha'</span>, <span class="string">'oolong'</span> ] &#125;;</span><br><span class="line"></span><br><span class="line">assert.typeOf(foo, <span class="string">'string'</span>); <span class="comment">// without optional message</span></span><br><span class="line">assert.typeOf(foo, <span class="string">'string'</span>, <span class="string">'foo is a string'</span>);</span><br><span class="line">assert.equal(foo, <span class="string">'bar'</span>, <span class="string">'foo equal `bar`'</span>);</span><br><span class="line">assert.lengthOf(foo, <span class="number">3</span>, <span class="string">'foo`s value has a length of 3'</span>);</span><br><span class="line">assert.lengthOf(beverages.tea, <span class="number">3</span>, <span class="string">'beverages has 3 types of tea'</span>);</span><br></pre></td></tr></table></figure>
<h4 id="apis"><a href="#apis" class="headerlink" title="apis"></a>apis</h4><ul>
<li>assert(expression, message)，参数 expression 为待测试的语句</li>
<li>.fail(actual, expected, [message], [operator])，operator 为操作（默认为 !=）</li>
<li>.ifError(object)，校验真值时抛出错误</li>
<li>.isOk/isNotOk/isTrue/isNotTrue/isFalse/isNotFalse/isNull/isNotNull/isNaN/isNotNaN/<br>isUndefined/isDefined/isFunction/isNotFunction/isObject/isNotObject/isArray/isNotArray/<br>isString/isNotString/isNumber/isNotNumber/isFinite/isBoolean/isNotBoolean(object, [message])</li>
<li>.exists/notExists(value, [message])，校验 value 不是 null 或 undefined</li>
<li>.typeOf/notTypeOf(value, type, [message]) 类型校验</li>
<li>.instanceOf/notInstanceOf(object, constructor, [message])</li>
<li>.match/notMatch(value, regexp, [message])</li>
<li>.equal/notEqual/strictEqual/notStrictEqual/deepEqual/notDeepEqual(actual, expected, [message])，’==’, ‘===’ 或 深度相等</li>
<li>.isAbove/isAtLeast/isBelow/isAtMost(valueToCheck, valueToBeAbove, [message])，以操作符 ‘&gt;’, ‘&gt;=’, ‘&lt;’, ‘&lt;=’ 校验</li>
<li>.operator(val1, operator, val2, [message])，’&gt;’, ‘&lt;’ 操作符校验</li>
<li>.closeTo(actual, expected, delta, [message])，actual 在 expected - delta, expected + delta 之间</li>
<li>.approximately(actual, expected, delta, [message])，同上</li>
<li>.changes/doesNotChange/increases/doesNotIncrease/decreases/<br>doesNotDecrease(function, object, property, [message])，校验函数执行时是否改变对象属性</li>
<li>.changesBy/changesButNotBy/ncreasesBy/increasesButNotBy/decreasesBy/<br>doesNotDecreaseBy/decreasesButNotBy(function, object, property, delta, [message])，校验属性数值改变 + delta</li>
<li>.lengthOf(object, length, [message])，校验字符串或数组的长度</li>
<li>.isExtensible/isNotExtensible/isSealed/isNotSealed/isFrozen/isNotFrozen(object)</li>
<li>.isEmpty/isNotEmpty(target)，校验对象、数组、字符串、Map、Set非空</li>
<li>.oneOf(inList, list, [message])</li>
<li>.include/notInclude/deepInclude/notDeepInclude/nestedInclude/notNestedInclude/<br>deepNestedInclude/notDeepNestedInclude/ownInclude/notOwnInclude/<br>deepOwnInclude/notDeepOwnInclude(haystack, needle, [message])，校验是否包含数组项，子字符串，或者对象属性的截取。deep 为深度匹配，nest 以分隔符 . 或者 [] 校验嵌套属性，own 校验是否自有属性</li>
<li>sameMembers/notSameMembers/sameDeepMembers/notSameDeepMembers/<br>sameOrderedMembers/notSameOrderedMembers/<br>sameDeepOrderedMembers/notSameDeepOrderedMembers(set1, set2, [message])，校验 set 是否有相同的成员。orderd 顺序相同</li>
<li>.includeMembers/notIncludeMembers/includeDeepMembers/notIncludeDeepMembers/<br>includeOrderedMembers/notIncludeOrderedMembers/<br>includeDeepOrderedMembers/notIncludeDeepOrderedMembers(superset, subset, [message])</li>
<li>.property/notProperty/nestedProperty/notNestedProperty(object, property, [message])</li>
<li>.propertyVal/notPropertyVal/deepPropertyVal/notDeepPropertyVal/<br>notNestedProperty/notNestedPropertyVal/<br>deepNestedPropertyVal/notDeepNestedPropertyVal(object, property, value, [message])</li>
<li>.hasAnyKeys/hasAllKeys/containsAllKeys/doesNotHaveAnyKeys/<br>doesNotHaveAllKeys/hasAnyDeepKeys/hasAllDeepKeys/<br>containsAllDeepKeys/doesNotHaveAnyDeepKeys/doesNotHaveAllDeepKeys(object, [keys], [message])</li>
<li>.throws/doesNotThrow(fn, [errorLike/string/regexp], [string/regexp], [message])，校验函数 fn 将抛出指定类型及文案的错误</li>
</ul>
<h3 id="TDD测试-except-should"><a href="#TDD测试-except-should" class="headerlink" title="TDD测试 - except, should"></a>TDD测试 - except, should</h3><h4 id="except"><a href="#except" class="headerlink" title="except"></a>except</h4><p>提供链式调用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> expect = <span class="built_in">require</span>(<span class="string">'chai'</span>).expect</span><br><span class="line">  , foo = <span class="string">'bar'</span></span><br><span class="line">  , beverages = &#123; <span class="attr">tea</span>: [ <span class="string">'chai'</span>, <span class="string">'matcha'</span>, <span class="string">'oolong'</span> ] &#125;;</span><br><span class="line"></span><br><span class="line">expect(foo).to.be.a(<span class="string">'string'</span>);</span><br><span class="line">expect(foo).to.equal(<span class="string">'bar'</span>);</span><br><span class="line">expect(foo).to.have.lengthOf(<span class="number">3</span>);</span><br><span class="line">expect(beverages).to.have.property(<span class="string">'tea'</span>).with.lengthOf(<span class="number">3</span>);</span><br></pre></td></tr></table></figure>
<h4 id="should"><a href="#should" class="headerlink" title="should"></a>should</h4><p>增强了 Object.property 功能，因此需先显示调用 chai.should 函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> should = <span class="built_in">require</span>(<span class="string">'chai'</span>).should() <span class="comment">//actually call the function</span></span><br><span class="line">  , foo = <span class="string">'bar'</span></span><br><span class="line">  , beverages = &#123; <span class="attr">tea</span>: [ <span class="string">'chai'</span>, <span class="string">'matcha'</span>, <span class="string">'oolong'</span> ] &#125;;</span><br><span class="line"></span><br><span class="line">foo.should.be.a(<span class="string">'string'</span>);</span><br><span class="line">foo.should.equal(<span class="string">'bar'</span>);</span><br><span class="line">foo.should.have.lengthOf(<span class="number">3</span>);</span><br><span class="line">beverages.should.have.property(<span class="string">'tea'</span>).with.lengthOf(<span class="number">3</span>);</span><br></pre></td></tr></table></figure>
<h4 id="语言链修饰符"><a href="#语言链修饰符" class="headerlink" title="语言链修饰符"></a>语言链修饰符</h4><p>语言链修饰符用于增强代码的可读性，包含 to, be, been, isthat, and, has, have, with, at, of, same</p>
<h4 id="apis-1"><a href="#apis-1" class="headerlink" title="apis"></a>apis</h4><ul>
<li>not 将断言置否，即否值满足断言，如 expect(function () {}).to.not.throw();</li>
<li>deep 深比较，如 expect({a: 1}).to.deep.equal({a: 1});</li>
<li>nested 嵌套属性，以 . 或 [] 分割，如 expect({a: {b: [‘x’, ‘y’]}}).to.have.nested.property(‘a.b[1]’);</li>
<li>own 如 expect({a: 1}).to.have.own.property(‘a’);</li>
<li>ordered 顺序比较，如 expect([1, 2]).to.have.ordered.members([1, 2]).but.not.have.ordered.members([2, 1]);</li>
<li>any/all 如 expect({a: 1, b: 2}).to.not.have.any.keys(‘c’, ‘d’);</li>
<li>.a/an(type[, msg]) 如 expect({a: 1}).to.be.an(‘object’);</li>
<li>.include(val[, msg]) 如 expect(‘foobar’).to.include(‘foo’);</li>
<li>.ok/true/false/null/undefined/NaN/exist/empty/arguments/finite 如 expect(arguments).to.be.arguments;</li>
<li>.eql(obj[, msg]) 如 expect({a: 1}).to.eql({a: 1}).but.not.equal({a: 1});</li>
<li>.above/least/below/most(n[, msg]) 如 expect(1).to.be.at.least(2);</li>
<li>.within(start, finish[, msg]) 如 expect(2).to.be.within(1, 3);</li>
<li>.instanceof(constructor[, msg]) 如 expect({a: 1}).to.not.be.an.instanceof(Array);</li>
<li>.property(name[, val[, msg]]) 如 expect({x: {a: 1}}).to.have.deep.property(‘x’, {a: 1});</li>
<li>.ownPropertyDescriptor(name[, descriptor[, msg]]) 如 expect({a: 1}).to.have.ownPropertyDescriptor(‘a’);</li>
<li>.lengthOf(n[, msg]) 如 expect([1, 2, 3]).to.have.lengthOf(3);</li>
<li>.match(re[, msg]) 如 expect(‘foobar’).to.match(/^foo/);</li>
<li>.string(str[, msg]) 包含子字符串，如 expect(‘foobar’).to.not.have.string(‘taco’);</li>
<li>.keys(key1[, key2[, …]]) 如 expect({a: 1, b: 2}).to.have.all.keys(‘a’, ‘b’);</li>
<li>.throw([errorLike], [errMsgMatcher], [msg]) 校验函数必须抛出错误，如 expect(badFn).to.throw();</li>
<li>.respondTo(method[, msg]) 校验对象是否有某方法，可以是继承的，如 expect(new Cat()).to.respondTo(‘meow’);</li>
<li>.itself 自有属性，如 expect(Cat).itself.to.respondTo(‘hiss’).but.not.respondTo(‘meow’);</li>
<li>.satisfy(matcher[, msg]) 校验是否匹配 matcher，如 expect(1).to.satisfy(function(num) { return num &gt; 0; });</li>
<li>.closeTo(expected, delta[, msg]) 校验值在 expected - delta ~ expected + delta 范围内，如 expect(1.5).to.be.closeTo(1, 0.5);</li>
<li>.members(set[, msg]) 如 expect([1, 2, 3]).to.have.members([2, 1, 3]);</li>
<li>.oneOf(list[, msg]) 如 expect(1).to.be.oneOf([1, 2, 3]);</li>
<li>.change(subject[, prop[, msg]]) 执行函数后，引起对象或其属性改变，如 expect(addDot).to.change(myObj, ‘dots’);</li>
<li>.increase(subject[, prop[, msg]]) 值增加</li>
<li>.decrease(subject[, prop[, msg]]) 值减少</li>
<li>.by(delta[, msg]) 如 expect(addTwo).to.increase(myObj, ‘val’).by(2);</li>
<li>.extensible/sealed/frozen 对象可扩展性</li>
<li>.fail(actual, expected, [message], [operator])，operator 为操作（默认为 !=）</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/11/手册/Enzyme使用指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/11/手册/Enzyme使用指南/" itemprop="url">Enzyme使用指南</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-11T00:00:00+08:00">2018-02-11</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端工程化/" itemprop="url" rel="index"><span itemprop="name">前端工程化</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/11/手册/Enzyme使用指南/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/02/11/手册/Enzyme使用指南/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>Enzyme 是一款 react 组件测试工具。</p>
<p>Enzyme 基于 <a href="https://github.com/cheeriojs/cheerio" target="_blank" rel="noopener">cheerio</a> 实现虚拟 dom 的查找和遍历；而 cheerio 号称为服务器端的 jquery 实现。</p>
<p>Enzyme 本身不实现测试和断言库，你可以选择使用 Mocha/chai, Jasmine, Jest 等测试或断言库。</p>
<h2 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h2><ol>
<li>安装 npm i –save-dev enzyme。</li>
<li>针对项目中使用的 react 版本，安装 enzyme-adapter-react-16, enzyme-adapter-react-15（15.5.0 版本起）, enzyme-adapter-react-15.4（15.0.0 ~ 15.4.x）, enzyme-adapter-react-14, enzyme-adapter-react-13 适配器。</li>
<li><p>配置 enzyme 以使用适配器。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> Enzyme <span class="keyword">from</span> <span class="string">'enzyme'</span>;</span><br><span class="line"><span class="keyword">import</span> Adapter <span class="keyword">from</span> <span class="string">'enzyme-adapter-react-16'</span>;</span><br><span class="line"></span><br><span class="line">Enzyme.configure(&#123; <span class="attr">adapter</span>: <span class="keyword">new</span> Adapter() &#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写测试用例。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; expect &#125; <span class="keyword">from</span> <span class="string">'chai'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; shallow &#125; <span class="keyword">from</span> <span class="string">'enzyme'</span>;</span><br><span class="line"><span class="keyword">import</span> sinon <span class="keyword">from</span> <span class="string">'sinon'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> MyComponent <span class="keyword">from</span> <span class="string">'./MyComponent'</span>;</span><br><span class="line"><span class="keyword">import</span> Foo <span class="keyword">from</span> <span class="string">'./Foo'</span>;</span><br><span class="line"></span><br><span class="line">describe(<span class="string">'&lt;MyComponent /&gt;'</span>, () =&gt; &#123;</span><br><span class="line">  it(<span class="string">'renders three &lt;Foo /&gt; components'</span>, () =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> wrapper = shallow(<span class="xml"><span class="tag">&lt;<span class="name">MyComponent</span> /&gt;</span>);</span></span><br><span class="line"><span class="xml">    expect(wrapper.find(Foo)).to.have.length(3);</span></span><br><span class="line"><span class="xml">  &#125;);</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  it('renders an `.icon-star`', () =&gt; &#123;</span></span><br><span class="line"><span class="xml">    const wrapper = shallow(<span class="tag">&lt;<span class="name">MyComponent</span> /&gt;</span>);</span></span><br><span class="line"><span class="xml">    expect(wrapper.find('.icon-star')).to.have.length(1);</span></span><br><span class="line"><span class="xml">  &#125;);</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  it('renders children when passed in', () =&gt; &#123;</span></span><br><span class="line"><span class="xml">    const wrapper = shallow((</span></span><br><span class="line">      &lt;MyComponent&gt;</span><br><span class="line">        &lt;div className="unique" /&gt;</span><br><span class="line">      &lt;/MyComponent&gt;</span><br><span class="line">    ));</span><br><span class="line">    expect(wrapper.contains(&lt;div className="unique" /&gt;)).to.equal(true);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  it('simulates click events', () =&gt; &#123;</span><br><span class="line">    const onButtonClick = sinon.spy();</span><br><span class="line">    const wrapper = shallow(&lt;Foo onButtonClick=&#123;onButtonClick&#125; /&gt;);</span><br><span class="line">    wrapper.find('button').simulate('click');</span><br><span class="line">    expect(onButtonClick).to.have.property('callCount', 1);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="api-手册"><a href="#api-手册" class="headerlink" title="api 手册"></a>api 手册</h2><h3 id="渲染模式"><a href="#渲染模式" class="headerlink" title="渲染模式"></a>渲染模式</h3><ol>
<li>浅渲染：shallow(node[, options]) =&gt; ShallowWrapper。参数 node 为 ReactElement，options.context 传入组件的context，options.disableLifecycleMethods 生命周期方法是否有效。</li>
<li>完整渲染：mount(node[, options]) =&gt; ReactWrapper。options.context 传入组件的context，options.attachTo 生命周期方法是否有效。需要完整的 dom api，所以需要安装 <a href="https://github.com/jsdom/jsdom" target="_blank" rel="noopener">jsdom</a> 库。</li>
<li>静态渲染：render(node[, options]) =&gt; CheerioWrapper，渲染为 html，通过 cheerio 解析 html。</li>
</ol>
<h3 id="wrapper-api"><a href="#wrapper-api" class="headerlink" title="wrapper api"></a>wrapper api</h3><ol>
<li>.find(selector) =&gt; Wrapper</li>
<li>.findWhere(predicate) =&gt; Wrapper</li>
<li>.filter(selector) =&gt; Wrapper</li>
<li>.filterWhere(predicate) =&gt; Wrapper</li>
<li>.hostNodes() =&gt; Wrapper，事先存在于文档中 host 节点</li>
<li>.contains(nodeOrNodes) =&gt; Boolean</li>
<li>.containsMatchingElement(node) =&gt; Boolean</li>
<li>.containsAllMatchingElements(nodes) =&gt; Boolean</li>
<li>.containsAnyMatchingElements(nodes) =&gt; Boolean</li>
<li>.equals(node) =&gt; Boolean</li>
<li>.matchesElement(node) =&gt; Boolean</li>
<li>.hasClass(className) =&gt; Boolean</li>
<li>.is(selector) =&gt; Boolean</li>
<li>.exists() =&gt; Boolean</li>
<li>.isEmpty() =&gt; Boolean</li>
<li>.isEmptyRender() =&gt; Boolean</li>
<li>.not(selector) =&gt; Wrapper</li>
<li>.children() =&gt; Wrapper</li>
<li>.childAt(index) =&gt; Wrapper</li>
<li>.parents() =&gt; Wrapper</li>
<li>.parent() =&gt; Wrapper</li>
<li>.closest(selector) =&gt; Wrapper</li>
<li>.shallow([options]) =&gt; Wrapper，ShallowWrapper 独有</li>
<li>.render() =&gt; CheerioWrapper</li>
<li>.unmount() =&gt; Wrapper。ReactWrapper 独有 .mount() =&gt; Wrapper 方法</li>
<li>.text() =&gt; String</li>
<li>.html() =&gt; String</li>
<li>.get(index) =&gt; ReactElement</li>
<li>.getElement() =&gt; ReactElement。ReactWrapper 中为 .getNode() =&gt; ReactElement 方法</li>
<li>.getElements() =&gt; Array<reactelement>。ReactWrapper 中为 .getNodes() =&gt; Array<reactelement> 方法。ReactWrapper 独有 .getDOMNode() =&gt; DOMComponent 方法。</reactelement></reactelement></li>
<li>.at(index) =&gt; Wrapper</li>
<li>.first() =&gt; Wrapper</li>
<li>.last() =&gt; Wrapper</li>
<li>.state([key]) =&gt; Any</li>
<li>.context([key]) =&gt; Any</li>
<li>.props() =&gt; Object</li>
<li>.prop(key) =&gt; Any</li>
<li>.key() =&gt; String</li>
<li>.simulate(event[, data]) =&gt; Wrapper，模拟点击事件等</li>
<li>.setState(nextState) =&gt; Wrapper</li>
<li>.setProps(nextProps) =&gt; Wrapper</li>
<li>.setContext(context) =&gt; Wrapper</li>
<li>.instance() =&gt; ReactComponent</li>
<li>.update() =&gt; Wrapper，调用 forceUpdate 方法强制更新组件实例。调用实例方法后，需要调用 .update 强制刷新 props。</li>
<li>.debug() =&gt; String，.children 返回已渲染的节点，.children().debug() 返回渲染实际配置格式</li>
<li>.type() =&gt; String|Function|null</li>
<li>.name() =&gt; String</li>
<li>.forEach(fn) =&gt; Wrapper</li>
<li>.map(fn) =&gt; Array</li>
<li>.reduce(fn[, initialValue]) =&gt; Any</li>
<li>.reduceRight(fn[, initialValue]) =&gt; Any</li>
<li>.slice([begin[, end]]) =&gt; Wrapper</li>
<li>.tap(intercepter) =&gt; Self</li>
<li>.some(selector) =&gt; Boolean</li>
<li>.someWhere(predicate) =&gt; Boolean</li>
<li>.every(selector) =&gt; Boolean</li>
<li>.everyWhere(predicate) =&gt; Boolean</li>
<li>.dive([options]) =&gt; Wrapper，ShallowWrapper 独有</li>
<li>.ref(refName) =&gt; Wrapper，ReactWrapper 独有</li>
<li>.detach() =&gt; void，ReactWrapper 独有</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/10/手册/storybook使用指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/10/手册/storybook使用指南/" itemprop="url">storybook使用指南</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-10T20:44:57+08:00">2018-02-10</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端工程化/" itemprop="url" rel="index"><span itemprop="name">前端工程化</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/10/手册/storybook使用指南/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/02/10/手册/storybook使用指南/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>storybook 在应用之外，为 UI 组件提供了独立的开发、调试环境。react-transition-group 类库的测试工作即通过 storybook 实现。</p>
<p>storybook 支持调试 react, vue, angular, react-native 组件。<a href="https://storybook.js.org/" target="_blank" rel="noopener">storybook官网</a></p>
<h2 id="操作指南"><a href="#操作指南" class="headerlink" title="操作指南"></a>操作指南</h2><ol>
<li>全局安装 @storybook/cli</li>
<li>项目目录安装依赖：react 项目为 @storybook/react，vue 项目为 @storybook/vue，angular 项目为 @storybook/angular。同时需要安装 babel-core。</li>
<li><p>package.json 添加</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">// -h 选项 指定以 127.0.0.1 作为主机</span><br><span class="line">// -p 选项 指定以 9001 作为端口号</span><br><span class="line">// -s 选项 指定 public 作为为静态文件目录</span><br><span class="line">// -c 选项 指定以 .storybook 作为配置目录</span><br><span class="line">// -o 选项 指定以 .out 作为打包文件目录</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"scripts"</span>: &#123;</span><br><span class="line">    <span class="attr">"storybook"</span>: <span class="string">"start-storybook -h 127.0.0.1 -p 9001 -s ./public -c .storybook"</span>,</span><br><span class="line">    <span class="attr">"build:storybook"</span>: <span class="string">"build-storybook -s ./public -c .storybook -o .out"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>创建配置文件</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// .storybook/config.js</span></span><br><span class="line"><span class="keyword">import</span> &#123; configure &#125; <span class="keyword">from</span> <span class="string">'@storybook/react'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">loadStories</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">require</span>(<span class="string">'../stories/index.js'</span>);</span><br><span class="line">  <span class="comment">// You can require as many stories as you need.</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">configure(loadStories, <span class="built_in">module</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写 story。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// stories/index.js</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; storiesOf &#125; <span class="keyword">from</span> <span class="string">'@storybook/react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; action &#125; <span class="keyword">from</span> <span class="string">'@storybook/addon-actions'</span>;</span><br><span class="line"><span class="keyword">import</span> Button <span class="keyword">from</span> <span class="string">'../components/Button'</span>;<span class="comment">// 来自于工程目录</span></span><br><span class="line"></span><br><span class="line">storiesOf(<span class="string">'Button'</span>, <span class="built_in">module</span>)</span><br><span class="line">  .add(<span class="string">'with text'</span>, () =&gt; (</span><br><span class="line">    &lt;Button onClick=&#123;action(<span class="string">'clicked'</span>)&#125;&gt;Hello Button&lt;<span class="regexp">/Button&gt;</span></span><br><span class="line"><span class="regexp">  ))</span></span><br><span class="line"><span class="regexp">  .add('with some emoji', () =&gt; (</span></span><br><span class="line"><span class="regexp">    &lt;Button onClick=&#123;action('clicked')&#125;&gt;😀 😎 👍 💯&lt;/</span>Button&gt;</span><br><span class="line">  ));</span><br></pre></td></tr></table></figure>
</li>
<li><p>npm run storybook，将在 9001 端口启动服务，Button 按钮下有 with text, with some emoji 两个 story。</p>
</li>
<li>npm run build:storybook，打包输出静态文件。通过 storybook-deployer 工具可以将静态文件发布到 github 上，或者通过 build-storybook 命令将文件打包到 docs 目录中，作为 github pages 的根目录。</li>
</ol>
<h3 id="贴示"><a href="#贴示" class="headerlink" title="贴示"></a>贴示</h3><ol>
<li><p>storybook 内部集成 webpack，通过 babel 编译 js，.babelrc 文件可替代 storybook 的默认配置；支持 css, json, 图片等静态文件的加载。<br>自定义 webpack 配置通过在 .storybook 目录中添加 webpack.config.js 实现，如</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 除了 babel-loader 外，默认配置中的其余加载器全部停用</span></span><br><span class="line"><span class="comment">// 这种配置方式不能用于配置 babel-loader（第一个加载器）, entry, output</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.scss$/</span>,</span><br><span class="line">        loaders: [<span class="string">"style-loader"</span>, <span class="string">"css-loader"</span>, <span class="string">"sass-loader"</span>],</span><br><span class="line">        include: path.resolve(__dirname, <span class="string">'../'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line"><span class="comment">// 这种配置方式不能用于替换 babel-loader（第一个加载器）, entry, output，所有已存在的插件</span></span><br><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">storybookBaseConfig, configType, defaultConfig</span>) =&gt;</span> &#123;</span><br><span class="line">  storybookBaseConfig.module.rules.push(&#123;</span><br><span class="line">    test: <span class="regexp">/\.scss$/</span>,</span><br><span class="line">    loaders: [<span class="string">"style-loader"</span>, <span class="string">"css-loader"</span>, <span class="string">"sass-loader"</span>],</span><br><span class="line">    include: path.resolve(__dirname, <span class="string">'../'</span>)</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> storybookBaseConfig;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
</li>
<li><p>html，head 头部添加标签。</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">// .storybook/preview-head.html 配置文件将如下标签注入到渲染导入组件的 iframe 中，不影响 storybook 主界面</span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://use.typekit.net/xxxyyy.js"</span>&gt;</span><span class="undefined"></span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span>&gt;</span><span class="javascript"><span class="keyword">try</span>&#123; Typekit.load(); &#125; <span class="keyword">catch</span>(e)&#123; &#125;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"></span><br><span class="line">// .storybook/preview-head.html 配置文件，将影响 storybook 主界面</span><br></pre></td></tr></table></figure>
</li>
<li><p>通过访问 <a href="http://localhost:9009/iframe.html?selectedKind=Button&amp;selectedStory=with+text&amp;dataId=0" target="_blank" rel="noopener">http://localhost:9009/iframe.html?selectedKind=Button&amp;selectedStory=with+text&amp;dataId=0</a> 可以访问 Button 下的 with text 这个 story，浏览器显示将不带左边栏。</p>
</li>
</ol>
<h2 id="辅助测试"><a href="#辅助测试" class="headerlink" title="辅助测试"></a>辅助测试</h2><h3 id="Structural-Testing"><a href="#Structural-Testing" class="headerlink" title="Structural Testing"></a>Structural Testing</h3><p>Structural Testing 结构测试的目的是判断页面元素是否异常，缺失或增加等。</p>
<p>在 storybook 中，借助 <a href="https://facebook.github.io/jest/blog/2016/07/27/jest-14.html" target="_blank" rel="noopener">Jest’s snapshot testing</a> 实现结构测试。针对 react，Jest 将为虚拟 DOM 拍摄快照，将其转化为 json 数据，在下一次运行时比对两张快照是否有偏差。</p>
<p>具体步骤为：</p>
<ol>
<li>安装 @storybook/addon-storyshots 插件。</li>
<li><p>编写 storyshots.test.js 文件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> initStoryshots <span class="keyword">from</span> <span class="string">'@storybook/addon-storyshots'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// getStorybook() 函数获取所有 story</span></span><br><span class="line">initStoryshots(&#123; <span class="comment">/* configuration options */</span> &#125;);</span><br></pre></td></tr></table></figure>
</li>
<li><p>执行 storyshots.test.js 脚本，可用于测试组件逻辑是否崩盘。</p>
</li>
</ol>
<p>参考文档：<a href="http://onetwo.ren/ReactStorybook%E7%9A%84%E5%90%84%E7%A7%8D%E6%95%85%E4%BA%8B/" target="_blank" rel="noopener">ReactStorybook 的各种故事</a></p>
<h3 id="interaction-testing"><a href="#interaction-testing" class="headerlink" title="interaction testing"></a>interaction testing</h3><p>关于 interaction testing 交互测试，可以通过模拟用户输入，在 <a href="https://github.com/airbnb/enzyme" target="_blank" rel="noopener">Enzyme</a> 测试框架 Jest, Mocha 实现。</p>
<p>在 storybook 中，交互测试可通过 <a href="https://github.com/mthuret/storybook-addon-specifications" target="_blank" rel="noopener">storybook-addon-specifications</a> 插件实现。</p>
<p>具体步骤为：</p>
<ol>
<li>安装 storybook-addon-specifications 插件。</li>
<li><p>编写 .storybook/addons.js 配置文件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'storybook-addon-specifications/register'</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>添加测试文件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; storiesOf &#125; <span class="keyword">from</span> <span class="string">'@kadira/storybook'</span></span><br><span class="line"><span class="keyword">import</span> &#123; specs, describe, it &#125; <span class="keyword">from</span> <span class="string">'storybook-addon-specifications'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> &#123;mount&#125; <span class="keyword">from</span> <span class="string">"enzyme"</span>;</span><br><span class="line"><span class="keyword">import</span> expect <span class="keyword">from</span> <span class="string">"expect"</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> stories = storiesOf(<span class="string">'Button'</span>, <span class="built_in">module</span>);</span><br><span class="line"></span><br><span class="line">stories.add(<span class="string">'Hello World'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> story =</span><br><span class="line">    &lt;button onClick=&#123;action(<span class="string">'Hello World'</span>)&#125;&gt;</span><br><span class="line">      Hello World</span><br><span class="line">    &lt;<span class="regexp">/button&gt;;</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  /</span><span class="regexp">/ describe 首参必须与 story 名字相同</span></span><br><span class="line"><span class="regexp">  specs(() =&gt; describe('Hello World', function () &#123;</span></span><br><span class="line"><span class="regexp">    it('Should have the Hello World label', function () &#123;</span></span><br><span class="line"><span class="regexp">      let output = mount(story);</span></span><br><span class="line"><span class="regexp">      expect(output.text()).toContain('Hello World');</span></span><br><span class="line"><span class="regexp">    &#125;);</span></span><br><span class="line"><span class="regexp">  &#125;));</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">  return story;</span></span><br><span class="line"><span class="regexp">&#125;);</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h2 id="插件"><a href="#插件" class="headerlink" title="插件"></a>插件</h2><h3 id="使用插件"><a href="#使用插件" class="headerlink" title="使用插件"></a>使用插件</h3><p>在 storybook 中，插件分为两类，装饰器 Decorator（通过封装 react 组件实现，如 storybook-router） 或 以面板形式注入的 Native Addon（如 addon-actions）。</p>
<ol>
<li><p>添加 .storybook/addons.js 配置文件用于向页面添加右下方插件面板。如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> <span class="string">'@storybook/addon-actions/register'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'@storybook/addon-links/register'</span>;</span><br><span class="line"><span class="keyword">import</span> <span class="string">'@storybook/addon-notes/register'</span>;</span><br></pre></td></tr></table></figure>
</li>
<li><p>编写 stroy</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> &#123; storiesOf &#125; <span class="keyword">from</span> <span class="string">'@storybook/react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; action &#125; <span class="keyword">from</span> <span class="string">'@storybook/addon-actions'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; WithNotes &#125; <span class="keyword">from</span> <span class="string">'@storybook/addon-notes'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Button <span class="keyword">from</span> <span class="string">'./Button'</span>;</span><br><span class="line"></span><br><span class="line">storiesOf(<span class="string">'Button'</span>, <span class="built_in">module</span>)</span><br><span class="line">  .add(<span class="string">'with some emoji'</span>, () =&gt; (</span><br><span class="line">    &lt;WithNotes notes=&#123;<span class="string">'Here we use some emoji as the Button text. Doesn&amp;apos;t it look nice?'</span>&#125;&gt;</span><br><span class="line">      &lt;Button onClick=&#123;action(<span class="string">'clicked'</span>)&#125;&gt;😀 😎 👍 💯&lt;<span class="regexp">/Button&gt;</span></span><br><span class="line"><span class="regexp">    &lt;/</span>WithNotes&gt;</span><br><span class="line">  ));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用装饰器 1</span></span><br><span class="line"><span class="keyword">import</span> &#123; storiesOf &#125; <span class="keyword">from</span> <span class="string">'@storybook/react'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; action &#125; <span class="keyword">from</span> <span class="string">'@storybook/addon-actions'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> Button <span class="keyword">from</span> <span class="string">'./button'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> styles = &#123;</span><br><span class="line">  textAlign: <span class="string">'center'</span>,</span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">const</span> CenterDecorator = <span class="function">(<span class="params">storyFn</span>) =&gt;</span> (</span><br><span class="line">  &lt;div style=&#123;styles&#125;&gt;</span><br><span class="line">    &#123; storyFn() &#125;</span><br><span class="line">  &lt;<span class="regexp">/div&gt;</span></span><br><span class="line"><span class="regexp">);</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">storiesOf('Button', module)</span></span><br><span class="line"><span class="regexp">  .addDecorator(CenterDecorator)</span></span><br><span class="line"><span class="regexp">  .add('with text', () =&gt; (</span></span><br><span class="line"><span class="regexp">    &lt;Button onClick=&#123;action('clicked')&#125;&gt;Hello Button&lt;/</span>Button&gt;</span><br><span class="line">  ))</span><br><span class="line">  .add(<span class="string">'with some emojies'</span>, () =&gt; (</span><br><span class="line">    &lt;Button onClick=&#123;action(<span class="string">'clicked'</span>)&#125;&gt;😀 😎 👍 💯&lt;<span class="regexp">/Button&gt;</span></span><br><span class="line"><span class="regexp">  ));</span></span><br><span class="line"><span class="regexp"></span></span><br><span class="line"><span class="regexp">/</span><span class="regexp">/ 使用装饰器 2</span></span><br><span class="line"><span class="regexp">import &#123; storiesOf, addDecorator &#125; from '@storybook/</span>react<span class="string">';</span></span><br><span class="line"><span class="string">import &#123; action &#125; from '</span>@storybook/addon-actions<span class="string">';</span></span><br><span class="line"><span class="string">import &#123; linkTo &#125; from '</span>@storybook/addon-links<span class="string">';</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">import Button from '</span>./button<span class="string">';</span></span><br><span class="line"><span class="string">import Welcome from '</span>./welcome<span class="string">';</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">const styles = &#123;</span></span><br><span class="line"><span class="string">  textAlign: '</span>center<span class="string">',</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string">const CenterDecorator = (storyFn) =&gt; (</span></span><br><span class="line"><span class="string">  &lt;div style=&#123;styles&#125;&gt;</span></span><br><span class="line"><span class="string">    &#123; storyFn() &#125;</span></span><br><span class="line"><span class="string">  &lt;/div&gt;</span></span><br><span class="line"><span class="string">);</span></span><br><span class="line"><span class="string">addDecorator(CenterDecorator);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">storiesOf('</span>Welcome<span class="string">', module)</span></span><br><span class="line"><span class="string">  .add('</span>to Storybook<span class="string">', () =&gt; (</span></span><br><span class="line"><span class="string">    &lt;Welcome showApp=&#123;linkTo('</span>Button<span class="string">')&#125;/&gt;</span></span><br><span class="line"><span class="string">  ));</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">storiesOf('</span>Button<span class="string">', module)</span></span><br><span class="line"><span class="string">  .add('</span><span class="keyword">with</span> text<span class="string">', () =&gt; (</span></span><br><span class="line"><span class="string">    &lt;Button onClick=&#123;action('</span>clicked<span class="string">')&#125;&gt;Hello Button&lt;/Button&gt;</span></span><br><span class="line"><span class="string">  ))</span></span><br><span class="line"><span class="string">  .add('</span><span class="keyword">with</span> some emojies<span class="string">', () =&gt; (</span></span><br><span class="line"><span class="string">    &lt;Button onClick=&#123;action('</span>clicked<span class="string">')&#125;&gt;😀 😎 👍 💯&lt;/Button&gt;</span></span><br><span class="line"><span class="string">  ));</span></span><br></pre></td></tr></table></figure>
</li>
</ol>
<h3 id="插件清单"><a href="#插件清单" class="headerlink" title="插件清单"></a>插件清单</h3><ol>
<li><a href="https://github.com/storybooks/storybook/tree/master/addons/storyshots" target="_blank" rel="noopener">Storyshots</a>: 快照测试。</li>
<li><a href="https://github.com/mthuret/storybook-addon-specifications" target="_blank" rel="noopener">Specs</a>: 交互测试。</li>
<li><a href="https://github.com/storybooks/storybook/tree/master/addons/notes" target="_blank" rel="noopener">Notes</a>: 在 story 中添加备注。</li>
<li><a href="https://github.com/storybooks/storybook/tree/master/addons/info" target="_blank" rel="noopener">Info</a>: 用于创建 css 框架手册。</li>
<li><a href="https://github.com/tuchk4/storybook-readme" target="_blank" rel="noopener">Readme</a>: 将 markdown 导入为 story。</li>
<li><a href="https://github.com/storybooks/storybook/tree/master/addons/actions" target="_blank" rel="noopener">actions</a>: 显示事件的 event 对象。</li>
<li><a href="https://github.com/truffls/storybook-addon-intl" target="_blank" rel="noopener">Intl</a>: 添加 locales 面板，用于切换语言。</li>
<li><a href="https://github.com/Sambego/storybook-state" target="_blank" rel="noopener">State</a>: 添加 state 面板，展示或更新 state，重绘视图。</li>
<li><a href="https://github.com/evgenykochetkov/react-storybook-addon-props-combinations" target="_blank" rel="noopener">Props Combinations</a>: 配置可能有的props，一次性绘出多个组件作对比。</li>
<li><a href="https://github.com/storybooks/storybook/tree/master/addons/knobs" target="_blank" rel="noopener">Knobs</a>: 页面上变更 props 重绘视图。</li>
<li><a href="https://github.com/storybooks/storybook/tree/master/addons/links" target="_blank" rel="noopener">Links</a>: 通过 linkTo 函数或 LinkTo 组件链接多个 story，支持点击跳转。</li>
<li><a href="https://github.com/gvaldambrini/storybook-router" target="_blank" rel="noopener">Story-router</a>: 装饰器，支持 storybook 使用 react-router 等路由组件。</li>
<li><a href="https://github.com/storybook-eol/addon-backgrounds" target="_blank" rel="noopener">Backgrounds</a>: 切换背景图或背景颜色。</li>
<li><a href="https://github.com/joscha/storybook-addon-i18n-tools" target="_blank" rel="noopener">i18n tools</a>: 切换文字对齐方式，左对齐或右对齐。</li>
<li><a href="https://github.com/react-theming/storybook-addon-material-ui" target="_blank" rel="noopener">Material-UI</a>: 添加并切换自定义主题。</li>
<li><a href="https://github.com/philcockfield/storybook-host" target="_blank" rel="noopener">Host</a>: 装饰器，在页面上以盒模式展示组件。</li>
<li><a href="https://github.com/Checkfront/react-storybook-addon-chapters" target="_blank" rel="noopener">Chapters</a>: 在同一个 story 中以章节形式展示多个组件。</li>
<li><a href="https://github.com/storybooks/storybook/tree/master/addons/options" target="_blank" rel="noopener">Options</a>: 调整 storybook 页面外观，切换为全屏等。</li>
<li><a href="https://github.com/storybooks/storybook-addon-console" target="_blank" rel="noopener">Console</a>: 将浏览器控制台 console 信息输出到 storybook log 面板。</li>
<li><a href="https://github.com/storybooks/addon-jsx" target="_blank" rel="noopener">JSX preview</a>: 展示及拷贝 JSX 代码。</li>
<li><a href="https://github.com/buildit/storybook-addon-versions" target="_blank" rel="noopener">Versions</a>: 添加版本号，查看各版本的变化。</li>
<li><a href="https://github.com/abhiaiyer91/apollo-storybook-decorator" target="_blank" rel="noopener">Apollo</a>: 添加 Apollo client，模拟 GraphQL 查询。</li>
<li><a href="https://github.com/tsuyoshiwada/storybook-chrome-screenshot" target="_blank" rel="noopener">Screenshot</a>: 保存网页截图。</li>
<li><a href="https://storybook.js.org/addons/addon-gallery/" target="_blank" rel="noopener">Styles</a>: storybook 预览界面添加自定义样式。</li>
<li><a href="https://github.com/hharnisc/storybook-addon-figma" target="_blank" rel="noopener">Figma</a>: 添加 Figma 设计面板。</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/07/react/react相关/浅析react-transition-group源码/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/07/react/react相关/浅析react-transition-group源码/" itemprop="url">浅析react-transition-group源码</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-07T23:19:17+08:00">2018-02-07</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/react/" itemprop="url" rel="index"><span itemprop="name">react</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/07/react/react相关/浅析react-transition-group源码/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/02/07/react/react相关/浅析react-transition-group源码/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="react-transition-group-1-版本回顾"><a href="#react-transition-group-1-版本回顾" class="headerlink" title="react-transition-group 1 版本回顾"></a>react-transition-group 1 版本回顾</h2><p>react-transition-group 1 版本在子组件创建、删除过程通过添加 class 控制 css 动效。</p>
<p>介于 css transition 动效在元素添加到页面过程就会执行，因此这个过程无需调控动效的执行。而当有元素被移除时，我们需要容器组件驻留被删除的子组件，等到动效执行完成后，才实际删除该子组件。</p>
<p>针对这一问题，react-transition-group 提供了 TransitionGroup 容器组件。其 state.children 属性为实际待绘制的组件，当组件更新时，通过比对 state.children, props.children，就可以获知新增了哪些组件、移除了哪些组件（用户配置的子组件通过 key 键存储成映射结构）。当子组件被移除时，触发 performLeave 方法，以调用子组件的 componentWillLeave 方法添加样式类、执行动效；再通过 componentWillLeave 方法的回调函数，更新 TransitionGroup 容器的 state.children，触发子组件的实际移除行为。</p>
<p>当采用上述逻辑处理子组件的移除动效时，为着处理逻辑的统一，react-transition-group 针对 componentDidMount 或 componentDidUpdate 时创建的子组件也采用相同的处理逻辑。子组件的钩子函数 componentWillAppear, componentDidAppear, componentWillEnter, componentDidEnter, componentWillLeave, componentDidLeave 将分别得到执行。当独立使用  TransitionGroup 容器时，我们可以借助这些钩子函数操控节点的样式以触发 css 动效，或者组织 js 动效，或者实现懒加载等等。</p>
<p>在 TransitionGroup 容器的基础上，CSSTransitionGroupChild 组件用于装饰子组件，在 componentWillAppear 等钩子函数添加样式类以执行 css 动效，通过 setTimeout 或 transitionEnd 事件更新 TransitionGroup 容器的 state.children 属性。CSSTransitionGroup 组件用于将 props 配置上提，而不是通过 CSSTransitionGroupChild 给每个子组件外加一个壳子。</p>
<h2 id="react-transition-group-2-版本"><a href="#react-transition-group-2-版本" class="headerlink" title="react-transition-group 2 版本"></a>react-transition-group 2 版本</h2><h3 id="Transition"><a href="#Transition" class="headerlink" title="Transition"></a>Transition</h3><p>相比于 1 版本通过判断子组件的有无添加动效，react-transition-group 2 版本可通过向子组件传递状态值（props.children 以函数形式配置；若为ReactElement，则无任何作用）控制子组件的创建和删除过程，这一点和 react-motion 类库相仿。关于 react-motion，笔者将在后续文章中加以分析。</p>
<p>上述思路的简单实现是通过容器组件向子组件传递 props.status，用于判断动效是在执行中 transitionExcute，还是执行完成 transitionEnd。若执行完成，将触发移除组件的操作。为此，react-transition-group 2 提供了 Transition 容器组件，props.status 状态分别在子组件创建和移除阶段添置了两个值，合计四种状态，即 ENTERING, ENTERED, EXITING, EXITED 。ENTERING, ENTERED 状态针对新创建的子组件，EXITING, EXITED 状态针对待移除的子组件。Transition 组件内部实现的主要业务逻辑就是协调 ENTERING 到 ENTERED，EXITING 到 EXITED 状态的自动变更。对于不需要动效的场景，状态将直接置为 ENTERED, EXITED；在 Transition 组件中，作为动效开关的是 props.appear, props.enter, props.exit 属性。</p>
<p>除此之外，有必要区分组件在创建过程 onEnter 还是在移除过程 onExit，以便于控制组件的挂载状态。然而 onEnter, onExit 两个状态值不适用于动效结束时仍保留组件的场景。为此，Transition 组件使用 props.in 属性表示组件的显示状态，结合 props.unmountOnExit 属性即表示在动效执行完成后，不必移除组件。子组件不能通过获得的 status 值控制自身的挂载状态，Transition 容器通过将 status 置为 UNMOUNTED，并在其 render 方法中输出 null，以控制子组件的显隐。这样的设计也满足了对子组件挂载时机的微调。像 1 版本中那样，通常情况下，子组件往往而在。不同的是，在组件初始化时通过将 props.mountOnEnter 属性置为真值，且 props.in 为否值，子组件将不在视图显示；当更新组件时，props.in 属性首次切换为真值时，才将 status 置为 EXITED，以便在实际视图中创建子组件，从而启动动效。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constructor</span>(props, context) &#123;</span><br><span class="line">  <span class="keyword">super</span>(props, context);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> parentGroup = context.transitionGroup;</span><br><span class="line">  <span class="comment">// In the context of a TransitionGroup all enters are really appears</span></span><br><span class="line">  <span class="keyword">let</span> appear = parentGroup &amp;&amp; !parentGroup.isMounting ?</span><br><span class="line">    props.enter :</span><br><span class="line">    props.appear;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> initialStatus;</span><br><span class="line">  <span class="keyword">this</span>.nextStatus = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (props.in) &#123;<span class="comment">// in 为真值，创建并显示组件</span></span><br><span class="line">    <span class="keyword">if</span> (appear) &#123;<span class="comment">// appear 为真值，执行动效</span></span><br><span class="line">      initialStatus = EXITED;<span class="comment">// updateStatus 方法中满足 initialStatus 非 null 校验，以执行 performEnter 方法</span></span><br><span class="line">      <span class="keyword">this</span>.nextStatus = ENTERING;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;<span class="comment">// appear 为否值，不执行动效</span></span><br><span class="line">      initialStatus = ENTERED;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// mountOnEnter 为真值，意味着延迟挂载；unmountOnExit 为否值的情形，主要为着避过 updateStatus 中对 &#123; state: EXITED &#125; 的处理逻辑，即动效执行结束后移除组件</span></span><br><span class="line">    <span class="keyword">if</span> (props.unmountOnExit || props.mountOnEnter) &#123;</span><br><span class="line">      initialStatus = UNMOUNTED;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 悬空</span></span><br><span class="line">      initialStatus = EXITED;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.state = &#123; <span class="attr">status</span>: initialStatus &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.nextCallback = <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">componentDidMount() &#123;</span><br><span class="line">  <span class="keyword">this</span>.updateStatus(<span class="literal">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">componentWillReceiveProps(nextProps) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; status &#125; = <span class="keyword">this</span>.pendingState || <span class="keyword">this</span>.state;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (nextProps.in) &#123;</span><br><span class="line">    <span class="comment">// 子组件已被移除或初始化未被挂载，status 置为 EXITED，便于添加子组件</span></span><br><span class="line">    <span class="keyword">if</span> (status === UNMOUNTED) &#123;</span><br><span class="line">      <span class="keyword">this</span>.setState(&#123; <span class="attr">status</span>: EXITED &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 子组件尚未在视图中，执行显示动效</span></span><br><span class="line">    <span class="keyword">if</span> (status !== ENTERING &amp;&amp; status !== ENTERED) &#123;</span><br><span class="line">      <span class="keyword">this</span>.nextStatus = ENTERING;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// 子组件已在视图中，执行移除动效</span></span><br><span class="line">    <span class="keyword">if</span> (status === ENTERING || status === ENTERED) &#123;</span><br><span class="line">      <span class="keyword">this</span>.nextStatus = EXITING;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">componentDidUpdate() &#123;</span><br><span class="line">  <span class="keyword">this</span>.updateStatus();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">updateStatus(mounting = <span class="literal">false</span>) &#123;</span><br><span class="line">  <span class="keyword">let</span> nextStatus = <span class="keyword">this</span>.nextStatus;<span class="comment">// 只有两种可能，ENTERING 或 EXITING</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (nextStatus !== <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">this</span>.nextStatus = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">this</span>.cancelNextCallback();</span><br><span class="line">    <span class="keyword">const</span> node = ReactDOM.findDOMNode(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (nextStatus === ENTERING) &#123;</span><br><span class="line">      <span class="keyword">this</span>.performEnter(node, mounting);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.performExit(node);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="comment">// 动效执行完成后 state 置为 EXITED 时，且 unmountOnExit 为真，移除子组件</span></span><br><span class="line">    <span class="keyword">this</span>.props.unmountOnExit &amp;&amp;</span><br><span class="line">    <span class="keyword">this</span>.state.status === EXITED</span><br><span class="line">  ) &#123;</span><br><span class="line">    <span class="keyword">this</span>.setState(&#123; <span class="attr">status</span>: UNMOUNTED &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>（当初始化时，props.in 置为否值，子组件将不予渲染或渲染后无动效；当更新时置为否值，子组件已在视图中，执行 performExit 方法，好启动 exit 动效。）</p>
<p>上述代码中，performEnter, performExit 方法用于操控容器组件在 props.timeout 时间后自动从 ENTERING 切换到 ENTERED 状态，或者从 EXITING 切换到 EXITED 状态。这两个方法均调用了 safeSetState 方法，该方法的意义是设置 pendingState 属性，以避免动效的多次执行；以及通过调用 onTransitionEnd 方法执行变更 status 的逻辑。onTransitionEnd 方法的延迟机制通过监听 transitionEnd 事件（借助于 props.addEventLinstener 配置）或者使用 setTimeout 执行回调实现，变更 status 状态的回调通过 setNextCallback 方法免于多次执行。</p>
<p>Transition 容器在根据 props.in, props.appear, props.enter, props.exit, props.mountOnEnter, props.unmountOnExit 属性自动处理 status 状态的同时，还设置了多个在适当时机执行的钩子函数，包含 props.onEnter, props.onEntering, props.onEntered, props.onExit, props.onExiting, props.onExited 配置项。</p>
<h3 id="CSSTransition"><a href="#CSSTransition" class="headerlink" title="CSSTransition"></a>CSSTransition</h3><p>在 react-transition-group 2 版本内部，props.onEnter 等钩子在实现 CSSTransition 组件时极有意义。因为 Transition 容器传给 props.children 函数的 status 只包含 enter, exit 相关状态，没有 appear 状态。而 onEnter, onEntering, onEntered 钩子的次参即为是否在 appear 状态中（通过 context.transitionGroup.isMounting 或 mounting 获知），CSSTransition 组件即在此基础上实现，通过钩子更新 props.children 对应节点的 class（依次由 <em>-appear, </em>-appear-active, <em>-enter, </em>-enter-active, <em>-enter-done, </em>-exit, <em>-exit-active, </em>-exit-done 变更，* 通过 props.classNames 设置，该属性也设置为对象）。与 1 版本相同，2 版本在类名变更的同时，访问了 node.scrollTop 促使浏览器重绘；也可以在 props.children 中执行 onEnter 等方法阻止 js 动效或懒加载等逻辑。CSSTransition 组件同样向上抛出 props.onEnter, props.onEntering, props.onEntered, props.onExit, props.onExiting, props.onExited 钩子。</p>
<h3 id="TransitionGroup"><a href="#TransitionGroup" class="headerlink" title="TransitionGroup"></a>TransitionGroup</h3><p>TransitionGroup 的处理逻辑和 1 版本相同，即通过 state.children 控制待渲染的元素，以实现 exit 动效执行时仍驻留子组件的场景。不同的是，1 版本会用 CSSTransitionGroupChild 包装子组件，2 版本需要用户传入 Transition 组件作为 TransitionGroup 的子组件。当然，因为 2 版本中，Transition 组件动效执行时机和组件渲染状态的弱关联，促使 TransitionGroup 容器的 componentWillReceiveProps 方法中更新 state.children 的逻辑也不一样。</p>
<p>TransitionGroup 的一般适用场景为当子组件添加时，执行 enter 动效；当子组件移除时，执行 exit 动效。在这样的场景中，子组件的渲染状态不受 TransitionGroup 控制，也即 TransitionGroup 容器对子组件的 props.in 属性的调控必须与子组件的渲染状态向匹配。在 TransitionGroup 容器初始化阶段，传入子组件的 props.in 属性必然为真值，因为在这阶段，子组件都会得到渲染。在更新阶段，当子组件移除时，通过设置 props.in 为否值，触发 exit 动效；当子组件 exit 动效执行阶段，子组件又被添加，通过设置 props.in 为真值，使 enter, exit 动效得以执行；当子组件 exit 动效执行完成、且组件已移除后，处理逻辑同 exit 动效执行阶段；当子组件维持原样，传入子组件的 props.in 属性维持原值，props.oEnter, props.onExit 属性则同步为子组件最新的 props 值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">constructor</span>(props, context) &#123;</span><br><span class="line">  <span class="keyword">super</span>(props, context);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Initial children should all be entering, dependent on appear</span></span><br><span class="line">  <span class="keyword">this</span>.state = &#123;</span><br><span class="line">    children: getChildMapping(props.children, child =&gt; &#123;</span><br><span class="line">      <span class="keyword">return</span> cloneElement(child, &#123;</span><br><span class="line">        onExited: <span class="keyword">this</span>.handleExited.bind(<span class="keyword">this</span>, child),</span><br><span class="line">        <span class="keyword">in</span>: <span class="literal">true</span>,</span><br><span class="line">        appear: <span class="keyword">this</span>.getProp(child, <span class="string">'appear'</span>),</span><br><span class="line">        enter: <span class="keyword">this</span>.getProp(child, <span class="string">'enter'</span>),</span><br><span class="line">        exit: <span class="keyword">this</span>.getProp(child, <span class="string">'exit'</span>),</span><br><span class="line">      &#125;)</span><br><span class="line">    &#125;),</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">componentWillReceiveProps(nextProps) &#123;</span><br><span class="line">  <span class="keyword">let</span> prevChildMapping = <span class="keyword">this</span>.state.children;</span><br><span class="line">  <span class="keyword">let</span> nextChildMapping = getChildMapping(nextProps.children);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> children = mergeChildMappings(prevChildMapping, nextChildMapping);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Object</span>.keys(children).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> child = children[key]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isValidElement(child)) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> hasPrev = key <span class="keyword">in</span> prevChildMapping;</span><br><span class="line">    <span class="keyword">const</span> hasNext = key <span class="keyword">in</span> nextChildMapping;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> prevChild = prevChildMapping[key];</span><br><span class="line">    <span class="comment">// child 在移除过程中</span></span><br><span class="line">    <span class="keyword">const</span> isLeaving = isValidElement(prevChild) &amp;&amp; !prevChild.props.in;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// child 新添加或者移除动效尚未执行完成，执行 enter 动效</span></span><br><span class="line">    <span class="keyword">if</span> (hasNext &amp;&amp; (!hasPrev || isLeaving)) &#123;</span><br><span class="line">      <span class="comment">// console.log('entering', key)</span></span><br><span class="line">      children[key] = cloneElement(child, &#123;</span><br><span class="line">        onExited: <span class="keyword">this</span>.handleExited.bind(<span class="keyword">this</span>, child),</span><br><span class="line">        <span class="keyword">in</span>: <span class="literal">true</span>,</span><br><span class="line">        exit: <span class="keyword">this</span>.getProp(child, <span class="string">'exit'</span>, nextProps),</span><br><span class="line">        enter: <span class="keyword">this</span>.getProp(child, <span class="string">'enter'</span>, nextProps),</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 组件已移除，执行 exit 动效</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!hasNext &amp;&amp; hasPrev &amp;&amp; !isLeaving) &#123;</span><br><span class="line">      <span class="comment">// console.log('leaving', key)</span></span><br><span class="line">      children[key] = cloneElement(child, &#123; <span class="attr">in</span>: <span class="literal">false</span> &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 组件动效特性未作改变，保留原值</span></span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (hasNext &amp;&amp; hasPrev &amp;&amp; isValidElement(prevChild)) &#123;</span><br><span class="line">      <span class="comment">// console.log('unchanged', key)</span></span><br><span class="line">      children[key] = cloneElement(child, &#123;</span><br><span class="line">        onExited: <span class="keyword">this</span>.handleExited.bind(<span class="keyword">this</span>, child),</span><br><span class="line">        <span class="keyword">in</span>: prevChild.props.in,</span><br><span class="line">        exit: <span class="keyword">this</span>.getProp(child, <span class="string">'exit'</span>, nextProps),</span><br><span class="line">        enter: <span class="keyword">this</span>.getProp(child, <span class="string">'enter'</span>, nextProps),</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.setState(&#123; children &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>handleExited 方法用于当子组件 exit 动效执行完成且移除后，更新 TransitionGroup 容器的 state.children 属性，附带调用原始传入子组件的 props.onExited 方法（实际传入子组件的 props.onExited 方法被改写为 handleExited 方法）。</p>
<p>在变更 state.children 的处理逻辑之外，TransitionGroup 向外提供 props.appear, props.enter, props.exit, props.component, props.childFactory 配置项。props.appear, props.enter, props.exit 为当子组件元素没有同名 props 属性时，使用 TransitionGroup 容器的 props 属性；props.component 为外层包裹元素（适配 react 中 props.children 不能置为数组的特性，react 16 可能不需要）；props.childFactory 用于装饰子元素。</p>
<p>2 版本没有提供 CSSTransitionGroup 组件，因为在 TransitionGroup 组件下挂载 CSSTransition 组件即能实现与 1 版本中 CSSTransitionGroup 相同的效果，通过调整节点的 class 实现动效。在这里，CSSTransition 组件作为特殊的 Transition 组件。除此而外，Transition, CSSTransition 组件都向外暴露 props.onEnter, props.onEntering, props.onEntered, props.onExit, props.onExiting, props.onExited 配置钩子，因此相较于 1 版本中通过 CSSTransitionGroup 自应用的 CSSTransitionGroupChild 组件，2 版本能对 css 动效实现更细微的控制。</p>
<p>此外，TransitionGroup 组件会通过 context 属性向 Transition 子组件传递 transitionGroup 属性，以使 Transition 子组件能够感知动效处于 appear 阶段还是 enter 阶段。Transition 组件又通过 getChildContext 方法，将其子孙组件的 transitionGroup 属性置为 null，其意义时，当父 Transition 嵌套子 Transition 时，子 Transition 不至于尝试通过 context.transitionGroup 属性判断动效在 appear 阶段还是 enter 阶段。</p>
<h3 id="ReplaceTransition"><a href="#ReplaceTransition" class="headerlink" title="ReplaceTransition"></a>ReplaceTransition</h3><p>2 版本中，ReplaceTransition 用于通过控制 props.in 切换显示两个子组件中的一个。因此实际使用过程中，需要有容器包裹，通过容器更新传入 ReplaceTransition 组件中的props.in；循环切换需要在容器中设置定时器（循环切换过程中，不支持其中任意一个子组件 exit 动效，适用场景相对较小）。ReplaceTransition 组价向外提供 props.onEnter, props.onEntering, props.onEntered, props.onExit, props.onExiting, props.onExited 等配置属性，前三个为第一个子组件 enter 动效相关钩子，后三个为第二个子组件 enter 动效相关钩子。其 ReplaceTransition 组价支持在 enter 发生过程中调用子组件的 props.onEnter, props.onEntering, props.onEntered, props.onExit, props.onExiting, props.onExited，前三个钩子为第一个子组件独有，后三个为第二个子组件独有。源码不作赘述。</p>
<h2 id="反思"><a href="#反思" class="headerlink" title="反思"></a>反思</h2><p>无论 1 版本的核心模块 TransitionGroup，还是 2 版本的核心模块 Transition，都通过容器管理子组件的动效执行过程。1 版本切入的视角在于通过判断子组件从列表中创建、移除的过程，触发调用子组件的 componentWillAppear 等方法，以管理动效。对于 css 动效，1 版本又通过包含特定 componentWillAppear 等实例方法的 CSSTransitionGroupChild 包装用户实际开发的子组件，从而对接上 TransitionGroup 容器，使子组件中的动效得到管理。2 版本在处理上更为细致，独立对待用户开发的动效组件，而不是视为列表形式。2 版本通过 Transition 容器将子组件可能包含的 enter, exit 动效抽象为 state.status，并传入子组件，由子组件自身通过 status 启用特定的动效；并且同样提供了以钩子方式（props.onEnter 等配置方法）管理动效的实现，2 版本自身的 CSSTransition 组件即通过钩子调节添加到节点上的 class。若说 1 版本还滞留于子组件从列表中移入移出的视点，2 版本的观察角度则从列表中脱离，实打实地介入了子组件动效执行周期的管理，will - excute - did，并向下注入执行状态。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/06/webpack/webpack插件指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/06/webpack/webpack插件指南/" itemprop="url">webpack插件指南</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-06T23:38:53+08:00">2018-02-06</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端工程化/" itemprop="url" rel="index"><span itemprop="name">前端工程化</span></a></span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端工程化/webpack/" itemprop="url" rel="index"><span itemprop="name">webpack</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/06/webpack/webpack插件指南/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/02/06/webpack/webpack插件指南/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="HotModuleReplacementPlugin"><a href="#HotModuleReplacementPlugin" class="headerlink" title="HotModuleReplacementPlugin"></a>HotModuleReplacementPlugin</h2><p>内置为 webpack.HotModuleReplacementPlugin，热替换插件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> webpack.HotModuleReplacementPlugin(&#123;</span><br><span class="line">  multiStep: boolean,<span class="comment">// 设置为 true 时，插件会分成两步构建文件。首先编译热加载 chunks，之后再编译剩余的通常的资源</span></span><br><span class="line">  fullBuildTimeout: number,<span class="comment">// 当 multiStep 启用时，表示两步构建之间的延时</span></span><br><span class="line">  requestTimeout: number<span class="comment">// 下载 manifest 的延时</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="DllPlugin-DLLReferencePlugin"><a href="#DllPlugin-DLLReferencePlugin" class="headerlink" title="DllPlugin, DLLReferencePlugin"></a>DllPlugin, DLLReferencePlugin</h2><p>内置为 webpack.DllPlugin, webpack.DllReferencePlugin，用于提升编译速度。</p>
<p>DllPlugin 插件会生成一个 manifest.json 文件，该文件包含了从 require 和 import 的 request 到模块 id 的映射，用于让 DLLReferencePlugin 映射到相关的依赖上去。通过引用 manifest.json 文件来把依赖的名称映射到模块的 id 上，之后再在需要的时候通过内置的 <strong>webpack_require</strong> 函数来 require 他们。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// webpack.vendor.config.js</span></span><br><span class="line"><span class="keyword">new</span> webpack.DllPlugin(&#123;</span><br><span class="line">  context: __dirname,<span class="comment">// manifest 文件中请求的上下文(context)(默认值为 webpack 的上下文(context))</span></span><br><span class="line">  name: <span class="string">"[name]_[hash]"</span>,<span class="comment">// 暴露出的 DLL 的函数名</span></span><br><span class="line">  path: path.join(__dirname, <span class="string">"manifest.json"</span>),<span class="comment">// manifest.json 文件的绝对路径</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// webpack.app.config.js</span></span><br><span class="line"><span class="keyword">new</span> webpack.DllReferencePlugin(&#123;</span><br><span class="line">  context: __dirname,<span class="comment">// 绝对路径， manifest.json (或者是内容属性)中请求的上下文</span></span><br><span class="line">  manifest: <span class="built_in">require</span>(<span class="string">"./manifest.json"</span>),<span class="comment">// 包含 content 和 name 的对象</span></span><br><span class="line">  content: <span class="built_in">require</span>(<span class="string">"./manifest.json"</span>).content,<span class="comment">// 请求到模块 id 的映射 (默认值为 manifest.content)</span></span><br><span class="line">  name: manifest.name,<span class="comment">// dll 脚本的名称 (默认值为 manifest.name)</span></span><br><span class="line">  scope: <span class="literal">undefined</span>,<span class="comment">// 开启作用域模块，如 scope = "xyz"， dll 中的名为 abc 的文件可通过 require("xyz/abc") 加载。默认为映射模式，即通过 require("abc") 加载。且 dll 文件不会被打包到 bundle 中</span></span><br><span class="line">  sourceType: <span class="string">"commonsjs2"</span><span class="comment">// dll 如何向外提供全局函数</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="DefinePlugin"><a href="#DefinePlugin" class="headerlink" title="DefinePlugin"></a>DefinePlugin</h2><p>内置为 webpack.DefinePlugin，定义全局变量。使用场景如，由变量区分开发环境或生产环境，开发环境打印日志，生产环境不打印。变量的值将被转换为字符串，且以文本替换的形式传入代码中，所以需要包裹单双引号或使用 JSON.stringify，如 ‘“production”‘, JSON.stringify(‘production’)。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> webpack.DefinePlugin(&#123;</span><br><span class="line">  PRODUCTION: <span class="built_in">JSON</span>.stringify(<span class="literal">true</span>),<span class="comment">// 以文本形式传入 true</span></span><br><span class="line">  VERSION: <span class="built_in">JSON</span>.stringify(<span class="string">"5fa3b9"</span>),</span><br><span class="line">  BROWSER_SUPPORTS_HTML5: <span class="literal">true</span>,</span><br><span class="line">  TWO: <span class="string">"1+1"</span>,</span><br><span class="line">  <span class="string">"typeof window"</span>: <span class="built_in">JSON</span>.stringify(<span class="string">"object"</span>),<span class="comment">// 替换 typeof window 文本</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 功能标记</span></span><br><span class="line">  <span class="string">'NICE_FEATURE'</span>: <span class="built_in">JSON</span>.stringify(<span class="literal">true</span>),</span><br><span class="line">  <span class="string">'EXPERIMENTAL_FEATURE'</span>: <span class="built_in">JSON</span>.stringify(<span class="literal">false</span>),</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 服务 Url</span></span><br><span class="line">  <span class="string">'SERVICE_URL'</span>: <span class="built_in">JSON</span>.stringify(<span class="string">"http://dev.example.com"</span>)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="EnvironmentPlugin"><a href="#EnvironmentPlugin" class="headerlink" title="EnvironmentPlugin"></a>EnvironmentPlugin</h2><p>内置为 webpack.EnvironmentPlugin，使用 DefinePlugin 快捷设置 process.env 环境变量。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">等同于 new webpack.DefinePlugin(&#123;</span></span><br><span class="line"><span class="comment">  'process.env.NODE_ENV': JSON.stringify(process.env.NODE_ENV),</span></span><br><span class="line"><span class="comment">  'process.env.DEBUG': JSON.stringify(process.env.DEBUG)</span></span><br><span class="line"><span class="comment">&#125;)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">new</span> webpack.EnvironmentPlugin([<span class="string">'NODE_ENV'</span>, <span class="string">'DEBUG'</span>])</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用默认值</span></span><br><span class="line"><span class="keyword">new</span> webpack.EnvironmentPlugin(&#123;</span><br><span class="line">  NODE_ENV: <span class="string">'development'</span>, <span class="comment">// 除非有定义 process.env.NODE_ENV，否则就使用 'development'</span></span><br><span class="line">  DEBUG: <span class="literal">false</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="ProvidePlugin"><a href="#ProvidePlugin" class="headerlink" title="ProvidePlugin"></a>ProvidePlugin</h2><p>内置为 webpack.ProvidePlugin，当某变量没有赋值时，自动 import 或 require 相应的模块，并导出其中的方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 自动加载 jquery</span></span><br><span class="line"><span class="keyword">new</span> webpack.ProvidePlugin(&#123;</span><br><span class="line">  $: <span class="string">'jquery'</span>,</span><br><span class="line">  jQuery: <span class="string">'jquery'</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 注入 lodash.map 方法</span></span><br><span class="line"><span class="keyword">new</span> webpack.ProvidePlugin(&#123;</span><br><span class="line">  _map: [<span class="string">'lodash'</span>, <span class="string">'map'</span>]</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="CommonsChunkPlugin"><a href="#CommonsChunkPlugin" class="headerlink" title="CommonsChunkPlugin"></a>CommonsChunkPlugin</h2><p>内置为 webpack.optimize.CommonsChunkPlugin，提取公共代码，结合 entry 属性使用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> webpack = <span class="built_in">require</span>(<span class="string">"webpack"</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  entry: &#123;</span><br><span class="line">    vendor: [<span class="string">"jquery"</span>, <span class="string">"other-lib"</span>],</span><br><span class="line">    app: <span class="string">"./entry"</span></span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</span><br><span class="line">      name: string|string[],<span class="comment">// 字符串或数组，若设为已经存在的打包文件 chunk 名称，将把该 chunk 提取到公共文件中。如果该选项被忽略，同时 `options.async` 或者 `options.children` 被设置，所有的 chunk 都会被使用，否则 `options.filename` 会用于作为 chunk 名</span></span><br><span class="line">      filename: string,<span class="comment">// 公共文件名模板，使用和 output.filename 相同的占位符。不设置，将保留原 chunk 的名称</span></span><br><span class="line">      minChunks: number|<span class="literal">Infinity</span>|<span class="function">(<span class="params"><span class="built_in">module</span>, count</span>) =&gt;</span> boolean,<span class="comment">// 生成公共文件前，需要传入的 chunk 数量。设为 Infinity，会马上生成 公共chunk，但里面没有模块。默认是 chunk 的数量</span></span><br><span class="line">      chunks: string[],<span class="comment">// 选择 chunk 的来源。如果被忽略，所有的入口 chunk 都会被选择</span></span><br><span class="line">      children: boolean,<span class="comment">// 如果设置为 true，入口 chunk 的依赖都会被并入公共文件中，以避免 chunk 的依赖包含重复代码</span></span><br><span class="line">      <span class="keyword">async</span>: boolean|string,<span class="comment">// 如果设置为 true，与上面相同，入口 chunk 的依赖被并入公共文件中，且使用异步加载</span></span><br><span class="line">      minSize: number<span class="comment">// 在 公共chunk 被创建立之前，所有公共模块的最少大小</span></span><br><span class="line">    &#125;)</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 入口 chunk 依赖路径中包含 "somelib" 字样的脚本，这些脚本将被视为一个 chunk，chunk 的 keyname 是 "my-single-lib-chunk"，最终打包到 "my-single-lib-chunk.js" 中</span></span><br><span class="line"><span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</span><br><span class="line">  name: <span class="string">"vendor"</span>,</span><br><span class="line">  minChunks: ffunction(<span class="built_in">module</span>, count) &#123; </span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">module</span>.resource &amp;&amp; (<span class="regexp">/somelib/</span>).test(<span class="built_in">module</span>.resource) &amp;&amp; count === <span class="number">3</span>; </span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 避免提取 css, scss 文件，且公共文件只能在 node_modules 下</span></span><br><span class="line"><span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</span><br><span class="line">  name: <span class="string">"vendor"</span>,</span><br><span class="line">  minChunks: <span class="function"><span class="keyword">function</span> (<span class="params">module</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(<span class="built_in">module</span>.resource &amp;&amp; (<span class="regexp">/^.*\.(css|scss)$/</span>).test(<span class="built_in">module</span>.resource)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">module</span>.context &amp;&amp; <span class="built_in">module</span>.context.indexOf(<span class="string">"node_modules"</span>) !== <span class="number">-1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 webpack 注入页面的脚本提取到公共文件，文件名 "manifest" 不能和入口 chunk 重名</span></span><br><span class="line"><span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</span><br><span class="line">  name: <span class="string">"manifest"</span>,</span><br><span class="line">  minChunks: <span class="literal">Infinity</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line">[</span><br><span class="line">  <span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</span><br><span class="line">    name: <span class="string">"vendor"</span>,</span><br><span class="line">    minChunks: <span class="function"><span class="keyword">function</span>(<span class="params">module</span>)</span>&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">module</span>.context &amp;&amp; <span class="built_in">module</span>.context.indexOf(<span class="string">"node_modules"</span>) !== <span class="number">-1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;),</span><br><span class="line">  <span class="keyword">new</span> webpack.optimize.CommonsChunkPlugin(&#123;</span><br><span class="line">    name: <span class="string">"manifest"</span>,</span><br><span class="line">    minChunks: <span class="literal">Infinity</span></span><br><span class="line">  &#125;),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h2 id="SourceMapDevToolPlugin"><a href="#SourceMapDevToolPlugin" class="headerlink" title="SourceMapDevToolPlugin"></a>SourceMapDevToolPlugin</h2><p>内置为 webpack.SourceMapDevToolPlugin，对 webpackConfig.devtool 添加的 SourceMap 予以更细粒度的控制。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> webpack.SourceMapDevToolPlugin(&#123;</span><br><span class="line">  test,<span class="comment">// 指定资源，test 默认是 .js 和 .css 文件</span></span><br><span class="line">  include,</span><br><span class="line">  exclude,</span><br><span class="line">  filename: <span class="string">'[name].js.map'</span>,<span class="comment">// SourceMap 的输出文件名。如果没有提供值，则 source map 是内联的</span></span><br><span class="line">  append,<span class="comment">// 追加到原始资源。通常以 #sourceMappingURL 注释。[url] 替换为 source map 文件的 URL。false 禁止追加</span></span><br><span class="line">  moduleFilenameTemplate,<span class="comment">// SourceMap 的输出文件名模板</span></span><br><span class="line">  fallbackModuleFilenameTemplate,<span class="comment">// SourceMap 的输出文件名后备方案</span></span><br><span class="line">  <span class="built_in">module</span>: <span class="literal">true</span>,<span class="comment">// 为 false 时， loader 不再生成 source map，并且转换过的代码被用作源码</span></span><br><span class="line">  columns: <span class="literal">true</span>,<span class="comment">//  为 false 时，source map 中的列映射(column mapping)被忽略，并且使用更快速的 source map 实现</span></span><br><span class="line">  lineToLine: &#123;<span class="comment">// 匹配的模块使用简单快速的行到行 source map</span></span><br><span class="line">    test,</span><br><span class="line">    include,</span><br><span class="line">    exclude</span><br><span class="line">  &#125; </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="MinChunkSizePlugin"><a href="#MinChunkSizePlugin" class="headerlink" title="MinChunkSizePlugin"></a>MinChunkSizePlugin</h2><p>内置为 webpack.optimize.MinChunkSizePlugin，通过合并小于 minChunkSize 大小的 chunk，将 chunk 体积保持在指定大小限制以上。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> webpack.optimize.MinChunkSizePlugin(&#123;</span><br><span class="line">  minChunkSize: <span class="number">10000</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="BannerPlugin"><a href="#BannerPlugin" class="headerlink" title="BannerPlugin"></a>BannerPlugin</h2><p>内置为 webpack.BannerPlugin，为每个 chunk 文件头部添加 banner。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> webpack.BannerPlugin(banner)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line"><span class="keyword">new</span> webpack.BannerPlugin(&#123;</span><br><span class="line">  banner: <span class="string">"hash:[hash], chunkhash:[chunkhash], name:[name], filebase:[filebase], query:[query], file:[file]"</span>,</span><br><span class="line">  raw: <span class="literal">false</span>,<span class="comment">// 如果值为 true，将直出，不作为注释</span></span><br><span class="line">  entryOnly: <span class="literal">false</span>,<span class="comment">// 如果值为 true，将只在入口 chunks 文件中添加</span></span><br><span class="line">  test: <span class="literal">null</span>,</span><br><span class="line">  include: <span class="literal">null</span>,</span><br><span class="line">  exclude: <span class="literal">null</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="IgnorePlugin"><a href="#IgnorePlugin" class="headerlink" title="IgnorePlugin"></a>IgnorePlugin</h2><p>内置为 webpack.IgnorePlugin，打包时避过指定资源。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> webpack.IgnorePlugin(</span><br><span class="line">  requestRegExp,<span class="comment">// 测试资源请求路径的正则表达式</span></span><br><span class="line">  [contextRegExp]<span class="comment">// (可选) 测试资源上下文(目录)的正则表达式</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例，moment 类库中 locale 资源将不予打包</span></span><br><span class="line"><span class="keyword">new</span> webpack.IgnorePlugin(<span class="regexp">/^\.\/locale$/</span>, /moment$/)</span><br></pre></td></tr></table></figure>
<h2 id="NormalModuleReplacementPlugin"><a href="#NormalModuleReplacementPlugin" class="headerlink" title="NormalModuleReplacementPlugin"></a>NormalModuleReplacementPlugin</h2><p>内置为 webpack.NormalModuleReplacementPlugin，替换指定资源，适用场景为生产环境下的某配置文件比开发环境的配置文件有更高优先级。高级用法是指定环境变量，通过环境变量指定待加载的资源。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 生产环境修改 webpack.config.js，加载 './config.production.js' 文件；开发环境不使用 NormalModuleReplacementPlugin 插件，加载 'some/path/config.development.js' 文件</span></span><br><span class="line"><span class="keyword">new</span> webpack.NormalModuleReplacementPlugin(</span><br><span class="line">  /some\/path\/config\.development\.js/,</span><br><span class="line">  <span class="string">'./config.production.js'</span></span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 高级用法，通过环境变量加载文件，开发环境默认加载带 VERSION_A 字样文件；生产环境设 env.APP_TARGET = 'VERSION_B'，加载 VERSION_B 文件</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function"><span class="keyword">function</span>(<span class="params">env</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> appTarget = env.APP_TARGET || <span class="string">'VERSION_A'</span>;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    plugins: [</span><br><span class="line">      <span class="keyword">new</span> webpack.NormalModuleReplacementPlugin(<span class="regexp">/(.*)-APP_TARGET(\.*)/</span>, <span class="function"><span class="keyword">function</span>(<span class="params">resource</span>) </span>&#123;</span><br><span class="line">        resource.request = resource.request.replace(<span class="regexp">/-APP_TARGET/</span>, <span class="string">`-<span class="subst">$&#123;appTarget&#125;</span>`</span>);</span><br><span class="line">      &#125;)</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="ContextReplacementPlugin"><a href="#ContextReplacementPlugin" class="headerlink" title="ContextReplacementPlugin"></a>ContextReplacementPlugin</h2><p>内置为 webpack.ContextReplacementPlugin，替换 webpack 文件查找规则。在 webpack 中，当 require(‘./locale/‘ + name + ‘.json’)，webpack 将查找目录 (‘./locale/‘) 下符合正则表达式 (/^.*.json$/)的文件，由于 name 在编译时(compile time)还是未知的，webpack 会将每个文件都作为模块引入到 bundle 中。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> webpack.ContextReplacementPlugin，替换(</span><br><span class="line">  resourceRegExp: <span class="built_in">RegExp</span>,<span class="comment">// 如果资源（或目录）符合 resourceRegExp 正则表达式，插件会替换默认资源为 newContentResource</span></span><br><span class="line">  newContentResource?: string,<span class="comment">// 如果 newContentResource 为相对路径，会相对于前一匹配资源路径去解析</span></span><br><span class="line">  newContentRecursive?: boolean,<span class="comment">// 是否使用递归查找</span></span><br><span class="line">  newContentRegExp?: <span class="built_in">RegExp</span>,<span class="comment">// 用于筛选新上下文里的资源</span></span><br><span class="line">  newContentCallback?: <span class="function"><span class="params">data</span> =&gt;</span> <span class="keyword">void</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例</span></span><br><span class="line"><span class="keyword">new</span> webpack.ContextReplacementPlugin(<span class="regexp">/moment[\/\\]locale$/</span>, /de|fr|hu/)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">new</span> webpack.ContextReplacementPlugin，替换(</span><br><span class="line">  resourceRegExp: <span class="built_in">RegExp</span>,</span><br><span class="line">  newContentCallback?: <span class="function"><span class="params">data</span> =&gt;</span> <span class="keyword">void</span><span class="comment">// 首参为为上下文模块工厂(ContextModuleFactory)的 data 对象，需要覆写该对象的 request 属性</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例</span></span><br><span class="line"><span class="keyword">new</span> webpack.ContextReplacementPlugin(<span class="regexp">/^\.\/locale$/</span>, (context) =&gt; &#123;</span><br><span class="line">  <span class="keyword">if</span> (!<span class="regexp">/\/moment\//</span>.test(context.context)) &#123; <span class="keyword">return</span>; &#125;</span><br><span class="line">  <span class="built_in">Object</span>.assign(context, &#123;</span><br><span class="line">    regExp: <span class="regexp">/^\.\/\w+/</span>,</span><br><span class="line">    request: <span class="string">'../../locale'</span>, <span class="comment">// 相对路径</span></span><br><span class="line">  &#125;);</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line"><span class="keyword">new</span> webpack.ContextReplacementPlugin(</span><br><span class="line">  resourceRegExp: <span class="built_in">RegExp</span>,</span><br><span class="line">  newContentResource: string,</span><br><span class="line">  newContentCreateContextMap: object <span class="comment">// 将运行时请求(runtime-request)映射到编译时请求(compile-time request)</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 示例</span></span><br><span class="line"><span class="keyword">new</span> ContextReplacementPlugin(<span class="regexp">/selector/</span>, <span class="string">'./folder'</span>, &#123;</span><br><span class="line">  <span class="string">'./request'</span>: <span class="string">'./request'</span>,</span><br><span class="line">  <span class="string">'./other-request'</span>: <span class="string">'./new-request'</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="HtmlWebpackPlugin"><a href="#HtmlWebpackPlugin" class="headerlink" title="HtmlWebpackPlugin"></a>HtmlWebpackPlugin</h2><p>html-webpack-plugin 插件，创建 html 文件，自动加载打包资源。</p>
<p>注入 html 模板的变量包含，htmlWebpackPlugin = { files, options }, webpack, webpackConfig。</p>
<p>支持的事件包含，html-webpack-plugin-before-html-generation, html-webpack-plugin-before-html-processing, html-webpack-plugin-alter-asset-tags, html-webpack-plugin-after-html-processing, html-webpack-plugin-after-emit, 同步事件 tml-webpack-plugin-alter-chunks。在自定义插件中使用。</p>
<p>参考文档：<a href="https://github.com/jantimon/html-webpack-plugin" target="_blank" rel="noopener">https://github.com/jantimon/html-webpack-plugin</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> HtmlWebpackPlugin(&#123;</span><br><span class="line">  title: <span class="string">''</span>,<span class="comment">// 注入 html 的 title</span></span><br><span class="line">  filename: <span class="string">'index.html'</span>,<span class="comment">// 影响加载资源的位置</span></span><br><span class="line">  template: <span class="string">''</span>,<span class="comment">// html, ejs, jade 模板的路径</span></span><br><span class="line">  inject: <span class="literal">true</span> | <span class="string">'head'</span> | <span class="string">'body'</span> | <span class="literal">false</span>,<span class="comment">// 静态资源注入位置，默认在 body 底层</span></span><br><span class="line">  favicon: <span class="string">''</span>,<span class="comment">// 图标路径</span></span><br><span class="line">  minify: &#123;&#125;,<span class="comment">// 传递给 html-minifier 的选项，用于优化输出</span></span><br><span class="line">  hash: <span class="literal">true</span> | <span class="literal">false</span>,<span class="comment">// 设为真时，js, css 资源名将加上 hash 值，用于刷新缓存</span></span><br><span class="line">  cache: <span class="literal">true</span>,<span class="comment">// 设为真时，只有文件变更时，才重新请求</span></span><br><span class="line">  showErrors: <span class="literal">true</span>,<span class="comment">// 显示错误</span></span><br><span class="line">  chunks: [],<span class="comment">// 添加 chunk，如用于单元测试的脚本</span></span><br><span class="line">  chunksSortMode: <span class="string">'auto'</span>,<span class="comment">// chunk 排序方式，可选值 'none' | 'auto' | 'dependency' |'manual' | &#123;function&#125; </span></span><br><span class="line">  excludeChunks: [],<span class="comment">// 避免引用某些 chunk</span></span><br><span class="line">  xhtml: <span class="literal">false</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="UglifyjsWebpackPlugin"><a href="#UglifyjsWebpackPlugin" class="headerlink" title="UglifyjsWebpackPlugin"></a>UglifyjsWebpackPlugin</h2><p>uglifyjs-webpack-plugin 插件，压缩 js 脚本。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> UglifyJSPlugin(&#123;</span><br><span class="line">  test,<span class="comment">// 定位资源</span></span><br><span class="line">  include,</span><br><span class="line">  exclude,</span><br><span class="line">  parallel: <span class="literal">false</span>,<span class="comment">// 使用多进程并行运行和文件缓存来提高构建速度，如 &#123; cache: true, workers: 2 &#125;，parallel.workers 为 cpu 核数</span></span><br><span class="line">  sourceMap: <span class="literal">false</span>,<span class="comment">// 生成 source map，会减慢编译的速度。cheap-source-map 选项不适用于此插件</span></span><br><span class="line">  uglifyOptions: &#123;<span class="comment">// 压缩选项，供 uglifyJs 使用</span></span><br><span class="line">    ie8: <span class="literal">false</span>,<span class="comment">// 支持 ie8</span></span><br><span class="line">    ecma: <span class="number">8</span>,<span class="comment">// es 语法版本号，可选项 5, 6, 7, 8，影响 parse, compress, output 选项</span></span><br><span class="line">    parse: &#123;&#125;,<span class="comment">// parse 选项</span></span><br><span class="line">    mangle: &#123;&#125;,<span class="comment">// 名称矫正??? </span></span><br><span class="line">    output: &#123;<span class="comment">// 默认最佳压缩</span></span><br><span class="line">      comments: <span class="literal">false</span>,</span><br><span class="line">      beautify: <span class="literal">false</span></span><br><span class="line">    &#125;,</span><br><span class="line">    compress: &#123;&#125;,<span class="comment">// parse 选项</span></span><br><span class="line">    warnings: <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br><span class="line">  extractComments: <span class="literal">true</span>,<span class="comment">// 函数，提取注释</span></span><br><span class="line">  warningsFilter: <span class="literal">undefined</span><span class="comment">// 过滤警告，如 source =&gt; Boolean</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="ExtractTextWebpackPlugin"><a href="#ExtractTextWebpackPlugin" class="headerlink" title="ExtractTextWebpackPlugin"></a>ExtractTextWebpackPlugin</h2><p>extract-text-webpack-plugin 插件，提取 css 文件。</p>
<p>ExtractTextPlugin.extract 在已经存在的 loader 中，创建一个提取 css 的 loader。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> ExtractTextWebpackPlugin(filename | &#123; </span><br><span class="line">  id: string,<span class="comment">// 此插件实例的唯一 ident（仅限高级用途，默认情况下自动生成）</span></span><br><span class="line">  filename: string,<span class="comment">// 生成文件的文件名，占位符包含 [name], [id], [contenthash]。ExtractTextPlugin 对 每个入口 chunk 都生成一个对应的文件</span></span><br><span class="line">  allChunks: <span class="literal">false</span>,<span class="comment">// 默认情况下，从入口 chunk 提取 css。当使用 CommonsChunkPlugin，且使用 ExtractTextPlugin.extract 在公共 chunk 中有提取 css 时，allChunks 须置为真</span></span><br><span class="line">  disable: <span class="literal">false</span>,<span class="comment">// 禁用插件</span></span><br><span class="line">  ignoreOrder: <span class="literal">false</span>,<span class="comment">// 禁用检查</span></span><br><span class="line">  threshold: <span class="number">0</span>,<span class="comment">// 大于该值的文件将被压缩</span></span><br><span class="line">  minRatio: <span class="number">0.8</span>,<span class="comment">// 压缩比大于该值的将被压缩</span></span><br><span class="line">  deleteOriginalAssets: <span class="literal">false</span><span class="comment">// 是否删除原始资源</span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ExtractTextPlugin.extract</span></span><br><span class="line">ExtractTextPlugin.extract(&#123;</span><br><span class="line">  loader: <span class="string">'[name]-loader'</span>,</span><br><span class="line">  options: &#123;</span><br><span class="line">    use: [<span class="string">'css-loader'</span>, <span class="string">'sass-loader'</span>],<span class="comment">// 提取 css 文件，使用这些 loader 获得 css 模块</span></span><br><span class="line">    fallback: <span class="string">'style-loader'</span>,<span class="comment">// css 模块已取得，尚未提取前应用</span></span><br><span class="line">    publicPath: <span class="comment">// 重写此 loader 的 publicPath 配置</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或者</span></span><br><span class="line"><span class="keyword">const</span> ExtractTextPlugin = <span class="built_in">require</span>(<span class="string">'extract-text-webpack-plugin'</span>);</span><br><span class="line"><span class="keyword">const</span> extractCSS = <span class="keyword">new</span> ExtractTextPlugin(<span class="string">'stylesheets/[name]-one.css'</span>);</span><br><span class="line"><span class="keyword">const</span> extractLESS = <span class="keyword">new</span> ExtractTextPlugin(<span class="string">'stylesheets/[name]-two.css'</span>);</span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        use: extractCSS.extract([ <span class="string">'css-loader'</span>, <span class="string">'postcss-loader'</span> ])</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.less$/i</span>,</span><br><span class="line">        use: extractLESS.extract([ <span class="string">'css-loader'</span>, <span class="string">'less-loader'</span> ])</span><br><span class="line">      &#125;,</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  plugins: [</span><br><span class="line">    extractCSS,</span><br><span class="line">    extractLESS</span><br><span class="line">  ]</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="NpmInstallWebpackPlugin"><a href="#NpmInstallWebpackPlugin" class="headerlink" title="NpmInstallWebpackPlugin"></a>NpmInstallWebpackPlugin</h2><p>npm-install-webpack-plugin 插件，加载缺失的依赖。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> NpmInstallPlugin(&#123;</span><br><span class="line">  dev: <span class="literal">false</span>,<span class="comment">// 使用 --save 或者 --save-dev</span></span><br><span class="line">  peerDependencies: <span class="literal">true</span>,<span class="comment">// 安装缺少的 peerDependencies</span></span><br><span class="line">  quiet: <span class="literal">false</span>,<span class="comment">// 减少控制台日志记录的数量</span></span><br><span class="line">  npm: <span class="string">'tnpm'</span><span class="comment">// 包加载方式，默认 'npm'</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="I18nWebpackPlugin"><a href="#I18nWebpackPlugin" class="headerlink" title="I18nWebpackPlugin"></a>I18nWebpackPlugin</h2><p>i18n-webpack-plugin 插件，国际化???</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> I18nWebpackPlugin(&#123;</span><br><span class="line">  functionName: <span class="string">'__'</span>,<span class="comment">// 函数名</span></span><br><span class="line">  failOnMissing: <span class="literal">false</span>,<span class="comment">// 找不到映射文件时给予警告</span></span><br><span class="line">  hideMessage: <span class="literal">false</span><span class="comment">// 隐藏警告/错误信息</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="BabiliWebpackPlugin"><a href="#BabiliWebpackPlugin" class="headerlink" title="BabiliWebpackPlugin"></a>BabiliWebpackPlugin</h2><p>babili-webpack-plugin 插件，使用 babel-minify 根据浏览器是否支持 es5 最新特性，优化压缩代码。也可以在 babel-loader 配置中使用 babel-preset-minify 。比起 babel-loader 配置，babili-webpack-plugin 插件能优化全文件，包含不通过 babel-loader 加载的文件，即 node_modules 下的文件，以及由 webpack 生成的文件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> BabiliPlugin(</span><br><span class="line">  babiliOptions = &#123; </span><br><span class="line">    plugins:[], </span><br><span class="line">    presets:[] </span><br><span class="line">  &#125;, </span><br><span class="line">  overrides = &#123;</span><br><span class="line">    test: <span class="regexp">/\.js($|\?)/i</span>,<span class="comment">// 待包含的文件</span></span><br><span class="line">    comments: <span class="regexp">/@preserve|@licen(s|c)e/</span>,<span class="comment">// 置为 false，将移除注释</span></span><br><span class="line">    sourceMap: webpackConfig.devtool,</span><br><span class="line">    parserOpts: &#123;&#125;,</span><br><span class="line">    babel: <span class="built_in">require</span>(<span class="string">"babel-core"</span>),<span class="comment">// 用于替代 babel-core</span></span><br><span class="line">    babili: <span class="built_in">require</span>(<span class="string">'babel-preset-minify'</span>)</span><br><span class="line">  &#125;</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<h2 id="CompressionWebpackPlugin"><a href="#CompressionWebpackPlugin" class="headerlink" title="CompressionWebpackPlugin"></a>CompressionWebpackPlugin</h2><p>compression-webpack-plugin 插件，压缩静态资源。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> CompressionWebpackPlugin(&#123; </span><br><span class="line">  test: <span class="string">'.'</span>, </span><br><span class="line">  include: <span class="literal">undefined</span>,</span><br><span class="line">  exclude: <span class="literal">undefined</span>,</span><br><span class="line">  cache: <span class="literal">false</span>,<span class="comment">// 开启文件缓存</span></span><br><span class="line">  asset: [path].gz[query],<span class="comment">// 目标资源名称。[file] 会被替换成原始资源，[path] 会被替换成原始资源的路径，[query] 会被替换成查询字符串</span></span><br><span class="line">  filename: <span class="literal">false</span>,<span class="comment">// 函数，如 (asset) =&gt; asset</span></span><br><span class="line">  algorithm: <span class="string">'gzip'</span>,<span class="comment">// 压缩算法或算法名，如 (buffer, cb) =&gt; cb(buffer)</span></span><br><span class="line">  threshold: <span class="number">0</span>,<span class="comment">// 大于该值的文件将被压缩</span></span><br><span class="line">  minRatio: <span class="number">0.8</span>,<span class="comment">// 压缩比大于该值的将被压缩</span></span><br><span class="line">  deleteOriginalAssets: <span class="literal">false</span><span class="comment">// 是否删除原始资源</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="ZopfliWebpackPlugin"><a href="#ZopfliWebpackPlugin" class="headerlink" title="ZopfliWebpackPlugin"></a>ZopfliWebpackPlugin</h2><p>zopfli-webpack-plugin 插件，压缩资源。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">new</span> ZopfliWebpackPlugin(&#123; </span><br><span class="line">  asset: [path].gz[query],<span class="comment">// 目标资源名称。[file] 会被替换成原始资源，[path] 会被替换成原始资源的路径，[query] 会被替换成查询字符串</span></span><br><span class="line">  filename: <span class="literal">false</span>,<span class="comment">// 函数，如 (asset) =&gt; asset</span></span><br><span class="line">  algorithm: <span class="string">'gzip'</span>,<span class="comment">// 压缩算法或算法名，如 (buffer, cb) =&gt; cb(buffer)</span></span><br><span class="line">  threshold: <span class="number">0</span>,<span class="comment">// 大于该值的文件将被压缩</span></span><br><span class="line">  minRatio: <span class="number">0.8</span>,<span class="comment">// 压缩比大于该值的将被压缩</span></span><br><span class="line">  deleteOriginalAssets: <span class="literal">false</span><span class="comment">// 是否删除原始资源</span></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="ComponentWebpackPlugin"><a href="#ComponentWebpackPlugin" class="headerlink" title="ComponentWebpackPlugin"></a>ComponentWebpackPlugin</h2><p>不详。。。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/04/webpack/webpack加载器指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/04/webpack/webpack加载器指南/" itemprop="url">webpack加载器指南</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-04T00:00:00+08:00">2018-02-04</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端工程化/" itemprop="url" rel="index"><span itemprop="name">前端工程化</span></a></span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端工程化/webpack/" itemprop="url" rel="index"><span itemprop="name">webpack</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/04/webpack/webpack加载器指南/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/02/04/webpack/webpack加载器指南/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>加载器在 webpack 编译前预处理文件，链式调用多个加载器。</p>
<h2 id="babel-loader"><a href="#babel-loader" class="headerlink" title="babel-loader"></a>babel-loader</h2><p>babel-loader将 es6 降级为 es5。</p>
<p>参考文档：</p>
<p><a href="https://www.cnblogs.com/tugenhua0707/p/7863616.html" target="_blank" rel="noopener">Babel是如何编译JS代码的及理解抽象语法树(AST)</a></p>
<h3 id="options-选项"><a href="#options-选项" class="headerlink" title="options 选项"></a>options 选项</h3><p>参考文档：</p>
<p><a href="https://babeljs.cn/docs/usage/api/" target="_blank" rel="noopener">babel options</a>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 默认配置</span></span><br><span class="line">&#123;</span><br><span class="line">  plugins:[],<span class="comment">//	需要加载和使用的插件列表</span></span><br><span class="line">  presets: [],<span class="comment">//	需要加载和使用的 presets (一组插件) 列表</span></span><br><span class="line">  generatorOpts: &#123;&#125;,<span class="comment">// 包含要传递给 babel 代码生成器(babel-generator)的选项对象</span></span><br><span class="line">  parserOpts:&#123;&#125;,<span class="comment">// 需要传递给 babel 解析器，babylon 的选项对象</span></span><br><span class="line">  only: <span class="literal">null</span>,<span class="comment">// 待编译的文件，正则，字符串或数组形式</span></span><br><span class="line">  ignore: <span class="literal">null</span>,<span class="comment">// 无需编译的文件</span></span><br><span class="line">  minified: <span class="literal">false</span>,<span class="comment">// 保证输出最小化(不输出代码块最后一个分号，输出文字为字符串而不是转义字符串，安全情况下 new 后的 () 会被去除)</span></span><br><span class="line">  babelrc: <span class="literal">true</span>,<span class="comment">// 指定是否使用 .babelrc 和 babelignore 配置文件，命令行使用 --no-babelrc 代替</span></span><br><span class="line">  extends: <span class="literal">null</span>,<span class="comment">// 扩展 .babelrc 文件的路径</span></span><br><span class="line">  sourceType:	<span class="string">"module"</span>,<span class="comment">//	设置 babel 解析代码的模式。可以设置为 “script” 或 “module” </span></span><br><span class="line">  sourceRoot:	(moduleRoot),<span class="comment">//	所有 source 都是相对于 root 的</span></span><br><span class="line">  retainLines: <span class="literal">false</span>,<span class="comment">// 保留行号。这将导致代码变得很古怪，适用于不能使用 source map 的场景</span></span><br><span class="line">  sourceMaps: <span class="literal">false</span>,<span class="comment">//	如果为 true ，添加一个 map 属性在输出的返回值中。如果设置为 "inline" ，带有 sourceMappingURL 指令的注释被添加到返回代码的底部。如果设置为 "both" ，则会返回 map 属性并追加 source map 注释。命令行使用 --source-maps</span></span><br><span class="line">  sourceMapTarget: (filenameRelative),<span class="comment">//	在返回 souremap 时设置 file</span></span><br><span class="line">  inputSourceMap: <span class="literal">null</span>,<span class="comment">// 输出的 source map 将基于该 source map 对象</span></span><br><span class="line">  sourceFileName: (filenameRelative),<span class="comment">// 在返回的 source map 上设置 sources[0]</span></span><br><span class="line">  auxiliaryCommentAfter: <span class="literal">null</span>,<span class="comment">// 在所有非用户编写代码后添加注释</span></span><br><span class="line">  auxiliaryCommentBefore: <span class="literal">null</span>,<span class="comment">// 在所有非用户编写代码前添加注释</span></span><br><span class="line">  commets: <span class="literal">true</span>,<span class="comment">// 是否在生成的代码中添加注释</span></span><br><span class="line">  shouldPrintComment: <span class="literal">null</span>,<span class="comment">// 是否需要输出注释。具体调用为 shouldPrintComment(commentContents)。将覆盖 commets 选项</span></span><br><span class="line">  compact: <span class="string">'auto'</span>,<span class="comment">// 是否包含多余的空格符和换行符，当输入大于 500KB 时，compact 属性自动设置为真值</span></span><br><span class="line">  ast: <span class="literal">true</span><span class="comment">// 是否在返回对象包含 ast 抽象语法树 abstract syntax tree</span></span><br><span class="line">  code: <span class="literal">true</span>,<span class="comment">// 是否启用代码生成选项</span></span><br><span class="line">  env: &#123;&#125;,<span class="comment">// 配置给不同环境的选项。环境配置的优先级依次为 BABEL_ENV, NODE_ENV，默认'development'环境。env 配置如 &#123; env: &#123; 'product': /* options */ &#125; &#125;</span></span><br><span class="line">  filename: <span class="string">'unknown'</span>,<span class="comment">// 在错误信息是使用的文件名等</span></span><br><span class="line">  filenameRelative: (filename),<span class="comment">//	相对于 sourceRoot 的文件名</span></span><br><span class="line">  moduleId: <span class="literal">null</span>,<span class="comment">// 指定模块 ID 的自定义名称</span></span><br><span class="line">  moduleIds: <span class="literal">false</span>,<span class="comment">// 是否为模块指定明确的 ID。默认情况下，所有模块都是匿名的(不适用于 common 模块)</span></span><br><span class="line">  moduleRoot: (sourceRoot),<span class="comment">// AMD 模块格式化程序的可选前缀，可以被预先添加到模块定义的文件名当中</span></span><br><span class="line">  getModuleId: <span class="literal">null</span>,<span class="comment">// 指定回调函数 getModuleId(moduleName) 生成模块 ID。返回false，意味模块 ID 已被使用</span></span><br><span class="line">  highlightCode: <span class="literal">true</span>,<span class="comment">// ANSI 错误语法高亮显示</span></span><br><span class="line">  resolveModuleSource: <span class="literal">null</span>,<span class="comment">// 解析模块入口，例如 import "SOURCE"; 引入自定义值。具体调用为 resolveModuleSource(source, filename)</span></span><br><span class="line">  wrapPluginVisitorMethod: <span class="literal">null</span>,<span class="comment">// 可用于包装访问者模式的可选回调。注意: 这对于自我检查这样的事是有必要的，并且不需要实现任何方法。具体调用为 wrapPluginVisitorMethod(pluginAlias, visitorType, callback)</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="plugins-presets-插件"><a href="#plugins-presets-插件" class="headerlink" title="plugins presets 插件"></a>plugins presets 插件</h3><p>参考文档：</p>
<p><a href="https://babeljs.cn/docs/plugins/" target="_blank" rel="noopener">babel plugins</a>。</p>
<p>plugins 为编译时调用的插件，presets 为官方封装的插件集合。编译时，plugin 运行在 preset 前，plugin 顺序执行，preset 反序执行。配置时，’babel-plugin-‘, ‘babel-preset-‘ 前缀可以忽略，babel 将自动拼接，并在 node_modules 目录中查找。当 babel 插件不在工程目录中时，可以通过插件的绝对路径加以配置，如 “plugins”: [“./node_modules/asdf/plugin”]。插件选项配置通过将插件名称和选项对象放置在同一个数组中实现。</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">// 执行顺序为 "transform-decorators-legacy", "transform-class-properties"</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"plugins"</span>: [</span><br><span class="line">    <span class="string">"transform-decorators-legacy"</span>,</span><br><span class="line">    <span class="string">"transform-class-properties"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 执行顺序为 "stage-2", "react", "es2015"</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"presets"</span>: [</span><br><span class="line">    <span class="string">"es2015"</span>,</span><br><span class="line">    <span class="string">"react"</span>,</span><br><span class="line">    <span class="string">"stage-2"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 配置选项</span><br><span class="line">&#123;</span><br><span class="line">  <span class="attr">"plugins"</span>: [</span><br><span class="line">    [<span class="string">"transform-async-to-module-method"</span>, &#123;</span><br><span class="line">      <span class="attr">"module"</span>: <span class="string">"bluebird"</span>,</span><br><span class="line">      <span class="attr">"method"</span>: <span class="string">"coroutine"</span></span><br><span class="line">    &#125;]</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="presets-官方插件集合"><a href="#presets-官方插件集合" class="headerlink" title="presets 官方插件集合"></a>presets 官方插件集合</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  // env 包含es2015, es2016, es2017 及最新版本</span><br><span class="line">  // 参考文档：[](https://babeljs.cn/docs/plugins/preset-env/)</span><br><span class="line">  [<span class="string">"babel-preset-env"</span>,&#123;</span><br><span class="line">    "targets": &#123;&#125;,// 设定适配环境，如 &#123; node: "6.10" &#125;。支持的环境有 browsers, chrome, opera, edge, firefox, safari, ie, ios, android, node, electron。浏览器端清单 https://github.com/ai/browserslist，如 &#123; "chrome": 52, "browsers": ["last 2 versions", "safari 7"] &#125;。uglify 属性设置为 true，uglify-js 压缩脚本时已编译为 es5 语法</span><br><span class="line">    "spec": false,// 是否允许插件启用 "spec" 转换，更符合规范，编译较慢</span><br><span class="line">    "loose": false,// 是否允许插件启用 "loose" 转换</span><br><span class="line">    "modules": "commonjs",// 将es6模块语法转换为另一个模块类型。可选值为 "amd" | "umd" | "systemjs" | "commonjs" | false。false 将不会转换任何模块</span><br><span class="line">    "include": [],// 包含的插件。include 与 exclude 选项仅仅适用于 preset 中包含的插件。可配置为 ["transform-es2015-arrow-functions", "es6.map"]。"es6.map" 为 [Built-ins](https://github.com/babel/babel-preset-env/blob/master/data/built-in-features.js)</span><br><span class="line">    "exclude": [],// 移除的插件</span><br><span class="line">    "useBuiltIns": false// 是否在 env 中引入 babel-ployfill，以避免在模块中调用 import "babel-polyfill"。npm &gt; 3，babel 6</span><br><span class="line">  &#125;],</span><br><span class="line"></span><br><span class="line">  [<span class="string">"babel-preset-es2015"</span>,&#123;</span><br><span class="line">    <span class="attr">"loose"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"spec"</span>: <span class="literal">false</span>,</span><br><span class="line">    <span class="attr">"modules"</span>: <span class="string">"commonjs"</span></span><br><span class="line">  &#125;],</span><br><span class="line"></span><br><span class="line">  ["babel-preset-es2016",&#123; &#125;],</span><br><span class="line"></span><br><span class="line">  ["babel-preset-es2017",&#123; &#125;],</span><br><span class="line"></span><br><span class="line">  ["babel-preset-react",&#123; &#125;],</span><br><span class="line"></span><br><span class="line">  ["babel-preset-flow",&#123; &#125;],</span><br><span class="line"></span><br><span class="line">  // stage 3 候选：完成规范和浏览器初步实现。Stage 4 将到下一年度发行</span><br><span class="line">  ["babel-preset-stage-3",&#123; &#125;],</span><br><span class="line"></span><br><span class="line">  // stage 2  初稿: 完成初步规范。包含 preset-stage-3 所有插件</span><br><span class="line">  ["babel-preset-stage-2",&#123; &#125;],</span><br><span class="line"></span><br><span class="line">  // stage 1  提案: 初步尝试。包含 preset-stage-2, preset-stage-3 所有插件</span><br><span class="line">  ["babel-preset-stage-1",&#123; &#125;],</span><br><span class="line"></span><br><span class="line">  // stage 0  稻草人: 只是一个想法。包含 preset-stage-1, preset-stage-2, preset-stage-3 所有插件</span><br><span class="line">  ["babel-preset-stage-0",&#123; &#125;],</span><br><span class="line"></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h4 id="plugin-插件"><a href="#plugin-插件" class="headerlink" title="plugin 插件"></a>plugin 插件</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  // es3</span><br><span class="line">  [<span class="string">"babel-plugin-transform-es3-property-literals"</span>,&#123; &#125;],// 定义对象属性时包裹上双引号</span><br><span class="line">  [<span class="string">"babel-plugin-transform-es3-member-expression-literals"</span>,&#123; &#125;],// 使用对象属性时包裹上双引号</span><br><span class="line"></span><br><span class="line">  // es5</span><br><span class="line">  [<span class="string">"abel-plugin-transform-es5-property-mutators"</span>,&#123; &#125;],// 对象访问器属性 get, set 方法</span><br><span class="line"></span><br><span class="line">  // es2015</span><br><span class="line">  [<span class="string">"check-es2015-constants"</span>,&#123; &#125;],// 常量只读检查</span><br><span class="line">  [<span class="string">"transform-es2015-block-scoped-functions"</span>,&#123; &#125;],// 在块中声明的函数只在块中可用</span><br><span class="line">  ["transform-es2015-block-scoping",&#123;// let 块级作用域</span><br><span class="line">    "throwIfClosureRequired": false// for() 语句中定义的 let 在 &#123;&#125; 中使用，是否直接报错</span><br><span class="line">  &#125;],</span><br><span class="line">  [<span class="string">"transform-es2015-arrow-functions"</span>,&#123; </span><br><span class="line">    <span class="attr">"spec"</span>: <span class="literal">false</span></span><br><span class="line">  &#125;],// 箭头函数转换</span><br><span class="line">  ["transform-es2015-classes",&#123;// 类转换</span><br><span class="line">    "loose": false// loose 模式下，原型方法可枚举，且不能在子类中重复定义</span><br><span class="line">  &#125;],</span><br><span class="line">  ["transform-es2015-computed-properties",&#123; &#125;],// 对象计算属性转换，如 [x + 'foo'] 属性</span><br><span class="line">  ["transform-es2015-destructuring",&#123; &#125;],// 解构</span><br><span class="line">  ["transform-es2015-duplicate-keys",&#123; &#125;],// 将同名属性转换为计算属性，再由 transform-es2015-computed-properties 插件处理</span><br><span class="line">  ["transform-es2015-for-of",&#123; &#125;],// for of 语法</span><br><span class="line">  ["transform-es2015-function-name",&#123; &#125;],// function.name</span><br><span class="line">  ["transform-es2015-literals",&#123; &#125;],// 二进制、八进制整数，unicode 字面量</span><br><span class="line">  ["transform-es2015-modules-commonjs",&#123; &#125;],// 转换成 commonjs 模块。使用 babel-plugin-add-module-exports 插件，避免使用 require("your-module").default 调用模块，可直接使用 require("your-module")</span><br><span class="line">  ["transform-es2015-object-super",&#123; &#125;],// super 父类转换???</span><br><span class="line">  ["transform-es2015-parameters",&#123; &#125;],// 解构函数参数，设置默认值，...arr支持。默认使用 let 处理参数，需要配合使用 transform-es2015-block-scoping 插件</span><br><span class="line">  ["transform-es2015-shorthand-properties",&#123; &#125;],// 允许 &#123; a &#125; 方式赋值对象，转换为 &#123; a: a &#125;</span><br><span class="line">  ["transform-es2015-spread",&#123;// ...a</span><br><span class="line">    "loose": false</span><br><span class="line">  &#125;],</span><br><span class="line">  ["transform-es2015-sticky-regex",&#123; &#125;],// 正则表达式转换为正则构造函数形式</span><br><span class="line">  [<span class="string">"transform-es2015-template-literals"</span>,&#123; </span><br><span class="line">    "loose": false,// 设置为true时，模板字符串对象不会被 frozen</span><br><span class="line">    "spec": false// 是否用 String 函数包裹模板字符串内变量</span><br><span class="line">  &#125;],// 模板字符串</span><br><span class="line">  ["transform-es2015-typeof-symbol",&#123; &#125;],// typeof Symbol() === "symbol" 语法支持</span><br><span class="line">  ["transform-es2015-unicode-regex",&#123; &#125;],// unicode 正则???</span><br><span class="line">  ["transform-regenerator",&#123;// 生成器函数，页面需要引入 babel-ployfill 或 regenerator-runtime 运行时脚本。使用 async 函数，需要添加 syntax-async-functions 插件</span><br><span class="line">    "asyncGenerators": true,</span><br><span class="line">    "generators": true,</span><br><span class="line">    "async": true</span><br><span class="line">  &#125;],</span><br><span class="line"></span><br><span class="line">  // es2016</span><br><span class="line">  ["transform-exponentiation-operator",&#123; &#125;],// ** 求幂</span><br><span class="line"></span><br><span class="line">  // es2017</span><br><span class="line">  ["syntax-trailing-function-commas",&#123; &#125;],// 函数参数后加','，添加参数时只有一行改变，方便git diff</span><br><span class="line">  ["transform-async-to-generator",&#123; &#125;],// 将 acync 函数转化为生成器函数</span><br><span class="line"></span><br><span class="line">  // react 包含 preset-flow, babel-plugin-syntax-jsx, babel-plugin-transform-react-jsx, babel-plugin-transform-react-display-name</span><br><span class="line">  // preset-flow 包含 transform-flow-strip-types 插件，其余均为插件</span><br><span class="line">  ["transform-flow-strip-types",&#123; &#125;],// 移除 flow 类型，但不作类型校验，类型校验需要使用 flow 或另外的插件。如 function foo(one: any, two: number, three?): string &#123;&#125; 将转换为 function foo(one, two, three) &#123;&#125;</span><br><span class="line">  ["babel-plugin-syntax-jsx",&#123; &#125;],// 解析 JSX</span><br><span class="line">  ["babel-plugin-transform-react-jsx",&#123; &#125;],// 将 JSX 转换为 react 函数</span><br><span class="line">  ["babel-plugin-transform-react-display-name",&#123; &#125;],// 调用 React.createClass 或 createReactClass 函数时自动添加 displayName，如 var bar = createReactClass(&#123;&#125;) 将转换为 var bar = createReactClass(&#123; displayName: "bar" &#125;)</span><br><span class="line"></span><br><span class="line">  // flow</span><br><span class="line">  ["transform-flow-strip-types",&#123; &#125;],// react preset 包含</span><br><span class="line"></span><br><span class="line">  // stage 3</span><br><span class="line">  ["transform-object-rest-spread",&#123; &#125;],// ...a 语法支持</span><br><span class="line">  ["transform-async-generator-functions",&#123; &#125;],// async 函数转换为生成器函数</span><br><span class="line"></span><br><span class="line">  // stage 2</span><br><span class="line">  ["syntax-dynamic-import",&#123; &#125;],// import() 支持变量</span><br><span class="line">  ["transform-class-properties",&#123; &#125;],// 类静态属性，实例属性、方法等</span><br><span class="line"></span><br><span class="line">  // stage 1</span><br><span class="line">  ["transform-class-constructor-call",&#123; &#125;],// 类作为普通函数使用</span><br><span class="line">  ["transform-export-extensions",&#123; &#125;],// export * as ns from 'mod'; export v from 'mod'; 语法支持</span><br><span class="line"></span><br><span class="line">  // stage 0</span><br><span class="line">  ["transform-do-expressions",&#123; &#125;],// do &#123;&#125; 语法支持，构造块级作用域，最终执行语句作为返回值</span><br><span class="line">  ["transform-function-bind",&#123; &#125;],// obj::func 转换为 func.bind(obj)；::obj.func 转换为 obj.func.bind(obj)；obj::func(val) 转换为 func.call(obj, val)；::obj.func(val) 转换为 obj.func.call(obj, val)</span><br><span class="line">  </span><br><span class="line">  // 模块</span><br><span class="line">  ["es2015-modules-amd",&#123; &#125;],// 将模块导出为 amd 模块</span><br><span class="line">  ["es2015-modules-commonjs",&#123;// 将模块导出为 commonjs 模块</span><br><span class="line">    "loose": false,// loose 模式下，import, export 可在全局使用；非 loose 模式下，只能在外层使用。非 loose 模式下，通过 defineProperty 语句注入不可枚举的 __esModule 属性；loose 模式下，通过赋值注入 __esModule 属性</span><br><span class="line">    "strict": false,// strict 属性置为真，将阻止导出 __esModule 属性</span><br><span class="line">    "noInterop": false// 加载模块时，是否不使用 function _interopRequireDefault(obj) &#123; return obj &amp;&amp; obj.__esModule ? obj : &#123; default: obj &#125;; &#125;，适用于不需要 default 属性的场景</span><br><span class="line">  &#125;],</span><br><span class="line">  ["es2015-modules-systemjs",&#123;// 将模块导出为 SystemJS 模块</span><br><span class="line">    "systemGlobal": "SystemJS"</span><br><span class="line">  &#125;],</span><br><span class="line">  ["es2015-modules-umd",&#123;// 依据 define, exports 变量有无，分别导出 amd, commonjs 等模块</span><br><span class="line">     "globals": &#123;&#125;,// 用于设置导出变量名，如 "globals": &#123; "es6-promise": "Promise" &#125;</span><br><span class="line">     "exactGlobals": true// 规范化注入的全局变量???</span><br><span class="line">  &#125;],</span><br><span class="line"></span><br><span class="line">  // 实验阶段</span><br><span class="line">  ["async-generator-functions",&#123; &#125;],// stage 3 包含</span><br><span class="line">  ["transform-async-to-module-method",&#123; &#125;],// 将 async 函数转换为 Bluebird coroutine</span><br><span class="line">  ["class-properties",&#123; &#125;],// stage 2 包含</span><br><span class="line">  ["transform-decorators-legacy",&#123; &#125;],// 装饰器，babel 7 包含在 stage 0 中。平常开发时，需要通过 plugins 配置注入</span><br><span class="line">  ["do-expressions",&#123; &#125;],// stage 0 包含</span><br><span class="line">  ["export-extensions",&#123; &#125;],// stage 1 包含</span><br><span class="line">  ["function-bind",&#123; &#125;],// stage 0 包含</span><br><span class="line">  ["object-rest-spread",&#123; &#125;],// stage 3 包含</span><br><span class="line"></span><br><span class="line">  // Minification</span><br><span class="line">  ["transform-inline-environment-variables",&#123;// 将环境变量以字符串形式注入模块</span><br><span class="line">    "include": [],// 注入的环境变量，如 "include": [ "NODE_ENV" ]</span><br><span class="line">    "exclude": []// 移除的环境变量</span><br><span class="line">  &#125;],</span><br><span class="line">  ["transform-inline-consecutive-adds",&#123; &#125;],// 将对象属性的赋值和数组 push 方法调用过程移入声明中，前提赋值和 push 紧跟在声明后</span><br><span class="line">  ["member-expression-literals",&#123;&#125;],// 对象属性名含关键字，以计算属性 [''] 表示；不含，采用 . 分割形式</span><br><span class="line">  ["transform-minify-booleans",&#123;&#125;],// 以 !0 代替 true，!1 代替 false</span><br><span class="line">  ["minify-dead-code-elimination",&#123;// 精简无用代码</span><br><span class="line">    "keepFnName": true,// 防止插件删除函数名</span><br><span class="line">    "keepFnArgs": true,// 防止插件删除函数参数</span><br><span class="line">    "keepClassName": true,// 防止插件删除类名</span><br><span class="line">  &#125;],</span><br><span class="line">  ["minify-flip-comparisons",&#123;&#125;],// 精简翻转输出，基于重复的内容进行压缩算法优化，例如 gzip。bar !== null 转换为 null !== bar</span><br><span class="line">  ["minify-guarded-expressions",&#123;&#125;],// 精简守护表达式，针对 &amp;&amp;, ||，0 &amp;&amp; new Foo() 转换为 0</span><br><span class="line">  ["minify-infinity",&#123;&#125;],// 精简无穷大，Infinity 转换为 1/0</span><br><span class="line">  ["minify-mangle-names",&#123;&#125;],// 根据作用域精简一次性使用的变量名</span><br><span class="line">  ["minify-numeric-literals",&#123;&#125;],// 通过科学计数法精简数值字面量</span><br><span class="line">  ["minify-replace",&#123;// 用给定节点替换变量</span><br><span class="line">    "identifierName": null,// 待替换的变量名，如 __DEV__</span><br><span class="line">    "replacement": &#123;&#125;// 替换规则，如 &#123; type: "numericLiteral", value: 0, &#125;，效果是将 __DEV__ 转换为 0</span><br><span class="line">  &#125;],</span><br><span class="line">  ["minify-simplify",&#123;&#125;],// 简化，if (x) a(); 将转换为 x &amp;&amp; a()，Number(foo) 将转换为 +foo</span><br><span class="line">  ["minify-type-constructors",&#123;// 将构造函数转化为字面量，不推荐在 IE8 中使用</span><br><span class="line">    "array": true,// 是否启用 Array 构造函数</span><br><span class="line">    "boolean": true,// 是否启用 Boolean 构造函数</span><br><span class="line">    "number": true,// 是否启用 Number 构造函数</span><br><span class="line">    "object": true,// 是否启用 Object 构造函数</span><br><span class="line">    "string": true// 是否启用 String 构造函数</span><br><span class="line">  &#125;],</span><br><span class="line">  ["transform-node-env-inline",&#123;&#125;],// 将 process.env.NODE_ENV === "development"; 转换为 true | false</span><br><span class="line">  ["transform-property-literals",&#123;&#125;],// 对非关键字属性取出双引号</span><br><span class="line">  ["transform-regexp-constructors",&#123;&#125;],// 正则构造函数转换为正则表达式</span><br><span class="line">  ["transform-remove-console",&#123;&#125;],// 移除console</span><br><span class="line">  ["transform-remove-debugger",&#123;&#125;],// 移除debugger</span><br><span class="line">  ["simplify-comparison-operators",&#123;&#125;],// 当比较类型相同时，将 ===, !== 转换为 ==, !=</span><br><span class="line">  ["transform-undefined-to-void",&#123;&#125;],// 将 undefined 转换为 void 0</span><br><span class="line"></span><br><span class="line">  // react</span><br><span class="line">  ["transform-react-constant-elements",&#123;&#125;],// 将常量元素(作为返回值)提取到最外层，如 const Hr = () =&gt; &#123; return &lt;hr className="hr" /&gt;; &#125;; 将转换为 const _ref = &lt;hr className="hr" /&gt;; const Hr = () =&gt; &#123; return _ref; &#125;; 若元素包含 ...props 或 ref 属性，将不予转换</span><br><span class="line">  ["transform-react-display-name",&#123;&#125;],// react preset 包含</span><br><span class="line">  ["transform-react-inline-elements",&#123;&#125;],// 将 React.createElement 转换为 babelHelpers.jsx，如 &lt;Baz foo="bar" key="1"&gt;&lt;/Baz&gt;; 将转换为 babelHelpers.jsx(Baz, &#123; foo: "bar" &#125;, "1"); 若元素包含 ...props 或 ref 属性，将不予转换</span><br><span class="line">  ["transform-react-jsx",&#123;&#125;],// react preset 包含</span><br><span class="line">  ["transform-react-jsx-compat",&#123;&#125;],// 将 JSX 转换为 React Pre-0.12 函数，如 var profile = &lt;div&gt;&lt;img src="avatar.png" class="profile" /&gt;&lt;/div&gt;; 将转换为 var profile = React.DOM.div(null, React.DOM.img(&#123; src: "avatar.png", "class": "profile" &#125;) );</span><br><span class="line">  ["transform-react-jsx-self",&#123;&#125;],// JSX 元素中添加 __self 属性为 this，以便于 react 运行时报错</span><br><span class="line">  ["transform-react-jsx-source",&#123;&#125;],// JSX 元素中添加 __source 属性为 &#123; fileName: 'this/file.js', lineNumber: 10 &#125; 等，以便于 react 运行时报错</span><br><span class="line"></span><br><span class="line">  // 其他</span><br><span class="line">  ["transform-eval",&#123;&#125;],// eval("(() =&gt; 'foo')"); 将转换为 eval("(function () &#123; return 'foo'; &#125;)");</span><br><span class="line">  ["transform-flow-comments",&#123;&#125;],// 将 flow 类型说明转换为注释???</span><br><span class="line">  ["transform-flow-strip-types",&#123;&#125;],// react, flow preset 包含</span><br><span class="line">  ["transform-jscript",&#123;&#125;],// 将函数表达式通过自调用匿名函数赋值</span><br><span class="line">  ["transform-object-assign",&#123;&#125;],// 将 Object.assign 函数转换为 ... 语句，不适用于 const &#123; assign &#125; = Object场景</span><br><span class="line">  ["transform-object-set-prototype-of-to-assign",&#123;&#125;],// 将 Object.setPrototypeOf 转换为 ... 语句</span><br><span class="line">  ["transform-proto-to-assign",&#123;&#125;],// 对象 __proto__ 赋值转换为 ... 语句</span><br><span class="line">  ["transform-regenerator",&#123;&#125;],// es2015 包含</span><br><span class="line">  ["transform-runtime",&#123;// 无需通过污染全局对象调用最新的 api，模块需要注入 babel-runtime。参考文档：[tranform-runtime](https://babeljs.cn/docs/plugins/transform-runtime/)</span><br><span class="line">    "helpers": true,// 是否内置 classCallCheck, extends 等。模块为 babel-runtime/helpers</span><br><span class="line">    "polyfill": true,// 是否内置 Promise, Set, Map, Symbol 等。模块为 babel-runtime/core-js</span><br><span class="line">    "regenerator": true,// 是否内置生成器函数，async 函数。模块为 babel-runtime/regenerator</span><br><span class="line">    "moduleName": "babel-runtime"// 改变模块名，import 相应作改变</span><br><span class="line">  &#125;],// JSX 元素中添加 __self 属性为 this，以便于 react 运行时报错</span><br><span class="line">  ["transform-strict-mode",&#123;&#125;],// 转换为严格模式</span><br><span class="line">  ["external-helpers",&#123;&#125;],// 将 babel 中的 helpers 通过 babel-cli 导出为独立文件，然后在页面直接加载</span><br><span class="line"></span><br><span class="line">  // ant-design</span><br><span class="line">  [<span class="string">"babel-plugin-import"</span>,&#123;</span><br><span class="line">    <span class="attr">"libraryName"</span>: <span class="string">"antd"</span>,</span><br><span class="line">    <span class="attr">"style"</span>: <span class="literal">true</span></span><br><span class="line">  &#125;],</span><br><span class="line">  [<span class="string">"babel-plugin-import"</span>,&#123;</span><br><span class="line">    <span class="attr">"libraryName"</span>: <span class="string">"antd-mobile"</span>,</span><br><span class="line">    <span class="attr">"style"</span>: <span class="string">"css"</span></span><br><span class="line">  &#125;],</span><br><span class="line"></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<h2 id="awesome-typescript-loader"><a href="#awesome-typescript-loader" class="headerlink" title="awesome-typescript-loader"></a>awesome-typescript-loader</h2><p>编译 typescript。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [&#123;</span><br><span class="line">      test: <span class="regexp">/\.tsx?$/</span>,</span><br><span class="line">      loader: <span class="string">'awesome-typescript-loader'</span>,</span><br><span class="line">      options: &#123;</span><br><span class="line">        silent: <span class="literal">false</span>,<span class="comment">// 是否打印日志</span></span><br><span class="line">        compiler: <span class="string">'typescript'</span>,<span class="comment">// 选择编译器</span></span><br><span class="line">        useTranspileModule: <span class="literal">false</span>,<span class="comment">// 启用 transpileModule 模式???</span></span><br><span class="line">        instance: <span class="string">'at-loader'</span>,<span class="comment">// 使用多个编译器???</span></span><br><span class="line">        configFileName: <span class="string">'tsconfig.json'</span>,<span class="comment">// 配置文件名</span></span><br><span class="line">        transpileOnly: <span class="literal">false</span>,<span class="comment">// 置为真，跳过类型校验</span></span><br><span class="line">        errorsAsWarnings: <span class="literal">false</span>,<span class="comment">// 以警告方式对待错误</span></span><br><span class="line">        forceIsolatedModules: <span class="literal">false</span>,<span class="comment">// 模块不能包含依赖</span></span><br><span class="line">        ignoreDiagnostics: [],<span class="comment">// 跳过错误，如 [8014] 将跳过 stage-1 错误</span></span><br><span class="line">        useBabel: <span class="literal">false</span>,<span class="comment">// 使用 babel-loader</span></span><br><span class="line">        babelOptions: &#123;&#125;,<span class="comment">// 配置 babel-loader 选项</span></span><br><span class="line">        babelCore: <span class="literal">undefined</span>,<span class="comment">// @babel/core 路径。@babel/core 不在 node_modules 中需要配置；babel 7 需要配置为 "@babel/core"</span></span><br><span class="line">        useCache: <span class="literal">false</span>,<span class="comment">// 使用缓存，提升速度，供 babel-loader 使用</span></span><br><span class="line">        usePrecompiledFiles: <span class="literal">false</span>,<span class="comment">// 启用预编译文件</span></span><br><span class="line">        cacheDirectory: <span class="string">'.awcache'</span>,<span class="comment">// 缓存目录</span></span><br><span class="line">        reportFiles: []<span class="comment">// 诊断报道???，如 [ "src/**/*.&#123;ts,tsx&#125;" ]</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="vue-loader"><a href="#vue-loader" class="headerlink" title="vue-loader"></a>vue-loader</h2><p>编译 vue 组件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [&#123;</span><br><span class="line">      test: <span class="regexp">/\.vue?$/</span>,</span><br><span class="line">      loader: <span class="string">'awesome-typescript-loader'</span>,</span><br><span class="line">      options: &#123;</span><br><span class="line">        loaders: &#123;<span class="comment">// 组件各部分加载器</span></span><br><span class="line">          js: <span class="string">'babel-loader!eslint-loader'</span>,</span><br><span class="line">          template: <span class="string">'html-loader'</span>,</span><br><span class="line">          css: <span class="string">'style-loader!css-loader!less-loader'</span></span><br><span class="line">        &#125;,</span><br><span class="line">        preLoaders: &#123;&#125;,<span class="comment">// 在 loaders 之前处理</span></span><br><span class="line">        postLoaders: &#123;&#125;,</span><br><span class="line">        postcss: [],<span class="comment">// 指定要应用于 .vue 文件中 CSS 的自定义 PostCSS 插件。在 11.0.0+ 版本中，推荐使用 PostCSS 配置文件代替。也可使用对象配置，如 &#123; plugins: [...],  options: &#123; parser: 'sugarss' &#125;, config: &#123; path: path.resolve('./src') &#125;, useConfigFile: false &#125;，config.path 指定加载 PostCSS 配置文件的路径或目录，config.ctx 指定为 PostCSS 插件提供的上下文，useConfigFile 是否禁用配置文件</span></span><br><span class="line">        cssSourceMap: <span class="literal">false</span>,<span class="comment">// 是否开启 CSS 的 source maps，关闭可提升编译速度，避免 css-loader 的 some relative path related bugs。webpack 配置中没有 devtool 的情况下自动设置为 false</span></span><br><span class="line">        esModule: <span class="literal">false</span>,<span class="comment">// 是否导出兼容 esModule 的代码。默认导出 commonjs 格式，像 module.exports = ....。esModule 为真时，导出 exports.__esModule = true; exports = ...，适用于与 Babel 以外的 transpiler 互操作，比如 TypeScript</span></span><br><span class="line">        preserveWhitespace: <span class="literal">true</span>,<span class="comment">// 置为否值，模版中 HTML 标签之间的空格将会被忽略</span></span><br><span class="line">        compilerModules: [],<span class="comment">// 为 vue-template-compiler 配置 modules 选项</span></span><br><span class="line">        compilerDirectives: [],<span class="comment">// 为 vue-template-compiler 配置 directives 选项</span></span><br><span class="line">        transformToRequire: &#123; <span class="attr">img</span>: <span class="string">'src'</span>, <span class="attr">image</span>: <span class="string">'xlink:href'</span> &#125;,<span class="comment">// 在模版编译过程中，编译器可以将某些属性，如 src 路径，转换为 require 调用。供 html-loader 使用</span></span><br><span class="line">        buble: &#123;&#125;,<span class="comment">// 配置 buble-loader 的选项 (如果存在)，并且 buble 编译传递模板渲染函数???</span></span><br><span class="line">        extractCSS: <span class="literal">true</span>,<span class="comment">// 使用 extract-text-webpack-plugin 自动提取 CSS。值可以为真，或 ExtractTextPlugin 插件的一个实例</span></span><br><span class="line">        optimizeSSR: <span class="literal">false</span><span class="comment">// 渲染函数将会把返回的 vdom 树的一部分编译为字符串，适用于服务器端渲染</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="style-loader"><a href="#style-loader" class="headerlink" title="style-loader"></a>style-loader</h2><p>配合 css-loader 一起使用。style-loader 用于将样式以 style 标签注入到页面中，同时 import 时将生成类名的 hash 值(标识符)对象；style-loader/url 模块将以 link 注入到页面中。style-loader/useable 模块将延迟注入页面，直到 import style from ‘./file.css’; style.use();// =style.ref() 中 use, ref 方法被调用时，才注入到页面中。当调用unuse, unref 方法时，将从页面上删除。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          &#123; </span><br><span class="line">            loader: <span class="string">"style-loader"</span>,</span><br><span class="line">            options: &#123;</span><br><span class="line">              base: <span class="literal">true</span>,<span class="comment">// 设置模块 ID 基础，生成 ID 大于该值。当使用 DllPlugin 编译 css 时，用于避免多个编译结果的 ID 冲突，实现是 多个编译配置设置不同的 ID 范围值</span></span><br><span class="line">              attrs: &#123;&#125;,<span class="comment">// 添加自定义属性到注入页面的 style, link 标签中</span></span><br><span class="line">              transform: <span class="literal">false</span>,<span class="comment">// 转换/条件加载 CSS，通过传递转换/条件函数。用于载入页面前修改 css，函数返回 false 将不会加载 css 。配置如 css =&gt; css.replace('.classNameA', '.classNameB')。transform 也可配置为脚本的路径</span></span><br><span class="line">              insertAt: <span class="string">"bottom"</span>,<span class="comment">// 在给定位置插入 style 节点，可选值 "bottom", "top"</span></span><br><span class="line">              insertInto: <span class="string">"&lt;head&gt;"</span>,<span class="comment">// 在给定标签处插入 style 节点，值可以是 css 选择器，或 ShadowRoot???</span></span><br><span class="line">              singleton: <span class="literal">true</span>,<span class="comment">// 重用 style 标签插入 css 脚本，否则每个样式文件插入一个 style 标签</span></span><br><span class="line">              sourceMap: <span class="literal">false</span>,<span class="comment">// 是否启用 SourceMap，css 脚本将生成 Blob，相对路径将无法正常工作。解决方法是设置 publicPath 属性或将 convertToAbsoluteUrls 置为真???</span></span><br><span class="line">              convertToAbsoluteUrls: <span class="literal">false</span><span class="comment">// 启用 SourceMap 后，将相对 url 转换为绝对 url</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;,</span><br><span class="line">          &#123; <span class="attr">loader</span>: <span class="string">"css-loader"</span> &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.url\.css$/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          &#123; <span class="attr">loader</span>: <span class="string">"style-loader/url"</span> &#125;,</span><br><span class="line">          &#123; <span class="attr">loader</span>: <span class="string">"css-loader"</span> &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.useable\.css$/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          &#123;</span><br><span class="line">            loader: <span class="string">"style-loader/useable"</span></span><br><span class="line">          &#125;,</span><br><span class="line">          &#123; <span class="attr">loader</span>: <span class="string">"css-loader"</span> &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="css-loader"><a href="#css-loader" class="headerlink" title="css-loader"></a>css-loader</h2><p>用于解析 css 脚本中的 @import, url() 语句，附加的资源文件调用 import, require 加载并解析。import, url() 语句解析时，根据 webpack 配置将调用对应的 file-loader, url-loader 加载器。因此 css-loader 基于 file-loader, url-loader 加载器。</p>
<p>可以直接将 css-loader 的结果作为字符串使用，例如 Angular 的组件样式???。如果有 SourceMap，它们也将包含在字符串结果中。</p>
<p>对使用 extract-text-webpack-plugin 预渲染的场景，应使用 css-loader/locals，而不是 style-loader!css-loader。它不会嵌入 CSS，但只导出标识符映射；由 extract-text-webpack-plugin 提取 css 后，再通过 link 标签嵌入页面。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 'css-loader' 导入资源转化为字符串，由开发者在页面中添加 link 标签后使用</span></span><br><span class="line">&#123;</span><br><span class="line">   test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">   use: [</span><br><span class="line">     <span class="string">'to-string-loader'</span>,</span><br><span class="line">     <span class="string">'css-loader'</span></span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line"><span class="keyword">const</span> css = <span class="built_in">require</span>(<span class="string">'./test.css'</span>).toString();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line">&#123;</span><br><span class="line">   test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">   use: [</span><br><span class="line">     <span class="string">'file-loader?name=[name].[ext]'</span></span><br><span class="line">     <span class="string">'handlebars-loader'</span>, <span class="comment">// handlebars loader expects raw resource string</span></span><br><span class="line">     <span class="string">'extract-loader'</span>,<span class="comment">// 将 html, css 提取为纯粹的字符串，通过 handlebars 处理，由 file 注入页面</span></span><br><span class="line">     &#123;</span><br><span class="line">       loader: <span class="string">'css-loader'</span>,</span><br><span class="line">       options: &#123;</span><br><span class="line">         root: <span class="string">"/"</span>,<span class="comment">// 以 / 开头的 URL 默认不会被转译，设置 root 为 "."，将 /image.png 转换为 ./image.png</span></span><br><span class="line">         url: <span class="literal">true</span>,<span class="comment">// 是否编译 css 文件中 url() 语句</span></span><br><span class="line">         alias: &#123;&#125;,<span class="comment">// 别名，便于 import 导入</span></span><br><span class="line">         <span class="keyword">import</span>: <span class="literal">true</span>,<span class="comment">// 是否编译 css 文件中 @import 语句</span></span><br><span class="line">         modules: <span class="literal">false</span>,<span class="comment">// 是否启用 css-modules</span></span><br><span class="line">         minimize: <span class="literal">false</span>,<span class="comment">// 是否启用压缩，压缩通过 cssnano 实现。[cssnano 文档](http://cssnano.co/guides/)</span></span><br><span class="line">         sourceMap: <span class="literal">false</span>,<span class="comment">// 是否启用SourceMap</span></span><br><span class="line">         camelCase: <span class="literal">false</span>,<span class="comment">// 以驼峰化式类名导出类名。可选值有 true 类名将被驼峰化，'dashes' 只有破折号被驼峰化，'only' 类名将被驼峰化，初始类名从映射中移除，'dashesOnly' 只有破折号被驼峰化，初始类名从映射中移除</span></span><br><span class="line">         importLoaders: <span class="number">0</span>,<span class="comment">// 在 css-loader 前应用的加载器数量。css-loader 前有 postcss-loader 时，设置为 1；css-loader 前有 postcss-loader, sass-loader，设置为 2</span></span><br><span class="line">         localIdentName: [hash:base64],<span class="comment">// 配置生成的标识符，import style from 'a.css' 加载时，作为style 属性的值，如 '[path][name]__[local]--[hash:base64:5]'</span></span><br><span class="line">         getLocalIdent: <span class="literal">false</span>,<span class="comment">// 指定生成标识符的函数，如 (context, localIdentName, localName, options) =&gt; &#123; return 'whatever_random_class_name' &#125;</span></span><br><span class="line">       &#125;</span><br><span class="line">     &#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line"><span class="keyword">const</span> css = <span class="built_in">require</span>(<span class="string">'./test.css'</span>).toString();</span><br></pre></td></tr></table></figure>
<h3 id="css-modules"><a href="#css-modules" class="headerlink" title="css-modules"></a>css-modules</h3><p>启用启用 css-modules 时，会产生局部作用域 CSS，使用 :global(…) 或 :global 设置为全局作用域，类名将不会转换为标识符；使用 :local(…) 或 :locale 设置为局部，类名将转换为标识符。局部作用域的类名建议使用驼峰式书写。</p>
<p>样式属性中可使用 composes 属性，用于向一个类注入另一个类(该类可以是另一个 css 文件中的类)的样式。一个类下，composes 属性可设置多个。</p>
<figure class="highlight css"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">// :local 为局部作用域，类名将转换为标识符，import 加载时生成映射形式；:global为全局作用域，类名保持不变</span><br><span class="line"><span class="selector-pseudo">:local(.className)</span> &#123;</span><br><span class="line">  <span class="attribute">composes</span>: edit hightlight from <span class="string">'./edit.css'</span>;</span><br><span class="line">  <span class="attribute">composes</span>: button from <span class="string">'module/button.css'</span>;</span><br><span class="line">  <span class="attribute">composes</span>: classFromThisModule;</span><br><span class="line">  <span class="attribute">background</span>: red;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-pseudo">:local(.subClass)</span> &#123;</span><br><span class="line">  <span class="attribute">composes</span>: className;</span><br><span class="line">  <span class="attribute">background</span>: blue;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="selector-pseudo">:local</span> <span class="selector-class">.className</span> <span class="selector-class">.subClass</span> <span class="selector-pseudo">:global(.global-class-name)</span> &#123; <span class="attribute">color</span>: blue; &#125;</span><br></pre></td></tr></table></figure>
<h2 id="postcss-loader"><a href="#postcss-loader" class="headerlink" title="postcss-loader"></a>postcss-loader</h2><p>对 css 文件自动拼接浏览器兼容性前缀等。参考文档：<a href="https://github.com/postcss/postcss-loader。" target="_blank" rel="noopener">https://github.com/postcss/postcss-loader。</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [&#123;</span><br><span class="line">      test: <span class="regexp">/\.style.js$/</span>,</span><br><span class="line">      use: [</span><br><span class="line">        <span class="string">'style-loader'</span>,</span><br><span class="line">        &#123; <span class="attr">loader</span>: <span class="string">'css-loader'</span>, <span class="attr">options</span>: &#123; <span class="attr">importLoaders</span>: <span class="number">1</span> &#125; &#125;,</span><br><span class="line">        &#123; </span><br><span class="line">          loader: <span class="string">'postcss-loader'</span>, </span><br><span class="line">          options: &#123; </span><br><span class="line">            parser: <span class="literal">undefined</span>,<span class="comment">// 设置 PostCSS 解析器，可选值 'sugarss'，可配置为函数</span></span><br><span class="line">            syntax: <span class="literal">undefined</span>,<span class="comment">// 设置 PostCSS 语法解析器，可选值 'sugarss'，可配置为函数</span></span><br><span class="line">            stringifier: <span class="literal">undefined</span>,<span class="comment">// 设置 PostCSS 字符串化，可选值 'midas'，可配置为函数</span></span><br><span class="line">            exec: <span class="literal">true</span>,<span class="comment">// 将 css-in-js 编译为 css</span></span><br><span class="line">            config: &#123;</span><br><span class="line">              path: <span class="literal">undefined</span>,<span class="comment">// postcss.config.js 文件路径，默认自动从 css 文件目录向上查找</span></span><br><span class="line">              ctx: &#123;<span class="comment">// postcss 配置的上下文，传入 postcss.config.js</span></span><br><span class="line">                env: <span class="string">'development'</span>,<span class="comment">// process.env.NODE_ENV</span></span><br><span class="line">                file: loader.resourcePath,<span class="comment">// 包含 extname扩展名, dirname目录名, basename文件名</span></span><br><span class="line">                options: &#123;&#125;<span class="comment">// 选项</span></span><br><span class="line">                ...<span class="comment">// 其余参数</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            plugins: [],<span class="comment">// 可配置为函数形式，如(loader) =&gt; [ require('postcss-import')(&#123; root: loader.resourcePath &#125;), require('postcss-cssnext')(), require('autoprefixer')(), require('cssnano')() ]</span></span><br><span class="line">            sourceMap: <span class="literal">false</span><span class="comment">// 是否启用 SourceMap，可选值 true, "inline"</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;,&#123;</span><br><span class="line"></span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// postcss.config.js 依旧生成 postcss-loader 选项</span></span><br><span class="line"><span class="built_in">module</span>.exports = <span class="function">(<span class="params">&#123; file, options, env &#125;</span>) =&gt;</span> (&#123;</span><br><span class="line">  parser: file.extname === <span class="string">'.sss'</span> ? <span class="string">'sugarss'</span> : <span class="literal">false</span>,</span><br><span class="line">  plugins: &#123;</span><br><span class="line">    <span class="string">'postcss-import'</span>: &#123; <span class="attr">root</span>: file.dirname &#125;,</span><br><span class="line">    <span class="string">'postcss-cssnext'</span>: options.cssnext ? options.cssnext : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">'autoprefixer'</span>: env == <span class="string">'production'</span> ? options.autoprefixer : <span class="literal">false</span>,</span><br><span class="line">    <span class="string">'cssnano'</span>: env === <span class="string">'production'</span> ? options.cssnano : <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// style.js</span></span><br><span class="line"><span class="keyword">import</span> colors <span class="keyword">from</span> <span class="string">'./styles/colors'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">    <span class="string">'.menu'</span>: &#123;</span><br><span class="line">      color: colors.main,</span><br><span class="line">      height: <span class="number">25</span>,</span><br><span class="line">      <span class="string">'&amp;_link'</span>: &#123;</span><br><span class="line">      color: <span class="string">'white'</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="less-loader"><a href="#less-loader" class="headerlink" title="less-loader"></a>less-loader</h2><p>将 less 文件编译成 css 文件。less 插件会作为 less-loader 的 peerDependency，因此安装 less-loader 的时候会自动安装 less 插件。</p>
<p>less-loader 4 起，查询文件可通过 webpack resolver 或 less 内置的 resolver。less-loader 应用一个 Less 插件，并且将所有查询参数传递给 webpack resolver。需要从 node_modules 导入 less 模块时，只要加一个 ~ 前缀，如 @import “~bootstrap/less/bootstrap”; 。使用 webpack resolver，可以引入任何导出 less 的文件，如 “js-to-less-loader” 导出的文件，与此同时，需要使用 issuer 属性约定请求资源的脚本文件名，如 issuer: /.less$/。</p>
<p>当 options 配置 paths 属性时，将使用 less 内置的 resolver 去查询文件。paths 属性以数组形式配置绝对路径。</p>
<p>options 配置参考 <a href="http://lesscss.org/usage/#command-line-usage-options" target="_blank" rel="noopener">less options</a>。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">  rules: [&#123;</span><br><span class="line">    test: <span class="regexp">/\.less$/</span>,</span><br><span class="line">    use: [&#123;</span><br><span class="line">      loader: <span class="string">"style-loader"</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      loader: <span class="string">"css-loader"</span></span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      loader: <span class="string">"less-loader"</span>, </span><br><span class="line">      options: &#123;</span><br><span class="line">        strictMath: <span class="literal">false</span>,<span class="comment">// 是否直接输出数学计算值</span></span><br><span class="line">        strictUnits: <span class="literal">false</span>,<span class="comment">// 是否支持 1px * 2px 运算，单位通过猜测获得</span></span><br><span class="line">        globalVar: &#123;&#125;,<span class="comment">// 全局变量</span></span><br><span class="line">        modifyVar: &#123;&#125;,<span class="comment">// 在 less 文件可改变的变量</span></span><br><span class="line">        paths: [],<span class="comment">// less 文件查找路径，如 [ path.resolve(__dirname, "node_modules") ]</span></span><br><span class="line">        plugins: [],<span class="comment">// 设置插件，如 [ new CleanCSSPlugin(&#123; advanced: true &#125;) ]</span></span><br><span class="line">        sourceMap: <span class="literal">false</span><span class="comment">// 是否启用 SourceMap，可选值 true, "inline"</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [&#123;</span><br><span class="line">      test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">      issuer: <span class="regexp">/\.less$/</span>,</span><br><span class="line">      use: [&#123;</span><br><span class="line">        loader: <span class="string">"js-to-less-loader"</span></span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="sass-loader"><a href="#sass-loader" class="headerlink" title="sass-loader"></a>sass-loader</h2><p>将 scss 文件编译成 css 文件。node-sass 插件会作为 sass-loader 的 peerDependency，因此安装 sass-loader 的时候会自动安装 node-sass 插件。</p>
<p>options 配置参考 <a href="http://lesscss.org/usage/#command-line-usage-options" target="_blank" rel="noopener">node-sass</a>。</p>
<p>sass-loader 中，url(…) 语法将相对于网站的根目录查找(没有 css-loader)，或相对 scss 文件查找(有 css-loader)。有 css-loader 场景，可通过 resolve-url-loader 加载器获得相对 scss 文件的 url。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [&#123;</span><br><span class="line">      test: <span class="regexp">/\.scss$/</span>,</span><br><span class="line">      use: [&#123;</span><br><span class="line">        loader: <span class="string">"style-loader"</span></span><br><span class="line">      &#125;, &#123;</span><br><span class="line">        loader: <span class="string">"css-loader"</span></span><br><span class="line">      &#125;, &#123;</span><br><span class="line">        loader: <span class="string">"sass-loader"</span>,</span><br><span class="line">        options: &#123;</span><br><span class="line">          includePaths: [],<span class="comment">// 文件路径，如 ["absolute/path/a", "absolute/path/b"]</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="dynamic-css-loader"><a href="#dynamic-css-loader" class="headerlink" title="dynamic-css-loader"></a>dynamic-css-loader</h2><p>对 css 文件中的 import 语句，采用动态加载的方式。结合 extract-text-webpack-plugin, file-loader, extract-loader 使用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  test: <span class="regexp">/.../</span>,</span><br><span class="line">  use: ExtractTextPlugin.extract(&#123;</span><br><span class="line">    use: [ ... ],</span><br><span class="line">    fallback: [</span><br><span class="line">      <span class="string">'dynamic-css-loader'</span>,</span><br><span class="line">      <span class="string">'file-loader'</span>,</span><br><span class="line">      <span class="string">'extract-loader'</span>,</span><br><span class="line">    ],</span><br><span class="line">  &#125;),</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>
<h2 id="file-loader"><a href="#file-loader" class="headerlink" title="file-loader"></a>file-loader</h2><p>支持 import, require 加载文件，返回文件的 url。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>: &#123;</span><br><span class="line">  rules: [</span><br><span class="line">    &#123;</span><br><span class="line">      test: <span class="regexp">/\.(png|jpg|gif)$/</span>,</span><br><span class="line">      use: [</span><br><span class="line">        &#123;</span><br><span class="line">          loader: <span class="string">'file-loader'</span>,</span><br><span class="line">          options: &#123;</span><br><span class="line">            name: [hash].[ext],<span class="comment">// 文件名，模板字符串，支持占位符 ext 扩展名，name 文件名，path 相对于 context 的路径，hash 哈希值，N 当前文件名按照查询参数 regExp 匹配后获得到第 N 个匹配结果，等</span></span><br><span class="line">            context: <span class="keyword">this</span>.options.context,<span class="comment">// 文件查找的基本路径，默认为 webpack 配置项的 context</span></span><br><span class="line">            publicPath: __webpack_public_path__,<span class="comment">// 文件的 public path，默认为 webpack 配置项的 publicPath</span></span><br><span class="line">            outputPath: <span class="literal">undefined</span>,<span class="comment">// 文件导出目录</span></span><br><span class="line">            useRelativePath: <span class="literal">false</span>,<span class="comment">// 设置为真值时，生成 url 相对于 context</span></span><br><span class="line">            emitFile: <span class="literal">true</span><span class="comment">// 为真值时处理文件，为否值只获取 url</span></span><br><span class="line">          &#125;  </span><br><span class="line">        &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="url-loader"><a href="#url-loader" class="headerlink" title="url-loader"></a>url-loader</h2><p>基本功能同 file-loader，但当文件不大时，以 DataUrl 形式嵌入 html 页面中，避免请求服务器资源。DataUrl 主要实现为，将图片编码为 base64，存储在 url 中，并冠以 mime-type。base64 编码的数据体积通常是原数据的体积 4/3，且不会被浏览器缓存。缓存问题可通过 css 背景图片解决，图片资源嵌入 url(…) 语句，随 css 文件一同缓存在浏览器端。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.(png|jpg|gif)$/</span>,</span><br><span class="line">        use: [</span><br><span class="line">          &#123;</span><br><span class="line">            loader: <span class="string">'url-loader'</span>,</span><br><span class="line">            options: &#123;</span><br><span class="line">              limit: <span class="literal">undefined</span>,<span class="comment">// 文件大于 limit 值，使用 file-loader 加载；小于，使用 url-loader，如 limit: 8192</span></span><br><span class="line">              mimetype: <span class="string">"extname"</span>,<span class="comment">// 设置文件的 mime-type，默认通过扩展名获取</span></span><br><span class="line">              prefix: <span class="literal">false</span><span class="comment">// 提供给 file-loader 使用</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="html-loader"><a href="#html-loader" class="headerlink" title="html-loader"></a>html-loader</h2><p>处理 html 文件中的图片链接 img:src 等属性，需要结合 url-loader, file-loader 使用。</p>
<p>html-loader 只作字符处理，如 ‘Text <img src="image.png"><img src="~bootstrap-img"> Text’ 将转换为 ‘module.exports = “Text &lt;img src=\“” + require(“./image.png”) + “\“&gt;&lt;img src=\“” + require(“bootstrap-img”) + “\“&gt; Text”;’</p>
<p>因此，若要导出 html 页面，需要配合 file-loader, extract-loader 使用。extract-loader 将 js 转换为 html，file-loader 输出 html 文件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// html-loader 加载器选项，也可以设置在 webpackConfig 的 htmlLoader, otherHtmlLoaderConfig 属性中，加载时指定 config，如 html-loader?config=otherHtmlLoaderConfig</span></span><br><span class="line">&#123;</span><br><span class="line">  test: <span class="regexp">/\.(html)$/</span>,</span><br><span class="line">  use: &#123;</span><br><span class="line">    loader: <span class="string">'html-loader'</span>,</span><br><span class="line">    options: &#123;</span><br><span class="line">      attrs: [<span class="string">'img:src'</span>],<span class="comment">// 待处理的标签，如 ':data-src'。设置为 false，禁用对标签属性的处理。设置为 'img:src'，url-loader, file-loader 导出的链接赋值给 src 属性；设置为 ':data-src'，url-loader, file-loader 导出的链接赋值给 data-src 属性</span></span><br><span class="line">      minimize: <span class="literal">false</span>,<span class="comment">// 最小化输出</span></span><br><span class="line">      removeComments: <span class="literal">false</span>,<span class="comment">// 最小化选项</span></span><br><span class="line">      removeCommentsFromCDATA: <span class="literal">false</span>,</span><br><span class="line">      removeCDATASectionsFromCDATA: <span class="literal">false</span>,</span><br><span class="line">      collapseWhitespace: <span class="literal">false</span>,</span><br><span class="line">      conservativeCollapse: <span class="literal">false</span>,</span><br><span class="line">      removeAttributeQuotes: <span class="literal">false</span>,</span><br><span class="line">      useShortDoctype: <span class="literal">false</span>,</span><br><span class="line">      keepClosingSlash: <span class="literal">false</span>,</span><br><span class="line">      minifyJS: <span class="literal">false</span>,</span><br><span class="line">      minifyCSS: <span class="literal">false</span>,</span><br><span class="line">      removeScriptTypeAttributes: <span class="literal">false</span>,</span><br><span class="line">      removeStyleTypeAttributes: <span class="literal">false</span>,</span><br><span class="line">      root: <span class="literal">false</span>,<span class="comment">// 设置为 true 时，&lt;img src="/image.jpg"&gt; 中 src 属性将自动拼接网站根目录</span></span><br><span class="line">      interpolate: <span class="literal">false</span>,<span class="comment">// 设置为 true 时，自动转换 es6 模板字符串 $&#123;&#125;；设置为 'require'，只能在模板内使用 require。如 &lt;#list list as list&gt;&lt;a href="$&#123;list.href!&#125;" /&gt;$&#123;list.name&#125;&lt;/a&gt;&lt;/#list&gt;</span></span><br><span class="line">      exportAsDefault: <span class="literal">false</span>,<span class="comment">// 以 es5 格式导出 exports.default = "Hello world"; 默认导出格式为 module.exports = "Hello world";</span></span><br><span class="line">      exportAsEs6Default: <span class="literal">false</span>,<span class="comment">// 以 es6 格式导出 export default "Hello world";</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="raw-loader"><a href="#raw-loader" class="headerlink" title="raw-loader"></a>raw-loader</h2><p>将文件导入为字符串。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  test: <span class="regexp">/\.txt$/</span>,</span><br><span class="line">  loader: <span class="string">'raw-loader'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="i18n-loader"><a href="#i18n-loader" class="headerlink" title="i18n-loader"></a>i18n-loader</h2><p>将所有语言包加载到一个对象中，并根据 window.navigator.userLanguage 或 window.navigator.language 区分语言包。i18n/choose 模块用于选择正确的语言包，i18n/concat 模块将拼接所有合适的地区，i18n/merge 将所有语言包合并到对象中，</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> locale = <span class="built_in">require</span>(<span class="string">"./colors.i18.json"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 等待准备就绪，在一个 web 项目中所有地区只需要一次</span></span><br><span class="line"><span class="comment">// 因为所有地区的语言被合并到一个块中</span></span><br><span class="line">locale(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(locale);<span class="comment">// 打印语言包</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  test: <span class="regexp">/\.i18$/</span>,</span><br><span class="line">  use: [&#123;</span><br><span class="line">    loader: <span class="string">'i18n-loader'</span>,</span><br><span class="line">    options: &#123;</span><br><span class="line">      locales: [],<span class="comment">// 将所有语言包打包到一个对象中，如 [ "de", "de-de", "fr" ]，同时开启同步加载模式</span></span><br><span class="line">      bundleTogether: <span class="literal">false</span><span class="comment">// 是否禁止所有语言包打包在一起</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,&#123;</span><br><span class="line">    loader: <span class="string">'json-loader'</span></span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="json-loader"><a href="#json-loader" class="headerlink" title="json-loader"></a>json-loader</h2><p>webpack 2 起，将自动导入json。若使用不同的扩展名，仍可使用 json-loader 导入 json 数据。</p>
<h2 id="json5-loader"><a href="#json5-loader" class="headerlink" title="json5-loader"></a>json5-loader</h2><p>用于导入 json5 文件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  test: <span class="regexp">/\.json5$/</span>,</span><br><span class="line">  loader: <span class="string">'json5-loader'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="svg-inline-loader"><a href="#svg-inline-loader" class="headerlink" title="svg-inline-loader"></a>svg-inline-loader</h2><p>用于导入 svg。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  test: <span class="regexp">/\.svg$/</span>,</span><br><span class="line">  use: [&#123;</span><br><span class="line">    loader: <span class="string">'svg-inline-loader'</span>,</span><br><span class="line">    options: &#123;</span><br><span class="line">      removeTags: <span class="literal">false</span>,<span class="comment">// 删除指定的标签和它的子元素，布尔型</span></span><br><span class="line">      removingTags: [],<span class="comment">// 待删除的标签，需要 removeTags 属性置为真，如 ['title', 'desc', 'defs', 'style']</span></span><br><span class="line">      warnTags: [],<span class="comment">// 警告标签</span></span><br><span class="line">      removeSVGTagAttrs: <span class="literal">true</span>,<span class="comment">// 是否删除 &lt;svg /&gt; 的 width 和 height 属性</span></span><br><span class="line">      removingTagAttrs: [],<span class="comment">// 删除内部的 &lt;svg /&gt;的属性</span></span><br><span class="line">      warnTagAttrs: [],<span class="comment">// 在console发出关于内部 &lt;svg /&gt; 属性的警告</span></span><br><span class="line">      classPrefix: <span class="literal">false</span>,<span class="comment">// svg 标签 class 添加前缀，避免命名冲突，可选值 true 或 字符串</span></span><br><span class="line">      idPrefix: <span class="literal">false</span><span class="comment">// svg 标签 id 添加前缀，避免命名冲突，可选值 true 或 字符串</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="null-loader"><a href="#null-loader" class="headerlink" title="null-loader"></a>null-loader</h2><p>使打包文件不包含部分类库额外引入的依赖。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  test: path.resolve(__dirname, <span class="string">'node_modules/library/polyfill.js'</span>),</span><br><span class="line">  loader: <span class="string">'null-loader'</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="bundle-loader"><a href="#bundle-loader" class="headerlink" title="bundle-loader"></a>bundle-loader</h2><p>通过 require.ensure 方法实现文件的异步加载，设置回调对文件作处理，回调可设置多个。当文件加载完成后，执行回调；当回调在文件加载完成后添加，立即执行回调。为了同其他脚本作区分，配置时 test 属性可设置为 /.bundle.js$/。效果如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> load <span class="keyword">from</span> <span class="string">'test.bundle.js'</span>;</span><br><span class="line"></span><br><span class="line">load(<span class="function"><span class="params">file</span> =&gt;</span> &#123;&#125;);<span class="comment">// 首次调用文件后加载回调</span></span><br></pre></td></tr></table></figure>
<h2 id="coffee-loader"><a href="#coffee-loader" class="headerlink" title="coffee-loader"></a>coffee-loader</h2><p>编译 CoffeeScript。选项包含 literate = false 编译在 Markdown 中书写的 CoffeeScript 脚本，sourceMap = false 是否启用 source-map，transpile = false 配置 babel-preset 及 babel-plugin。</p>
<h2 id="coffee-redux-loader"><a href="#coffee-redux-loader" class="headerlink" title="coffee-redux-loader"></a>coffee-redux-loader</h2><p>编译 CoffeeScript。终极版???</p>
<h2 id="jshint-loader"><a href="#jshint-loader" class="headerlink" title="jshint-loader"></a>jshint-loader</h2><p>jshint 语法检查。jshint-loader 选项配置参考：<a href="http://jshint.com/docs/options/。" target="_blank" rel="noopener">http://jshint.com/docs/options/。</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [&#123;</span><br><span class="line">      test: <span class="regexp">/\.js$/</span>,</span><br><span class="line">      enforce: <span class="string">"pre"</span>, <span class="comment">// 预先加载 jshint loader</span></span><br><span class="line">      exclude: <span class="regexp">/node_modules/</span>,</span><br><span class="line">      use: [&#123;</span><br><span class="line">        loader: <span class="string">"jshint-loader"</span>,</span><br><span class="line">        options: &#123;</span><br><span class="line">          camelcase: <span class="literal">true</span>,</span><br><span class="line">          emitErrors: <span class="literal">false</span>,<span class="comment">// jshint 默认显示警告类信息，emitErrors设为 true 将置为错误类信息</span></span><br><span class="line">          failOnHint: <span class="literal">false</span>,<span class="comment">// 设置为真值时，jshint 报错将打断 webpack 函数</span></span><br><span class="line">          reporter: <span class="function"><span class="keyword">function</span>(<span class="params">errors</span>) </span>&#123; &#125;<span class="comment">// 自定义报告函数，errors 为数组形式 [&#123; id, code, reason, evidence, line, character, scope &#125;]; 其中，reason 为错误消息，evidence 为错误编码，scope 为消息作用域。函数中，调用 this.emitWarning(...) 或 this.emitError(...) 显示消息。由 webpack 提供上下文 this</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="mocha-loader"><a href="#mocha-loader" class="headerlink" title="mocha-loader"></a>mocha-loader</h2><p>加载时运行 mocha 测试。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  rules: [&#123;</span><br><span class="line">    test: <span class="regexp">/test\.js$/</span>,</span><br><span class="line">    use: <span class="string">'mocha-loader'</span>,</span><br><span class="line">    exclude: <span class="regexp">/node_modules/</span>,</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="istanbul-instrumenter-loader"><a href="#istanbul-instrumenter-loader" class="headerlink" title="istanbul-instrumenter-loader"></a>istanbul-instrumenter-loader</h2><p>加载时运行 karam 测试。</p>
<p>参考文档：<br><a href="https://github.com/webpack-contrib/karma-webpack" target="_blank" rel="noopener">karma-webpack</a><br><a href="https://github.com/mattlewis92/karma-coverage-istanbul-reporter" target="_blank" rel="noopener">karma-coverage-istanbul-reporter</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  test: <span class="regexp">/\.js$|\.jsx$/</span>,</span><br><span class="line">  use: &#123;</span><br><span class="line">    loader: <span class="string">'istanbul-instrumenter-loader'</span>,</span><br><span class="line">    options: &#123; </span><br><span class="line">      debug: <span class="literal">false</span>,<span class="comment">// 开启 debug 模式</span></span><br><span class="line">      compact: <span class="literal">true</span>,<span class="comment">// 生成压缩后代码</span></span><br><span class="line">      autoWrap: <span class="literal">false</span>,<span class="comment">// 函数外是否允许返回语句</span></span><br><span class="line">      esModules: <span class="literal">false</span>,<span class="comment">// ES2015 书写代码</span></span><br><span class="line">      coverageVariable: <span class="string">'__coverage__'</span>,<span class="comment">// 全局覆盖率变量名</span></span><br><span class="line">      preserveComments: <span class="literal">false</span>,<span class="comment">// 输出中保留注释</span></span><br><span class="line">      produceSourceMap: <span class="literal">false</span>,<span class="comment">// 生成 source-map</span></span><br><span class="line">      sourceMapUrlCallback: <span class="literal">null</span><span class="comment">// source-map url 查询后的回调</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  enforce: <span class="string">'post'</span>,</span><br><span class="line">  exclude: <span class="regexp">/node_modules|\.spec\.js$/</span>,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="coverjs-loader"><a href="#coverjs-loader" class="headerlink" title="coverjs-loader"></a>coverjs-loader</h2><p>用于测试???</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// cover-my-client-tests.js</span></span><br><span class="line"><span class="built_in">require</span>(<span class="string">"./my-client-tests"</span>);</span><br><span class="line"></span><br><span class="line">after(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(<span class="string">"cover-loader"</span>).reportHtml();</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="exports-loader"><a href="#exports-loader" class="headerlink" title="exports-loader"></a>exports-loader</h2><p>exports 插入属性，或者赋值 module.exports。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">"exports-loader?file,parse=helpers.parse!./file.js"</span>);</span><br><span class="line"><span class="comment">// adds below code to the file's source:</span></span><br><span class="line"><span class="comment">//  exports["file"] = file;</span></span><br><span class="line"><span class="comment">//  exports["parse"] = helpers.parse;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">"exports-loader?file!./file.js"</span>);</span><br><span class="line"><span class="comment">// adds below code to the file's source:</span></span><br><span class="line"><span class="comment">//  module.exports = file;</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span>(<span class="string">"exports-loader?[name]!./file.js"</span>);</span><br><span class="line"><span class="comment">// adds below code to the file's source:</span></span><br><span class="line"><span class="comment">//  module.exports = file;</span></span><br></pre></td></tr></table></figure>
<h2 id="expose-loader"><a href="#expose-loader" class="headerlink" title="expose-loader"></a>expose-loader</h2><p>暴露全局变量，注入到 global 对象中。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">require</span>(<span class="string">"expose-loader?$!jquery"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 或</span></span><br><span class="line"><span class="built_in">module</span>: &#123;</span><br><span class="line">  rules: [&#123;</span><br><span class="line">    test: <span class="built_in">require</span>.resolve(<span class="string">'jquery'</span>),</span><br><span class="line">    use: [&#123;</span><br><span class="line">      loader: <span class="string">'expose-loader'</span>,</span><br><span class="line">      options: <span class="string">'jQuery'</span></span><br><span class="line">    &#125;,&#123;</span><br><span class="line">      loader: <span class="string">'expose-loader'</span>,</span><br><span class="line">      options: <span class="string">'$'</span></span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="imports-loader"><a href="#imports-loader" class="headerlink" title="imports-loader"></a>imports-loader</h2><p>自动为文件注入局部变量。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>: &#123;</span><br><span class="line">  rules: [&#123;</span><br><span class="line">    test: <span class="regexp">/test\/.js/</span></span><br><span class="line">    use: [&#123;</span><br><span class="line">      loader: <span class="string">'imports-loader'</span>,</span><br><span class="line">      options: &#123;&#125;<span class="comment">// 注入变量，如 &#123; angular: true &#125; 将注入 angular 类库；&#123; $: 'jquery' &#125; 将注入 jquery；&#123; config: '&gt;&#123; size: 50 &#125;' &#125; 将赋值 config = &#123; size: 50 &#125; 等</span></span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="gzip-loader"><a href="#gzip-loader" class="headerlink" title="gzip-loader"></a>gzip-loader</h2><p>加载 gzip 压缩资源。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [</span><br><span class="line">      &#123;</span><br><span class="line">        test: <span class="regexp">/\.gz$/</span>,</span><br><span class="line">        enforce: <span class="string">'pre'</span>,</span><br><span class="line">        use: <span class="string">'gzip-loader'</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="yaml-frontmatter-loader"><a href="#yaml-frontmatter-loader" class="headerlink" title="yaml-frontmatter-loader"></a>yaml-frontmatter-loader</h2><p>将 yaml 转化为 json。</p>
<h2 id="react-proxy-loader"><a href="#react-proxy-loader" class="headerlink" title="react-proxy-loader"></a>react-proxy-loader</h2><p>通过 require.ensure 按需加载文件组件。组件实例 mixins 属性注入代理组件 require(‘react-proxy-loader!./a.js’).Mixin，在当前组件中调用loadComponent 即可获取 a.js 导出的组件，a.js 文件尚未加载完成，调用开发者配置的 renderUnavailable 方法进行渲染。或者，直接将 require(‘react-proxy-loader!./a.js’) 作为组件使用，a.js 文件尚未加载完成，render 方法返回 null。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> Component = <span class="built_in">require</span>(<span class="string">"react-proxy-loader!./Component"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> ComponentProxyMixin = <span class="built_in">require</span>(<span class="string">"react-proxy-loader!./Component"</span>).Mixin;</span><br><span class="line"><span class="keyword">var</span> ComponentProxy = React.createClass(&#123;</span><br><span class="line">	mixins: [ComponentProxyMixin],</span><br><span class="line">	renderUnavailable: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">p</span>&gt;</span>Loading...<span class="tag">&lt;/<span class="name">p</span>&gt;</span></span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="script-loader"><a href="#script-loader" class="headerlink" title="script-loader"></a>script-loader</h2><p>在全局上下文中执行一次 js 脚本，加载时即执行。</p>
<h2 id="source-map-loader"><a href="#source-map-loader" class="headerlink" title="source-map-loader"></a>source-map-loader</h2><p>从 js 入口文件中提取 source-map 文件(该文件的内容由 webpackConfig devtool 配置项限定)。可设置 include, exclude 选项。</p>
<h2 id="cache-loader"><a href="#cache-loader" class="headerlink" title="cache-loader"></a>cache-loader</h2><p>在性能开销较大的 loader 前加载 cache-loader，可以将编译结果缓存到磁盘中，如 babel-loader 前。options 有 cacheDirectory 缓存目录，默认为 path.resolve(‘.cache-loader’)。</p>
<h2 id="worker-loader"><a href="#worker-loader" class="headerlink" title="worker-loader"></a>worker-loader</h2><p>将 js 转化为 webworker，父子线程间通信???</p>
<p>webworker 参考文档：<a href="https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API。" target="_blank" rel="noopener">https://developer.mozilla.org/en-US/docs/Web/API/Web_Workers_API。</a></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file.js</span></span><br><span class="line"><span class="keyword">var</span> _ = <span class="built_in">require</span>(<span class="string">'lodash'</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> o = &#123;<span class="attr">foo</span>: <span class="string">'foo'</span>&#125;</span><br><span class="line"></span><br><span class="line">_.has(o, <span class="string">'foo'</span>) <span class="comment">// true</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 将数据发送到父线程(parent thread)</span></span><br><span class="line">self.postMessage(&#123;<span class="attr">foo</span>: <span class="string">'foo'</span>&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 响应来自父线程(parent thread)的消息</span></span><br><span class="line">self.addEventListener(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>)</span>&#123; <span class="built_in">console</span>.log(event); &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// main.js</span></span><br><span class="line"><span class="keyword">var</span> MyWorker = <span class="built_in">require</span>(<span class="string">"worker-loader!./file.js"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> worker = <span class="keyword">new</span> MyWorker();</span><br><span class="line">worker.postMessage(&#123;<span class="attr">a</span>: <span class="number">1</span>&#125;);</span><br><span class="line">worker.onmessage = <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;...&#125;;</span><br><span class="line">worker.addEventListener(<span class="string">"message"</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;...&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="multi-loader"><a href="#multi-loader" class="headerlink" title="multi-loader"></a>multi-loader</h2><p>控制多个加载器。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> multi = <span class="built_in">require</span>(<span class="string">"multi-loader"</span>);</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    loaders: [&#123;</span><br><span class="line">      test: <span class="regexp">/\.css$/</span>,</span><br><span class="line">      loader: multi(<span class="comment">// multi 参数中 loader 顺序执行，即先解析 css，再以字符串输出</span></span><br><span class="line">        <span class="string">"style-loader!css-loader!autoprefixer-loader"</span>,</span><br><span class="line">        <span class="string">"raw-loader"</span></span><br><span class="line">      )</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="thread-loader"><a href="#thread-loader" class="headerlink" title="thread-loader"></a>thread-loader</h2><p>作为前置 loader，将使之后的 loader 运行在独立的线程池中。但这些后置的 loader 不能产生新的文件，不能使用定制的 loader API，无法获取 webpack 的选项设置???</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">   use: [</span><br><span class="line">    &#123;</span><br><span class="line">      loader: <span class="string">"thread-loader"</span>,</span><br><span class="line">      options: &#123;<span class="comment">// 有同样配置的 loader 会共享一个 worker 池(worker pool)</span></span><br><span class="line">        workers: <span class="number">2</span>,<span class="comment">// 产生的 worker 的数量，默认是 cpu 的核心数</span></span><br><span class="line">        workerParallelJobs: <span class="number">50</span>,<span class="comment">// 一个 worker 进程中并行执行工作的数量，默认为 20</span></span><br><span class="line">        workerNodeArgs: [<span class="string">'--max-old-space-size'</span>, <span class="string">'1024'</span>],<span class="comment">// 额外的 node.js 参数</span></span><br><span class="line">        poolTimeout: <span class="number">2000</span>,<span class="comment">// 闲置时定时删除 worker 进程，默认为 500ms。可以设置为无穷大， 这样在监视模式(--watch)下可以保持 worker 持续存在</span></span><br><span class="line">        poolParallelJobs: <span class="number">50</span>,<span class="comment">// 池(pool)分配给 worker 的工作数量，默认为 200。降低这个数值会降低总体的效率，但是会提升工作分布更均一</span></span><br><span class="line">        name: <span class="string">"my-pool"</span><span class="comment">// 池(pool)的名称，可以修改名称来创建其余选项都一样的池(pool)</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"expensive-loader"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 预热 worker 池(worker pool)来防止启动 worker 时的高延时。这会启动池(pool)内最大数量的 worker 并把指定的模块载入 node.js 的模块缓存中</span></span><br><span class="line"><span class="keyword">const</span> threadLoader = <span class="built_in">require</span>(<span class="string">'thread-loader'</span>);</span><br><span class="line">threadLoader.warmup(options, [</span><br><span class="line">  <span class="string">'babel-loader'</span>,</span><br><span class="line">  <span class="string">'babel-preset-es2015'</span>,</span><br><span class="line">  <span class="string">'sass-loader'</span>,</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
<h2 id="transform-loader"><a href="#transform-loader" class="headerlink" title="transform-loader"></a>transform-loader</h2><p>应用 browserify transforms???</p>
<p>browserify transforms 参考文档：<a href="https://github.com/browserify/browserify/wiki/list-of-transforms" target="_blank" rel="noopener">https://github.com/browserify/browserify/wiki/list-of-transforms</a></p>
<h2 id="val-loader"><a href="#val-loader" class="headerlink" title="val-loader"></a>val-loader</h2><p>根据输入加载不同文件，交由下一个中间件???</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> ask = <span class="built_in">require</span>(<span class="string">'./ask.js'</span>);</span><br><span class="line"><span class="keyword">const</span> generateResult = <span class="built_in">require</span>(<span class="string">'./generateResult.js'</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">findAnswer</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ask(options.question)</span><br><span class="line">    .then(generateResult)</span><br><span class="line">    .then(<span class="function"><span class="params">result</span> =&gt;</span> (&#123;</span><br><span class="line">      code: result.code,</span><br><span class="line">      sourceMap: result.sourceMap,</span><br><span class="line">      ast: result.abstractSyntaxTree,<span class="comment">// 下一个 loader 使用相同的 ast，可以提升编译速度</span></span><br><span class="line">      dependencies: [<span class="comment">// 默认为 []，需要监听这些文件的变更</span></span><br><span class="line">        <span class="built_in">require</span>.resolve(<span class="string">'./ask.js'</span>),</span><br><span class="line">        <span class="built_in">require</span>.resolve(<span class="string">'./generateResult.js'</span>)</span><br><span class="line">      ],.</span><br><span class="line">      cacheable: <span class="literal">true</span><span class="comment">// 依赖没有变更时，使用缓存</span></span><br><span class="line">    &#125;));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = findAnswer;</span><br><span class="line"></span><br><span class="line"><span class="comment">// webpack.config.js</span></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="built_in">module</span>: &#123;</span><br><span class="line">    rules: [&#123;</span><br><span class="line">      test: <span class="built_in">require</span>.resolve(<span class="string">'path/to/findAnswer.js'</span>),</span><br><span class="line">      use: [&#123;</span><br><span class="line">        loader: <span class="string">'val-loader'</span>,</span><br><span class="line">        options: &#123;</span><br><span class="line">          question: <span class="string">'What is the meaning of life?'</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;]</span><br><span class="line">    &#125;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/02/03/工程化/浅析webpack-merge源码/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/02/03/工程化/浅析webpack-merge源码/" itemprop="url">浅析webpack-merge源码</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-02-03T14:48:30+08:00">2018-02-03</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端工程化/" itemprop="url" rel="index"><span itemprop="name">前端工程化</span></a></span>

                
                
                  ， 
                
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端工程化/webpack/" itemprop="url" rel="index"><span itemprop="name">webpack</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/02/03/工程化/浅析webpack-merge源码/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2018/02/03/工程化/浅析webpack-merge源码/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="merge方法"><a href="#merge方法" class="headerlink" title="merge方法"></a>merge方法</h2><p>webpack-merge 类库的 merge 方法基于 lodash 类库的 mergeWith 方法实现。</p>
<p>mergeWith 方法用于遍历数组项或对象属性，通过尾参 customizer 定制化数据处理函数，获得新的数组项或对象属性。customizer 函数的参数为 (objValue, srcValue, key, object, source, stack)。</p>
<p>webpack-merge 通过 join-arrays 模块导出的 joinArrays 函数将用户配置项 { customizeArray, customizeObject } 对象构建为 customizer 函数生成器。customizer 函数的处理逻辑为：当 objValue, srcValue 为函数时，该函数的返回值由 customizer 函数再次处理。当 objValue, srcValue 为数组时，通过 customizeArray 函数处理，参数为（objValue, srcValue, key）；若 customizeArray 函数未定义，合并数组项。当 objValue, srcValue 为对象时，通过 customizeObject 函数处理，若无返回值或 customizeObject 函数未定义，构建新的key值，调用 joinArrays 函数将 { customizeArray, customizeObject } 配置项转化成内层数据处理函数，并对 objValue, srcValue 的子孙属性深度处理。除此而外，深拷贝 source 或者将 source 作为返回值。特别的，当 customizeArray, customizeObject 函数均未作配置时，customizer 函数作深拷贝处理。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="function"><span class="keyword">function</span> <span class="title">joinArrays</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="function"><span class="params">  customizeArray,</span></span></span><br><span class="line"><span class="function"><span class="params">  customizeObject,</span></span></span><br><span class="line"><span class="function"><span class="params">  key</span></span></span><br><span class="line"><span class="function"><span class="params">&#125; = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">_joinArrays</span>(<span class="params">a, b, k</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> newKey = key ? <span class="string">`<span class="subst">$&#123;key&#125;</span>.<span class="subst">$&#123;k&#125;</span>`</span> : k;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isFunction(a) &amp;&amp; isFunction(b)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="function">(<span class="params">...args</span>) =&gt;</span> _joinArrays(a(...args), b(...args), k);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (isArray(a) &amp;&amp; isArray(b)) &#123;</span><br><span class="line">      <span class="keyword">const</span> customResult = customizeArray &amp;&amp; customizeArray(a, b, newKey);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> customResult || [...a, ...b];</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isPlainObject(a) &amp;&amp; isPlainObject(b)) &#123;</span><br><span class="line">      <span class="keyword">const</span> customResult = customizeObject &amp;&amp; customizeObject(a, b, newKey);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 第二层以同样的逻辑处理，如 'module.rules'等</span></span><br><span class="line">      <span class="keyword">return</span> customResult || mergeWith(&#123;&#125;, a, b, joinArrays(&#123;</span><br><span class="line">        customizeArray,</span><br><span class="line">        customizeObject,</span><br><span class="line">        key: newKey</span><br><span class="line">      &#125;));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isPlainObject(b)) &#123;</span><br><span class="line">      <span class="keyword">return</span> cloneDeep(b);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> b;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在此基础上，webpack-merge 实现了 merge 方法。该方法支持单参数，通过接受{ customizeArray, customizeObject } 对象，返回值用于对数据（格式可以是数组，或多参数）做处理；也支持多参数，数据处理模式即为深拷贝。</p>
<h2 id="multiple-方法"><a href="#multiple-方法" class="headerlink" title="multiple 方法"></a>multiple 方法</h2><p>multiple 方法在 merge 方法的基础上构建，首先通过 merge 方法将配置数据复合为一，然后通过 lodash.values 方法以数组形式返回复合对象各属性的值。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">'path'</span>);</span><br><span class="line"><span class="keyword">var</span> baseConfig = &#123;</span><br><span class="line">    server: &#123;</span><br><span class="line">      target: <span class="string">'node'</span>,</span><br><span class="line">      output: &#123;</span><br><span class="line">        path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">        filename: <span class="string">'lib.node.js'</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    client: &#123;</span><br><span class="line">      output: &#123;</span><br><span class="line">        path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">        filename: <span class="string">'lib.js'</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// specialized configuration</span></span><br><span class="line"><span class="keyword">var</span> production = &#123;</span><br><span class="line">    client: &#123;</span><br><span class="line">      output: &#123;</span><br><span class="line">        path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">        filename: <span class="string">'[name].[hash].js'</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// output</span></span><br><span class="line">[&#123;</span><br><span class="line">  target: <span class="string">'node'</span>,</span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">    filename: <span class="string">'lib.node.js'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;,&#123;</span><br><span class="line">  output: &#123;</span><br><span class="line">    path: path.resolve(__dirname, <span class="string">'dist'</span>),</span><br><span class="line">    filename: <span class="string">'[name].[hash].js'</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;]</span><br></pre></td></tr></table></figure>
<h2 id="unique-方法"><a href="#unique-方法" class="headerlink" title="unique 方法"></a>unique 方法</h2><p>unique 方法通过 lodash 类库的 differenceWith 方法实现。differenceWith 方法接受参数为 (array, values, comparator)，通过遍历 array 数组项，并调用 comparator 函数将数组项和 values 数组比较，将返回否值的数组项构建成新的数组。unique 方法用于构建 customizeArray 配置函数，且其接受参数为 (key, uniques, getter)，key 即属性名，uniques, getter 参数用于构建 differenceWith 方法中的参数 comparator。若getter返回值已存在 uniques 中，comparator 返回真值；否则返回否值，即该数组项拷贝到新数组中。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// unique 方法源码</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">mergeUnique</span>(<span class="params">key, uniques, getter = a =&gt; a</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">a, b, k</span>) =&gt;</span> (</span><br><span class="line">    k === key &amp;&amp; [</span><br><span class="line">      ...a,</span><br><span class="line">      ...differenceWith(</span><br><span class="line">        b, a, item =&gt; uniques.indexOf(getter(item)) &gt;= <span class="number">0</span></span><br><span class="line">      )</span><br><span class="line">    ]</span><br><span class="line">  );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// unique 方法使用</span></span><br><span class="line"><span class="comment">// 需要注意的是，若首个 plugins 中没有 HotModuleReplacementPlugin 构造函数</span></span><br><span class="line"><span class="comment">// 第二个 plugins 中的HotModuleReplacementPlugin 也不会拷贝到新数组中</span></span><br><span class="line"><span class="keyword">const</span> output = merge(&#123;</span><br><span class="line">  customizeArray: merge.unique(</span><br><span class="line">    <span class="string">'plugins'</span>,</span><br><span class="line">    [<span class="string">'HotModuleReplacementPlugin'</span>],</span><br><span class="line">    plugin =&gt; plugin.constructor &amp;&amp; plugin.constructor.name</span><br><span class="line">  )</span><br><span class="line">&#125;)(&#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> webpack.HotModuleReplacementPlugin()</span><br><span class="line">  ]</span><br><span class="line">&#125;, &#123;</span><br><span class="line">  plugins: [</span><br><span class="line">    <span class="keyword">new</span> webpack.HotModuleReplacementPlugin()</span><br><span class="line">  ]</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h2 id="strategy-方法"><a href="#strategy-方法" class="headerlink" title="strategy 方法"></a>strategy 方法</h2><p>strategy 方法在 merge 方法基础上实现，通过配置项 rules 构建 { customizeArray, customizeObject } 对象，最终生成 customizer 数据处理函数。rules 以对象形式配置，定义了数据处理策略，其中，’prepend’ 为反向深拷贝，’replace’ 替换，默认为 ‘append’ 即正向深拷贝。与 merge 方法相同，rules 可以设置深度嵌套属性的处理规则，如 ‘module.rules’: ‘prepend’。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mergeStrategy = <span class="function">(<span class="params">rules = &#123;&#125;</span>) =&gt;</span> merge(&#123;</span><br><span class="line">  customizeArray: customizeArray(rules),</span><br><span class="line">  customizeObject: customizeObject(rules)</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">customizeArray</span>(<span class="params">rules</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">a, b, key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (rules[key]) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'prepend'</span>:</span><br><span class="line">        <span class="keyword">return</span> [...b, ...a];</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'replace'</span>:</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">      <span class="keyword">default</span>: <span class="comment">// append</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">customizeObject</span>(<span class="params">rules</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">a, b, key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">switch</span> (rules[key]) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'prepend'</span>:</span><br><span class="line">        <span class="keyword">return</span> mergeWith(&#123;&#125;, b, a, joinArrays());</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'replace'</span>:</span><br><span class="line">        <span class="keyword">return</span> b;</span><br><span class="line">      <span class="keyword">default</span>: <span class="comment">// append</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="smart-方法"><a href="#smart-方法" class="headerlink" title="smart 方法"></a>smart 方法</h2><p>smart 方法为处理 module.rules 配置项而设计。首先提取 module.rules 数组，交由 lodash 模块的 unionWith 方法处理。unionWith 方法接受参数为 (…array, compator)，comparator(arrVal, othVal) 函数返回 false 时保留两个数组项，返回真值只保留 arrVal。特别的，comparator 执行过程中，可对引用对象 arrVal 进行再度插值操作，使其具有 othVal 的特性。为此，webpack-merge 类库构造了 uniteRules 函数对 module.rules 数组项进行处理。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mergeSmart = merge(&#123;</span><br><span class="line">  customizeArray: <span class="function">(<span class="params">a, b, key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isRule(key.split(<span class="string">'.'</span>).slice(<span class="number">-1</span>)[<span class="number">0</span>])) &#123;</span><br><span class="line">      <span class="keyword">return</span> unionWith(a, b, uniteRules.bind(<span class="literal">null</span>, &#123;&#125;, key));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>uniteRules 函数接受参数为 {rules, key, newRule, rule}，其中 rules 用于配置 module.rules 合并策略，如 { rules.use: ‘prepend’ | ‘append’ | ‘replace’ }，key 即 ‘rules’，newRule, rule 为待合并的两个加载器配置项。uniteRules 函数的处理逻辑为：首先比较 newRule, rule 的 test, include, exclude, enforce, query 查询字符串，是否跳过合并；其次，将 newRule.loader 配置项赋给rule，作为返回值，因为无论 ‘prepend’ | ‘append’ | ‘replace’ 策略，都将返回 newRule.loader；其次将 rule.loader 转换为 [{ loader }]数组，同时newRule.use, rule.use 也转换为 [{ loader }] 数组，该数组同名 loader 将会被合并。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">uniteRules</span>(<span class="params">rules, key, newRule, rule</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">String</span>(rule.test) !== <span class="built_in">String</span>(newRule.test)</span><br><span class="line">      || ((newRule.enforce || rule.enforce) &amp;&amp; rule.enforce !== newRule.enforce)</span><br><span class="line">      || (newRule.include &amp;&amp; !isSameValue(rule.include, newRule.include))</span><br><span class="line">      || (newRule.exclude &amp;&amp; !isSameValue(rule.exclude, newRule.exclude))) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!rule.test &amp;&amp; !rule.include &amp;&amp; !rule.exclude</span><br><span class="line">      &amp;&amp; (rule.loader &amp;&amp; rule.loader.split(<span class="string">'?'</span>)[<span class="number">0</span>]) !== (newRule.loader &amp;&amp; newRule.loader.split(<span class="string">'?'</span>)[<span class="number">0</span>])) &#123;</span><br><span class="line">    <span class="comment">// Don't merge the rule if there isn't any identifying fields and the loaders don't match</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((rule.include || rule.exclude) &amp;&amp; (!newRule.include &amp;&amp; !newRule.exclude)) &#123;</span><br><span class="line">    <span class="comment">// Don't merge child without include/exclude to parent that has either</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// newRule.loader should always override</span></span><br><span class="line">  <span class="keyword">if</span> (newRule.loader) &#123;</span><br><span class="line">    <span class="keyword">const</span> optionsKey = newRule.options ? <span class="string">'options'</span> : newRule.query &amp;&amp; <span class="string">'query'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span> rule.use;</span><br><span class="line">    <span class="keyword">delete</span> rule.loaders;</span><br><span class="line">    rule.loader = newRule.loader;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (optionsKey) &#123;</span><br><span class="line">      rule[optionsKey] = newRule[optionsKey];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((rule.use || rule.loaders || rule.loader) &amp;&amp; (newRule.use || newRule.loaders)) &#123;</span><br><span class="line">    <span class="keyword">const</span> expandEntry = <span class="function"><span class="params">loader</span> =&gt;</span> (</span><br><span class="line">      <span class="keyword">typeof</span> loader === <span class="string">'string'</span> ? &#123; loader &#125; : loader</span><br><span class="line">    );</span><br><span class="line">    <span class="comment">// this is only here to avoid breaking existing tests</span></span><br><span class="line">    <span class="keyword">const</span> unwrapEntry = <span class="function"><span class="params">entry</span> =&gt;</span> (</span><br><span class="line">      !entry.options &amp;&amp; !entry.query ? entry.loader : entry</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> entries;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 将 &#123; loader &#125; 转化成 [&#123; loader, option?, query? &#125;]数组</span></span><br><span class="line">    <span class="keyword">if</span> (rule.loader) &#123;</span><br><span class="line">      <span class="keyword">const</span> optionsKey = rule.options ? <span class="string">'options'</span> : rule.query &amp;&amp; <span class="string">'query'</span>;</span><br><span class="line">      entries = [&#123; <span class="attr">loader</span>: rule.loader &#125;];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (optionsKey) &#123;</span><br><span class="line">        entries[<span class="number">0</span>][optionsKey] = rule[optionsKey];</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">delete</span> rule.loader;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (optionsKey) &#123;</span><br><span class="line">        <span class="keyword">delete</span> rule[optionsKey];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// rule.use, rule.loaders 数组项若为字符串，转化为 &#123; loader &#125; 对象</span></span><br><span class="line">      entries = [].concat(rule.use || rule.loaders).map(expandEntry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> newEntries = [].concat(newRule.use || newRule.loaders).map(expandEntry);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> loadersKey = rule.use || newRule.use ? <span class="string">'use'</span> : <span class="string">'loaders'</span>;</span><br><span class="line">    <span class="keyword">const</span> resolvedKey = <span class="string">`<span class="subst">$&#123;key&#125;</span>.<span class="subst">$&#123;loadersKey&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (rules[resolvedKey]) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'prepend'</span>:</span><br><span class="line">        rule[loadersKey] = [</span><br><span class="line">          ...differenceWith(newEntries, entries, uniteEntries),</span><br><span class="line">          ...entries</span><br><span class="line">        ].map(unwrapEntry);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'replace'</span>:</span><br><span class="line">        rule[loadersKey] = newRule.use || newRule.loaders;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        rule[loadersKey] = unionWith(</span><br><span class="line">          <span class="comment">// Remove existing entries so that we can respect the order of the new</span></span><br><span class="line">          <span class="comment">// entries</span></span><br><span class="line">          differenceWith(entries, newEntries, isEqual),</span><br><span class="line">          newEntries,</span><br><span class="line">          uniteEntries</span><br><span class="line">        ).map(unwrapEntry);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (newRule.include) &#123;</span><br><span class="line">    rule.include = newRule.include;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (newRule.exclude) &#123;</span><br><span class="line">    rule.exclude = newRule.exclude;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">uniteEntries</span>(<span class="params">newEntry, entry</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> loaderNameRe = <span class="regexp">/^([^?]+)/ig</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> [loaderName] = entry.loader.match(loaderNameRe);</span><br><span class="line">  <span class="keyword">const</span> [newLoaderName] = newEntry.loader.match(loaderNameRe);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (loaderName !== newLoaderName) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Replace query values with newer ones</span></span><br><span class="line">  mergeWith(entry, newEntry);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="smartStrategy-方法"><a href="#smartStrategy-方法" class="headerlink" title="smartStrategy 方法"></a>smartStrategy 方法</h2><p>smartStrategy 方法不同于 smart 方法只处理 module.rules 配置项，smartStrategy 方法对整个 webpack 配置进行处理。其中，对 module.rules 配置项，smartStrategy 方法处理逻辑雷同 smart 方法，其他配置项则同 strategy 方法。针对 module.rules 配置项，合并规则 rules 须配置为 { ‘module.rules’: ‘prepend’ | ‘replace’ | ‘append’, ‘module.rules.use’: ‘prepend’ | ‘replace’ | ‘append’ } 形式。’module.rules’ 属性设定 module.rules 合并策略，’module.rules.use’ 属性设定 rule.use 合并策略。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> mergeSmartStrategy = <span class="function">(<span class="params">rules = &#123;&#125;</span>) =&gt;</span> merge(&#123;</span><br><span class="line">  customizeArray: <span class="function">(<span class="params">a, b, key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> topKey = key.split(<span class="string">'.'</span>).slice(<span class="number">-1</span>)[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isRule(topKey)) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (rules[key]) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'prepend'</span>:</span><br><span class="line">          <span class="keyword">return</span> [</span><br><span class="line">            ...differenceWith(b, a, (newRule, seenRule) =&gt; (</span><br><span class="line">              uniteRules(rules, key, newRule, seenRule, <span class="string">'prepend'</span>))</span><br><span class="line">            ),</span><br><span class="line">            ...a</span><br><span class="line">          ];</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'replace'</span>:</span><br><span class="line">          <span class="keyword">return</span> b;</span><br><span class="line">        <span class="keyword">default</span>: <span class="comment">// append</span></span><br><span class="line">          <span class="keyword">return</span> unionWith(a, b, uniteRules.bind(<span class="literal">null</span>, rules, key));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> customizeArray(rules)(a, b, key);</span><br><span class="line">  &#125;,</span><br><span class="line">  customizeObject: customizeObject(rules)</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>备注：webpack-merge类库主要应用于webpack配置，对于roadhog等类库需要注入babelPlugins、babelPresets配置的，稍显鞭长莫及。</p>
<h2 id="参考文档"><a href="#参考文档" class="headerlink" title="参考文档"></a>参考文档</h2><p><a href="https://lodash.com/docs" target="_blank" rel="noopener">lodash官方文档</a></p>
<p><a href="https://github.com/survivejs/webpack-merge" target="_blank" rel="noopener">webpack-merge仓库</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/11/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><span class="page-number current">12</span><a class="page-number" href="/page/13/">13</a><a class="extend next" rel="next" href="/page/13/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpeg" alt="Alfred">
            
              <p class="site-author-name" itemprop="name">Alfred</p>
              <p class="site-description motion-element" itemprop="description">人苦不知足，既得陇，复望蜀</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">122</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    <span class="site-state-item-count">37</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    <span class="site-state-item-count">26</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Alfred-sg" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/xiu-fan-79/activities" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-globe"></i>知乎</a>
                  </span>
                
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Alfred</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Pisces</a> v6.0.2</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.0.2"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.2"></script>



  

  
    <script id="dsq-count-scr" src="https://alfred.disqus.com/count.js" async></script>
  

  





	





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->





  

  

  

  

  
  

  

  

  

  

</body>
</html>
