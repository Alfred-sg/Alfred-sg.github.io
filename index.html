<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.0.2" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.2">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.2" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.0.2',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="Hexo, NexT">


<meta name="description" content="人苦不知足，既得陇，复望蜀">
<meta property="og:type" content="website">
<meta property="og:title" content="修子范语">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="修子范语">
<meta property="og:description" content="人苦不知足，既得陇，复望蜀">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="修子范语">
<meta name="twitter:description" content="人苦不知足，既得陇，复望蜀">






  <link rel="canonical" href="http://yoursite.com/">


  <title>修子范语</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">修子范语</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Alfredo's Notes</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>
        </li>
      

      
    </ul>
  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/13/java/spring之我见/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/13/java/spring之我见/" itemprop="url">spring之我见</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-13T00:00:00+08:00">2019-11-13</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/13/java/spring之我见/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/11/13/java/spring之我见/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>在我所知的前端脚手架中，dawn 使用中间件的方式串联任务流，nowa 使用子命令的方式串联任务流，umi 使用插件的方式串联任务流。三者中较为特别的是，umi 在提供打包构建、测试、mock 服务器等能力之外，它还以根据配置制作入口文件的方式，集成了路由、限定了前端代码的结构。umi 中的集成意识也许来自于 dva。无论从 dva （由状态管理器入手的）前端应用框架到 umi 脚手架，还是从 antd 组件库到 ant pro 模板工程，蚂蚁工程师们抛出的命题总是一环扣一环。我只觉得，问题会引导人去解决，开阔的应用场景会激发问题，这是一条良性的道路。如果应用场景受限，问题得不到暴露，那就要凭技术上的储备去探知下一个去脉。因此，我学习 spring 的目的在于寻找创新点，手法也是不求甚解。</p>
<h2 id="IoC"><a href="#IoC" class="headerlink" title="IoC"></a>IoC</h2><p>在 spring 中，控制反转就是依赖注入。当 Class B 作为 Class A 的依赖时，控制反转会将 B 实例注入到 A 实例中。其实现过程是可以推想的：首先使用 Bean 容器管理并协调 bean 的生命周期，然后从 xml、注解或 java 配置构成的元数据中解析出 bean 的依赖关系，最后按照依赖关系将 B 实例组装到 A 实例中。在 spring 中，作为 Bean 容器的是 BeanFactory；ApplicationContext 作为 BeanFactory 的超类，额外实现了对 AOP、资源处理、事件发布、应用上下文的支持。在这套机制的基础上，spring 一方面提供了声明式编程的能力（同时可以通过 ApplicationContext 访问 bean），另一方面对元数据的多种配置场景作了适配（也就是超强的模式解析能力）。</p>
<img src="/2019/11/13/java/spring之我见/container-magic.png">

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/11/java/spring测试/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/11/java/spring测试/" itemprop="url">spring测试</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-11T00:00:00+08:00">2019-11-11</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/java/" itemprop="url" rel="index"><span itemprop="name">java</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/11/java/spring测试/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/11/11/java/spring测试/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>在 spring mvc 中，可使用 JUnit 作单元测试、Spring Test 作集成测试。测试过程不需要启动项目，可借助 Servlet 相关的模拟对象如 MockMVC、MockHttpServletResquest、MockHttpServletResponse、MockHttpSession 进行模拟。在 spring boot 中，编写测试用例前先加载依赖如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- pom.xml --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span><span class="comment">&lt;!-- 在 test 周期中有效 --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>JUnit4 为了保证每个测试方法都是单元测试，是独立的互不影响。所以每个测试方法执行前都会重新实例化测试类，它提供了如下注解：</p>
<ul>
<li>@BeforeClass 和 @AfterClass 在类被实例化前后执行，且只执行一次，通常用来初始化或关闭资源</li>
<li>@Before 和 @After 在每个 @Test 执行前后都会被执行一次</li>
<li>使用 @Test 标记测试方法单元，被 @Ignore 标记的测试方法不会被执行</li>
</ul>
<p>测试脚本编写完成后，可直接运行 run 跑测试用例。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith</span>(SpringRunner.class)<span class="comment">// 运用 junit4 进行测试，SpringRunner.class 等同 SpringJUnit4ClassRunner.class</span></span><br><span class="line"><span class="meta">@SpringBootTest</span>(classes = &#123;YourApplication.class&#125;)</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoControllerTest</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MockMvc mockMvc;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> DemoController demoController;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span> </span><br><span class="line">    WebApplicationContext wac;<span class="comment">// 可注入 WebApplicationContext</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span> </span><br><span class="line">    MockHttpSession session;<span class="comment">// 可注入 http session</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Autowired</span> </span><br><span class="line">    MockHttpServletRequest request;<span class="comment">// 可注入 request</span></span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Before</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="comment">// 初始化 mockMvc</span></span><br><span class="line">      mockMvc = MockMvcBuilders.webAppContextSetup(<span class="keyword">this</span>.wac).build();</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testPageController</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      mockMvc.perform(get(<span class="string">"/normal"</span>))</span><br><span class="line">          .andExpect(status().isOk())</span><br><span class="line">          .andExpect(view().name(<span class="string">"page"</span>))<span class="comment">// 预期 view 的名称为 page</span></span><br><span class="line">          .andExpect(forwardedUrl(<span class="string">"/WEB-INF/classes/views/page.jsp"</span>))<span class="comment">// 预期页面转向的真正路径为 /WEB-INF/classes/views/page.jsp</span></span><br><span class="line">          .andExpect(model().attribute(<span class="string">"msg"</span>, demoService.saySomething()));<span class="comment">// 预期 model 里的值为 demoService.saySomething 方法的返回结果</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testRestController</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      mockMvc.perform(get(<span class="string">"/testRest"</span>))</span><br><span class="line">          .andExpect(status().isOk())</span><br><span class="line">          .andExpect(content().contentType(<span class="string">"text/plain;charset=UTF-8"</span>))<span class="comment">// 期望返回值的媒体类型是 text/plain、UTF-8</span></span><br><span class="line">          .andExpect(content().string(demoService.saySomething()));<span class="comment">// 期望返回值内容为 demoService.saySomething 方法的返回结果</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.jianshu.com/p/76b893f43bdd" target="_blank" rel="noopener">Spring Boot测试</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/10/frontend/前端监控/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/10/frontend/前端监控/" itemprop="url">前端监控</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-10T00:00:00+08:00">2019-11-10</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端/" itemprop="url" rel="index"><span itemprop="name">前端</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/10/frontend/前端监控/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/11/10/frontend/前端监控/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前端监控"><a href="#前端监控" class="headerlink" title="前端监控"></a>前端监控</h2><p>前端监控包含 js 错误统计、js 错误诊断、api 统计监控、前后端链路追踪、文件加载失败监控、页面访问速度、慢回话追踪等。</p>
<p>js 错误统计可以借助 try…catch、window.onerror 实现。try…catch 能捕获到错误信息描述、堆栈、行号、列号、具体的出错文件信息等，但是它只能在单一的作用域内捕获错误，不能捕获异步函数的错误，如 setTimeout 函数就需要在其内部使用 try…catch 语句，才能捕获定时器回调函数的错误内容。这时候想要使用 try…catch 捕获错误，就需要对 setTimeout 等函数进行封装。window.onerror 可以在任何执行上下文中执行，也能捕获脚本语法错误、运行时错误（出错信息、出错文件、行号等），但不能捕获跨域脚本的错误（跨域脚本只会简单报 script error 错误）。</p>
<p>文件加载失败可以通过加载节点的 onreadystatechange 或 onload 事件加以统计。</p>
<p>页面访问性能可以通过 Performance API 加以统计。</p>
<h2 id="retcode"><a href="#retcode" class="headerlink" title="retcode"></a>retcode</h2><p>retcode 是阿里云 <a href="https://www.alibabacloud.com/help/zh/doc-detail/58652.htm?spm=a2c63.p38356.b99.80.4fcf86c0Gnp5qS" target="_blank" rel="noopener">ARMS 前端监控平台</a>配套的 jssdk。其压缩代码地址为 <a href="https://retcode.alicdn.com/retcode/bl.js。这里不作详解。" target="_blank" rel="noopener">https://retcode.alicdn.com/retcode/bl.js。这里不作详解。</a></p>
<h2 id="Bombay"><a href="#Bombay" class="headerlink" title="Bombay"></a>Bombay</h2><p><a href="https://github.com/bombayjs/bombayjs" target="_blank" rel="noopener">Bombay</a> 通过 xhr 对象或者 window.navigator.sendBeacon 上报数据。上报数据类型包含 error、behavior、health 以及其他，除了 health 尝试使用 window.navigator.sendBeacon 上报以外，其他全部使用 xhr 对象。上报数据的功能实现由 reporter 模块承担；在 reporter 模块的基础上，handlers 模块用于实际上报不同类型的数据，如 pv、health（页面停留时长）、click 点击事件、blur 失焦事件（点击和失焦事件的上报内容包含节点的路径）、performance 性能（首屏渲染时各操作的处理时长）、resource（资源加载时长）、navigation（页面跳转情况）、hashChange（单页应用跳转情况）、caughtError（js 报错，通过 window.addEventListener(‘error’, …) 实现）、promiseError（promise 错误，通过 window.addEventListener(‘unhandledrejection’, …) 实现）、resourceError（资源加载错误）、api（ajax 处理情况）、message（window.postMessage 发送消息）等。在处理单页应用的页面跳转或 ajax 请求等时，Bombay 通过 hack 机制劫持了 window.console、history.pushState、history.replaceState、window.fetch、window.XMLHttpRequest、window.onpopstate 等原生语法，以在封装后的函数执行过程中上报数据。最后，Bombay 根据用户配置项启用功能。</p>
<p>与 mixpanel 一样，Bombay 在上报数据时需要设置 token，即避免其他应用调用上报接口。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.cnblogs.com/passkey/p/9981654.html" target="_blank" rel="noopener">监控平台前端SDK开发实践</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/10/frontend/前端调试/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/10/frontend/前端调试/" itemprop="url">前端调试</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-10T00:00:00+08:00">2019-11-10</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端/" itemprop="url" rel="index"><span itemprop="name">前端</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/10/frontend/前端调试/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/11/10/frontend/前端调试/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>基本调试可以借助 chrome 控制台实现。</p>
<h2 id="同步刷新"><a href="#同步刷新" class="headerlink" title="同步刷新"></a>同步刷新</h2><h3 id="browser-sync"><a href="#browser-sync" class="headerlink" title="browser-sync"></a>browser-sync</h3><p>browser-sync 通过 web-socket 将变更内容透出到页面侧，因此无须刷新页面。browser-sync 提供了两个方法：init({ server }) 启动本地静态服务器，init({ proxy }) 启动代理服务器（当本地服务器通过其他方式启动时，browser-sync 选用代理模式启动）；reload 实时更新页面变动内容。</p>
<h3 id="emmet-livestyle"><a href="#emmet-livestyle" class="headerlink" title="emmet livestyle"></a>emmet livestyle</h3><p>emmet livestyle 扩展程序（浏览器、编辑器有各自的扩展程序）允许将编辑器的变更内容自动反应在页面上，又将浏览器的变更内容自动反应在编辑器上。</p>
<h2 id="抓包工具"><a href="#抓包工具" class="headerlink" title="抓包工具"></a>抓包工具</h2><p>charles 是 mac os 中的抓包工具，fiddler 是 windows 中的抓包工具，两者都通过将自己设置成系统的网络访问代理服务器实现。即所有请求先经过 charles、fiddler，然后再发送到远程服务器中，因此可以拦截请求、修改请求、修改响应，甚至将响应内容替换成本地资源。fiddler 还可以通过 tools - options - connection 设置监听端口，然后手机代理到该端口，就可以将手机端获得的响应资源替换成本地文件，详情可参阅 <a href="https://www.cnblogs.com/wenbodeboke/p/9770771.html" target="_blank" rel="noopener">fiddler手机抓包配置方法</a>。</p>
<h2 id="模拟器"><a href="#模拟器" class="headerlink" title="模拟器"></a>模拟器</h2><p>Genymotion</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://www.cnblogs.com/xy-nb/p/web.html" target="_blank" rel="noopener">手机web前端调试页面的几种方式</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/03/frontend/前端埋点/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/03/frontend/前端埋点/" itemprop="url">前端埋点</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-03T00:00:00+08:00">2019-11-03</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端/" itemprop="url" rel="index"><span itemprop="name">前端</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/03/frontend/前端埋点/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/11/03/frontend/前端埋点/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="埋点统计数据"><a href="#埋点统计数据" class="headerlink" title="埋点统计数据"></a>埋点统计数据</h2><h3 id="用户访问统计"><a href="#用户访问统计" class="headerlink" title="用户访问统计"></a>用户访问统计</h3><p>用户访问统计包含 PV（Page View）、UV（Unique Visitor）、VV（Visit View）、IP 等。PV 用来统计一天之内页面的被访问次数，机刷也可以造成 PV 数据提升。UV 用来统计一天之内访问页面的用户数量，一般使用 IP 统计（IP 统计并不谨慎，同一个办公区或校园公用一个 IP）；使用 cookie + IP 统计（cookie 会被刷新，造成用户数被重复统计）；使用 userAgent + API 统计（userAgent + API 相同的情况也常有发生）。UV 统计的细化点是新访客数、新访客比率等。VV 用来统计一天之内网站被用户访问的次数；用户访问网站到结束访问视为 1 次，因此同一个用户在一天之内可能造成多条 VV。IP 用来统计一天之内访问网站的不重复 IP 数。</p>
<h3 id="用户行为分析"><a href="#用户行为分析" class="headerlink" title="用户行为分析"></a>用户行为分析</h3><p>用户行为分析包含页面点击量、用户点击流、用户访问路径、用户点击热力图、用户转化率、导流转化率、用户访问时长分析和用户访问内容分析等。用户点击量用来统计用户在某个可点击或可操作区域的点击或操作次数。用户点击流用来统计用户在页面中发生点击或操作动作的顺序；埋点过程中，可先用 localStorage 存储用户点击或操作行为的唯一 id，然后在一次 VV 结束或下一次 VV 开始时上报。用户访问路径用来统计用户访问页面的路径。用户点击热力图用来统计用户在一张页面中的点击热衷区域；埋点过程中，可以对 document 点击绑定 click 事件，并上报 e.pageX、e.pageY 数据。用户转化率指的是访问页面的注册用户数和页面 PV 的比值。导流转化率指的是导流页面 PV 和源页面 PV 的比值。用户访问时长用来统计用户在关键内容页面的停留时长，以便分析用户是否对内容感兴趣。</p>
<h2 id="埋点方案"><a href="#埋点方案" class="headerlink" title="埋点方案"></a>埋点方案</h2><p>前端埋点分为：代码埋点、可视化埋点、无痕埋点三种。代码埋点即侵入式埋点，可以在任意时刻、任意位置精确地发送数据，但是工作量较大，对业务代码也有较大影响。可视化埋点即以业务代码为输入，通过可视化系统配置埋点，最后以耦合的形式输出业务代码和埋点代码，但是可视化系统的埋点控件有限，并不能充分满足埋点需求。无痕埋点即无差别地对所有事件等进行全埋点，但是没法定制埋点需求。</p>
<img src="/2019/11/03/frontend/前端埋点/track.png">
<h3 id="埋点上报数据"><a href="#埋点上报数据" class="headerlink" title="埋点上报数据"></a>埋点上报数据</h3><p>上报的主要数据包含：appid、userAgent、timestamp（上报的时间戳）、currentUrl（用户当前的 url）、fromUrl（前一个页面的 url）、type（上报事件的类型）、element（触发上报事件的元素）、data（自定义数据）等。数据可通过 OpenSSL 或 crypto 模块进行加密。</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;   </span><br><span class="line">  <span class="comment">// 上报接口本身提供</span></span><br><span class="line">  currentUrl,  </span><br><span class="line">  fromUrl,</span><br><span class="line">  timestamp,</span><br><span class="line">  userAgent: &#123;</span><br><span class="line">    os,</span><br><span class="line">    netWord,</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 业务代码配置和自定义上报数据</span></span><br><span class="line">  <span class="keyword">type</span>,</span><br><span class="line">  appid,</span><br><span class="line">  element,</span><br><span class="line">  data: &#123;</span><br><span class="line">    uid,</span><br><span class="line">    uname</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="mixpanel"><a href="#mixpanel" class="headerlink" title="mixpanel"></a>mixpanel</h2><img src="/2019/11/03/frontend/前端埋点/mixpanel.png">
<p>按我的个性化解读，<a href="https://github.com/mixpanel/mixpanel-js" target="_blank" rel="noopener">mixpanel</a> 分为三层结构：</p>
<ul>
<li>基本工具层：提供类型判断、遍历、继承、bind 等基本的工具函数；json、base64、utf8 编解码能力；url 参数读写函数；cookie、localStorage 读写能力；dom 事件绑定能力；dom 节点查询能力；info 浏览器信息获取能力。</li>
<li>功能模块层：提供基于 DomTracker 实现的 LinkTracker 跳链接埋点、FormTracker 提交数据埋点功能；autotrack 自动埋点功能；基于 cookie 或 localStorage 的 MixpanelPersistence 持久化功能；MixpanelNotification 提示功能；gdbr 依据欧盟《通用数据保护条例》，首先判断用户是否设置了 navigator.doNotTrack 避免数据被追踪，其次判断持久层是否禁止数据被追踪，当两者同时允许追踪埋点数据时，mixpanel 才会上报埋点数据。</li>
<li>核心实现层：MixpanelLib 串联功能、处理选项、发送埋点数据等；MaxpanelGroup；MaxpanelPeople。</li>
</ul>
<p>mixpanel 根据用户配置项，分别使用 img、script 节点、XHR 对象上报数据，这一逻辑实现在 mixpanelLib._send_request(url, data, callback) 方法中。_send_request 方法会附加上报 ip 地址、时间戳等；callback 回调用于处理服务端响应及上传数据。一般而言，在 _send_reques 方法执行前，mixpanel 会调用 gdbr 模块校验用户或持久层的 token 是否禁止数据被追踪；在 _send_reques 方法执行后，mixpanel 会调用 _check_and_handle_notifications 上报用户的唯一标识，并根据返回结果触发弹窗。基于 _send_request，MixpanelLib 封装了 track(event_name, properties, callback)、_dom_loaded 等方法。其中，track 方法附加上持久层的数据，并以 { event, properties } 格式发送到远程服务器中；track_pageview 方法（上报浏览器和页面信息）、LinkTracker、FormTracker 均基于 track 实现（LinkTracker、FormTracker 在上报数据完成后，再触发原始的跳链接、提交操作）。_dom_loaded 在 DOMContentLoaded 事件中触发执行，为 LinkTracker、FormTracke 相关节点绑定事件。autotrack 自动埋点先须由用户开启，其次请求服务器是否允许自动埋点，然后以事件委托的方式在 document 节点层面收集数据并上报。</p>
<p>mixpanel 有其成熟后的复杂度，个别内容不作详解，另作专题剖析。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/02/react/react相关/umi-hooks、hox/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/11/02/react/react相关/umi-hooks、hox/" itemprop="url">umi-hooks、hox</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-02T00:00:00+08:00">2019-11-02</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/react/" itemprop="url" rel="index"><span itemprop="name">react</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/02/react/react相关/umi-hooks、hox/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/11/02/react/react相关/umi-hooks、hox/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>这篇文章仅整理蚂蚁金服的 umi-hooks、hox 的大致实现原理，以说明 react-hooks 的探索空间和实践场景。循着蚂蚁金服体验技术部的足迹，自觉很能开拓眼界和思路。</p>
<h2 id="umi-hooks"><a href="#umi-hooks" class="headerlink" title="umi-hooks"></a>umi-hooks</h2><h3 id="useAsync"><a href="#useAsync" class="headerlink" title="useAsync"></a>useAsync</h3><p>useAsync 用于处理异步请求，它支持的功能点包含暂停、撤销、重启、轮询。</p>
<p>在实现上，umi-hooks 首先构造 Timer 类以定时器方式执行指定函数，timer.stop、timer.pause、timer.resume 方法可用于终止、暂停、重启定时器（初次启动也通过 resume 方法执行）。以定时器处理异步请求一方面能便于实现轮询，另一方面也是由于请求库未必都实现撤销功能。因为定时器并不能真正打断异步请求，所以 useAsync 只是不去处理响应，而不是撤销请求。另外，对于已卸载的组件，也不需要处理响应。因此是否处理响应的状态标识通过 useEffect 处理，在组件卸载时使其失效，通过 timer.stop 终止时也使其失效。这个状态标识通过 useRef 构造：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 是否处理响应标识</span></span><br><span class="line"><span class="comment">// 1. 在异步流程前首先将 count.current 赋值给 runCount 变量</span></span><br><span class="line"><span class="comment">// 2. 异步流程后再判断再判断 count.current 与 runCount 是否等值</span></span><br><span class="line"><span class="comment">// 3. 组件卸载、终止、撤销处理时均将 count.current 自增 1</span></span><br><span class="line"><span class="keyword">const</span> count = useRef(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">const</span> init = useRef(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  count.current += <span class="number">1</span>;</span><br><span class="line">  init.current = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    count.current += <span class="number">1</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;, _deps);</span><br></pre></td></tr></table></figure>
<p>umi-hooks 在 useAsync 函数内部首先通过 useCallback 实现了 run、stop、pause、resume、start 等基础功能（其中，run 方法只是单纯地调用用户传入的异步请求函数 fn）；其次构造 intervalAsync 作为定时器的回调，实现轮询逻辑；其次实现 reload 方法用于重启请求或轮询，cancel 方法取消；最后使用 useEffect 判断选项，分别启用单次请求或轮询功能。以下仅贴示 intervalAsync 的实现：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> intervalAsync = useCallback(</span><br><span class="line">  <span class="keyword">async</span> (...args: <span class="built_in">any</span>[]) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> runCount = count.current;</span><br><span class="line">    <span class="keyword">let</span> ret: Result | <span class="literal">undefined</span>;</span><br><span class="line">    <span class="keyword">if</span> (!_options.manual || !init.current) &#123;</span><br><span class="line">      ret = <span class="keyword">await</span> run(...(args || []));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (count.current === runCount) &#123;</span><br><span class="line">      <span class="comment">// 只初始化定时器，不开始计时</span></span><br><span class="line">      timer.current = <span class="keyword">new</span> Timer&lt;Result&gt;(</span><br><span class="line">        () =&gt; intervalAsync(...args),</span><br><span class="line">        _options.pollingInterval <span class="keyword">as</span> <span class="built_in">number</span>,</span><br><span class="line">      );</span><br><span class="line">      <span class="comment">// 如果设置了 manual，则默认不开始计时</span></span><br><span class="line">      <span class="keyword">if</span> (init.current &amp;&amp; _options.manual) &#123;</span><br><span class="line">        <span class="comment">// await run(...(args || []));</span></span><br><span class="line">        init.current = <span class="literal">false</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 开始计时</span></span><br><span class="line">        ret = <span class="keyword">await</span> timer.current.resume(...(args || []));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">  &#125;,</span><br><span class="line">  [_options.pollingInterval, _options.manual, run],</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="useAPI"><a href="#useAPI" class="headerlink" title="useAPI"></a>useAPI</h3><p>useAPI 在 useAsync 的基础上，以选项指定了远程请求的 url 等参数、异步调用方法。如果没有指定 opt.method 异步调用方法，也可以使用 configRequest 指定或直接使用 window.fetch 方法。</p>
<h3 id="useEventEmitter"><a href="#useEventEmitter" class="headerlink" title="useEventEmitter"></a>useEventEmitter</h3><p>useEventEmitter 用于组织多个组件间的通信逻辑。在实现上，useEventEmitter 基于事件模型。但是绑定事件随着组件的卸载，需要得到解绑，因此 useEventEmitter 使用 useEffect 处理这一逻辑。以下是其源码：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> EventEmitter&lt;T&gt; &#123;</span><br><span class="line">  <span class="keyword">private</span> subscriptions = <span class="keyword">new</span> Set&lt;Subscription&lt;T&gt;&gt;();</span><br><span class="line"></span><br><span class="line">  emit = <span class="function">(<span class="params">val: T</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> subscription of <span class="keyword">this</span>.subscriptions) &#123;</span><br><span class="line">      subscription(val);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  useSubscription = <span class="function">(<span class="params">callback: Subscription&lt;T&gt;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> callbackRef = useRef&lt;Subscription&lt;T&gt;&gt;();</span><br><span class="line">    callbackRef.current = callback;</span><br><span class="line">    useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">subscription</span>(<span class="params">val: T</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (callbackRef.current) &#123;</span><br><span class="line">          callbackRef.current(val);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.subscriptions.add(subscription);</span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.subscriptions.delete(subscription);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;, []);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useEventEmitter</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ref = useRef&lt;EventEmitter&lt;T&gt;&gt;();</span><br><span class="line">  <span class="keyword">if</span> (!ref.current) &#123;</span><br><span class="line">    ref.current = <span class="keyword">new</span> EventEmitter();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ref.current;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="useUpdateEffect"><a href="#useUpdateEffect" class="headerlink" title="useUpdateEffect"></a>useUpdateEffect</h3><p>useUpdateEffect 效果等同 useEffect，只是执行阶段在 didMount 之后（即更新阶段）。</p>
<h3 id="useLocalStorageState"><a href="#useLocalStorageState" class="headerlink" title="useLocalStorageState"></a>useLocalStorageState</h3><p>useLocalStorageState 用于实时从 localStorage 读写值，又借助 useState 实时更新视图层。</p>
<h3 id="useControllableValue"><a href="#useControllableValue" class="headerlink" title="useControllableValue"></a>useControllableValue</h3><p>useControllableValue 用于处理受控值，它首先通过 props 属性读取初始值和实时值（实时值通过 useUpdateEffect 存入 state 中），随后输出 state、handleSetState 以供视图层使用。在 handleSetState 方法执行期间，useControllableValue 还允许执行 props.onChange 等方法。</p>
<h3 id="useSelections"><a href="#useSelections" class="headerlink" title="useSelections"></a>useSelections</h3><p>useSelections 借助 Set 类以及 useMemo 实现，用于处理选择逻辑。</p>
<h3 id="useDynamicList"><a href="#useDynamicList" class="headerlink" title="useDynamicList"></a>useDynamicList</h3><p>useDynamicList 用于管理列表的增删改查逻辑，除了使用 setState 维护列表元素外，还维护了 key 键列表（用于存储原数组元素在 state 中的新的索引）。</p>
<h3 id="usePagination"><a href="#usePagination" class="headerlink" title="usePagination"></a>usePagination</h3><p>usePagination 在 useAsync 的基础上，用于处理分页逻辑。</p>
<h3 id="useSearch"><a href="#useSearch" class="headerlink" title="useSearch"></a>useSearch</h3><p>useSearch 在 useAsync 的基础上，用于在表单或字段内容改变时，自动或手动发送请求获取相应。这一过程通过定时器防抖（避免频繁请求）。</p>
<h3 id="useLoadMore"><a href="#useLoadMore" class="headerlink" title="useLoadMore"></a>useLoadMore</h3><p>useLoadMore 在 useAsync 的基础上，实现了下拉或点击加载更多的处理逻辑。其 reload 逻辑的实现是，使用 state 记录加载次数 count，当这个 count 变更时，再使用 useEffect 远程获取数据。</p>
<h3 id="useAntdTable"><a href="#useAntdTable" class="headerlink" title="useAntdTable"></a>useAntdTable</h3><p>useAntdTable 用于组织 antd-table 表格的逻辑，支持远程请求、分页、筛选、排序、搜索表单等功能。在实现上，useAntdTable 使用 useReducer 管理状态。当表格页面切换时，为了重新加载之前访问的页面数据，useAntdTable 使用 cacheData 缓存数据。在状态变更后，useAntdTable 借助 useUpdateEffect 重新发起请求。当表单数据改变时，useAntdTable 使用定时器获取表单数据，随后更新 state.count 值，最后通过 useUpdateEffect 重新发起请求。以下是部分方法的实现：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 如果存在 options.id，在切换页面时缓存页面数据，切回表格页面时重新加载</span></span><br><span class="line">  <span class="keyword">if</span> (id &amp;&amp; cacheData[id]) &#123;</span><br><span class="line">    <span class="keyword">const</span> cache = cacheData[id];</span><br><span class="line">    <span class="comment">/* 修改完 formData 和 searchType 之后，会触发 useUpdateEffect，给当前表单赋值 */</span></span><br><span class="line">    dispatch(&#123;</span><br><span class="line">      <span class="keyword">type</span>: <span class="string">'updateState'</span>,</span><br><span class="line">      payload: &#123;</span><br><span class="line">        current: cache.current,</span><br><span class="line">        pageSize: cache.pageSize,</span><br><span class="line">        searchType: cache.searchType,</span><br><span class="line">        activeFormData: cache.activeFormData,</span><br><span class="line">        formData: cache.formData,</span><br><span class="line">        filters: cache.filters,</span><br><span class="line">        sorter: cache.sorter,</span><br><span class="line">        count: state.count + <span class="number">1</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (form) &#123;</span><br><span class="line">    <span class="comment">/* 如果有 form，需要走 searchSubmit，为了初始化的时候，拿到 initialValue */</span></span><br><span class="line">    searchSubmit();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    refresh();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (id) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      cacheData[id] = stateRef.current;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;;</span><br><span class="line">&#125;, []);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> searchSubmit = useCallback(</span><br><span class="line">  (e?: <span class="built_in">string</span> | React.MouseEvent&lt;HTMLElement&gt; | React.KeyboardEvent&lt;HTMLInputElement&gt;) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (!form) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (e &amp;&amp; (e <span class="keyword">as</span> React.MouseEvent&lt;HTMLElement&gt;).preventDefault) &#123;</span><br><span class="line">      (e <span class="keyword">as</span> React.MouseEvent&lt;HTMLElement&gt;).preventDefault();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> activeFormData = getCurrentFieldsValues();</span><br><span class="line">      dispatch(&#123;</span><br><span class="line">        <span class="keyword">type</span>: <span class="string">'updateState'</span>,</span><br><span class="line">        payload: &#123;</span><br><span class="line">          activeFormData,</span><br><span class="line">          formData: &#123; ...state.formData, ...activeFormData &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// reload 更新 state 中的 current、count</span></span><br><span class="line">      reload();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  [form, reload],</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="useResponsive"><a href="#useResponsive" class="headerlink" title="useResponsive"></a>useResponsive</h3><p>useResponsive 通过监听 resize 事件，及时更新屏幕尺寸状态（屏幕尺寸分为 xs、sm、md、lg、xl 五种），提供一种绘制响应式视图的能力。</p>
<h3 id="useSize"><a href="#useSize" class="headerlink" title="useSize"></a>useSize</h3><p>useSize 借助 resize-observer-polyfill 库，实时获取 dom 节点的尺寸大小变更。useSize 监听的 dom 节点可以通过首参传入；在不传入首参的情况下，umi-hooks 可以通过 useRef 设置 dom 节点。</p>
<h3 id="useVirtualList"><a href="#useVirtualList" class="headerlink" title="useVirtualList"></a>useVirtualList</h3><p>useVirtualList 用于解决展示海量数据渲染时首屏渲染缓慢和滚动卡顿问题，采用的方式是逐屏滚动。在实现上，useVirtualList 使用滚动容器包裹列表，列表全量展示，通过 onScroll 事件实时设置 scrollTop 设置偏移量。以下是 useVirtualList 的实现：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">&lt;T = <span class="built_in">any</span>&gt;<span class="function">(<span class="params">list: T[], options: OptionType</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [size, containerRef] = useSize&lt;HTMLElement&gt;();</span><br><span class="line">  <span class="comment">// 暂时禁止 cache</span></span><br><span class="line">  <span class="comment">// const distanceCache = useRef&lt;&#123; [key: number]: number &#125;&gt;(&#123;&#125;);</span></span><br><span class="line">  <span class="keyword">const</span> [state, setState] = useState(&#123; start: <span class="number">0</span>, end: <span class="number">10</span> &#125;);</span><br><span class="line">  <span class="keyword">const</span> &#123; itemHeight, overscan = <span class="number">5</span> &#125; = options;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!itemHeight) &#123;</span><br><span class="line">    <span class="built_in">console</span>.warn(<span class="string">'please enter a valid itemHeight'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取滚动容器能展示的元素数</span></span><br><span class="line">  <span class="keyword">const</span> getViewCapacity = <span class="function">(<span class="params">containerHeight: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> itemHeight === <span class="string">'number'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Math</span>.ceil(containerHeight / itemHeight);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> &#123; start = <span class="number">0</span> &#125; = state;</span><br><span class="line">    <span class="keyword">let</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> capacity = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = start; i &lt; list.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> height = <span class="function">(<span class="params">itemHeight <span class="keyword">as</span> (<span class="params">(<span class="params">index: <span class="built_in">number</span></span>) =&gt; <span class="built_in">number</span></span>)</span>)(<span class="params">i</span>);</span></span><br><span class="line"><span class="function">      <span class="params">sum</span> += <span class="params">height</span>;</span></span><br><span class="line"><span class="function">      <span class="params">if</span> (<span class="params">sum &gt;= containerHeight</span>) &#123;</span></span><br><span class="line"><span class="function">        <span class="params">capacity</span> = <span class="params">i</span>;</span></span><br><span class="line"><span class="function">        <span class="params">break</span>;</span></span><br><span class="line"><span class="function">      &#125;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">    <span class="params">return</span> <span class="params">capacity</span> - <span class="params">start</span>;</span></span><br><span class="line"><span class="function">  &#125;;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // 计算滚动隐藏内容的元素数</span></span><br><span class="line"><span class="function">  <span class="params">const</span> <span class="params">getOffset</span> = (<span class="params">scrollTop: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> itemHeight === <span class="string">'number'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Math</span>.floor(scrollTop / itemHeight) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> offset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; list.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> height = <span class="function">(<span class="params">itemHeight <span class="keyword">as</span> (<span class="params">(<span class="params">index: <span class="built_in">number</span></span>) =&gt; <span class="built_in">number</span></span>)</span>)(<span class="params">i</span>);</span></span><br><span class="line"><span class="function">      <span class="params">sum</span> += <span class="params">height</span>;</span></span><br><span class="line"><span class="function">      <span class="params">if</span> (<span class="params">sum &gt;= scrollTop</span>) &#123;</span></span><br><span class="line"><span class="function">        <span class="params">offset</span> = <span class="params">i</span>;</span></span><br><span class="line"><span class="function">        <span class="params">break</span>;</span></span><br><span class="line"><span class="function">      &#125;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">    <span class="params">return</span> <span class="params">offset</span> + 1;</span></span><br><span class="line"><span class="function">  &#125;;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // 计算列表的起止元素</span></span><br><span class="line"><span class="function">  <span class="params">const</span> <span class="params">calculateRange</span> = <span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> element = containerRef.current;</span><br><span class="line">    <span class="keyword">if</span> (element) &#123;</span><br><span class="line">      <span class="keyword">const</span> offset = getOffset(element.scrollTop);</span><br><span class="line">      <span class="keyword">const</span> viewCapacity = getViewCapacity(element.clientHeight);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> <span class="keyword">from</span> = offset - overscan;</span><br><span class="line">      <span class="keyword">const</span> to = offset + viewCapacity + overscan;</span><br><span class="line">      setState(&#123; start: <span class="keyword">from</span> &lt; <span class="number">0</span> ? <span class="number">0</span> : <span class="keyword">from</span>, end: to &gt; list.length ? list.length : to &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 在滚动容器变更时，重新计算列表的起止元素</span></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    calculateRange();</span><br><span class="line">  &#125;, [size.width, size.height]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计算列表总高度</span></span><br><span class="line">  <span class="keyword">const</span> totalHeight = useMemo(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> itemHeight === <span class="string">'number'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> list.length * itemHeight;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list.reduce(<span class="function">(<span class="params">sum, _, index</span>) =&gt;</span> sum + itemHeight(index), <span class="number">0</span>);</span><br><span class="line">  &#125;, [list.length]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取 index 元素与顶部的距离</span></span><br><span class="line">  <span class="keyword">const</span> getDistanceTop = <span class="function">(<span class="params">index: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> itemHeight === <span class="string">'number'</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> height = index * itemHeight;</span><br><span class="line">      <span class="keyword">return</span> height;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> height = list.slice(<span class="number">0</span>, index).reduce(<span class="function">(<span class="params">sum, _, i</span>) =&gt;</span> sum + itemHeight(i), <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> height;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> scrollTo = <span class="function">(<span class="params">index: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (containerRef.current) &#123;</span><br><span class="line">      containerRef.current.scrollTop = getDistanceTop(index);</span><br><span class="line">      calculateRange();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="comment">// 通过 state 待展示的元素</span></span><br><span class="line">    list: list.slice(state.start, state.end).map(<span class="function">(<span class="params">ele, index</span>) =&gt;</span> (&#123;</span><br><span class="line">      data: ele,</span><br><span class="line">      index: index + state.start,</span><br><span class="line">    &#125;)),</span><br><span class="line">    scrollTo,</span><br><span class="line">    containerProps: &#123;</span><br><span class="line">      ref: <span class="function">(<span class="params">ele: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">        containerRef.current = ele;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// 通过滚动事件重新设置偏移量</span></span><br><span class="line">      onScroll: <span class="function">(<span class="params">e: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">        e.preventDefault();</span><br><span class="line">        calculateRange();</span><br><span class="line">      &#125;,</span><br><span class="line">      style: &#123; overflowY: <span class="string">'auto'</span> &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    wrapperProps: &#123;</span><br><span class="line">      style: &#123; width: <span class="string">'100%'</span>, height: totalHeight, paddingTop: getDistanceTop(state.start) &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="hox"><a href="#hox" class="headerlink" title="hox"></a>hox</h2><p>hox 号称“下一代状态管理器”，因此它的意图还是在于使用 hooks 抽象 ViewModel 层，将 hooks 的使用过程从与视图组件的强关联中解放出来，同时支持在类组件中也能使用 hooks。那么，它是怎么做到的呢？它的代码逻辑很简单，即使用 Exector 虚拟组件来运作 hooks 逻辑，hooks 返回值通过绑定事件的方式通知到 Exector 虚拟组件外层，然后使用 setState 接值，传入实际渲染的视图组件中。</p>
<img src="/2019/11/02/react/react相关/umi-hooks、hox/hox.png">
<p>以下是其实现逻辑：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createModel</span>&lt;<span class="title">T</span>&gt;(<span class="params">hook: ModelHook&lt;T&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> element = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>);</span><br><span class="line">  <span class="comment">// Container 提供事件绑定、触发的机制</span></span><br><span class="line">  <span class="keyword">const</span> container = <span class="keyword">new</span> Container(hook);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过虚拟组件承载 hooks 执行逻辑，每次重绘时执行 hooks 并 onUpdate 钩子</span></span><br><span class="line">  ReactDOM.render(</span><br><span class="line">    &lt;Executor</span><br><span class="line">      onUpdate=&#123;<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">        container.data = val;</span><br><span class="line">        container.notify();</span><br><span class="line">      &#125;&#125;</span><br><span class="line">      hook=&#123;hook&#125;</span><br><span class="line">    /&gt;,</span><br><span class="line">    element</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> useModel: UseModel&lt;T&gt; = <span class="function"><span class="params">depsFn</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> [state, setState] = useState&lt;T | <span class="literal">undefined</span>&gt;<span class="function">(<span class="params">(<span class="params"></span>) =&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">      container ? (<span class="params">container.data <span class="keyword">as</span> T</span>) : <span class="literal">undefined</span></span></span></span><br><span class="line"><span class="function"><span class="params">    </span>);</span></span><br><span class="line"><span class="function">    <span class="params">const</span> <span class="params">depsFnRef</span> = <span class="params">useRef</span>(<span class="params">depsFn</span>);</span></span><br><span class="line"><span class="function">    <span class="params">depsFnRef</span>.<span class="params">current</span> = <span class="params">depsFn</span>;</span></span><br><span class="line"><span class="function">    <span class="params">const</span> <span class="params">depsRef</span> = <span class="params">useRef</span>&lt;<span class="params">unknown</span>[]&gt;(<span class="params">[]</span>);</span></span><br><span class="line"><span class="function">    <span class="params">useEffect</span>(<span class="params">(<span class="params"></span>) =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">if</span> (<span class="params">!container</span>) <span class="keyword">return</span>;</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="comment">// 作为绑定函数，承接 hooks 返回值，并使用 useState 机制传给实际的视图组件</span></span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">function</span> subscriber(<span class="params">val: T</span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">if</span> (<span class="params">!depsFnRef.current</span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">          setState(<span class="params">val</span>);</span></span></span><br><span class="line"><span class="function"><span class="params">        &#125; <span class="keyword">else</span> &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">const</span> oldDeps = depsRef.current;</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">const</span> newDeps = depsFnRef.current(<span class="params">val</span>);</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">if</span> (<span class="params">compare(<span class="params">oldDeps, newDeps</span>)</span>) &#123;<span class="comment">// 比较依赖</span></span></span></span><br><span class="line"><span class="function"><span class="params">            setState(<span class="params">val</span>);</span></span></span><br><span class="line"><span class="function"><span class="params">          &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">          depsRef.current = newDeps;</span></span></span><br><span class="line"><span class="function"><span class="params">        &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">      &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">      container.subscribers.add(<span class="params">subscriber</span>);</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">return</span> (<span class="params"></span>) =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">        container.subscribers.<span class="keyword">delete</span>(<span class="params">subscriber</span>);</span></span></span><br><span class="line"><span class="function"><span class="params">      &#125;;</span></span></span><br><span class="line"><span class="function"><span class="params">    &#125;, [container]</span>);</span></span><br><span class="line"><span class="function">    <span class="params">return</span> <span class="params">state</span>!;</span></span><br><span class="line"><span class="function">  &#125;;</span></span><br><span class="line"><span class="function">  <span class="params">Object</span>.<span class="params">defineProperty</span>(<span class="params">useModel, "data", &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">get</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">return</span> container.data;</span></span></span><br><span class="line"><span class="function"><span class="params">    &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;</span>);</span></span><br><span class="line"><span class="function">  <span class="params">return</span> <span class="params">useModel</span>;</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<p>当一个视图组件需要多个 model 时，hox 像 redux 一样提供了 withModel 方法用于将多个 model 内容传输给类组件的 props。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/29/frontend/hybird app/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/29/frontend/hybird app/" itemprop="url">hybird app</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-10-29T00:00:00+08:00">2019-10-29</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/实践/" itemprop="url" rel="index"><span itemprop="name">实践</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/10/29/frontend/hybird app/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/10/29/frontend/hybird app/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>hybird app 介于 native app、web app 之间，性能比 web app 好，比 native app 差，但是适应了更多的移动开发场景。hybird app 具有如下特点：因为受到移动设备CPU、内存、网卡、网络连接等限制，hybird app 可用的系统网络资源有限；hybird app 支持更新的浏览器特性；hybird app 可实现离线应用，即借助浏览器最新的特性或 Native 的文件读取机制进行文件级的文件缓存或离线更新；hybird app 需要考虑不同设备机型的兼容性问题；hybird app 支持唤起 Native 的能力，如摄像头、定位、传感器、本地文件访问等。理想情况下，hybird app 须唤起 native 能力绘制通用导航菜单、系统 UI、核心动效等，这样能充分利用 native 的性能优势（WebView 的执行性能只有移动端浏览器的 1/3 ~ 1/4）。</p>
<h2 id="web-到-native-通信协议"><a href="#web-到-native-通信协议" class="headerlink" title="web 到 native 通信协议"></a>web 到 native 通信协议</h2><h3 id="通过-url"><a href="#通过-url" class="headerlink" title="通过 url"></a>通过 url</h3><p>Native 应用在移动端系统中注册一个 Schema 协议的 URI，这个 URI 可在系统的任意地方授权访问来掉漆一段原生方法或一个原生的界面。在此基础上，Native 应用的 WebView 控件中的 js 脚本也可以远程请求匹配 Schema 协议的 URI，如通过 iframe 的 src 属性，这个请求就能被 Native 应用的系统捕获并调起 Native 应用注册匹配的 Schema 协议内容，以唤起原生能力。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> iframe = <span class="built_in">document</span>.createElement(<span class="string">'iframe'</span>);</span><br><span class="line">iframe.setAttribute(<span class="string">'style'</span>, <span class="string">'display: none'</span>);</span><br><span class="line"><span class="built_in">document</span>.appendChild(iframe);</span><br><span class="line">iframe.setAttribute(<span class="string">'src'</span>, <span class="string">'myApp://className/method?args'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="通过-addJavascriptInterface"><a href="#通过-addJavascriptInterface" class="headerlink" title="通过 addJavascriptInterface"></a>通过 addJavascriptInterface</h3><p>Native 应用也可以通过 addJavascriptInterface 方法将 Native 的一个对象方法注入到页面 window 对象中，供 js 调用。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Websettings websettings = webView.getSettings();</span><br><span class="line">websettings.setJavascriptEnabled(<span class="keyword">true</span>);<span class="comment">// 设置 webView 允许执行 js 脚本</span></span><br><span class="line">webView.loadUrl(<span class="string">'file:///android_asset/index.html'</span>);<span class="comment">// 加载页面到 webView 中</span></span><br><span class="line">webView.addJavascriptInterface(<span class="keyword">new</span> JsInterface(), <span class="string">'native'</span>);<span class="comment">// window 加入 native 对象</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JsInterface</span> </span>&#123;</span><br><span class="line">  <span class="meta">@JavascriptInterface</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">showToast</span><span class="params">(String toast)</span> </span>&#123;</span><br><span class="line">    Toast.makeText(MainActivity.<span class="keyword">this</span>, toast, Toast.LENGTH_SHORT).show();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>addJavascriptInterface 在 Android 4.2 以下版本有安全漏洞。另一种可行的方法时，当 js 调用 alert 或 prompt 方法时，会执行 Native 中的 onJsAlert 或 onJsPrompt 方法，因此就可以用这两个方法加以监听 html5 传递的消息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">webView.setWebChromeClient(<span class="keyword">new</span> WebChromeClient() &#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onJsPrompt</span><span class="params">(WebView view, String url, String message, </span></span></span><br><span class="line"><span class="function"><span class="params">    String defaultValue, JsPromptResult result)</span> </span>&#123;</span><br><span class="line">    result.confirm(JSBridge.callJsPrompt(MainActivity.<span class="keyword">this</span>, view, message));</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<h2 id="native-到-web-通信协议"><a href="#native-到-web-通信协议" class="headerlink" title="native 到 web 通信协议"></a>native 到 web 通信协议</h2><p>首先在 html5 页面的全局作用域下声明一个方法；其次在 Android 中使用 loadUrl 唤起这个方法，或者在 iOS 中使用 stringByEvaluatingJavaScriptFromString 唤起这个方法，这样就能使 Native 应用主动调用 html5 中的 js 方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Websettings websettings = webView.getSettings();</span><br><span class="line">websettings.setJavascriptEnabled(<span class="keyword">true</span>);<span class="comment">// 设置 webView 允许执行 js 脚本</span></span><br><span class="line">webView.loadUrl(<span class="string">'file:///android_asset/index.html'</span>);<span class="comment">// 加载页面到 webView 中</span></span><br><span class="line">JsInterface jsInterface = <span class="keyword">new</span> JsInterface();</span><br><span class="line">jsInterface.log(<span class="string">'hello world'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JsInterface</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">log</span><span class="params">(<span class="keyword">final</span> String msg)</span> </span>&#123;</span><br><span class="line">    webView.post(<span class="keyword">new</span> Runnable() &#123;<span class="comment">// 创建一个新线程执行 js 中的 log 方法</span></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="comment">// 调用 html5 中 window.log 方法</span></span><br><span class="line">        webView.loadUrl(<span class="string">'javascript: log('</span> + <span class="string">'"'</span> + msg + <span class="string">'"'</span> + <span class="string">')'</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="通信协议"><a href="#通信协议" class="headerlink" title="通信协议"></a>通信协议</h2><p>目前较多使用的通信协议方案为 jsbridge://className:callbackMethod/methodName?jsonObj。jsbridge 为 Native 注册的协议头；className 为调用 Native 的类；methodName 为类中的方法名；jsonObj 为传递的参数；callbackMethod 为 Native 回调 js 的方法名，即 Native 调用 webView.loadUrl(‘javascript: callbackMethod()’)。以 html5 中请求 jsbridge://Util:success/toString?{“msg”: “hello world”} 为例，Native 使用 Util 类中的 toString 方法处理参数 {“msg”: “hello world”}，完成后再回调 html5 中的 success 方法。</p>
<p>通常 jsBridge 中会使用公共方法发送请求。如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">JsBridge.call = <span class="function"><span class="keyword">function</span>(<span class="params">className, methodName, params, callback</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> bridgeStr;</span><br><span class="line">  <span class="keyword">let</span> paramsStr = <span class="built_in">JSON</span>.stingify(params || &#123;&#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (className &amp;&amp; methodName)&#123;</span><br><span class="line">    bridgeStr = <span class="string">`jsbridge://<span class="subst">$&#123;className&#125;</span>:<span class="subst">$&#123;callback&#125;</span>/<span class="subst">$&#123;methodName&#125;</span>?<span class="subst">$&#123;paramsStr&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      sendToNative(bridgeStr);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(e) &#123;</span><br><span class="line">      <span class="built_in">console</span>.log(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'Invalid className or methodName'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setToNative</span>(<span class="params">url, data</span>)</span>&#123;</span><br><span class="line">  <span class="built_in">window</span>.prompt(url, <span class="built_in">JSON</span>.stringify(data || &#123;&#125;));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="离线缓存与更新"><a href="#离线缓存与更新" class="headerlink" title="离线缓存与更新"></a>离线缓存与更新</h2><h3 id="ServiceWorker"><a href="#ServiceWorker" class="headerlink" title="ServiceWorker"></a>ServiceWorker</h3><p>使用 ServiceWorker 作离线缓存可参考 <a href="https://blog.csdn.net/huangpb123/article/details/89498418" target="_blank" rel="noopener">Service Worker —— 这应该是一个挺全面的整理</a>，ServiceWorker 有兼容性问题。</p>
<h3 id="localeStorage"><a href="#localeStorage" class="headerlink" title="localeStorage"></a>localeStorage</h3><p>使用 localeStorage 作离线缓存就是带版本号形式缓存静态资源、页面内容、响应。典型如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> newVersion = <span class="built_in">document</span>.getElementById(<span class="string">'versionStore'</span>).getAttribute(<span class="string">'data-version'</span>);</span><br><span class="line"><span class="keyword">const</span> oldVersion = localeStorage.getItem(<span class="string">'version'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (newVersion &gt; (oldVersion || <span class="number">0</span>))&#123;</span><br><span class="line">  loadScript(<span class="string">`scriptpath/<span class="subst">$&#123;newVersion&#125;</span>.js`</span>).then(<span class="function"><span class="params">content</span> =&gt;</span> &#123;</span><br><span class="line">    localeStorage.setItem(<span class="string">'scriptpath'</span>, content);</span><br><span class="line">  &#125;)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</span><br><span class="line">  script.innerHtml = localeStorage.getItem(<span class="string">'scriptpath'</span>);</span><br><span class="line">  <span class="built_in">document</span>.appendChild(script);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>使用 localeStorage 有以下缺点：大小有限制（同域一般认为 5M 以内）；用户手动清空会使 localeStorage 失效；读取 localeStorage 较慢。</p>
<h3 id="文件增量更新"><a href="#文件增量更新" class="headerlink" title="文件增量更新"></a>文件增量更新</h3><p>文件增量更新指的是：客户端通过 localeStorage 获取本地缓存资源的版本号，与 html 页面中最新版本号对比，如果本地版本号较小，则加载增量的静态资源，如本地为 1.1.js，远程最新版本为 1.4.js，则增量获取 1.1-1.4.js。有两种机制可以实现文件的增量更新：基于代码分块、基于编辑距离。基于代码分块的思路是，以增量描述说明代码块的变动内容，新增、删除、修改、保持原样；然后根据原文件和增量描述产生新文件。基于编辑距离（Levenshtein Distance）是计算从一个字符串变更到另一个字符串的最少操作步骤，适合于少量字符串变更的文件内容。</p>
<p>使用文件增量更新机制，有必要埋点统计不同版本号的用户覆盖率。</p>
<h3 id="native-离线资源"><a href="#native-离线资源" class="headerlink" title="native 离线资源"></a>native 离线资源</h3><p>当用户访问页面，native 首先会检查离线资源包中是否存在本地目录中的文件，然后将其与线上资源对比：如果线上有最新资源，则拉取线上资源并缓存，没有，就使用本地资源。这样当再次访问页面时，WebView 就可以读取本地资源了。</p>
<h2 id="支付宝-jssdk"><a href="#支付宝-jssdk" class="headerlink" title="支付宝 jssdk"></a>支付宝 jssdk</h2><p><a href="https://gw.alipayobjects.com/as/g/h5-lib/alipayjsapi/3.1.1/alipayjsapi.js" target="_blank" rel="noopener">alipayjsapi</a> 首先添加 <a href="https://raw.githubusercontent.com/stefanpenner/es6-promise/master/LICENSE" target="_blank" rel="noopener">es6-promise</a> 垫片。</p>
<h3 id="核心流程"><a href="#核心流程" class="headerlink" title="核心流程"></a>核心流程</h3><p>alipayjsapi 通过 addJavascriptInterface 为 window 对象注入 AlipayJSBridge 对象，html5 页面中即可以用如 AlipayJSBridge.call(‘alert’,{message: 12345}) 形式唤起 native 能力。alipayjsapi 另外构造了一个 _JSAPI 对象。_JSAPI 约定了各方法是怎样处理入参、唤起 native 能力、处理出参等的。下面以 redirectTo 说明 _JSAPI 对象的构造：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> _JSAPI = &#123;</span><br><span class="line">  compressImage: &#123;</span><br><span class="line">    b: <span class="function"><span class="keyword">function</span> <span class="title">b</span>(<span class="params">opt</span>) </span>&#123;</span><br><span class="line">      opt.level = __isUndefined(opt.level) ? <span class="number">4</span> : opt.level;</span><br><span class="line">      <span class="comment">// _mapping 将 opt._ 更名为 opt.apFilePaths</span></span><br><span class="line">      <span class="keyword">return</span> _mapping(opt, &#123;</span><br><span class="line">        _: <span class="string">'apFilePaths'</span>,</span><br><span class="line">        level: <span class="string">'compressLevel%d'</span></span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;,</span><br><span class="line">    d: <span class="function"><span class="keyword">function</span> <span class="title">d</span>(<span class="params">_opt, cb</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (__isAndroid()) &#123;</span><br><span class="line">        _JS_BRIDGE.call(<span class="string">'compressImage'</span>, _opt, cb);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// _fakeCallBack 使用定时器直接调用 cb</span></span><br><span class="line">        _fakeCallBack(cb, &#123;</span><br><span class="line">          apFilePaths: _opt.apFilePaths || []</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在 _JSAPI 对象中，每个 api 可能包含以下方法或属性：m，即 mapping 的缩写，指定 native 端实际的接口名；b，即 before 的缩写，前置处理函数，用于转化入参；d，即 doing 的缩写，指定实际的执行流程（在不指定的情况下，将使用 AlipayJSBridge.call 的形式唤起 native 能力）；a，即 after 的缩写，后置处理函数，用于转化出参；e 或者 extra，指定 handleEventData 等扩展字段。在上面一段代码中，compressImage.b 就在转换选项，compressImage.d 就在执行图片压缩操作或不作任何处理。</p>
<p>在 _JSAPI 的基础上，alipayjsapi 的核心流程即使用 _JSAPI 处理出入参数，再使用 AlipayJSBridge.call 唤起 native 能力；偶然绑定事件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> AP = &#123;</span><br><span class="line">  call: <span class="function"><span class="keyword">function</span> <span class="title">call</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> args = __argumentsToArg(<span class="built_in">arguments</span>);</span><br><span class="line">    <span class="keyword">if</span> (__isSupportPromise()) &#123;</span><br><span class="line">      <span class="keyword">return</span> AP.ready().then(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(realCall);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//如果直接加到 ready 事件里会有不触发调用的情况</span></span><br><span class="line">      <span class="comment">//AP.ready(realCall);</span></span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (_isBridgeReady()) &#123;</span><br><span class="line">        realCall();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//保存在待执行队列</span></span><br><span class="line">        _WAITING_QUEUE.push(args);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">realCall</span>(<span class="params">resolve, reject</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> apiName;</span><br><span class="line">      <span class="keyword">var</span> opt; <span class="comment">//原始 option</span></span><br><span class="line">      <span class="keyword">var</span> cb; <span class="comment">//原始 callback</span></span><br><span class="line">      <span class="keyword">var</span> _opt; <span class="comment">//处理过的 option</span></span><br><span class="line">      <span class="keyword">var</span> _cbSFC; <span class="comment">//不同状态回调</span></span><br><span class="line">      <span class="keyword">var</span> _cb; <span class="comment">//处理过的 callback</span></span><br><span class="line">      <span class="keyword">var</span> onEvt;</span><br><span class="line">      <span class="keyword">var</span> offEvt;</span><br><span class="line">      <span class="keyword">var</span> doingFn;</span><br><span class="line">      <span class="keyword">var</span> logOpt;</span><br><span class="line">      <span class="comment">//强制转为 name + object + function 形式的入参</span></span><br><span class="line">      apiName = args[<span class="number">0</span>] + <span class="string">''</span>;</span><br><span class="line">      opt = args[<span class="number">1</span>];</span><br><span class="line">      cb = args[<span class="number">2</span>];</span><br><span class="line">      <span class="comment">//处理 cb 和 opt 的顺序</span></span><br><span class="line">      <span class="keyword">if</span> (__isUndefined(cb) &amp;&amp; __isFunction(opt)) &#123;</span><br><span class="line">        cb = opt;</span><br><span class="line">        opt = &#123;&#125;;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//接口有非对象入参，设为快捷入参</span></span><br><span class="line">      <span class="keyword">if</span> (!__isObject(opt) &amp;&amp; args.length &gt;= <span class="number">2</span>) &#123;</span><br><span class="line">        <span class="comment">//before、doing、after 方法中直接取 opt._ 作为参数</span></span><br><span class="line">        opt = &#123;</span><br><span class="line">          _: opt</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//兜底</span></span><br><span class="line">      <span class="keyword">if</span> (__isUndefined(opt)) &#123;</span><br><span class="line">        opt = &#123;&#125;;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 处理入参，使用 _JSAPI[apiName].b 处理 opt</span></span><br><span class="line">      _opt = _getApiOption(apiName, opt, cb);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 获取回调，_opt 以 success、fail、complete 属性约定回调</span></span><br><span class="line">      _cbSFC = _getApiCallBacks(apiName, _opt);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (__isUndefined(_opt)) &#123;</span><br><span class="line">        <span class="built_in">console</span>.error(<span class="string">'please confirm '</span> + apiName + <span class="string">'.before() returns the options.'</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 获取 _JSAPI[apiName].d 方法</span></span><br><span class="line">      doingFn = _getApiDoing(apiName);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 输出入参</span></span><br><span class="line">      logOpt = __hasOwnProperty(opt, <span class="string">'_'</span>) ? opt._ : opt;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// AP.debug 置为真值时，在控制台打印信息</span></span><br><span class="line">      _apiLog(apiName, logOpt, _opt);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 是否是事件监听，apiName 以 on 起始</span></span><br><span class="line">      onEvt = _getApiOnEvent(apiName);</span><br><span class="line">      <span class="comment">// 是否是事件移除，apiName 以 off 起始</span></span><br><span class="line">      offEvt = _getApiOffEvent(apiName);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 处理回调</span></span><br><span class="line">      _cb = <span class="function"><span class="keyword">function</span> <span class="title">_cb</span>(<span class="params">res</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">var</span> _res = <span class="keyword">void</span> <span class="number">0</span>;</span><br><span class="line">        res = res || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (onEvt &amp;&amp; _getApiExtra(apiName, <span class="string">'handleEventData'</span>) !== <span class="literal">false</span>) &#123;</span><br><span class="line">          _res = _handleEventData(res);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用 _JSAPI[apiName].a 处理结果</span></span><br><span class="line">        _res = _getApiResult(apiName, _res || res, _opt, opt, cb);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (__isUndefined(_res)) &#123;</span><br><span class="line">          <span class="built_in">console</span>.error(<span class="string">'please confirm '</span> + apiName + <span class="string">'.after() returns the result.'</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 处理错误码及相应，即处理 _res.error 及 res</span></span><br><span class="line">        _res = _handleApiError(apiName, _res);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 打印 debug 日志</span></span><br><span class="line">        _apiLog(apiName, logOpt, _opt, res, _res);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (__hasOwnProperty(_res, <span class="string">'error'</span>) || __hasOwnProperty(_res, <span class="string">'errorMessage'</span>)) &#123;</span><br><span class="line">          <span class="keyword">if</span> (__isFunction(reject)) &#123;</span><br><span class="line">            reject(_res);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (__isFunction(_cbSFC.fail)) &#123;</span><br><span class="line">            _cbSFC.fail(_res);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (__isFunction(resolve)) &#123;</span><br><span class="line">            resolve(_res);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (__isFunction(_cbSFC.success)) &#123;</span><br><span class="line">            _cbSFC.success(_res);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (__isFunction(_cbSFC.complete)) &#123;</span><br><span class="line">          _cbSFC.complete(_res);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 执行用户的回调</span></span><br><span class="line">        <span class="keyword">if</span> (__isFunction(cb)) &#123;</span><br><span class="line">          cb(_res);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 如果存在 d 直接执行，否则执行 AlipayJSBridge.call</span></span><br><span class="line">      <span class="keyword">if</span> (__isFunction(doingFn)) &#123;</span><br><span class="line">        doingFn(_opt, _cb, opt, cb);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (onEvt) &#123;</span><br><span class="line">        <span class="comment">// 将事件、处理函数等存入 _CACHE.EVENTS</span></span><br><span class="line">        _cacheEventHandler(onEvt, cb, _cb, _cbSFC);</span><br><span class="line">        <span class="comment">// 使用 document.addEventListener 绑定事件</span></span><br><span class="line">        AP.on(onEvt, _cb);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (offEvt) &#123;</span><br><span class="line">        _removeEventHandler(offEvt, cb);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 执行 AlipayJSBridge.call</span></span><br><span class="line">        _JS_BRIDGE.call(_getApiName(apiName), _opt, _cb);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 埋点，发送日志到远程服务器</span></span><br><span class="line">      _apiRemoteLog(apiName);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="埋点"><a href="#埋点" class="headerlink" title="埋点"></a>埋点</h3><p>alipayjsapi 先收集调用的 api，当收集的 api 到 6 个时，再使用定时器上报。alipayjsapi 兜底使用返回按钮的 back 事件上报日志。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> _apiRemoteLog = <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> apiInvokeQueue = [];</span><br><span class="line">  <span class="keyword">var</span> timerId = <span class="keyword">void</span> <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">var</span> isTimerActived = <span class="literal">false</span>;</span><br><span class="line">  <span class="comment">//发送日志</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">triggerSendLog</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (apiInvokeQueue.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> param1 = apiInvokeQueue.join(<span class="string">'|'</span>);</span><br><span class="line">        AP.ready(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">          _JS_BRIDGE.call(<span class="string">'remoteLog'</span>, &#123;</span><br><span class="line">            type: <span class="string">'monitor'</span>,</span><br><span class="line">            bizType: <span class="string">'ALIPAYJSAPI'</span>,</span><br><span class="line">            logLevel: <span class="number">1</span>, <span class="comment">// 1 - high, 2 - medium, 3 - low</span></span><br><span class="line">            actionId: <span class="string">'MonitorReport'</span>,</span><br><span class="line">            seedId: <span class="string">'ALIPAYJSAPI_INVOKE_COUNTER'</span>,</span><br><span class="line">            param1: param1</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125;);</span><br><span class="line">        AP.debug &amp;&amp; <span class="built_in">console</span>.info(<span class="string">'REMOTE_LOG_QUEUE&gt;'</span>, apiInvokeQueue);</span><br><span class="line">        apiInvokeQueue = [];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// 停止计时器</span></span><br><span class="line">      clearTimer();</span><br><span class="line">    &#125;, <span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计时器</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">timer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 计时激活标致</span></span><br><span class="line">    isTimerActived = <span class="literal">true</span>;</span><br><span class="line">    <span class="comment">// 启动计时器</span></span><br><span class="line">    timerId = setTimeout(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// 日志发送</span></span><br><span class="line">      triggerSendLog();</span><br><span class="line">    &#125;, <span class="number">5000</span>); <span class="comment">// 5 秒上报</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清除计时器</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">clearTimer</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    !__isUndefined(timerId) &amp;&amp; clearTimeout(timerId);</span><br><span class="line">    isTimerActived = <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// back 事件上报日志，作为兜底</span></span><br><span class="line">  AP.on(<span class="string">'back'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    triggerSendLog();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> (<span class="params">apiName</span>) </span>&#123;</span><br><span class="line">    apiInvokeQueue.push(apiName);</span><br><span class="line">    <span class="comment">// 6 个上报</span></span><br><span class="line">    <span class="keyword">if</span> (apiInvokeQueue.length &gt;= <span class="number">6</span>) &#123;</span><br><span class="line">      triggerSendLog();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isTimerActived) &#123;</span><br><span class="line">      timer();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;();</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>《现代前端技术解析》 —— 张成文</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/27/编辑器/uform/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/27/编辑器/uform/" itemprop="url">uform</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-10-27T00:00:00+08:00">2019-10-27</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/react/" itemprop="url" rel="index"><span itemprop="name">react</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/10/27/编辑器/uform/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/10/27/编辑器/uform/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>通常对表单的抽象分为状态管理和视图组件两部分。按我的理解，uform 的三层结构与 redux + redux-react + react 组件或 mobx + mobx-react + react 组件的构成模式相仿。</p>
<img src="/2019/10/27/编辑器/uform/uform.png">
<ul>
<li>@uform/core：状态管理层，抽象通用 form 表单、field 字段的状态管理逻辑。</li>
<li>@uform/react：抽象视图层，其一桥接状态管理器和视图组件，其二用于注册组件或容器等。</li>
<li>@uform/antd, @uform/next：视图组件层，对接特定的视图组件库。</li>
</ul>
<h2 id="uform-core"><a href="#uform-core" class="headerlink" title="@uform/core"></a>@uform/core</h2><p>在不借助 redux 等状态管理器的前提下，针对业务逻辑抽象状态管理的做法是：OOP 编程方式抽象状态管理类，并提供统一的副作用接口驱动视图重绘。多个 store 之间可以通过消息总线通信；或者相互持有实例；或者在视图层组织交互逻辑。在这种设计思想下，store 状态管理类和 view 视图组件类即如下图：</p>
<img src="/2019/10/27/编辑器/uform/store.png">
<p>不同于 redux 等适用于全领域的状态管理器，表单的状态管理有其特点，所涉及的状态包含表单数据、脏值状态、校验状态、错误状态、编辑状态（在表单编辑器中）、props 等。表单状态管理分为两层：Form 表单层级、Field 字段层级。rc-form 的状态管理没有到字段层级，FormItem 组件从子字段中获取校验信息等数据。更为精细的状态管理需要到字段层级，这样就可以不用重绘表单，而是重绘字段组件。因为字段组件的类型众多，业务实体也可能以字段组件的形式呈现，所以，一般使用通用的 Field 模型抽象字段的状态管理逻辑。</p>
<img src="/2019/10/27/编辑器/uform/form_field.png">
<p>在 uform 中，Field 实例以 field.context 属性持有 Form 实例。Form、Field 实例对外通信均可以通过 Broadcast 绑定订阅函数达成，典型的订阅函数即利用 setState 以驱动组件重绘。不同的是，Form 实例用于构造对外交互接口，允许用户挂载多个订阅函数；Field 实例只允许挂载一个订阅函数 —— 变异的 setState，既驱动字段组件重绘，又驱动表单状态更新。Form 内部的事件机制通过 <a href="https://www.jianshu.com/p/f92ce317b07b" target="_blank" rel="noopener">rxjs 的 Subject</a> 实现，支持通过初始化选项绑定事件回调，其被称为 effect 副作用，包含 onFormReset、onFormSubmit、onFieldInit、onFieldChange、onFieldInputChange 这几类。</p>
<p>表单数据状态变更只有一种模式：通过 Form 提供的接口更新，Field 接口不对外暴露。因为字段组件的绑定事件挂载了 mutators.change（mutators 由封装 Form 接口实现），所以当用户交互行为驱动字段更新时，首先会更新 Form 表单数据，其次间接更新相关的 Field 数据，其次 Field 数据变更引起字段组件重绘，最后触发表单层面 onFieldChange 副作用执行。通过 effect 副作用更新字段数据的执行逻辑也是这样的。uform 通过 syncUpdateMode 属性区分同步更新字段和异步更新字段两种模式：同步模式直接使用 raf 更新字段；异步模式通过 raf 在下一次绘制时批量更新字段。</p>
<p>Form 实例提供三种更新状态的方式： 用于构造 mutators 的 form.setValue；在 effect 场景中使用的 form.setFormState、form.setFieldState。setValue 较为简单，即首先使用 Field 实例更新字段的状态，其次当字段存在脏值时予以重绘，其次触发 onFieldInputChange 副作用，最后校验表单并触发执行表单层面的订阅函数、onFieldChange 副作用。setFormState、setFieldState 并不会触发 onFieldInputChange 副作用，但这两个方法都会通过 formNotify 触发 onFieldChange 副作用。</p>
<p>setFormState 流程图：<br><img src="/2019/10/27/编辑器/uform/setFormState.png"></p>
<p>setFieldState 流程图：<br><img src="/2019/10/27/编辑器/uform/setFieldState.png"></p>
<p>如上文所说，uform 不止于管理表单数据、校验状态等状态（两者均通过 field.notify 驱动字段组件的重绘），还包含 props、editable 可编辑状态等数据。在提升性能方面，精准的字段状态管理可以只驱动字段的重绘，而不是表单的重绘；uform 又使用 raf 在启动重绘。至于功能上的联动显示隐藏，uform 一方面可以通过 setFieldState 更新字段的 visible, display 状态；另一方面可以通过 react 语法在特定条件下构建字段组件实例（通过 props.onChange 方法监听并插入字段组件）。在后一种情况下，uform 允许使用 updateFieldStateFromBuffer 更新新增字段的状态。</p>
<h2 id="uform-react"><a href="#uform-react" class="headerlink" title="@uform/react"></a>@uform/react</h2><p>与 rc-form 一样，uform 也使用高阶组件 StateForm、StateField 将状态管理器注入到表单及字段组件中；但是子组件表单没法通过 props.form 访问 Form 实例，StateForm 会通过 context 将 Form 实例直接传给字段 StateField。表单的高阶组件主要在于将 Form 实例的订阅函数等通过 props 透出到表单外围、通过 props 更新 Form 实例的状态、将 Form 实例透传给内部子组件；字段的高阶组件主要在于通过 props 更新 Field 实例的状态、构建 mutators 监听字段组件的变更以实时更新字段的状态。</p>
<p>StateForm 会通过 registerFormWrapper 函数注册成原始表单的外层容器；registerFormWrapper 函数还可用于注册其他容器。注册完成后，通过 OriginForm 可以获取集成外围容器的表单组件。与 registerFormWrapper 功能相仿，registerFieldMiddleware 用于为字段组件添加外围容器（外围容器的功能如在 antd 中为字段组件包裹上 FormItem 组件）。registerFormField 用于注册字段组件，如 input，radio 等。因为对于不同的字段组件，其值可能会有不同的 props 属性表现（如 props.value、props.checked 等），编辑状态与不可编辑状态也可能会使用不同的字段组件，@uform/react 提供 connect 用于转换 props 或处理 schema。在 registerFormField 时，一般会配合使用 connect。</p>
<p>uform 中的字段渲染比较特别，分为两种模式：SchemaMarkup 传入 props.schema，直接予以渲染；通过 SchemaField 描述 SchemaForm 包含的字段组件，收集 schema 后予以渲染。@uform/antd 透出的 SchemaForm 即基于 SchemaMarkup；Field 即基于 SchemaField。以下是源码：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">const SchemaForm = SchemaMarkup()(</span><br><span class="line">  React.forwardRef((props: ISchemaFormProps, ref: React.Ref&lt;any&gt;) =&gt; &#123;</span><br><span class="line">    // 这个时候就有 schema 数据</span><br><span class="line">    const &#123; children, className, ...others &#125; = props</span><br><span class="line">    return (</span><br><span class="line">      &lt;OriginForm</span><br><span class="line">        className=&#123;`rs-uform $&#123;className || &apos;&apos;&#125;`&#125;</span><br><span class="line">        &#123;...others&#125;</span><br><span class="line">        ref=&#123;ref&#125;</span><br><span class="line">      &gt;</span><br><span class="line">        &lt;div className=&quot;rs-uform-content&quot;&gt;</span><br><span class="line">          &#123;/* 从 schema 取出数据渲染 */&#125;</span><br><span class="line">          &lt;FormField name=&quot;&quot; path=&#123;[]&#125; schemaPath=&#123;[]&#125; /&gt;</span><br><span class="line">        &lt;/div&gt;</span><br><span class="line">        &#123;children&#125;</span><br><span class="line">      &lt;/OriginForm&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125;)</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">// 虚拟组件，仅用于收集 schema</span><br><span class="line">const SchemaField = props =&gt; &#123;</span><br><span class="line">  const parent = useContext(MarkupContext)</span><br><span class="line">  if (schemaIs(parent, &apos;object&apos;)) &#123;</span><br><span class="line">    const name = props.name || getRadomName()</span><br><span class="line">    parent.properties = parent.properties || &#123;&#125;</span><br><span class="line">    parent.properties[name] = clone(</span><br><span class="line">      props,</span><br><span class="line">      filterSchemaPropertiesAndReactChildren</span><br><span class="line">    )</span><br><span class="line">    return (</span><br><span class="line">      &lt;MarkupContext.Provider value=&#123;parent.properties[name]&#125;&gt;</span><br><span class="line">        &#123;props.children&#125;</span><br><span class="line">      &lt;/MarkupContext.Provider&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125; else if (schemaIs(parent, &apos;array&apos;)) &#123;</span><br><span class="line">    parent.items = clone(props, filterSchemaPropertiesAndReactChildren)</span><br><span class="line">    return (</span><br><span class="line">      &lt;MarkupContext.Provider value=&#123;parent.items&#125;&gt;</span><br><span class="line">        &#123;props.children&#125;</span><br><span class="line">      &lt;/MarkupContext.Provider&gt;</span><br><span class="line">    )</span><br><span class="line">  &#125; else &#123;</span><br><span class="line">    return props.children || &lt;React.Fragment /&gt;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">const SchemaMarkup = createHOC((options, SchemaForm) =&gt; &#123;</span><br><span class="line">  return class extends Component&lt;ISchemaFormProps&gt; &#123;</span><br><span class="line">    public static displayName = &apos;SchemaMarkupParser&apos;</span><br><span class="line"></span><br><span class="line">    public portalRoot = document.createElement(&apos;div&apos;)</span><br><span class="line"></span><br><span class="line">    public render() &#123;</span><br><span class="line">      const &#123;</span><br><span class="line">        children,</span><br><span class="line">        initialValues,</span><br><span class="line">        defaultValue,</span><br><span class="line">        value,</span><br><span class="line">        schema,</span><br><span class="line">        ...others</span><br><span class="line">      &#125; = this.props</span><br><span class="line"></span><br><span class="line">      let alreadyHasSchema = false</span><br><span class="line">      let finalSchema = &#123;&#125;</span><br><span class="line">      if (schema) &#123;</span><br><span class="line">        alreadyHasSchema = true</span><br><span class="line">        finalSchema = schema</span><br><span class="line">      &#125; else &#123;</span><br><span class="line">        finalSchema = &#123; type: &apos;object&apos; &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      nonameId = 0</span><br><span class="line"></span><br><span class="line">      return (</span><br><span class="line">        &lt;React.Fragment&gt;</span><br><span class="line">          &#123;!alreadyHasSchema &amp;&amp;</span><br><span class="line">            // 只是为了去收集 schema 数据</span><br><span class="line">            createPortal(</span><br><span class="line">              &lt;MarkupContext.Provider value=&#123;finalSchema&#125;&gt;</span><br><span class="line">                &#123;children&#125;</span><br><span class="line">              &lt;/MarkupContext.Provider&gt;,</span><br><span class="line">              this.portalRoot</span><br><span class="line">            )&#125;</span><br><span class="line">          &#123;/* 收集后的 schema 用于渲染 */&#125;</span><br><span class="line">          &lt;SchemaForm</span><br><span class="line">            &#123;...others&#125;</span><br><span class="line">            defaultValue=&#123;defaultValue&#125;</span><br><span class="line">            value=&#123;value&#125;</span><br><span class="line">            initialValues=&#123;initialValues&#125;</span><br><span class="line">            schema=&#123;finalSchema&#125;</span><br><span class="line">          &gt;</span><br><span class="line">            &#123;children&#125;</span><br><span class="line">          &lt;/SchemaForm&gt;</span><br><span class="line">        &lt;/React.Fragment&gt;</span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
<p>@uform/react 封装了三种抽象组件：array 列表组件、object 多属性组件、slot 插槽组件（渲染 schema.renderChildren）。registerFieldRenderer 函数用于增强 schema 的解析能力，默认 schema[‘x-render’] 可以作为字段组件的渲染函数。</p>
<p>借助于通过 createContext 机制传递 Broadcast 实例，StateForm、StateField 会持有相同的 Broadcast 实例。这个 Broadcast 实例可以作为组件层级的通信总线。@uform/react 另外借助了 <a href="https://github.com/janryWang/react-eva" target="_blank" rel="noopener">react-eva</a> 可用于以 actions、effects 形式操控表单。</p>
<h2 id="uform-antd"><a href="#uform-antd" class="headerlink" title="@uform/antd"></a>@uform/antd</h2><p>@uform/antd、@uform/next 主要利用 @uform/react 提供的 registerFormWrapper、registerFieldMiddleware、registerFormField + connect 完成表单外围容器、字段外围容器、字段组件的注册。如在 @uform/antd 中，会通过 registerFormWrapper 为表单包裹上 antd 的 Form 组件；通过 registerFieldMiddleware 为字段包裹上 FormItem 组件；通过 registerFormField + connect 注册 input，radio 等字段组件。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>uform 有其设计和实现上的复杂性，本文暂未深入挖掘子字段、path、列表组件等内容。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/25/读书笔记/数据服务/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/25/读书笔记/数据服务/" itemprop="url">大数据之路 —— 数据服务章</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-10-25T00:00:00+08:00">2019-10-25</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/读书笔记/" itemprop="url" rel="index"><span itemprop="name">读书笔记</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/10/25/读书笔记/数据服务/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/10/25/读书笔记/数据服务/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="架构演进"><a href="#架构演进" class="headerlink" title="架构演进"></a>架构演进</h2><p>阿里巴巴的数据开放服务经历了四个阶段：DWSOA、OpenAPI、SmartDQ 和 OneService。</p>
<img src="/2019/10/25/读书笔记/数据服务/dataservice.jpg">
<ul>
<li>DWSOA：将业务方对数据的需求通过 SOA 服务提供除去（接口内部实现数据计算逻辑）。接口开发、测试、上线繁复，灵活性不高，扩展性差，复用率低。</li>
<li>OpenApi：同类数据（如会员数据）合并成一张逻辑表，对外透出一个接口，通过接口参数定位具体数据。接口数量随着类目数量也逐渐增多。</li>
<li>SmartDQ：逻辑表的取数据逻辑通过 SQL （作为领域专用语言 DSL）描述，SmartDQ 通过解析 SQL、生成执行计划、执行 SQL、合并数据、限制结果，最终透出数据。SmartDQ 通过跨异构数据源适配器对接不同的数据库，并且封装了分布式查询功能，无需关心底层物理表是不是分库分表。应用层，SmartDQ 提供接口配置管理，且集成监控、限流、计费、权限能力。缺点是 SQL 无法解决复杂的业务逻辑，即提供个性化的数据内容。</li>
<li>OneService：OneService 在 SmartDQ 的基础上，切分数据使用场景，主要包含以下几类：个性化的垂直业务场景、实时数据推送服务、定时任务服务。介于此，OneService 提供多种服务类型满足不同场景，分别是 OneService-SmartDQ、OneService-Lego、OneService-iPush、OneService-uTiming。OneService-Lego 采用插件化开发模式，一类需求一个插件，用于满足个性化的垂直业务场景。OneService-iPush 通过 websocket 或 long-polling 实时推送数据。OneService-uTiming 提供定时任务、即时任务两种模式。</li>
</ul>
<p>在 OneService 阶段；数据生产者推送数据入库，服务提供者根据规范快速创建、发布、监控、下线服务；服务调用者可以在门户网站中快速检索、申请、调用服务。</p>
<p>SmartDQ 架构图：</p>
<img src="/2019/10/25/读书笔记/数据服务/SmartDQ.png">
<p>OneService 架构图：</p>
<img src="/2019/10/25/读书笔记/数据服务/OneService.png">
<h2 id="架构细节"><a href="#架构细节" class="headerlink" title="架构细节"></a>架构细节</h2><img src="/2019/10/25/读书笔记/数据服务/SmartDQ_Detail.jpeg">
<p>逻辑表通过多个数据源的物理表汇总而成，多个逻辑表挂在一个主题下。服务层元数据中心用于进行元数据配置，并维护物理表到逻辑表的映射。同时，服务层会把元数据加载到本地缓存中，以便进行后续的模型解析。</p>
<p>元数据分三套环境：日常、预发、线上。元数据经预发布经验证后，才可以正式发布。元数据的权限级别在逻辑表层级。当某用户修改逻辑表及其下的物理表资源时，禁止其他用户修改。技术上，元数据缓存采用增量更新。</p>
<p>主处理模块首先会通过解析 DSL（即 SQL 描述）获得查询树；其次遍历查询树，混入元数据模型中的逻辑表信息，获得逻辑 Query；其次通过元数据模型中物理表和逻辑表的映射关系，将逻辑 Query 转成物理 Query；其次按所涉及的物理表拆分为 SubQuery；其次将 SubQuery 组装成 SQL 语句并交给 DB 执行；最后将执行结果合并，返回调用者。</p>
<p>对于 Get 快查询和 List 慢查询，分配两套线程池，避免 Get 快查询前面有一个 List 慢查询，导致等待时间过长。在查询优化过程中，引擎会将不必要的 List 慢查询转成 Get 快查询。</p>
<p>查询服务器分组，每个分组有明确的服务对象和保障等级。分组隔离使 A 分组的异常不会影响到 B 分组。分组策略会进行动态调整，以实现资源的最大化利用。</p>
<p>数据安全方面，查询强制带上 LIMIT 限制，并设定必传字段，防止全表扫描。</p>
<p>日志采集方面，采集内容包含调用时间、接口名、方法名、返回记录数等基础信息；调用者应用名、来源 IP 地址等调用者信息；调用指标、查询筛选条件等调用信息；响应时间、是否走缓存等性能指标信息；出错原因、错误类型、数据源、错误堆栈等错误信息。在有了日志的基础上，可以监控系统的健康：总体、分组或单机的性能；逻辑表被调用情况（零调用酌情予以下线处理）；慢 SQL 查找并优化；错误排查。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/10/23/他山石/HSF服务/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2019/10/23/他山石/HSF服务/" itemprop="url">HSF服务</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-10-23T00:00:00+08:00">2019-10-23</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/他山石/" itemprop="url" rel="index"><span itemprop="name">他山石</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/10/23/他山石/HSF服务/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/10/23/他山石/HSF服务/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>此前用 node 对接过一段时候的 HSF 服务，不知分寸地一头扎进 node 模块源码里，也没得出个所以然。直到今天偶然在《企业IT架构转型之道：阿里巴巴中台战略思想与架构实战》这本书读到有关 HSF 的内容，才理解了 HSF 实现的大致原理。看来还是要多读书、多看文档。谨以这篇短文留念。</p>
<h2 id="HSF"><a href="#HSF" class="headerlink" title="HSF"></a>HSF</h2><p>HSF 全称 High Speed Framework 高速服务框架，是阿里内部广泛使用的 RPC 框架。不同于 ESB 企业服务总线，HSF 实现了服务调用方（Consumer）和服务提供方（Provider）的点对点通信。在 HSF 框架中，地址服务器用于维护全量服务器（包含服务调用方和服务提供方）和 Diamond 服务器列表信息；配置服务器用于记录服务发布（服务提供方发布了哪些服务）和服务订阅（服务调用方需要哪些服务）信息，并将相关信息推送到对应的服务器上，如配置服务器会将服务提供方的相关信息推送给服务调用方。配置服务器与服务提供方、服务调用方均保持长连接，采用心跳的方式监控各服务运行节点的状况，以便剔除故障的服务提供方。HSF 通过 ip 和端口号锁定服务提供方或服务调用方；通过服务名和版本号定位服务（因此，通过指定服务名和版本号可以直连本地服务器）。首先服务提供方会在配置服务器中完成服务的注册发布，然后服务调用方会在配置服务器中订阅服务，以便配置服务器即时推送服务提供方的 ip 和端口。为了服务发布、订阅、推送的负载均衡，生产环境上的配置服务器一般会配置多台，且在不同的配置服务器之间会作实时的数据同步。</p>
<img src="/2019/10/23/他山石/HSF服务/hsf.png">
<blockquote class="blockquote-center"><p>每一个 HSF 的应用均以 War 包形式存在，运行在 Ali-Tomcat 容器中。Ali-Tomcat 容器层已经集成了 HSF 服务框架对服务提供者或服务调用者进行配置服务器发现、服务注册、订阅、失效转移等相关功能，所以不管是在服务提供者还是调用者开发时，只需要进行服务相关的配置操作，应用中无需引入任何 HSF 相关的 Jar 包。</p>
</blockquote>
<p>在服务提供方和服务调用方的点对点通信中，服务调用者会从服务提供者列表中随机选择一台进行通信，无需通过 ESB 中转，因此就形成“去中心化”的服务架构。当请求的服务提供方故障时，服务调用者会获得失败反馈，继而从剩下的服务提供者列表中选择一台再次通信，这就是 HSF 服务的容错机制；同时配置服务器与服务提供方的长连接通信，允许配置服务器及时剔除故障的服务提供方并推送到服务调用方。HSF 的线性扩展能力在于，只要启动一台新的服务提供方服务器，并由配置服务器推送给服务调用方，即可以分摊服务调用的压力。</p>
<h3 id="Diamond"><a href="#Diamond" class="headerlink" title="Diamond"></a>Diamond</h3><p>Diamond 服务器用于推送统一的配置服务。在 HSF 中，Diamond 主要用于：</p>
<ol>
<li>通过设置白名单使某些服务调用方的服务只被特定 IP 地址的服务器调用。</li>
<li>通过用户认证的方式控制服务是否能被调用。</li>
<li>按照不同的服务路由权重设置服务调用方对多个服务提供方服务节点的访问。</li>
<li>设置某些服务的 QPS 能力上限值，实现限流。</li>
</ol>
<p>Diamond 会将这些规则保存在在自身的 MySql 中，并将这些规则推送到相关的服务节点上，使这些规则能立即在服务运行环境中生效。</p>
<h3 id="通信和序列化协议"><a href="#通信和序列化协议" class="headerlink" title="通信和序列化协议"></a>通信和序列化协议</h3><p>HSF 框架使用网络通信框架 Netty、Hession 数据序列化协议实现服务器键的交互。这类 RPC 协议采用多路复用的 TCP 长连接方式，即在服务提供方和调用方点对点通信期间会共用同一个长连接，以传输不同的请求块。Hessian 数据序列化协议精简高效，同时可以跨语言使用。另外 Hessian 可以充分利用 Web 容器的成熟功能，在处理大量用户访问时很有优势，在资源分配、线程排队、异常处理等方面都可以由 Web 容器保证。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://blog.csdn.net/laomumu1992/article/details/86636757" target="_blank" rel="noopener">HSF简介（摘自《企业IT架构转型之道》）</a><br><a href="https://help.aliyun.com/document_detail/100087.html?spm=a2c4g.11174359.4.4.34c32b88ntjXfW" target="_blank" rel="noopener">HSF 概述</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/10/">10</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpeg" alt="Alfred">
            
              <p class="site-author-name" itemprop="name">Alfred</p>
              <p class="site-description motion-element" itemprop="description">人苦不知足，既得陇，复望蜀</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">96</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    <span class="site-state-item-count">31</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    <span class="site-state-item-count">26</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Alfred-sg" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/xiu-fan-79/activities" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-globe"></i>知乎</a>
                  </span>
                
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Alfred</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Pisces</a> v6.0.2</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.0.2"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.2"></script>



  

  
    <script id="dsq-count-scr" src="https://alfred.disqus.com/count.js" async></script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  

  





	





  












  





  

  

  

  

  
  

  

  

  

  

</body>
</html>
