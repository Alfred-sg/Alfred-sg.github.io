<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.2" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.2">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.2" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.0.2',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="Hexo, NexT" />


<meta name="description" content="人苦不知足，既得陇，复望蜀">
<meta property="og:type" content="website">
<meta property="og:title" content="修子范语">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="修子范语">
<meta property="og:description" content="人苦不知足，既得陇，复望蜀">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="修子范语">
<meta name="twitter:description" content="人苦不知足，既得陇，复望蜀">






  <link rel="canonical" href="http://yoursite.com/"/>


  <title>修子范语</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">修子范语</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Alfredo's Notes</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
        </li>
      

      
    </ul>
  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/04/es6/Reflect, Proxy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/04/es6/Reflect, Proxy/" itemprop="url">Reflect, Proxy</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-04T10:12:43+08:00">2018-10-04</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/es6/" itemprop="url" rel="index"><span itemprop="name">es6</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/10/04/es6/Reflect, Proxy/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/10/04/es6/Reflect, Proxy/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Reflect"><a href="#Reflect" class="headerlink" title="Reflect"></a>Reflect</h2><p>ES6 提供的 API，集成语言层面的对象操作（操作与 Proxy 一一对应，且为函数形式）。</p>
<ul>
<li>Reflect.get(target, name, receiver): 获取属性。</li>
<li>Reflect.set(target, name, value, receiver): 对属性赋值。</li>
<li>Reflect.defineProperty(target, name, desc): 修改属性的描述符。</li>
<li>Reflect.deleteProperty(target, name): 删除属性。</li>
<li>Reflect.has(target, name): propKey in proxy 判断。</li>
<li>Reflect.ownKeys(target): 返回对象的自有属性。</li>
<li>Reflect.enumerate(target): 以迭代器形式获取对象的可枚举属性。</li>
<li>Reflect.isExtensible(target): 判断对象是否可扩展。</li>
<li>Reflect.preventExtensions(target): 使对象不可扩展。</li>
<li>Reflect.getOwnPropertyDescriptor(target, name): 获取属性的描述符。</li>
<li>Reflect.getPrototypeOf(target): 获取对象的 <strong>proto</strong> 属性。</li>
<li>Reflect.setPrototypeOf(target, prototype): 设置对象的原型。</li>
<li>Reflect.apply(target, thisArg, args): 以 thisArg 为上下文执行 target 函数。</li>
<li>Reflect.construct(target, args): 创建 target 实例。</li>
</ul>
<h2 id="Proxy"><a href="#Proxy" class="headerlink" title="Proxy"></a>Proxy</h2><p>Proxy 在语言层面，拦截针对对象的操作。ES6 原生提供 Proxy 构造函数，用来生成 Proxy 实例。</p>
<p>使用 let proxy = new Proxy(target, handler); 创建 Proxy 实例。参数 target 可以是对象，也可以是函数。handler 为设定拦截操作的集合。操作 proxy，将同时影响 target。</p>
<p>Proxy.revocable 方法返回一个可取消的 Proxy 实例。返回值中，proxy 属性即为 Proxy 实例，revoke 方法用于取消 Proxy 实例。</p>
<p>在 Proxy 代理的情况下，目标对象内的 this 关键字将指向 Proxy 实例。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> proto = <span class="keyword">new</span> <span class="built_in">Proxy</span>(&#123;&#125;, &#123;</span><br><span class="line">  get(target, propertyKey, receiver) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'GET '</span> + propertyKey);</span><br><span class="line">    <span class="keyword">return</span> target[propertyKey];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj = <span class="built_in">Object</span>.create(proto);</span><br><span class="line">obj.foo <span class="comment">// "GET foo"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> target = &#123;&#125;;</span><br><span class="line"><span class="keyword">let</span> handler = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> &#123;proxy, revoke&#125; = <span class="built_in">Proxy</span>.revocable(target, handler);</span><br><span class="line"></span><br><span class="line">proxy.foo = <span class="number">123</span>;</span><br><span class="line">proxy.foo <span class="comment">// 123</span></span><br><span class="line"></span><br><span class="line">revoke();</span><br><span class="line">proxy.foo <span class="comment">// TypeError: Revoked</span></span><br></pre></td></tr></table></figure>
<p>可拦截的操作包含：</p>
<ul>
<li>get(target, propKey, receiver)：拦截对象属性的读取。参数 reveiver 为操作行为所针对的对象，通常是 proxy 实例。</li>
<li>set(target, propKey, value, receiver)：拦截对象属性的设置，返回布尔值。</li>
<li>has(target, propKey)：拦截 propKey in proxy 操作，返回布尔值。</li>
<li>deleteProperty(target, propKey)：拦截 delete proxy[propKey] 的操作，返回布尔值。</li>
<li>ownKeys(target)：拦截 Object.getOwnPropertyNames(proxy)、Object.getOwnPropertySymbols(proxy)、Object.keys(proxy)、for…in 循环，返回目标对象自身所有的属性，Object.keys() 返回仅包括目标对象自身的可遍历属性。</li>
<li>getOwnPropertyDescriptor(target, propKey)：拦截 Object.getOwnPropertyDescriptor(proxy, propKey)，返回属性的描述对象。</li>
<li>defineProperty(target, propKey, propDesc)：拦截 Object.defineProperty(proxy, propKey, propDesc）、Object.defineProperties(proxy, propDescs)，返回布尔值。</li>
<li>preventExtensions(target)：拦截 Object.preventExtensions(proxy)，返回布尔值。</li>
<li>getPrototypeOf(target)：拦截 Object.getPrototypeOf(proxy)，返回对象。</li>
<li>isExtensible(target)：拦截 Object.isExtensible(proxy)，返回布尔值。</li>
<li>setPrototypeOf(target, proto)：拦截 Object.setPrototypeOf(proxy, proto)，返回布尔值。</li>
<li>apply(target, object, args)：拦截 Proxy 实例作为函数调用的操作，比如 proxy(…args)、proxy.call(object, …args)、proxy.apply(…)。</li>
<li>construct(target, args)：拦截 Proxy 实例作为构造函数调用的操作，比如 new proxy(…args)。</li>
</ul>
<h2 id="harmony-reflect"><a href="#harmony-reflect" class="headerlink" title="harmony-reflect"></a>harmony-reflect</h2><h3 id="Reflect-1"><a href="#Reflect-1" class="headerlink" title="Reflect"></a>Reflect</h3><p>扩展或提供平台提供的 Reflect 对象。</p>
<ul>
<li>Reflect.get(target, name, receiver) 方法实现: 首先，若 target 为 Proxy 实例，获取并调用 handler.get 方法；其次，若 target 不是 Proxy 实例，通过 Object.getOwnPropertyDescriptor 获取属性描述符，若属性描述符为 undefined，尝试通过 Object.getPrototypeOf 方法获取原型的 name 属性；其次，若属性描述符不是 undefined，尝试获取属性描述符中的 value 属性或执行 get 方法。</li>
<li>Reflect.set(target, name, value, receiver) 方法: 首先，若 target 为 Proxy 实例，获取并调用 handler.set 方法；其次，若 target 不是 Proxy 实例，通过 Object.getOwnPropertyDescriptor 获取属性描述符，若属性描述符为 undefined，尝试通过 Object.getPrototypeOf 方法调用原型的 set 方法；其次，若属性描述符不是 undefined，且访问器属性 set 为真值，尝试以 receiver 为上下文调用属性描述符中的 set 方法；其次，通过 Object.getOwnPropertyDescriptor 获取 receiver 对象的属性描述符，若属性描述符为 undefined，调用 Object.defineProperty 重新设置属性描述符，更新 value 值；其次，若 receiver 对象的属性描述符不是 undefined，校验 receiver 是否可扩展，若可扩展，调用 Object.defineProperty 重新设置属性描述符。</li>
<li>Reflect.defineProperty(target, name, desc) 方法: 首先，若 target 为 Proxy 实例，获取并调用 handler.defineProperty 方法；其次，若 target 不是 Proxy 实例，通过 Object.getOwnPropertyDescriptor 获取当前的属性描述符，当属性描述符的 configurable 属性为 false 时，运行原有的 Object.defineProperty 将报错，实现上将引起报错的情形全部以 return false 形式剔除，随后再调用 Object.defineProperty，重新设定属性描述符。</li>
<li>Reflect.deleteProperty(target, name) 方法: 首先，若 target 为 Proxy 实例，获取并调用 handler.deleteProperty 方法；其次，通过 Object.getOwnPropertyDescriptor 获取当前的属性描述符并判断其 configurable 属性，若属性为真，调用 delete target[name] 语句，否则返回 false。</li>
<li>Reflect.has(target, name) 方法: 执行 name in target 语句。</li>
<li>Reflect.ownKeys(target) 方法: 首先，若 target 为 Proxy 实例，获取并调用 handler.ownKeys 方法；其次，调用 Object.getOwnPropertyNames 方法。</li>
<li>Reflect.enumerate(target) 方法: 首先，若 target 为 Proxy 实例，获取并调用 handler.enumerate 方法；其次，通过 for…in 语句获取目标的可枚举属性集合，以迭代器形式输出。</li>
<li>Reflect.isExtensible(target) 方法: 直接调用 Object.isExtensible 方法。</li>
<li>Reflect.preventExtensions(target) 方法: 首先，若 target 为 Proxy 实例，获取并调用 handler.preventExtensions 方法；其次，调用 Object.preventExtensions 方法。</li>
<li>Reflect.getOwnPropertyDescriptor(target, name) 方法: 直接调用 Object.getOwnPropertyDescriptor 方法。</li>
<li>Reflect.getPrototypeOf(target) 方法: 直接调用 Object.getPrototypeOf 方法。</li>
<li>Reflect.setPrototypeOf(target, prototype): 首先，若 target 为 Proxy 实例，获取并调用 handler.setPrototypeOf 方法；其次，判断目标的可扩展性，若其可扩展，以 try-catch 语句执行 Object.setPrototypeOf 方法，以捕获错误。</li>
<li>Reflect.apply(target, thisArg, args): 调用 Function.prototype.apply.call(target, thisArg, args)。</li>
<li>Reflect.construct(target, args, newTarget): 首先，若 target 为 Proxy 实例，获取并调用 handler.construct 方法；其次，在 newTarget 为 undefined 或与 target 等值的基础上，基于 target 并以 null 为上下文生成构造函数；否则，Object.create(newTarget.prototype) 为上文生成构造函数。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="built_in">Reflect</span> = &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  enumerate: <span class="function"><span class="keyword">function</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> handler = directProxies.get(target);</span><br><span class="line">    <span class="keyword">var</span> result;</span><br><span class="line">    <span class="keyword">if</span> (handler !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      result = handler.enumerate(handler.target);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      result = [];</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> name <span class="keyword">in</span> target) &#123; result.push(name); &#125;;      </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> l = +result.length;</span><br><span class="line">    <span class="keyword">var</span> idx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      next: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (idx === l) <span class="keyword">return</span> &#123; <span class="attr">done</span>: <span class="literal">true</span> &#125;;</span><br><span class="line">        <span class="keyword">return</span> &#123; <span class="attr">done</span>: <span class="literal">false</span>, <span class="attr">value</span>: result[idx++] &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  construct: <span class="function"><span class="keyword">function</span>(<span class="params">target, args, newTarget</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> handler = directProxies.get(target);</span><br><span class="line">    <span class="keyword">if</span> (handler !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> handler.construct(handler.target, args, newTarget);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> target !== <span class="string">"function"</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">"target is not a function: "</span> + target);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (newTarget === <span class="literal">undefined</span> || newTarget === target) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> (<span class="built_in">Function</span>.prototype.bind.apply(target, [<span class="literal">null</span>].concat(args)));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> newTarget !== <span class="string">"function"</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">"newTarget is not a function: "</span> + target);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">var</span> proto = newTarget.prototype;</span><br><span class="line">      <span class="keyword">var</span> instance = (<span class="built_in">Object</span>(proto) === proto) ? <span class="built_in">Object</span>.create(proto) : &#123;&#125;;</span><br><span class="line">      <span class="keyword">var</span> result = <span class="built_in">Function</span>.prototype.apply.call(target, instance, args);</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Object</span>(result) === result ? result : instance;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="proxy"><a href="#proxy" class="headerlink" title="proxy"></a>proxy</h3>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/03/设计模式/代理模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/03/设计模式/代理模式/" itemprop="url">代理模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-03T00:00:00+08:00">2018-10-03</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/设计模式/" itemprop="url" rel="index"><span itemprop="name">设计模式</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/10/03/设计模式/代理模式/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/10/03/设计模式/代理模式/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>代理模式(proxy pattern) 的主要处理逻辑为，构建代理对象以桥接对实际对象的访问。因此，可以在访问过程中构建附加的间接性操作如请求处理、权限校验、内务处理(housekeeping task)等，也可以为多种实际对象提供统一的接口。</p>
<p>《设计模式:可复用面向对象软件的基础》中的说法是：</p>
<blockquote class="blockquote-center"><p>Provide a surrogate or placeholder for another object to control access to it.</p>
</blockquote>
<p>使用代理模式的场景：</p>
<ol>
<li>远程代理(remote proxy): 为一个远程服务对象提供本地表现，通过本地方法调用远程服务。</li>
<li>虚代理(virtual proxy): 在代理中延迟创建一个开销很大的对象。如在图片代理对象的实现过程中，draw 方法执行前才创建实际所需的图片对象。</li>
<li>保护代理(protection proxy): 访问对象前执行权限校验。</li>
<li>智能指引(smart reference): 访问实际的对象时执行附加操作，如对引用计数，当没被引用时，释放内存；首次引用时，将持久对象装入内存等。</li>
</ol>
<h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><img src="/2018/10/03/设计模式/代理模式/proxy.png">
<ul>
<li>Proxy: 以引用形式持有实体，接口与 Subject 相同，以便于使用代理对象替代实体，并控制对实体的访问。必要时，可以在代理对象中创建或删除实体。<ul>
<li>remote proxy 负责对请求及其参数进行编码，并向远程服务器发送请求。</li>
<li>virtual proxy 负责缓存实体的附加信息，以便延迟创建实体。</li>
<li>protection proxy 负责校验请求是否有特定的访问权限。</li>
</ul>
</li>
<li>Subject 定义 RealSubject, Proxy 的公共接口，因此在需要使用 RealSubject 的场景中都可以使用 Proxy 代替。</li>
<li>RealSubject 定义 Proxy 所代表的实体。</li>
</ul>
<h2 id="harmony-reflect"><a href="#harmony-reflect" class="headerlink" title="harmony-reflect"></a>harmony-reflect</h2>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/11/工程化/前端构建工具dawn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/11/工程化/前端构建工具dawn/" itemprop="url">前端构建工具 dawn 不完全解密</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-11T00:00:00+08:00">2018-09-11</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端工程化/" itemprop="url" rel="index"><span itemprop="name">前端工程化</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/11/工程化/前端构建工具dawn/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/11/工程化/前端构建工具dawn/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><p>dawn 是一个采用中间件技术实现的轻量的任务流协调器，它和 gulp, grunt 有异曲同工之妙。dawn 本身并不处理任务，转而交由中间件承担这一职能，如同 gulp, grunt 插件。在实现上，dawn 是 webpack 出台后的产物，就不需要像 gulp, grunt 那样关注任务流的始点 —— 文件位置，而更容易聚焦于任务的分解，将编译、压缩作业交给 dn-middleware-webpack 中间件。若说 gulp 中的任务流是鱼跃似的，一个跟着另一个，那么，dawn 通过 ctx 上下文使得两个任务之间可以借助事件或实例属性进行通信。dawn 的中间件实现机制如同 koa，其一使用 next 引用下一个中间件串联任务流，其二以继承事件模型的 ctx 实例作为上下文。其核心代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Context</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> _execQueue(middlewares, args, onFail) &#123;</span><br><span class="line">    <span class="keyword">const</span> middleware = middlewares.shift();</span><br><span class="line">    <span class="keyword">if</span> (!middleware) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// this.load 安装中间件，并执行中间件的外层函数，获得实际的任务逻辑 handler</span></span><br><span class="line">    <span class="keyword">const</span> handler = <span class="keyword">await</span> <span class="keyword">this</span>.load(middleware);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> next = <span class="function">(<span class="params">args</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 若返回真值，在 watch 状态下，也只执行一次</span></span><br><span class="line">      <span class="keyword">if</span> (next.__result) <span class="keyword">return</span> next.__result;</span><br><span class="line"></span><br><span class="line">      next.__result = <span class="keyword">this</span>._execQueue(middlewares, args, onFail)</span><br><span class="line">        .catch(<span class="function"><span class="params">err</span> =&gt;</span> onFail(err));</span><br><span class="line">      <span class="keyword">return</span> next.__result;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> handler.call(<span class="keyword">this</span>, next, <span class="keyword">this</span>, args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为 dawn 是一个任务流协调器，使得它就像一架航母，其能力仰赖于战斗机群 —— 由丰富的中间件、模板构成的生态系统。第一，这样使得 dawn 更着眼于为开发团队提供服务（两者呈互为因果的关系）。dawn 内建了复合远程配置的功能。不少公司会有私有的 npm 仓库，开发的 dn 中间件、模板先期都会在这些私有仓库中发展成形。借助于 dn config registry <a href="http://your_server_url" target="_blank" rel="noopener">http://your_server_url</a> 命令，dawn 安装中间件时会从这些私有仓库中拉取中间件或模板。对于配置文件，借助于 dn config server <a href="http://your_server_url" target="_blank" rel="noopener">http://your_server_url</a> 命令，dawn 也会从私有服务器中拉取远程配置，并与本地配置合并。如此，既能保有模板的闭源特征，又能实现配置文件的复用。扯开一个话题，使用 .yml 文件配置选项、将配置文件存于远端，这和我稍有耳闻的 spring boot 项目有些相仿。</p>
<p>第二，为了开发中间件的方便，ctx 必然需要提供大而全的功能。以下简要地展示 ctx 提供的 api 列表：</p>
<ul>
<li>cli: 命令行 Command 实例。</li>
<li>command: 当前执行的命令，如 init, dev, build 等。</li>
<li>pipeline: 当前命令实际所用中间件列表。</li>
<li>cwd: 项目路径。</li>
<li>project: 项目 package.json 文件内容。</li>
<li>middlewareMgr: 中间件管理器，用于查询私有中心的中间件列表，或者安装中间件。</li>
<li>templateMgr: 模板管理器，用于查询私有中心的模板列表，或者文件重命名，或者下载模板。</li>
<li>conf: rc配置管理器，用于获取本地或远程 rc 配置，或者设置 rc 配置，默认获取 .dawnrc 文件。</li>
<li>console: 命令行编辑器 console。</li>
<li>inquirer, utils.inquirer : 命令行交互接口，即 inquirer 类库。</li>
<li>utils.exec(script, opts): 执行 script 命令，返回 promise；utils.exec.withResult(script, opts) 等待并返回执行结果。</li>
<li>utils.writeFile(filename, content): 写文件，返回 promise。</li>
<li>utils.readFile(filename): 读文件，返回 promise。</li>
<li>utils.del: 删除文件，返回 promise。</li>
<li>utils.mkdirp: 创建目录，返回 promise。</li>
<li>download: fetch 响应。</li>
<li>sleep: 延时执行。</li>
<li>prompt: 使用 inquirer.prompt 在命令行编辑器创建引导式交互界面。</li>
<li>utils.mod: 模块管理器，用于执行 npm 命令，或者安装依赖，或者下载模板（缓存在计算机的特定位置），或者获取 npm 包信息。</li>
<li>utils.open: 打开浏览器，即 react-dev-utils/openBrowser 模块。</li>
<li>utils.oneport: 获取一个空闲的端口，即 oneport 类库。</li>
<li>utils.fetch: fetch 响应。</li>
<li>utils.yaml: 通过 js-yaml 类库解析或编译 .yml 文件格式数据。</li>
<li>utils.globby: 通过匹配规则获取文件路径，即 <a href="https://github.com/sindresorhus/globby" target="_blank" rel="noopener">globby 类库</a>。</li>
<li>utils.confman: 配置文件加载器，即 <a href="https://github.com/Houfeng/confman" target="_blank" rel="noopener">confman 类库</a></li>
<li>utils.streamToBuffer, utils.stream2buffer: 将可读流转化成 字符串或 buffer，返回 promise。</li>
<li>utils.bufferToStream, utils.buffer2stream: 将字符串或 buffer 转化成可读流，返回 promise。</li>
<li>utils.copydir: 拷贝文件夹，返回 promise。</li>
<li>utils.findCommand(dirname, command): 获取执行脚本文件。</li>
<li>load(opts): 加载中间件，并执行外层函数。</li>
<li>exec(middlewares, initailArgs): 构建任务流，可用于在中间件中构建子任务流。</li>
</ul>
<h2 id="常用中间件"><a href="#常用中间件" class="headerlink" title="常用中间件"></a>常用中间件</h2><h3 id="dn-middleware-webpack"><a href="#dn-middleware-webpack" class="headerlink" title="dn-middleware-webpack"></a>dn-middleware-webpack</h3><p>概述：基于 webpack3 实现的中间件，打包模块。本地开发模式也将打包模块，而不是读取 webpack 缓存数据。</p>
<p>奥妙：</p>
<ol>
<li>dn-middleware-webpack 在回调中执行后续中间件的处理逻辑。</li>
<li>通过 vmodule-webpack-plugin 插件将 config.yml 类配置文件注入为可以 import 引入的虚拟模块。</li>
<li>ctx 中添加 webpack 属性，即 webpack 类库。</li>
</ol>
<p>选项：</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>意义</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>config</td>
<td>不同环境通过加载配置文件的模块名和文件路径，使用 <a href="https://github.com/Houfeng/vmodule-webpack-plugin" target="_blank" rel="noopener">vmodule-webpack-plugin</a> 创建虚拟模块</td>
<td>{ name: ‘$config’, path: ‘./config’ }</td>
</tr>
<tr>
<td>configFile</td>
<td>webpack 配置文件路径，配置文件导出函数有效</td>
<td>‘./webpack.config.js’</td>
</tr>
<tr>
<td>mode</td>
<td>模式</td>
<td>undefined</td>
</tr>
<tr>
<td>entry</td>
<td>入口文件</td>
<td>[‘./src/*.{js,jsx,ts,tsx}’]</td>
</tr>
<tr>
<td>inject</td>
<td>注入模板中的公用入口文件</td>
<td>[‘./src/*.{js,jsx,ts,tsx}’]</td>
</tr>
<tr>
<td>template</td>
<td>模板文件，模板会加载同名的入口文件</td>
<td>[‘./src/assets/*.html’]</td>
</tr>
<tr>
<td>output</td>
<td>打包文件目录</td>
<td>‘./build/‘</td>
</tr>
<tr>
<td>publicPath</td>
<td>浏览器端访问打包文件的路径</td>
<td>undefined</td>
</tr>
<tr>
<td>folders</td>
<td>不同文件类型的打包目录</td>
<td>{ js: ‘js’, css: ‘css’, img: ‘img’, font: ‘font’, html: ‘’ }</td>
</tr>
<tr>
<td>chunkFilename</td>
<td>懒加载模块名</td>
<td>‘chunks/[name]-[chunkhash].js’</td>
</tr>
<tr>
<td>umd</td>
<td>值为对象时，混合到 webpackConfig.output 配置中</td>
<td>undefined</td>
</tr>
<tr>
<td>external</td>
<td>是否使用外部扩展</td>
<td>undefined</td>
</tr>
<tr>
<td>externals</td>
<td>外部扩展</td>
<td>{ ‘jquery’: ‘jQuery’, ‘zepto’: ‘Zepto’, ‘react’: ‘React’, ‘react-dom’: ‘ReactDOM’ }</td>
</tr>
<tr>
<td>sourceMap</td>
<td>是否生成 source map，开发环境默认生成，false 时不生成；打包时置为 true 才生成</td>
<td>undefined</td>
</tr>
<tr>
<td>watch</td>
<td>是否使用 webpack 监听文件变更，执行 compiler.watch 或 compiler.run 的差别</td>
<td>undefined</td>
</tr>
<tr>
<td>watchOpts</td>
<td>watch 配置</td>
<td>{ aggregateTimeout: 600, ignored: /node_modules/ }</td>
</tr>
<tr>
<td>babel</td>
<td>babel-loader 选项相关，参见下文</td>
<td></td>
</tr>
<tr>
<td>rules</td>
<td>配置额外的加载器，默认加载器包含 babel-loader, vue-loader, json-loader, raw-loader, ejs-loader, url-loade, css-loader, less-loader, fast-sass-loader，可加载的文件可想而知</td>
<td>undefined</td>
</tr>
<tr>
<td>cssModules</td>
<td>是否使用 css modules</td>
<td>undefined</td>
</tr>
</tbody>
</table>
<p>babel 选项：</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>意义</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>presets</td>
<td>配置额外的 presets，默认包含 ‘babel-preset-env’, ‘babel-preset-react’, ‘babel-preset-stage-0’</td>
<td>undefined</td>
</tr>
<tr>
<td>plugins</td>
<td>配置额外的 plugins，默认包含 ‘babel-plugin-typecheck’, ‘babel-plugin-transform-decorators-legacy’, ‘babel-plugin-transform-runtime’</td>
<td>undefined</td>
</tr>
<tr>
<td>targets</td>
<td>作用于 ‘babel-preset-env’，设定编译后脚本的适配环境</td>
<td>undefined</td>
</tr>
<tr>
<td>browsers</td>
<td>适配的浏览器环境，默认适配 [ ‘last 2 versions’, ‘IE &gt;= 9’ ]</td>
<td>undefined</td>
</tr>
<tr>
<td>uglify</td>
<td>targets 中属性，使用 uglify.js 压缩脚本前是否已编译成 es5，默认是，false 为否</td>
<td>undefined</td>
</tr>
<tr>
<td>include</td>
<td>作用于 ‘babel-preset-env’，设定包含的插件</td>
<td>undefined</td>
</tr>
<tr>
<td>exclude</td>
<td>作用于 ‘babel-preset-env’，设定移除的插件</td>
<td>undefined</td>
</tr>
<tr>
<td>loose</td>
<td>作用于 ‘babel-preset-env’，是否允许插件启用 “loose” 转换，默认为否</td>
<td>undefined</td>
</tr>
<tr>
<td>modules</td>
<td>作用于 ‘babel-preset-env’，将es6模块语法转换为何种模块规范语法，默认为 ‘commonjs’</td>
<td>undefined</td>
</tr>
<tr>
<td>useBuiltIns</td>
<td>作用于 ‘babel-preset-env’，是否自动引入 ‘babel-ployfill’，默认使用时引入</td>
<td>undefined</td>
</tr>
<tr>
<td>spec</td>
<td>作用于 ‘babel-preset-env’，是否允许插件启用 “spec” 转换，更符合规范，编译较慢，默认为 false</td>
<td>undefined</td>
</tr>
<tr>
<td>debug</td>
<td>作用于 ‘babel-preset-env’</td>
<td>undefined</td>
</tr>
<tr>
<td>react</td>
<td>是否使用 ‘babel-preset-react’，默认使用，false 时不使用</td>
<td>undefined</td>
</tr>
<tr>
<td>transform</td>
<td>作用于 ‘babel-plugin-transform-runtime’</td>
<td>undefined</td>
</tr>
<tr>
<td>transform.helpers</td>
<td>是否内置 classCallCheck, extends 等，默认内置</td>
<td>undefined</td>
</tr>
<tr>
<td>transform.polyfill</td>
<td>是否内置 Promise, Set, Map, Symbol 等，默认内置</td>
<td>undefined</td>
</tr>
<tr>
<td>transform.regenerator</td>
<td>是否内置生成器函数，async 函数，默认内置</td>
<td>undefined</td>
</tr>
<tr>
<td>transform.moduleName</td>
<td>模块名，import 导入需要，默认为 ‘babel-runtime’</td>
<td>undefined</td>
</tr>
<tr>
<td>transform.useBuiltIns</td>
<td>默认自动引入</td>
<td>undefined</td>
</tr>
<tr>
<td>addExports</td>
<td>影响 ‘babel-plugin-add-module-exports’ 插件的使用（该插件可在模块转换成 common.js，无需从default 属性中取出模块导出内容），false 时不使用 ‘babel-plugin-add-module-exports’</td>
<td>undefined</td>
</tr>
<tr>
<td>strict</td>
<td>影响 ‘babel-plugin-transform-remove-strict-mode’ 插件的使用，true 时不使用</td>
<td>undefined</td>
</tr>
</tbody>
</table>
<p>事件：</p>
<ul>
<li>‘webpack.opts’，可用于修改 opts 配置项，参数 opts。</li>
<li>‘webpack.config’，可用于修改注入 webpack 的 config 配置，参数 config, webpack, opts。</li>
<li>‘webpack.compiler’，操纵 webpack 的编译器，参数 compiler。</li>
<li>‘webpack.stats’，可用于监控编译状态，参数 stats。</li>
</ul>
<h3 id="dn-middleware-server"><a href="#dn-middleware-server" class="headerlink" title="dn-middleware-server"></a>dn-middleware-server</h3><p>概述：基于 <a href="https://github.com/nokitjs/nokit" target="_blank" rel="noopener">nokit</a>，启动本地服务。首次执行时将在项目空间创建 server.yml 配置文件。</p>
<p>奥妙：</p>
<ol>
<li>在 nokit 服务器中设置拦截器，通过 <a href="https://github.com/nodejitsu/node-http-proxy" target="_blank" rel="noopener">httpProxy</a> 转发请求。</li>
<li>ctx 中添加 server 属性，即 nokit.Server 实例；以及 httpServer 属性，即 server.httpServer。</li>
</ol>
<p>选项：</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>意义</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>host</td>
<td>主机，影响自动访问的页面地址</td>
<td>‘<a href="http://localhost" target="_blank" rel="noopener">http://localhost</a>‘</td>
</tr>
<tr>
<td>config</td>
<td>配置文件路径，作为 nokit 服务器的配置文件路径，默认读取 server.yml</td>
<td>‘server’</td>
</tr>
<tr>
<td>public</td>
<td>浏览器端访问资源文件的路径</td>
<td>‘./build’</td>
</tr>
<tr>
<td>port</td>
<td>端口，默认使用 ctx.oneport 检测空闲的端口</td>
<td>undefined</td>
</tr>
<tr>
<td>autoOpen</td>
<td>是否自动访问网页，false 时为否</td>
<td>undefined</td>
</tr>
</tbody>
</table>
<p>server.yml 中 proxy 支持配置选项：</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>意义</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>rules</td>
<td>转发路径匹配规则，如 ^/api(.*): ‘<a href="https://www.aliyun.com/" target="_blank" rel="noopener">https://www.aliyun.com/</a>‘</td>
<td>{}</td>
</tr>
<tr>
<td>options</td>
<td>作为 Proxy Server 的选项</td>
<td>{ xfwd: true, changeOrigin: true }</td>
</tr>
<tr>
<td>headers</td>
<td>设置代理请求的 header 头，如 Referer: ‘<a href="https://www.aliyun.com/" target="_blank" rel="noopener">https://www.aliyun.com/</a>‘ 可携带 cookie</td>
<td>undefined</td>
</tr>
</tbody>
</table>
<p>事件：</p>
<ul>
<li>‘server.init’，服务未启动时事件，参数 server 实例。</li>
<li>‘server.start’，服务启动成功时事件，参数 server 实例。</li>
</ul>
<h3 id="dn-middleware-dll"><a href="#dn-middleware-dll" class="headerlink" title="dn-middleware-dll"></a>dn-middleware-dll</h3><p>概述：独立构建项目依赖，节省打包时间。</p>
<p>奥妙：</p>
<ol>
<li>借助 ctx.exec 方法执行 webpack 中间件，打包项目的依赖，默认存放在工程目录 .cache 文件夹内。子文件夹名基于项目所使用的依赖通过 md5 生成散列，以便在依赖更新时重新打包。再借助 ctx.exec 方法执行 copy 中间件，将打包文件拷贝到 build/js 文件夹内。</li>
<li>通过 ‘webpack.config’ 事件，在 webpackConfig 插件中注入 webpack.DllReferencePlugin 插件。</li>
</ol>
<p>选项：</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>意义</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>output</td>
<td>打包文件输出位置</td>
<td>‘build/js’</td>
</tr>
<tr>
<td>libName</td>
<td>打包文件名</td>
<td>‘lib’</td>
</tr>
<tr>
<td>compress</td>
<td>是否压缩打包文件，默认压缩，false 时不压缩</td>
<td>undefined</td>
</tr>
<tr>
<td>vendors</td>
<td>待打包模块列表，默认为 package.json 中依赖</td>
<td>undefined</td>
</tr>
</tbody>
</table>
<h3 id="dn-middleware-faked"><a href="#dn-middleware-faked" class="headerlink" title="dn-middleware-faked"></a>dn-middleware-faked</h3><p>概述：基于 <a href="https://github.com/Houfeng/faked" target="_blank" rel="noopener">faked</a> 提供数据模拟服务。</p>
<p>奥妙：</p>
<ol>
<li>基于 faked 创建 gui server 服务器，配置的模拟数据将输出到工程目录 mock 文件夹中 index.js, gui.data.json。</li>
<li>模拟数据文件最终将作为 webpack 入口文件，以此实现远程请求的拦截，并实现热更新。</li>
<li>执行逻辑被封装为 ctx.faked.apply 方法，在 dn-middleware-webpack 中执行，两个中间件耦合度较高。</li>
</ol>
<p>选项：</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>意义</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>dir</td>
<td>打包文件输出位置</td>
<td>‘mock’</td>
</tr>
<tr>
<td>port</td>
<td>gui server 服务启动的端口号，默认使用 this.utils.oneport 检出</td>
<td>undefined</td>
</tr>
<tr>
<td>gui</td>
<td>禁用 gui server 服务</td>
<td>‘build/js’</td>
</tr>
</tbody>
</table>
<h3 id="dn-middleware-i18n"><a href="#dn-middleware-i18n" class="headerlink" title="dn-middleware-i18n"></a>dn-middleware-i18n</h3><p>概述：将工程目录中 locales 语言包加载为 $locales 模块，通过 $i18n 获取指定模块，实现国际化。</p>
<p>奥妙：</p>
<ol>
<li>使用 confman.webpackPlugin 方法将工程目录中的语言包输出为 $locales 虚拟模块。</li>
<li>使用 vmodule-webpack-plugin 类库输出 $i18n 虚拟模块，以获取指定文案。</li>
</ol>
<p>选项：</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>意义</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>dir</td>
<td>语言包所在位置</td>
<td>‘./locales’</td>
</tr>
<tr>
<td>extract</td>
<td>指定将语言包输出为单独的 js 资源的文件夹路径，默认不输出单独的脚本</td>
<td>null</td>
</tr>
</tbody>
</table>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><ul>
<li>dn-middleware-clean，清理文件或目录，可用 opts.target 加以配置，默认清理 ‘./build/<em>*/</em>.*’。</li>
<li>dn-middleware-copy，复制文件。选项 from 查询源文件的文件夹路径，默认 ‘./from’; to 目标文件夹路径; log 是否打印日志; dot 源文件匹配规则是否支持 ‘.’ 起始; direction 影响映射 key 键指代源文件还是目标文件; files 源文件和目标文件映射，目标文件路径支持占位符 {index} 替换（index 自右而左），或使用源文件路径（映射中，目标文件以 ‘/‘ 结尾）。</li>
<li>dn-middleware-browser-sync 基于 ‘browser-sync’ 监听打包文件变更，借助 ‘connect-browser-sync’ express中间件实现热更新。选项 files 配置监听的文件，默认 [‘./build/<em>*/</em>.*’]；port 为 ‘browser-sync’ 服务启动端口，默认 5001。</li>
<li>dn-middleware-git-sync，git 操作，包含 commit, push 动作（push 又区分日常和预发环境）。</li>
<li>dn-middleware-jcs，在 babel-loader 中添加 ‘jsx-control-statements’ 插件，以使 jsx 可使用结构控制语句，同时 lint 阶段也会作代码检查，参考 <a href="https://zhuanlan.zhihu.com/p/28519304" target="_blank" rel="noopener">通过 JSX Control Statements 编写 JSX</a>。</li>
<li>dn-middleware-lint，使用 eslint 命令作语法检查。</li>
<li>dn-middleware-tslint，对 typescript 进行语法检查。</li>
<li>dn-middleware-typedoc，使用 typedoc 为 typescript 项目生成文档。</li>
<li>dn-middleware-typescript，在 webpackConfig 中添加 awesome-typescript-loader，支持编译 tsx 模块。选项 declaration 是否分离 ts, js 文件，默认分离，false 时不分离。</li>
<li>dn-middleware-pkginfo，更新项目 package.json 中的 name, version, description 信息。</li>
<li>dn-middleware-prepush，在 .git/hooks/pre-push 添加 shell 命令，推送前执行 dn build 命令。</li>
<li>dn-middleware-sensitive-path，在 webpackConfig 中添加 ‘case-sensitive-paths-webpack-plugin’ 插件，使 mac, windows 引入模块时严格区分模块的大小写。</li>
<li>dn-middleware-shell，调用 ctx.utils.exec 执行 shell 命令。选项 script 命令内容；wscript 为 windows 系统下命令内容；async 是否异步执行，默认同步。</li>
<li>dn-middleware-watch，基于 ‘chokidar’ 监听执行文件变更。选项 match 匹配的文件，默认为 ‘./src/<em>*/</em>.*’；event 监听的事件类型；script 事件发生后执行的脚本；onChange 事件发生后执行的动作。</li>
<li>dn-middleware-unit，基于 ‘mocha’ 对 ./test/unit 文件夹中内容作单元测试。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/22/react/react相关/mobx使用探微/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/22/react/react相关/mobx使用探微/" itemprop="url">mobx使用探微</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-22T00:00:00+08:00">2018-08-22</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/状态管理/" itemprop="url" rel="index"><span itemprop="name">状态管理</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/08/22/react/react相关/mobx使用探微/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/08/22/react/react相关/mobx使用探微/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>写作这篇文章的起因是我有感于实际项目中所遇到的问题。因此，这篇文章只算是摸索的产物，远未臻于完美。在这里，我谨期望阅读这篇文章的同学能够见仁见智，各洒江海。</p>
<p>我所遇到的问题，总结如下：</p>
<ol>
<li>项目采用分层设计，pages 为视图层，stores 为模型层，services 为服务层。从某种意义上讲，代码是按功能单元进行划分的，而不是业务单元。需要分别从 pages, stores, services 层取出相应的模块，才能构成一个完整的业务单元。分层设计的优点在于代码组织的清晰性，但是降低了可移植性。当需要向第三方应用输出某个业务单元时，就不得不另起炉灶，需要重新为特定的视图组件串联 stores。</li>
<li>无论 stores 层，还是 services 层，代码设计大都以视图为出发点，比如 services 层多次对同一个后台接口实现了调用，比如 stores 混杂着特定页面的视图状态，不利于复用。通过这一点，所能感知的症结是，stores 层中的模块称不上是对数据模型的精要抽象。除此以外，这个病症所体现的另一个特征是，stores 层中的模块常常仅作为视图组件和 ajax 接口的桥接层，即简单地将接口数据灌入到视图中、或者将视图数据提交到远端。这样做的好处是 store 极为轻量，但是，其一，远没有挖掘 mobx 用于组织数据模型的价值（近于使用 redux 处理纯数据），其二，store 没法涵盖数据特征，数据在视图层消费时才能展现其意义。事实上，数据处理中的 value - text 转换也常常会落在视图层。这样，在另一张需要消费同一份数据的视图页面中，就仍需要重做一份数据转换处理。</li>
</ol>
<p>以上种种，促使我在业余时间着意摸索 mobx 的使用。很显然的，需求是技术提升的动力。离开项目环境，仅凭有限的知识和经验储备，我没办法复现实际项目的业务复杂度。相形之下，我所思忖的案例是较为简单的。因此，由这篇文章引出的种种观点无疑都是可商榷的。不过，有什么是一成不变的呢？譬如武侠小说中提到的，“剑招是死的，人是活的”。我再次期望阅读这篇文章的同学对本文所引出的命题有所意会、有所领悟，而对形式上的糟粕持宽容的态度；若是能以丰富的开发经验对我有所指教，那就再好不过了。</p>
<p>备注：示例代码通过自制的 <a href="https://github.com/Alfred-sg/plutarch" target="_blank" rel="noopener">plutarch 脚手架</a> 实现，托管仓库地址为 <a href="https://github.com/Alfred-sg/mobx-demo" target="_blank" rel="noopener">mobx-demo</a> 。</p>
<h2 id="案例前情"><a href="#案例前情" class="headerlink" title="案例前情"></a>案例前情</h2><p>案例将提取商城系统中的产品配置环节，绘制的页面仅包含产品列表页、产品编辑页和产品详情页。介于案例旨在于探讨 mobx 的使用，势必会使业务屈从于所要考量的功能点，一反业务引导开发的常态。我个人的一些看法，在开发已集大成的前提下，由开发引导业务也未尝不是一种选项；系统设计的舵手譬如指挥官，所需的是纵览全局的能力，不扭于认知、经验和职司。假使一位富于远见的开发对多个商城系统的设计和实现已经了然于胸，他又怎不能称为建站工作的主导者呢？只不过这一点对大多数人来说，都过于理想化，很能达成。毕竟职业、天赋和精力的限制，会让我们的成长道路都有所局限。当然，这是题外话。言归正传，本案例涵盖的考察要点包括：</p>
<ol>
<li>适用于多个页面的 Product 商品模型。</li>
<li>互为关联的 Product, Attribute 商品属性模型。</li>
</ol>
<p>以上两点，都是以数据模型为导向的，而不是着眼于页面绘制。从职责来看，前端的工作内容是绘制页面，页面逻辑在部分人眼里只是个子内容。但从整体来看，数据才是内容，视图只是表现。mobx 所提供的强大能力不止于像 redux 那样单纯处理数据流，而在于它通过代理提供了数据建模的可能。如果说 redux 是面向过程编程，那么 mobx 就是面向对象编程。附着的那层响应式操作不改变原有类的特征，使我们能更大程度地使用这个类。这是在响应式之外，使用 mobx 编程时尤其需要有所发现的点。下文将作深入探讨。</p>
<p>当前端的开发工作以数据模型为导向时，就更能契合后端的表结构设计、模型层实现，抽象程度也更高，自然能加深对业务的理解。另外，数据处理也不至于散落在视图层。</p>
<p>对于考察要点中的第二项，所需说明的是案例持有的业务特征。当我们访问淘宝，会发现手机从属于“家电 / 数码 / 手机”这一大类，“手机”这一小类；对于“手机”这一小类，还有诸如”机身内存ROM”，“手机类型”，“网络类型”，“附加功能”，“摄像头类型”，“分辨率”等特有属性。可以料想的是，这些特有属性和“手机”这个小类呈联动关系，即 Attribute 有单独的表设计（特征量和特征值双表）。特别说明这一点，既是为了剖析案例所有的业务特征，也是为了表明案例更大程度上植根于猜想，我并没有参与商城开发的十足经验，错谬也在所难免，期望阅读这篇文章的同学海涵。</p>
<p>简易的表结构设计如下（参考淘宝开放平台的商品接口设计）：</p>
<p><em>图 1，简要表结构</em><br><img src="/2018/08/22/react/react相关/mobx使用探微/database.png"></p>
<p>如上图所示，Product 产品表包含 cids 字段指向 Category 分类表，attrs 字段用于聚合 Attribute 属性特征量表和 Attr_Value 属性特征值表。贴图的表结构虽然难免会有差池，但不妨碍本文用于探讨 mobx 的使用。为了简化案列的复杂度，本文也约定 Category, Attribute, Attr_Value 表中的数据不需要另行制作配置页面注入数据。</p>
<p>基于以上，相应接口如下，相关代码参考托管仓库中的 plutarch.mock.js 文件：</p>
<ol>
<li>get api/category 接口用于获取产品类目，传参 level 用于区分检索大类还是小类，cid 用于锁定产品类目。</li>
<li>get api/attributes 接口用于获取与类目相关的属性，传参 cid 用于锁定产品类目。</li>
<li>post api/product 接口用于保存或更新产品。</li>
<li>get api/product 接口用于获取产品。</li>
<li>get api/products 接口用于获取产品列表。</li>
<li>delete api/product 用于删除产品。</li>
</ol>
<h2 id="案列实现"><a href="#案列实现" class="headerlink" title="案列实现"></a>案列实现</h2><p>案例仍采用分层架构（如何以业务单元形式组织代码暂留作后续的思考命题）：</p>
<p><em>图 2，整体架构</em><br><img src="/2018/08/22/react/react相关/mobx使用探微/architecture.png"></p>
<ol>
<li>requset 模块：基于 aioxs 类库处理 ajax 请求，使用拦截器诊断错误的响应，并使用 antd/message 组件在页面中显示错误内容（该组件能同时展现多个请求错误）。</li>
<li>services 层：使用 class 语法构造，便于继承，同时也继承了 Cache 类，用于缓存比较稳定的接口数据。同时，utils 工具包提供了 mixinStaticProperty 装饰器，用于将 services 层输出类的原型方法注入为 model 类的静态方法，参见 stores/models/Product 类的实现。services 层也可以用于拆分接口，如 services/category 将 getCategory 接口拆分为 getCategoryByCid, getCategoryByLevel 两个接口。这样便于更细微的控制，当然，拆分接口的稳定性另当别论。</li>
<li>stores/models 基本数据模型：数据模型分为两类，一类需要深入数据库或后台模型的数据特征，如 Product 类拥有诸多的可观察属性，便于以方法的形式操作这些属性值的变更，而列表也是由这些类自底而上构成的；另一类则采用数目不多的属性批量更新的机制实现，不需要微操数据的变更，所包含的方法通常也只跟远程请求相关，如 Category, Attribute 类。</li>
<li>stores 层其余衍生数据模型：基于 models 实现，与页面实际交互的模型，如由 Product 类衍生出 ProductInEdit, ProductInDetail, ProductList 三个类，即分别应用于编辑页、详情页和列表页。编辑页和详情页所使用的模型均可拓展 Product 类实现，案列出于职责分离的考虑，将其细分为多个子类。当然，也可以像案列中 Category 类的实现那样，在该类中聚合多种只能，比如全量拉取产品分类数据，以及只拉取针对某个产品的分类数据。同时，为了更好地实现数据处理，Category, Attribute 类均输出实例作为 Product 的实例属性，这样能聚合该产品的分类、属性数据处理操作。</li>
<li>pages 层：当 stores 层通过数据模型承担数据处理操作时，pages 理论上只承担了展示职能。介于 mobx 实现代理数组的特殊性，改变数组项的内部属性只能通过观察该数组项完成，列表操作又需要调用代理数组的方法，才能启动重绘。因此，使用 mobx 注入可观察数据时，首先，组件的颗粒度需要得到细化处理，其次，在删除某个数组项如某个产品时，不禁需要调用 product.delete 方法，也需要调用调用 products.splice 方法，使列表得到重绘。</li>
<li>locales 层：提供国际化文案，使用命名空间拆分成 action, model,text 三大类。action 包含操作类文案，model 包含数据模型相关文案，text 包含标题、消息和普通文本。国际化文案可直接注入视图层，或者经由 model 作转化处理后注入视图层，后者作为 model 的静态属性注入视图层。</li>
</ol>
<p>以下内容将通过代码展示部分实现。</p>
<h3 id="数据缓存"><a href="#数据缓存" class="headerlink" title="数据缓存"></a>数据缓存</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> caches = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 设置数据缓存</span></span><br><span class="line">  setCache(actionName, key, value)&#123;</span><br><span class="line">    <span class="keyword">if</span> ( !caches[actionName] ) caches[actionName] = &#123;&#125;;</span><br><span class="line">    caches[actionName][key] = value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取数据缓存</span></span><br><span class="line">  getCache(actionName, key)&#123;</span><br><span class="line">    <span class="keyword">const</span> cache = caches[actionName];</span><br><span class="line">    <span class="keyword">return</span> cache &amp;&amp; key !== <span class="literal">undefined</span> ? cache[key] : cache;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清除数据缓存</span></span><br><span class="line">  clearCache(actionName)&#123;</span><br><span class="line">    caches[actionName] = <span class="literal">undefined</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryService</span> <span class="keyword">extends</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> getCategory(params)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; cid, level &#125; = params;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ( level !== <span class="literal">undefined</span> ) </span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.getCategoryByLevel(level);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( cid !== <span class="literal">undefined</span> ) </span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.getCategoryByCid(cid);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 在 service 层将 getCategory 拆分成多个针对请求的微处理接口</span></span><br><span class="line">  <span class="comment">// 必要时使用缓存数据</span></span><br><span class="line">  <span class="keyword">async</span> getCategoryByLevel(level)&#123;</span><br><span class="line">    <span class="keyword">let</span> res = <span class="keyword">this</span>.getCache(<span class="string">'getCategoryByLevel'</span>, level);</span><br><span class="line">    <span class="keyword">if</span> ( res ) <span class="keyword">return</span> res;</span><br><span class="line">    </span><br><span class="line">    res = <span class="keyword">await</span> get(<span class="string">'/api/category'</span>, &#123; level &#125;);</span><br><span class="line">    <span class="keyword">this</span>.setCache(<span class="string">'getCategoryByLevel'</span>, level, res);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> getCategoryByCid(cid)&#123;</span><br><span class="line">    <span class="keyword">let</span> res = <span class="keyword">this</span>.getCache(<span class="string">'getCategoryByCid'</span>, cid);</span><br><span class="line">    <span class="keyword">if</span> ( res ) <span class="keyword">return</span> res;</span><br><span class="line"></span><br><span class="line">    res = <span class="keyword">await</span> get(<span class="string">'/api/category'</span>, &#123; cid &#125;);</span><br><span class="line">    <span class="keyword">this</span>.setCache(<span class="string">'getCategoryByCid'</span>, cid, res);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码通过 Cache 类实现数据缓存功能，CategoryService 类继承后，将根据请求内容、原型方法名缓存 ‘/api/category’ 接口的响应数据。同时，getCategory 接口也视页面中的调用情况拆分为 getCategoryByLevel, getCategoryByCid 两个原型方法，也许这是画蛇添足的一个举动，既会使代码不够简易，在后台接口变动时，又会增加额外的修改量，不过却暗含着一种可能，利弊交由阅读这篇文章的同学自行判断。</p>
<p>以上代码存在的优化点：</p>
<ol>
<li>缓存 key 键的兼容度，Cache 类实现上仅能处理有请求参数的情形，而有些可以作缓存的接口没有请求参数。</li>
<li>缓存的时效问题，Cache 类的缓存机制在当前访问过程中均有效，在该时间段无法拉取数据库中已作更改的最新值。</li>
</ol>
<h3 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可采用继承的方式将远程请求方法混入到 Product 类中，此处使用 mixinStaticProperty 装饰器混入静态方法</span></span><br><span class="line">@mixinStaticProperty(ProductService)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line">  @observable id;<span class="comment">// 商品id</span></span><br><span class="line">  @observable name;<span class="comment">// 商品名称</span></span><br><span class="line">  @observable cids;<span class="comment">// 商品分类</span></span><br><span class="line">  @observable attrValues = &#123;&#125;;<span class="comment">// 商品属性</span></span><br><span class="line">  @observable num;<span class="comment">// 库存</span></span><br><span class="line">  @observable price;<span class="comment">// 价格</span></span><br><span class="line">  @observable desc;<span class="comment">// 描述</span></span><br><span class="line">  @observable status;<span class="comment">// 状态</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(props)&#123;</span><br><span class="line">    <span class="keyword">this</span>.setValues(props);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 后台交互数据全量更新；部分更新可直接使用赋值语句；重置可传空</span></span><br><span class="line">  @action</span><br><span class="line">  setValues(data = &#123;&#125;)&#123;</span><br><span class="line">    <span class="keyword">this</span>.id = data.id;</span><br><span class="line">    <span class="keyword">this</span>.name = data.name;</span><br><span class="line">    <span class="keyword">this</span>.cids = data.cids;</span><br><span class="line">    <span class="keyword">this</span>.attrValues = data.attrValues || &#123;&#125;;</span><br><span class="line">    <span class="keyword">this</span>.num = data.num;</span><br><span class="line">    <span class="keyword">this</span>.price = data.price;</span><br><span class="line">    <span class="keyword">this</span>.desc = data.desc;</span><br><span class="line">    <span class="keyword">this</span>.status = data.status;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取后台交互数据</span></span><br><span class="line">  getValues()&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      id: <span class="keyword">this</span>.id,</span><br><span class="line">      name: <span class="keyword">this</span>.name,</span><br><span class="line">      cids: <span class="keyword">this</span>.cids,</span><br><span class="line">      attrValues: <span class="keyword">this</span>.attrValues,</span><br><span class="line">      num: <span class="keyword">this</span>.num,</span><br><span class="line">      price: <span class="keyword">this</span>.price,</span><br><span class="line">      desc: <span class="keyword">this</span>.desc,</span><br><span class="line">      status: <span class="keyword">this</span>.status</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  @action</span><br><span class="line">  <span class="keyword">async</span> getProduct(id)&#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> Product.get(&#123; id &#125;);</span><br><span class="line">    <span class="keyword">if</span> ( res ) <span class="keyword">this</span>.setValues(res);</span><br><span class="line">    <span class="keyword">return</span> res || <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  @action</span><br><span class="line">  <span class="keyword">async</span> saveProduct()&#123;</span><br><span class="line">    <span class="keyword">const</span> params = <span class="keyword">this</span>.getValues();</span><br><span class="line">    <span class="keyword">const</span> res = params.id ? <span class="keyword">await</span> Product.update(params) : <span class="keyword">await</span> Product.save(params);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  @action</span><br><span class="line">  <span class="keyword">async</span> deleteProduct()&#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> Product.del(&#123; <span class="attr">id</span>: <span class="keyword">this</span>.id &#125;);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码为 Product 基类，可以看出，实现上同后台提供的接口和数据模型均强关联，其一通过 observable 装饰器将后台提供的字段全部转化为可观察属性，并提供 setValues, getValues 批量赋值和取值（通常在提交数据前、获取数据后，需要调用这两个方法）；其二以原型方法实现 ajax 调用，这里既可以继承 services 层中的类，也可以使用 mixinStaticProperty 装饰器注入静态方法。</p>
<p>Product 基类化用了 backbone 模型特征，可以优化的点：</p>
<ol>
<li>代码自动生成。通过 Product 基类也能发现，该类数据模型拥有很高的类同点，基于后台数据模型及接口实现 mobx 数据模型基类，如果能根据 jar 包和配置文件，自动生成这些基类文件，那就再好不过了。当然，这对我来说，也是短期内没法办到的事。需要走的路还长着呢。</li>
<li>案列中没有考虑两份提交数据，多个接口调用，比如产品状态更新，就需要多一份产品状态提交数据，再调用状态更新的接口。因此，我的一些想法还没经过实践沉淀，合理性和稳定性势必存疑，比如前一条优化建议。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductInDetail</span> <span class="keyword">extends</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line">  attribute = <span class="keyword">new</span> Attribute();</span><br><span class="line">  category = <span class="keyword">new</span> Category();</span><br><span class="line"></span><br><span class="line">  @observable categories = [];<span class="comment">// 商品分类全量信息</span></span><br><span class="line">  @observable attributes = [];<span class="comment">// 商品属性全量信息</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 备注，改变单个数组项的属性不会引起视图重绘，必须在数组中改变整个数组项</span></span><br><span class="line">  <span class="comment">// 在 product 实例初始化过程中调用 getCategories 方法，不会引起 Table 视图的重绘</span></span><br><span class="line">  @action</span><br><span class="line">  <span class="keyword">async</span> getCategories(cids)&#123;</span><br><span class="line">    <span class="keyword">this</span>.categories = [];</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">this</span>.category.getCategoryByCids(cids);</span><br><span class="line">    <span class="keyword">if</span> ( res ) <span class="keyword">this</span>.categories = res;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取商品分类文案</span></span><br><span class="line">  @computed</span><br><span class="line">  get categoryTexts()&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.categories.map(<span class="function"><span class="params">item</span> =&gt;</span> item.name).join(<span class="string">', '</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取属性</span></span><br><span class="line">  @action</span><br><span class="line">  <span class="keyword">async</span> getAttributes(cid)&#123;</span><br><span class="line">    <span class="keyword">this</span>.attributes = [];</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">this</span>.attribute.getAttributes(&#123; cid  &#125;);</span><br><span class="line">    <span class="keyword">if</span> ( res ) <span class="keyword">this</span>.attributes = res;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @computed</span><br><span class="line">  get attributeTexts()&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; attrValues, attributes &#125; = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">Object</span>.keys(attrValues).length || !attributes.length ) <span class="keyword">return</span> [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> result = [];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Object</span>.keys(attrValues).map(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> attr = attributes.find(<span class="function"><span class="params">attr</span> =&gt;</span> attr.id == key);</span><br><span class="line">      <span class="keyword">const</span> name = attr.name;</span><br><span class="line">      <span class="keyword">let</span> value = attrValues[key].map(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> attr.options.find(<span class="function"><span class="params">item</span> =&gt;</span> item.id == val).name;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      result.push(&#123;</span><br><span class="line">        name,</span><br><span class="line">        value</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取商品状态文案</span></span><br><span class="line">  @computed</span><br><span class="line">  get statusText()&#123;</span><br><span class="line">    <span class="keyword">let</span> text = StatusList.filter(<span class="function"><span class="params">item</span> =&gt;</span> item.value === <span class="keyword">this</span>.status)[<span class="number">0</span>].text;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> text;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductInEdit</span> <span class="keyword">extends</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line">  attribute = <span class="keyword">new</span> Attribute();</span><br><span class="line"></span><br><span class="line">  @observable attributes = [];<span class="comment">// 商品属性全量信息</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取属性</span></span><br><span class="line">  @action</span><br><span class="line">  <span class="keyword">async</span> getAttributes(cid)&#123;</span><br><span class="line">    <span class="keyword">this</span>.attributes = [];</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">this</span>.attribute.getAttributes(&#123; cid  &#125;);</span><br><span class="line">    <span class="keyword">if</span> ( res ) <span class="keyword">this</span>.attributes = res;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 编辑页显示数据</span></span><br><span class="line">  @computed</span><br><span class="line">  get pageValues()&#123;</span><br><span class="line">    <span class="keyword">let</span> attrValues = &#123;&#125;;</span><br><span class="line">    <span class="built_in">Object</span>.keys(<span class="keyword">this</span>.attrValues).map(<span class="function"><span class="params">attrId</span> =&gt;</span> &#123;</span><br><span class="line">      attrValues[<span class="string">`attrId<span class="subst">$&#123;attrId&#125;</span>`</span>] = <span class="keyword">this</span>.attrValues[attrId];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      name: <span class="keyword">this</span>.name,</span><br><span class="line">      cids: <span class="keyword">this</span>.cids,</span><br><span class="line">      attrs: attrValues,</span><br><span class="line">      num: <span class="keyword">this</span>.num,</span><br><span class="line">      price: <span class="keyword">this</span>.price,</span><br><span class="line">      desc: <span class="keyword">this</span>.desc</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码基于 Product 类实现详情页、编辑页专用的数据模型，无非获取远程数据，进行 value - name 值转换。在获取远程数据时，可以将另一个数据模型以实例属性的方式注入到当前数据模型中，以便于在当前模型中作数据转换处理，同时增加了模型之间的耦合度。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductList</span> </span>&#123;</span><br><span class="line">  @observable products = [];</span><br><span class="line">  </span><br><span class="line">  @action</span><br><span class="line">  <span class="keyword">async</span> getProducts()&#123;</span><br><span class="line">    <span class="keyword">this</span>.products = [];</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> Product.query();</span><br><span class="line">    (res || []).map(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.products.push(<span class="keyword">new</span> Product(item));<span class="comment">// 此处 Product 为 ProductInDetail</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ProductList 类基于 ProductInDetail 实例构建数组项，以便于在视图层绘制列表时直接绘制 ProductInDetail 实例的计算属性或者调用其远程请求接口。</p>
<h3 id="并行请求"><a href="#并行请求" class="headerlink" title="并行请求"></a>并行请求</h3><p>并行请求可以在视图层通过 Promise.all 加以组织，也可以在模型层组织同一类并行请求接口，如 Category 模型中通过 getCategoryByCids 方法获取产品的多个类目信息。当然，这部分内容通常由后端同学帮忙完成，这里仅展示前端代码实现上的一种可能。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Category</span> <span class="keyword">extends</span> <span class="title">CategoryService</span> </span>&#123;</span><br><span class="line">  @observable categories = [];</span><br><span class="line"></span><br><span class="line">  @action</span><br><span class="line">  insertToCategories = <span class="function">(<span class="params">category = &#123;&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="keyword">this</span>.categories.some(<span class="function"><span class="params">item</span> =&gt;</span> item.id == category.id) )&#123;</span><br><span class="line">      <span class="keyword">this</span>.categories.push(category);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> getCategory(params)&#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">super</span>.getCategory(params);</span><br><span class="line">    <span class="keyword">if</span> ( res )&#123;</span><br><span class="line">      <span class="comment">// 将多次数据变更合成一个事务，减少重绘的次数</span></span><br><span class="line">      transaction(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        res.map(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">this</span>.insertToCategories(item);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理并行请求</span></span><br><span class="line">  getCategoryByCids(cids)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.categories = [];</span><br><span class="line">  </span><br><span class="line">      cids.map(<span class="keyword">async</span> cid =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">this</span>.getCategory(&#123; cid &#125;);</span><br><span class="line">        <span class="keyword">if</span> ( !res ) reject(res);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 最后一个请求，响应通过 insertToCategories 方法收集到 categories 属性中</span></span><br><span class="line">        <span class="keyword">if</span> ( cids.length == <span class="keyword">this</span>.categories.length ) </span><br><span class="line">          resolve(<span class="keyword">this</span>.categories);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 传入 cids，便于并行请求</span></span><br><span class="line">  getCategoryByLevels(cids)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      cids.map(<span class="keyword">async</span> (cid, index) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">this</span>.getCategory(&#123; <span class="attr">level</span>: index + <span class="number">1</span> &#125;);</span><br><span class="line">        <span class="keyword">if</span> ( !res ) reject(res);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( index + <span class="number">1</span> === cids.length ) resolve(<span class="keyword">this</span>.categories);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @computed</span><br><span class="line">  get categoriesTree()&#123;</span><br><span class="line">    <span class="keyword">let</span> tree = [];</span><br><span class="line">    <span class="keyword">this</span>.categories.toJS().sort(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a.level - b.level).filter(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> ( item.level == <span class="number">1</span> )&#123;</span><br><span class="line">        tree.push(&#123;</span><br><span class="line">          value: item.id,</span><br><span class="line">          label: item.name,</span><br><span class="line">          isLeaf: <span class="literal">false</span></span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( item.level == <span class="number">2</span> )&#123;</span><br><span class="line">        <span class="keyword">let</span> parent = tree.filter(<span class="function"><span class="params">it</span> =&gt;</span> it.value == item.parentId)[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> ( !parent.children ) parent.children = [];</span><br><span class="line">        parent.children.push(&#123;</span><br><span class="line">          value: item.id,</span><br><span class="line">          label: item.name</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tree;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="视图组件"><a href="#视图组件" class="headerlink" title="视图组件"></a>视图组件</h3><p>组件层即如上文所说的，所需注意的是 mobx 中数组的特殊性，单纯赋值数组项的属性不会引起观察数组的组件重绘，而需要将组件的颗粒度锁定为观察数组项，如下方代码的 CategoryText 组件。删除数组项时，也需要调用代理数组的 splice 方法，才能引起列表组件重绘，如 ProductList 组件内 deleteProduct 方法的实现。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">@observer</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryText</span> <span class="keyword">extends</span> <span class="title">Component</span></span>&#123;</span><br><span class="line">  componentDidMount()&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; product, loadCategory &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">if</span> ( loadCategory ) product.getCategories(product.cids);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render()&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; product &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">return</span> product.categoryTexts;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">@inject(<span class="string">'productList'</span>)</span><br><span class="line">@observer</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductList</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  columns = [&#123;</span><br><span class="line">    title: $i18n(<span class="string">'model.product.id'</span>),</span><br><span class="line">    dataIndex: <span class="string">'id'</span>,</span><br><span class="line">    key: <span class="string">'id'</span></span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    title: $i18n(<span class="string">'model.product.name'</span>),</span><br><span class="line">    dataIndex: <span class="string">'name'</span>,</span><br><span class="line">    key: <span class="string">'name'</span>,</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    title: $i18n(<span class="string">'model.product.categories'</span>),</span><br><span class="line">    dataIndex: <span class="string">'categories'</span>,</span><br><span class="line">    key: <span class="string">'categories'</span>,</span><br><span class="line">    render: <span class="function">(<span class="params">categories, product</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">CategoryText</span> <span class="attr">product</span>=<span class="string">&#123;product&#125;</span> <span class="attr">loadCategory</span>=<span class="string">&#123;true&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">    &#125;</span></span><br><span class="line"><span class="xml">  &#125;, &#123;</span></span><br><span class="line"><span class="xml">    title: $i18n('model.product.price'),</span></span><br><span class="line"><span class="xml">    dataIndex: 'price',</span></span><br><span class="line"><span class="xml">    key: 'price'</span></span><br><span class="line"><span class="xml">  &#125;, &#123;</span></span><br><span class="line"><span class="xml">    title: $i18n('model.product.num'),</span></span><br><span class="line"><span class="xml">    dataIndex: 'num',</span></span><br><span class="line"><span class="xml">    key: 'num'</span></span><br><span class="line"><span class="xml">  &#125;, &#123;</span></span><br><span class="line"><span class="xml">    title: $i18n('model.product.status'),</span></span><br><span class="line"><span class="xml">    dataIndex: 'statusText',</span></span><br><span class="line"><span class="xml">    key: 'statusText'</span></span><br><span class="line"><span class="xml">  &#125;, &#123;</span></span><br><span class="line"><span class="xml">    title: $i18n('model.product.desc'),</span></span><br><span class="line"><span class="xml">    dataIndex: 'desc',</span></span><br><span class="line"><span class="xml">    key: 'desc'</span></span><br><span class="line"><span class="xml">  &#125;, &#123;</span></span><br><span class="line"><span class="xml">    title: $i18n('action.handle'),</span></span><br><span class="line"><span class="xml">    key: 'action',</span></span><br><span class="line"><span class="xml">    render: (text, product, index) =&gt; (</span></span><br><span class="line">      &lt;span&gt;</span><br><span class="line">        &lt;Link to=&#123;`/detail/$&#123;product.id&#125;`&#125; style=&#123;&#123;marginRight: '10px'&#125;&#125;&gt;&#123;$i18n('text.detail')&#125;&lt;/Link&gt;</span><br><span class="line">        &lt;Link to=&#123;`/edit/$&#123;product.id&#125;`&#125; style=&#123;&#123;marginRight: '10px'&#125;&#125;&gt;&#123;$i18n('action.edit')&#125;&lt;/Link&gt;</span><br><span class="line">        &lt;Popconfirm title=&#123;$i18n('text.product.delete_confirm')&#125; </span><br><span class="line">          onConfirm=&#123;() =&gt; &#123; this.deleteProduct(product, index) &#125;&#125; </span><br><span class="line">          okText=&#123;$i18n('action.ok')&#125; cancelText=&#123;$i18n('action.cancel')&#125;&gt;</span><br><span class="line">          &lt;a href="javascript:;"&gt;&#123;$i18n('action.delete')&#125;&lt;/a&gt;</span><br><span class="line">        &lt;/Popconfirm&gt;</span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">    ),</span></span><br><span class="line"><span class="xml">  &#125;];</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  componentDidMount()&#123;</span></span><br><span class="line"><span class="xml">    this.props.productList.getProducts();</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  // 删除商品</span></span><br><span class="line"><span class="xml">  deleteProduct = async (product, index) =&gt; &#123;</span></span><br><span class="line"><span class="xml">    const &#123; products &#125; = this.props.productList;</span></span><br><span class="line"><span class="xml">    const res = await product.deleteProduct();</span></span><br><span class="line"><span class="xml">    if ( res )&#123;</span></span><br><span class="line"><span class="xml">      products.splice(index);</span></span><br><span class="line"><span class="xml">      message.success($i18n('text.product.delete_success'));</span></span><br><span class="line"><span class="xml">    &#125;;</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  render()&#123;</span></span><br><span class="line"><span class="xml">    const &#123; products &#125; = this.props.productList;</span></span><br><span class="line"><span class="xml">    </span></span><br><span class="line"><span class="xml">    return (</span></span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Button style=&#123;&#123;marginBottom: '15px'&#125;&#125; type='primary'&gt;</span><br><span class="line">          &lt;Link to=&#123;'/create'&#125;&gt;&#123;`$&#123;$i18n('action.create')&#125;$&#123;$i18n('text.product')&#125;`&#125;&lt;/Link&gt;</span><br><span class="line">        &lt;/Button&gt;</span><br><span class="line">        &lt;Table size="small" rowKey='id' columns=&#123;this.columns&#125; dataSource=&#123;products.toJS()&#125; /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>更多代码，请参考 <a href="https://github.com/Alfred-sg/mobx-demo" target="_blank" rel="noopener">mobx-demo</a>，也许阅读这篇文章的同学能有额外的发现呢。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>《唐李问对》褒扬诸葛亮而贬低曹操，因为曹操的《孟德新书》适合于照章办事的生手，诸葛亮的《兵法二十篇》适合于独立思考的老手。其中的事理，和吴军博士在《数学之美》中论述道与术一样，浮于浅层的形式抵不过深入的理解。这是一篇富有探索气质的文章，更多地旨在于引发思考，而不是妄下定论。何况这篇文章对于 mobx 的使用及其实现内核的化用，也只是迈出了小小的一两步。要走的路还长着呢。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://open.taobao.com/doc.htm?docId=73&amp;docType=1" target="_blank" rel="noopener">淘宝开放平台 - 文档中心</a><br><a href="https://blog.csdn.net/crazzy0727/article/details/59576713" target="_blank" rel="noopener">淘宝商品数据库设计</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/15/react/react相关/mobx源码分析2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/15/react/react相关/mobx源码分析2/" itemprop="url">mobx源码分析（二） 订阅响应式数据</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-15T00:00:00+08:00">2018-08-15</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/状态管理/" itemprop="url" rel="index"><span itemprop="name">状态管理</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/08/15/react/react相关/mobx源码分析2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/08/15/react/react相关/mobx源码分析2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>处理问题有两种方式，从一般到具体，或者从具体到一般。在写作这两篇文章时，我选择了后者，一是因为我在写作这篇文章的过程中才逐渐摸清 mobx 的设计和实现，二是因为我自身尚不具备足够的积淀，能站在更高的抽象维度对问题的一般面加以思索。上一篇文章对各种数据结构的处理无疑都是具体的，本文将介入如何抽象 observable，即对上一篇文章中的公有特征 reportObserved, reportChanged 方法加以萃取。</p>
<p>本文也将致力于解答上一篇文章遗留的问题，怎样使观察者订阅响应式数据的变更。</p>
<p>总而言之，本文将串联 mobx 的核心运作机制，从执行动作 action 促使响应式数据 observable 变更，到响应式数据变更引起衍生 derivation 执行的一整个过程。</p>
<h2 id="概念"><a href="#概念" class="headerlink" title="概念"></a>概念</h2><p>首先，我们先来看一下 mobx 设计的几种抽象概念：</p>
<ol>
<li>observable: 响应式数据，最主要的特征是将数据变更信息上报给全局监听器。mobx 使用 IObservable 接口，Atom 类加以抽象。</li>
<li>derivation: 衍生，响应式数据变更后执行的副作用函数，包含计算属性、反应。mobx 使用 IDerivation 接口，ComputedValue 类、Reaction 类加以抽象。</li>
<li>action: 动作，由其促使响应式数据发生变更。上一节已指出，使用 observableValue 实例的 set 方法，就能促使响应式数据发生变更，action 的意义在于，使用 startBatch, endBatch 事务发生执行动作，能整合一组响应式数据变更，在这一组响应式数据变更完成后，再执行 derivation 衍生。在 mobx 中，action 是很轻的一层，因为将响应式数据变更上报到全局环境由 observable 完成，action 中的逻辑处理即是在动作执行期间使用事务加以包裹，并根据配置项判断响应式数据只能在 action 中完成。在这篇文章中将不作赘述。</li>
</ol>
<p><em>图 1，observable, derivation 类图</em><br><img src="/2018/08/15/react/react相关/mobx源码分析2/core.png"></p>
<h3 id="observable"><a href="#observable" class="headerlink" title="observable"></a>observable</h3><p>对于 observable，所需考虑的是，响应式数据变更会引起指定的观察者执行其处理逻辑；当响应式数据没有指定观察者时，数据变更就不会引起衍生的执行。为此，在 mobx 抽象的 IObservable 接口中，observers 属性为 observable 绑定的观察者队列；lowestObserverState 属性为状态标识，用于标记数据是否被更新，需要执行相应的衍生；diffValue 属性用于实时更新 observable, observer 的依赖关系。</p>
<p>此外，在 IObservable 接口中，mobx 还提供了 onBecameUnobservered, onBecameObservered 钩子，分别在 observable 不被监听或被监听时得到调用；lastAcessedBy（最后消费 observable 的观察者 id）, isBeingObserved 属性用于使 onBecameObservered 钩子不被反复调用；isPendingUnobservation 属性用于使 onBecameUnobservered 钩子不被反复执行。与配置项相当，属性需要通过翻阅源码中的逻辑实现，才能确切感知到该属性存在的价值。介于部分属性与核心流程无关，在这里将只作简要讨论或不作讨论。</p>
<p>Atom 类除了实现 IObservable 接口以外，额外新增了 reportObserved, reportChanged 方法。顾名思义，当 observable 被观察时，需要显示调用 reportObserved 方法；当 observable 数据变更时，需要显示调用 reportChanged 方法。更多内容，参见前文 - <a href="http://xzfyu.com/2018/08/03/react/react%E7%9B%B8%E5%85%B3/mobx%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%901/" target="_blank" rel="noopener">mobx 源码分析（一）构造响应式数据</a>。</p>
<h3 id="derivation"><a href="#derivation" class="headerlink" title="derivation"></a>derivation</h3><p>derivation 可以理解为实际消费 observable 的观察者，因此，本文中的 observer 指代的也就是 derivation。在 mobx 实现中，observable, derivation 相互持有彼此的引用。IDerivation 接口的 observing 属性本次衍生在哪些响应式数据变更时执行；dependenciesState 属性为状态标识，用于标记本次衍生观察的数据是否已经改变，是否运行期处理逻辑；onBecomeStale 方法就是当观察数据变更时，运行的处理逻辑；newObserving 属性用于变更 observable, derivation 的依赖关系（在于观察者可改变观察的数据）；unboundDepsCount 属性用于统计本次衍生所观察的数据量，同 observable.diffValue 一样，目的都在于实时更新 observable, derivation 的依赖关系。</p>
<p>除了上述属性和方法，IDerivation 接口还提供了 runId 属性，由它构成 observable.lastAcessedBy 的值；isTracing 属性标记日志级别，以便在 onBecomeStale 方法执行前打印日志。</p>
<p>IDerivation 接口有两种实现，其一是作为反应的 Reaction 类，其二是作为计算属性的 ComputedValue 类。这两个类都实现了具体的 onBecomeStale 方法。reaction.onBecomeStale 方法的表现是在所有响应式数据变更完成后，再对相关的衍生执行批处理操作，当然，在同一个批处理周期内，不会再对由 reaction 引起的衍生加以处理，这些衍生需要等待下一个批处理周期。ComputedValue 的特别之处是，它既是衍生，观察着数据变更；又是响应式数据，被其他衍生所观察。因此，computedValue.onBecomeStale 方法的处理逻辑是在其他衍生执行 onBecomeStale 过程中，重新获取计算属性的值。</p>
<h2 id="运作机制"><a href="#运作机制" class="headerlink" title="运作机制"></a>运作机制</h2><h3 id="reportObserved"><a href="#reportObserved" class="headerlink" title="reportObserved"></a>reportObserved</h3><p>当响应式数据被衍生订阅时，将会执行 obsrvable.reportObserved 方法。在该方法的执行过程中，无他，就是针对当前执行的衍生调用其观察的响应式数据的 onBecameObserved 方法；或者将该 obsrvable 实例添加到 globalState.pendingUnobservations 数组中，等待事务结束时，执行 observable.onBecomeUnobserved 与 computedValue.suspend 方法。这里不再作介绍。</p>
<h3 id="reportChanged"><a href="#reportChanged" class="headerlink" title="reportChanged"></a>reportChanged</h3><p><em>图 2，reportChanged 执行流程</em><br><img src="/2018/08/15/react/react相关/mobx源码分析2/reportChanged.png"></p>
<p>结合上图，当响应式数据发生变更时，mobx 的处理机制为：</p>
<ol>
<li>通过 observable.reportChanged 方法将响应式数据变更的信息上报到全局监听器。</li>
<li>observable.reportChanged 执行过程中，使用 startBatch, endBatch 函数将 propagateChange(observable) 包裹到事务处理流程中。mobx 中的事务通过 globalState.inBatch 计数器标识：在 startBatch 函数执行过程中，globalState.inBatch 加 1；在 endBatch 函数执行过程中，globalState.inBatch 减 1；当 globalState.inBatch 为 0 时，表示单个事务处理结束。因为事务的意义在于将并行的响应式数据变更视为一组，在一组变更完成之后，在执行相应的衍生。</li>
<li>在同一个事务处理流程中，首先通过 propagateChange(observable) 间接将 derivation 加入到 globalState.pendingReactions 队列中。该过程中通过调用 derivation.onBecameStale 方法实现。对于 reaction 反应，在事务执行期间，直接将 reaction 添加到 globalState.pendingReactions 队列；对于 computedValue 计算属性，间接将观察 computedValue 变更的 reaction 添加到 globalState.pendingReactions 队列。</li>
<li>在 endBatch 函数执行期间，通过调用 runReactions 方法遍历 globalState.pendingReactions 队列，执行 reaction.runReaction 方法。每个 reaction.runReaction 方法内部的执行逻辑中，包含 observer 依赖和状态更新，以及执行用户实际注册的监听函数。reaction.runReaction 方法的处理细节将在后文加以分析。</li>
<li>在事务处理的尾端，又将遍历 globalState.pendingUnobservations 数组，调用 observable.onBecomeUnobserved 方法。对于计算属性，额外调用 computedValue.suspend() 方法。这样的目的在于当前没有观察者监听这些 observable 或 computedValue 的变更，无需将数据变更上报到全局环境。</li>
</ol>
<p><em>代码段 1，reportChanged 处理流程</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Atom</span> <span class="title">implements</span> <span class="title">IAtom</span> </span>&#123;</span><br><span class="line">  public reportChanged() &#123;</span><br><span class="line">    startBatch()</span><br><span class="line">    propagateChanged(<span class="keyword">this</span>)</span><br><span class="line">    endBatch()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">startBatch</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  globalState.inBatch++</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">endBatch</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (--globalState.inBatch === <span class="number">0</span>) &#123;</span><br><span class="line">    runReactions()</span><br><span class="line">    <span class="keyword">const</span> list = globalState.pendingUnobservations</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; list.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> observable = list[i]</span><br><span class="line">      observable.isPendingUnobservation = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">if</span> (observable.observers.size === <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (observable.isBeingObserved) &#123;</span><br><span class="line">          observable.isBeingObserved = <span class="literal">false</span></span><br><span class="line">          observable.onBecomeUnobserved()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (observable <span class="keyword">instanceof</span> ComputedValue) &#123;</span><br><span class="line">          observable.suspend()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    globalState.pendingUnobservations = []</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">propagateChanged</span>(<span class="params">observable: IObservable</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (observable.lowestObserverState === IDerivationState.STALE) <span class="keyword">return</span></span><br><span class="line">  observable.lowestObserverState = IDerivationState.STALE</span><br><span class="line"></span><br><span class="line">  observable.observers.forEach(<span class="function"><span class="params">d</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (d.dependenciesState === IDerivationState.UP_TO_DATE) &#123;</span><br><span class="line">      d.onBecomeStale()</span><br><span class="line">    &#125;</span><br><span class="line">    d.dependenciesState = IDerivationState.STALE</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">propagateMaybeChanged</span>(<span class="params">observable: IObservable</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (observable.lowestObserverState !== IDerivationState.UP_TO_DATE) <span class="keyword">return</span></span><br><span class="line">  observable.lowestObserverState = IDerivationState.POSSIBLY_STALE</span><br><span class="line"></span><br><span class="line">  observable.observers.forEach(<span class="function"><span class="params">d</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (d.dependenciesState === IDerivationState.UP_TO_DATE) &#123;</span><br><span class="line">      d.dependenciesState = IDerivationState.POSSIBLY_STALE</span><br><span class="line">      d.onBecomeStale()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ComputedValue</span>&lt;<span class="title">T</span>&gt; <span class="title">implements</span> <span class="title">IObservable</span>, <span class="title">IComputedValue</span>&lt;<span class="title">T</span>&gt;, <span class="title">IDerivation</span> </span>&#123;</span><br><span class="line">  onBecomeStale() &#123;</span><br><span class="line">    propagateMaybeChanged(<span class="keyword">this</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Reaction</span> <span class="title">implements</span> <span class="title">IDerivation</span>, <span class="title">IReactionPublic</span> </span>&#123;</span><br><span class="line">  onBecomeStale() &#123;</span><br><span class="line">    <span class="keyword">this</span>.schedule()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  schedule() &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>._isScheduled) &#123;</span><br><span class="line">      <span class="keyword">this</span>._isScheduled = <span class="literal">true</span></span><br><span class="line">      globalState.pendingReactions.push(<span class="keyword">this</span>)</span><br><span class="line">      runReactions()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> reactionScheduler: <span class="function">(<span class="params">fn: (</span>) =&gt;</span> <span class="keyword">void</span>) =&gt; <span class="keyword">void</span> = <span class="function"><span class="params">f</span> =&gt;</span> f()</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">runReactions</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (globalState.inBatch &gt; <span class="number">0</span> || globalState.isRunningReactions) <span class="keyword">return</span></span><br><span class="line">  reactionScheduler(runReactionsHelper)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">runReactionsHelper</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  globalState.isRunningReactions = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">const</span> allReactions = globalState.pendingReactions</span><br><span class="line">  <span class="keyword">let</span> iterations = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (allReactions.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">let</span> remainingReactions = allReactions.splice(<span class="number">0</span>)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>, l = remainingReactions.length; i &lt; l; i++)</span><br><span class="line">      remainingReactions[i].runReaction()</span><br><span class="line">  &#125;</span><br><span class="line">  globalState.isRunningReactions = <span class="literal">false</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>以上代码不但没有看见计算属性重新取值的实现，而且高度依赖于 observable 和 observer 的依赖关系和各自的状态标识，因此，我们会持有以下两个问题：</p>
<ol>
<li>reaction.runReaction 方法到底是怎样实现的？reaction 和 computedValue 又怎样相互影响？</li>
<li>mobx 怎样更新及维护 observable 和 observer 的依赖关系和状态标识？</li>
</ol>
<h4 id="runReaction"><a href="#runReaction" class="headerlink" title="runReaction"></a>runReaction</h4><p><em>图 3，reaction.runReaction 执行流程</em><br><img src="/2018/08/15/react/react相关/mobx源码分析2/runReaction.png"></p>
<p>结合上图，reaction.runReaction 针对以下两种情况作出处理：</p>
<ol>
<li>当响应式数据引起的反应内部没有计算属性时，重新执行反应的处理逻辑。</li>
<li>当响应式数据引起的反应内部有计算属性时，且计算属性观察的数据改变时，通过 computedValue 方法重新获取计算属性的值，事务（在 reaction.runReaction 方法执行过程中，使用 startBatch 函数开启）的意义在于等待计算属性的重新计算。其他情况下使用原有的值。</li>
</ol>
<p>需要留神的是，在 reaction.runReaction 方法中使用 startBatch 开启事务时，globalState.isRunningReactions 标识仍旧为真值，也就不会造成 globalState.pendingReactions 中未作处理的 reaction 被反复执行。</p>
<p><em>代码段 2，runReaction 处理流程</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Reaction</span> <span class="title">implements</span> <span class="title">IDerivation</span>, <span class="title">IReactionPublic</span> </span>&#123;</span><br><span class="line">  runReaction() &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.isDisposed) &#123;</span><br><span class="line">      startBatch()</span><br><span class="line">      <span class="keyword">this</span>._isScheduled = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">if</span> (shouldCompute(<span class="keyword">this</span>)) &#123;</span><br><span class="line">        <span class="comment">// 用户实际注册的监听函数经包装后将以 reaction.onInvalidate 形式呈现</span></span><br><span class="line">        <span class="keyword">this</span>.onInvalidate()</span><br><span class="line">      &#125;</span><br><span class="line">      endBatch()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shouldCompute</span>(<span class="params">derivation: IDerivation</span>): <span class="title">boolean</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (derivation.dependenciesState) &#123;</span><br><span class="line">    <span class="keyword">case</span> IDerivationState.UP_TO_DATE:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    <span class="keyword">case</span> IDerivationState.NOT_TRACKING:</span><br><span class="line">    <span class="keyword">case</span> IDerivationState.STALE:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    <span class="keyword">case</span> IDerivationState.POSSIBLY_STALE: &#123;</span><br><span class="line">      <span class="keyword">const</span> prevUntracked = untrackedStart()</span><br><span class="line">      <span class="keyword">const</span> obs = derivation.observing,</span><br><span class="line">        l = obs.length</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; l; i++) &#123;</span><br><span class="line">        <span class="keyword">const</span> obj = obs[i]</span><br><span class="line">        <span class="keyword">if</span> (isComputedValue(obj)) &#123;</span><br><span class="line">          obj.get()</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> ((derivation.dependenciesState <span class="keyword">as</span> any) === IDerivationState.STALE) &#123;</span><br><span class="line">            untrackedEnd(prevUntracked)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      changeDependenciesStateTo0(derivation)</span><br><span class="line">      untrackedEnd(prevUntracked)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ComputedValue</span>&lt;<span class="title">T</span>&gt; <span class="title">implements</span> <span class="title">IObservable</span>, <span class="title">IComputedValue</span>&lt;<span class="title">T</span>&gt;, <span class="title">IDerivation</span> </span>&#123;</span><br><span class="line">  public get(): T &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.keepAlive &amp;&amp; <span class="keyword">this</span>.firstGet) &#123;</span><br><span class="line">      <span class="keyword">this</span>.firstGet = <span class="literal">false</span></span><br><span class="line">      autorun(<span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">this</span>.get())</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 初始化获取绑定计算属性的依赖关系，或者在 action 中直接获取计算属性</span></span><br><span class="line">    <span class="keyword">if</span> (globalState.inBatch === <span class="number">0</span> &amp;&amp; <span class="keyword">this</span>.observers.size === <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (shouldCompute(<span class="keyword">this</span>)) &#123;</span><br><span class="line">        <span class="keyword">this</span>.warnAboutUntrackedRead()</span><br><span class="line">        startBatch()</span><br><span class="line">        <span class="keyword">this</span>.value = <span class="keyword">this</span>.computeValue(<span class="literal">false</span>)</span><br><span class="line">        endBatch()</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// reaction.runReaction 处理逻辑中，将进入第二个条件分支</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      reportObserved(<span class="keyword">this</span>)</span><br><span class="line">      <span class="keyword">if</span> (shouldCompute(<span class="keyword">this</span>)) <span class="keyword">if</span> (<span class="keyword">this</span>.trackAndCompute()) propagateChangeConfirmed(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> result = <span class="keyword">this</span>.value!</span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  computeValue(track: boolean) &#123;</span><br><span class="line">    globalState.computationDepth++</span><br><span class="line">    <span class="keyword">let</span> res: T | CaughtException</span><br><span class="line">    <span class="keyword">if</span> (track) &#123;</span><br><span class="line">      res = trackDerivedFunction(<span class="keyword">this</span>, <span class="keyword">this</span>.derivation, <span class="keyword">this</span>.scope)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      res = <span class="keyword">this</span>.derivation.call(<span class="keyword">this</span>.scope)</span><br><span class="line">    &#125;</span><br><span class="line">    globalState.computationDepth--</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  private trackAndCompute(): boolean &#123;</span><br><span class="line">    <span class="keyword">const</span> oldValue = <span class="keyword">this</span>.value</span><br><span class="line">    <span class="keyword">const</span> wasSuspended = <span class="keyword">this</span>.dependenciesState === IDerivationState.NOT_TRACKING</span><br><span class="line">    <span class="keyword">const</span> newValue = <span class="keyword">this</span>.computeValue(<span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> changed = wasSuspended || !<span class="keyword">this</span>.equals(oldValue, newValue)</span><br><span class="line">    <span class="keyword">if</span> (changed) <span class="keyword">this</span>.value = newValue</span><br><span class="line">    <span class="keyword">return</span> changed</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">propagateChangeConfirmed</span>(<span class="params">observable: IObservable</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (observable.lowestObserverState === IDerivationState.STALE) <span class="keyword">return</span></span><br><span class="line">  observable.lowestObserverState = IDerivationState.STALE</span><br><span class="line"></span><br><span class="line">  observable.observers.forEach(<span class="function"><span class="params">d</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (d.dependenciesState === IDerivationState.POSSIBLY_STALE)</span><br><span class="line">      d.dependenciesState = IDerivationState.STALE</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">      d.dependenciesState === IDerivationState.UP_TO_DATE</span><br><span class="line">    )</span><br><span class="line">      observable.lowestObserverState = IDerivationState.UP_TO_DATE</span><br><span class="line">  &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上述代码中，对于 trackDerivedFunction 函数的处理逻辑，我将在下一小节予以分析。</p>
<h4 id="依赖更新"><a href="#依赖更新" class="headerlink" title="依赖更新"></a>依赖更新</h4><p>我们先来看一下 mobx 为 observable, observer 提供的状态值：</p>
<ol>
<li>IDerivationState.NOT_TRACKING：值为 -1，作为 derivation 的初始状态。当衍生不再订阅响应式数据时，derivation.dependenciesState 值也将被置为 NOT_TRACKING。</li>
<li>IDerivationState.UP_TO_DATE：值为 0，当响应式数据变更且衍生有执行时，derivation.dependenciesState 状态将被置为 UP_TO_DATE。</li>
<li>IDerivationState.POSSIBLY_STALE：值为 1，计算属性变更时，订阅计算属性的衍生状态将置为 POSSIBLY_STALE。若在 shouldCompute 函数执行环节，当确认计算属性的值未作变更时，derivation.dependenciesState 状态将被重置为 UP_TO_DATE；若作变更，状态将置为 STALE。</li>
<li>IDerivationState.STALE：值为 2，当衍生订阅的响应式数据或计算属性变更时，derivation.dependenciesState 状态将被置为 STALE，意味着衍生的逻辑需要重新启动。</li>
</ol>
<p><em>图 4，状态标识更新流程</em><br><img src="/2018/08/15/react/react相关/mobx源码分析2/state.png"></p>
<p>状态标识更新流程为：</p>
<ol>
<li>当初次添加 derivation 时，状态标识置为 NOT_TRACKING。</li>
<li>当响应式数据更新，监听这个响应式数据的衍生包含 reaction，则将该 reaction 的状态置为 STALE；包含 computedValue，则将该 computedValue 状态置为 STALE，并通过 computedValue.onBecameStale 方法将订阅这个计算属性的反应 reaction 的状态置为 POSSIBLY_STALE。</li>
<li>在事务 endBatch 环节，通过 reaction.runReaction 方法的执行过程刷新该 reaction 和 observable 的绑定关系，并将 reaction 的状态标识置为 NOT_TRACKING（在 reaction 用户端逻辑执行过程中，添加了新的 observable） 或 UP_TO_DATE。若 reaction 还订阅了计算属性，则调用计算属性 computedValue.get 方法，通过这个方法的执行，刷新 computedValue 和 observable 的关系，并将其状态标识置为 NOT_TRACKING 或 UP_TO_DATE。</li>
</ol>
<p>第 2 步的执行逻辑参见上文给出的 propagateChanged, propagatedMaybeChanged 函数；第 1, 3 两步均通过 trackDerivedFunction 函数实现。</p>
<p><em>代码段 3，derivation 状态更新</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">trackDerivedFunction</span>&lt;<span class="title">T</span>&gt;(<span class="params">derivation: IDerivation, f: (</span>) =&gt; <span class="title">T</span>, <span class="title">context</span>: <span class="title">any</span>) </span>&#123;</span><br><span class="line">  changeDependenciesStateTo0(derivation)</span><br><span class="line">  derivation.newObserving = <span class="keyword">new</span> <span class="built_in">Array</span>(derivation.observing.length + <span class="number">100</span>)</span><br><span class="line">  derivation.unboundDepsCount = <span class="number">0</span></span><br><span class="line">  derivation.runId = ++globalState.runId</span><br><span class="line">  <span class="keyword">const</span> prevTracking = globalState.trackingDerivation</span><br><span class="line">  globalState.trackingDerivation = derivation</span><br><span class="line">  <span class="keyword">let</span> result</span><br><span class="line">  <span class="keyword">if</span> (globalState.disableErrorBoundaries === <span class="literal">true</span>) &#123;</span><br><span class="line">    result = f.call(context)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      result = f.call(context)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      result = <span class="keyword">new</span> CaughtException(e)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  globalState.trackingDerivation = prevTracking</span><br><span class="line">  bindDependencies(derivation)</span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 刷新 derivation 和 observable 的依赖关系，并将 derivation 的状态标识置为 UP_TO_DATE 或 NOT_TRACKING</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindDependencies</span>(<span class="params">derivation: IDerivation</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> prevObserving = derivation.observing</span><br><span class="line">  <span class="keyword">const</span> observing = (derivation.observing = derivation.newObserving!)</span><br><span class="line">  <span class="keyword">let</span> lowestNewObservingDerivationState = IDerivationState.UP_TO_DATE</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> i0 = <span class="number">0</span>,</span><br><span class="line">    l = derivation.unboundDepsCount</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; l; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> dep = observing[i]</span><br><span class="line">    <span class="keyword">if</span> (dep.diffValue === <span class="number">0</span>) &#123;</span><br><span class="line">      dep.diffValue = <span class="number">1</span></span><br><span class="line">      <span class="keyword">if</span> (i0 !== i) observing[i0] = dep</span><br><span class="line">      i0++</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (((dep <span class="keyword">as</span> any) <span class="keyword">as</span> IDerivation).dependenciesState &gt; lowestNewObservingDerivationState) &#123;</span><br><span class="line">      lowestNewObservingDerivationState = ((dep <span class="keyword">as</span> any) <span class="keyword">as</span> IDerivation).dependenciesState</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  observing.length = i0</span><br><span class="line"></span><br><span class="line">  derivation.newObserving = <span class="literal">null</span></span><br><span class="line">  </span><br><span class="line">  l = prevObserving.length</span><br><span class="line">  <span class="keyword">while</span> (l--) &#123;</span><br><span class="line">    <span class="keyword">const</span> dep = prevObserving[l]</span><br><span class="line">    <span class="keyword">if</span> (dep.diffValue === <span class="number">0</span>) &#123;</span><br><span class="line">      removeObserver(dep, derivation)</span><br><span class="line">    &#125;</span><br><span class="line">    dep.diffValue = <span class="number">0</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (i0--) &#123;</span><br><span class="line">    <span class="keyword">const</span> dep = observing[i0]</span><br><span class="line">    <span class="keyword">if</span> (dep.diffValue === <span class="number">1</span>) &#123;</span><br><span class="line">      dep.diffValue = <span class="number">0</span></span><br><span class="line">      addObserver(dep, derivation)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 对于新添加的观察数据，将 derivation 添加 globalState.pendingReactions 中，在当前事务周期中处理</span></span><br><span class="line">  <span class="keyword">if</span> (lowestNewObservingDerivationState !== IDerivationState.UP_TO_DATE) &#123;</span><br><span class="line">    derivation.dependenciesState = lowestNewObservingDerivationState</span><br><span class="line">    derivation.onBecomeStale()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">changeDependenciesStateTo0</span>(<span class="params">derivation: IDerivation</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (derivation.dependenciesState === IDerivationState.UP_TO_DATE) <span class="keyword">return</span></span><br><span class="line">  derivation.dependenciesState = IDerivationState.UP_TO_DATE</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> obs = derivation.observing</span><br><span class="line">  <span class="keyword">let</span> i = obs.length</span><br><span class="line">  <span class="keyword">while</span> (i--) obs[i].lowestObserverState = IDerivationState.UP_TO_DATE</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>trackDerivedFunction 函数在 mobx 中的实际调用过程：</p>
<ol>
<li>Reaction 构造函数提供了 track 实例方法。该实例方法执行过程中，将 trackDerivedFunction 函数更新 derivation 的状态和依赖关系，同时执行传参 fn 函数。实际在构造 Reaction 过程中，用户端执行逻辑将经由 autorun 函数使用 reaction.track 封装后构成 reaction.onInvalidate 方法，该方法将在 reaction.runReaction 执行过程中得到调用，而用户端执行逻辑也将作为 reaction.track 方法的参数 fn。这样就解释了响应式数据变更时，既会处理用户端执行逻辑，如使视图重绘，又会促使 reaction 的状态值得到更新。</li>
<li>ComputedValue 构造函数提供的 computeValue 实例方法，也会调用 trackDerivedFunction 函数。而 computedValue.get 实例方法将间接调用 computeValue 方法，从而使计算属性的状态得到更新。</li>
</ol>
<p><em>代码段 4，trackDerivedFunction 实际调用，只限于 reaction</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Reaction</span> <span class="title">implements</span> <span class="title">IDerivation</span>, <span class="title">IReactionPublic</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(</span><br><span class="line">    public name: string = "Reaction@" + getNextId(),</span><br><span class="line">    private onInvalidate: () =&gt; void,</span><br><span class="line">    private errorHandler?: (error: any, derivation: IDerivation) =&gt; void</span><br><span class="line">  ) &#123; &#125;</span><br><span class="line"></span><br><span class="line">  runReaction() &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.isDisposed) &#123;</span><br><span class="line">      startBatch()</span><br><span class="line">      <span class="keyword">this</span>._isScheduled = <span class="literal">false</span></span><br><span class="line">      <span class="keyword">if</span> (shouldCompute(<span class="keyword">this</span>)) &#123;</span><br><span class="line">        <span class="comment">// 用户实际注册的监听函数经包装后将以 reaction.onInvalidate 形式呈现</span></span><br><span class="line">        <span class="keyword">this</span>.onInvalidate()</span><br><span class="line">      &#125;</span><br><span class="line">      endBatch()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  track(fn: <span class="function"><span class="params">()</span> =&gt;</span> <span class="keyword">void</span>) &#123;</span><br><span class="line">    startBatch()</span><br><span class="line">    <span class="keyword">this</span>._isRunning = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">const</span> result = trackDerivedFunction(<span class="keyword">this</span>, fn, <span class="literal">undefined</span>)</span><br><span class="line">    <span class="keyword">this</span>._isRunning = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">this</span>._isTrackPending = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.isDisposed) &#123;</span><br><span class="line">      clearObserving(<span class="keyword">this</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    endBatch()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">autorun</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  view: (r: IReactionPublic</span>) =&gt; <span class="title">any</span>,</span></span><br><span class="line"><span class="function">  <span class="title">opts</span>: <span class="title">IAutorunOptions</span> = <span class="title">EMPTY_OBJECT</span></span></span><br><span class="line"><span class="function">): <span class="title">IReactionDisposer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> name: string = (opts &amp;&amp; opts.name) || (view <span class="keyword">as</span> any).name || <span class="string">"Autorun@"</span> + getNextId()</span><br><span class="line">  <span class="keyword">let</span> reaction: Reaction</span><br><span class="line"></span><br><span class="line">  reaction = <span class="keyword">new</span> Reaction(</span><br><span class="line">    name,</span><br><span class="line">    <span class="function"><span class="keyword">function</span> (<span class="params">this: Reaction</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">this</span>.track(reactionRunner)</span><br><span class="line">    &#125;,</span><br><span class="line">    opts.onError</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">reactionRunner</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    view(reaction)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 初始化绑定 reaction 和 observable 的依赖关系，并调用用户端执行逻辑 view</span></span><br><span class="line">  reaction.schedule()</span><br><span class="line">  <span class="keyword">return</span> reaction.getDisposer()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="接口层"><a href="#接口层" class="headerlink" title="接口层"></a>接口层</h2><p>接口层的主要目的是将用户端执行逻辑在响应式数据变更后自动得到调用。</p>
<h3 id="autoRun"><a href="#autoRun" class="headerlink" title="autoRun"></a>autoRun</h3><p>autoRun 函数的处理流程为：构建 Reaction 实例；初始化调用 reaction.schedule 方法，初次调用用户端执行逻辑 ，绑定 observer 和 observable 的依赖关系；使用 reaction.track 包装用户端执行逻辑，在响应式数据变更后，既负责更新 observer 和 observable 的依赖关系，又负责调用用户端执行逻辑。用户端执行逻辑通常表现为视图变更，因此也被标识为 view 函数。</p>
<p>在调用 autoRun 时，可以通过选项 opts.delay 或 opts.scheduler 调度 view 的执行时机。</p>
<p>完整代码如下：</p>
<p><em>代码段 5，autoRun 函数</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">autorun</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  view: (r: IReactionPublic</span>) =&gt; <span class="title">any</span>,</span></span><br><span class="line"><span class="function">  <span class="title">opts</span>: <span class="title">IAutorunOptions</span> = <span class="title">EMPTY_OBJECT</span></span></span><br><span class="line"><span class="function">): <span class="title">IReactionDisposer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> name: string = (opts &amp;&amp; opts.name) || (view <span class="keyword">as</span> any).name || <span class="string">"Autorun@"</span> + getNextId()</span><br><span class="line">  <span class="keyword">const</span> runSync = !opts.scheduler &amp;&amp; !opts.delay</span><br><span class="line">  <span class="keyword">let</span> reaction: Reaction</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (runSync) &#123;</span><br><span class="line">    reaction = <span class="keyword">new</span> Reaction(</span><br><span class="line">      name,</span><br><span class="line">      <span class="function"><span class="keyword">function</span> (<span class="params">this: Reaction</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.track(reactionRunner)</span><br><span class="line">      &#125;,</span><br><span class="line">      opts.onError</span><br><span class="line">    )</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> scheduler = createSchedulerFromOptions(opts)</span><br><span class="line">    <span class="keyword">let</span> isScheduled = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    reaction = <span class="keyword">new</span> Reaction(</span><br><span class="line">      name,</span><br><span class="line">      () =&gt; &#123;</span><br><span class="line">        <span class="keyword">if</span> (!isScheduled) &#123;</span><br><span class="line">          isScheduled = <span class="literal">true</span></span><br><span class="line">          scheduler(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">            isScheduled = <span class="literal">false</span></span><br><span class="line">            <span class="keyword">if</span> (!reaction.isDisposed) reaction.track(reactionRunner)</span><br><span class="line">          &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      opts.onError</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">reactionRunner</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    view(reaction)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  reaction.schedule()</span><br><span class="line">  <span class="keyword">return</span> reaction.getDisposer()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createSchedulerFromOptions</span>(<span class="params">opts: IReactionOptions</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> opts.scheduler</span><br><span class="line">    ? opts.scheduler</span><br><span class="line">    : opts.delay</span><br><span class="line">      ? <span class="function">(<span class="params">f: Lambda</span>) =&gt;</span> setTimeout(f, opts.delay!)</span><br><span class="line">      : run</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="reaction"><a href="#reaction" class="headerlink" title="reaction"></a>reaction</h3><p>reaction 函数的处理基本同 autoRun，其主要区别是，用户端执行逻辑表现为当首参计算函数返回的终值发生改变时，执行次参副作用逻辑。</p>
<p><em>代码段 6，reaction 函数</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">reaction</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  expression: (r: IReactionPublic</span>) =&gt; <span class="title">T</span>,</span></span><br><span class="line"><span class="function">  <span class="title">effect</span>: (<span class="params">arg: T, r: IReactionPublic</span>) =&gt; <span class="title">void</span>,</span></span><br><span class="line"><span class="function">  <span class="title">opts</span>: <span class="title">IReactionOptions</span> = <span class="title">EMPTY_OBJECT</span></span></span><br><span class="line"><span class="function">): <span class="title">IReactionDisposer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> name = opts.name || <span class="string">"Reaction@"</span> + getNextId()</span><br><span class="line">  <span class="keyword">const</span> effectAction = action(</span><br><span class="line">    name,</span><br><span class="line">    opts.onError ? wrapErrorHandler(opts.onError, effect) : effect</span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">const</span> runSync = !opts.scheduler &amp;&amp; !opts.delay</span><br><span class="line">  <span class="keyword">const</span> scheduler = createSchedulerFromOptions(opts)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> firstTime = <span class="literal">true</span></span><br><span class="line">  <span class="keyword">let</span> isScheduled = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> value: T</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> equals = (opts <span class="keyword">as</span> any).compareStructural</span><br><span class="line">    ? comparer.structural</span><br><span class="line">    : opts.equals || comparer.default</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> r = <span class="keyword">new</span> Reaction(</span><br><span class="line">    name,</span><br><span class="line">    () =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (firstTime || runSync) &#123;</span><br><span class="line">        reactionRunner()</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!isScheduled) &#123;</span><br><span class="line">        isScheduled = <span class="literal">true</span></span><br><span class="line">        scheduler!(reactionRunner)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    opts.onError</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">reactionRunner</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    isScheduled = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">if</span> (r.isDisposed) <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">let</span> changed = <span class="literal">false</span></span><br><span class="line">    r.track(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> nextValue = expression(r)</span><br><span class="line">      changed = firstTime || !equals(value, nextValue)</span><br><span class="line">      value = nextValue</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> (firstTime &amp;&amp; opts.fireImmediately!) effectAction(value, r)</span><br><span class="line">    <span class="keyword">if</span> (!firstTime &amp;&amp; (changed <span class="keyword">as</span> boolean) === <span class="literal">true</span>) effectAction(value, r)</span><br><span class="line">    <span class="keyword">if</span> (firstTime) firstTime = <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  r.schedule()</span><br><span class="line">  <span class="keyword">return</span> r.getDisposer()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="when"><a href="#when" class="headerlink" title="when"></a>when</h3><p>when 函数的意义是在满足特定条件下，以动作 action 形式执行副作用函数，其实现内部调用了 autoRun 函数。when 函数分为同步版本和异步版本两个。并且，随着响应式数据的变更满足了特定的条件，在副作用函数执行之前，reactin 实例将被销毁，因此副作用函数将只执行一次。</p>
<p><em>代码段 7，reaction 函数</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">when</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  predicate: (</span>) =&gt; <span class="title">boolean</span>,</span></span><br><span class="line"><span class="function">  <span class="title">opts</span>?: <span class="title">IWhenOptions</span></span></span><br><span class="line"><span class="function">): <span class="title">Promise</span>&lt;<span class="title">void</span>&gt; &amp; </span>&#123; cancel(): <span class="keyword">void</span> &#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">when</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  predicate: (</span>) =&gt; <span class="title">boolean</span>,</span></span><br><span class="line"><span class="function">  <span class="title">effect</span>: <span class="title">Lambda</span>,</span></span><br><span class="line"><span class="function">  <span class="title">opts</span>?: <span class="title">IWhenOptions</span></span></span><br><span class="line"><span class="function">): <span class="title">IReactionDisposer</span></span></span><br><span class="line"><span class="function"><span class="title">function</span> <span class="title">when</span>(<span class="params">predicate: any, arg1?: any, arg2?: any</span>): <span class="title">any</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">arguments</span>.length === <span class="number">1</span> || (arg1 &amp;&amp; <span class="keyword">typeof</span> arg1 === <span class="string">"object"</span>))</span><br><span class="line">    <span class="keyword">return</span> whenPromise(predicate, arg1)</span><br><span class="line">  <span class="keyword">return</span> _when(predicate, arg1, arg2 || &#123;&#125;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">_when</span>(<span class="params">predicate: (</span>) =&gt; <span class="title">boolean</span>, <span class="title">effect</span>: <span class="title">Lambda</span>, <span class="title">opts</span>: <span class="title">IWhenOptions</span>): <span class="title">IReactionDisposer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> timeoutHandle: any</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> opts.timeout === <span class="string">"number"</span>) &#123;</span><br><span class="line">    timeoutHandle = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!disposer[$mobx].isDisposed) &#123;</span><br><span class="line">        disposer()</span><br><span class="line">        <span class="keyword">const</span> error = <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">"WHEN_TIMEOUT"</span>)</span><br><span class="line">        <span class="keyword">if</span> (opts.onError) opts.onError(error)</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">throw</span> error</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, opts.timeout)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  opts.name = opts.name || <span class="string">"When@"</span> + getNextId()</span><br><span class="line">  <span class="keyword">const</span> effectAction = createAction(opts.name + <span class="string">"-effect"</span>, effect <span class="keyword">as</span> <span class="built_in">Function</span>)</span><br><span class="line">  <span class="keyword">const</span> disposer = autorun(<span class="function"><span class="params">r</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (predicate()) &#123;</span><br><span class="line">      r.dispose()</span><br><span class="line">      <span class="keyword">if</span> (timeoutHandle) clearTimeout(timeoutHandle)</span><br><span class="line">      effectAction()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, opts)</span><br><span class="line">  <span class="keyword">return</span> disposer</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">whenPromise</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  predicate: (</span>) =&gt; <span class="title">boolean</span>,</span></span><br><span class="line"><span class="function">  <span class="title">opts</span>?: <span class="title">IWhenOptions</span></span></span><br><span class="line"><span class="function">): <span class="title">Promise</span>&lt;<span class="title">void</span>&gt; &amp; </span>&#123; cancel(): <span class="keyword">void</span> &#125; &#123;</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">"production"</span> &amp;&amp; opts &amp;&amp; opts.onError)</span><br><span class="line">    <span class="keyword">return</span> fail(<span class="string">`the options 'onError' and 'promise' cannot be combined`</span>)</span><br><span class="line">  <span class="keyword">let</span> cancel</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> disposer = _when(predicate, resolve, &#123; ...opts, <span class="attr">onError</span>: reject &#125;)</span><br><span class="line">    cancel = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      disposer()</span><br><span class="line">      reject(<span class="string">"WHEN_CANCELLED"</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line">    ; (res <span class="keyword">as</span> any).cancel = cancel</span><br><span class="line">  <span class="keyword">return</span> res <span class="keyword">as</span> any</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>mobx 是一个十分严谨的类库，这两篇文章点到的内容最多也不过十之六七。感兴趣的读者可以自行翻阅源码，想必能发现额外的矿藏，比如错误处理、信息追踪等。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/03/react/react相关/mobx源码分析1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/03/react/react相关/mobx源码分析1/" itemprop="url">mobx源码分析（一） 构造响应式数据</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-03T00:00:00+08:00">2018-08-03</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/状态管理/" itemprop="url" rel="index"><span itemprop="name">状态管理</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/08/03/react/react相关/mobx源码分析1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/08/03/react/react相关/mobx源码分析1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="思想实验"><a href="#思想实验" class="headerlink" title="思想实验"></a>思想实验</h2><p>在开篇之初，我们先作一番思想实验。借助于形象化思维，通过类比的方式，那样会更容易理解 mobx 的实现。</p>
<p>视线折回到明代，水患侵扰了淳安县境，治理地方水务的官员把这情况上报给知县海瑞，海瑞又上报总督胡宗宪，而胡宗宪呢，他派出快马，向京师呈报奏章，吁请内阁早日筹备赈灾的粮食。与此同时，东厂番子早已把眼线布满全国，不等内阁向嘉靖奏报，嘉靖早已知晓了千里之外的动向。当我们把这环节牵涉到的各级官员设想为收发消息的节点，再把东厂番子设想为全局的监听器，我们就可以据此绘出一张图谱。</p>
<p><em>图 1，明代行政流程图抽象</em><br><img src="/2018/08/03/react/react相关/mobx源码分析1/monitor.png"></p>
<p>即如图谱中所见，node 负责接收消息 message，触发相应的动作 listener，再把消息传递给上层节点的同时，又会把消息传递给全局监听器 monitor，由 monitor 触发 reaction 行为。reaction 行为在现实表现中，往往是命令 node 节点再执行额外的动作，因此，在 node 节点向 monitor 呈报消息的时候，也会携带当前 node 节点的信息。</p>
<p>由此我们类比到 mobx 的实现，绘制出如下图谱：</p>
<p><em>图 2，mobx 工作流程</em><br><img src="/2018/08/03/react/react相关/mobx源码分析1/mobx-monitor.png"></p>
<p>上图中，观察对象 observable 身兼一种能力，即在数据变更前，会触发 interceptor 拦截函数的执行；在数据变更后，会触发 listener 监听函数的执行，同时将数据变更的信息上报给全局监听器。在全局监听器中，startBatch, endBatch 用于开启、结束事务。事务执行过程中，将统计哪些观察者 observer 所观察的数据发生了变更、需要重新执行；在事务的尾端（endBatch 过程中），通过 runAction 方法调用这些观察者的实际处理逻辑。</p>
<p>思考以上 mobx 的工作流程，我们需要探索的问题是：</p>
<ol>
<li>怎样将数据转变成 observable？当数据变更时，observable 又怎样驱动 interceptor, listener 的执行，并上报给全局监听器？</li>
<li>怎样使 observer 订阅 observable？在数据变更的时候，使得相应的观察者 observer 执行其处理逻辑？</li>
</ol>
<p>这篇文章致力于对问题 1 加以解答。对于问题 2，将在下一篇文章加以解答。</p>
<h2 id="响应式数据"><a href="#响应式数据" class="headerlink" title="响应式数据"></a>响应式数据</h2><p>如果数据赋值这一动作委托给某函数处理，我们可以借助 AOP 编程思想，在该函数的执行过程中，添加一些附加操作，如上报变更信息、启用回调函数、或者触发指定事件等。正因为如此，Vue 才得以通过 Object.defineProperty 方法实现双向数据绑定；React 才得以通过 setState 方法引起组件重绘。mobx 融合了两种处理手法。首先，mobx 基于原始数据构建出 observable 实例，在 observable 实例方法变更数据的过程中，将执行 interceptor, listener, reportChanged 等附加操作，这一机制如同 React 内建的 setState 方法在变更组件状态的同时，还能驱动组件重绘。其次，mobx 通过 Object.defineProperty 方法将原始数据（对象形式）的赋值、取值动作委托给 observable 实例方法加以处理，使得原始数据的赋值动作转变成响应式的、取值动作又能获得原始数据内容，这一过程同 Vue 那样使用了 Object.defineProperty 方法。</p>
<p>mobx 能将如下几种数据类型转变为 observable 实例：ObservableValue 实例作为代理，能将基本数据类型的赋值动作转变成响应式；ObservableObjectAdministration 实例能处理对象；ObservableArrayAdministration 实例能处理数组；ObservableMap 实例能处理 map 数据结构。</p>
<p><em>图 3，observable 实例基本</em><br><img src="/2018/08/03/react/react相关/mobx源码分析1/observable.png"></p>
<p>与此同时，mobx 使用 enhancer 递归地将层级较深的数据内容转变成上述四种 observable 实例，使得原始数据的子属性及元素（表现为数组、对象或 map）都具备响应式赋值能力。</p>
<p><em>图 4，enhancer 机制基本</em><br><img src="/2018/08/03/react/react相关/mobx源码分析1/enhancer.png"></p>
<h3 id="ObservableValue"><a href="#ObservableValue" class="headerlink" title="ObservableValue"></a>ObservableValue</h3><p><em>代码段 1，ObservableValue 的部分实例方法</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">public set(newValue: T) &#123;</span><br><span class="line">  <span class="keyword">const</span> oldValue = <span class="keyword">this</span>.value</span><br><span class="line">  newValue = <span class="keyword">this</span>.prepareNewValue(newValue) <span class="keyword">as</span> any</span><br><span class="line">  <span class="keyword">if</span> (newValue !== UNCHANGED) &#123;</span><br><span class="line">    <span class="keyword">const</span> notifySpy = isSpyEnabled()</span><br><span class="line">    <span class="keyword">if</span> (notifySpy &amp;&amp; process.env.NODE_ENV !== <span class="string">"production"</span>) &#123;</span><br><span class="line">        spyReportStart(&#123;</span><br><span class="line">            type: <span class="string">"update"</span>,</span><br><span class="line">            name: <span class="keyword">this</span>.name,</span><br><span class="line">            newValue,</span><br><span class="line">            oldValue</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">this</span>.setNewValue(newValue)</span><br><span class="line">    <span class="keyword">if</span> (notifySpy &amp;&amp; process.env.NODE_ENV !== <span class="string">"production"</span>) spyReportEnd()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private prepareNewValue(newValue): T | IUNCHANGED &#123;</span><br><span class="line">  <span class="comment">// 计算属性获取过程不允许变更响应式数据，严格模式下只能通过 action 改变响应式数据（即状态）</span></span><br><span class="line">  checkIfStateModificationsAreAllowed(<span class="keyword">this</span>)</span><br><span class="line">  <span class="keyword">if</span> (hasInterceptors(<span class="keyword">this</span>)) &#123;</span><br><span class="line">      <span class="keyword">const</span> change = interceptChange&lt;IValueWillChange&lt;T&gt;&gt;(<span class="keyword">this</span>, &#123;</span><br><span class="line">          object: <span class="keyword">this</span>,</span><br><span class="line">          type: <span class="string">"update"</span>,</span><br><span class="line">          newValue</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="keyword">if</span> (!change) <span class="keyword">return</span> UNCHANGED</span><br><span class="line">      newValue = change.newValue</span><br><span class="line">  &#125;</span><br><span class="line">  newValue = <span class="keyword">this</span>.enhancer(newValue, <span class="keyword">this</span>.value, <span class="keyword">this</span>.name)</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.value !== newValue ? newValue : UNCHANGED</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">setNewValue(newValue: T) &#123;</span><br><span class="line">  <span class="keyword">const</span> oldValue = <span class="keyword">this</span>.value</span><br><span class="line">  <span class="keyword">this</span>.value = newValue</span><br><span class="line">  <span class="keyword">this</span>.reportChanged()</span><br><span class="line">  <span class="keyword">if</span> (hasListeners(<span class="keyword">this</span>)) &#123;</span><br><span class="line">    notifyListeners(<span class="keyword">this</span>, &#123;</span><br><span class="line">        type: <span class="string">"update"</span>,</span><br><span class="line">        object: <span class="keyword">this</span>,</span><br><span class="line">        newValue,</span><br><span class="line">        oldValue</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">public get(): T &#123;</span><br><span class="line">  <span class="keyword">this</span>.reportObserved()</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.dehanceValue(<span class="keyword">this</span>.value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过以上代码，我们也能看出，ObservableValue 实例的 set 方法具有四种智能职能：开发环境下，在数据变更前后，触发 spyListener 间谍监听器的执行（可用于添加日志）；数据变更前，校验变更的合理性，如计算属性获得过程中不允许作数据变更、严格模式下不允许在 action 外作数据变更；同样在数据变更前，调用 interceptor 拦截器，拦截器可用于打断数据变更的动作；数据变更后，通过 reportChanged 方法将数据变更信息上报到全局监听器，并触发 listener 监听函数的执行。</p>
<p>其中，interceptor, listener 均挂载为 ObservableValue 实例的属性，因此，interceptChange, notifyListeners 以 ObservableValue 实例作为其入参，用于查找待执行的 interceptor, listener。</p>
<p>reportChanged 方法执行过程中，将把当前的 ObservableValue 标识为脏值，并驱动相应的 observer（同样挂载为 ObservableValue 实例的属性）执行其处理逻辑。在 mobx 的实现中，观察者 observer 并不需要感知自己观察的 observable 实例作了哪些变更，而只要知晓 observable 已经作了数据变更，observer 就需要执行其处理逻辑。因此，只要 observer 观察的 observable 实例颗粒度足够细，就能使 observer 基于确凿的数据变更，发起相应的响应式处理流程。这部分内容，散见于下文。</p>
<p>有了上述逻辑实现后，基本数据类型就可以把赋值动作委托给 observableValue.set 方法加以处理，以获得响应式变更数据内容的能力。</p>
<p>enhancer 用于将数据内容转变成 observable 实例，既能用于递归地处理复杂的数据结构，又能适应 js 弱类型语言的特征。比如，当把数据内容从基本数据类型切换成对象时，enhancer 就能使得对象属性的赋值动作也具有响应式效果。enhancer 分为两类，其一作为构造函数的参数，其二作为实例方法。</p>
<h3 id="ObservableObjectAdministration"><a href="#ObservableObjectAdministration" class="headerlink" title="ObservableObjectAdministration"></a>ObservableObjectAdministration</h3><p>不同于基本数据类型的全量更新，对象单次只更新一个属性。因此，ObservableValue 实例与原始数据的关系较为直接，原始数据的读写动作可直接委托给 observableValue.set, observableValue.get 方法加以处理，呈单一的线条形状；ObservableObjectAdministration 实例和原始数据就显得比较复杂，需要通过属性作桥接，按属性呈多线条形状。无论 ObservableObjectAdministration 实例提供的 read, write, addObservableProp, addComputedProp 都在属性级别。顾名思义，read, write 方法用于针对属性的读写操作，addObservableProp 用于添加可观察属性，addComputedProp 用于添加计算属性。</p>
<p>除此而外，ObservableValue 实例不会改变原始数据 value 的读写过程，而只能通过显式调用 observableValue.set 方法唤起响应式操作。ObservableObjectAdministration 实例可通过 Object.defineProperty 方法影响原始数据的读写。使用了 Object.defineProperty 方法后，读取 target 属性，都将委托给 observableObjectAdministration.read, observableObjectAdministration.write 方法去处理，从而使原始数据的读写过程变成响应式。</p>
<p>在 ObservableObjectAdministration 构造函数的实现内部，仰赖于 ObservableValue, ComputedValue 构造函数，因为其子属性既可能是 ObservableValue 可观察数据，ComputedValue 计算属性，又可能是没有响应式特征的普通数据。</p>
<p><em>代码段 2，ObservableObjectAdministration 的部分实例方法</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line">read(key: string) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.values.get(key)!.get()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">write(key: string, newValue) &#123;</span><br><span class="line">  <span class="keyword">const</span> instance = <span class="keyword">this</span>.target</span><br><span class="line">  <span class="keyword">const</span> observable = <span class="keyword">this</span>.values.get(key)</span><br><span class="line">  <span class="comment">// 变更计算属性，予以报错处理，</span></span><br><span class="line">  <span class="keyword">if</span> (observable <span class="keyword">instanceof</span> ComputedValue) &#123;</span><br><span class="line">    observable.set(newValue)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (hasInterceptors(<span class="keyword">this</span>)) &#123;</span><br><span class="line">    <span class="keyword">const</span> change = interceptChange&lt;IObjectWillChange&gt;(<span class="keyword">this</span>, &#123;</span><br><span class="line">      type: <span class="string">"update"</span>,</span><br><span class="line">      object: <span class="keyword">this</span>.proxy || instance,</span><br><span class="line">      name: key,</span><br><span class="line">      newValue</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> (!change) <span class="keyword">return</span></span><br><span class="line">    newValue = (change <span class="keyword">as</span> any).newValue</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// 触发 ObservableValue 实例的 interceptor 拦截器, 通过 observableValue.enhance 获取终值</span></span><br><span class="line">  newValue = (observable <span class="keyword">as</span> any).prepareNewValue(newValue)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (newValue !== UNCHANGED) &#123;</span><br><span class="line">    <span class="keyword">const</span> notify = hasListeners(<span class="keyword">this</span>)</span><br><span class="line">    <span class="keyword">const</span> notifySpy = isSpyEnabled()</span><br><span class="line">    <span class="keyword">const</span> change =</span><br><span class="line">      notify || notifySpy</span><br><span class="line">        ? &#123;</span><br><span class="line">          type: <span class="string">"update"</span>,</span><br><span class="line">          object: <span class="keyword">this</span>.proxy || instance,</span><br><span class="line">          oldValue: (observable <span class="keyword">as</span> any).value,</span><br><span class="line">          name: key,</span><br><span class="line">          newValue</span><br><span class="line">        &#125;</span><br><span class="line">        : <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (notifySpy &amp;&amp; process.env.NODE_ENV !== <span class="string">"production"</span>)</span><br><span class="line">      spyReportStart(&#123; ...change, <span class="attr">name</span>: <span class="keyword">this</span>.name, key &#125;)</span><br><span class="line">        <span class="comment">// 触发 ObservableValue 实例的 listener 订阅函数，并调用 observableValue.reportChanged 上报变更</span></span><br><span class="line">        ; (observable <span class="keyword">as</span> ObservableValue&lt;any&gt;).setNewValue(newValue)</span><br><span class="line">    <span class="keyword">if</span> (notify) notifyListeners(<span class="keyword">this</span>, change)</span><br><span class="line">    <span class="keyword">if</span> (notifySpy &amp;&amp; process.env.NODE_ENV !== <span class="string">"production"</span>) spyReportEnd()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">addObservableProp(propName: string, newValue, <span class="attr">enhancer</span>: IEnhancer&lt;any&gt; = <span class="keyword">this</span>.defaultEnhancer) &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; target &#125; = <span class="keyword">this</span></span><br><span class="line">  <span class="comment">// 校验 target 对象 propName 是否具有 configurable, writable 可能</span></span><br><span class="line">  assertPropertyConfigurable(target, propName)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (hasInterceptors(<span class="keyword">this</span>)) &#123;</span><br><span class="line">    <span class="keyword">const</span> change = interceptChange&lt;IObjectWillChange&gt;(<span class="keyword">this</span>, &#123;</span><br><span class="line">      object: <span class="keyword">this</span>.proxy || target,</span><br><span class="line">      name: propName,</span><br><span class="line">      type: <span class="string">"add"</span>,</span><br><span class="line">      newValue</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> (!change) <span class="keyword">return</span></span><br><span class="line">    newValue = (change <span class="keyword">as</span> any).newValue</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> observable = <span class="keyword">new</span> ObservableValue(</span><br><span class="line">    newValue,</span><br><span class="line">    enhancer,</span><br><span class="line">    <span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span>.<span class="subst">$&#123;propName&#125;</span>`</span>,</span><br><span class="line">    <span class="literal">false</span></span><br><span class="line">  )</span><br><span class="line">  <span class="keyword">this</span>.values.set(propName, observable)</span><br><span class="line">  newValue = (observable <span class="keyword">as</span> any).value <span class="comment">// observableValue might have changed it</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">Object</span>.defineProperty(target, propName, generateObservablePropConfig(propName))</span><br><span class="line">  <span class="keyword">this</span>.notifyPropertyAddition(propName, newValue)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">notifyPropertyAddition(key: string, newValue) &#123;</span><br><span class="line">  <span class="keyword">const</span> notify = hasListeners(<span class="keyword">this</span>)</span><br><span class="line">  <span class="keyword">const</span> notifySpy = isSpyEnabled()</span><br><span class="line">  <span class="keyword">const</span> change =</span><br><span class="line">    notify || notifySpy</span><br><span class="line">      ? &#123;</span><br><span class="line">        type: <span class="string">"add"</span>,</span><br><span class="line">        object: <span class="keyword">this</span>.proxy || <span class="keyword">this</span>.target,</span><br><span class="line">        name: key,</span><br><span class="line">        newValue</span><br><span class="line">      &#125;</span><br><span class="line">      : <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (notifySpy &amp;&amp; process.env.NODE_ENV !== <span class="string">"production"</span>)</span><br><span class="line">    spyReportStart(&#123; ...change, <span class="attr">name</span>: <span class="keyword">this</span>.name, key &#125;)</span><br><span class="line">  <span class="keyword">if</span> (notify) notifyListeners(<span class="keyword">this</span>, change)</span><br><span class="line">  <span class="keyword">if</span> (notifySpy &amp;&amp; process.env.NODE_ENV !== <span class="string">"production"</span>) spyReportEnd()</span><br><span class="line">  <span class="keyword">this</span>.keysAtom.reportChanged()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过以上代码，可以看出，observableObjectAdministration.write 方法将依次调用挂载在 ObservableValue, ObservableObjectAdministration 实例上的 interceptor 拦截器和 listener 订阅函数，又通过 observableValue.reportChanged 上报给全局监听器，触发相应的观察者 observer 执行其处理逻辑。在这里，作为属性值的 observableValue 实例颗粒度更细，通过 observableValue.reportChanged 上报给全局监听器，将能使观察者 observer 对更细微的数据变动做出响应。为什么 observableObjectAdministration 没有实现 reportChanged 方法呢？因为，基于 enhancer，observableValue 所处理的数据有可能就是一个 observableObjectAdministration 实例，由 observableValue 处理上报动作是可行的。</p>
<p>observableObjectAdministration.addObservableProp 方法用于添加可观察属性。在该方法的内部实现中，既通过创建新的 ObservableValue 实例将属性变更上报给全局监听器，又通过 keysAtom 属性（Atom 实例）上报给全局监听器。前者使观察属性变更的 observer 作出响应，后者用于使观察属性集合的 observer 作出响应。同 Vue，mobx 在取值时设定观察者 observer 和可观察数据 observable 的依赖关系，通过 reportObserved 方法刷新依赖；在赋值时将可观察数据 observable 标识为脏值，观察者 observer 需要执行其处理逻辑。因此，单有 reportChanged 并不触发响应式动作，那时还没有一个观察者需要基于变更的数据作出响应（或者理解为没有观察者订阅变更的数据）；只有 reportObserved, reportChanged，观察者 observer 才会执行其处理逻辑。</p>
<p><em>图 5，ObservableObjectAdministration 工作流程</em><br><img src="/2018/08/03/react/react相关/mobx源码分析1/observable-object-admin.png"></p>
<h3 id="ObservableArrayAdministration"><a href="#ObservableArrayAdministration" class="headerlink" title="ObservableArrayAdministration"></a>ObservableArrayAdministration</h3><p>对于数组，与 Vue 相同，mobx 需要使数组的原型方法也具有响应式操作的能力。不同于 Vue 直接改写数组的实例方法，mobx 使用了 es6 中 Proxy 语法。通过 Proxy 代理器，mobx 将对数组项的读取操作、push 等方法移交给 arrayExtensions 集合处理。因此，ObservableArrayAdministration 构造函数不同于 ObservableObjectAdministration，部分可以在 ObservableArrayAdministration 构造函数中实现的实例方法最终会在 arrayExtensions 对象中实现。</p>
<p><em>代码段 3，ObservableArrayAdministration 的部分实例方法</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">spliceWithArray(index: number, deleteCount?: number, newItems?: any[]): any[] &#123;</span><br><span class="line">  checkIfStateModificationsAreAllowed(<span class="keyword">this</span>.atom)</span><br><span class="line">  <span class="keyword">const</span> length = <span class="keyword">this</span>.values.length</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (index === <span class="literal">undefined</span>) index = <span class="number">0</span></span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (index &gt; length) index = length</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (index &lt; <span class="number">0</span>) index = <span class="built_in">Math</span>.max(<span class="number">0</span>, length + index)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">arguments</span>.length === <span class="number">1</span>) deleteCount = length - index</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (deleteCount === <span class="literal">undefined</span> || deleteCount === <span class="literal">null</span>) deleteCount = <span class="number">0</span></span><br><span class="line">  <span class="keyword">else</span> deleteCount = <span class="built_in">Math</span>.max(<span class="number">0</span>, <span class="built_in">Math</span>.min(deleteCount, length - index))</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (newItems === <span class="literal">undefined</span>) newItems = EMPTY_ARRAY</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (hasInterceptors(<span class="keyword">this</span>)) &#123;</span><br><span class="line">      <span class="keyword">const</span> change = interceptChange&lt;IArrayWillSplice&lt;any&gt;&gt;(<span class="keyword">this</span> <span class="keyword">as</span> any, &#123;</span><br><span class="line">          object: <span class="keyword">this</span>.proxy <span class="keyword">as</span> any,</span><br><span class="line">          type: <span class="string">"splice"</span>,</span><br><span class="line">          index,</span><br><span class="line">          removedCount: deleteCount,</span><br><span class="line">          added: newItems</span><br><span class="line">      &#125;)</span><br><span class="line">      <span class="keyword">if</span> (!change) <span class="keyword">return</span> EMPTY_ARRAY</span><br><span class="line">      deleteCount = change.removedCount</span><br><span class="line">      newItems = change.added</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  newItems = newItems.length === <span class="number">0</span> ? newItems : newItems.map(<span class="function"><span class="params">v</span> =&gt;</span> <span class="keyword">this</span>.enhancer(v, <span class="literal">undefined</span>))</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">"production"</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> lengthDelta = newItems.length - deleteCount</span><br><span class="line">      <span class="keyword">this</span>.updateArrayLength(length, lengthDelta) <span class="comment">// checks if internal array wasn't modified</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> res = <span class="keyword">this</span>.spliceItemsIntoValues(index, deleteCount, newItems)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (deleteCount !== <span class="number">0</span> || newItems.length !== <span class="number">0</span>) <span class="keyword">this</span>.notifyArraySplice(index, newItems, res)</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.dehanceValues(res)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">spliceItemsIntoValues(index, deleteCount, <span class="attr">newItems</span>: any[]): any[] &#123;</span><br><span class="line">  <span class="keyword">if</span> (newItems.length &lt; MAX_SPLICE_SIZE) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.values.splice(index, deleteCount, ...newItems)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> res = <span class="keyword">this</span>.values.slice(index, index + deleteCount)</span><br><span class="line">      <span class="keyword">this</span>.values = <span class="keyword">this</span>.values</span><br><span class="line">          .slice(<span class="number">0</span>, index)</span><br><span class="line">          .concat(newItems, <span class="keyword">this</span>.values.slice(index + deleteCount))</span><br><span class="line">      <span class="keyword">return</span> res</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">notifyArraySplice(index: number, <span class="attr">added</span>: any[], <span class="attr">removed</span>: any[]) &#123;</span><br><span class="line">  <span class="keyword">const</span> notifySpy = !<span class="keyword">this</span>.owned &amp;&amp; isSpyEnabled()</span><br><span class="line">  <span class="keyword">const</span> notify = hasListeners(<span class="keyword">this</span>)</span><br><span class="line">  <span class="keyword">const</span> change =</span><br><span class="line">      notify || notifySpy</span><br><span class="line">          ? &#123;</span><br><span class="line">                object: <span class="keyword">this</span>.proxy,</span><br><span class="line">                type: <span class="string">"splice"</span>,</span><br><span class="line">                index,</span><br><span class="line">                removed,</span><br><span class="line">                added,</span><br><span class="line">                removedCount: removed.length,</span><br><span class="line">                addedCount: added.length</span><br><span class="line">            &#125;</span><br><span class="line">          : <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (notifySpy &amp;&amp; process.env.NODE_ENV !== <span class="string">"production"</span>)</span><br><span class="line">      spyReportStart(&#123; ...change, <span class="attr">name</span>: <span class="keyword">this</span>.atom.name &#125;)</span><br><span class="line">  <span class="keyword">this</span>.atom.reportChanged()</span><br><span class="line">  <span class="keyword">if</span> (notify) notifyListeners(<span class="keyword">this</span>, change)</span><br><span class="line">  <span class="keyword">if</span> (notifySpy &amp;&amp; process.env.NODE_ENV !== <span class="string">"production"</span>) spyReportEnd()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">notifyArrayChildUpdate(index: number, <span class="attr">newValue</span>: any, <span class="attr">oldValue</span>: any) &#123;</span><br><span class="line">  <span class="keyword">const</span> notifySpy = !<span class="keyword">this</span>.owned &amp;&amp; isSpyEnabled()</span><br><span class="line">  <span class="keyword">const</span> notify = hasListeners(<span class="keyword">this</span>)</span><br><span class="line">  <span class="keyword">const</span> change =</span><br><span class="line">    notify || notifySpy</span><br><span class="line">      ? &#123;</span><br><span class="line">        object: <span class="keyword">this</span>.proxy,</span><br><span class="line">        type: <span class="string">"update"</span>,</span><br><span class="line">        index,</span><br><span class="line">        newValue,</span><br><span class="line">        oldValue</span><br><span class="line">      &#125;</span><br><span class="line">      : <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (notifySpy &amp;&amp; process.env.NODE_ENV !== <span class="string">"production"</span>)</span><br><span class="line">    spyReportStart(&#123; ...change, <span class="attr">name</span>: <span class="keyword">this</span>.atom.name &#125;)</span><br><span class="line">  <span class="keyword">this</span>.atom.reportChanged()</span><br><span class="line">  <span class="keyword">if</span> (notify) notifyListeners(<span class="keyword">this</span>, change)</span><br><span class="line">  <span class="keyword">if</span> (notifySpy &amp;&amp; process.env.NODE_ENV !== <span class="string">"production"</span>) spyReportEnd()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过以上代码，可以看出，ObservableArrayAdministration 构造函数只提供了 spliceWithArray 实例方法，用于一次性变更数组项及数组的长度。在这一过程中，同样会调用挂载在 observableArrayAdministration 实例中的 interceptor, listener，以及通过 reportChanged 方法将变更信息上报给全局监听器。</p>
<p>不同于 observableArrayAdministration 实例中变更数据的子属性由 observableValue 实例构成；observableArrayAdministration 实例中变更的数组项直接通过 enhancer 处理成 observable 实例。因为对于数组，观察者只订阅单个数组项变更的情况较少，不像对象需要监控每个属性的变更，两者监控的颗粒度不一样，前者就使用 enhancer 构造 observable 实例，后者通过 ObservableValue 构造 observable 实例。</p>
<p><em>代码段4，arrayExtensions 对象含有的方法</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> arrayExtensions = &#123;</span><br><span class="line">  clear(): any[] &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.splice(<span class="number">0</span>)</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  replace(newItems: any[]) &#123;</span><br><span class="line">    <span class="keyword">const</span> adm: ObservableArrayAdministration = <span class="keyword">this</span>[$mobx]</span><br><span class="line">    <span class="keyword">return</span> adm.spliceWithArray(<span class="number">0</span>, adm.values.length, newItems)</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  splice(index: number, deleteCount?: number, ...newItems: any[]): any[] &#123;</span><br><span class="line">    <span class="keyword">const</span> adm: ObservableArrayAdministration = <span class="keyword">this</span>[$mobx]</span><br><span class="line">    <span class="keyword">switch</span> (<span class="built_in">arguments</span>.length) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">return</span> []</span><br><span class="line">      <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        <span class="keyword">return</span> adm.spliceWithArray(index)</span><br><span class="line">      <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        <span class="keyword">return</span> adm.spliceWithArray(index, deleteCount)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> adm.spliceWithArray(index, deleteCount, newItems)</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  spliceWithArray(index: number, deleteCount?: number, newItems?: any[]): any[] &#123;</span><br><span class="line">    <span class="keyword">const</span> adm: ObservableArrayAdministration = <span class="keyword">this</span>[$mobx]</span><br><span class="line">    <span class="keyword">return</span> adm.spliceWithArray(index, deleteCount, newItems)</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  push(...items: any[]): number &#123;</span><br><span class="line">    <span class="keyword">const</span> adm: ObservableArrayAdministration = <span class="keyword">this</span>[$mobx]</span><br><span class="line">    adm.spliceWithArray(adm.values.length, <span class="number">0</span>, items)</span><br><span class="line">    <span class="keyword">return</span> adm.values.length</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  pop() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.splice(<span class="built_in">Math</span>.max(<span class="keyword">this</span>[$mobx].values.length - <span class="number">1</span>, <span class="number">0</span>), <span class="number">1</span>)[<span class="number">0</span>]</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  shift() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.splice(<span class="number">0</span>, <span class="number">1</span>)[<span class="number">0</span>]</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  unshift(...items: any[]): number &#123;</span><br><span class="line">    <span class="keyword">const</span> adm = <span class="keyword">this</span>[$mobx]</span><br><span class="line">    adm.spliceWithArray(<span class="number">0</span>, <span class="number">0</span>, items)</span><br><span class="line">    <span class="keyword">return</span> adm.values.length</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  reverse(): any[] &#123;</span><br><span class="line">    <span class="comment">// 开发环境提示用户 reverse 方法不会改变观察数据的内容</span></span><br><span class="line">    <span class="keyword">const</span> clone = (<span class="xml"><span class="tag">&lt;<span class="name">any</span>&gt;</span>this).slice()</span></span><br><span class="line"><span class="xml">    return clone.reverse.apply(clone, arguments)</span></span><br><span class="line"><span class="xml">  &#125;,</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  sort(compareFn?: (a: any, b: any) =&gt; number): any[] &#123;</span></span><br><span class="line"><span class="xml">    // 开发环境提示用户 sort 方法不会改变观察数据的内容</span></span><br><span class="line">    const clone = (&lt;any&gt;this).slice()</span><br><span class="line">    return clone.sort.apply(clone, arguments)</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  remove(value: any): boolean &#123;</span><br><span class="line">    const adm: ObservableArrayAdministration = this[$mobx]</span><br><span class="line">    const idx = adm.dehanceValues(adm.values).indexOf(value)</span><br><span class="line">    if (idx &gt; -1) &#123;</span><br><span class="line">      this.splice(idx, 1)</span><br><span class="line">      return true</span><br><span class="line">    &#125;</span><br><span class="line">    return false</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  get(index: number): any | undefined &#123;</span><br><span class="line">    const adm: ObservableArrayAdministration = this[$mobx]</span><br><span class="line">    if (adm) &#123;</span><br><span class="line">      if (index &lt; adm.values.length) &#123;</span><br><span class="line">        adm.atom.reportObserved()</span><br><span class="line">        return adm.dehanceValue(adm.values[index])</span><br><span class="line">      &#125;</span><br><span class="line">      // 提示用户超过数组长度</span><br><span class="line">    &#125;</span><br><span class="line">    return undefined</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  set(index: number, newValue: any) &#123;</span><br><span class="line">    const adm: ObservableArrayAdministration = this[$mobx]</span><br><span class="line">    const values = adm.values</span><br><span class="line">    if (index &lt; values.length) &#123;</span><br><span class="line">      checkIfStateModificationsAreAllowed(adm.atom)</span><br><span class="line">      const oldValue = values[index]</span><br><span class="line">      if (hasInterceptors(adm)) &#123;</span><br><span class="line">        const change = interceptChange&lt;IArrayWillChange&lt;any&gt;&gt;(adm as any, &#123;</span><br><span class="line">          type: "update",</span><br><span class="line">          object: this as any,</span><br><span class="line">          index,</span><br><span class="line">          newValue</span><br><span class="line">        &#125;)</span><br><span class="line">        if (!change) return</span><br><span class="line">        newValue = change.newValue</span><br><span class="line">      &#125;</span><br><span class="line">      newValue = adm.enhancer(newValue, oldValue)</span><br><span class="line">      const changed = newValue !== oldValue</span><br><span class="line">      if (changed) &#123;</span><br><span class="line">        values[index] = newValue</span><br><span class="line">        adm.notifyArrayChildUpdate(index, newValue, oldValue)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; else if (index === values.length) &#123;</span><br><span class="line">      adm.spliceWithArray(index, 0, [newValue])</span><br><span class="line">    &#125; else &#123;</span><br><span class="line">      // 超过数组长度，报错处理</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">[</span><br><span class="line">  "every",</span><br><span class="line">  "filter",</span><br><span class="line">  "forEach",</span><br><span class="line">  "indexOf",</span><br><span class="line">  "join",</span><br><span class="line">  "lastIndexOf",</span><br><span class="line">  "map",</span><br><span class="line">  "reduce",</span><br><span class="line">  "reduceRight",</span><br><span class="line">  "slice",</span><br><span class="line">  "some",</span><br><span class="line">  "toString",</span><br><span class="line">  "toLocaleString"</span><br><span class="line">].forEach(funcName =&gt; &#123;</span><br><span class="line">  arrayExtensions[funcName] = function () &#123;</span><br><span class="line">    const adm: ObservableArrayAdministration = this[$mobx]</span><br><span class="line">    adm.atom.reportObserved()</span><br><span class="line">    const res = adm.dehanceValues(adm.values)</span><br><span class="line">    return res[funcName].apply(res, arguments)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure></p>
<p>可以看出，arrayExtensions 对象封装了数组的原型方法，便于通过 Proxy 语法构建代理，为原始数据提供响应式的数组操作。在 mobx 中，创建原始数组的代理通过 createObservableArray 函数实现。源码如下：</p>
<p><em>代码段 5，为数组创建代理</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createObservableArray</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  initialValues: any[] | undefined,</span></span></span><br><span class="line"><span class="function"><span class="params">  enhancer: IEnhancer&lt;T&gt;,</span></span></span><br><span class="line"><span class="function"><span class="params">  name = <span class="string">"ObservableArray@"</span> + getNextId(</span>),</span></span><br><span class="line"><span class="function">  <span class="title">owned</span> = <span class="title">false</span></span></span><br><span class="line"><span class="function">): <span class="title">IObservableArray</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> adm = <span class="keyword">new</span> ObservableArrayAdministration(name, enhancer, owned)</span><br><span class="line">  addHiddenFinalProp(adm.values, $mobx, adm)</span><br><span class="line">  <span class="keyword">const</span> proxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(adm.values, arrayTraps) <span class="keyword">as</span> any</span><br><span class="line">  adm.proxy = proxy</span><br><span class="line">  <span class="keyword">if</span> (initialValues &amp;&amp; initialValues.length) &#123;</span><br><span class="line">    <span class="keyword">const</span> prev = allowStateChangesStart(<span class="literal">true</span>)</span><br><span class="line">    adm.spliceWithArray(<span class="number">0</span>, <span class="number">0</span>, initialValues)</span><br><span class="line">    allowStateChangesEnd(prev)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> proxy</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> arrayTraps = &#123;</span><br><span class="line">  get(target, name) &#123;</span><br><span class="line">    <span class="keyword">if</span> (name === $mobx) <span class="keyword">return</span> target[$mobx]</span><br><span class="line">    <span class="keyword">if</span> (name === <span class="string">"length"</span>) <span class="keyword">return</span> target[$mobx].getArrayLength()</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> name === <span class="string">"number"</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> arrayExtensions.get.call(target, name)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> name === <span class="string">"string"</span> &amp;&amp; !<span class="built_in">isNaN</span>(name <span class="keyword">as</span> any)) &#123;</span><br><span class="line">      <span class="keyword">return</span> arrayExtensions.get.call(target, <span class="built_in">parseInt</span>(name))</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (arrayExtensions.hasOwnProperty(name)) &#123;</span><br><span class="line">      <span class="keyword">return</span> arrayExtensions[name]</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> target[name]</span><br><span class="line">  &#125;,</span><br><span class="line">  set(target, name, value): boolean &#123;</span><br><span class="line">    <span class="keyword">if</span> (name === <span class="string">"length"</span>) &#123;</span><br><span class="line">      target[$mobx].setArrayLength(value)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> name === <span class="string">"number"</span>) &#123;</span><br><span class="line">      arrayExtensions.set.call(target, name, value)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="built_in">isNaN</span>(name)) &#123;</span><br><span class="line">      arrayExtensions.set.call(target, <span class="built_in">parseInt</span>(name), value)</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;,</span><br><span class="line">  preventExtensions(target) &#123;</span><br><span class="line">    fail(<span class="string">`Observable arrays cannot be frozen`</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过创建代理对象，mobx 数组的处理效果就等同使用 Object.defineProperty 方法处理后的对象，赋值呈现响应式，取值获得更新后的值。</p>
<h3 id="ObservableMap"><a href="#ObservableMap" class="headerlink" title="ObservableMap"></a>ObservableMap</h3><p>mobx 介入对象处理的着眼点是属性，而对于 map 数据结构，其着眼点在于实例方法 set, get, has 等。因此，ObservableMap 与 ObservableArrayAdminstriation 处理上有相似的地方，都是对原始数据提供代理对象。在 ObservableArrayAdminstriation 的实现中，真正的代理对象需要在 createObservableArray 函数执行环节才能创建出 proxy 实例，而 ObservableMap 实例即是原始 map 结构的代理。</p>
<p><em>代码段 6，ObservableMap 的部分实例方法</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">has(key: K): boolean &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>._hasMap.has(key)) <span class="keyword">return</span> <span class="keyword">this</span>._hasMap.get(key)!.get()</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>._updateHasMapEntry(key, <span class="literal">false</span>).get()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">set(key: K, <span class="attr">value</span>: V) &#123;</span><br><span class="line">  <span class="keyword">const</span> hasKey = <span class="keyword">this</span>._has(key)</span><br><span class="line">  <span class="keyword">if</span> (hasInterceptors(<span class="keyword">this</span>)) &#123;</span><br><span class="line">    <span class="keyword">const</span> change = interceptChange&lt;IMapWillChange&lt;K, V&gt;&gt;(<span class="keyword">this</span>, &#123;</span><br><span class="line">      type: hasKey ? <span class="string">"update"</span> : <span class="string">"add"</span>,</span><br><span class="line">      object: <span class="keyword">this</span>,</span><br><span class="line">      newValue: value,</span><br><span class="line">      name: key</span><br><span class="line">    &#125;)</span><br><span class="line">    <span class="keyword">if</span> (!change) <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">    value = change.newValue!</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (hasKey) &#123;</span><br><span class="line">    <span class="keyword">this</span>._updateValue(key, value)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>._addValue(key, value)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private _updateHasMapEntry(key: K, <span class="attr">value</span>: boolean): ObservableValue&lt;boolean&gt; &#123;</span><br><span class="line">  <span class="keyword">let</span> entry = <span class="keyword">this</span>._hasMap.get(key)</span><br><span class="line">  <span class="keyword">if</span> (entry) &#123;</span><br><span class="line">    entry.setNewValue(value)</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    entry = <span class="keyword">new</span> ObservableValue(value, referenceEnhancer, <span class="string">`<span class="subst">$&#123;<span class="keyword">this</span>.name&#125;</span>.<span class="subst">$&#123;key&#125;</span>?`</span>, <span class="literal">false</span>)</span><br><span class="line">    <span class="keyword">this</span>._hasMap.set(key, entry)</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> entry</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private _updateValue(key: K, <span class="attr">newValue</span>: V | <span class="literal">undefined</span>) &#123;</span><br><span class="line">  <span class="keyword">const</span> observable = <span class="keyword">this</span>._data.get(key)!</span><br><span class="line">  newValue = (observable <span class="keyword">as</span> any).prepareNewValue(newValue) <span class="keyword">as</span> V</span><br><span class="line">  <span class="keyword">if</span> (newValue !== UNCHANGED) &#123;</span><br><span class="line">    <span class="keyword">const</span> notifySpy = isSpyEnabled()</span><br><span class="line">    <span class="keyword">const</span> notify = hasListeners(<span class="keyword">this</span>)</span><br><span class="line">    <span class="keyword">const</span> change =</span><br><span class="line">      notify || notifySpy</span><br><span class="line">        ? &lt;IMapDidChange&lt;K, V&gt;&gt;&#123;</span><br><span class="line">          type: "update",</span><br><span class="line">          object: this,</span><br><span class="line">          oldValue: (observable as any).value,</span><br><span class="line">          name: key,</span><br><span class="line">          newValue</span><br><span class="line">        &#125;</span><br><span class="line">        : null</span><br><span class="line">    if (notifySpy &amp;&amp; process.env.NODE_ENV !== "production")</span><br><span class="line">      spyReportStart(&#123; ...change, name: this.name, key &#125;)</span><br><span class="line">    observable.setNewValue(newValue as V)</span><br><span class="line">    if (notify) notifyListeners(this, change)</span><br><span class="line">    if (notifySpy &amp;&amp; process.env.NODE_ENV !== "production") spyReportEnd()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">private _addValue(key: K, newValue: V) &#123;</span><br><span class="line">  checkIfStateModificationsAreAllowed(this._keysAtom)</span><br><span class="line">  transaction(() =&gt; &#123;</span><br><span class="line">    const observable = new ObservableValue(</span><br><span class="line">      newValue,</span><br><span class="line">      this.enhancer,</span><br><span class="line">      `$&#123;this.name&#125;.$&#123;key&#125;`,</span><br><span class="line">      false</span><br><span class="line">    )</span><br><span class="line">    this._data.set(key, observable)</span><br><span class="line">    newValue = (observable as any).value // value might have been changed</span><br><span class="line">    this._updateHasMapEntry(key, true)</span><br><span class="line">    this._keysAtom.reportChanged()</span><br><span class="line">  &#125;)</span><br><span class="line">  const notifySpy = isSpyEnabled()</span><br><span class="line">  const notify = hasListeners(this)</span><br><span class="line">  const change =</span><br><span class="line">    notify || notifySpy</span><br><span class="line">      ? &lt;IMapDidChange&lt;K, V&gt;&gt;&#123;</span><br><span class="line">        type: "add",</span><br><span class="line">        object: this,</span><br><span class="line">        name: key,</span><br><span class="line">        newValue</span><br><span class="line">      &#125;</span><br><span class="line">      : null</span><br><span class="line">  if (notifySpy &amp;&amp; process.env.NODE_ENV !== "production")</span><br><span class="line">    spyReportStart(&#123; ...change, name: this.name, key &#125;)</span><br><span class="line">  if (notify) notifyListeners(this, change)</span><br><span class="line">  if (notifySpy &amp;&amp; process.env.NODE_ENV !== "production") spyReportEnd()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上述代码中，除了常规的 interceptChange, notifyListeners, spyReportStart, spyReportEnd 以外，mobx 构建了两个 observable 实例集合，其一是 this._hasMap（由 ObservableValue 实例构成），其二是 this._data（由 enhancer 构建的 observable 实例构成）。其中，this._hasMap 用于协助 map.has 方法的响应式特征，其实际存储的值也是布尔类型；this._data 用于协助 map.set 方法的响应式特征，其存储的就是用户设置的数据。这两个 observable 实例集合可能同时会通过 reportChanged 方法上报数据变更（this.keysAtom 也会上报 map 集合所有的 key 键变化），因此在代码的组织中，ObservableMap 构造函数使用了 mobx 内置的 tansaction 函数，用于在多次数据变更信息上报时协调事务，只有在最后一次数据上报时，才执行观察者 observer 的处理逻辑。</p>
<h2 id="接口层"><a href="#接口层" class="headerlink" title="接口层"></a>接口层</h2><p><em>图 6，observable 接口层处理流程</em><br><img src="/2018/08/03/react/react相关/mobx源码分析1/observable-interface.png"></p>
<p>结合上图和前文，可得出 mobx 接口层的一些处理逻辑：</p>
<ol>
<li>对于普通数据、map 数据结构的处理即是直接生成 ObservableValue, ObservableMap 实例。</li>
<li>对于数组，则通过 createObservableArray 创建 Proxy 代理实例，该代理实例的方法体中将调用 ObservableArrayAdminstrition 实例的响应式操作。</li>
<li>对于对象，则分为两种情况，当 options.proxy 为否值，只生成 ObservableObjectAdminstrition，再通过装饰器插入计算属性或可观察属性；当 options.proxy 为真值，创建 Proxy 代理实例，同样的，该代理实例的方法体中将调用 ObservableObjectAdminstrition 实例的响应式操作，再通过装饰器插入计算属性或可观察属性。</li>
<li>以上3点之外，mobx 通过 enhancer 决定对深层数据结构的处理操作，如 observable.deep 装饰器使用 deepEnhancer 增强器，将数据的深层结构统统转换为 observable 实例（默认操作）；observable.shallow 装饰器使用 shallowEnhancer 增强器，只将数据的首层转换为 observable 实例；observable.ref 装饰器使用 referenceEnhancer 增强器，不会将数据转换为 observable 实例（除非新值就是个 observable 实例）；observable.struct 装饰器使用 refStructEnhancer 增强器，同样不会将数据转换为 observable 实例，与 referenceEnhancer 区别是，当数据未作变更时，refStructEnhancer 将以引用对象形式返回原始数据，而不是值相同的新数据。</li>
</ol>
<p>值得说明的是，mobx 处理对象时会批量添加计算属性或可观察属性，所以实现中使用 startBatch, endBatch 开启事务，使观察者的处理逻辑只执行一次。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/08/react/react相关/react-redux源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/08/react/react相关/react-redux源码分析/" itemprop="url">react-redux源码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-08T00:00:00+08:00">2018-07-08</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/状态管理/" itemprop="url" rel="index"><span itemprop="name">状态管理</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/08/react/react相关/react-redux源码分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/07/08/react/react相关/react-redux源码分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>react-redux 类库的意义是将 redux 状态注入到组件中，且在状态更新时驱动组件重绘。在这个类库的设计和实现上，需要面临两个问题：如何将 store 中缓存的状态注入到组件中；在状态更新时，如何驱动组件重绘。</p>
<p>对于第一个问题，react-redux 解决手法也极为简单且常见。通过顶层 Provider 容器接受 store 作为 props，再将 store 作为 context 内容传入子孙组件；在用户端实际消费状态的组件（自定义组件）外层构造直属父级容器（HOC 高阶组件），由直属父级容器将通过 context.store 属性获取的状态数据输入为自定义组件的 props。</p>
<p>对于第二个问题，react-redux 解决手法是：通过 store.subscribe 方法注册状态变更后待执行的回调函数 listener，在该回调函数执行直属父级容器的 forceUpdate 或 setState 方法，重新计算注入自定义组件的 props 数据，由此重绘自定义组件。在这个过程中，无论 store 中的状态数据作何种更新，均会触发 listener 回调的执行，因而实现上有一个优化性能的关键点，即怎样使组件在指定状态更新时启用重绘机制。这一优化点通过重新计算注入自定义组件的 props 实现。在 react-redux 源码中，重新计算 props 数据由 selector 筛选器完成。除此以外，react-redux 还有另一处优化：为减少 listener 的数量，当某个 HOC 组件的重绘机制（在 redux 源码中，表现为该 HOC 组件的 onStateChange 方法）已挂载为 listener 时，其下子孙容器（同样是 HOC 组件）的重绘机制将在这个 listener 的函数体中实现。</p>
<p><em>图 1，react-redux 执行流程</em><br><img src="/2018/07/08/react/react相关/react-redux源码分析/react-redux.png"></p>
<p><em>图 1</em> 中，store, action, listener 概念来自于 redux，可参见<a href="http://xzfyu.com/2018/07/08/react/react%E7%9B%B8%E5%85%B3/redux%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90/" target="_blank" rel="noopener">react源码分析</a>；context 用于为子孙组件传入数据，概念来自于 react；Provider 作为顶层容器，由 react-redux 提供；Component，实际为自定义组件的直属父级容器，由 react-redux 提供；selector 是 react-redux 机制中将state、dispatch 和 boundAction 转化为自定义组件所需的 props 的筛选器。</p>
<h2 id="selector"><a href="#selector" class="headerlink" title="selector"></a>selector</h2><p>selector 筛选器注入组件的 props 有两种：store 中存储的状态值、驱动状态值变更的方法 boundAction（包含 store.dispatch 方法）。这两份数据分别通过用户配置项 mapStateToProps, mapDispatchToProps 获得，再由用户配置的 mergeProps = (stateProps, dispatchProps, ownProps) =&gt; props 获取注入组件的 props（ownProps 是由父组件注入自定义组件的 props）。</p>
<p>主要处理流程：</p>
<ol>
<li>采用泛职责链模式处理用户配置项 mapStateToProps, mapDispatchToProps 的多态特征（配置项类型可能为函数、对象或 undefined），转换成 mapStateToProps = (state, ownProps) =&gt; stateProps, mapDispatchToProps = (dispatch, ownProps) =&gt; dispatchProps。链式处理参数多态的手法值得借鉴。</li>
<li>mapStateToProps, mapDispatchToProps 经由 wrapMapToPropsConstant, wrapMapToPropsFunc 函数封装为 initSelector = (dispatch, options) =&gt; sourceSelector 函数（在源码中，initSelector 函数实际表现为 connect/wrapMapToProps 模块中的 initConstantSelector, initProxySelector 函数，作归一化处理需要）。initSelector 的参数 dispatch 由组件传入。sourceSelector 为 (stateOrDispatch, ownProps?) =&gt; props 函数形式，返回值为 stateProps, dispatchProps，参数同样由组件注入（与 dispatch 不同的是，参数 state 是动态的），用于获取 stateProps, dispatchProps。封装的意义，就是将 selector 筛选器从组件中独立出来。</li>
<li>将前两步的处理逻辑复合为 mapStateToPropsFactory = mapStateToProps =&gt; initSelector, mapDispatchToPropsFactory = mapDispatchToProps =&gt; initSelector，可在构建父级直属容器时直接使用。返回值 initSelector = (dispatch, options) =&gt; stateOrDispatchSelector 通过父级指数容器获得入参 store.dispatch，并生成 stateOrDispatchSelector = (stateOrDispatch, ownProps) =&gt; props 。stateOrDispatchSelector 用于获得注入组件的 props，在源码中实际表现为 mapStateToPropsProxy, mapdispatchToPropsSelector。</li>
<li>stateOrDispatchSelector 由 selectorFctory 函数调用，并在 selectorFctory 函数体内通过 mergeProps 将 stateProps, dispatchProps 复合成待传入组件的 props（mergeProps 的多态特征也经过链式处理）。selectorFctory 函数的特殊意义是，如果 state 或 ownProps 未作更改，沿用缓存的 stateProps, dispatchProps，以提升性能。</li>
</ol>
<p><em>图 2，selector 总体执行流程</em><br><img src="/2018/07/08/react/react相关/react-redux源码分析/selector.png"></p>
<h3 id="mapToPropsFactory"><a href="#mapToPropsFactory" class="headerlink" title="mapToPropsFactory"></a>mapToPropsFactory</h3><p>mapToPropsFactory 包含 mapStateToPropsFactory, mapDispatchToPropsFactory，这里只概述 mapDispatchToPropsFactory 的处理流程。mapStateToPropsFactory 实现同 mapDispatchToPropsFactory。</p>
<p><em>图 3，mapToPropsFactory 执行流程</em><br><img src="/2018/07/08/react/react相关/react-redux源码分析/mapToPropsFactory.png"></p>
<p><em>代码段 1，mapToPropsFactory</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// connect/mapDispatchToProps</span></span><br><span class="line"><span class="keyword">import</span> &#123; bindActionCreators &#125; <span class="keyword">from</span> <span class="string">'redux'</span></span><br><span class="line"><span class="keyword">import</span> &#123; wrapMapToPropsConstant, wrapMapToPropsFunc &#125; <span class="keyword">from</span> <span class="string">'./wrapMapToProps'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">whenMapDispatchToPropsIsFunction</span>(<span class="params">mapDispatchToProps</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">typeof</span> mapDispatchToProps === <span class="string">'function'</span>)</span><br><span class="line">    ? wrapMapToPropsFunc(mapDispatchToProps, <span class="string">'mapDispatchToProps'</span>)</span><br><span class="line">    : <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">whenMapDispatchToPropsIsMissing</span>(<span class="params">mapDispatchToProps</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (!mapDispatchToProps)</span><br><span class="line">    ? wrapMapToPropsConstant(<span class="function"><span class="params">dispatch</span> =&gt;</span> (&#123; dispatch &#125;))</span><br><span class="line">    : <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">whenMapDispatchToPropsIsObject</span>(<span class="params">mapDispatchToProps</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (mapDispatchToProps &amp;&amp; <span class="keyword">typeof</span> mapDispatchToProps === <span class="string">'object'</span>)</span><br><span class="line">    ? wrapMapToPropsConstant(<span class="function"><span class="params">dispatch</span> =&gt;</span> bindActionCreators(mapDispatchToProps, dispatch))</span><br><span class="line">    : <span class="literal">undefined</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> [</span><br><span class="line">  whenMapDispatchToPropsIsFunction,</span><br><span class="line">  whenMapDispatchToPropsIsMissing,</span><br><span class="line">  whenMapDispatchToPropsIsObject</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"><span class="comment">// connect/wrapMapToProps</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">wrapMapToPropsConstant</span>(<span class="params">getConstant</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">initConstantSelector</span>(<span class="params">dispatch, options</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> constant = getConstant(dispatch, options)</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">constantSelector</span>(<span class="params"></span>) </span>&#123; <span class="keyword">return</span> constant &#125;</span><br><span class="line">    constantSelector.dependsOnOwnProps = <span class="literal">false</span> </span><br><span class="line">    <span class="keyword">return</span> constantSelector</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">  </span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">wrapMapToPropsFunc</span>(<span class="params">mapToProps, methodName</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">initProxySelector</span>(<span class="params">dispatch, &#123; displayName &#125;</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> proxy = <span class="function"><span class="keyword">function</span> <span class="title">mapToPropsProxy</span>(<span class="params">stateOrDispatch, ownProps</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> proxy.dependsOnOwnProps</span><br><span class="line">        ? proxy.mapToProps(stateOrDispatch, ownProps)</span><br><span class="line">        : proxy.mapToProps(stateOrDispatch)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    proxy.dependsOnOwnProps = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    proxy.mapToProps = <span class="function"><span class="keyword">function</span> <span class="title">detectFactoryAndVerify</span>(<span class="params">stateOrDispatch, ownProps</span>) </span>&#123;</span><br><span class="line">      proxy.mapToProps = mapToProps</span><br><span class="line">      <span class="comment">// getDependsOnOwnProps 判断 mapToProps 是否依赖于父组件传入的 props</span></span><br><span class="line">      <span class="comment">//    通过 mapToProps.dependsOnOwnProps 属性进行判断</span></span><br><span class="line">      proxy.dependsOnOwnProps = getDependsOnOwnProps(mapToProps)</span><br><span class="line">      <span class="keyword">let</span> props = proxy(stateOrDispatch, ownProps)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> props === <span class="string">'function'</span>) &#123;</span><br><span class="line">        proxy.mapToProps = props</span><br><span class="line">        proxy.dependsOnOwnProps = getDependsOnOwnProps(props)</span><br><span class="line">        props = proxy(stateOrDispatch, ownProps)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> props</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> proxy</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><em>代码段 1</em> 中，wrapMapToPropsFunc 函数的写法相当有趣。如果想使用 ownProps 的某个方法决定当前组件需要 store 中的哪些状态值，首先需设定 mapStateToProps.dependsOnOwnProps 为真值，其次用户配置的 mapDispatchToProps 函数须以 ownProps 的那个方法作为返回值，该返回值将构成新的 mapDispatchToProps 函数，用于计算 dispatchProps。在源码编写上，react-redux 采用在函数执行过程中改变函数指向，两次调用自身的方式实现。以 proxy 字样命名函数也值得借鉴，因为 mapToPropsProxy 函数与 mapToProps 功能相同。</p>
<h4 id="mergeProps"><a href="#mergeProps" class="headerlink" title="mergeProps"></a>mergeProps</h4><p>mergeProps 处理流程可以参见上文，其意义是针对复杂的应用场景，能设置更灵活的 props 获取方式。</p>
<p><em>代码段 2，mergeProps 机制，mergePropsProxy 实现参看源码，与 mapToPropsFactory 相似</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// connect/selectorFactory</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">impureFinalPropsSelectorFactory</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  mapStateToProps,</span></span></span><br><span class="line"><span class="function"><span class="params">  mapDispatchToProps,</span></span></span><br><span class="line"><span class="function"><span class="params">  mergeProps,</span></span></span><br><span class="line"><span class="function"><span class="params">  dispatch</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">impureFinalPropsSelector</span>(<span class="params">state, ownProps</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> mergeProps(</span><br><span class="line">      mapStateToProps(state, ownProps),</span><br><span class="line">      mapDispatchToProps(dispatch, ownProps),</span><br><span class="line">      ownProps</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">pureFinalPropsSelectorFactory</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  mapStateToProps,</span></span></span><br><span class="line"><span class="function"><span class="params">  mapDispatchToProps,</span></span></span><br><span class="line"><span class="function"><span class="params">  mergeProps,</span></span></span><br><span class="line"><span class="function"><span class="params">  dispatch,</span></span></span><br><span class="line"><span class="function"><span class="params">  &#123; areStatesEqual, areOwnPropsEqual, areStatePropsEqual &#125;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> hasRunAtLeastOnce = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">let</span> state</span><br><span class="line">  <span class="keyword">let</span> ownProps</span><br><span class="line">  <span class="keyword">let</span> stateProps</span><br><span class="line">  <span class="keyword">let</span> dispatchProps</span><br><span class="line">  <span class="keyword">let</span> mergedProps</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleFirstCall</span>(<span class="params">firstState, firstOwnProps</span>) </span>&#123;</span><br><span class="line">    state = firstState</span><br><span class="line">    ownProps = firstOwnProps</span><br><span class="line">    stateProps = mapStateToProps(state, ownProps)</span><br><span class="line">    dispatchProps = mapDispatchToProps(dispatch, ownProps)</span><br><span class="line">    mergedProps = mergeProps(stateProps, dispatchProps, ownProps)</span><br><span class="line">    hasRunAtLeastOnce = <span class="literal">true</span></span><br><span class="line">    <span class="keyword">return</span> mergedProps</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleNewPropsAndNewState</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    stateProps = mapStateToProps(state, ownProps)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mapDispatchToProps.dependsOnOwnProps)</span><br><span class="line">      dispatchProps = mapDispatchToProps(dispatch, ownProps)</span><br><span class="line"></span><br><span class="line">    mergedProps = mergeProps(stateProps, dispatchProps, ownProps)</span><br><span class="line">    <span class="keyword">return</span> mergedProps</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleNewProps</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (mapStateToProps.dependsOnOwnProps)</span><br><span class="line">      stateProps = mapStateToProps(state, ownProps)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (mapDispatchToProps.dependsOnOwnProps)</span><br><span class="line">      dispatchProps = mapDispatchToProps(dispatch, ownProps)</span><br><span class="line"></span><br><span class="line">    mergedProps = mergeProps(stateProps, dispatchProps, ownProps)</span><br><span class="line">    <span class="keyword">return</span> mergedProps</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleNewState</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> nextStateProps = mapStateToProps(state, ownProps)</span><br><span class="line">    <span class="keyword">const</span> statePropsChanged = !areStatePropsEqual(nextStateProps, stateProps)</span><br><span class="line">    stateProps = nextStateProps</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (statePropsChanged)</span><br><span class="line">      mergedProps = mergeProps(stateProps, dispatchProps, ownProps)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> mergedProps</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleSubsequentCalls</span>(<span class="params">nextState, nextOwnProps</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> propsChanged = !areOwnPropsEqual(nextOwnProps, ownProps)</span><br><span class="line">    <span class="keyword">const</span> stateChanged = !areStatesEqual(nextState, state)</span><br><span class="line">    state = nextState</span><br><span class="line">    ownProps = nextOwnProps</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (propsChanged &amp;&amp; stateChanged) <span class="keyword">return</span> handleNewPropsAndNewState()</span><br><span class="line">    <span class="keyword">if</span> (propsChanged) <span class="keyword">return</span> handleNewProps()</span><br><span class="line">    <span class="keyword">if</span> (stateChanged) <span class="keyword">return</span> handleNewState()</span><br><span class="line">    <span class="keyword">return</span> mergedProps</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">pureFinalPropsSelector</span>(<span class="params">nextState, nextOwnProps</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> hasRunAtLeastOnce</span><br><span class="line">      ? handleSubsequentCalls(nextState, nextOwnProps)</span><br><span class="line">      : handleFirstCall(nextState, nextOwnProps)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// initMapStateToProps, initMapDispatchToProps 为 _图 6_ 中的 initSelector</span></span><br><span class="line"><span class="comment">//    源码中实际表现为 wrapMapToProps 模块的 initProxySelector</span></span><br><span class="line"><span class="comment">//    通过传参 dispatch, options，获取实际可用的 mapStateToProps, mapDispatchToProps</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">finalPropsSelectorFactory</span>(<span class="params">dispatch, &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">  initMapStateToProps,</span></span></span><br><span class="line"><span class="function"><span class="params">  initMapDispatchToProps,</span></span></span><br><span class="line"><span class="function"><span class="params">  initMergeProps,</span></span></span><br><span class="line"><span class="function"><span class="params">  ...options</span></span></span><br><span class="line"><span class="function"><span class="params">&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> mapStateToProps = initMapStateToProps(dispatch, options)</span><br><span class="line">  <span class="keyword">const</span> mapDispatchToProps = initMapDispatchToProps(dispatch, options)</span><br><span class="line">  <span class="keyword">const</span> mergeProps = initMergeProps(dispatch, options)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> selectorFactory = options.pure</span><br><span class="line">    ? pureFinalPropsSelectorFactory</span><br><span class="line">    : impureFinalPropsSelectorFactory</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> selectorFactory(</span><br><span class="line">    mapStateToProps,</span><br><span class="line">    mapDispatchToProps,</span><br><span class="line">    mergeProps,</span><br><span class="line">    dispatch,</span><br><span class="line">    options</span><br><span class="line">  )</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="connect"><a href="#connect" class="headerlink" title="connect"></a>connect</h3><p>如前文所指出的，dispatch 只能通过直属父级容器获得，state 又在 listener（直属父级容器的方法）执行过程中获取，因此对于用户配置项 mapStateToProps, mapDispatchToProps, mergeProps，react-redux 通过 connect 函数构建直属父级容器的时候将其转变为 initSelector, mergeProps，并注入直属父级容器中。当直属父级容器获得 store.dispatch 时，initSelector, mergeProps 又会通过 selectorFactory 转变为最终的 sourceSelector = (state, ownProps) =&gt; props，用于获取注入自定义组件的 props（包含状态值以及驱动状态转变的方法）。</p>
<p>在上述过程中，react-redux 为了实现逻辑的灵活性，connect 通过 createConnect 函数生成，执行逻辑中所使用的 mapStateToPropsFactory, mapDispatchToPropsFactory, mergePropsFactory, selectorFactory 均为 createConnect 的入参。而 sourceSelector 又用于构建直属父级容器的 this.selector，其 run 方法用于重新计算 props，shouldComponentUpdate 属性用于判断 props 是否便能，props 属性即是注入自定义组件的 props。</p>
<p>当 state 状态变更时，直属父级容器的 onStateChange 方法将以 listener 回调形式被执行。在 onStateChange 方法体中，首先调用 selector.run 重新计算 props，若变更，调用直属父级容器的 setState 方法重绘自定义组件。同时，无论 props 变更与否，直属父级容器都会驱动其子孙组件父容器的 onStateChange 执行。</p>
<p><em>图 4，connect 执行流程，不包含驱动子孙容器 onStateChange 执行部分</em><br><img src="/2018/07/08/react/react相关/react-redux源码分析/connect.png"></p>
<p><em>代码段 3，HOC 驱动自定义组件重绘，省略 displayName 等处理</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// connect/connect.js</span></span><br><span class="line"><span class="comment">// 上文 selector 内容输出的模块</span></span><br><span class="line"><span class="keyword">import</span> defaultMapDispatchToPropsFactories <span class="keyword">from</span> <span class="string">'./mapDispatchToProps'</span></span><br><span class="line"><span class="keyword">import</span> defaultMapStateToPropsFactories <span class="keyword">from</span> <span class="string">'./mapStateToProps'</span></span><br><span class="line"><span class="keyword">import</span> defaultMergePropsFactories <span class="keyword">from</span> <span class="string">'./mergeProps'</span></span><br><span class="line"><span class="keyword">import</span> defaultSelectorFactory <span class="keyword">from</span> <span class="string">'./selectorFactory'</span></span><br><span class="line"><span class="keyword">import</span> connectAdvanced <span class="keyword">from</span> <span class="string">'../components/connectAdvanced'</span></span><br><span class="line"><span class="keyword">import</span> shallowEqual <span class="keyword">from</span> <span class="string">'../utils/shallowEqual'</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createConnect</span>(<span class="params">&#123;</span></span></span><br><span class="line"><span class="function"><span class="params">  connectHOC = connectAdvanced,</span></span></span><br><span class="line"><span class="function"><span class="params">  mapStateToPropsFactories = defaultMapStateToPropsFactories,</span></span></span><br><span class="line"><span class="function"><span class="params">  mapDispatchToPropsFactories = defaultMapDispatchToPropsFactories,</span></span></span><br><span class="line"><span class="function"><span class="params">  mergePropsFactories = defaultMergePropsFactories,</span></span></span><br><span class="line"><span class="function"><span class="params">  selectorFactory = defaultSelectorFactory</span></span></span><br><span class="line"><span class="function"><span class="params">&#125; = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">connect</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">    mapStateToProps,</span></span></span><br><span class="line"><span class="function"><span class="params">    mapDispatchToProps,</span></span></span><br><span class="line"><span class="function"><span class="params">    mergeProps,</span></span></span><br><span class="line"><span class="function"><span class="params">    &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">      pure = true,</span></span></span><br><span class="line"><span class="function"><span class="params">      areStatesEqual = strictEqual,</span></span></span><br><span class="line"><span class="function"><span class="params">      areOwnPropsEqual = shallowEqual,</span></span></span><br><span class="line"><span class="function"><span class="params">      areStatePropsEqual = shallowEqual,</span></span></span><br><span class="line"><span class="function"><span class="params">      areMergedPropsEqual = shallowEqual,</span></span></span><br><span class="line"><span class="function"><span class="params">      ...extraOptions</span></span></span><br><span class="line"><span class="function"><span class="params">    &#125; = &#123;&#125;</span></span></span><br><span class="line"><span class="function"><span class="params">  </span>) </span>&#123;</span><br><span class="line">    <span class="comment">// match 用于使用 factory 链式处理 mapToProps，以获得 initSelector = (dispatch, options) =&gt; selector</span></span><br><span class="line">    <span class="keyword">const</span> initMapStateToProps = match(mapStateToProps, mapStateToPropsFactories, <span class="string">'mapStateToProps'</span>)</span><br><span class="line">    <span class="keyword">const</span> initMapDispatchToProps = match(mapDispatchToProps, mapDispatchToPropsFactories, <span class="string">'mapDispatchToProps'</span>)</span><br><span class="line">    <span class="keyword">const</span> initMergeProps = match(mergeProps, mergePropsFactories, <span class="string">'mergeProps'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> connectHOC(selectorFactory, &#123;</span><br><span class="line">      initMapStateToProps,</span><br><span class="line">      initMapDispatchToProps,</span><br><span class="line">      initMergeProps,</span><br><span class="line">      pure,</span><br><span class="line">      areStatesEqual,</span><br><span class="line">      areOwnPropsEqual,</span><br><span class="line">      areStatePropsEqual,</span><br><span class="line">      areMergedPropsEqual,</span><br><span class="line"></span><br><span class="line">      ...extraOptions</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// components/connectAdvanced.js</span></span><br><span class="line"><span class="keyword">import</span> hoistStatics <span class="keyword">from</span> <span class="string">'hoist-non-react-statics'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> dummyState = &#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">noop</span>(<span class="params"></span>) </span>&#123;&#125;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">makeSelectorStateful</span>(<span class="params">sourceSelector, store</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> selector = &#123;</span><br><span class="line">    run: <span class="function"><span class="keyword">function</span> <span class="title">runComponentSelector</span>(<span class="params">props</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> nextProps = sourceSelector(store.getState(), props)</span><br><span class="line">        <span class="keyword">if</span> (nextProps !== selector.props || selector.error) &#123;</span><br><span class="line">          selector.shouldComponentUpdate = <span class="literal">true</span></span><br><span class="line">          selector.props = nextProps</span><br><span class="line">          selector.error = <span class="literal">null</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (error) &#123;</span><br><span class="line">        selector.shouldComponentUpdate = <span class="literal">true</span></span><br><span class="line">        selector.error = error</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> selector</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">connectAdvanced</span>(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  selectorFactory,</span></span></span><br><span class="line"><span class="function"><span class="params">  &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    storeKey = <span class="string">'store'</span></span></span></span><br><span class="line"><span class="function"><span class="params">  &#125; = &#123;&#125;</span></span></span><br><span class="line"><span class="function"><span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> subscriptionKey = storeKey + <span class="string">'Subscription'</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> contextTypes = &#123;</span><br><span class="line">    [storeKey]: storeShape,</span><br><span class="line">    <span class="comment">// 子孙容器的 onStateChange 挂载到当前父容器创建的 listener 中，用于减少 listener 的数量</span></span><br><span class="line">    [subscriptionKey]: subscriptionShape,</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> childContextTypes = &#123;</span><br><span class="line">    [subscriptionKey]: subscriptionShape,</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">wrapWithConnect</span>(<span class="params">WrappedComponent</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Connect</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">      <span class="keyword">constructor</span>(props, context) &#123;</span><br><span class="line">        <span class="keyword">super</span>(props, context)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.state = &#123;&#125;</span><br><span class="line">        <span class="keyword">this</span>.store = context[storeKey]</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.initSelector()</span><br><span class="line">        <span class="keyword">this</span>.initSubscription()</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      getChildContext() &#123;</span><br><span class="line">        <span class="keyword">const</span> subscription = <span class="keyword">this</span>.subscription</span><br><span class="line">        <span class="keyword">return</span> &#123; [subscriptionKey]: <span class="keyword">this</span>.subscription || <span class="keyword">this</span>.context[subscriptionKey] &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      componentDidMount() &#123;</span><br><span class="line">        <span class="keyword">this</span>.subscription.trySubscribe()</span><br><span class="line">        <span class="keyword">this</span>.selector.run(<span class="keyword">this</span>.props)</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.selector.shouldComponentUpdate) <span class="keyword">this</span>.forceUpdate()</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      componentWillReceiveProps(nextProps) &#123;</span><br><span class="line">        <span class="keyword">this</span>.selector.run(nextProps)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      componentWillUnmount() &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">this</span>.subscription) <span class="keyword">this</span>.subscription.tryUnsubscribe()</span><br><span class="line">        <span class="keyword">this</span>.subscription = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">this</span>.notifyNestedSubs = noop</span><br><span class="line">        <span class="keyword">this</span>.store = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">this</span>.selector.run = noop</span><br><span class="line">        <span class="keyword">this</span>.selector.shouldComponentUpdate = <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      initSelector() &#123;</span><br><span class="line">        <span class="keyword">const</span> sourceSelector = selectorFactory(<span class="keyword">this</span>.store.dispatch, selectorFactoryOptions)</span><br><span class="line">        <span class="keyword">this</span>.selector = makeSelectorStateful(sourceSelector, <span class="keyword">this</span>.store)</span><br><span class="line">        <span class="keyword">this</span>.selector.run(<span class="keyword">this</span>.props)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      initSubscription() &#123;</span><br><span class="line">        <span class="keyword">const</span> parentSub = <span class="keyword">this</span>.context[subscriptionKey]</span><br><span class="line">        <span class="keyword">this</span>.subscription = <span class="keyword">new</span> Subscription(<span class="keyword">this</span>.store, parentSub, <span class="keyword">this</span>.onStateChange.bind(<span class="keyword">this</span>))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.notifyNestedSubs = <span class="keyword">this</span>.subscription.notifyNestedSubs.bind(<span class="keyword">this</span>.subscription)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      onStateChange() &#123;</span><br><span class="line">        <span class="keyword">this</span>.selector.run(<span class="keyword">this</span>.props)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.selector.shouldComponentUpdate) &#123;</span><br><span class="line">          <span class="keyword">this</span>.notifyNestedSubs()</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">this</span>.componentDidUpdate = <span class="keyword">this</span>.notifyNestedSubsOnComponentDidUpdate</span><br><span class="line">          <span class="keyword">this</span>.setState(dummyState)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      notifyNestedSubsOnComponentDidUpdate() &#123;</span><br><span class="line">        <span class="keyword">this</span>.componentDidUpdate = <span class="literal">undefined</span></span><br><span class="line">        <span class="keyword">this</span>.notifyNestedSubs()</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      render() &#123;</span><br><span class="line">        <span class="keyword">const</span> selector = <span class="keyword">this</span>.selector</span><br><span class="line">        selector.shouldComponentUpdate = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (selector.error) &#123;</span><br><span class="line">          <span class="keyword">throw</span> selector.error</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> createElement(WrappedComponent, selector.props)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Connect.childContextTypes = childContextTypes</span><br><span class="line">    Connect.contextTypes = contextTypes</span><br><span class="line">    Connect.propTypes = contextTypes</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> hoistStatics(Connect, WrappedComponent)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p><em>代码段 3</em> 展示了直属父级容器的构建过程，其实例化过程中首先创建 selector 筛选器和 subscription 订阅器。随后，在 componentDidMount 生命周期执行过程中，将容器的 onStateChange 方法挂载为 store 的 listener 回调；调用 selector.run 方法重新计算 props，若 props 值变更，调用 forceUpdate 方法重绘组件。在 componentWillReceiveProps 生命周期中，再次调用 selector.run 方法重新计算 props，因为 ownProps 的变更可能影响注入自定义组件的 state, boundAction 数据（react-redux 为直属父级容器的 componentWillReceiveProps 和 componentDidUpdate 方法分派了不同的职能，前者驱动 ownProps, stateProps, dispatchProps 变更时自定义组件的重绘，后者驱动 stateProps, dispatchProps 变更时子孙容器的重绘。因此在 stateProps, dispatchProps 无变更的情形下，componentDidUpdate 方法将置为 undefined）。在 componentWillUnmount 生命周期里，将重置 selector 筛选器和 subscription 订阅器。</p>
<p>在状态值变更的情形下，容器的 onStateChange 方法将以 listener 回调形式得到执行，其将调用 selector.run 方法重新计算 props。若 props 已变更，调用 setState 方法驱动直属父级容器重绘；在自定义组件重绘完成后，通过 componentDidUpdate 生命周期方法通知子孙容器状态已更新，尝试执行其 onStateChange 方法。若 props 未作变更，直接通知子孙容器状态已更新，尝试执行其 onStateChange 方法。</p>
<p>subscription 用于将直属父级容器的 onStateChange 方法挂载为 store 中的 listener 回调，而子孙容器的 onStateChange 方法将存储在 subscription.listeners 数组中。当 action 被派发引起 state 变更时，直属父级容器的 onStateChange 方法自然会执行，而子孙容器的 onStateChange 方法则需要在当前直属父级容器中通过调用 subscription.notifyNestedSubs 执行（其执行时机参见 <em>代码段 3</em>，即在当前直属父级容器的 onStateChange 方法调用过程中唤起执行）。</p>
<p><em>代码段 4，subscription 订阅器</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> CLEARED = <span class="literal">null</span></span><br><span class="line"><span class="keyword">const</span> nullListeners = &#123; notify() &#123;&#125; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createListenerCollection</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> current = []</span><br><span class="line">  <span class="keyword">let</span> next = []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    clear() &#123;</span><br><span class="line">      next = CLEARED</span><br><span class="line">      current = CLEARED</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    notify() &#123;</span><br><span class="line">      <span class="keyword">const</span> listeners = current = next</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; listeners.length; i++) &#123;</span><br><span class="line">        listeners[i]()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    get() &#123;</span><br><span class="line">      <span class="keyword">return</span> next</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    subscribe(listener) &#123;</span><br><span class="line">      <span class="keyword">let</span> isSubscribed = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">if</span> (next === current) next = current.slice()</span><br><span class="line">      next.push(listener)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">unsubscribe</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!isSubscribed || current === CLEARED) <span class="keyword">return</span></span><br><span class="line">        isSubscribed = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (next === current) next = current.slice()</span><br><span class="line">        next.splice(next.indexOf(listener), <span class="number">1</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Subscription</span> </span>&#123;</span><br><span class="line">  <span class="keyword">constructor</span>(store, parentSub, onStateChange) &#123;</span><br><span class="line">    <span class="keyword">this</span>.store = store</span><br><span class="line">    <span class="keyword">this</span>.parentSub = parentSub</span><br><span class="line">    <span class="keyword">this</span>.onStateChange = onStateChange</span><br><span class="line">    <span class="keyword">this</span>.unsubscribe = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">this</span>.listeners = nullListeners</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  addNestedSub(listener) &#123;</span><br><span class="line">    <span class="keyword">this</span>.trySubscribe()</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.listeners.subscribe(listener)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  notifyNestedSubs() &#123;</span><br><span class="line">    <span class="keyword">this</span>.listeners.notify()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  isSubscribed() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Boolean</span>(<span class="keyword">this</span>.unsubscribe)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  trySubscribe() &#123;</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.unsubscribe) &#123;</span><br><span class="line">      <span class="keyword">this</span>.unsubscribe = <span class="keyword">this</span>.parentSub</span><br><span class="line">        ? <span class="keyword">this</span>.parentSub.addNestedSub(<span class="keyword">this</span>.onStateChange)</span><br><span class="line">        : <span class="keyword">this</span>.store.subscribe(<span class="keyword">this</span>.onStateChange)</span><br><span class="line"> </span><br><span class="line">      <span class="keyword">this</span>.listeners = createListenerCollection()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  tryUnsubscribe() &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.unsubscribe) &#123;</span><br><span class="line">      <span class="keyword">this</span>.unsubscribe()</span><br><span class="line">      <span class="keyword">this</span>.unsubscribe = <span class="literal">null</span></span><br><span class="line">      <span class="keyword">this</span>.listeners.clear()</span><br><span class="line">      <span class="keyword">this</span>.listeners = nullListeners</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>俗语，”麻雀虽小，五脏俱全“，”苔米花虽小，也学牡丹开“。使用 react-redux 无非 ‘Provider store={store}’ 和 ‘connect(mapStateToProps, mapDispatchToProps)(Component)’ 两段代码，而在 react-redux 的设计和实现上，我们又可以看见丰富的矿藏，真是”人不可貌相，海不可斗量，代码不可管窥“。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/07/02/react/react相关/redux源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/07/02/react/react相关/redux源码分析/" itemprop="url">redux源码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-07-02T00:00:00+08:00">2018-07-02</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/状态管理/" itemprop="url" rel="index"><span itemprop="name">状态管理</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/07/02/react/react相关/redux源码分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/07/02/react/react相关/redux源码分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>为使页面组件和业务逻辑解耦，前端相继涌现出 MVC（Model-View-Controller）、MVP（Model-View-Presenter）、 MVVM（Model-View-ViewModel） 模式。在双向数据流的实现中，同一个 View 可能会触发多个 Model 的更新，并间接引起另一个 View 的刷新，使得状态变更的线索及影响变得错综复杂。redux 延续了 flux 架构，倡导单向数据流模式、不能通过访问器属性修改数据，这样就便于追踪状态变化的线索。</p>
<p><em>图 1，redux 数据流图</em><br><img src="/2018/07/02/react/react相关/redux源码分析/redux-data-stream.png"></p>
<p>在 redux 的设计中，state 为全局缓存的状态（存储于 Store 中），action 为状态变更的标识，派发特定的 action 将引起指定的 state 变更。不得不指出，首先，在视图组件的实现上，多个 View 可能会复用相同的 state，因此，在一个 View 中派发的 action 可能会影响另一个 View 的状态，这样的话，状态管理上仍会有错综的线索，并不具备清晰性。其次，redux 以状态变更的动作为着眼点，通过 redux 组织业务逻辑，不如包含数据及其变更动作的 Model 直观。</p>
<h2 id="源起"><a href="#源起" class="headerlink" title="源起"></a>源起</h2><p>redux 最初需要聚焦于实现 state = fn(state, action) 函数，用于刷新缓存的状态值。在这个函数中，state 可能包含多个状态属性；action 的职责有两种，其一使用 type 属性标识状态值作何变更，其二携带的附属信息将作为引导状态值变更的数据源。对于多种状态值变更，可采用分治的思想将其简化，即 childState = fn(childState, action)。</p>
<p><em>代码段 1，状态变更的雏形</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> state = &#123;</span><br><span class="line">  todoList: [&#123;</span><br><span class="line">    text: <span class="string">'Eat food'</span>,</span><br><span class="line">    completed: <span class="literal">true</span></span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    text: <span class="string">'Exercise'</span>,</span><br><span class="line">    completed: <span class="literal">false</span></span><br><span class="line">  &#125;],</span><br><span class="line">  visibilityFilter: <span class="string">'SHOW_COMPLETED'</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">visibilityFilter</span>(<span class="params">state = <span class="string">'SHOW_ALL'</span>, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (action.type === <span class="string">'SET_VISIBILITY_FILTER'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> action.filter;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">todos</span>(<span class="params">state = [], action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (action.type) &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">'ADD_TODO'</span>:</span><br><span class="line">    <span class="keyword">return</span> state.concat([&#123; <span class="attr">text</span>: action.text, <span class="attr">completed</span>: <span class="literal">false</span> &#125;]);</span><br><span class="line">  <span class="keyword">case</span> <span class="string">'TOGGLE_TODO'</span>:</span><br><span class="line">    <span class="keyword">return</span> state.map(<span class="function">(<span class="params">todo, index</span>) =&gt;</span></span><br><span class="line">      action.index === index ?</span><br><span class="line">        &#123; <span class="attr">text</span>: todo.text, <span class="attr">completed</span>: !todo.completed &#125; :</span><br><span class="line">        todo</span><br><span class="line">   )</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">return</span> state;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">todoApp</span>(<span class="params">state = &#123;&#125;, action</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    todos: todos(state.todos, action),</span><br><span class="line">    visibilityFilter: visibilityFilter(state.visibilityFilter, action)</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Add_Todo_Action = &#123; <span class="attr">type</span>: <span class="string">'ADD_TODO'</span>, <span class="attr">text</span>: <span class="string">'Go to swimming pool'</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> Toggle_Todo_Action = &#123; <span class="attr">type</span>: <span class="string">'TOGGLE_TODO'</span>, <span class="attr">index</span>: <span class="number">1</span> &#125;;</span><br><span class="line"><span class="keyword">const</span> Set_Visibility_Filter_Action = &#123; <span class="attr">type</span>: <span class="string">'SET_VISIBILITY_FILTER'</span>, <span class="attr">filter</span>: <span class="string">'SHOW_ALL'</span> &#125;;</span><br><span class="line"></span><br><span class="line">todoApp(state, Add_Todo_Action);</span><br></pre></td></tr></table></figure></p>
<p>通过这份来自<a href="http://www.redux.org.cn/docs/introduction/CoreConcepts.html" target="_blank" rel="noopener">官网的代码示例</a>，我们既能瞧见源码作者最初聚焦的视点，又能看见 redux 的一大原则 —— 使用纯函数实现状态更新。</p>
<p>在 redux 中，函数 state = fn(state, action) 被称为 reducer。与 Array.prototype.reduce(arrReducer, result) 方法相同的是，在数组的原型方法中，result 的终值通过递归调用 arrReducer 获得；redux 中的 state 更新也是通过逐个调用 reducer 函数实现。如果我们把采用策略模式分而治之的示例代码转变为采用职责链模式实现，即 childState = fn(childState, action) 替换为 state = fn(state, action) 函数，传入 reducer 中的为全量 state 数据，多个 reducer 构成链式结构，当前一个执行完成后，再执行下一个，这样就更接近于 Array.prototype.reduce 方法的执行机制，我们也就更能看出更新状态的函数为什么会被叫做 reducer 了。</p>
<p><em>图 2，reducer 工作的两种可能性</em><br><img src="/2018/07/02/react/react相关/redux源码分析/reducer.png"></p>
<p>在 redux 源码中，串联多个 state 实际采用的是策略模式。与示例代码不同的是，state 状态会以业务模块的组织划分成多个状态管理模块，同一个状态管理模块内部又包含多个状态值。对于前者，redux 提供了 combineReducers 方法，用于复合多个 reducer 函数。对于后者，需要使用者手动复合。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="store"><a href="#store" class="headerlink" title="store"></a>store</h3><p>上一节提到了状态转换的机制，这是在 action 被派发以后所执行的动作。这一节我们将串联整个链路，包含 action 怎样被派发，状态值如何作缓存，以及更新等。</p>
<p>针对根据 action 触发 reducer 执行这一命题，我们自然地会想到使用发布-订阅模式加以处理，将 action.type 视为订阅的主题，action 中其余属性作为提供给订阅者的额外信息。然而 redux 的宗旨是使状态变化的线索变得清晰，易于追踪和调试，发布-订阅模式和这一宗旨相悖。因为在发布-订阅模式中，同一主题可以有多个订阅者，也就意味着同一个 action 可以触发多个 reducer，线索就会变得错综。在 redux 的设计中，一个 action 只能触发某个特定的reducer 执行。这样，我们就解释了为什么在 redux 源码中，针对独立状态集的多个子 reducer 可以被复合成一个单一的全局总 reducer（简单的，可以通过 switch 语句实现），用于负责处理全局状态的变更。当 action 被派发时，只需调用缓存的全局总 reducer，就可以实现全局状态的更新。</p>
<p>如果我们把总 reducer 称为 finalReducer，全局状态称为 globalState，派发 action 的过程其实只在于唤起 finalReducer 的执行。在 redux 源码中，无论 finalReducer，还是 globalState，都在 store 中维护。</p>
<p><em>图 3，store 的执行机制</em><br><img src="/2018/07/02/react/react相关/redux源码分析/store.png"></p>
<p>为了实现上述机制，store 将 finalReducer, globalState 实现为缓存数据，并提供 getState, dispatch, replaceReducer 方法。其中，store.getState 用于获取全局缓存的状态值，store.dispatch 用于派发 action，store.replaceReducer 用于替换 finalReducer。在 redux 源码中，store 表现为 createStore 模块，其提供 createStore(reducer, initialState) 函数，用于设置 finalReducer, globalState 的初始值。</p>
<p>从源码中抽出这部分内容，即为如下代码（剔除参数校验）：</p>
<p><em>代码段 2，store 基本功能</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createStore</span>(<span class="params">reducer, preloadedState</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> currentReducer = reducer</span><br><span class="line">  <span class="keyword">let</span> currentState = preloadedState</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">getState</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> currentState</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> action.type === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">        <span class="string">'Actions may not have an undefined "type" property. '</span> +</span><br><span class="line">          <span class="string">'Have you misspelled a constant?'</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    currentState = currentReducer(currentState, action)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> action</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">replaceReducer</span>(<span class="params">nextReducer</span>) </span>&#123;</span><br><span class="line">    currentReducer = nextReducer</span><br><span class="line">    dispatch(&#123; <span class="attr">type</span>: ActionTypes.REPLACE &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  dispatch(&#123; <span class="attr">type</span>: ActionTypes.INIT &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    dispatch,</span><br><span class="line">    getState,</span><br><span class="line">    replaceReducer</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>从上述代码中，redux 在创建 store 的过程，会派发 action = { type: ActionTypes.INIT }，意味着可以在应用初始化过程中更新 state；而 store.replaceReducer 方法的存在通常是为了支持编码时的热加载功能，同时又会派发 action = { type: ActionTypes.REPLACE }。从设计的角度考量源码，这是无需多加关注的细节。</p>
<h3 id="middleware"><a href="#middleware" class="headerlink" title="middleware"></a>middleware</h3><p>从 <em>图 3</em> 中，我们也能看出，action 经由 dispatch 函数直接交给 finalReducer 函数，middleware 中间件的意义是在 action 传入 dispatch 函数前，对 action 进行转换等特殊处理，功能类似 sevelet 中对请求进行转换、过滤等操作的 filter，或者 koa 中间件。redux 中间件的实现上也采用泛职责链模式，前一个中间件处理完成，交由下一个中间件进行处理。</p>
<p><em>图 4，中间件转换 action 流程</em><br><img src="/2018/07/02/react/react相关/redux源码分析/middleware.png"></p>
<p>redux 只能从 dispatch 函数的参数中截取到 action，因此在固有程序插入中间件的机制是通过封装 dispatch 函数来完成的，即函数 newDispatch = middleware(dispatch)。这样，在newDispatch 函数体内，我们就能获得使用者传入的 action。</p>
<p>在多个中间件的串联上，redux 借助 Array.prototype.reduce 方法实现。redux 又将 getState, dispatch 作为参数传入 middleware 中，作为工具函数。</p>
<p>使用 redux 时，编写中间件采用 ({ getState, dispatch }) =&gt; dispatch =&gt; action =&gt; {  } 形式。再次申明，参数 { getState, dispatch } 为 redux 中间件机制中传入的辅助函数，参数 dispatch 为本次 action 派发过程中唤起执行的 store.dispatch 方法，其意义就是通过封装该函数获取它的参数 action，参数 action 就是本次实际被派发的 action，中间件实际需要处理的转换对象。</p>
<p><em>图 5，单个中间件的处理流程</em><br><img src="/2018/07/02/react/react相关/redux源码分析/middleware-flow.png"></p>
<p><em>代码段 3，中间件机制</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">compose</span>(<span class="params">...funcs</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (funcs.length === <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">arg</span> =&gt;</span> arg</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (funcs.length === <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> funcs[<span class="number">0</span>]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> funcs.reduce(<span class="function">(<span class="params">a, b</span>) =&gt;</span> (...args) =&gt; a(b(...args)))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">applyMiddleware(...middlewares) &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">createStore</span> =&gt;</span> (...args) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> store = createStore(...args)</span><br><span class="line">    <span class="keyword">let</span> dispatch = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">        <span class="string">`Dispatching while constructing your middleware is not allowed. `</span> +</span><br><span class="line">          <span class="string">`Other middleware would not be applied to this dispatch.`</span></span><br><span class="line">      )</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> chain = []</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> middlewareAPI = &#123;</span><br><span class="line">      getState: store.getState,</span><br><span class="line">      dispatch: <span class="function">(<span class="params">...args</span>) =&gt;</span> dispatch(...args)</span><br><span class="line">    &#125;</span><br><span class="line">    chain = middlewares.map(<span class="function"><span class="params">middleware</span> =&gt;</span> middleware(middlewareAPI))</span><br><span class="line">    dispatch = compose(...chain)(store.dispatch)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      ...store,</span><br><span class="line">      dispatch</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>通过上述代码，我们也能看出，redux 植入中间件机制是通过 applyMiddleware 函数封装 createStore 完成的。在重新构建的 createStore 函数体内，其实现也如上文指出的，就是逐个调用中间件函数，对 store.dispatch 方法进行封装。值得借鉴的是，通过包装函数增强原函数的功能，可以使新功能点无缝地插入到原代码逻辑中。</p>
<p>回过头再看 createStore 模块，我们发现，redux 在 createStore 函数的实现上还有第三个参数 enhancer，其主要目的就是为 applyMiddleware 函数提供一个便捷的接口，enhancer 参数的意义也就在于包装 createStore 函数。</p>
<p><em>代码段 3，createStore 函数功能增强</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createStore</span>(<span class="params">reducer, preloadedState, enhancer</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> enhancer !== <span class="string">'function'</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Expected the enhancer to be a function.'</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> enhancer(createStore)(reducer, preloadedState)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="listener"><a href="#listener" class="headerlink" title="listener"></a>listener</h3><p>以上内容无不与状态更新环节相关联，并没有涉及 store 与视图层 view 怎样完成交互。针对这一命题，redux 采用了发布-订阅模式。实际表现为，当 store 派发一个 action 时（可视为发出一个消息），都会促使监视器 listener 与观察者 observer （可视为消息的接受者）运作其处理逻辑。</p>
<p>在具体实现过程中，监视器 listener 通过 store.subscribe 方法添加到 listeners 缓存队列中；当 action 被派发时，其将被取出执行。对于观察者 observer，首先通过 store.observable 方法获得接口层面的可观察对象，其次调用该可观察对象的 subscribe 方法，将 observer.next 转化为 listener，并添加到 listeners 缓存队列中。这样，当 action 被派发时，无论监视器 listener，还是观察者 observer 的 next 方法都将得到执行。不同的是，listener 为无参执行，observer.next 将以即时的 globalState 作为参数。</p>
<p><em>图 6，listener, observer 执行流程</em><br><img src="/2018/07/02/react/react相关/redux源码分析/listener.png"></p>
<p><em>代码段 4，listener, observer 实现</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createStore</span>(<span class="params">reducer, preloadedState, enhancer</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">ensureCanMutateNextListeners</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (nextListeners === currentListeners) &#123;</span><br><span class="line">      nextListeners = currentListeners.slice()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">subscribe</span>(<span class="params">listener</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> isSubscribed = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    ensureCanMutateNextListeners()</span><br><span class="line">    nextListeners.push(listener)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">unsubscribe</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (!isSubscribed) &#123;</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (isDispatching) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">          <span class="string">'You may not unsubscribe from a store listener while the reducer is executing. '</span> +</span><br><span class="line">            <span class="string">'See http://redux.js.org/docs/api/Store.html#subscribe for more details.'</span></span><br><span class="line">        )</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      isSubscribed = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">      ensureCanMutateNextListeners()</span><br><span class="line">      <span class="keyword">const</span> index = nextListeners.indexOf(listener)</span><br><span class="line">      nextListeners.splice(index, <span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">observable</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> outerSubscribe = subscribe</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      subscribe(observer) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> observer !== <span class="string">'object'</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">'Expected the observer to be an object.'</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">observeState</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">          <span class="keyword">if</span> (observer.next) &#123;</span><br><span class="line">            observer.next(getState())</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        observeState()</span><br><span class="line">        <span class="keyword">const</span> unsubscribe = outerSubscribe(observeState)</span><br><span class="line">        <span class="keyword">return</span> &#123; unsubscribe &#125;</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      [$$observable]() &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">dispatch</span>(<span class="params">action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      isDispatching = <span class="literal">true</span></span><br><span class="line">      currentState = currentReducer(currentState, action)</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      isDispatching = <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> listeners = (currentListeners = nextListeners)</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; listeners.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> listener = listeners[i]</span><br><span class="line">      listener()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> action</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    subscribe,</span><br><span class="line">    [$$observable]: observable</span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>关于 listener 的用法，我将在下一节，以特例 <a href="">react-redux</a> 源码分析中穿插说明。</p>
<h3 id="utils"><a href="#utils" class="headerlink" title="utils"></a>utils</h3><p>redux 提供了三个工具函数，分别是 <em>代码段 3</em> 给出的 compose 函数，以及 bindActionCreators, combineReducers 函数。</p>
<p>compose 函数的功能和实现，可参见上文。</p>
<p>bindActionCreators 函数的意义在于支持动态配置 action。其实现原理是通过 actionCreator 函数生成 action，再调用 store.dispatch 方法加以派发。</p>
<p><em>代码段 5，bindActionCreators</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindActionCreator</span>(<span class="params">actionCreator, dispatch</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> dispatch(actionCreator.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">bindActionCreators</span>(<span class="params">actionCreators, dispatch</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreators === <span class="string">'function'</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> bindActionCreator(actionCreators, dispatch)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreators !== <span class="string">'object'</span> || actionCreators === <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(</span><br><span class="line">      <span class="string">`bindActionCreators expected an object or a function, instead received <span class="subst">$&#123;</span></span></span><br><span class="line"><span class="string"><span class="subst">        actionCreators === <span class="literal">null</span> ? <span class="string">'null'</span> : <span class="keyword">typeof</span> actionCreators</span></span></span><br><span class="line"><span class="string"><span class="subst">      &#125;</span>. `</span> +</span><br><span class="line">        <span class="string">`Did you write "import ActionCreators from" instead of "import * as ActionCreators from"?`</span></span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> keys = <span class="built_in">Object</span>.keys(actionCreators)</span><br><span class="line">  <span class="keyword">const</span> boundActionCreators = &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; keys.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = keys[i]</span><br><span class="line">    <span class="keyword">const</span> actionCreator = actionCreators[key]</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> actionCreator === <span class="string">'function'</span>) &#123;</span><br><span class="line">      boundActionCreators[key] = bindActionCreator(actionCreator, dispatch)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> boundActionCreators</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>combineReducers 函数的意义在于复合 reducer。其实现过程中校验了初始状态，状态的 key 值是否有与之匹配的 reducer。</p>
<p><em>代码段 6，combineReducers</em><br><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">combineReducers</span>(<span class="params">reducers</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> reducerKeys = <span class="built_in">Object</span>.keys(reducers)</span><br><span class="line">  <span class="keyword">const</span> finalReducers = &#123;&#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; reducerKeys.length; i++) &#123;</span><br><span class="line">    <span class="keyword">const</span> key = reducerKeys[i]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> reducers[key] === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">        warning(<span class="string">`No reducer provided for key "<span class="subst">$&#123;key&#125;</span>"`</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> reducers[key] === <span class="string">'function'</span>) &#123;</span><br><span class="line">      finalReducers[key] = reducers[key]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> finalReducerKeys = <span class="built_in">Object</span>.keys(finalReducers)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> unexpectedKeyCache</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    unexpectedKeyCache = &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> shapeAssertionError</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// assertReducerShape 校验 reducer 返回初始状态非 undefined，且有兜底 state</span></span><br><span class="line">    assertReducerShape(finalReducers)</span><br><span class="line">  &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">    shapeAssertionError = e</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">combination</span>(<span class="params">state = &#123;&#125;, action</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (shapeAssertionError) &#123;</span><br><span class="line">      <span class="keyword">throw</span> shapeAssertionError</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">      <span class="comment">// getUnexpectedStateShapeWarningMessage 函数校验 state 初始值和 reducer 各键的匹配程度</span></span><br><span class="line">      <span class="comment">// state 初始值可通过 ActionTypes.INIT 设定或参数注入</span></span><br><span class="line">      <span class="keyword">const</span> warningMessage = getUnexpectedStateShapeWarningMessage(</span><br><span class="line">        state,</span><br><span class="line">        finalReducers,</span><br><span class="line">        action,</span><br><span class="line">        unexpectedKeyCache</span><br><span class="line">      )</span><br><span class="line">      <span class="keyword">if</span> (warningMessage) &#123;</span><br><span class="line">        warning(warningMessage)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> hasChanged = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">const</span> nextState = &#123;&#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; finalReducerKeys.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> key = finalReducerKeys[i]</span><br><span class="line">      <span class="keyword">const</span> reducer = finalReducers[key]</span><br><span class="line">      <span class="keyword">const</span> previousStateForKey = state[key]</span><br><span class="line">      <span class="keyword">const</span> nextStateForKey = reducer(previousStateForKey, action)</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> nextStateForKey === <span class="string">'undefined'</span>) &#123;</span><br><span class="line">        <span class="comment">// reducer 返回值为 undefined 时，由 getUndefinedStateErrorMessage 函数拼接错误文案</span></span><br><span class="line">        <span class="keyword">const</span> errorMessage = getUndefinedStateErrorMessage(key, action)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(errorMessage)</span><br><span class="line">      &#125;</span><br><span class="line">      nextState[key] = nextStateForKey</span><br><span class="line">      hasChanged = hasChanged || nextStateForKey !== previousStateForKey</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> hasChanged ? nextState : state</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><p>为简化 redux 使用过程中的编码量，可参考 dva 设计 redux-model 模块，通过 namespace 复合 constants, actions, reducers 文件。</p>
<p>异步请求的 loading 状态可制作 redux-loading-middleware 中间件模块作统一处理。</p>
<p>以上两点，以及状态数据的设计（在状态管理模块确定之后，如何高效、稳妥地组织状态数据通常是编写业务代码的重心），介于篇幅和能力的限制，我将不再作阐述。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>对我这样半道出家的人来说，阅读源码比如专研一本好书。先从薄处入手，藉由丰富的关联性思想到每个可挖掘的点，视野渐渐变得开阔，纸张上的字句也会渐渐变得厚实。再从厚处着眼，借着内在已储备的知识量，更容易拨开阻碍视线的枝蔓，洞见维系着本质的主干，作者构思的线条也会变得越来越简明。像每一段求索经历，这是一个从薄到厚、再从厚到薄的过程，就中的滋味不乏刑侦、推理的乐趣。但是，阅读源码譬如靠经验增进技艺，对知识的汲取往往流于碎片化。对那些才能稍嫌拙劣、又想一探究竟的人来说，以阅读源码的方式攀升到系统化认知的高度，这当中所需的演绎过程将置那些流行、已成熟的技术体系于不顾，势必会耗费莫大的心力，譬如绕一段未必能达到终点的远路。我认为，科班生有一种高屋建瓴的视角，较之半道出家的人，他们具备更为全面的认知，更容易跳过沿途遭遇的细节，理出解决命题的主要线索。当然，假如有个人以一种谈不上正确的方式探寻 api 或数学公式背后的奥秘，他的动机是值得鼓励的。只是等他回落在简单的哲学中，那就需要一段或长或短的时间了。</p>
<p>吴军博士在《数学之美》中引用了牛顿的一句话，”（人们发觉）真理在形式上从来都是简单的，而不是复杂和含混的。“在阅读这本书的过程中，我既能感受到作者行文简明扼要的美感，又能从作者的描述中体会到简单哲学的分量。因为简单，可以助人在错综的表象中洞悉本质，可以摆脱心理上的弊病，免于将学识敷在脸面上。我想，演绎得越多，仰赖于记忆的成分也越少，深藏在海平面下的设计矿产也越加丰富（在其上方形成的概念可以理解为变动不居的表象）。秉持着对简单哲学的信奉，我开始写作这篇分析 redux 源码的文章，虽然对简单哲学的应用以现有的编程功底仍旧有力所不逮的感觉。</p>
<p>总之，这篇文章是逐渐摸索的产物，其中难免错谬与勉强，却是我试图在编程行业中登堂入室的中转站。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>[深入 React 技术栈 - 陈屹]<br><a href="http://www.redux.org.cn/" target="_blank" rel="noopener">Redux 中文文档</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/24/设计模式/职责链模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/24/设计模式/职责链模式/" itemprop="url">职责链模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-24T00:00:00+08:00">2018-06-24</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/设计模式/" itemprop="url" rel="index"><span itemprop="name">设计模式</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/06/24/设计模式/职责链模式/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/06/24/设计模式/职责链模式/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>职责链模式(Chain of Responsibility)的主要实现逻辑为，将请求的处理对象构造为链式结构，然后在这条链上依序传递请求，直到请求被某个对象处理，或者最终得不到处理。</p>
<p>《设计模式:可复用面向对象软件的基础》一书将职责链模式描述为：</p>
<p>Avoid coupling the sender of a request to its receiver by giving morethan one object a chance to handle the request. Chain the receiving objects and pass the request along the chain until an object handles it.</p>
<h2 id="经典实现"><a href="#经典实现" class="headerlink" title="经典实现"></a>经典实现</h2><p>职责链模式包含下列组件：</p>
<ul>
<li>Handler: 处理请求对象的抽象接口，包含 handle 抽象方法，用于处理请求或调用下一个处理对象处理请求；setNextHandler 方法（可选），用于设定下一个处理对象；nextHandler 属性为下一个处理对象。</li>
<li>ConcerteHandler: 处理请求的具体类，包含 handle, setNextHandler 方法的实现，nextHandler 属性访问下一个处理对象。</li>
<li>Client: 用于向链上的具体处理者传递请求。</li>
</ul>
<p>以下代码使用职责链模式揣测浏览器事件冒泡机制的简要实现。与浏览器不同的是，示例代码只演示父子层级关系中，子节点如何将事件对象转交给父节点，并触发绑定在父节点上的事件处理函数。不过，通过这段简要的代码实现，可以猜想事件对象 stopPropagation 方法的实现。事件对象可在鼠标或键盘点击时构造；在浏览器中，指定下一个处理对象这一过程，也可以在解析 dom 树的时候实现，使父节点自然成为子节点的下一个处理对象。关于事件捕获的实现，疑似通过事件对象的坐标属性和元素的位置属性比对实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">abstract <span class="class"><span class="keyword">class</span> <span class="title">Handler</span></span>&#123;</span><br><span class="line">  nextHandler;</span><br><span class="line"></span><br><span class="line">  handle()&#123;&#125;</span><br><span class="line">  setNextHandler(nextHandler)&#123;</span><br><span class="line">    <span class="keyword">this</span>.nextHandler = nextHandler;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Node</span> <span class="keyword">extends</span> <span class="title">Handler</span></span>&#123;</span><br><span class="line">  clickHandlers = [];</span><br><span class="line"></span><br><span class="line">  handle(event)&#123;</span><br><span class="line">    <span class="keyword">switch</span>(event.type)&#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'onClick'</span>:</span><br><span class="line">        <span class="keyword">for</span> ( <span class="keyword">const</span> handler <span class="keyword">of</span> <span class="keyword">this</span>.clickHandlers )&#123;</span><br><span class="line">          handler();</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">if</span> ( <span class="keyword">this</span>.nextHandler ) <span class="keyword">this</span>.nextHandler.handle(event);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  onClick(handler)&#123;</span><br><span class="line">    <span class="keyword">this</span>.clickHandlers.push(handler);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ParentNode</span> <span class="keyword">extends</span> <span class="title">Node</span></span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ChildNode</span> <span class="keyword">extends</span> <span class="title">Node</span></span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> parentNode = <span class="keyword">new</span> ParentNode();</span><br><span class="line"><span class="keyword">const</span> childNode = <span class="keyword">new</span> ChildNode();</span><br><span class="line">childNode.setNextHandler(parentNode);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> mouseEvent = <span class="keyword">new</span> MouseEvent();</span><br><span class="line">childNode.handle(mouseEvent);</span><br></pre></td></tr></table></figure>
<p>通过上述代码示例，我们也可以猜想 JavaScript 语言中原型链的实现。</p>
<p>职责链模式具有如下特点：</p>
<ol>
<li>处理对象呈链式结构，因此，天然可以用来处理流程。在实现上，可以使用 setNextHandler 方法指定下一个处理对象，也可以使用一条已有的链，如父子结构形成的层级关系，或者队列形式（队列内若存储函数，当函数返回值为 false 时，表示不再将请求转交给下一个处理对象）。通常情况下，职责链模式表现为，根据请求的不同，再唤醒链上的某个处理对象加以操作，效果等同于策略模式。介于其链式处理的特征，职责链模式有一个变种，即请求经由前一个处理对象封装后，再交由下一个处理对象，这和浏览器的事件冒泡机制相仿（这样的链式操作，也可以通过函数队列或者迭代器模式实现）。</li>
<li>当链未明确指定时，可在链中灵活地添加处理对象、并指定下一个处理对象，跳过不必要的处理逻辑。</li>
<li>请求对象可以采用最简单的硬编码形式，也可以采用复杂的对象形式、或者使用特定的 Request 类加以构造，甚至使用转换函数从标识符中获取到传入处理对象的数据。这里要指出职责链模式的另一个变种，即可通过处理对象对请求进行特定包装后，再唤醒下一个处理对象。如第一点指出的，对于简单的请求对象，我们可以换用策略模式实现多样的处理机制；甚至对于复杂的请求对象，我们也可以制定规则转换引擎将其转换为简单的标识符形式，再通过策略模式加以处理。但是策略模式只能选中一种算法，且没有呈现出链式结构，因此策略模式不能像职责链模式那样不能用于控制流程，如审批流。</li>
<li>职责链模式可用于降低请求发送者和接受者的耦合度，处理对象也不需要知道链的结构。</li>
<li>过长的职责链影响程序的性能，同时也占用内存开销。在某些情况下，传入的请求会得不到处理，这时可以在链的尾端添加一个兜底函数处理请求。</li>
</ol>
<h2 id="js-中的职责链模式"><a href="#js-中的职责链模式" class="headerlink" title="js 中的职责链模式"></a>js 中的职责链模式</h2><p>在 js 中，可借助 AOP 切面实现职责链模式，在实现上呈现出函数式特征。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handler1</span>(<span class="params"></span>)</span>&#123; &#125;;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handler2</span>(<span class="params"></span>)</span>&#123; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">Function</span>.property.after = <span class="function"><span class="params">nextHandler</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">let</span> ret = <span class="keyword">this</span>.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line">    <span class="keyword">if</span> ( !!ret ) <span class="keyword">return</span> nextHandler.apply(<span class="keyword">this</span>, <span class="built_in">arguments</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">handler1.after(handler2);</span><br></pre></td></tr></table></figure>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><p>如前文所说，职责链模式可应用于呈现出父子结构的图形界面上，以实现事件处理或者其他图形效果。</p>
<p>职责链也可用于流程控制，如审批流等。</p>
<p>在已知的应用中，职责链模式见于 servelt 过滤器的实现，redux、koa 中间件的实现，koa-router 路由的实现。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>[设计模式:可复用面向对象软件的基础]<br>[Javascript 设计模式和开发实践 - 曾探]</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/06/13/jquery/动效分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/06/13/jquery/动效分析/" itemprop="url">jquery 动效分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-06-13T00:00:00+08:00">2018-06-13</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/jquery/" itemprop="url" rel="index"><span itemprop="name">jquery</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/06/13/jquery/动效分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/06/13/jquery/动效分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="动效基础"><a href="#动效基础" class="headerlink" title="动效基础"></a>动效基础</h2><p>在阅读 jquery/effects 模块源码之前，有必要先了解一下制作前端动效的一些基本知识，其内容包含动效实现的基本原理、缓动函数等。对于以上内容，笔者将在这一小节一一加以介绍。</p>
<h3 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h3><p>动效实现的基本原理如同逐帧制作动画，相隔时间较短的两帧动画可以促使人类视觉误以为那是连续的一个过程。术语刷新率 fps 指每秒更新多少帧画面。通常，每秒刷新 24 张画面最适宜于人类视觉，也就是单张画面的滞留时间为 25 毫秒。因此，制作小球动效等价于在时间轴上计算小球当前的运动位置这一数学命题，即算术表达式 x = fn(t)。</p>
<h3 id="缓动函数"><a href="#缓动函数" class="headerlink" title="缓动函数"></a>缓动函数</h3><p>常规的缓动函数表达式为 x = fn(t, b, c, d)，其中 x 为当前样式，t 为动画执行事件，b 为起始样式，c 为最终样式，d 为动画总时长。在已知 b, c, d 三个参数的情形下，缓动函数可以表述为 x = fn(t)，其斜率为速度，二次导数为加速度。</p>
<p>常见的缓动函数可以查看 <a href="https://esings.net/zh-cn" target="_blank" rel="noopener">缓动函数速查表</a>。缓动函数名中，后缀 In 表示加速，Out 表示减速，InOut 标识先加速、后减速；后缀 Sine 表示由三角函数实现，Quad 表示由二次方函数实现，Cubic 为三次方，Quart 为四次方，Quint 为五次方，Circ 为开平方根，Expo 为开立方根，Elastic 为结合三角函数和开立方根的初级弹簧效果，Back 为使用常数 1.70158 计算的回退效果，Bounce 为高级弹簧效果。linear 为线性函数。</p>
<img src="/2018/06/13/jquery/动效分析/easing.png">
<p>jquery.esing 类库列出了多种缓动函数集合，参数 p 为动画已执行时间占动画总时长的百分比，返回值当前移动距离占总移动距离的百分比。代码如下（包含 jquery 中提供的 linear, swing 函数）：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> c1 = <span class="number">1.70158</span>;</span><br><span class="line"><span class="keyword">const</span> c2 = c1 * <span class="number">1.525</span>;</span><br><span class="line"><span class="keyword">const</span> c3 = c1 + <span class="number">1</span>;</span><br><span class="line"><span class="keyword">const</span> c4 = ( <span class="number">2</span> * <span class="built_in">Math</span>.PI ) / <span class="number">3</span>;</span><br><span class="line"><span class="keyword">const</span> c5 = ( <span class="number">2</span> * <span class="built_in">Math</span>.PI ) / <span class="number">4.5</span>;</span><br><span class="line"></span><br><span class="line">$.esing = &#123;</span><br><span class="line">  linear(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p;</span><br><span class="line">  &#125;,</span><br><span class="line">  swing(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0.5</span> - <span class="built_in">Math</span>.Math.cos( p * <span class="built_in">Math</span>.PI ) / <span class="number">2</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInQuad(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p * p;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeOutQuad(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> - ( <span class="number">1</span> - p ) * ( <span class="number">1</span> - p );</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInOutQuad(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p &lt; <span class="number">0.5</span> ? </span><br><span class="line">      <span class="number">2</span> * p * p : </span><br><span class="line">      <span class="number">1</span> - <span class="built_in">Math</span>.pow( <span class="number">-2</span> * p + <span class="number">2</span>, <span class="number">2</span> ) / <span class="number">2</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInCubic(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p * p * p;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeOutCubic(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> - <span class="built_in">Math</span>.pow( <span class="number">1</span> - p, <span class="number">3</span> );</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInOutCubic(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p &lt; <span class="number">0.5</span> ? </span><br><span class="line">      <span class="number">4</span> * p * p * p : </span><br><span class="line">      <span class="number">1</span> - <span class="built_in">Math</span>.pow( <span class="number">-2</span> * p + <span class="number">2</span>, <span class="number">3</span> ) / <span class="number">2</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInQuart(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p * p * p * p;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeOutQuart(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> - <span class="built_in">Math</span>.pow( <span class="number">1</span> - p, <span class="number">4</span> );</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInOutQuart(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p &lt; <span class="number">0.5</span> ?</span><br><span class="line">      <span class="number">8</span> * p * p * p * p :</span><br><span class="line">      <span class="number">1</span> - <span class="built_in">Math</span>.pow( <span class="number">-2</span> * p + <span class="number">2</span>, <span class="number">4</span> ) / <span class="number">2</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInQuint(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p * p * p * p * p;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeOutQuint(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> - <span class="built_in">Math</span>.pow( <span class="number">1</span> - p, <span class="number">5</span> );</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInOutQuint(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p &lt; <span class="number">0.5</span> ?</span><br><span class="line">      <span class="number">16</span> * p * p * p * p * p :</span><br><span class="line">      <span class="number">1</span> - <span class="built_in">Math</span>.pow( <span class="number">-2</span> * p + <span class="number">2</span>, <span class="number">5</span> ) / <span class="number">2</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInSine(p) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> - <span class="built_in">Math</span>.cos( p * <span class="built_in">Math</span>.PI/<span class="number">2</span> );</span><br><span class="line">  &#125;,</span><br><span class="line">  easeOutSine(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Math</span>.sin( p * <span class="built_in">Math</span>.PI/<span class="number">2</span> );</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInOutSine(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> -( <span class="built_in">Math</span>.cos( <span class="built_in">Math</span>.PI * p ) - <span class="number">1</span> ) / <span class="number">2</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInEppo(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p === <span class="number">0</span> ? <span class="number">0</span> : <span class="built_in">Math</span>.pow( <span class="number">2</span>, <span class="number">10</span> * p - <span class="number">10</span> );</span><br><span class="line">  &#125;,</span><br><span class="line">  easeOutEppo(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p === <span class="number">1</span> ? <span class="number">1</span> : <span class="number">1</span> - <span class="built_in">Math</span>.pow( <span class="number">2</span>, <span class="number">-10</span> * p );</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInOutEppo(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p === <span class="number">0</span> ? <span class="number">0</span> : p === <span class="number">1</span> ? <span class="number">1</span> : p &lt; <span class="number">0.5</span> ?</span><br><span class="line">      <span class="built_in">Math</span>.pow( <span class="number">2</span>, <span class="number">20</span> * p - <span class="number">10</span> ) / <span class="number">2</span> :</span><br><span class="line">      ( <span class="number">2</span> - <span class="built_in">Math</span>.pow( <span class="number">2</span>, <span class="number">-20</span> * p + <span class="number">10</span> ) ) / <span class="number">2</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInCirc(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> - <span class="built_in">Math</span>.sqrt( <span class="number">1</span> - <span class="built_in">Math</span>.pow( p, <span class="number">2</span> ) );</span><br><span class="line">  &#125;,</span><br><span class="line">  easeOutCirc(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Math</span>.sqrt( <span class="number">1</span> - <span class="built_in">Math</span>.pow( p - <span class="number">1</span>, <span class="number">2</span> ) );</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInOutCirc(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p &lt; <span class="number">0.5</span> ?</span><br><span class="line">      ( <span class="number">1</span> - <span class="built_in">Math</span>.sqrt( <span class="number">1</span> - <span class="built_in">Math</span>.pow( <span class="number">2</span> * p, <span class="number">2</span> ) ) ) / <span class="number">2</span> :</span><br><span class="line">      ( <span class="built_in">Math</span>.sqrt( <span class="number">1</span> - <span class="built_in">Math</span>.pow( <span class="number">-2</span> * p + <span class="number">2</span>, <span class="number">2</span> ) ) + <span class="number">1</span> ) / <span class="number">2</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInElastic(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p === <span class="number">0</span> ? <span class="number">0</span> : p === <span class="number">1</span> ? <span class="number">1</span> :</span><br><span class="line">      -<span class="built_in">Math</span>.pow( <span class="number">2</span>, <span class="number">10</span> * p - <span class="number">10</span> ) * <span class="built_in">Math</span>.sin( ( p * <span class="number">10</span> - <span class="number">10.75</span> ) * c4 );</span><br><span class="line">  &#125;,</span><br><span class="line">  easeOutElastic(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p === <span class="number">0</span> ? <span class="number">0</span> : p === <span class="number">1</span> ? <span class="number">1</span> :</span><br><span class="line">      <span class="built_in">Math</span>.pow( <span class="number">2</span>, <span class="number">-10</span> * p ) * <span class="built_in">Math</span>.sin( ( p * <span class="number">10</span> - <span class="number">0.75</span> ) * c4 ) + <span class="number">1</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInOutElastic(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p === <span class="number">0</span> ? <span class="number">0</span> : p === <span class="number">1</span> ? <span class="number">1</span> : p &lt; <span class="number">0.5</span> ?</span><br><span class="line">      -( <span class="built_in">Math</span>.pow( <span class="number">2</span>, <span class="number">20</span> * p - <span class="number">10</span> ) * <span class="built_in">Math</span>.sin( ( <span class="number">20</span> * p - <span class="number">11.125</span> ) * c5 )) / <span class="number">2</span> :</span><br><span class="line">      <span class="built_in">Math</span>.pow( <span class="number">2</span>, <span class="number">-20</span> * p + <span class="number">10</span> ) * <span class="built_in">Math</span>.sin( ( <span class="number">20</span> * p - <span class="number">11.125</span> ) * c5 ) / <span class="number">2</span> + <span class="number">1</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInBack(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> c3 * p * p * p - c1 * p * p;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeOutBack(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> + c3 * <span class="built_in">Math</span>.pow( p - <span class="number">1</span>, <span class="number">3</span> ) + c1 * <span class="built_in">Math</span>.pow( p - <span class="number">1</span>, <span class="number">2</span> );</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInOutBack(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p &lt; <span class="number">0.5</span> ?</span><br><span class="line">      ( <span class="built_in">Math</span>.pow( <span class="number">2</span> * p, <span class="number">2</span> ) * ( ( c2 + <span class="number">1</span> ) * <span class="number">2</span> * p - c2 ) ) / <span class="number">2</span> :</span><br><span class="line">      ( <span class="built_in">Math</span>.pow( <span class="number">2</span> * p - <span class="number">2</span>, <span class="number">2</span> ) *( ( c2 + <span class="number">1</span> ) * ( p * <span class="number">2</span> - <span class="number">2</span> ) + c2 ) + <span class="number">2</span> ) / <span class="number">2</span>;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInBounce(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> - bounceOut( <span class="number">1</span> - p );</span><br><span class="line">  &#125;,</span><br><span class="line">  easeOutBounce(p) &#123;</span><br><span class="line">    <span class="keyword">var</span> n1 = <span class="number">7.5625</span>,</span><br><span class="line">      d1 = <span class="number">2.75</span>;</span><br><span class="line">    <span class="keyword">if</span> ( p &lt; <span class="number">1</span> / d1 ) &#123;</span><br><span class="line">      <span class="keyword">return</span> n1 * p * p;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( p &lt; <span class="number">2</span> / d1 ) &#123;</span><br><span class="line">      <span class="keyword">return</span> n1 * (p -= (<span class="number">1.5</span> / d1)) * p + <span class="number">0.75</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( p &lt; <span class="number">2.5</span> / d1 ) &#123;</span><br><span class="line">      <span class="keyword">return</span> n1 * (p -= (<span class="number">2.25</span> / d1)) * p + <span class="number">0.9375</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> n1 * (p-=(<span class="number">2.625</span>/d1))*p + <span class="number">0.984375</span>;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">  easeInOutBounce(p)&#123;</span><br><span class="line">    <span class="keyword">return</span> p &lt; <span class="number">0.5</span> ?</span><br><span class="line">      ( <span class="number">1</span> - bounceOut( <span class="number">1</span> - <span class="number">2</span> * p ) ) / <span class="number">2</span> :</span><br><span class="line">      ( <span class="number">1</span> + bounceOut( <span class="number">2</span> * p - <span class="number">1</span> ) ) / <span class="number">2</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>关于各式缓动函数的由来、及其与贝塞尔曲线的关系，笔者暂时没能力加以分析。</p>
<h3 id="requestAnimationFrame"><a href="#requestAnimationFrame" class="headerlink" title="requestAnimationFrame"></a>requestAnimationFrame</h3><p>有了缓动函数，就需要通过定时器运作动画脚本，间隔 25 毫秒刷新元素的显示样式。通常，我们会使用 setInterval 函数创建定时器，但在这种情况下，当页面上有多个动画脚本时，创建的多个定时器无疑会影响性能，就容易造成动画的执行延时。为了优化性能，我们可借助于创建队列的方式，把待执行的动画脚本添加到队列中，再使用单个定时器在 25 毫秒取出队列中的函数加以执行。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> millisec = <span class="number">25</span>;</span><br><span class="line"><span class="keyword">const</span> queue = <span class="keyword">new</span> <span class="built_in">Map</span>();</span><br><span class="line"><span class="keyword">const</span> uuid = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">animate</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  [...queue.values()].map(<span class="function"><span class="params">fn</span> =&gt;</span> &#123;</span><br><span class="line">    fn(<span class="keyword">new</span> <span class="built_in">Date</span>);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">window</span>.setInterval(animate, millisec);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> request = <span class="function"><span class="params">handler</span> =&gt;</span> &#123;</span><br><span class="line">  uuid++;</span><br><span class="line">  queue.set(uuid, handler);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> uuid;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> cancel = <span class="function"><span class="params">id</span> =&gt;</span> &#123;</span><br><span class="line">  queue.delete(id);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> &#123;</span><br><span class="line">  request,</span><br><span class="line">  cancel</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>对于上述 js 代码，浏览器端提供的 requestAnimationFrame 接口也实现了相同的功能，由浏览器管控 dom 渲染的时机、事件队列等，刷新率为 60 帧左右，不能快进，也不能放慢，不适用于帧率要求较高的动画，如游戏等。requestAnimationFrame 函数的返回值为 ID，可用于终止动画；通过调用 cancelAnimationFrame 接口的方式。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getAnimationFrame</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; </span><br><span class="line">    requestAnimationFrame, cancelAnimationFrame, </span><br><span class="line">    mozRequestAnimationFrame, mozCancelAnimationFrame, </span><br><span class="line">    webiketRequestAnimationFrame, webkitCancelAnimationFrame </span><br><span class="line">  &#125; = <span class="built_in">window</span>;</span><br><span class="line">  <span class="keyword">const</span> EmptyFunction = <span class="function"><span class="params">timestamp</span> =&gt;</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// IE10, Chrome24</span></span><br><span class="line">  <span class="keyword">if</span> ( requestAnimationFrame )&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      request: requestAnimationFrame,</span><br><span class="line">      cancel: cancelAnimationFrame</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// FireFox 11 以下没有实现 mozCancelAnimationFrame 接口</span></span><br><span class="line">  <span class="comment">// 且 mozRequestAnimationFrame 接口只用于触发 'MozBeforePaint' 事件</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( mozRequestAnimationFrame &amp;&amp; mozCancelAnimationFrame )&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      request: mozRequestAnimationFrame,</span><br><span class="line">      cancel: mozCancelAnimationFrame</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// webkit 某个版本没有返回 id，动画不能清除</span></span><br><span class="line">  <span class="comment">// webkit 某个版本没有给动画函数注入 time 参数</span></span><br><span class="line">  <span class="comment">// webkit 早期版本使用 webkitCancelRequestAnimationFrame 清除动画</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( webiketRequestAnimationFrame &amp;&amp; webiketRequestAnimationFrame(EmptyFunction) )&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      request: <span class="function"><span class="params">fn</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> webiketRequestAnimationFrame(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">return</span> fn(<span class="keyword">new</span> <span class="built_in">Date</span>);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;,</span><br><span class="line">      cancel: webkitCancelAnimationFrame || webkitCancelRequestAnimationFrame</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h4><p>除了 setInterval, requestAnimationFrame 方法，还可以借助 setTimeout 函数（通过递归调用）、postMessage 异步方法（同 setImmediate 函数，在所有页面脚本执行完成后被调用，通过 addEventListener 方法监听 ‘message’ 事件）实现动画，IE10 还可以借助 setImmediate 方法。</p>
<p>通过自制脚本，可以侦测 setInterval, setTimeout, requestAnimationFrame, postMessage 诸方法在 1s 时间内的最小帧数，最大帧数以及平均帧数，并以图形化界面输出。关于这部分内容，可参考司徒正美的《Javascript 框架设计》一书第 381 页。笔者不作详谈。</p>
<p>关于 setImmediate 方法以及 node 端 process.nextTick 方法的实现原理，笔者将在后续的文章中加以分析。</p>
<h3 id="动画队列"><a href="#动画队列" class="headerlink" title="动画队列"></a>动画队列</h3><p>动画队列是指以联动方式组织同一个元素的动画流程，当前一个动画执行完成后，再执行下一个动画。</p>
<h2 id="jQuery-基础"><a href="#jQuery-基础" class="headerlink" title="jQuery 基础"></a>jQuery 基础</h2><p>这部分内容将介绍 jQuery/effects 动画模块所涉及的 jQuery 接口。关于这些接口的实现，读者可参详网上内容。当然，笔者也将在后续的文章加以详谈。</p>
<h3 id="Promise-对象"><a href="#Promise-对象" class="headerlink" title="Promise 对象"></a>Promise 对象</h3><p>$.deferred 方法用于创建 Promise 延迟对象。该Promise 对象中，promise 方法，可以为 Promise 对象添加额外的属性和方法；progress, done, fail, always 方法可用于挂载回调函数；notifyWith, resolveWith, rejectWith 方法用于触发回调函数的执行。</p>
<p>Promise 对象在动效模块中的表现就是在动画执行期间或动画执行完成后，触发特定回调函数的执行。</p>
<p>在 jQuery 动效源码中，我们也将看到嵌套使用 promise.done 方法（defaultPrefilter 函数中嵌套使用 anim.always 方法，以清除缓存中的 queue 属性），以确保某个回调函数必然最后执行。因为该回调函数在包裹它的回调执行期间，被添加回调队列中，也就是回调队列中的最后一项。</p>
<h3 id="css-操作"><a href="#css-操作" class="headerlink" title="css 操作"></a>css 操作</h3><p>$.css(prop, [val]) 方法用于获取或设置元素的显示样式。</p>
<p>$.cssHooks 集合形式，为指定 css 样式设置 $.css 方法的执行逻辑，如 $.cssHooks.borderRadius 是为对圆角进行处理，其值为 { get: (elem, computed, extra) =&gt; {}, set: (elem, value) =&gt; {}, expand: value =&gt; {} } 形式的对象。其中，get, set 方法影响 css 样式的取值、赋值操作，expand 方法对样式的值进行处理。</p>
<p>adjustCSS(elem, prop, valueParts, tween)，内部方法，转换并获得待设置的 css 样式值。参数 valueParts 为新设置的 css 属性，包含 +/- 符号、数值和单位，有两种设定形式，包含 +/- 号时，在原值上累加；不包含，取 valueParts 中的数值作为新的样式值。在第一种情形下，valueParts 中的单位若与获取到的样式值的原单位不符，需要将原样式值转换为新单位下的相应值。参数 tween 在动画情形中使用，其 cur 方法用于获取当前样式值，在 adjustCSS 方法执行过程中，其 unit, start, end 属性将相应得到修正。</p>
<p>showHide(elems, showFlag)，内部方法，用于显式或隐藏元素。</p>
<h3 id="data-缓存"><a href="#data-缓存" class="headerlink" title="data 缓存"></a>data 缓存</h3><p>jQuery 中创建的 Data 实例，是通过挂载在特定的节点上实现的，又分为两类，第一类通过 dataPriv 函数创建私有的 Data 实例，第二类通过 dataUser 函数创建外部使用的 Data 实例。data 实例又包含 cache(owner), get(owner, key), set(owner, key, value), access(owner, key, [value]), remove(owner, key), hasData(owner) 方法，其中，参数 owner 为挂载缓存数据的对象，通常为节点。</p>
<p>当全量取出 data 缓存数据时（在不设定 key 键的情况下），作为引用对象，修改其值，也将影响缓存数据。这一点在 jQuery 动效源码中 defaultPrefilter 处理 queue 队列时有使用。</p>
<h3 id="queue-队列"><a href="#queue-队列" class="headerlink" title="queue 队列"></a>queue 队列</h3><p>jQuery.queue(elem, type, data) 方法通过 dataPriv 数据缓存创建、添加或获取以 <code>${queueName}queue</code> 为主键的函数队列。</p>
<p>jQuery.dequeue(elem, type) 方法取出 <code>${queueName}queue</code> 函数队列中首个函数并执行。每个队列函数获得的参数为 elem, next, hooks，其中，next 借助于 jQuery.dequeue 方法执行第二个队列函数，hooks 为 <code>${queueName}queueHooks</code> 钩子函数集合。当 type 为默认的 ‘fx’ 时，在队列顶端插入 ‘inprogress’ 字符串，标记当前有队列函数在执行中，阻止 $.queue 方法运作过程取出首个队列函数并执行，而只能通过 $.dequeue 或 jQuery.dequeue 方法执行队列函数。不得不说，jQuery 中的多态性、各模块间的耦合度几至于芜杂，并不简单明朗，也许借助于类的方式可以写得更为晓畅明白。</p>
<p>jQuery._queueHooks(elem, type) 方法取出 <code>${queueName}queueHooks</code> 钩子函数集合，或其默认值。默认的钩子函数集合只包含 empty 方法，即如前所述，其用于从 dataPriv 缓存中移除 <code>${queueName}queue</code> 属性。</p>
<p>$.queue(queueName, [queue || callback]) 创建、添加或获取 <code>${queueName}queue</code> 函数队列。当添加队列函数时，其会调用 jQuery.dequeue 取出居于首位的队列函数并执行，若其取出的 <code>${queueName}queue</code> 首项不是 ‘inprogress’ 字符串。</p>
<p>$.dequeue(queueName) 方法从 <code>${queueName}queue</code> 函数队列中取出顶端的函数并执行，且下一个队列函数将作为参数 next 传入前一个队列函数中，queue 缓存数据则会即时移除该顶端函数；所有队列函数取出执行后，调用 <code>${queueName}queueHooks</code> 钩子函数集合中的 empty 方法，用于从 dataPriv 缓存中移除 <code>${queueName}queue</code> 属性。</p>
<p>$.clearQueue(queueName) 方法用于清空 <code>${queueName}queue</code> 函数队列。</p>
<p>queue 队列在动效模块中的表现就是组织动画队列。jQuery 的动画可分为两种情形，其一立即执行，多个动画也将并行执行，其二使用动画队列，挨个执行。jQuery 默认使用动画队列方式处理动效。</p>
<p>使用 $.queue 方法添加动画函数时，默认首个动画会立即执行。当再度调用 $.queue 方法添加第二个动画函数时，因为其从 queue 队列中取出的首项为 ‘inprogress’ 字符串（将阻止通过 $.queue 执行首个队列函数，而只能采用 jQuery.dequeue 方法予以执行），第二个动画函数在 $.queue 方法执行期间得不到执行。若在此时，第一个动画函数执行完成后的回调中使用 jQuery.dequeue 方法，则将触发第二个动画函数的执行。按上述实现，在动画执行结束后，因为有 ‘inprogress’ 字符串存储在队列中，无论调用 $.queue 还是 $.animate 方法添加队列函数，都将不能自动执行。这是 jQuery 队列中的诡异现象，需要调用 jQuery.dequeue 方法或者清除队列，才能使 $.queue, $.animate 方法添加的队列函数不再被阻塞。源码参见下文。</p>
<p>下文中，queue 队列指代本节中的 <code>${queueName}queue</code> 函数队列，queueHooks 钩子函数集合指代 <code>${queueName}queueHooks</code> 钩子函数集合，queueHooks.empty 指代钩子函数集合中的 empty 方法，dataPriv.queue 指代 dataPriv[<code>${queueName}queue</code>] 队列函数。</p>
<h2 id="动效模块设计"><a href="#动效模块设计" class="headerlink" title="动效模块设计"></a>动效模块设计</h2><p>jQuery 对动效模块的设计中，首先映入眼帘的是 Animation 函数，其基本骨架是以 deferred 模块组织异步逻辑。其中，tick 内含定时任务函数用于计算动画已执行时长百分比，并触发挂载在 promise 对象上的 progress, done, fail 回调函数的执行；animation 内部变量既包含基本的动画属性和方法，又兼有 promise 对象的属性和方法，随后通过该 animation 对象挂载 progress, done, fail 回调。</p>
<p>在 Animation 函数中，propFilter 函数用于转换 Animation 函数参数中的样式配置项及缓动配置项；Animation.prefilters 数组为动画执行前的一组预处理函数，既能影响应用于动画上的一些属性，又能通过 animation 的 progress, done, fail, always 方法影响异步回调。默认的 defaultPrefilter 函数用于清空 queue 队列，以及对显示隐藏动画作特殊处理。</p>
<p>tick 定时任务通过 jQuery.fx.timer 函数执行，其实现是添加到 jQuery.timers 动画队列中，由 schedule 调度函数通过 window.requestAnimationFrame 方法或 window.setTimeout 函数在一定时间内取出执行。所以，jQuery 中所有动画可理解为均借助于单个定时器实现。在 schedule 函数调度实现的基础上，jQuery 中所有动画可以通过 jQuery.fx.stop 函数终止动画的运作。</p>
<p>以上描述均不涉及 jQuery 动画中的样式变更凭何实现，那么 jQuery 动画中的样式变更到底是怎么实现的呢？原来在定时任务 tick 执行过程中，jQuery 会取出 animation.tweens 数组并执行数组项的 run 方法。tween 又是怎样一个概念呢？tween 针对单个 css 样式属性，通过当前样式值及动画已执行时长计算待调整的样式值，并对元素的样式做出调整。因此在 Animation 函数的实现中，程序首先将遍历待变更的 css 样式属性创建 tween；当 jQuery.fx.timer 函数触发 tick 定时任务函数执行时，在 tick 函数执行过程中，将遍历 tween 数组并执行其 run 方法，促使元素的样式得到更新。</p>
<p>以上内容，可以分为三个板块：</p>
<ol>
<li><p>以 jQuery.fx.timer 等函数为核心的定时任务调用机制。</p>
</li>
<li><p>Tween 实例的创建和执行。其执行过程中，将使用缓动函数更新节点样式。</p>
</li>
<li><p>基于 promise 实现的 Animation 函数，其将创建 tick 定时任务，添加 promise 回调，设置回调的执行时机。抛开这些，Animation 函数还将对参数作适当的转化处理，并执行 prefilter 预处理器。</p>
</li>
</ol>
<p>基于以上三点，就能实现单个元素的动画效果，但是没有涉及动画队列。虽然在 jQuery 中，对队列函数的控制主要在 queue 模块中，而 effects 动效模块与此交互的部分却落在接口层，如 $.animate, $.stop, $.finish 方法的实现中。这在实现部分将予以详述。</p>
<img src="/2018/06/13/jquery/动效分析/effects.png">
<h2 id="动效模块实现"><a href="#动效模块实现" class="headerlink" title="动效模块实现"></a>动效模块实现</h2><h3 id="jQuery-fx-timer-定时任务"><a href="#jQuery-fx-timer-定时任务" class="headerlink" title="jQuery.fx.timer 定时任务"></a>jQuery.fx.timer 定时任务</h3><p>当有定时任务 timer 函数，通过 jQuery.fx.timer 函数存入 jQuery.timers 定时任务队列中，再调用 jQuery.fx.start 函数，以启动定时任务调用程序。当用户反复调用 jQuery.fx.timer 函数时，为了避免定时任务调用程序多次执行，jQuery.fx.start 函数中带有 inProgress 标识。当定时任务调用程序已启动，inProgress 标识置为真值，实际的调度函数 schedule 将不再被重复调用。</p>
<p>通过 jQuery.fx.start 函数调用的调度函数 schedule 中，或者借助于 window.requestAnimationFrame 方法或者借助于 window.setTimeout 方法，以在间隔一定时间内递归调用 schedule 函数，从而触发 jQuery.fx.tick 函数的执行。</p>
<p>jQuery.fx.tick 函数中，程序将取出 jQuery.timers 队列中的所有定时任务并同步执行执行，若定时任务返回否值，则将其从 jQuery.timers 队列中移除。即当某个定时任务返回真值时，该定时任务将在一定时间间隔后再次被调用，直到其返回否值。</p>
<p>借助于 inProgress 标识为真值时，实际的调度函数 schedule 才会遍历 jQuery.timers 队列中的定时任务并予以执行，jQuery.fx.stop 方法通过将 inProgress 标识置为 null 的方式，可用于终止定时任务调用程序。而在 schedule 调度函数的执行逻辑中，当 jQuery.timers 队列已清空，也会通过调用 jQuery.fx.stop 方法，将 inProgress 标识置为 null。</p>
<p>在 jQuery 动画模块中，作为 timer 定时任务函数的是，Animation 函数体内创建的 tick 函数，其执行逻辑为在动画执行期间更新样式并触发 progress 回调，在动画完成后触发 done, fail 回调。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> fxNow;</span><br><span class="line">jQuery.timers = [];</span><br><span class="line">jQuery.fx.interval = <span class="number">13</span>;</span><br><span class="line"></span><br><span class="line">jQuery.fx.timer = <span class="function"><span class="keyword">function</span>(<span class="params"> timer </span>) </span>&#123;</span><br><span class="line">	jQuery.timers.push( timer );</span><br><span class="line">	jQuery.fx.start();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">jQuery.fx.start = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ( inProgress ) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	inProgress = <span class="literal">true</span>;</span><br><span class="line">	schedule();</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">schedule</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> ( inProgress ) &#123;</span><br><span class="line">		<span class="keyword">if</span> ( <span class="built_in">document</span>.hidden === <span class="literal">false</span> &amp;&amp; <span class="built_in">window</span>.requestAnimationFrame ) &#123;</span><br><span class="line">			<span class="built_in">window</span>.requestAnimationFrame( schedule );</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="built_in">window</span>.setTimeout( schedule, jQuery.fx.interval );</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		jQuery.fx.tick();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jQuery.fx.tick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> timer,</span><br><span class="line">		i = <span class="number">0</span>,</span><br><span class="line">		timers = jQuery.timers;</span><br><span class="line"></span><br><span class="line">	fxNow = <span class="built_in">Date</span>.now();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> ( ; i &lt; timers.length; i++ ) &#123;</span><br><span class="line">		timer = timers[ i ];</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Run the timer and safely remove it when done (allowing for external removal)</span></span><br><span class="line">		<span class="keyword">if</span> ( !timer() &amp;&amp; timers[ i ] === timer ) &#123;</span><br><span class="line">			timers.splice( i--, <span class="number">1</span> );</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( !timers.length ) &#123;</span><br><span class="line">		jQuery.fx.stop();</span><br><span class="line">	&#125;</span><br><span class="line">	fxNow = <span class="literal">undefined</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">jQuery.fx.stop = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">	inProgress = <span class="literal">null</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="Tween-样式更新"><a href="#Tween-样式更新" class="headerlink" title="Tween 样式更新"></a>Tween 样式更新</h3><h4 id="Tween-构造函数"><a href="#Tween-构造函数" class="headerlink" title="Tween 构造函数"></a>Tween 构造函数</h4><p>Tween 在实例化过程中，首先记录关联的节点 this.elem、待更新的样式属性 this.prop、缓动函数类型 this.easing、选项 this.options（包含动画执行时长 duration、步进函数 step = (currentStyle, tween) =&gt; {}。其中，步进函数执行时的上下文为节点元素，即 this.elem），随后计算起始样式值 this.start，并记录结束样式值 this.end、样式的单位 this.unit。</p>
<p>在 Tween 实例的 run 方法中，将更新节点的样式值。其实现的具体逻辑为，根据传参动 percent 画已执行时长百分比，通过缓动函数 eased = fn(percent, duration * percent, 0, 1, duration)，计算样式已变更值占所需变更值的百分比 eased，并存入 this.pos 属性中，由此获得新的样式值 this.now。（缓动函数见前文）</p>
<p>在 Tween 实例的执行逻辑中，jQuery 额外构建了一套节点样式取值、赋值机制，即通过 Tween.propHooks 样式处理集合进行操作。其所需面对的一种情形是，this.elem 不是节点元素，或者指定的样式属性 this.prop 不是节点所有的属性，来自于用户自定义。在这种情况下，Tween.propHooks 作为一种钩子处理集合，将截获样式的获取和赋值，由 elem 引用对象以 elem[this.prop] = this.now 的形式存储待更新的样式。同时针对 IE 9 及其以下浏览器，scrollTop 作为特殊的样式，其样式赋值操作将直接作用于 elem 元素，而不是 elem.style 样式集合中。</p>
<p>与此同时，若用户在 jQuery.fx.step 步进函数集合中注册了针对某一个样式的特殊行为，样式赋值操作将只唤醒该行为，而不会对节点 this.elem 进行处理。如需对 this.elem 节点的样式进行处理，仍需要由用户承担额外的开发工作。</p>
<p>关于选项中的步进函数 options.step，其可用于以日志形式记录待更新样式的值、或者在样式更新的某个值上作特殊处理。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Tween</span>(<span class="params"> elem, options, prop, end, easing </span>) </span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> Tween.prototype.init( elem, options, prop, end, easing );</span><br><span class="line">&#125;</span><br><span class="line">jQuery.Tween = Tween;</span><br><span class="line"></span><br><span class="line">Tween.prototype = &#123;</span><br><span class="line">	<span class="keyword">constructor</span>: Tween,</span><br><span class="line">	init: function( elem, options, prop, end, easing, unit ) &#123;</span><br><span class="line">		<span class="keyword">this</span>.elem = elem;</span><br><span class="line">		<span class="keyword">this</span>.prop = prop;</span><br><span class="line">		<span class="keyword">this</span>.easing = easing || jQuery.easing._default;</span><br><span class="line">		<span class="keyword">this</span>.options = options;</span><br><span class="line">		<span class="keyword">this</span>.start = <span class="keyword">this</span>.now = <span class="keyword">this</span>.cur();</span><br><span class="line">		<span class="keyword">this</span>.end = end;</span><br><span class="line">		<span class="keyword">this</span>.unit = unit || ( jQuery.cssNumber[ prop ] ? <span class="string">""</span> : <span class="string">"px"</span> );</span><br><span class="line">	&#125;,</span><br><span class="line">	cur: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">var</span> hooks = Tween.propHooks[ <span class="keyword">this</span>.prop ];</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> hooks &amp;&amp; hooks.get ?</span><br><span class="line">			hooks.get( <span class="keyword">this</span> ) :</span><br><span class="line">			Tween.propHooks._default.get( <span class="keyword">this</span> );</span><br><span class="line">	&#125;,</span><br><span class="line">	run: <span class="function"><span class="keyword">function</span>(<span class="params"> percent </span>) </span>&#123;</span><br><span class="line">		<span class="keyword">var</span> eased,</span><br><span class="line">			hooks = Tween.propHooks[ <span class="keyword">this</span>.prop ];</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( <span class="keyword">this</span>.options.duration ) &#123;</span><br><span class="line">			<span class="keyword">this</span>.pos = eased = jQuery.easing[ <span class="keyword">this</span>.easing ](</span><br><span class="line">				percent, <span class="keyword">this</span>.options.duration * percent, <span class="number">0</span>, <span class="number">1</span>, <span class="keyword">this</span>.options.duration</span><br><span class="line">			);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			<span class="keyword">this</span>.pos = eased = percent;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">this</span>.now = ( <span class="keyword">this</span>.end - <span class="keyword">this</span>.start ) * eased + <span class="keyword">this</span>.start;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( <span class="keyword">this</span>.options.step ) &#123;</span><br><span class="line">			<span class="keyword">this</span>.options.step.call( <span class="keyword">this</span>.elem, <span class="keyword">this</span>.now, <span class="keyword">this</span> );</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( hooks &amp;&amp; hooks.set ) &#123;</span><br><span class="line">			hooks.set( <span class="keyword">this</span> );</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			Tween.propHooks._default.set( <span class="keyword">this</span> );</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">Tween.prototype.init.prototype = Tween.prototype;</span><br><span class="line"></span><br><span class="line">Tween.propHooks = &#123;</span><br><span class="line">	_default: &#123;</span><br><span class="line">		get: <span class="function"><span class="keyword">function</span>(<span class="params"> tween </span>) </span>&#123;</span><br><span class="line">			<span class="keyword">var</span> result;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Use a property on the element directly when it is not a DOM element,</span></span><br><span class="line">			<span class="comment">// or when there is no matching style property that exists.</span></span><br><span class="line">			<span class="keyword">if</span> ( tween.elem.nodeType !== <span class="number">1</span> ||</span><br><span class="line">				tween.elem[ tween.prop ] != <span class="literal">null</span> &amp;&amp; tween.elem.style[ tween.prop ] == <span class="literal">null</span> ) &#123;</span><br><span class="line">				<span class="keyword">return</span> tween.elem[ tween.prop ];</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Passing an empty string as a 3rd parameter to .css will automatically</span></span><br><span class="line">			<span class="comment">// attempt a parseFloat and fallback to a string if the parse fails.</span></span><br><span class="line">			<span class="comment">// Simple values such as "10px" are parsed to Float;</span></span><br><span class="line">			<span class="comment">// complex values such as "rotate(1rad)" are returned as-is.</span></span><br><span class="line">			result = jQuery.css( tween.elem, tween.prop, <span class="string">""</span> );</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Empty strings, null, undefined and "auto" are converted to 0.</span></span><br><span class="line">			<span class="keyword">return</span> !result || result === <span class="string">"auto"</span> ? <span class="number">0</span> : result;</span><br><span class="line">		&#125;,</span><br><span class="line">		set: <span class="function"><span class="keyword">function</span>(<span class="params"> tween </span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Use step hook for back compat.</span></span><br><span class="line">			<span class="comment">// Use cssHook if its there.</span></span><br><span class="line">			<span class="comment">// Use .style if available and use plain properties where available.</span></span><br><span class="line">			<span class="keyword">if</span> ( jQuery.fx.step[ tween.prop ] ) &#123;</span><br><span class="line">				jQuery.fx.step[ tween.prop ]( tween );</span><br><span class="line">			&#125; <span class="keyword">else</span> <span class="keyword">if</span> ( tween.elem.nodeType === <span class="number">1</span> &amp;&amp;</span><br><span class="line">				( tween.elem.style[ jQuery.cssProps[ tween.prop ] ] != <span class="literal">null</span> ||</span><br><span class="line">					jQuery.cssHooks[ tween.prop ] ) ) &#123;</span><br><span class="line">				jQuery.style( tween.elem, tween.prop, tween.now + tween.unit );</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				tween.elem[ tween.prop ] = tween.now;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Support: IE &lt;=9 only</span></span><br><span class="line"><span class="comment">// Panic based approach to setting things on disconnected nodes</span></span><br><span class="line">Tween.propHooks.scrollTop = Tween.propHooks.scrollLeft = &#123;</span><br><span class="line">	set: <span class="function"><span class="keyword">function</span>(<span class="params"> tween </span>) </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> ( tween.elem.nodeType &amp;&amp; tween.elem.parentNode ) &#123;</span><br><span class="line">			tween.elem[ tween.prop ] = tween.now;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">jQuery.easing = &#123;</span><br><span class="line">	linear: <span class="function"><span class="keyword">function</span>(<span class="params"> p </span>) </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> p;</span><br><span class="line">	&#125;,</span><br><span class="line">	swing: <span class="function"><span class="keyword">function</span>(<span class="params"> p </span>) </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0.5</span> - <span class="built_in">Math</span>.cos( p * <span class="built_in">Math</span>.PI ) / <span class="number">2</span>;</span><br><span class="line">	&#125;,</span><br><span class="line">	_default: <span class="string">"swing"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Back compat &lt;1.8 extension point</span></span><br><span class="line">jQuery.fx.step = &#123;&#125;;</span><br></pre></td></tr></table></figure>
<h4 id="创建-Tween-实例"><a href="#创建-Tween-实例" class="headerlink" title="创建 Tween 实例"></a>创建 Tween 实例</h4><p>不得不说，jQuery 有五花八门的拦截机制，部分是为了满足吊诡的开发需要，部分是为了便于对 jQuery 作一层封装。其实既不借助于事件系统，也不像 webpack 那样采用回调链的方式（适用于异步形式，可以拦截后续的流程），而是使用注册 hooks 集合，针对属性对原始行为作一些拓展。Tween 构造函数中如此，创建 Tween 实例也是如此。</p>
<p>在 Animation 函数中，jQuery 将针对每个待调整的样式属性创建各自的 Tween 实例，默认采用 animition.createTween 方法。这一过程由 Animation.tweeners[ “<em>“ ] 方法实现，当样式值带有 +, - 号时，adjustCSS 用于调整结束样式。除此之外，用户可以使用 Animation.tweener(callback) 方法改变 Animation.tweeners[ “</em>“ ] 方法的行为，或者使用 Animation.tweener(prop, callback) 方法创建自定义的 tween，用于变更样式值。</p>
<p>需要指明的一点是，只要调用 createTween 函数，就会将新创建的 tween 添加到 animation.tweens 数组中，动画执行期间，均会刷新样式。jQuery 源码中，创建 tween 的时机有两个，其一在 Animation 函数中根据待变更的样式创建 tween，其二在 defaultPrefilter 预处理器中针对 slideUp 等动效，用于处理元素的宽高属性更新。源码见下文。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createTween</span>(<span class="params"> value, prop, animation </span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> tween,</span><br><span class="line">		collection = ( Animation.tweeners[ prop ] || [] ).concat( Animation.tweeners[ <span class="string">"*"</span> ] ),</span><br><span class="line">		index = <span class="number">0</span>,</span><br><span class="line">		length = collection.length;</span><br><span class="line">	<span class="keyword">for</span> ( ; index &lt; length; index++ ) &#123;</span><br><span class="line">		<span class="keyword">if</span> ( ( tween = collection[ index ].call( animation, prop, value ) ) ) &#123;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// We're done with this property</span></span><br><span class="line">			<span class="keyword">return</span> tween;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Animation</span>(<span class="params"> elem, properties, options </span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">var</span> animation = deferred.promise( &#123;</span><br><span class="line">			tweens: [],</span><br><span class="line">			createTween: <span class="function"><span class="keyword">function</span>(<span class="params"> prop, end </span>) </span>&#123;</span><br><span class="line">				<span class="keyword">var</span> tween = jQuery.Tween( elem, animation.opts, prop, end,</span><br><span class="line">						animation.opts.specialEasing[ prop ] || animation.opts.easing );</span><br><span class="line">				animation.tweens.push( tween );</span><br><span class="line">				<span class="keyword">return</span> tween;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">		&#125; );</span><br><span class="line"></span><br><span class="line">  jQuery.map( props, createTween, animation );</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jQuery.Animation = jQuery.extend( Animation, &#123;</span><br><span class="line">	tweeners: &#123;</span><br><span class="line">		<span class="string">"*"</span>: [ <span class="function"><span class="keyword">function</span>(<span class="params"> prop, value </span>) </span>&#123;</span><br><span class="line">			<span class="keyword">var</span> tween = <span class="keyword">this</span>.createTween( prop, value );</span><br><span class="line">			adjustCSS( tween.elem, prop, rcssNum.exec( value ), tween );</span><br><span class="line">			<span class="keyword">return</span> tween;</span><br><span class="line">		&#125; ]</span><br><span class="line">	&#125;,</span><br><span class="line"></span><br><span class="line">	tweener: <span class="function"><span class="keyword">function</span>(<span class="params"> props, callback </span>) </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> ( isFunction( props ) ) &#123;</span><br><span class="line">			callback = props;</span><br><span class="line">			props = [ <span class="string">"*"</span> ];</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			props = props.match( rnothtmlwhite );</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">var</span> prop,</span><br><span class="line">			index = <span class="number">0</span>,</span><br><span class="line">			length = props.length;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">for</span> ( ; index &lt; length; index++ ) &#123;</span><br><span class="line">			prop = props[ index ];</span><br><span class="line">			Animation.tweeners[ prop ] = Animation.tweeners[ prop ] || [];</span><br><span class="line">			Animation.tweeners[ prop ].unshift( callback );</span><br><span class="line">		&#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="Animation-动画函数"><a href="#Animation-动画函数" class="headerlink" title="Animation 动画函数"></a>Animation 动画函数</h3><p>剥离 jQuery.fx.timer 定时任务执行机制和 Tween 样式变更机制后，Animation 函数的实现也极为简单。其主要逻辑为，借助 deferred 模块创建 promise 对象（其表现为 animation 对象），构建 tick 函数用于设置 promise 回调的执行时机以及调用 tween.run 方法更新样式，为 promise 对象设置回调函数。</p>
<p>在 animation 对象中，createTween 方法用于创建 tween，并存入 animation.tweens 数组中，动画执行期间，再取出数组项刷新元素样式。stop 方法通过将 stopped 置为 true，以终止动画，若其传参 gotoEnd 为真值，则逐个遍历 animation.tweens 数组，将动画执行到末端状态。stop 方法中触发回调的机制也由 gotoEnd 传参决定，若其为真，触发成功回调，反之，触发失败回调；回调参数带有 gotoEnd 标识。</p>
<p>除了设置 promise 回调相关内容、启动定时任务执行脚本外，Animation 函数还有一些预处理操作。其中，propFilter 对参数进行预处理；Animation.prefilters 对 queue 队列以及特殊样式进行预处理，其返回值中的 stop 方法将注册为 queueHooks 钩子函数集合的 stop 方法；选项 options.start 由用户对 animation 进行一些预处理操作。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Animation</span>(<span class="params"> elem, properties, options </span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> result,</span><br><span class="line">		stopped,</span><br><span class="line">		index = <span class="number">0</span>,</span><br><span class="line">		length = Animation.prefilters.length,</span><br><span class="line">		deferred = jQuery.Deferred().always( <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Don't match elem in the :animated selector</span></span><br><span class="line">			<span class="keyword">delete</span> tick.elem;</span><br><span class="line">		&#125; ),</span><br><span class="line">		tick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">			<span class="keyword">if</span> ( stopped ) &#123;</span><br><span class="line">				<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">var</span> currentTime = fxNow || createFxNow(),</span><br><span class="line">				remaining = <span class="built_in">Math</span>.max( <span class="number">0</span>, animation.startTime + animation.duration - currentTime ),</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Support: Android 2.3 only</span></span><br><span class="line">				<span class="comment">// Archaic crash bug won't allow us to use `1 - ( 0.5 || 0 )` (#12497)</span></span><br><span class="line">				temp = remaining / animation.duration || <span class="number">0</span>,</span><br><span class="line">				percent = <span class="number">1</span> - temp,</span><br><span class="line">				index = <span class="number">0</span>,</span><br><span class="line">				length = animation.tweens.length;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> ( ; index &lt; length; index++ ) &#123;</span><br><span class="line">				animation.tweens[ index ].run( percent );</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			deferred.notifyWith( elem, [ animation, percent, remaining ] );</span><br><span class="line"></span><br><span class="line">			<span class="comment">// If there's more to do, yield</span></span><br><span class="line">			<span class="keyword">if</span> ( percent &lt; <span class="number">1</span> &amp;&amp; length ) &#123;</span><br><span class="line">				<span class="keyword">return</span> remaining;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// If this was an empty animation, synthesize a final progress notification</span></span><br><span class="line">			<span class="keyword">if</span> ( !length ) &#123;</span><br><span class="line">				deferred.notifyWith( elem, [ animation, <span class="number">1</span>, <span class="number">0</span> ] );</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Resolve the animation and report its conclusion</span></span><br><span class="line">			deferred.resolveWith( elem, [ animation ] );</span><br><span class="line">			<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">		&#125;,</span><br><span class="line">		animation = deferred.promise( &#123;</span><br><span class="line">			elem: elem,</span><br><span class="line">			props: jQuery.extend( &#123;&#125;, properties ),</span><br><span class="line">			opts: jQuery.extend( <span class="literal">true</span>, &#123;</span><br><span class="line">				specialEasing: &#123;&#125;,</span><br><span class="line">				easing: jQuery.easing._default</span><br><span class="line">			&#125;, options ),</span><br><span class="line">			originalProperties: properties,</span><br><span class="line">			originalOptions: options,</span><br><span class="line">			startTime: fxNow || createFxNow(),</span><br><span class="line">			duration: options.duration,</span><br><span class="line">			tweens: [],</span><br><span class="line">			createTween: <span class="function"><span class="keyword">function</span>(<span class="params"> prop, end </span>) </span>&#123;</span><br><span class="line">				<span class="keyword">var</span> tween = jQuery.Tween( elem, animation.opts, prop, end,</span><br><span class="line">						animation.opts.specialEasing[ prop ] || animation.opts.easing );</span><br><span class="line">				animation.tweens.push( tween );</span><br><span class="line">				<span class="keyword">return</span> tween;</span><br><span class="line">			&#125;,</span><br><span class="line">			stop: <span class="function"><span class="keyword">function</span>(<span class="params"> gotoEnd </span>) </span>&#123;</span><br><span class="line">				<span class="keyword">var</span> index = <span class="number">0</span>,</span><br><span class="line"></span><br><span class="line">					<span class="comment">// If we are going to the end, we want to run all the tweens</span></span><br><span class="line">					<span class="comment">// otherwise we skip this part</span></span><br><span class="line">					length = gotoEnd ? animation.tweens.length : <span class="number">0</span>;</span><br><span class="line">				<span class="keyword">if</span> ( stopped ) &#123;</span><br><span class="line">					<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">				&#125;</span><br><span class="line">				stopped = <span class="literal">true</span>;</span><br><span class="line">				<span class="keyword">for</span> ( ; index &lt; length; index++ ) &#123;</span><br><span class="line">					animation.tweens[ index ].run( <span class="number">1</span> );</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Resolve when we played the last frame; otherwise, reject</span></span><br><span class="line">				<span class="keyword">if</span> ( gotoEnd ) &#123;</span><br><span class="line">					deferred.notifyWith( elem, [ animation, <span class="number">1</span>, <span class="number">0</span> ] );</span><br><span class="line">					deferred.resolveWith( elem, [ animation, gotoEnd ] );</span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					deferred.rejectWith( elem, [ animation, gotoEnd ] );</span><br><span class="line">				&#125;</span><br><span class="line">				<span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; ),</span><br><span class="line">		props = animation.props;</span><br><span class="line"></span><br><span class="line">	propFilter( props, animation.opts.specialEasing );</span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> ( ; index &lt; length; index++ ) &#123;</span><br><span class="line">		result = Animation.prefilters[ index ].call( animation, elem, props, animation.opts );</span><br><span class="line">		<span class="keyword">if</span> ( result ) &#123;</span><br><span class="line">			<span class="keyword">if</span> ( isFunction( result.stop ) ) &#123;</span><br><span class="line">				jQuery._queueHooks( animation.elem, animation.opts.queue ).stop =</span><br><span class="line">					result.stop.bind( result );</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">return</span> result;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	jQuery.map( props, createTween, animation );</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( isFunction( animation.opts.start ) ) &#123;</span><br><span class="line">		animation.opts.start.call( elem, animation );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Attach callbacks from options</span></span><br><span class="line">	animation</span><br><span class="line">		.progress( animation.opts.progress )</span><br><span class="line">		.done( animation.opts.done, animation.opts.complete )</span><br><span class="line">		.fail( animation.opts.fail )</span><br><span class="line">		.always( animation.opts.always );</span><br><span class="line"></span><br><span class="line">	jQuery.fx.timer(</span><br><span class="line">		jQuery.extend( tick, &#123;</span><br><span class="line">			elem: elem,</span><br><span class="line">			anim: animation,</span><br><span class="line">			queue: animation.opts.queue</span><br><span class="line">		&#125; )</span><br><span class="line">	);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> animation;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="propFilter"><a href="#propFilter" class="headerlink" title="propFilter"></a>propFilter</h4><p>propFilter 函数以引用对象形式对传参样式属性集合 props, 缓动函数类型集合 specialEasing 进行处理。首先，其将 props 属性转化为驼峰式书写形式，同时 props 属性的值支持以二元数组形式约定样式和缓动函数类型。其次，当传入的 props 属性作为复合属性、且在 jQuery.cssHooks 注册了预处理集合，且该集合中存在 expand 处理，传入的 props 属性的值将经过 expand 方法处理，由返回值定义该操作哪些样式。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">propFilter</span>(<span class="params"> props, specialEasing </span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> index, name, easing, value, hooks;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// camelCase, specialEasing and expand cssHook pass</span></span><br><span class="line">	<span class="keyword">for</span> ( index <span class="keyword">in</span> props ) &#123;</span><br><span class="line">		name = camelCase( index );</span><br><span class="line">		easing = specialEasing[ name ];</span><br><span class="line">		value = props[ index ];</span><br><span class="line">		<span class="keyword">if</span> ( <span class="built_in">Array</span>.isArray( value ) ) &#123;</span><br><span class="line">			easing = value[ <span class="number">1</span> ];</span><br><span class="line">			value = props[ index ] = value[ <span class="number">0</span> ];</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( index !== name ) &#123;</span><br><span class="line">			props[ name ] = value;</span><br><span class="line">			<span class="keyword">delete</span> props[ index ];</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		hooks = jQuery.cssHooks[ name ];</span><br><span class="line">		<span class="keyword">if</span> ( hooks &amp;&amp; <span class="string">"expand"</span> <span class="keyword">in</span> hooks ) &#123;</span><br><span class="line">			value = hooks.expand( value );</span><br><span class="line">			<span class="keyword">delete</span> props[ name ];</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Not quite $.extend, this won't overwrite existing keys.</span></span><br><span class="line">			<span class="comment">// Reusing 'index' because we have the correct "name"</span></span><br><span class="line">			<span class="keyword">for</span> ( index <span class="keyword">in</span> value ) &#123;</span><br><span class="line">				<span class="keyword">if</span> ( !( index <span class="keyword">in</span> props ) ) &#123;</span><br><span class="line">					props[ index ] = value[ index ];</span><br><span class="line">					specialEasing[ index ] = easing;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			specialEasing[ name ] = easing;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="Animation-prefilters"><a href="#Animation-prefilters" class="headerlink" title="Animation.prefilters"></a>Animation.prefilters</h4><p>jQuery.Animation.prefilters 作为预处理函数队列，可通过 jQuery.Animation.prefilter 添加，默认只有一个预处理函数 defaultPrefilter。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">jQuery.Animation = jQuery.extend( Animation, &#123;</span><br><span class="line">	prefilters: [ defaultPrefilter ],</span><br><span class="line"></span><br><span class="line">	prefilter: <span class="function"><span class="keyword">function</span>(<span class="params"> callback, prepend </span>) </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> ( prepend ) &#123;</span><br><span class="line">			Animation.prefilters.unshift( callback );</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			Animation.prefilters.push( callback );</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125; );</span><br></pre></td></tr></table></figure>
<p>defaultPrefilter 函数的处理内容有两块，其一针对即时执行的动画，当类型为 ‘fx’ 的 queue 队列的长度变为 0 时，也即队列等待执行的动画时，使用 queueHooks.empty 方法移除 dataPriv 中与当前 queue 相关的属性；其二针对 slideUp 等动效，不只元素的 display 属性需要在动画起始、结束时作特殊处理，元素的宽高等样式也需要通过计算获得。</p>
<p>对于内容一，有一点疑问，既然动画没有添加到 queue 队列中，为什么还要调用 queueHooks 钩子清除缓存中的数据呢？作为用于避免内存浪费的保证吗？</p>
<p>内容一的实现，在于缓存在元素上的 hooks.unqueued 标识，动画执行期间加 1，动画执行完成后减 1，由此可以判断所有动画是否均已执行完成。当 hooks.unqueued 标识重新变成 0 值时，且缓存中的 queue 队列长度也为 0，调用钩子集合中的 empty 方法，移除 dataPriv.queue 属性。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defaultPrefilter</span>(<span class="params"> elem, props, opts </span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> hooks, oldfire,</span><br><span class="line">		isBox = <span class="string">"width"</span> <span class="keyword">in</span> props || <span class="string">"height"</span> <span class="keyword">in</span> props,</span><br><span class="line">		anim = <span class="keyword">this</span>,</span><br><span class="line">		orig = &#123;&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Queue-skipping animations hijack the fx hooks</span></span><br><span class="line">	<span class="keyword">if</span> ( !opts.queue ) &#123;</span><br><span class="line">		hooks = jQuery._queueHooks( elem, <span class="string">"fx"</span> );</span><br><span class="line">		<span class="keyword">if</span> ( hooks.unqueued == <span class="literal">null</span> ) &#123;</span><br><span class="line">			hooks.unqueued = <span class="number">0</span>;</span><br><span class="line">			oldfire = hooks.empty.fire;</span><br><span class="line">			hooks.empty.fire = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">				<span class="keyword">if</span> ( !hooks.unqueued ) &#123;</span><br><span class="line">					oldfire();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;;</span><br><span class="line">		&#125;</span><br><span class="line">		hooks.unqueued++;</span><br><span class="line"></span><br><span class="line">		anim.always( <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Ensure the complete handler is called before this completes</span></span><br><span class="line">			anim.always( <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">				hooks.unqueued--;</span><br><span class="line">				<span class="keyword">if</span> ( !jQuery.queue( elem, <span class="string">"fx"</span> ).length ) &#123;</span><br><span class="line">					hooks.empty.fire();</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; );</span><br><span class="line">		&#125; );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>内容二的处理逻辑为，在 slideUp 等动效执行期间，需要对元素的显示动效作处理，从隐藏到显示或者从显示到隐藏；当动效包含宽高属性的变动时，需要将 display 从 ‘none’ 或 ‘inline’ 转换成 ‘inline-block’，以使 slideUp 等动效发生过程中，宽高样式能在视图中正常显示；当动效包含 overflow 属性变更时（作为参数 opts 选项的属性，而不像其他样式变更那样在 props 参数中），在动效执行期间，将元素的 overslow 属性设置 ‘hidden’，在动效执行完成后，再切换为配置值。</p>
<p>内容二的实现，借助于 dataShow 缓存数据，该缓存用于记录动效起始状态，其包含 display, hidden 属性，也包含 slideUp 等动效相关的 height, marginTop, paddingTop, [width] 属性。</p>
<p>dataShow.display 属性取决于元素本身的 display 样式。情形一，若其为 ‘none’，则尝试先将该元素展示在视图上，然后取其 display 样式，并存入 dataShow.display 缓存中。在这种情况下，缓存 dataShow.display 的意义在于，动画执行期间将元素的 display 样式设定为缓存值（当元素显示的 display 样式为 ‘inline’ 或 ‘inline-block’，进入情形二中的处理逻辑），以使动画得以展示。情形二，若其为 ‘inline’ 或 ‘inline-block’，dataShow.display 属性直接取元素的 display 样式。在这种情形下，缓存 dataShow.display 的意义在于，首次动画执行期间将元素的 display 样式设为 ‘inline-block’，以使 width 属性能正常变更；且对于 slideUp 等滑动、渐隐类特效（在源码中的表现为，传入 Animation 的参数为 { marginLeft: ‘show’ } 等形式），等动画执行结束后，元素的 display 样式仍回设为 dataShow.display 缓存值；当首次动画执行期间、再启动第二个动画时，则跳过上述处理逻辑、沿用第一个动画将 display 样式置为 ‘inline-block’ 的做法。</p>
<p>以上处理存在两个疑点。其一，上文也有指出，当元素包含除 slideUp 等类型以外的动效时，动画执行结束后，元素的 display 属性将定格为 ‘inline-block’，而不是初始的 ‘inline’。这种做法是为了满足下一个动画改变元素宽度的需求吗？其二，当第一个动画类型为 slideUp 等，在该动画执行期间插入第二个动画，当第一个动画执行完成后，元素的 display 样式将可能被设为 ‘inline’，这是否会影响第二个动画的执行？这种处理方式仍取决于动画通常以队列方式添加，而不是即时执行吗（即两个动画并行执行的可能很小）？</p>
<p>内容二中，最后的处理逻辑是，使用 dataShow 缓存记录元素的初始 height, marginTop, paddingTop, [width] 等属性（这些数据经 createTween 函数处理后获得），并在动画执行前后使用 display 属性切换元素的显示状态，这样就不会影响元素原有的宽高属性。与此同时，程序将使用 createTween 函数在 animation.tweens 数组中添加 tween，该 tween 用于在动画执行期间刷新元素的 height, marginTop, paddingTop, [width] 等属性，从而实现动画效果。</p>
<p>上述处理逻辑的设计，基于接口层面需实现 $.slideUp 等方法。如果以类的方式构造动画模块，可以用继承类实现 slideUp 等动效，而不需要像 jQuery 那样在一体化处理逻辑掺杂 slideUp 等动效的实现。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> rfxtypes = <span class="regexp">/^(?:toggle|show|hide)$/</span>；</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defaultPrefilter</span>(<span class="params"> elem, props, opts </span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> prop, value, toggle, propTween, restoreDisplay, display,</span><br><span class="line">		isBox = <span class="string">"width"</span> <span class="keyword">in</span> props || <span class="string">"height"</span> <span class="keyword">in</span> props,</span><br><span class="line">		anim = <span class="keyword">this</span>,</span><br><span class="line">		orig = &#123;&#125;,</span><br><span class="line">		style = elem.style,</span><br><span class="line">		hidden = elem.nodeType &amp;&amp; isHiddenWithinTree( elem ),</span><br><span class="line">		dataShow = dataPriv.get( elem, <span class="string">"fxshow"</span> );</span><br><span class="line"></span><br><span class="line">	<span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">// Detect show/hide animations</span></span><br><span class="line">	<span class="keyword">for</span> ( prop <span class="keyword">in</span> props ) &#123;</span><br><span class="line">		value = props[ prop ];</span><br><span class="line">		<span class="keyword">if</span> ( rfxtypes.test( value ) ) &#123;</span><br><span class="line">			<span class="keyword">delete</span> props[ prop ];</span><br><span class="line">			toggle = toggle || value === <span class="string">"toggle"</span>;</span><br><span class="line">			<span class="keyword">if</span> ( value === ( hidden ? <span class="string">"hide"</span> : <span class="string">"show"</span> ) ) &#123;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Pretend to be hidden if this is a "show" and</span></span><br><span class="line">				<span class="comment">// there is still data from a stopped show/hide</span></span><br><span class="line">				<span class="keyword">if</span> ( value === <span class="string">"show"</span> &amp;&amp; dataShow &amp;&amp; dataShow[ prop ] !== <span class="literal">undefined</span> ) &#123;</span><br><span class="line">					hidden = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Ignore all other no-op show/hide data</span></span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">continue</span>;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			orig[ prop ] = dataShow &amp;&amp; dataShow[ prop ] || jQuery.style( elem, prop );</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Bail out if this is a no-op like .hide().hide()</span></span><br><span class="line">	propTween = !jQuery.isEmptyObject( props );</span><br><span class="line">	<span class="keyword">if</span> ( !propTween &amp;&amp; jQuery.isEmptyObject( orig ) ) &#123;</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Restrict "overflow" and "display" styles during box animations</span></span><br><span class="line">	<span class="keyword">if</span> ( isBox &amp;&amp; elem.nodeType === <span class="number">1</span> ) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Support: IE &lt;=9 - 11, Edge 12 - 15</span></span><br><span class="line">		<span class="comment">// Record all 3 overflow attributes because IE does not infer the shorthand</span></span><br><span class="line">		<span class="comment">// from identically-valued overflowX and overflowY and Edge just mirrors</span></span><br><span class="line">		<span class="comment">// the overflowX value there.</span></span><br><span class="line">		opts.overflow = [ style.overflow, style.overflowX, style.overflowY ];</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Identify a display type, preferring old show/hide data over the CSS cascade</span></span><br><span class="line">		restoreDisplay = dataShow &amp;&amp; dataShow.display;</span><br><span class="line">		<span class="keyword">if</span> ( restoreDisplay == <span class="literal">null</span> ) &#123;</span><br><span class="line">			restoreDisplay = dataPriv.get( elem, <span class="string">"display"</span> );</span><br><span class="line">		&#125;</span><br><span class="line">		display = jQuery.css( elem, <span class="string">"display"</span> );</span><br><span class="line">		<span class="keyword">if</span> ( display === <span class="string">"none"</span> ) &#123;</span><br><span class="line">			<span class="keyword">if</span> ( restoreDisplay ) &#123;</span><br><span class="line">				display = restoreDisplay;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Get nonempty value(s) by temporarily forcing visibility</span></span><br><span class="line">				showHide( [ elem ], <span class="literal">true</span> );</span><br><span class="line">				restoreDisplay = elem.style.display || restoreDisplay;</span><br><span class="line">				display = jQuery.css( elem, <span class="string">"display"</span> );</span><br><span class="line">				showHide( [ elem ] );</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Animate inline elements as inline-block</span></span><br><span class="line">		<span class="keyword">if</span> ( display === <span class="string">"inline"</span> || display === <span class="string">"inline-block"</span> &amp;&amp; restoreDisplay != <span class="literal">null</span> ) &#123;</span><br><span class="line">			<span class="keyword">if</span> ( jQuery.css( elem, <span class="string">"float"</span> ) === <span class="string">"none"</span> ) &#123;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Restore the original display value at the end of pure show/hide animations</span></span><br><span class="line">				<span class="keyword">if</span> ( !propTween ) &#123;</span><br><span class="line">					anim.done( <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">						style.display = restoreDisplay;</span><br><span class="line">					&#125; );</span><br><span class="line">					<span class="keyword">if</span> ( restoreDisplay == <span class="literal">null</span> ) &#123;</span><br><span class="line">						display = style.display;</span><br><span class="line">						restoreDisplay = display === <span class="string">"none"</span> ? <span class="string">""</span> : display;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">				style.display = <span class="string">"inline-block"</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( opts.overflow ) &#123;</span><br><span class="line">		style.overflow = <span class="string">"hidden"</span>;</span><br><span class="line">		anim.always( <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">			style.overflow = opts.overflow[ <span class="number">0</span> ];</span><br><span class="line">			style.overflowX = opts.overflow[ <span class="number">1</span> ];</span><br><span class="line">			style.overflowY = opts.overflow[ <span class="number">2</span> ];</span><br><span class="line">		&#125; );</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Implement show/hide animations</span></span><br><span class="line">	propTween = <span class="literal">false</span>;</span><br><span class="line">	<span class="keyword">for</span> ( prop <span class="keyword">in</span> orig ) &#123;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// General show/hide setup for this element animation</span></span><br><span class="line">		<span class="keyword">if</span> ( !propTween ) &#123;</span><br><span class="line">			<span class="keyword">if</span> ( dataShow ) &#123;</span><br><span class="line">				<span class="keyword">if</span> ( <span class="string">"hidden"</span> <span class="keyword">in</span> dataShow ) &#123;</span><br><span class="line">					hidden = dataShow.hidden;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				dataShow = dataPriv.access( elem, <span class="string">"fxshow"</span>, &#123; <span class="attr">display</span>: restoreDisplay &#125; );</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Store hidden/visible for toggle so `.stop().toggle()` "reverses"</span></span><br><span class="line">			<span class="keyword">if</span> ( toggle ) &#123;</span><br><span class="line">				dataShow.hidden = !hidden;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Show elements before animating them</span></span><br><span class="line">			<span class="keyword">if</span> ( hidden ) &#123;</span><br><span class="line">				showHide( [ elem ], <span class="literal">true</span> );</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* eslint-disable no-loop-func */</span></span><br><span class="line"></span><br><span class="line">			anim.done( <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* eslint-enable no-loop-func */</span></span><br><span class="line"></span><br><span class="line">				<span class="comment">// The final step of a "hide" animation is actually hiding the element</span></span><br><span class="line">				<span class="keyword">if</span> ( !hidden ) &#123;</span><br><span class="line">					showHide( [ elem ] );</span><br><span class="line">				&#125;</span><br><span class="line">				dataPriv.remove( elem, <span class="string">"fxshow"</span> );</span><br><span class="line">				<span class="keyword">for</span> ( prop <span class="keyword">in</span> orig ) &#123;</span><br><span class="line">					jQuery.style( elem, prop, orig[ prop ] );</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; );</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// Per-property setup</span></span><br><span class="line">		propTween = createTween( hidden ? dataShow[ prop ] : <span class="number">0</span>, prop, anim );</span><br><span class="line">		<span class="keyword">if</span> ( !( prop <span class="keyword">in</span> dataShow ) ) &#123;</span><br><span class="line">			dataShow[ prop ] = propTween.start;</span><br><span class="line">			<span class="keyword">if</span> ( hidden ) &#123;</span><br><span class="line">				propTween.end = propTween.start;</span><br><span class="line">				propTween.start = <span class="number">0</span>;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="接口设计"><a href="#接口设计" class="headerlink" title="接口设计"></a>接口设计</h3><p>在动效接口部分，笔者将拆分为两类加以分析，其一是通用的动画接口，其二是 slideUp 等特殊动效。前者提供 $.animate, $.stop, $.finish 方法；后者基于前者的 animate 方法实现。</p>
<h4 id="通用动画接口"><a href="#通用动画接口" class="headerlink" title="通用动画接口"></a>通用动画接口</h4><p>$.animate 方法的处理逻辑为：</p>
<p>首先，使用 jQuery.speed 方法处理传参，且该方法将把 jQuery.dequeue 方法挂载到动画的回调函数中，以使前一个动画执行完成后，能取出 queue 队列中的下一个动画或普通函数并执行。特别的，当 jQuery.fx.off 开关置为真值时，样式变更将在下一个定时任务中即时得到完成。</p>
<p>其次，在 $.animate 方法中，如果传参 speed.queue 为 false，那么就以立即执行方式调用 Animation 函数；反之，以动画队列方式处理 Animation 函数。Animation 函数通过 doAnimation 函数封装，后续将指出为什么要用 doAnimation 函数进行封装。</p>
<p>$.stop 方法的处理逻辑为：</p>
<p>首先，视传参 clearQueue 是否为真值，清空 queue 队列函数。</p>
<p>其次，调用 queueHooks 钩子中的 stop 方法，并传入 gotoEnd 参数。该 stop 一则可以通过添加返回值带有 stop 方法的 prefilter 函数实现，一则可以调用 jQuery._queueHooks 注册。</p>
<p>其次，通过 queue 类型和 elem 属性，从 jQuery.timers 定时任务队列中取出待执行的 animation 对象，执行其 stop 方法，阻止元素样式更新或者将样式更新为最终状态（由  gotoEnd 入参决定）；并从 jQuery.timers 缓存中剔除当前元素的动画任务，基于 queue 类型判断，存储在同一个 queue 队列中的动画都将被移除。</p>
<p>最后，如果 gotoEnd 入参为否值，或者动画函数尚没有添加到 jQuery.timers 定时任务队列中（其情形为，动画函数在 queue 队列中等待执行。这种情形发生在调用 $.animate 方法在 queue 队列中创建 ‘inprogress’ 字符串的时候，等该动画执行完后，再使用 $.animate, $.queue 方法都将只把动画或普通函数添加到队列中，而不会自动执行，这部分可参见 jQuery 基础 - queue 队列一节），那么调用 jQuery.dequeue 方法，取出下一个动画函数并执行。如果 jQuery 对 stop 方法的设计采用如 requestAnimationFrame 的形式，即将 animation 对象输出给用户，由用户手动调用该 animation 的 stop 方法，就不会出现如上问题，而且对终止动画的操作也更具颗粒性。也许使用类的编码方式会更加合理。</p>
<p>$.finish 方法的处理逻辑为：</p>
<p>首先，从 queue 队列中取出 $.animate 方法创建的 doAnimation 函数，将 dataPriv.finish 缓存属性置为真。</p>
<p>其次，将 queue 队列置为空数组。</p>
<p>其次，调用 queueHooks.stop 钩子。</p>
<p>其次，根据 queue 类型和 elem 属性，遍历 jQuery.timers 定时任务队列，执行 animation.stop 方法，并从 jQuery.timers 队列中移除动画。</p>
<p>其次，执行 doAnimation.finish 方法，即 doAnimation 本身，这里仍是针对动画在队列中排队、得不到执行的情形。</p>
<p>最后，移除 dataPriv.finish 标识，意味着 doAnimation 函数中的 dataPriv.finish 只可能发生于 $.finish 方法执行期间。</p>
<p>由以上可以看出，jQuery 在顾全某些特殊情形时，各模块、各函数间的耦合度相当高，编码极不明朗，在程序设计上大有不可取的姿态。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> rrun = <span class="regexp">/queueHooks$/</span>;</span><br><span class="line"></span><br><span class="line">jQuery.speed = <span class="function"><span class="keyword">function</span>(<span class="params"> speed, easing, fn </span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> opt = speed &amp;&amp; <span class="keyword">typeof</span> speed === <span class="string">"object"</span> ? jQuery.extend( &#123;&#125;, speed ) : &#123;</span><br><span class="line">		complete: fn || !fn &amp;&amp; easing ||</span><br><span class="line">			isFunction( speed ) &amp;&amp; speed,</span><br><span class="line">		duration: speed,</span><br><span class="line">		easing: fn &amp;&amp; easing || easing &amp;&amp; !isFunction( easing ) &amp;&amp; easing</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Go to the end state if fx are off</span></span><br><span class="line">	<span class="keyword">if</span> ( jQuery.fx.off ) &#123;</span><br><span class="line">		opt.duration = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		<span class="keyword">if</span> ( <span class="keyword">typeof</span> opt.duration !== <span class="string">"number"</span> ) &#123;</span><br><span class="line">			<span class="keyword">if</span> ( opt.duration <span class="keyword">in</span> jQuery.fx.speeds ) &#123;</span><br><span class="line">				opt.duration = jQuery.fx.speeds[ opt.duration ];</span><br><span class="line"></span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				opt.duration = jQuery.fx.speeds._default;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Normalize opt.queue - true/undefined/null -&gt; "fx"</span></span><br><span class="line">	<span class="keyword">if</span> ( opt.queue == <span class="literal">null</span> || opt.queue === <span class="literal">true</span> ) &#123;</span><br><span class="line">		opt.queue = <span class="string">"fx"</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// Queueing</span></span><br><span class="line">	opt.old = opt.complete;</span><br><span class="line"></span><br><span class="line">	opt.complete = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> ( isFunction( opt.old ) ) &#123;</span><br><span class="line">			opt.old.call( <span class="keyword">this</span> );</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( opt.queue ) &#123;</span><br><span class="line">			jQuery.dequeue( <span class="keyword">this</span>, opt.queue );</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> opt;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">jQuery.fn.extend( &#123;</span><br><span class="line">	animate: <span class="function"><span class="keyword">function</span>(<span class="params"> prop, speed, easing, callback </span>) </span>&#123;</span><br><span class="line">		<span class="keyword">var</span> empty = jQuery.isEmptyObject( prop ),</span><br><span class="line">			optall = jQuery.speed( speed, easing, callback ),</span><br><span class="line">			doAnimation = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Operate on a copy of prop so per-property easing won't be lost</span></span><br><span class="line">				<span class="keyword">var</span> anim = Animation( <span class="keyword">this</span>, jQuery.extend( &#123;&#125;, prop ), optall );</span><br><span class="line"></span><br><span class="line">				<span class="comment">// Empty animations, or finishing resolves immediately</span></span><br><span class="line">				<span class="keyword">if</span> ( empty || dataPriv.get( <span class="keyword">this</span>, <span class="string">"finish"</span> ) ) &#123;</span><br><span class="line">					anim.stop( <span class="literal">true</span> );</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;;</span><br><span class="line">			doAnimation.finish = doAnimation;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> empty || optall.queue === <span class="literal">false</span> ?</span><br><span class="line">			<span class="keyword">this</span>.each( doAnimation ) :</span><br><span class="line">			<span class="keyword">this</span>.queue( optall.queue, doAnimation );</span><br><span class="line">	&#125;,</span><br><span class="line">	stop: <span class="function"><span class="keyword">function</span>(<span class="params"> type, clearQueue, gotoEnd </span>) </span>&#123;</span><br><span class="line">		<span class="keyword">var</span> stopQueue = <span class="function"><span class="keyword">function</span>(<span class="params"> hooks </span>) </span>&#123;</span><br><span class="line">			<span class="keyword">var</span> stop = hooks.stop;</span><br><span class="line">			<span class="keyword">delete</span> hooks.stop;</span><br><span class="line">			stop( gotoEnd );</span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ( <span class="keyword">typeof</span> type !== <span class="string">"string"</span> ) &#123;</span><br><span class="line">			gotoEnd = clearQueue;</span><br><span class="line">			clearQueue = type;</span><br><span class="line">			type = <span class="literal">undefined</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">if</span> ( clearQueue &amp;&amp; type !== <span class="literal">false</span> ) &#123;</span><br><span class="line">			<span class="keyword">this</span>.queue( type || <span class="string">"fx"</span>, [] );</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.each( <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">			<span class="keyword">var</span> dequeue = <span class="literal">true</span>,</span><br><span class="line">				index = type != <span class="literal">null</span> &amp;&amp; type + <span class="string">"queueHooks"</span>,</span><br><span class="line">				timers = jQuery.timers,</span><br><span class="line">				data = dataPriv.get( <span class="keyword">this</span> );</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> ( index ) &#123;</span><br><span class="line">				<span class="keyword">if</span> ( data[ index ] &amp;&amp; data[ index ].stop ) &#123;</span><br><span class="line">					stopQueue( data[ index ] );</span><br><span class="line">				&#125;</span><br><span class="line">			&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">				<span class="keyword">for</span> ( index <span class="keyword">in</span> data ) &#123;</span><br><span class="line">					<span class="keyword">if</span> ( data[ index ] &amp;&amp; data[ index ].stop &amp;&amp; rrun.test( index ) ) &#123;</span><br><span class="line">						stopQueue( data[ index ] );</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">for</span> ( index = timers.length; index--; ) &#123;</span><br><span class="line">				<span class="keyword">if</span> ( timers[ index ].elem === <span class="keyword">this</span> &amp;&amp;</span><br><span class="line">					( type == <span class="literal">null</span> || timers[ index ].queue === type ) ) &#123;</span><br><span class="line"></span><br><span class="line">					timers[ index ].anim.stop( gotoEnd );</span><br><span class="line">					dequeue = <span class="literal">false</span>;</span><br><span class="line">					timers.splice( index, <span class="number">1</span> );</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Start the next in the queue if the last step wasn't forced.</span></span><br><span class="line">			<span class="comment">// Timers currently will call their complete callbacks, which</span></span><br><span class="line">			<span class="comment">// will dequeue but only if they were gotoEnd.</span></span><br><span class="line">			<span class="keyword">if</span> ( dequeue || !gotoEnd ) &#123;</span><br><span class="line">				jQuery.dequeue( <span class="keyword">this</span>, type );</span><br><span class="line">			&#125;</span><br><span class="line">		&#125; );</span><br><span class="line">	&#125;,</span><br><span class="line">	finish: <span class="function"><span class="keyword">function</span>(<span class="params"> type </span>) </span>&#123;</span><br><span class="line">		<span class="keyword">if</span> ( type !== <span class="literal">false</span> ) &#123;</span><br><span class="line">			type = type || <span class="string">"fx"</span>;</span><br><span class="line">		&#125;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.each( <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">			<span class="keyword">var</span> index,</span><br><span class="line">				data = dataPriv.get( <span class="keyword">this</span> ),</span><br><span class="line">				queue = data[ type + <span class="string">"queue"</span> ],</span><br><span class="line">				hooks = data[ type + <span class="string">"queueHooks"</span> ],</span><br><span class="line">				timers = jQuery.timers,</span><br><span class="line">				length = queue ? queue.length : <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Enable finishing flag on private data</span></span><br><span class="line">			data.finish = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Empty the queue first</span></span><br><span class="line">			jQuery.queue( <span class="keyword">this</span>, type, [] );</span><br><span class="line"></span><br><span class="line">			<span class="keyword">if</span> ( hooks &amp;&amp; hooks.stop ) &#123;</span><br><span class="line">				hooks.stop.call( <span class="keyword">this</span>, <span class="literal">true</span> );</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Look for any active animations, and finish them</span></span><br><span class="line">			<span class="keyword">for</span> ( index = timers.length; index--; ) &#123;</span><br><span class="line">				<span class="keyword">if</span> ( timers[ index ].elem === <span class="keyword">this</span> &amp;&amp; timers[ index ].queue === type ) &#123;</span><br><span class="line">					timers[ index ].anim.stop( <span class="literal">true</span> );</span><br><span class="line">					timers.splice( index, <span class="number">1</span> );</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Look for any animations in the old queue and finish them</span></span><br><span class="line">			<span class="keyword">for</span> ( index = <span class="number">0</span>; index &lt; length; index++ ) &#123;</span><br><span class="line">				<span class="keyword">if</span> ( queue[ index ] &amp;&amp; queue[ index ].finish ) &#123;</span><br><span class="line">					queue[ index ].finish.call( <span class="keyword">this</span> );</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">// Turn off finishing flag</span></span><br><span class="line">			<span class="keyword">delete</span> data.finish;</span><br><span class="line">		&#125; );</span><br><span class="line">	&#125;</span><br><span class="line">&#125; );</span><br></pre></td></tr></table></figure>
<h4 id="特殊动效"><a href="#特殊动效" class="headerlink" title="特殊动效"></a>特殊动效</h4><p>jQuery 中的特殊动效包含 toggle, show, hide, slideUp, slideDown, fadeIn, fadeOut, fadeToggle，主要为滑动及渐隐。</p>
<p>对于 toggle, show, hide，其处理逻辑为区分是即时的样式改变，还是动画。</p>
<p>对于其他样式，则需要通过 genFx 函数获取注入 Animation 函数的 props。如针对 $.slideUp 方法，genFx 函数的返回值为 { height: ‘show’, marginTop: ‘show’, paddingTop: ‘show’, marginBottom: ‘show’, paddingottom: ‘show’ }。前文已经提到，这样的数据作为参数 props 注入 Animation 函数时，将被 defaultProfilter 预处理器所拦截，并创建 tween 已更新元素的相关样式，构成滑动效果。余同</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Generate parameters to create a standard animation</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">genFx</span>(<span class="params"> type, includeWidth </span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> which,</span><br><span class="line">		i = <span class="number">0</span>,</span><br><span class="line">		attrs = &#123; <span class="attr">height</span>: type &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// If we include width, step value is 1 to do all cssExpand values,</span></span><br><span class="line">	<span class="comment">// otherwise step value is 2 to skip over Left and Right</span></span><br><span class="line">	includeWidth = includeWidth ? <span class="number">1</span> : <span class="number">0</span>;</span><br><span class="line">	<span class="keyword">for</span> ( ; i &lt; <span class="number">4</span>; i += <span class="number">2</span> - includeWidth ) &#123;</span><br><span class="line">		which = cssExpand[ i ];</span><br><span class="line">		attrs[ <span class="string">"margin"</span> + which ] = attrs[ <span class="string">"padding"</span> + which ] = type;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> ( includeWidth ) &#123;</span><br><span class="line">		attrs.opacity = attrs.width = type;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> attrs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jQuery.each( [ <span class="string">"toggle"</span>, <span class="string">"show"</span>, <span class="string">"hide"</span> ], <span class="function"><span class="keyword">function</span>(<span class="params"> i, name </span>) </span>&#123;</span><br><span class="line">	<span class="keyword">var</span> cssFn = jQuery.fn[ name ];</span><br><span class="line">	jQuery.fn[ name ] = <span class="function"><span class="keyword">function</span>(<span class="params"> speed, easing, callback </span>) </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> speed == <span class="literal">null</span> || <span class="keyword">typeof</span> speed === <span class="string">"boolean"</span> ?</span><br><span class="line">			cssFn.apply( <span class="keyword">this</span>, <span class="built_in">arguments</span> ) :</span><br><span class="line">			<span class="keyword">this</span>.animate( genFx( name, <span class="literal">true</span> ), speed, easing, callback );</span><br><span class="line">	&#125;;</span><br><span class="line">&#125; );</span><br><span class="line"></span><br><span class="line">jQuery.each( &#123;</span><br><span class="line">	slideDown: genFx( <span class="string">"show"</span> ),</span><br><span class="line">	slideUp: genFx( <span class="string">"hide"</span> ),</span><br><span class="line">	slideToggle: genFx( <span class="string">"toggle"</span> ),</span><br><span class="line">	fadeIn: &#123; <span class="attr">opacity</span>: <span class="string">"show"</span> &#125;,</span><br><span class="line">	fadeOut: &#123; <span class="attr">opacity</span>: <span class="string">"hide"</span> &#125;,</span><br><span class="line">	fadeToggle: &#123; <span class="attr">opacity</span>: <span class="string">"toggle"</span> &#125;</span><br><span class="line">&#125;, <span class="function"><span class="keyword">function</span>(<span class="params"> name, props </span>) </span>&#123;</span><br><span class="line">	jQuery.fn[ name ] = <span class="function"><span class="keyword">function</span>(<span class="params"> speed, easing, callback </span>) </span>&#123;</span><br><span class="line">		<span class="keyword">return</span> <span class="keyword">this</span>.animate( props, speed, easing, callback );</span><br><span class="line">	&#125;;</span><br><span class="line">&#125; );</span><br></pre></td></tr></table></figure>
<h2 id="感悟"><a href="#感悟" class="headerlink" title="感悟"></a>感悟</h2><p>这几天，我总想用一种形象化的比喻来描述自己管窥中的程序设计。有想过把它比作为流水线上的零部件加工，可使这样的形容不足以说明程序设计的复杂度。在源码阅读过程中，我发现，程序设计里对模块的使用并不像产业工人那样只是做简单的拼装。模块间的耦合度会因为设计的不合理、开发者能力的局限、问题的复杂度，而显出一定的复杂度。譬如，在 jQuery 中，queue 模块会内嵌许多针对动效的处理逻辑，基于类的形式构建程序处理的多样性会比在函数体内设置标识、或者通过传参判断，条理会更清晰明朗；在 webpack 中，module 的编译流程会散落在多个模块中，各个模块间的关联性并不是那么容易理清。程序设计并不像对汽车零部件的加工，走完这道工序，就是那一道工序。它更像从史记中理出某个历史事件，比如汉武帝听从大行王恢的建议在马邑对匈奴设伏，事件的枝节会散落在各个人物传记中；各方人物的心理也小挖掘；针对史料，又需要摸索作者的曲笔、晦言；当把事件置入历史长河、国内外局势中，则需要作一番更深远的考量。换回到工业层面，也许可以把程序设计思想为，模块就好比一台可以加工多种产品的设备，模块间的铰链就好比产品在多个设备中周转，程序设计像是创建一个工厂、一套工程，而不止于一个产品。</p>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2><ol>
<li><p>参考 Java 中多线程 Thread 的设计，使用类的形式构建 Animation 模块。</p>
</li>
<li><p>是否能构建一个独立的流程控制器，用于在制作模块时，控制其执行流程，并对外提供钩子。</p>
</li>
</ol>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpeg"
                alt="Alfred" />
            
              <p class="site-author-name" itemprop="name">Alfred</p>
              <p class="site-description motion-element" itemprop="description">人苦不知足，既得陇，复望蜀</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    <span class="site-state-item-count">15</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    <span class="site-state-item-count">16</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Alfred-sg" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/xiu-fan-79/activities" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-globe"></i>知乎</a>
                  </span>
                
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Alfred</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Pisces</a> v6.0.2</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.0.2"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.2"></script>



  

  
    <script id="dsq-count-scr" src="https://alfred.disqus.com/count.js" async></script>
  

  





	





  












  





  

  

  

  

  
  

  

  

  

  

</body>
</html>
