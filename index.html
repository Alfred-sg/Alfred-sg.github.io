<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.0.2" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.2">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.2" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.0.2',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="Hexo, NexT">


<meta name="description" content="人苦不知足，既得陇，复望蜀">
<meta property="og:type" content="website">
<meta property="og:title" content="修子范语">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="修子范语">
<meta property="og:description" content="人苦不知足，既得陇，复望蜀">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="修子范语">
<meta name="twitter:description" content="人苦不知足，既得陇，复望蜀">






  <link rel="canonical" href="http://yoursite.com/">


  <title>修子范语</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">修子范语</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Alfredo's Notes</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/12/31/frontend/前端工程体系/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/12/31/frontend/前端工程体系/" itemprop="url">前端工程体系</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-12-31T00:00:00+08:00">2020-12-31</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端/" itemprop="url" rel="index"><span itemprop="name">前端</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/12/31/frontend/前端工程体系/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/12/31/frontend/前端工程体系/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>我常常执着于部分（比如昏天暗地地解读一个源码），不能跳出来看看整体。这篇文章旨在于整理我所理解的前端工程体系，方便逐步演进顶层观念并指导后续发展。因为见识的有限和理解的不足，这篇文章本难免缺陷和差缪，还望有识予以理解。</p>
<img src="/2020/12/31/frontend/前端工程体系/global.png">
<p>我所理解的前端工程体系大致如上图。左半部分以 antd + umi、fusion + 飞冰为参照加以说明，组件库用于提供基础的通用组件。模板工程通常提供了应用层面的最佳实践，因此不止于使用在组件库之内的基础通用组件、在组件库之外的图表和编辑器组件等，还包含状态管理、路由管理、服务调用等内容。当某些组件还未包含在组件库中，但在应用中经常使用，那么这些组件也可以通过模板工程下沉到组件库中。由组件库往上，可以生长出业务组件、区块、前端工程模板，这些都可以被物料中心所吸纳，以便使用特定的域作为标识，在可视化搭建等其他应用、前端 IDE 工具或简单的本地开发环境中复用。这部分内容不限于 web 场景，还包含小程序等场景。事实上，fusion 的物料中心包含 rax 组件，支付宝小程序也提供了基础组件库和 IDE 开发环境。</p>
<p>右半部分在于使用 node 服务封装后端接口提供定制化的数据，包含但不限于元数据（如菜单栏）、查询数据库的动态数据等。node 服务不止可以提供数据接口，还包含构建发布平台（构建工具通过命令行工具与其打通）、mock 服务（在应用本地运行时动态获取）、国际化服务（在应用启动阶段动态拉取）等。</p>
<img src="/2020/12/31/frontend/前端工程体系/node.png">
<h2 id="组件库"><a href="#组件库" class="headerlink" title="组件库"></a>组件库</h2><p>现行较为火热的组件库有 <a href="https://github.com/ant-design/ant-design" target="_blank" rel="noopener">ant design</a>、<a href="https://github.com/alibaba-fusion/next" target="_blank" rel="noopener">fusion</a>、<a href="https://github.com/mui-org/material-ui" target="_blank" rel="noopener">material ui</a>、<a href="https://github.com/elemefe" target="_blank" rel="noopener">element ui</a> 等。以下是 ant design 的大体结构：</p>
<img src="/2020/12/31/frontend/前端工程体系/antd.png">
<ul>
<li><a href="https://github.com/benjycui/bisheng" target="_blank" rel="noopener">bisheng</a>: 解析 markdown 文件并生成静态网站。主流程上，它借助 <a href="https://github.com/mozilla/nunjucks" target="_blank" rel="noopener">nunjucks</a>、webpack、ssr 机制启动本地服务器、生成打包文件，以及通过 <a href="https://github.com/tschaub/gh-pages" target="_blank" rel="noopener">gh-pages</a> 将静态页面上传到 github 服务器上。实现可参考 <a href="http://xzfyu.com/2019/12/21/antd/%E8%81%8A%E8%81%8A%20antd%20%E7%BD%91%E7%AB%99%E6%98%AF%E6%80%8E%E4%B9%88%E5%88%B6%E4%BD%9C%E7%9A%84/" target="_blank" rel="noopener">聊聊 antd 网站是怎么制作的</a>。</li>
<li><a href="https://github.com/ant-design/antd-tools" target="_blank" rel="noopener">antd-tools</a>、scripts: 提供基本的命令行工具。antd-tools 基于 gulp 实现，它集成了 compile（基于不同组件的入口文件编译 less、ts、svg 等）、dist（使用 webpack 打包整个组件库）、<a href="https://github.com/ant-design/antd-tools/blob/master/lib/lint/checkDeps.js" target="_blank" rel="noopener">deps-lint</a>（检查模块是否被依赖）、pub（编译、打包并发布）、guard、sort-api-table、api-collection、clean 等操作。</li>
</ul>
<p>ant design 的定制主题功能基于 less 的 <a href="https://ant.design/docs/react/customize-theme-cn" target="_blank" rel="noopener">modifyVars</a>，即将可定制的样式定义为 less 变量，随后就可以通过 less-loader 引用外部 less 变量文件实现定制。ant design 中可配置的样式见 <a href="https://github.com/ant-design/ant-design/blob/master/components/style/themes/default.less" target="_blank" rel="noopener">这里</a>。无障碍功能基于节点的 aria-、role- 属性实现，可参考 <a href="https://www.cnblogs.com/dingyuanxin/p/4052518.html" target="_blank" rel="noopener">aria初探</a>。国际化功能基于 react 的 context 机制实现，同时会设置 moment 的语言。按需加载功能借助于 <a href="https://github.com/ant-design/babel-plugin-import" target="_blank" rel="noopener">babel-plugin-import</a> 插件；其原理为在 babel 编译期间转换 import 语句，并加载必要的样式（默认加载组件文件夹下的 css/index.js 文件）。</p>
<p>以下是 react-components 组件图谱，动效、对齐、伸缩作为基础的组件或工具函数，其上再延伸出表单、数据展示、导航、回馈组件等。</p>
<img src="/2020/12/31/frontend/前端工程体系/react-components.png">
<p>ant-design 的组件基本基于 ConfigProvider 构建。ConfigProvider 通过 react 的 context 机制提供国际化、弹层根节点获取函数、空态渲染函数等。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://news.html5.qq.com/article?ch=901201&amp;tabId=0&amp;tagId=0&amp;docId=669838503675269442&amp;showAttach=1&amp;url=http%3A%2F%2Fkuaibao%2Eqq%2Ecom%2Fs%2F20191214A0F0TM00&amp;dataSrc=96&amp;showDate=1&amp;extenddata=%26%5Fdis%3D3%26bp%3D1%26contentLevel%3D2%26dataSrc%3D96%26queryId%3D1576313487963%26sGrayPlatFormModelId%3D100000%26sModelId%3D100000%26sStrategyId%3D153%26subjectId%3D1090319%26wx%3D1%26zimeitiId%3Dqeh%5F5598878&amp;pid=1&amp;data_type=1&amp;ctrid=1" target="_blank" rel="noopener">如果我是阿里的前端架构师，我会这么搭建前端架构体系</a><br><a href="https://zhuanlan.zhihu.com/p/94949118" target="_blank" rel="noopener">蚂蚁前端研发最佳实践</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/09/frontend/前端技术汇总贴/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/06/09/frontend/前端技术汇总贴/" itemprop="url">前端技术汇总贴</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-06-09T00:00:00+08:00">2020-06-09</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端/" itemprop="url" rel="index"><span itemprop="name">前端</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/06/09/frontend/前端技术汇总贴/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/06/09/frontend/前端技术汇总贴/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h2><p><a href="https://segmentfault.com/a/1190000017946900" target="_blank" rel="noopener">立即收藏！这应该是你见过的最全前端下载总结</a></p>
<h2 id="校验"><a href="#校验" class="headerlink" title="校验"></a>校验</h2><h3 id="身份证号"><a href="#身份证号" class="headerlink" title="身份证号"></a>身份证号</h3><p>根据〖中华人民共和国国家标准 GB 11643-1999〗中有关公民身份号码的规定，公民身份号码是特征组合码，由十七位数字本体码和一位数字校验码组成。排列顺序从左至右依次为：六位数字地址码，八位数字出生日期码，三位数字顺序码和一位数字校验码。</p>
<ul>
<li>地址码表示编码对象常住户口所在县(市、旗、区)的行政区划代码。</li>
<li>出生日期码表示编码对象出生的年、月、日，其中年份用四位数字表示，年、月、日之间不用分隔符。</li>
<li>顺序码表示同一地址码所标识的区域范围内，对同年、月、日出生的人员编定的顺序号。顺序码的奇数分给男性，偶数分给女性。</li>
<li>校验码是根据前面十七位数字码，按照 ISO 7064:1983.MOD 11-2 校验码计算出来的检验码。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> City = &#123;</span><br><span class="line">  <span class="number">11</span>:<span class="string">"北京"</span>, <span class="number">12</span>:<span class="string">"天津"</span>, <span class="number">13</span>:<span class="string">"河北"</span>, <span class="number">14</span>:<span class="string">"山西"</span>, <span class="number">15</span>:<span class="string">"内蒙古"</span>, <span class="number">21</span>:<span class="string">"辽宁"</span>, <span class="number">22</span>:<span class="string">"吉林"</span>, <span class="number">23</span>:<span class="string">"黑龙江 "</span>,</span><br><span class="line">  <span class="number">31</span>:<span class="string">"上海"</span>, <span class="number">32</span>:<span class="string">"江苏"</span>, <span class="number">33</span>:<span class="string">"浙江"</span>, <span class="number">34</span>:<span class="string">"安徽"</span>, <span class="number">35</span>:<span class="string">"福建"</span>, <span class="number">36</span>:<span class="string">"江西"</span>, <span class="number">37</span>:<span class="string">"山东"</span>, <span class="number">41</span>:<span class="string">"河南"</span>,</span><br><span class="line">  <span class="number">42</span>:<span class="string">"湖北 "</span>, <span class="number">43</span>:<span class="string">"湖南"</span>, <span class="number">44</span>:<span class="string">"广东"</span>, <span class="number">45</span>:<span class="string">"广西"</span>, <span class="number">46</span>:<span class="string">"海南"</span>, <span class="number">50</span>:<span class="string">"重庆"</span>, <span class="number">51</span>:<span class="string">"四川"</span>, <span class="number">52</span>:<span class="string">"贵州"</span>, </span><br><span class="line">  <span class="number">53</span>:<span class="string">"云南"</span>, <span class="number">54</span>:<span class="string">"西藏"</span>, <span class="number">61</span>:<span class="string">"陕西"</span>, <span class="number">62</span>:<span class="string">"甘肃"</span>, <span class="number">63</span>:<span class="string">"青海"</span>, <span class="number">64</span>:<span class="string">"宁夏"</span>, <span class="number">65</span>:<span class="string">"新疆"</span>, <span class="number">71</span>:<span class="string">"台湾"</span>,</span><br><span class="line">  <span class="number">81</span>:<span class="string">"香港"</span>, <span class="number">82</span>:<span class="string">"澳门"</span>, <span class="number">91</span>:<span class="string">"国外"</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 15位校验规则：6位地址编码+6位出生日期+3位顺序号</span></span><br><span class="line"><span class="comment">// 18位校验规则：6位地址编码+8位出生日期+3位顺序号+1位校验位</span></span><br><span class="line"><span class="keyword">const</span> IdentityCodeRegExp = <span class="regexp">/^\d&#123;6&#125;(18|19|20)?\d&#123;2&#125;(0[1-9]|1[012])(0[1-9]|[12]\d|3[01])\d&#123;3&#125;(\d|X)$/i</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 校验位规则     公式:∑(ai×Wi)(mod 11)</span></span><br><span class="line"><span class="comment">//   i----表示号码字符从由至左包括校验码在内的位置序号； </span></span><br><span class="line"><span class="comment">//   ai----表示第i位置上的号码字符值； </span></span><br><span class="line"><span class="comment">//   Wi----示第i位置上的加权因子，其数值依据公式Wi=2^(n-1）(mod 11)计算得出。</span></span><br><span class="line"><span class="keyword">const</span> factor = [ <span class="number">7</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">2</span>, <span class="number">1</span>, <span class="number">6</span>, <span class="number">3</span>, <span class="number">7</span>, <span class="number">9</span>, <span class="number">10</span>, <span class="number">5</span>, <span class="number">8</span>, <span class="number">4</span>, <span class="number">2</span> ];<span class="comment">// 加权因子</span></span><br><span class="line"><span class="keyword">const</span> parity = [ <span class="number">1</span>, <span class="number">0</span>, <span class="string">'X'</span>, <span class="number">9</span>, <span class="number">8</span>, <span class="number">7</span>, <span class="number">6</span>, <span class="number">5</span>, <span class="number">4</span>, <span class="number">3</span>, <span class="number">2</span> ];<span class="comment">// 校验位</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> IdentityCodeValid = <span class="function">(<span class="params">code</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">if</span>( !code || !IdentityCodeRegExp.test(code) )&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"身份证号格式错误"</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>( !City[code.substr(<span class="number">0</span>,<span class="number">2</span>)] )&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">"身份证号中地址编码错误"</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 18位身份证需要验证最后一位校验位</span></span><br><span class="line">  <span class="keyword">if</span>( code.length == <span class="number">18</span> )&#123;</span><br><span class="line">    <span class="keyword">let</span> sum = <span class="number">0</span>;</span><br><span class="line">    code.substr(<span class="number">0</span>,<span class="number">17</span>).split(<span class="string">''</span>).forEach(<span class="function">(<span class="params">ai, i</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> wi = factor[i];</span><br><span class="line">      sum += ai * wi;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> last = parity[sum % <span class="number">11</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>( last != code[<span class="number">17</span>] )&#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">"校验位错误"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>参考 <a href="https://www.cnblogs.com/xtqg0304/p/9529721.html" target="_blank" rel="noopener">完美身份证正则表达式</a>。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/29/计算机/进程与线程/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/29/计算机/进程与线程/" itemprop="url">进程与线程</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-29T00:00:00+08:00">2020-02-29</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/计算机/" itemprop="url" rel="index"><span itemprop="name">计算机</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/02/29/计算机/进程与线程/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/02/29/计算机/进程与线程/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="进程"><a href="#进程" class="headerlink" title="进程"></a>进程</h2><h3 id="进程概要"><a href="#进程概要" class="headerlink" title="进程概要"></a>进程概要</h3><p>单核 CPU 一瞬只能运行一个进程，因此需要通过多道程序设计实现多进程的伪并行，营造在 1 秒钟内有多个进程同时运行的错觉。<br>一个进程就是一个正在执行程序的实例，包含程序计数器、寄存器和变量的当前值。程序计数器用于存放指令，CPU 层面有物理程序计数器，以进程抽象的程序层面有逻辑程序计数器。程序运行时，它的逻辑程序计数器会被装入物理程序计数器中；当程序结束或暂停时，物理程序计数器会被保存在内存中该程序的逻辑程序计数器中。进程有程序、输入、输出及状态；多个进程可共享 CPU，通过调度算法实现进程间的切换。</p>
<h3 id="创建进程"><a href="#创建进程" class="headerlink" title="创建进程"></a>创建进程</h3><ul>
<li>UNIX 系统，已存在的进程执行 fork 系统调用创建一个与调用进程相同的副本进程。这两个进程拥有相同的内存映像、环境字符串和打开文件。当子进程执行 execve 等系统调用时，子进程的内存映像会被修改，随后运行一个新程序。在 fork 之后、execve 之前，子进程可以处理它的文件描述符，这样可以完成对标准输入文件、标准输出文件和标准错误文件的重定向。有关文件描述符，可参考 理解文件描述符。</li>
<li>Windows 系统，一个 Win32 函数调用 CreateProcess 创建进程，同时把程序装入进程。该调用的参数包含要执行的程序、输入给程序的命令行参数、各种安全属性、打开文件是否继承的控制位、优先级信息、窗口规格等。</li>
</ul>
<p>UNIX 中的父子进程会共享不可写内存，某些 UNIX 实现会允许子进程在写时 copy 父进程的内存。 Windows 中的父子进程一开始就会拥有不同的地址空间。</p>
<h3 id="终止进程"><a href="#终止进程" class="headerlink" title="终止进程"></a>终止进程</h3><ul>
<li>正常退出。UNIX 通过执行 exit 系统调用退出；Windows 通过执行 ExitProcess 退出。</li>
<li>出错退出，因为进程发现严重的错误而自愿退出。</li>
<li>严重错误，因为程序本身的错误而非自愿退出。</li>
<li>被其他进程杀死。UNIX 通过执行 kill 系统调用杀死其他进程；Windows 通过执行 TerminateProcess 系统调用杀死其他进程。两者都需要相当的权限。</li>
</ul>
<h3 id="进程的状态"><a href="#进程的状态" class="headerlink" title="进程的状态"></a>进程的状态</h3><ul>
<li>运行态（实际占用 CPU 运行中）</li>
<li>就绪态（可运行，等待 CPU 空闲）</li>
<li>阻塞态（除非外部事件触发，否则进程不能运行）</li>
</ul>
<p>进程间的切换、进程状态的变更由运行调度算法的进程调度程序完成。</p>
<h3 id="进程的实现"><a href="#进程的实现" class="headerlink" title="进程的实现"></a>进程的实现</h3><p>操作系统维护着一张进程表，它为每个进程分配一个进程表项。该表项包含程序计数器、堆栈指针、内存分配状态、打开文件的状态、账号、调度信息、以及进程切换操作所需的信息。</p>
<p>进程调度中与 I/O 相关的是中断服务。当磁盘中断发生时，中断硬件会将程序计数器、程序状态字、[寄存器]压入堆栈（保存到进程表中），计算机随即跳到中断向量所指示的地址，运行处理中断服务。当中断服务处理完成后，被中断的进程都会返回到中断前的状态。完整流程如下（保存寄存器值、设置堆栈指针等需要汇编语言实现）：</p>
<ol>
<li>硬件压入堆栈程序计数器等。</li>
<li>硬件从中断向量装入新的程序计数器。</li>
<li>汇编语言过程保存寄存器值。</li>
<li>汇编语言过程设置新的堆栈。</li>
<li>C中断服务历程运行（典型地读和缓冲输入）。</li>
<li>调度程序决定下一个将运行的进程。</li>
<li>C过程返回至汇编代码。</li>
<li>汇编语言过程开始运行新的当前进程。</li>
</ol>
<h2 id="线程"><a href="#线程" class="headerlink" title="线程"></a>线程</h2><h3 id="线程概要"><a href="#线程概要" class="headerlink" title="线程概要"></a>线程概要</h3><p>同一个应用程序的某些活动会随着时间推移进入阻塞态，这时将应用程序拆解成准并行运行的多个顺序线程，会使程序设计模型变得简单。线程可以共享同一个地址控件和所有可用数据，不必考虑单道程序设计时所需面对的中断、定时器和上下文切换；线程也远比进程更为轻量级，创建和销毁都比较容易；多线程面对大量 I/O 处理时有性能优势。</p>
<p>《现代操作系统》举例说明了多线程的优点：在字处理软件中，交互线程负责处理与用户的交互；格式化线程在后台默默进行格式化操作；磁盘备份线程实现自动保存功能。这样就避免了用户须等待格式化完成再进行其他处理的问题。这三个线程也能共享处理中的文件，而不像进程那样不能共享。在 web 服务器中，分派线程用于从网络中读取请求，并分发给工作线程。当请求到达时，分派线程会挑选一个阻塞的工作线程，提交该请求，通常是对该工作线程所配有的某个专门字写入消息指针。接着分派线程会唤醒工作线程，将它从阻塞态转为就绪态，以处理请求；等请求处理完成后，工作线程会重新进入阻塞态。在大量数据处理中，输入线程用于把数据读入缓冲区；处理线程用于处理数据，并将输出写入缓冲区；输出线程将结果写到磁盘上。</p>
<h4 id="三种处理模式"><a href="#三种处理模式" class="headerlink" title="三种处理模式"></a>三种处理模式</h4><ul>
<li>单线程：阻塞系统调用，便于程序设计，舍弃了性能。</li>
<li>多线程：阻塞系统调用，便于程序设计，通过并行改善了性能。</li>
<li>有限状态机：将这一程序转向 I/O 处理后，通过有限状态机机制保存状态，转而处理那一程序。当 I/O 处理完成后，通过信号或中断的形式唤醒这一程序，并装入状态。典型如 nodejs，借助中断实现非阻塞式调用。</li>
</ul>
<h4 id="进程与线程对比"><a href="#进程与线程对比" class="headerlink" title="进程与线程对比"></a>进程与线程对比</h4><p>进程的内容有地址空间、全局变量、打开文件、子进程、即将发生的定时器、信号处理程序、账号信息等属性。线程的内容有程序计数器、存放工作变量的寄存器、记录执行历史的堆栈（每一帧保存了已调用但未返回的过程）、状态等属性。进程的意义在于将资源分组后进行集中处理；线程的意义在于对某一分组资源采用多道程序处理。</p>
<h4 id="线程基本特征"><a href="#线程基本特征" class="headerlink" title="线程基本特征"></a>线程基本特征</h4><p>线程有四种状态：运行、阻塞、就绪或终止。</p>
<p>线程的堆栈用于存放调用中但为返回的过程，同时包含相应过程的局部变量以及过程执行完成的返回地址。</p>
<p>在多线程模式下，执行线程有能力通过调用库函数创建或终止线程。如使用 thread_create 创建线程（通过参数指定要运行的过程名，通常会返回一个线程标识符）；thread_exit 退出线程；thread_join 等待某线程退出后再运行，参数为待运行线程的标识符；thread_yield 释放 CPU 来运行另一线程（线程没法像进程那样利用时间中断强制让出 CPU）；thread_attr_init 初始化某线程的属性结构；thread_attr_destory 删除某线程的属性结构。</p>
<h4 id="线程的实现"><a href="#线程的实现" class="headerlink" title="线程的实现"></a>线程的实现</h4><p>线程包可以在用户空间或内核中实现，即在进程的运行时系统中存放线程表或在内核中存放线程表。线程表与进程表类似，用于存放线程重新启动所需的信息。</p>
<p>在用户空间切换线程比在内核中更为高效，同时允许每个进程定制自己的调度算法。用户空间线程包需要处理阻塞问题，等待 I/O 的线程会长期占用 CPU，导致其他线程无法展开工作。解决方式有二：通过修改操作系统的方式将调用改成非阻塞式（不乐观）；二则通过包装器 jacker 提前检测系统调用是否会被阻塞，等线程安全了再进行调用。</p>
<p>内核线程包开销较大，且需要面对 fork 的子进程是否拥有与父进程相同线程、以及线程怎样订阅进程间通信信号等问题。但是，内核线程包中能够阻塞线程的调用都以系统调用的形式实现，内核有能力切换到其他就绪线程上，避免 CPU 空转。其能力体现为：采用调度程序激活机制，内核会为每个进程安排一定数量的虚拟处理器，随后由运行时系统将线程分配到处理器上。当内核感知到线程被阻塞后，内核会通知运行时系统，并且在堆栈中以参数形式传递有问题的线程编号和所发生事件的一个描述。内核在上述堆栈地址启动运行时系统，从而发出通知，这是对 UNIX 中信号的一种粗略模拟。</p>
<p>混合实现综合了用户级线程和内核级线程的优点，单条内核线程下挂多条用户级线程，同样可以创建、销毁和调度这些用户级线程。</p>
<h4 id="弹出式线程"><a href="#弹出式线程" class="headerlink" title="弹出式线程"></a>弹出式线程</h4><p>消息如 web 服务请求到达时，传统的做法是使用阻塞进程或线程等待消息达到，然后进行处理。另一种方式是在消息到达系统后创建一个弹出式线程（全新的，没有历史，创建会非常快）。在内核创建弹出式线程比在用户空间中更快捷，且容易访问所有的表格和 I/O 设备，以便于作中断处理。但是，出错的内核线程比用户线程危害更大。</p>
<h4 id="多线程程序设计问题"><a href="#多线程程序设计问题" class="headerlink" title="多线程程序设计问题"></a>多线程程序设计问题</h4><p>多线程会面临如下问题：</p>
<ul>
<li>全局变量问题：某线程使用的全局变量会被另一线程篡改掉。有种解决方案是，为每个线程创建私有的全局变量，比如引入新的库过程（create_global、set_global、read_global 等）以创建、设置和读取这些线程范围内的全局变量。</li>
<li>库调用、内存分配问题：库调用在前一个执行期间，仍可进行二次调用；内存指针在线程切换期间可能会处于不稳定状态。有种解决方案是，为每个过程提供包装器，包装器会设置某个库在使用中的标识，这样该库的其他线程都会被阻塞。使用信号处理上述问题时会遇到额外的问题，在内核中发送非线程专用的信号，无法感知要把信号发送到哪个线程；如果信号采用广播模式，也会遇上诸如“某个线程想捕获信号，另一个想中断进程”的问题。</li>
<li>堆栈管理问题：进程的堆栈溢出时，内核会为该进程分配更多的堆栈；内核没法了解多线程的所有堆栈，无法为它们分配更多的堆栈。</li>
</ul>
<h3 id="进程通信"><a href="#进程通信" class="headerlink" title="进程通信"></a>进程通信</h3><p>进程间通信（Inter Process Communication, IPC）需要解决以下三个问题：</p>
<ol>
<li>A 进程怎样把信息传递给 B 进程（因为线程共享地址控件，线程间通信就没有这问题）。</li>
<li>怎样保证多个进程读写某一共享资源时会有一致性问题（线程间通信也会有这问题）。</li>
<li>B 进程处理前需要等待 A 进程处理完成之类的顺序问题（线程间通信也会有这问题）。</li>
</ol>
<p>多进程读写同一共享资源时的一致性问题也称为竞争条件，因其处理结果取决于多进程运行的精确时序。处理竞争条件的策略有互斥，即避免多个进程同时读写共享数据。当把读写共享数据的程序片段称为临界区后，多个进程在某一时刻只能有一个进入临界区。其实现有：</p>
<ul>
<li>屏蔽中断：在每个进程进入临界区时屏蔽中断，这样依赖于中断的进程切换就没法展开，某一时间就只能有一个进程在临界区中。在用户进程中屏蔽中断会导致其他 CPU 无法继续运行。</li>
<li>锁变量：通过共享锁变量标记某一进程在临界区中，阻断其他进程进入临界区。锁变量同样会有竞争条件问题。</li>
<li>严格轮换法：通过自旋锁阻断其他进程运行（自旋锁在 A 进程执行过程为 0，执行后为 1；B 进程执行过程为 1，执行后为 0），阻断可以用 while 锁变量实现（自旋锁为 0 时，B 进程无法运行；为 1 时， A 进程无法运行），使进程处于忙等待状态。</li>
<li>Pererson 算法：有两个进程，设置两个标识，一则以变量记录申请进入临界区的进程，二则以集合形式记录已申请进入临界区（处于运行态或阻塞态）的进程，直到运行结束才会释放。在 A 进程进入临界区期间，因为 A 进程在集合记录中，B 进程没法进入临界区；只有等到集合记录释放时，B 进程才能进入临界区。后续进程会进入忙等待状态。</li>
<li>TSL、XCHG 指令：通过汇编语言向寄存器中写入非零值，作循环处理，其他指令均无法修改，直到本指令的调用者执行结束。这样做就是锁住了内存总线（只能允许当前指令访问内存）。锁住内存总线的机制与屏蔽中断不同；屏蔽中断时，其他进程仍能访问内存。后续进程会进入忙等待状态。</li>
<li>sleep、wakeup 系统调用：sleep 将引起调用进程阻塞，直到被另外一个进程唤起；wakeup 唤醒进程。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/28/antd/聊聊组件库的构成/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/28/antd/聊聊组件库的构成/" itemprop="url">聊聊 Ant Design 组件库的构成</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-28T00:00:00+08:00">2020-02-28</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/组件库/" itemprop="url" rel="index"><span itemprop="name">组件库</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/02/28/antd/聊聊组件库的构成/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/02/28/antd/聊聊组件库的构成/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="底层功能组件"><a href="#底层功能组件" class="headerlink" title="底层功能组件"></a>底层功能组件</h2><h3 id="rc-util"><a href="#rc-util" class="headerlink" title="rc-util"></a>rc-util</h3><p>KeyCode: 记录了各按键的编码，并提供按键判断工具。</p>
<h4 id="hooks"><a href="#hooks" class="headerlink" title="hooks"></a>hooks</h4><p>useMergedState(defaultStateValue, option) 主要用于表单项的 value 值状态处理，也可以用于其他状态处理。逻辑上，首先以 option.value、option.defaultValue、defaultStateValue 的顺序设置内部 value 状态值，该 value 值经 option.postState 转变后透出使用；同时透出的有 triggerChange 方法既能改变内部 value 状态值，又能触发 onChange 回调。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useControlledState</span>&lt;<span class="title">T</span>, <span class="title">R</span> = <span class="title">T</span>&gt;(<span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">  defaultStateValue: T | ((</span>) =&gt; <span class="title">T</span>),</span></span><br><span class="line"><span class="function">  <span class="title">option</span>?: </span>&#123;</span><br><span class="line">    defaultValue?: T | <span class="function">(<span class="params">(</span>) =&gt;</span> T);</span><br><span class="line">    value?: T;</span><br><span class="line">    onChange?: <span class="function">(<span class="params">value: T, prevValue: T</span>) =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line">    postState?: <span class="function">(<span class="params">value: T</span>) =&gt;</span> T;</span><br><span class="line">  &#125;,</span><br><span class="line">): [R, (value: T) =&gt; <span class="keyword">void</span>] &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; defaultValue, value, onChange, postState &#125; = option || &#123;&#125;;</span><br><span class="line">  <span class="keyword">const</span> [innerValue, setInnerValue] = React.useState&lt;T&gt;<span class="function">(<span class="params">(</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (value !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (defaultValue !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">typeof</span> defaultValue === <span class="string">'function'</span></span><br><span class="line">        ? (defaultValue <span class="keyword">as</span> any)()</span><br><span class="line">        : defaultValue;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">typeof</span> defaultStateValue === <span class="string">'function'</span></span><br><span class="line">      ? (defaultStateValue <span class="keyword">as</span> any)()</span><br><span class="line">      : defaultStateValue;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> mergedValue = value !== <span class="literal">undefined</span> ? value : innerValue;</span><br><span class="line">  <span class="keyword">if</span> (postState) &#123;</span><br><span class="line">    mergedValue = postState(mergedValue);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">triggerChange</span>(<span class="params">newValue: T</span>) </span>&#123;</span><br><span class="line">    setInnerValue(newValue);</span><br><span class="line">    <span class="keyword">if</span> (mergedValue !== newValue &amp;&amp; onChange) &#123;</span><br><span class="line">      onChange(newValue, mergedValue);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> [(mergedValue <span class="keyword">as</span> unknown) <span class="keyword">as</span> R, triggerChange];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="rc-align"><a href="#rc-align" class="headerlink" title="rc-align"></a>rc-align</h3><h3 id="rc-trigger"><a href="#rc-trigger" class="headerlink" title="rc-trigger"></a>rc-trigger</h3><p><a href="https://github.com/react-component/trigger" target="_blank" rel="noopener">rc-trigger</a> 作为触发器，它抽象了弹层触发的逻辑。功能点包含：</p>
<ul>
<li>触发节点：children 触发节点。</li>
<li>弹层内容：popup 弹层内容；getPopupContainer 获得弹层容器。</li>
<li>渲染、销毁时机：forceRender 弹层未显示时予以绘制；destroyPopupOnHide 弹层隐藏时销毁。</li>
<li>弹层显示、隐藏时机：action 何种用户行为展示；mouseEnterDelay 鼠标移入后延迟展示；mouseLeaveDelay 鼠标移出时延迟隐藏；popupVisible 受控显示弹层；defaultPopupVisible 弹层默认状况。</li>
<li>弹层位置：alignPoint 跟随鼠标位置动态变动；popupAlign 弹层位置；builtinPlacements 触发元素和弹层的对齐关系隐射 { topLeft: { points: [‘tl’, ‘tl’] }} 两元素左上角对齐；popupPlacement 设置对齐位置。</li>
<li>弹层样式：popupClassName 样式名；getPopupClassNameFromAlign；popupStyle 样式；prefixCls 样式名前缀。zIndex 弹层 zIndex；stretch 弹层大小随触发元素动态变更。</li>
<li>弹层动效：popupTransitionName 弹层动效；maskTransitionName 蒙层动效。</li>
<li>蒙层：mask 是否显示蒙层；maskClosable 点击蒙层关闭弹层；getDocument 文档节点，绑定点击隐藏冒牌事件。</li>
<li>弹层交互：onPopupVisibleChange 弹层显示时回调；onPopupAlign 弹层位置调整时回调。</li>
<li>ref 引用：getRootDomNode 获取触发节点的 dom 元素；getPopupDomNode 获取弹层的 dom 元素。</li>
</ul>
<h2 id="通用组件"><a href="#通用组件" class="headerlink" title="通用组件"></a>通用组件</h2><h3 id="按钮-Button"><a href="#按钮-Button" class="headerlink" title="按钮 Button"></a>按钮 Button</h3><ul>
<li>功能特性：<ul>
<li>绘制按钮。</li>
<li>绘制按钮组。</li>
</ul>
</li>
<li>样式特性：<ul>
<li>type 按钮类型：primary 主按钮、默认按钮、dashed 虚线按钮、danger 危险按钮和 link 链接按钮。其中，link 按钮以 a 节点渲染，其他按钮以 button 按钮渲染。</li>
<li>disabled、loading 按钮状态：默认正常状态、disabled 不可用状态、loading 加载中状态。加载中状态按钮将额外绘制加载图标。</li>
<li>shape 按钮形状：默认小圆角按钮、circle 圆形按钮、round 全圆角按钮。</li>
<li>size 按钮尺寸：large 大尺寸按钮、默认中尺寸按钮、small 小尺寸按钮。</li>
<li>block 按钮：100% 宽度构成块状按钮。</li>
<li>ghost 按钮：背景透明的按钮。</li>
<li>icon 图标：按钮内置图标。</li>
<li>按钮内容为双汉字，在双汉字之间插入空格。通过 ConfigProvider 的 autoInsertSpaceInButton 属性可以避免这一行为。</li>
</ul>
</li>
</ul>
<h3 id="图标-Icon"><a href="#图标-Icon" class="headerlink" title="图标 Icon"></a>图标 Icon</h3><p>图标基于 <a href="https://github.com/ant-design/ant-design-icons" target="_blank" rel="noopener">ant-design-icons</a> 制作。</p>
<ul>
<li>功能特性：<ul>
<li>绘制内置 svg 图标。</li>
<li>component 设置自定义 svg 图标渲染组件，自定义 svg 图标通过 <a href="https://www.npmjs.com/package/@svgr/webpack" target="_blank" rel="noopener">@svgr/webpack</a> 加载，参看 <a href="https://ant.design/components/icon-cn/#%E8%87%AA%E5%AE%9A%E4%B9%89-SVG-%E5%9B%BE%E6%A0%87" target="_blank" rel="noopener">自定义 SVG 图标</a>。</li>
<li>tabIndex 限制 tab 按键点选顺序。</li>
<li>viewbox 截取 svg 图片，参看 <a href="https://www.jianshu.com/p/4422c05ff0f2" target="_blank" rel="noopener">秒懂 svg 图片的 viewbox</a>。</li>
<li>onClick 点击交互等。</li>
<li>Icon.createFromIconfontCN 绘制 iconfont 图标，参看 <a href="https://ant.design/components/icon-cn/#%E8%87%AA%E5%AE%9A%E4%B9%89-font-%E5%9B%BE%E6%A0%87" target="_blank" rel="noopener">自定义 font 图标</a>。</li>
<li>Icon.setTwoToneColor 设置双色图标的主色。</li>
</ul>
</li>
<li>样式特性：<ul>
<li>theme 图标主题风格：outlined 默认描线、filled 实心、twoTone 双色。</li>
<li>type 图标类型：图标类型和 theme 主题风格构成按钮的编码类型，用于查询确切的 svg 图标。</li>
<li>spin 旋转图标。</li>
<li>rotate 旋转角度：基于 transform 样式制作。</li>
<li>twoToneColor 双色图标的主色。</li>
<li>className、style 设置 svg 图标颜色等。</li>
</ul>
</li>
</ul>
<h3 id="排版-Typography"><a href="#排版-Typography" class="headerlink" title="排版 Typography"></a>排版 Typography</h3><ul>
<li>功能特性：<ul>
<li>绘制 Title 标题、Text 文本、Paragraph 段落。</li>
<li>editable 编辑功能。编辑按钮使用 TransButton 组件包裹，便于使用 tab、enter 按键交互以及支持失焦、聚焦事件。编辑按钮点击时将绘制 Textarea。交互行为支持 editable.onStart、editable.onChange。</li>
<li>copyable 复制功能。copy 功能借助 <a href="https://github.com/sudodoki/copy-to-clipboard" target="_blank" rel="noopener">copy-to-clipboard</a> 库实现。复制按钮同样使用 TransButton 组件包裹。交互行为支持 copyable.onCopy；copyable.text 可设置复制内容。</li>
<li>ellipsis 文本省略，ellipsis.expandable 设置折叠展开功能。对于溢出的文本，ant-design 会借助 raf 在下一帧省略文本内容。文本省略采用两种方案实现：首先尝试使用 css 样式（-webkit-line-clamp、text-overflow 属性）；其次使用两分法查询待显示的文本内容，同时会合并文本节点。ant-design 同时会借助 rc-resize-observer 在屏幕大小改变调整显示文本。交互行为支持 ellipsis.onExpand。</li>
</ul>
</li>
<li>样式特性：<ul>
<li>Title 标题按 level 设置不同级别，分别用 h1、h2、h3、h4 节点渲染。</li>
<li>Text 文本使用 span 节点绘制；Paragraph 段落使用 div 节点绘制。</li>
<li>type 文字类型：默认主要文字、secondary 次要文字浅灰色、warning 警告文字橘黄色、danger 错误文字红色。disabled 失效文字。mark 使用 mark 节点渲染。code 使用 code 节点渲染。underline 使用 u 节点渲染。delete 使用 del 节点渲染。strong 使用 strong 节点渲染。</li>
</ul>
</li>
</ul>
<h2 id="布局组件"><a href="#布局组件" class="headerlink" title="布局组件"></a>布局组件</h2><h3 id="栅格-Grid"><a href="#栅格-Grid" class="headerlink" title="栅格 Grid"></a>栅格 Grid</h3><ul>
<li>功能特性：<ul>
<li>提供栅格布局功能。栅格布局基于 less 函数制作，并运用了 MediaQuery 样式特性。</li>
</ul>
</li>
<li>样式特性：<ul>
<li>flex 布局：Row 组件默认使用 block 绘制，可以基于 type 属性使用 flex 布局。flex 布局下，Row#justify 属性设置元素的水平对齐方式；Row#align 属性设置元素的垂直对齐方式；Col#order 属性设置元素的展示顺序。</li>
<li>Row#gutter 栅格间距（Row 组件设置左右减半负边距，Col 组件设置左右边距），间距可以根据屏幕大小动态调整。屏幕大小通过 enquire.js 库嗅探，以回调形式重绘组件。间距通过 Context 机制传入 Col 组件中。</li>
</ul>
</li>
</ul>
<h3 id="布局-Layout"><a href="#布局-Layout" class="headerlink" title="布局 Layout"></a>布局 Layout</h3><ul>
<li>功能特性：<ul>
<li>页面布局，包含 Header 头部、Content 内容、Sider 侧边栏、Footer 尾部。侧边栏可以展开折叠，由 Layout 组件通过收集折叠的侧边栏标识传入子组件中。</li>
</ul>
</li>
<li>样式特性：<ul>
<li>渲染时，Layout 组件使用 section 节点；Header 使用 header 节点；Content 使用 main 节点；Footer 使用 footer 节点。Layout 采用 flex 布局，主轴为垂直方向。</li>
<li>Sider#collapsible 激活侧边栏的展开折叠功能。其一可以通过触发按钮展开折叠侧边栏，其二基于 window.matchMedia 方式响应式展开折叠（触发按钮有两种，Sider 组件的展开折叠按钮、Sider 外围通过 Layout 获取状态的展开折叠按钮）。侧边栏内容由子组件渲染，侧边栏的展开折叠状态通过 Context 机制传递。</li>
<li>Sider#theme 设置侧边栏的样式主题。</li>
</ul>
</li>
</ul>
<h2 id="导航组件"><a href="#导航组件" class="headerlink" title="导航组件"></a>导航组件</h2><h3 id="固钉-Affix"><a href="#固钉-Affix" class="headerlink" title="固钉 Affix"></a>固钉 Affix</h3><ul>
<li>功能特性：<ul>
<li>绘制固钉。固钉会随着 target 节点的事件或者屏幕大小的调整改变位置。固钉的位置调整首先取决于 target 节点和固钉的渲染内容，因此 ant-design 首先会等待渲染完成，借助 raf （封装成方法的装饰器 throttleByAnimationFrameDecorator）调用 setState 重绘，重绘阶段经由 componentDidUpdate 生命周期计算固钉的偏移量等样式，再次使用 setState 进行重绘。依据屏幕大小的动态调整借助于 rc-resize-observer 库；依据 target 节点事件的动态调整借助于 rc-util 库绑定事件。</li>
</ul>
</li>
</ul>
<h3 id="面包屑-Breadcrumb"><a href="#面包屑-Breadcrumb" class="headerlink" title="面包屑 Breadcrumb"></a>面包屑 Breadcrumb</h3><p>Breadcrumb 组件测试脚本通过 MemoryRouter 组件实现。</p>
<ul>
<li>功能特性：<ul>
<li>绘制面包屑。面包屑内容既可以使用 Breadcrumb.Item 组件渲染，又可以基于 routes 路由属性渲染（基于路由渲染时，额外可以使用 itemRender 渲染函数获取面包屑元素）。</li>
</ul>
</li>
<li>样式特性：<ul>
<li>separator 分隔符，既可以通过 Breadcrumb#separator 属性设置，又可以通过 Breadcrumb.Separator 组件渲染。</li>
<li>Breadcrumb.Item#href 链接，设置后将使用 a 节点渲染，不然使用 span 节点渲染。</li>
<li>Breadcrumb.Item#overlay 下拉菜单的内容，下拉菜单通过 DropDown 组件渲染，展示位置在正下方。</li>
</ul>
</li>
</ul>
<h3 id="下拉菜单-DropDown"><a href="#下拉菜单-DropDown" class="headerlink" title="下拉菜单 DropDown"></a>下拉菜单 DropDown</h3><ul>
<li>功能特性<ul>
<li>提供下拉菜单的渲染容器。下拉菜单的触发节点 DropDown#children 和下拉菜单 DropDown#overlay 的内容都由开发者提供，一般菜单内容为 Menu 组件渲染内容。DropDown 会为下拉菜单内容传入 selectable=false, focusable=true 以及 expandIcon 图标属性。渲染容器基于 <a href="http://react-component.github.io/dropdown/" target="_blank" rel="noopener">rc-dropdown</a> 库实现，rc-dropdown 内部使用 <a href="https://github.com/react-component/trigger" target="_blank" rel="noopener">rc-trigger</a> 库。</li>
<li>DropDown.Button 不止于提供下拉菜单的渲染容器，同时也将触发节点设置为按钮。它的实现借助于 Button、DropDown 组件。</li>
</ul>
</li>
<li>样式特性：<ul>
<li>DropDown#getPopupContainer：基于 rc-trigger 库设置下拉菜单的渲染父节点，作为定位节点。</li>
<li>DropDown#align：基于 rc-trigger 库设置下拉菜单位置调整依据。</li>
<li>DropDown#placement：基于 rc-trigger 库设置下拉菜单的弹出位置。</li>
<li>DropDown#transitionName：基于 rc-trigger 库设置下拉菜单展示隐藏时的动效。</li>
<li>DropDown#trigger：基于 rc-trigger 库设置触发下拉菜单的行为 click、hover、contextMenu。当由 contextMenu 鼠标右键触发时，基于 rc-trigger 特性菜单位置也会跟随鼠标移动。</li>
<li>DropDown#forceRender、DropDown#mouseEnterDelay、DropDown#mouseLeaveDelay 等：均基于 rc-trigger 库实现。</li>
</ul>
</li>
</ul>
<h3 id="导航菜单-Menu"><a href="#导航菜单-Menu" class="headerlink" title="导航菜单 Menu"></a>导航菜单 Menu</h3><p>详情参考 <a href="/2018/12/10/antd/Menu/">菜单组件源码分析</a>。</p>
<ul>
<li>功能特性：<ul>
<li>渲染菜单。菜单的基本要素包含 Menu 菜单容器、SubMenu 子菜单、MenuItem 菜单项。菜单以 context 机制对外承接 Sider 侧边栏组件，对内透传折叠、主题状态到 SubMenu、MenuItem 组件。菜单渲染基于 <a href="https://github.com/react-component/menu" target="_blank" rel="noopener">rc-menu</a>、Tooltip 组件。</li>
<li>Menu 菜单容器，组织菜单顶层的展示模式、展开折叠内容及动效。</li>
<li>SubMenu 子菜单。</li>
<li>MenuItem 菜单项，以 Tooltip 组件绘制。</li>
</ul>
</li>
<li>样式特性：<ul>
<li>Menu#mode 展示模式：vertical 垂直、horizontal 水平、inline 子菜单内嵌三种。在内嵌子菜单模式下，展开的子菜单通过 state.openKeys, state.inlineOpenKeys 交换实现。</li>
<li>Menu#theme 主题：light 浅色、dark 深色两种。</li>
<li>Menu#openKeys、Menu#defaultOpenKeys 展开的子菜单；Menu#onOpenChange 展开的子菜单变更时调用；Menu#subMenuCloseDelay、Menu#subMenuOpenDelay 子菜单展开、折叠时延；</li>
<li>Menu#selectedKeys、Menu#defaultSelectedKeys 选中的菜单项；Menu#onSelect、Menu#onDeSelect 菜单项选中、取消选中时调用；Menu#selectable    是否可选；Menu#multiple 是否多选。</li>
<li>Menu#forceSubMenuRender 在子菜单展示之前就渲染进 DOM。</li>
<li>Menu#inlineCollapsed 内嵌模式下菜单是否收起；Menu#inlineIndent 内嵌模式下菜单缩进宽度。</li>
<li>Menu#onClick 菜单项点击时触发。</li>
<li>Menu#overflowedIndicator 菜单折叠时图标。</li>
</ul>
</li>
</ul>
<h3 id="Pagination-分页器"><a href="#Pagination-分页器" class="headerlink" title="Pagination 分页器"></a>Pagination 分页器</h3><p>分页器基于 <a href="https://github.com/react-component/pagination" target="_blank" rel="noopener">rc-pagination</a> 渲染。分页器分为非简洁模式和简洁模式两种。非简洁模式有三部分构成：总页数、翻页列表、每页显示条数。简洁模式只有翻页功能，没有总页数、每页显示条数。内置状态包含 current 当前页码、pageSize 每页显示条目数。外置状态 total 总页数用于更新当前页码。翻页功能包含跳转上/下一页；跳转前/后三（或五）页（当前页码在总页码中间态时）。操作方法基于简单改变 current、pageSize 延伸出跳转上/下一页、通过按键改变页码等方法。改变每页显示的 Select 组件由 rc-pagination 通过 props 属性传值。</p>
<h3 id="PageHeader-页头"><a href="#PageHeader-页头" class="headerlink" title="PageHeader 页头"></a>PageHeader 页头</h3><p>页头组合了 Breadcrumb 面包屑、Avatar 头像、Tag 标签等组件，用于绘制页头。</p>
<h3 id="Steps-步骤条"><a href="#Steps-步骤条" class="headerlink" title="Steps 步骤条"></a>Steps 步骤条</h3><p>步骤条基于 <a href="https://github.com/react-component/steps" target="_blank" rel="noopener">rc-steps</a> 渲染。Steps 组件主要包含一些样式特性，状态管理逻辑基本没有。当浏览器支持 flex 布局时，Step 采用 flex 布局渲染；不支持时，Step 采用百分比渲染：默认类型的 Steps 会用 margin 值为最后一个元素预留宽度（通过定时器计算最后一个元素的宽度，更新 state 以重绘），导航类型的 Steps 通过百分比均分宽度。</p>
<h2 id="数据录入"><a href="#数据录入" class="headerlink" title="数据录入"></a>数据录入</h2><h3 id="AutoComplete-自动完成"><a href="#AutoComplete-自动完成" class="headerlink" title="AutoComplete 自动完成"></a>AutoComplete 自动完成</h3><p>自动完成组件基于 Select、Input 组件制作，主要逻辑也由 Select 组件承担。</p>
<h3 id="Checkbox-复选框、Radio-单选框"><a href="#Checkbox-复选框、Radio-单选框" class="headerlink" title="Checkbox 复选框、Radio 单选框"></a>Checkbox 复选框、Radio 单选框</h3><p>Checkbox 复选框、Radio 单选框可以参考 <a href="/2018/11/27/antd/Radio,%20Checkbox/">Radio, Checkbox</a>。</p>
<h3 id="Cascader-级联选择"><a href="#Cascader-级联选择" class="headerlink" title="Cascader 级联选择"></a>Cascader 级联选择</h3><h4 id="rc-cascader"><a href="#rc-cascader" class="headerlink" title="rc-cascader"></a>rc-cascader</h4><p>级联选择基于 <a href="https://github.com/react-component/cascader" target="_blank" rel="noopener">rc-cascader</a> 制作。rc-cascader 的实现又基于 <a href="https://github.com/react-component/trigger" target="_blank" rel="noopener">rc-trigger</a> 抽象弹层逻辑、<a href="https://github.com/afc163/array-tree-filter" target="_blank" rel="noopener">array-tree-filter</a> 扁平化、过滤树形数据。</p>
<p>实际的触发节点 props.children 通过 React.cloneElement 绑定 onKeyDown 键盘事件。如果 props.children 定义了 onKeyDown 方法，则取用该方法进行处理；如果没有，则使用 rc-cascader 内置的处理逻辑，包含 up/down 上下选、left/backspace 回选、right 向前选、esc/tab 隐藏等功能。</p>
<p>在 rc-cascader 中，array-tree-filter 负责根据级联选择的动态 value 值计算待展示的弹层菜单列表（即弹层菜单中，第二列起的次级列表，其与树结构首层混合，构成当前下拉菜单中展示的完整内容）。菜单中每个选项根据 label 值渲染内容，同时可以包含展开、加载中按钮；选项支持的交互行为包含双击隐藏弹层、点击选中、鼠标移入移出选中。选中的选项存入本地缓存中，在弹层显示状态更新时，用于使选项列表滚动至选中元素上（通过节点的 scrollTop 属性设置）。选项选中逻辑为：如果选中选项为否值或 disabled 状态，直接返回；如果级联选择开启了远程加载 loadData 功能，且选中选项不是叶子节点，首先基于 changeOnSelect 向外透出选中列表，然后更新级联选择的 state.activeValue 状态值并加载远程数据；如果只使用本地数据，且选中选项是叶子节点，向外透出选中列表并更新 state.value 状态值；如果只使用本地数据，根据 expandTrigger 触发行为向外透传选中列表、条件隐藏弹层，并更新 state。value 状态值。</p>
<h4 id="Cascader"><a href="#Cascader" class="headerlink" title="Cascader"></a>Cascader</h4><p>Cascader 组件在 rc-cascader 的基础上，默认使用输入框作为触发节点，也可以使用 props.children 替换。输入框有只读态、showSearch 搜索态两种：只读态基于  rc-cascader 点击展开弹层；搜索态阻止点击事件冒泡、支持失焦行为、键盘事件阻止 space/backspace 按键隐藏弹层、change 事件改编 inputValue 值（渲染时更新弹层选项列表）。选中的值在输入框中的表现通过固定定位的 span 节点渲染。输入框内可设置 allowClear 清空图标、suffixIcon 后缀图标。</p>
<p>输入框触发器能基于 SizeContext 获得外层传入的 size 尺寸。Cascader 对外提供的 ref 引用，可以使用 focus、blur 方法获得或失去焦点；input 属性即输入框节点。</p>
<p>全量的选项列表会通过扁平化处理。在渲染时，Cascader 会基于输入框的值进行筛选；筛选内容有最大展示条目限制；筛选内容有最大展示条目限制；选项内容可排序（以上，均可通过 props.showSearch 设置）。当没有（匹配的）选项时，展示空态。</p>
<p>弹层位置可基于 props.popupPlacement 或通过 ConfigContext 传入的 direction 设置（右下或左下对齐）。弹层大小可基于 props.showSearch.matchInputWidth 设置为与输入框等宽。弹层容器可基于 props.getPopupContainer 或通过 ConfigContext 传入的 getPopupContainer 设置。</p>
<p>Cascader 组件的值、弹层显示状态均是受控的；对外回调接口包含 onChange、onPopupVisibleChange。</p>
<h3 id="DatePicker-日期选择框"><a href="#DatePicker-日期选择框" class="headerlink" title="DatePicker 日期选择框"></a>DatePicker 日期选择框</h3><p>DatePicker 组件基于 <a href="http://xzfyu.com/2020/02/13/antd/DatePicker/" target="_blank" rel="noopener">rc-picker</a> 制作，它指定 moment 作为时间处理工具，并从上下文中获取 locale、size 属性等，以提供时间选择的功能。</p>
<h3 id="Form-表单"><a href="#Form-表单" class="headerlink" title="Form 表单"></a>Form 表单</h3><p>可参考 <a href="http://xzfyu.com/2018/11/04/antd/Form/" target="_blank" rel="noopener">Form</a>。</p>
<h3 id="InputNumber-数字输入框"><a href="#InputNumber-数字输入框" class="headerlink" title="InputNumber 数字输入框"></a>InputNumber 数字输入框</h3><h3 id="Input-输入框"><a href="#Input-输入框" class="headerlink" title="Input 输入框"></a>Input 输入框</h3>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/22/react/react fiber 2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/22/react/react fiber 2/" itemprop="url">未命名</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-22T17:03:13+08:00">2020-02-22</time>
            

            
            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/02/22/react/react fiber 2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/02/22/react/react fiber 2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="fiber-tag-类型"><a href="#fiber-tag-类型" class="headerlink" title="fiber.tag 类型"></a>fiber.tag 类型</h3><p><a href="https://github.com/facebook/react/blob/v16.12.0/packages/shared/ReactWorkTags.js#L35" target="_blank" rel="noopener">ReactWorkTags.js</a> 展示了 fiber 的类型（基于不同的类型会作不同处理）：</p>
<ul>
<li>FunctionComponent：函数式组件。React$ElementType 为构造函数。</li>
<li>ClassComponent：类组件。React$ElementType 为函数。</li>
<li>HostComponent：Host 组件（如 DOM 节点）。React$ElementType 为 string。</li>
<li>Fragment：Fragment 组件。React$ElementType 为 REACT_FRAGMENT_TYPE。</li>
<li>Mode：React$ElementType 为 REACT_CONCURRENT_MODE_TYPE 或 REACT_STRICT_MODE_TYPE。</li>
<li>Profiler：React$ElementType 为 REACT_PROFILER_TYPE。</li>
<li>SuspenseComponent：React$ElementType 为 REACT_SUSPENSE_TYPE。</li>
<li>SuspenseListComponent：React$ElementType 为 REACT_SUSPENSE_LIST_TYPE。</li>
<li>IndeterminateComponent：</li>
<li>HostRoot：</li>
<li>HostPortal：</li>
<li>HostText：</li>
<li>ContextConsumer：Context.Consumer 组件。React$ElementType 为对象，React$ElementType$$typeof 为 REACT_CONTEXT_TYPE。</li>
<li>ContextProvider：Context.Provider 组件。React$ElementType 为对象，React$ElementType$$typeof 为 REACT_PROVIDER_TYPE。</li>
<li>ForwardRef：React$ElementType 为对象，React$ElementType$$typeof 为 REACT_FORWARD_REF_TYPE。</li>
<li>MemoComponent：React$ElementType 为对象，React$ElementType$$typeof 为 REACT_MEMO_TYPE。</li>
<li>LazyComponent：React$ElementType 为对象，React$ElementType$$typeof 为 REACT_LAZY_TYPE。</li>
<li>FundamentalComponent：React$ElementType 为对象，React$ElementType$$typeof 为 REACT_FUNDAMENTAL_TYPE。</li>
<li>ScopeComponent：React$ElementType 为对象，React$ElementType$$typeof 为 REACT_SCOPE_TYPE。</li>
<li>SimpleMemoComponent：</li>
<li>IncompleteClassComponent：</li>
<li>DehydratedFragment：</li>
<li>Chunk：</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/22/react/react fiber 搜罗整理篇/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/22/react/react fiber 搜罗整理篇/" itemprop="url">react fiber 搜罗整理篇</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-22T00:00:00+08:00">2020-02-22</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/react/" itemprop="url" rel="index"><span itemprop="name">react</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/02/22/react/react fiber 搜罗整理篇/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/02/22/react/react fiber 搜罗整理篇/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="fiber-出台的原委和特性"><a href="#fiber-出台的原委和特性" class="headerlink" title="fiber 出台的原委和特性"></a>fiber 出台的原委和特性</h2><blockquote class="blockquote-center"><p>The crux of the change is transitioning from processing updates in a synchronous, recursive way to relying on asynchronous scheduling and prioritization of interface changes. </p>
</blockquote>
<p><a href="https://makersden.io/blog/look-inside-fiber/" target="_blank" rel="noopener">A look inside React Fiber</a> 指明，react 演进出 fiber 架构的关键点在于渲染策略的变更，从原先的 Stack Reconciler 同步递归模式转变为 Fiber Reconciler 基于优先级的异步调度模式。这样就能避免其他文章所说的，Stack Reconciler 模式中的 JS 运算、页面布局和页面绘制将长期占用主线程，页面出现掉帧的现象。依照官方文档 <a href="https://reactjs.org/docs/codebase-overview.html#fiber-reconciler" target="_blank" rel="noopener">Codebase Overview</a>，Fiber Reconciler 包含如下特性：</p>
<ul>
<li>将工作拆分为任务单元，实现增量渲染</li>
<li>按类型为任务单元设置优先级</li>
<li>任务单元可暂停、复用或中止</li>
<li>任务单元可并发执行</li>
</ul>
<p><a href="http://www.ayqy.net/blog/dive-into-react-fiber/" target="_blank" rel="noopener">完全理解 React Fiber</a> 提到增量渲染所采用的 cooperative scheduling 合作式调度是操作系统 3 种任务调度策略中的一种。其内容为：将渲染工作拆解，每次只做一小段，做完看是否还有时间继续下一个任务，没有就把时间控制权交还给主线程，有就继续处理下一个任务。</p>
<p><a href="https://github.com/acdlite/react-fiber-architecture" target="_blank" rel="noopener">React Fiber Architecture</a> 也指出，这一处理机跟 <a href="https://en.wikipedia.org/wiki/Call_stack" target="_blank" rel="noopener">call stack</a> 将执行函数作为栈帧添加到堆栈中相似。在处理 ui 时，浏览器提供了可用的 api：requestIdleCallback 会调度在空闲期间调用的低优先级函数；requestAnimationFrame 会调度在下一个动画帧上调用的高优先级函数。在 React 中，单个 fiber 就如同栈帧。React 的调度策略基于 pull 模式智能应用更新（基于 push 模式需要由开发者自主决定哪些更新是要应用的），且为不同的 fiber 设置不同的优先级，可以避免不必要的 UI 更新。</p>
<h2 id="React-分层模型和数据结构"><a href="#React-分层模型和数据结构" class="headerlink" title="React 分层模型和数据结构"></a>React 分层模型和数据结构</h2><p>推演 <a href="https://www.zcfy.cc/original/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react" target="_blank" rel="noopener">Inside Fiber: in-depth overview of the new reconciliation algorithm in React</a> 提及的，React 各分层的数据处理走向比如：</p>
<ul>
<li>用户侧创建 Class 或 Function 组件、Host 组件（如 DOM 节点）、Protals 等；</li>
<li>通过 React.createElement 创建 React 元素树，用于描述页面的呈现（<a href="https://www.zcfy.cc/original/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react" target="_blank" rel="noopener">Inside Fiber: in-depth overview of the new reconciliation algorithm in React</a> 坚持认为 Virtual DOM 实际上指的是不可改变的 React 元素树）；</li>
<li>基于 React 元素树创建 fiber 节点树（也称为 internal instances 内部实例树）；</li>
<li>最后由 fiber 节点树获得具体平台相关的 public instance（也称为 Host instance，如真实的 DOM 树）。</li>
</ul>
<p>上述数据结构的后半部分对应着 React 中的两个分层：</p>
<ul>
<li>Reconciler 层：执行 reconciliation 流程，通过 diff 算法等将组件状态变化反应为视图内容，并触发 side-effects（调用生命周期方法、更新 ref）等。</li>
<li>Renderer 层：根据不同的平台，渲染出真实的内容，比较常见的是 ReactDOM、ReactNative。</li>
</ul>
<h2 id="fiber，作为-unit-of-work"><a href="#fiber，作为-unit-of-work" class="headerlink" title="fiber，作为 unit of work"></a>fiber，作为 unit of work</h2><h3 id="fiber-基本结构"><a href="#fiber-基本结构" class="headerlink" title="fiber 基本结构"></a>fiber 基本结构</h3><p>fiber 节点可基于 React 元素创建，通过调用 <a href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiber.js#L593" target="_blank" rel="noopener">createFiberFromTypeAndProps.js</a> 实现。实际上，创建 fiber 节点不止于基于 React 元素一种。fiber 节点会以单向链表的形式构成节点树。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> type Fiber = &#123;|</span><br><span class="line">  <span class="comment">/** 1. 承接 React 元素的相关属性 **/</span></span><br><span class="line">  tag: WorkTag,<span class="comment">// fiber 节点的工作类型</span></span><br><span class="line">  elementType: any,<span class="comment">// react 元素类型</span></span><br><span class="line">  key: <span class="literal">null</span> | string,<span class="comment">// 用于 diff 算法的 key 键</span></span><br><span class="line">  type: any,<span class="comment">// 类组件构造函数或函数组件自身</span></span><br><span class="line">  ref:<span class="comment">// 引用</span></span><br><span class="line">    | <span class="literal">null</span></span><br><span class="line">    | <span class="function">(<span class="params">((handle: mixed</span>) =&gt;</span> <span class="keyword">void</span>) &amp; &#123;<span class="attr">_stringRef</span>: ?string, ...&#125;)</span><br><span class="line">    | RefObject,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** 2. props &amp; state **/</span></span><br><span class="line">  <span class="comment">// React 元素类型的引用，可以认为这个属性保存了与 fiber 相关的本地状态</span></span><br><span class="line">  stateNode: any,</span><br><span class="line">  pendingProps: any,<span class="comment">// 待更新的 props</span></span><br><span class="line">  memoizedProps: any,<span class="comment">// 更新后的 props，作为输出透出到页面侧</span></span><br><span class="line">  memoizedState: any,<span class="comment">// 更新后的 state，作为输出透出到页面侧</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/** 存放 fiber 依赖的 contexts, events **/</span></span><br><span class="line">  dependencies: Dependencies | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** 3. fiber 树结构 **/</span></span><br><span class="line">  <span class="keyword">return</span>: Fiber | <span class="literal">null</span>, <span class="comment">// 类同堆栈的返回栈帧，通常是父节点</span></span><br><span class="line">  child: Fiber | <span class="literal">null</span>,<span class="comment">// 子节点</span></span><br><span class="line">  sibling: Fiber | <span class="literal">null</span>,<span class="comment">// 邻近的兄弟节点</span></span><br><span class="line">  index: number,</span><br><span class="line">|&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="fiber-工作单元"><a href="#fiber-工作单元" class="headerlink" title="fiber 工作单元"></a>fiber 工作单元</h3><p>fiber 节点树不像剥离掉 diff 算法后的 Virtual DOM 那样仅是一种表现，它内部集成了可调度工作任务以操作树的算法。<a href="https://www.zcfy.cc/original/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react" target="_blank" rel="noopener">Inside Fiber: in-depth overview of the new reconciliation algorithm in React</a> 称单个 fiber 节点就是一个工作单元，这也是源码中的表现：</p>
<blockquote class="blockquote-center"><p>You can think of a fiber as a data structure that represents some work to do or, in other words, a unit of work. Fiber’s architecture also provides a convenient way to track, schedule, pause and abort the work.</p>
</blockquote>
<h4 id="current-tree-amp-work-in-progress-tree"><a href="#current-tree-amp-work-in-progress-tree" class="headerlink" title="current tree &amp; work-in-progress tree"></a>current tree &amp; work-in-progress tree</h4><ul>
<li>current tree：首次渲染或更新后设置，描述页面的当前展现；</li>
<li>work-in-progress tree：更新时用于页面呈现所需的操作，更新后会替代 current tree。</li>
</ul>
<p>使用 work-in-progress tree 直接替代 current tree 称为 double buffering 双缓冲技术，这样便于复用 fiber 对象、节省内存分配和 GC 的时间开销。current tree、work-in-progress tree 处理的简要流程如下：</p>
<p>首次渲染时，渲染完成的 fiber 节点树称为 current tree；更新渲染时，fiber 节点将被重用，current tree 会维持不变，更新内容反应为另一个 fiber 节点树 work-in-progress tree。当所有渲染流程走完时，work-in-progress tree 会被刷新到页面上，并成为新的 current tree（即 current tree 表示已渲染内容；work-in-progress tree 表示处理中的渲染内容）。current tree、work-in-progress tree 中的 fiber 节点以 alternate 属性相互持有对方，这样结对的处理方式便于延后批量应用更新内容，支持工作任务的可打断。下文将表明，Fiber Reconciler 的更新机制分为两阶段，render 阶段处理并获得以 work-in-progress tree 呈现的更新，commit 阶段应用 work-in-progress tree 的更新。</p>
<h4 id="update-queue"><a href="#update-queue" class="headerlink" title="update queue"></a>update queue</h4><p>可变的 state 更新会以 fiber.updateQueue 形式应用。<a href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactUpdateQueue.js#L10" target="_blank" rel="noopener">ReactUpdateQueue.js</a> 中阐明，UpdateQueue 跟 fiber 一样，也有 current queue、work-in-progress queue 两个队列。这两个队列共享同一个持久化的单链接链表。区别在于，这两个队列中指向活动中的 update 指针不同，work-in-progress 的指针索引在 render 阶段必然会大于或等于 current queue 的指针索引。提交阶段时，work-in-progress queue 会成为新的 current queue。任务的可中断正是在于，执行中的 work-in-progress queue 可被丢弃，并从 current queue 重新复制一份。</p>
<p>UpdateQueue 队列中的每个 update 任务有优先级标识。Reconciler 会根据优先级执行 update 任务。<a href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactUpdateQueue.js#L10" target="_blank" rel="noopener">ReactUpdateQueue.js</a> 指出需要特别注意的是，位于跳过的较低优先级之后高优先级任务仍旧会驻留在 UpdateQueue 队列中，就会造成这些高优先级任务被执行多次。正是因为这个原因，所以 render 阶段的生命周期函数才会打上 UNSAFE_ 标识，它们同样也会被执行多次，可能形成不必要的副作用（如在 UNSAFE_componentWillMount 中获取远程数据，请求就会发送多次）。</p>
<h4 id="expiration-time"><a href="#expiration-time" class="headerlink" title="expiration time"></a>expiration time</h4><p>fiber 任务的优先级与 fiber.expirationTime 息息相关。留待下回分解。</p>
<h4 id="side-effects"><a href="#side-effects" class="headerlink" title="side effects"></a>side effects</h4><p>除了 state 更新以外，react 官方将更新 ref 引用、调用生命周期、订阅 state 变更 dom 等都视为 side effects。<a href="https://www.zcfy.cc/original/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react" target="_blank" rel="noopener">Inside Fiber: in-depth overview of the new reconciliation algorithm in React</a> 引用了官方的原话：</p>
<blockquote class="blockquote-center"><p>You’ve likely performed data fetching, subscriptions, or manually changing the DOM from React components before. We call these operations “side effects” (or “effects” for short) because they can affect other components and can’t be done during rendering.</p>
</blockquote>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> type Fiber = &#123;|</span><br><span class="line">  <span class="comment">// current tree、work-in-progress tree 中的 fiber 节点以 alternate 属性相互持有对方</span></span><br><span class="line">  alternate: Fiber | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">// state 更新处理队列，以链表形式呈现</span></span><br><span class="line">  updateQueue: UpdateQueue&lt;any&gt; | <span class="literal">null</span>,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** 优先级 **/</span></span><br><span class="line">  expirationTime: ExpirationTime,<span class="comment">// fiber 任务预期执行时间，不包含子树中的更新</span></span><br><span class="line">  childExpirationTime: ExpirationTime,<span class="comment">// 用于判断子树中的任务是否执行完成</span></span><br><span class="line">  <span class="comment">// 以下四字段在 enableProfilerTimer 为 true 时设置</span></span><br><span class="line">  actualDuration?: number,<span class="comment">// 当前 fiber 及子孙的渲染时间，rerender 时重置为 0</span></span><br><span class="line">  actualStartTime?: number,<span class="comment">// render 阶段，fiber 任务开始时间</span></span><br><span class="line">  selfBaseDuration?: number,<span class="comment">// 当前 fiber 的历史渲染时间</span></span><br><span class="line">  treeBaseDuration?: number,<span class="comment">// 当前 fiber 子孙节点的历史渲染时间</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 用于描述 fiber 及其子树的特性，ConcurrentMode 表示默认情况下子树是否应异步</span></span><br><span class="line">  <span class="comment">// 创建 fiber 时，默认继承父节点的 mode，创建时可修改，fiber 生命周期中将维持不变</span></span><br><span class="line">  mode: TypeOfMode,</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** side-effects **/</span></span><br><span class="line">  effectTag: SideEffectTag,</span><br><span class="line">  nextEffect: Fiber | <span class="literal">null</span>,<span class="comment">// 链表结构，指向下一个带有 side-effects 的 fiber</span></span><br><span class="line">  firstEffect: Fiber | <span class="literal">null</span>,<span class="comment">// 链表中的首节点，便于快速更新链表</span></span><br><span class="line">  lastEffect: Fiber | <span class="literal">null</span>,<span class="comment">// 链表中的尾节点，便于快速更新链表</span></span><br><span class="line">|&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="render、commit-两阶段渲染"><a href="#render、commit-两阶段渲染" class="headerlink" title="render、commit 两阶段渲染"></a>render、commit 两阶段渲染</h2><p>如上文已指出，React 将渲染过程分为 render/reconciliation、commit 两阶段。<a href="http://www.ayqy.net/blog/dive-into-react-fiber/" target="_blank" rel="noopener">完全理解 React Fiber</a> 将这两阶段类比为 Virtual DOM 技术中的 diff、patch 过程。</p>
<ul>
<li>render 阶段计算并获取以 work-in-progress tree 呈现的更新，可中断；</li>
<li>commit 阶段应用 work-in-progress tree 的更新。</li>
</ul>
<p><a href="https://github.com/acdlite/react-fiber-architecture" target="_blank" rel="noopener">React Fiber Architecture</a> 中的以下描述也说明了两阶段的主要内容：</p>
<blockquote class="blockquote-center"><p> reconciliation：The algorithm React uses to diff one tree with another to determine which parts need to be changed.<br>update：A change in the data used to render a React app. Usually the result of <code>setState</code>. Eventually results in a re-render.</p>
</blockquote>
<img src="/2020/02/22/react/react%20fiber%20搜罗整理篇/lifecycle.png">
<h3 id="render-阶段"><a href="#render-阶段" class="headerlink" title="render 阶段"></a>render 阶段</h3><p>首次渲染时，reconciler 基于 React 元素创建 fiber，最终形成 fiber 节点树 current tree。当更新时，reconciler 会遍历 current tree，复用 fiber.alternate 备用节点，生成 work-in-progress tree。因为单个 fiber 也是 unit of work，work-in-progress tree 也可以称为任务单元树。</p>
<p>reconciler 会通过 performSyncWorkOnRoot、performConcurrentWorkOnRoot 函数启动 <a href="https://github.com/facebook/react/blob/v16.12.0/packages/react-reconciler/src/ReactFiberWorkLoop.js#L1459" target="_blank" rel="noopener">work-loop 循环</a> 。该循环会使用深度优先算法处理 work-in-progress tree，只有经过更新的 fiber 节点才会被处理。work-loop 循环有以下四种处理函数：</p>
<ul>
<li>performUnitOfWork：从 work-in-progress tree 中取出 fiber ，</li>
<li>beginWork：context 入栈后，更新当前 fiber 节点的 props、state 相关属性，视条件更新 side effects 链表，返回 fiber.child。</li>
<li>completeUnitOfWork：视条件更新 side effects 链表，返回 fiber.sibling 或 fiber.return。</li>
<li>completeWork：context 出栈等操作。</li>
</ul>
<p>performUnitOfWork、completeUnitOfWork 主要用于迭代 fiber 节点，主要更新活动由 beginWork、completeWork 完成。以下是这四种函数迭代节点的流程：</p>
<img src="/2020/02/22/react/react%20fiber%20搜罗整理篇/loop-work.gif">
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">workLoopSync</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (workInProgress !== <span class="literal">null</span>) &#123;</span><br><span class="line">    workInProgress = performUnitOfWork(workInProgress);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">performUnitOfWork</span>(<span class="params">workInProgress</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> next = beginWork(workInProgress);</span><br><span class="line">  <span class="keyword">if</span> (next === <span class="literal">null</span>) &#123;</span><br><span class="line">    next = completeUnitOfWork(workInProgress);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> next;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">beginWork</span>(<span class="params">workInProgress</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'work performed for '</span> + workInProgress.name);</span><br><span class="line">  <span class="keyword">return</span> workInProgress.child;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">completeUnitOfWork</span>(<span class="params">unitOfWork</span>) </span>&#123;</span><br><span class="line">  workInProgress = unitOfWork;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> current = workInProgress.alternate;</span><br><span class="line">    <span class="keyword">const</span> returnFiber = workInProgress.return;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((workInProgress.effectTag &amp; Incomplete) === NoEffect) &#123;</span><br><span class="line">      <span class="keyword">let</span> next = completeWork(current, workInProgress, renderExpirationTime);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (next !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (returnFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> next = unwindWork(workInProgress, renderExpirationTime);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (next !== <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> next;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (siblingFiber !== <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="comment">// If there is more work to do in this returnFiber, do that next.</span></span><br><span class="line">      <span class="keyword">return</span> siblingFiber;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Otherwise, return to the parent</span></span><br><span class="line">    workInProgress = returnFiber;</span><br><span class="line">  &#125; <span class="keyword">while</span> (workInProgress !== <span class="literal">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">completeWork</span>(<span class="params">workInProgress</span>) </span>&#123;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">'work completed for '</span> + workInProgress.name);</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>综上，更新时会生成部分节点带有 side effects 标识的 work-in-progress tree。effects list 链表会向上归并到父节点上，它会指示需要插入、更新或删除哪些节点，以及哪些组件需要调用其生命周期方法。current tree、work-in-progress tree、effects list 就是 render 阶段的所有产物（work-in-progress tree 在此时也被称为 finished-work tree）。</p>
<h3 id="commit-阶段"><a href="#commit-阶段" class="headerlink" title="commit 阶段"></a>commit 阶段</h3><p>commit 阶段的主要工作在于将 effects list 链表应用到 fiber 节点树上。这部分工作由 finishSyncRender、finishConcurrentRender 函数启动。主要功能则由 <a href="https://github.com/facebook/react/blob/master/packages/react-reconciler/src/ReactFiberWorkLoop.js#L1720" target="_blank" rel="noopener">commitRootImpl.js</a> 完成。<a href="https://www.zcfy.cc/original/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react" target="_blank" rel="noopener">Inside Fiber: in-depth overview of the new reconciliation algorithm in React</a> 指出它包含如下操作：</p>
<ul>
<li>对标记了 Snapshot effect 的节点调用 getSnapshotBeforeUpdate 生命周期方法</li>
<li>对标记了 Deletion effect 的节点调用 componentWillUnmount 生命周期方法</li>
<li>执行所有 DOM 插入、更新和删除操作</li>
<li>将 finished-work tree 分配给 FiberRoot，并置为 current tree</li>
<li>对标记了 Placement effect 的节点调用 componentDidMount 生命周期方法</li>
<li>对标记了 Update effect 的节点调用 componentDidUpdate 生命周期方法</li>
</ul>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>react fiber 是笔者长期没法啃下来的内容。这篇文章由以下文章汇总整理得来，却未对 scheduler、fiber 的优先级及类型等加诸说明。个中惭愧与骄傲处，留诗为念。</p>
<p>满身金紫一毛猴，偏腾赤手摘蟠桃。<br>不慎数声尽入水，引得御马都发笑。</p>
<p><a href="https://www.zcfy.cc/original/inside-fiber-in-depth-overview-of-the-new-reconciliation-algorithm-in-react" target="_blank" rel="noopener">Inside Fiber: in-depth overview of the new reconciliation algorithm in React</a><br><a href="https://zhuanlan.zhihu.com/p/57346388" target="_blank" rel="noopener">[译]深入React fiber架构及源码</a><br><a href="https://github.com/acdlite/react-fiber-architecture" target="_blank" rel="noopener">React Fiber Architecture</a><br><a href="http://www.ayqy.net/blog/dive-into-react-fiber/" target="_blank" rel="noopener">完全理解 React Fiber</a><br><a href="https://makersden.io/blog/look-inside-fiber/" target="_blank" rel="noopener">A look inside React Fiber</a><br><a href="https://www.cnblogs.com/Darlietoothpaste/p/9941117.html" target="_blank" rel="noopener">React Fiber 源码分析</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/17/工程化/umi运行时插件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/17/工程化/umi运行时插件/" itemprop="url">umi 运行时插件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-17T00:00:00+08:00">2020-02-17</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端工程化/" itemprop="url" rel="index"><span itemprop="name">前端工程化</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/02/17/工程化/umi运行时插件/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/02/17/工程化/umi运行时插件/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="运行原理"><a href="#运行原理" class="headerlink" title="运行原理"></a>运行原理</h2><p>runtimePlugin 运行时插件也遵循先注册、后使用的流程。运行时插件表现为数组形式，数组项为运行时插件的导出对象。导出对象中的属性可以是函数、或对象、返回对象的 Promise（前者可称为执行类导出，后两者可称为配置类导出，因其用于获取配置项）。umi 包中的 runtimePlugin.js 提供了如下方法：</p>
<ul>
<li>plugins：运行时插件集合。</li>
<li>validKeys：校验 key 键集合。</li>
<li>init({ validKeys })：清空 plugins，赋值 plugins。</li>
<li>use(plugin)：注册插件，并校验插件的 key 键。</li>
<li>getItem(key)：获取 key 键为指定值的插件。</li>
<li>compose(item, { initialValue })：选用执行类导出以 reduce 机制依次执行其中的函数，函数执行时参数为上游的返回值。</li>
<li>apply(item, { initialValue, args })：选用执行类导出以 reduce 机制依次执行其中的函数，函数执行时参数为上游的返回值 memo，以及 apply 调用时传参 args。</li>
<li>applyForEach(item, { initialValue })：选用执行类导出以 array.forEach 机制依次执行其中的函数，函数执行时参数为 initialValue。</li>
<li>mergeConfig(item)：选用纯对象配置类导出，混合其配置输出。</li>
<li>mergeConfigAsync(item)：选用 Promise 形式的配置类导出，混合其配置输出。</li>
</ul>
<p>上述方法的有效性都依赖于 plugins 运行时插件集合、validKeys 校验 key 键集合非空。那么，plugins、validKeys 都是在什么装填进内容的呢？采用倒溯法，我们可以在 umi-build-dev 包下的 entry.js.tpl 入口文件模板中找到如下代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> plugins = <span class="built_in">require</span>(<span class="string">'umi/_runtimePlugin'</span>);<span class="comment">// 实际就是 umi 包中的 runtimePlugin.js</span></span><br><span class="line">&#123;&#123;#globalVariables&#125;&#125;</span><br><span class="line"><span class="built_in">window</span>.g_plugins = plugins;</span><br><span class="line">&#123;&#123;/globalVariables&#125;&#125;</span><br><span class="line">plugins.init(&#123;</span><br><span class="line">  validKeys: [&#123;&#123;#validKeys&#125;&#125;'&#123;&#123;&#123; . &#125;&#125;&#125;',&#123;&#123;/validKeys&#125;&#125;],</span><br><span class="line">&#125;);</span><br><span class="line">&#123;&#123;#plugins&#125;&#125;</span><br><span class="line">plugins.use(<span class="built_in">require</span>(<span class="string">'&#123;&#123;&#123; . &#125;&#125;&#125;'</span>));</span><br><span class="line">&#123;&#123;/plugins&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>上述入口文件模板代码也即意味着 umi 在启动时会将运行时插件及其校验 key 键集合通过 mustache 模板引擎装填到入口文件中，以便其他调用文件所使用。实际入口文件内容由以下代码填充：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** umi-build-dev *** FilesGenerator.js ***/</span></span><br><span class="line"><span class="comment">// 调用 addRuntimePlugin 插件钩子，获得 umi 内部以及各 umi-plugin-* 注册的运行时插件</span></span><br><span class="line"><span class="keyword">const</span> plugins = <span class="keyword">this</span>.service</span><br><span class="line">  .applyPlugins(<span class="string">'addRuntimePlugin'</span>, &#123;</span><br><span class="line">    initialValue: [],</span><br><span class="line">  &#125;)</span><br><span class="line">  .map(<span class="function"><span class="params">plugin</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> winPath(relative(paths.absTmpDirPath, plugin));</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 调用 addRuntimePluginKey 插件钩子，获得 umi 内部以及各 umi-plugin-* 注册的运行时插件校验 key 键</span></span><br><span class="line"><span class="keyword">const</span> validKeys = <span class="keyword">this</span>.service.applyPlugins(<span class="string">'addRuntimePluginKey'</span>, &#123;</span><br><span class="line">  initialValue: [</span><br><span class="line">    <span class="string">'patchRoutes'</span>,</span><br><span class="line">    <span class="string">'render'</span>,</span><br><span class="line">    <span class="string">'rootContainer'</span>,</span><br><span class="line">    <span class="string">'modifyRouteProps'</span>,</span><br><span class="line">    <span class="string">'onRouteChange'</span>,</span><br><span class="line">    <span class="string">'modifyInitialProps'</span>,</span><br><span class="line">    <span class="string">'initialProps'</span>,</span><br><span class="line">  ],</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 mustache 模板引擎生成入口文件内容，为其装填运行时插件及其校验 key 键</span></span><br><span class="line"><span class="keyword">const</span> entryContent = Mustache.render(entryTpl, &#123;</span><br><span class="line">  globalVariables: !<span class="keyword">this</span>.service.config.disableGlobalVariables,</span><br><span class="line">  code: <span class="keyword">this</span>.service</span><br><span class="line">    .applyPlugins(<span class="string">'addEntryCode'</span>, &#123;</span><br><span class="line">      initialValue: [],</span><br><span class="line">    &#125;)</span><br><span class="line">    .join(<span class="string">'\n\n'</span>),</span><br><span class="line">  codeAhead: <span class="keyword">this</span>.service</span><br><span class="line">    .applyPlugins(<span class="string">'addEntryCodeAhead'</span>, &#123;</span><br><span class="line">      initialValue: [],</span><br><span class="line">    &#125;)</span><br><span class="line">    .join(<span class="string">'\n\n'</span>),</span><br><span class="line">  imports: importsToStr(</span><br><span class="line">    <span class="keyword">this</span>.service.applyPlugins(<span class="string">'addEntryImport'</span>, &#123;</span><br><span class="line">      initialValue: moduleBeforeRenderer,</span><br><span class="line">    &#125;),</span><br><span class="line">  ).join(<span class="string">'\n'</span>),</span><br><span class="line">  importsAhead: importsToStr(</span><br><span class="line">    <span class="keyword">this</span>.service.applyPlugins(<span class="string">'addEntryImportAhead'</span>, &#123;</span><br><span class="line">      initialValue: [],</span><br><span class="line">    &#125;),</span><br><span class="line">  ).join(<span class="string">'\n'</span>),</span><br><span class="line">  polyfillImports: importsToStr(</span><br><span class="line">    <span class="keyword">this</span>.service.applyPlugins(<span class="string">'addEntryPolyfillImports'</span>, &#123;</span><br><span class="line">      initialValue: [],</span><br><span class="line">    &#125;),</span><br><span class="line">  ).join(<span class="string">'\n'</span>),</span><br><span class="line">  moduleBeforeRenderer,</span><br><span class="line">  render: initialRender,</span><br><span class="line">  plugins,</span><br><span class="line">  validKeys,</span><br><span class="line">  htmlTemplateMap: htmlTemplateMap.join(<span class="string">'\n'</span>),</span><br><span class="line">  findRoutePath: winPath(<span class="built_in">require</span>.resolve(<span class="string">'./findRoute'</span>)),</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<p>提供给 umi-plugin-* 插件所使用的 api.addRuntimePlugin、api.addRuntimePluginKey 作为 ADD 类型的插件钩子，其意义在于给 opts.memo 添加元素，然后在 applyPlugins 阶段输出 plugins、validKeys。关于 umi 的插件钩子，可参看 <a href="http://xzfyu.com/2020/02/16/%E5%B7%A5%E7%A8%8B%E5%8C%96/umi%20%E6%8F%92%E4%BB%B6%E9%92%A9%E5%AD%90%E6%9C%BA%E5%88%B6/" target="_blank" rel="noopener">umi 插件钩子机制</a>。</p>
<h2 id="内置实例"><a href="#内置实例" class="headerlink" title="内置实例"></a>内置实例</h2><p>从上方源码也可以看出，umi 内置有 patchRoutes、render、rootContainer、modifyRouteProps、onRouteChange、modifyInitialProps、initialProps 等运行时插件。</p>
<h3 id="入口文件生成机制"><a href="#入口文件生成机制" class="headerlink" title="入口文件生成机制"></a>入口文件生成机制</h3><p>要说明这些插件的意义，先要解释一下 umi 中入口文件 umi.js 的生成策略。这部分功能由 FilesGenerator.js 模块中的 generateEntry 方法完成。它遵照一下流程：</p>
<ol>
<li>读取 entry.js.tpl 模板。</li>
<li>根据 SSR、CSR 渲染策略生成 render 渲染脚本（生成 rootContainer 应用根元素并完成挂载）。</li>
<li>执行 modifyEntryRender 插件钩子，改写 render 渲染脚本。</li>
<li>执行 addRendererWrapperWithModule 插件钩子，获取 render 渲染前执行脚本。</li>
<li>执行 addRuntimePlugin、addRuntimePluginKey 插件钩子，获取运行时插件及其校验 key 键。较为特殊的运行时插件为工程目录下的 app.js 文件。</li>
<li>如果是 SSR 渲染，生成服务端渲染 html 模板（注：不甚理解）。</li>
<li>通过 mustache 模板引擎生成 umi.js 入口文件脚本内容。</li>
<li>将入口文件脚本内容写入打包文件夹中。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** umi-build-dev *** FilesGenerator.js ***/</span></span><br><span class="line">generateEntry() &#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; paths, config &#125; = <span class="keyword">this</span>.service;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 步骤 1</span></span><br><span class="line">  <span class="keyword">const</span> entryTpl = readFileSync(paths.defaultEntryTplPath, <span class="string">'utf-8'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 步骤 2、3</span></span><br><span class="line">  <span class="keyword">const</span> initialRender = <span class="keyword">this</span>.service.applyPlugins(<span class="string">'modifyEntryRender'</span>, &#123;</span><br><span class="line">    initialValue: <span class="string">`</span></span><br><span class="line"><span class="string">window.g_isBrowser = true;</span></span><br><span class="line"><span class="string">let props = &#123;&#125;;</span></span><br><span class="line"><span class="string">// Both support SSR and CSR</span></span><br><span class="line"><span class="string">if (window.g_useSSR) &#123;</span></span><br><span class="line"><span class="string">  // 如果开启服务端渲染则客户端组件初始化 props 使用服务端注入的数据</span></span><br><span class="line"><span class="string">  props = window.g_initialData;</span></span><br><span class="line"><span class="string">&#125; else &#123;</span></span><br><span class="line"><span class="string">  const pathname = location.pathname;</span></span><br><span class="line"><span class="string">  const activeRoute = findRoute(require('@@/router').routes, pathname);</span></span><br><span class="line"><span class="string">  // 在客户端渲染前，执行 getInitialProps 方法</span></span><br><span class="line"><span class="string">  // 拿到初始数据</span></span><br><span class="line"><span class="string">  if (activeRoute &amp;&amp; activeRoute.component &amp;&amp; activeRoute.component.getInitialProps) &#123;</span></span><br><span class="line"><span class="string">    const initialProps = plugins.apply('modifyInitialProps', &#123;</span></span><br><span class="line"><span class="string">      initialValue: &#123;&#125;,</span></span><br><span class="line"><span class="string">    &#125;);</span></span><br><span class="line"><span class="string">    props = activeRoute.component.getInitialProps ? await activeRoute.component.getInitialProps(&#123;</span></span><br><span class="line"><span class="string">      route: activeRoute,</span></span><br><span class="line"><span class="string">      isServer: false,</span></span><br><span class="line"><span class="string">      location,</span></span><br><span class="line"><span class="string">      ...initialProps,</span></span><br><span class="line"><span class="string">    &#125;) : &#123;&#125;;</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"><span class="string">const rootContainer = plugins.apply('rootContainer', &#123;</span></span><br><span class="line"><span class="string">  initialValue: React.createElement(require('./router').default, props),</span></span><br><span class="line"><span class="string">&#125;);</span></span><br><span class="line"><span class="string">ReactDOM[window.g_useSSR ? 'hydrate' : 'render'](</span></span><br><span class="line"><span class="string">  rootContainer,</span></span><br><span class="line"><span class="string">  document.getElementById('<span class="subst">$&#123;config.mountElementId&#125;</span>'),</span></span><br><span class="line"><span class="string">);</span></span><br><span class="line"><span class="string">    `</span>.trim(),</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 步骤 4</span></span><br><span class="line">  <span class="keyword">const</span> moduleBeforeRenderer = <span class="keyword">this</span>.service</span><br><span class="line">    .applyPlugins(<span class="string">'addRendererWrapperWithModule'</span>, &#123;</span><br><span class="line">      initialValue: [],</span><br><span class="line">    &#125;)</span><br><span class="line">    .map(<span class="function">(<span class="params">source, index</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> &#123;</span><br><span class="line">        source,</span><br><span class="line">        specifier: <span class="string">`moduleBeforeRenderer<span class="subst">$&#123;index&#125;</span>`</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 步骤 5</span></span><br><span class="line">  <span class="keyword">const</span> plugins = <span class="keyword">this</span>.service</span><br><span class="line">    .applyPlugins(<span class="string">'addRuntimePlugin'</span>, &#123;</span><br><span class="line">      initialValue: [],</span><br><span class="line">    &#125;)</span><br><span class="line">    .map(<span class="function"><span class="params">plugin</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> winPath(relative(paths.absTmpDirPath, plugin));</span><br><span class="line">    &#125;);</span><br><span class="line">  <span class="keyword">if</span> (findJS(paths.absSrcPath, <span class="string">'app'</span>)) &#123;</span><br><span class="line">    plugins.push(<span class="string">'@/app'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">const</span> validKeys = <span class="keyword">this</span>.service.applyPlugins(<span class="string">'addRuntimePluginKey'</span>, &#123;</span><br><span class="line">    initialValue: [</span><br><span class="line">      <span class="string">'patchRoutes'</span>,</span><br><span class="line">      <span class="string">'render'</span>,</span><br><span class="line">      <span class="string">'rootContainer'</span>,</span><br><span class="line">      <span class="string">'modifyRouteProps'</span>,</span><br><span class="line">      <span class="string">'onRouteChange'</span>,</span><br><span class="line">      <span class="string">'modifyInitialProps'</span>,</span><br><span class="line">      <span class="string">'initialProps'</span>,</span><br><span class="line">    ],</span><br><span class="line">  &#125;);</span><br><span class="line">  assert(</span><br><span class="line">    uniq(validKeys).length === validKeys.length,</span><br><span class="line">    <span class="string">`Conflict keys found in [<span class="subst">$&#123;validKeys.join(<span class="string">', '</span>)&#125;</span>]`</span>,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 步骤 6</span></span><br><span class="line">  <span class="keyword">let</span> htmlTemplateMap = [];</span><br><span class="line">  <span class="keyword">if</span> (config.ssr) &#123;</span><br><span class="line">    <span class="keyword">const</span> isProd = process.env.NODE_ENV === <span class="string">'production'</span>;</span><br><span class="line">    <span class="keyword">const</span> routePaths = getRoutePaths(<span class="keyword">this</span>.RoutesManager.routes);</span><br><span class="line">    htmlTemplateMap = routePaths.map(<span class="function"><span class="params">routePath</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> ssrHtml = <span class="string">'&lt;&gt;&lt;/&gt;'</span>;</span><br><span class="line">      <span class="keyword">const</span> hg = getHtmlGenerator(<span class="keyword">this</span>.service, &#123;</span><br><span class="line">        chunksMap: &#123;</span><br><span class="line">          <span class="comment">// TODO, for dynamic chunks</span></span><br><span class="line">          <span class="comment">// placeholder waiting manifest</span></span><br><span class="line">          umi: [</span><br><span class="line">            isProd ? <span class="string">'__UMI_SERVER__.js'</span> : <span class="string">'umi.js'</span>,</span><br><span class="line">            isProd ? <span class="string">'__UMI_SERVER__.css'</span> : <span class="string">'umi.css'</span>,</span><br><span class="line">          ],</span><br><span class="line">        &#125;,</span><br><span class="line">        headScripts: [</span><br><span class="line">          &#123;</span><br><span class="line">            content: <span class="string">'window.g_useSSR=true;'</span>.trim(),</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">        scripts: [</span><br><span class="line">          &#123;</span><br><span class="line">            content: <span class="string">`window.g_initialData = \$&#123;stringify(props)&#125;;`</span>.trim(),</span><br><span class="line">          &#125;,</span><br><span class="line">        ],</span><br><span class="line">      &#125;);</span><br><span class="line">      <span class="keyword">const</span> content = hg.getMatchedContent(normalizePath(routePath, config.base));</span><br><span class="line">      ssrHtml = htmlToJSX(content).replace(</span><br><span class="line">        <span class="string">`&lt;div id="<span class="subst">$&#123;config.mountElementId || <span class="string">'root'</span>&#125;</span>"&gt;&lt;/div&gt;`</span>,</span><br><span class="line">        <span class="string">`&lt;div id="<span class="subst">$&#123;config.mountElementId || <span class="string">'root'</span>&#125;</span>"&gt;&#123;rootContainer&#125;&lt;/div&gt;`</span>,</span><br><span class="line">      );</span><br><span class="line">      <span class="keyword">return</span> <span class="string">`'<span class="subst">$&#123;routePath&#125;</span>': (<span class="subst">$&#123;ssrHtml&#125;</span>),`</span>;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 步骤 7</span></span><br><span class="line">  <span class="keyword">const</span> entryContent = Mustache.render(entryTpl, &#123;</span><br><span class="line">    globalVariables: !<span class="keyword">this</span>.service.config.disableGlobalVariables,<span class="comment">// 是否配置 window.g_history 等全局变量</span></span><br><span class="line">    code: <span class="keyword">this</span>.service<span class="comment">// 入口文件处添加的执行脚本，渲染后</span></span><br><span class="line">      .applyPlugins(<span class="string">'addEntryCode'</span>, &#123;</span><br><span class="line">        initialValue: [],</span><br><span class="line">      &#125;)</span><br><span class="line">      .join(<span class="string">'\n\n'</span>),</span><br><span class="line">    codeAhead: <span class="keyword">this</span>.service<span class="comment">// 入口文件处添加的执行脚本，渲染前</span></span><br><span class="line">      .applyPlugins(<span class="string">'addEntryCodeAhead'</span>, &#123;</span><br><span class="line">        initialValue: [],</span><br><span class="line">      &#125;)</span><br><span class="line">      .join(<span class="string">'\n\n'</span>),</span><br><span class="line">    imports: importsToStr(<span class="comment">// 入口文件 import 的模块</span></span><br><span class="line">      <span class="keyword">this</span>.service.applyPlugins(<span class="string">'addEntryImport'</span>, &#123;</span><br><span class="line">        initialValue: moduleBeforeRenderer,</span><br><span class="line">      &#125;),</span><br><span class="line">    ).join(<span class="string">'\n'</span>),</span><br><span class="line">    importsAhead: importsToStr(<span class="comment">// 入口文件 import 的模块</span></span><br><span class="line">      <span class="keyword">this</span>.service.applyPlugins(<span class="string">'addEntryImportAhead'</span>, &#123;</span><br><span class="line">        initialValue: [],</span><br><span class="line">      &#125;),</span><br><span class="line">    ).join(<span class="string">'\n'</span>),</span><br><span class="line">    polyfillImports: importsToStr(<span class="comment">// 入口文件最顶层 import 的 ployfill 模块</span></span><br><span class="line">      <span class="keyword">this</span>.service.applyPlugins(<span class="string">'addEntryPolyfillImports'</span>, &#123;</span><br><span class="line">        initialValue: [],</span><br><span class="line">      &#125;),</span><br><span class="line">    ).join(<span class="string">'\n'</span>),</span><br><span class="line">    moduleBeforeRenderer,<span class="comment">// render 脚本执行前的操作函数</span></span><br><span class="line">    render: initialRender,<span class="comment">// 渲染 rootContainer 的 render 脚本</span></span><br><span class="line">    plugins,<span class="comment">// 运行时插件集合</span></span><br><span class="line">    validKeys,<span class="comment">// 运行时插件校验 key 键集合</span></span><br><span class="line">    htmlTemplateMap: htmlTemplateMap.join(<span class="string">'\n'</span>),<span class="comment">// 服务端渲染 html 模板</span></span><br><span class="line">    findRoutePath: winPath(<span class="built_in">require</span>.resolve(<span class="string">'./findRoute'</span>)),<span class="comment">// 提供 findRoute、getUrlQuery 函数的 findRoute 模块位置</span></span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 步骤 8</span></span><br><span class="line">  writeContent(paths.absLibraryJSPath, prettierFile(<span class="string">`<span class="subst">$&#123;entryContent.trim()&#125;</span>\n`</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="render"><a href="#render" class="headerlink" title="render"></a>render</h3><p>render 运行时插件的功能在于对渲染脚本进行封装。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** umi-build-dev *** entry.js.tpl ***/</span></span><br><span class="line"><span class="keyword">const</span> render = plugins.compose(<span class="string">'render'</span>, &#123; <span class="attr">initialValue</span>: clientRender &#125;);</span><br></pre></td></tr></table></figure>
<h3 id="rootContainer"><a href="#rootContainer" class="headerlink" title="rootContainer"></a>rootContainer</h3><p>rootContainer 运行时插件的功能在于对渲染脚本进行封装。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** umi-build-dev *** entry.js.tpl ***/</span></span><br><span class="line"><span class="keyword">const</span> rootContainer = plugins.apply(<span class="string">'rootContainer'</span>, &#123;</span><br><span class="line">  initialValue: App,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
<h3 id="patchRoutes"><a href="#patchRoutes" class="headerlink" title="patchRoutes"></a>patchRoutes</h3><p>patchRoutes 运行时插件的功能在于追加或修改路由。其流程为：编译阶段获得配置路由或扫描文件路由，然后在运行时对这些路由进行再处理。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** umi-build-dev *** router.js.tpl ***/</span></span><br><span class="line"><span class="keyword">const</span> plugins = <span class="built_in">require</span>(<span class="string">'umi/_runtimePlugin'</span>);</span><br><span class="line">plugins.applyForEach(<span class="string">'patchRoutes'</span>, &#123; <span class="attr">initialValue</span>: routes &#125;);<span class="comment">// routes 为编译阶段输出路由</span></span><br></pre></td></tr></table></figure>
<h3 id="onRouteChange"><a href="#onRouteChange" class="headerlink" title="onRouteChange"></a>onRouteChange</h3><p>onRouteChange 运行时插件的功能在于监听路由变更信息。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** umi *** router.js.tpl ***/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">routeChangeHandler</span>(<span class="params">location, action</span>) </span>&#123;</span><br><span class="line">  plugins.applyForEach(<span class="string">'onRouteChange'</span>, &#123;</span><br><span class="line">    initialValue: &#123;</span><br><span class="line">      routes,</span><br><span class="line">      location,</span><br><span class="line">      action,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="modifyRouteProps、modifyInitialProps、initialProps"><a href="#modifyRouteProps、modifyInitialProps、initialProps" class="headerlink" title="modifyRouteProps、modifyInitialProps、initialProps"></a>modifyRouteProps、modifyInitialProps、initialProps</h3><p>modifyRouteProps、modifyInitialProps 的功能在于修改注入路由组件的 props。modifyInitialProps、initialProps 在服务端渲染时使用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** umi *** renderRoutes.js ***/</span></span><br><span class="line"><span class="keyword">const</span> newProps = plugins.apply(<span class="string">'modifyRouteProps'</span>, &#123;</span><br><span class="line">  initialValue: &#123;</span><br><span class="line">    ...props,</span><br><span class="line">    ...extraProps,</span><br><span class="line">    ...compatProps,</span><br><span class="line">  &#125;,</span><br><span class="line">  args: &#123; route &#125;,</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">let</span> &#123; <span class="attr">component</span>: Component &#125; = route;</span><br><span class="line"><span class="keyword">if</span> (__IS_BROWSER &amp;&amp; Component.getInitialProps) &#123;</span><br><span class="line">  <span class="keyword">const</span> initialProps = plugins.apply(<span class="string">'modifyInitialProps'</span>, &#123;</span><br><span class="line">    initialValue: &#123;&#125;,</span><br><span class="line">  &#125;);</span><br><span class="line">  Component = wrapWithInitialProps(Component, initialProps);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> (</span><br><span class="line">  &lt;Component &#123;...newProps&#125; route=&#123;route&#125;&gt;</span><br><span class="line">    &#123;childRoutes&#125;</span><br><span class="line">  &lt;<span class="regexp">/Component&gt;</span></span><br><span class="line"><span class="regexp">);</span></span><br></pre></td></tr></table></figure>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/17/工程化/umi-plugin-qiankun/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/17/工程化/umi-plugin-qiankun/" itemprop="url">umi-plugin-qiankun</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-17T00:00:00+08:00">2020-02-17</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端/" itemprop="url" rel="index"><span itemprop="name">前端</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/02/17/工程化/umi-plugin-qiankun/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/02/17/工程化/umi-plugin-qiankun/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://github.com/umijs/umi-plugin-qiankun" target="_blank" rel="noopener">umi-plugin-qiankun</a> 基于 <a href="http://xzfyu.com/2020/02/16/frontend/qiankun%20%E5%BE%AE%E6%9C%8D%E5%8A%A1/" target="_blank" rel="noopener">qiankun</a>，允许在 umi 环境中创建微服务。</p>
<p>按官方示例，搭建 umi 微服务可基于以下流程实现：</p>
<ol>
<li>主应用 .umirc.js 添加 @umijs/plugin-qiankun 插件配置 master 内容：注册子应用（应用名、html 地址、路由前缀、路由方式、挂载节点、自定义属性等）、启动沙箱、启动预加载、启动异步渲染等。（备注：子应用也可以在运行时通过 src/app.js 这个特殊的运行时插件导出 qiankun 的方式动态注册）</li>
<li>子应用 .umirc.js 添加 @umijs/plugin-qiankun 插件配置 slave 内容：keepOriginalRoutes。</li>
<li>子应用入口文件中导出 qiankun = { bootstrap, mount, unmount }，非必要。</li>
</ol>
<p>综上，注册子应用的方式有两种：</p>
<ol>
<li>编译期通过 .umirc.js 注册。</li>
<li>运行时通过 src/app.js 注册。</li>
</ol>
<p>基于 qiankun、umi 的运作机制，使用 umi-plugin-qiankun 搭建微服务就是在运行时获取编译期或运行时配置，然后调用 qiankun 的接口注册子应用并启动微服务。因为需要在运行时注册子应用，所以就需要借助运行时插件的能力。在实现上，umi-plugin-qiankun 会通过 qiankun-master、qiankun-slave 这两个额外插件分别会调用 api.addRuntimePlugin 接口注册各自的 runtimePlugin 运行时插件。关于 umi 的运行时插件，可参考 <a href="http://xzfyu.com/2020/02/17/%E5%B7%A5%E7%A8%8B%E5%8C%96/umi%E8%BF%90%E8%A1%8C%E6%97%B6%E6%8F%92%E4%BB%B6/" target="_blank" rel="noopener">umi 运行时插件</a>。</p>
<p>编译期配置（即 .umirc.js 中的 master、slave 内容）的获取，umi 提供的可实现方式是：</p>
<ol>
<li>首先通过 api.onOptionChange 监听编译期配置变更。</li>
<li>然后通过 api.changePluginOption 将配置内容传递给 qiankun-master、qiankun-slave 这两个额外插件。</li>
<li>在 qiankun-master、qiankun-slave 中，调用 api.writeTmpFile 将配置内容写入 subAppsConfig.json 临时文件。</li>
<li>runtimePlugin 运行时插件读取临时文件，并相应注册子应用。</li>
</ol>
<p>运行时配置（即 src/app.js 导出的 qiankun）的获取，umi 提供的可实现方式是：在 runtimePlugin 运行时插件通过调用 plugins.mergeConfigAsync(‘qiankun’) 读取导出内容。</p>
<h2 id="微服务注册启动流程"><a href="#微服务注册启动流程" class="headerlink" title="微服务注册启动流程"></a>微服务注册启动流程</h2><p>如上文，umi-plugin-qiankun 中的微服务注册启动流程就是读取编译器配置或运行时配置，再调用 qiankun 接口注册和启动微服务。这部分内容主要在 qiankun-master 这个额外插件实现。此外，umi-plugin-qiankun 支持使用 defer 配置异步渲染（子应用挂载在主应用渲染产生的节点上），这部分功能通过 api.writeTmpFile、api.addUmiExports 接口创建 qiankunDefer.js 临时文件实现。在启动微服务的流程中，umi-plugin-qiankun 首先会调用 render 脚本，然后（根据 defer 配置）等待 qiankunDefer 执行到 resolve 状态，最后调用 qiankun 接口启动微服务。想要使 qiankunDefer 变更到 resolve 状态，需要开发者手动调用 qiankunStart（也即 qiankunDefer.resolve）。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** qiankun-master *** runtimePlugin.js ***/</span></span><br><span class="line"><span class="comment">// 获取编译器配置（.umirc.js 中的 master、slave 内容）</span></span><br><span class="line"><span class="keyword">import</span> subAppConfig <span class="keyword">from</span> <span class="string">'@tmp/subAppsConfig.json'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取运行时配置（src/app.js 导出的 qiankun），运行时配置优先级高于编译器配置</span></span><br><span class="line"><span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">getMasterRuntime</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> plugins = <span class="built_in">require</span>(<span class="string">'umi/_runtimePlugin'</span>);</span><br><span class="line">  <span class="keyword">const</span> config: GlobalOptions = (<span class="keyword">await</span> plugins.mergeConfigAsync(<span class="string">'qiankun'</span>)) || &#123;&#125;;</span><br><span class="line">  <span class="keyword">const</span> &#123; master &#125; = config;</span><br><span class="line">  <span class="keyword">return</span> master || config;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">async</span> <span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">oldRender: typeof noop</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 执行 umi 应用的渲染脚本</span></span><br><span class="line">  <span class="comment">// 渲染脚本先于 defer 流程，defer 才有效</span></span><br><span class="line">  oldRender();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 子应用是否处于激活状态</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">isAppActive</span>(<span class="params">location: Location, history: IConfig[<span class="string">'history'</span>], base: App[<span class="string">'base'</span>]</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> baseConfig = toArray(base);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (history) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'hash'</span>:</span><br><span class="line">        <span class="keyword">return</span> baseConfig.some(<span class="function"><span class="params">pathPrefix</span> =&gt;</span> testPathWithPrefix(<span class="string">`#<span class="subst">$&#123;pathPrefix&#125;</span>`</span>, location.hash));</span><br><span class="line"></span><br><span class="line">      <span class="keyword">case</span> <span class="string">'browser'</span>:</span><br><span class="line">        <span class="keyword">return</span> baseConfig.some(<span class="function"><span class="params">pathPrefix</span> =&gt;</span> testPathWithPrefix(pathPrefix, location.pathname));</span><br><span class="line"></span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取运行时配置、编译器配置</span></span><br><span class="line">  <span class="keyword">const</span> runtimeConfig = <span class="keyword">await</span> getMasterRuntime();</span><br><span class="line">  <span class="keyword">const</span> &#123; apps, jsSandbox = <span class="literal">false</span>, prefetch = <span class="literal">true</span>, defer = <span class="literal">false</span>, lifeCycles, masterHistory, ...otherConfigs &#125; = &#123;</span><br><span class="line">    ...(subAppConfig <span class="keyword">as</span> Options),</span><br><span class="line">    ...(runtimeConfig <span class="keyword">as</span> Options),</span><br><span class="line">  &#125;;</span><br><span class="line">  assert(apps &amp;&amp; apps.length, <span class="string">'sub apps must be config when using umi-plugin-qiankun'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 注册子应用</span></span><br><span class="line">  registerMicroApps(</span><br><span class="line">    apps.map(<span class="function">(<span class="params">&#123; name, entry, base, history = masterHistory, mountElementId = defaultMountContainerId, props &#125;</span>) =&gt;</span> (&#123;</span><br><span class="line">      name,</span><br><span class="line">      entry,</span><br><span class="line">      activeRule: <span class="function"><span class="params">location</span> =&gt;</span> isAppActive(location, history, base),</span><br><span class="line">      render: <span class="function">(<span class="params">&#123; appContent, loading &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">'development'</span>) &#123;</span><br><span class="line">          <span class="built_in">console</span>.info(<span class="string">`app <span class="subst">$&#123;name&#125;</span> loading <span class="subst">$&#123;loading&#125;</span>`</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (mountElementId) &#123;</span><br><span class="line">          <span class="keyword">const</span> container = <span class="built_in">document</span>.getElementById(mountElementId);</span><br><span class="line">          <span class="keyword">if</span> (container) &#123;</span><br><span class="line">            <span class="keyword">const</span> subApp = React.createElement(<span class="string">'div'</span>, &#123;</span><br><span class="line">              dangerouslySetInnerHTML: &#123;</span><br><span class="line">                __html: appContent,</span><br><span class="line">              &#125;,</span><br><span class="line">            &#125;);</span><br><span class="line">            ReactDOM.render(subApp, container);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// 将 base、history 都传入子应用</span></span><br><span class="line">      props: &#123;</span><br><span class="line">        base,</span><br><span class="line">        history,</span><br><span class="line">        ...props,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;)),</span><br><span class="line">    lifeCycles,</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 异步启动，需要在主应用中手动调用 qiankunStart 函数，以使 deferred 执行到 resolve 状态</span></span><br><span class="line">  <span class="keyword">if</span> (defer) &#123;</span><br><span class="line">    <span class="keyword">await</span> deferred.promise;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 启动微服务</span></span><br><span class="line">  start(&#123; jsSandbox, prefetch, ...otherConfigs &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">api.writeTmpFile(</span><br><span class="line">  <span class="string">'qiankunDefer.js'</span>,</span><br><span class="line">  <span class="string">`</span></span><br><span class="line"><span class="string">    class Deferred &#123;</span></span><br><span class="line"><span class="string">      constructor() &#123;</span></span><br><span class="line"><span class="string">        this.promise = new Promise(resolve =&gt; this.resolve = resolve);</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &#125;</span></span><br><span class="line"><span class="string">    export const deferred = new Deferred();</span></span><br><span class="line"><span class="string">    export const qiankunStart = deferred.resolve;</span></span><br><span class="line"><span class="string">  `</span>.trim(),</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">api.addUmiExports([</span><br><span class="line">  &#123;</span><br><span class="line">    specifiers: [<span class="string">'qiankunStart'</span>],</span><br><span class="line">    source: <span class="string">'@tmp/qiankunDefer'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">]);</span><br></pre></td></tr></table></figure>
<p>子应用侧，结合 qiankun 加载子应用脚本生命周期函数的机制，qiankun-slave 这个额外插件会借助 api.modifyDefaultConfig 为子应用设置跟路由、挂载节点、开启 runtimePublicPath 等；借助 api.modifyPublicPathStr 将 publicPath 设置为 window.<strong>INJECTED_PUBLIC_PATH_BY_QIANKUN</strong> 或 api.config.publicPath、’/‘ 等；借助 api.modifyWebpackConfig 将打包模式改为 umd 模式，并将开发环境的 publicPath 与开发服务器 ip 地址挂钩。与此同时，qiankun-slave 会借助 api.modifyHTMLWithAST 为子应用的入口文件加载节点打上 entry 标识；借助 api.chainWebpackConfig 为开发环境的 source-map 增添跨域能力。以下仅展示部分脚本：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** qiankun-slave *** index.ts ***/</span></span><br><span class="line">api.modifyHTMLWithAST(<span class="function"><span class="params">$</span> =&gt;</span> &#123;</span><br><span class="line">  $(<span class="string">'script'</span>).each(<span class="function">(<span class="params">_, el</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> scriptEl = $(el);</span><br><span class="line">    <span class="keyword">const</span> umiEntryJs = <span class="regexp">/\/?umi(\.\w+)?\.js$/g</span>;</span><br><span class="line">    <span class="keyword">if</span> (umiEntryJs.test(scriptEl.attr(<span class="string">'src'</span>) ?? <span class="string">''</span>)) &#123;</span><br><span class="line">      scriptEl.attr(<span class="string">'entry'</span>, <span class="string">''</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> $;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">'development'</span> &amp;&amp; port) &#123;</span><br><span class="line">  <span class="comment">// 变更 webpack-dev-server websocket 默认监听地址</span></span><br><span class="line">  process.env.SOCKET_SERVER = <span class="string">`<span class="subst">$&#123;protocol&#125;</span>://<span class="subst">$&#123;localIpAddress&#125;</span>:<span class="subst">$&#123;port&#125;</span>/`</span>;</span><br><span class="line">  api.chainWebpackConfig(<span class="function"><span class="params">memo</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 禁用 devtool，启用 SourceMapDevToolPlugin</span></span><br><span class="line">    memo.devtool(<span class="literal">false</span>);</span><br><span class="line">    memo.plugin(<span class="string">'source-map'</span>).use(webpack.SourceMapDevToolPlugin, [</span><br><span class="line">      &#123;</span><br><span class="line">        namespace: pkgName,</span><br><span class="line">        append: <span class="string">`\n//# sourceMappingURL=<span class="subst">$&#123;protocol&#125;</span>://<span class="subst">$&#123;localIpAddress&#125;</span>:<span class="subst">$&#123;port&#125;</span>/[url]`</span>,</span><br><span class="line">        filename: <span class="string">'[file].map'</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    ]);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="子应用的生命周期函数"><a href="#子应用的生命周期函数" class="headerlink" title="子应用的生命周期函数"></a>子应用的生命周期函数</h2><p>umi-plugin-qiankun 允许在子应用的 src/app.js 配置生命周期函数。获取该部分的运行时配置同样通过添加运行时脚本实现，但这次并没有调用 api.addRuntimePlugin，而是调用 api.addRendererWrapperWithModule 将 qiankun-slave 插件中的 lifecycles.ts 模块注入到 umi.js 入口文件中，再通过调用 api.addEntryCode 使 umi.js 导出 bootstrap、mount、unmount 生命周期函数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** qiankun-slave *** index.ts ***/</span></span><br><span class="line"><span class="keyword">const</span> lifecyclePath = <span class="built_in">require</span>.resolve(<span class="string">'./lifecycles'</span>);</span><br><span class="line">api.addEntryImport(&#123;</span><br><span class="line">  source: lifecyclePath,</span><br><span class="line">  specifier:</span><br><span class="line">    <span class="string">'&#123; genMount as qiankun_genMount, genBootstrap as qiankun_genBootstrap, genUnmount as qiankun_genUnmount &#125;'</span>,</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// lifecycles.ts 以 moduleBeforeRendererPromises 形式添加到入口文件中</span></span><br><span class="line"><span class="comment">// moduleBeforeRendererPromises 为什么返回 Promise，就像这个插件中的情形一样，可以改写 render</span></span><br><span class="line"><span class="comment">// 改写完成后，再通过 resolve 进行渲染操作</span></span><br><span class="line">api.addRendererWrapperWithModule(lifecyclePath);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 往入口文件中插入脚本，对应 entry.js.tpl 中的 code，render 脚本渲染后再调用</span></span><br><span class="line">api.addEntryCode(</span><br><span class="line">  <span class="string">`</span></span><br><span class="line"><span class="string">  export const bootstrap = qiankun_genBootstrap(Promise.all(moduleBeforeRendererPromises), render);</span></span><br><span class="line"><span class="string">  export const mount = qiankun_genMount();</span></span><br><span class="line"><span class="string">  export const unmount = qiankun_genUnmount('<span class="subst">$&#123;mountElementId&#125;</span>');</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">  if (!window.__POWERED_BY_QIANKUN__) &#123;</span></span><br><span class="line"><span class="string">    bootstrap().then(mount);</span></span><br><span class="line"><span class="string">  &#125;</span></span><br><span class="line"><span class="string">  `</span>,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** qiankun-slave *** lifecycles.ts ***/</span></span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; noop &#125; <span class="keyword">from</span> <span class="string">'../common'</span>;</span><br><span class="line"></span><br><span class="line">type Defer = &#123;</span><br><span class="line">  promise: <span class="built_in">Promise</span>&lt;any&gt;;</span><br><span class="line">  resolve(value?: any): <span class="keyword">void</span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> defer: Defer = &#123;&#125;;</span><br><span class="line">defer.promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> &#123;</span><br><span class="line">  defer.resolve = resolve;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> render = noop;</span><br><span class="line"><span class="keyword">let</span> hasMountedAtLeastOnce = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// moduleBeforeRendererPromises 处理机制，需要返回 Promise</span></span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> () =&gt; defer.promise;</span><br><span class="line"></span><br><span class="line"><span class="comment">// src/app.js 中配置的生命周期函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getSlaveRuntime</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> plugins = <span class="built_in">require</span>(<span class="string">'umi/_runtimePlugin'</span>);</span><br><span class="line">  <span class="keyword">const</span> config = plugins.mergeConfig(<span class="string">'qiankun'</span>) || &#123;&#125;;</span><br><span class="line">  <span class="keyword">const</span> &#123; slave &#125; = config;</span><br><span class="line">  <span class="keyword">return</span> slave || config;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 引导函数，先执行 src/app.js 中配置的 bootstrap 生命周期</span></span><br><span class="line"><span class="comment">// 然后改写 render 脚本，渲染失败予以提示</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">genBootstrap</span>(<span class="params">promises: Promise&lt;any&gt;, oldRender: typeof noop</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> (...args: any[]) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> slaveRuntime = getSlaveRuntime();</span><br><span class="line">    <span class="keyword">if</span> (slaveRuntime.bootstrap) <span class="keyword">await</span> slaveRuntime.bootstrap(...args);</span><br><span class="line">    render = <span class="function"><span class="params">()</span> =&gt;</span></span><br><span class="line">      promises.then(oldRender).catch(<span class="function"><span class="params">e</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">'development'</span>) &#123;</span><br><span class="line">          <span class="built_in">console</span>.error(<span class="string">'Render failed'</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 挂载函数，先调用 defer.resolve 引起 render 渲染脚本执行</span></span><br><span class="line"><span class="comment">// 其次执行 src/app.js 中配置的 mount 生命周期</span></span><br><span class="line"><span class="comment">// 其次若非首次 mount，手动调用 render 渲染脚本</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">genMount</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> (...args: any[]) =&gt; &#123;</span><br><span class="line">    defer.resolve();</span><br><span class="line">    <span class="keyword">const</span> slaveRuntime = getSlaveRuntime();</span><br><span class="line">    <span class="keyword">if</span> (slaveRuntime.mount) <span class="keyword">await</span> slaveRuntime.mount(...args);</span><br><span class="line">    <span class="comment">// 第一次 mount umi 会自动触发 render，非第一次 mount 则需手动触发</span></span><br><span class="line">    <span class="keyword">if</span> (hasMountedAtLeastOnce) &#123;</span><br><span class="line">      render();</span><br><span class="line">    &#125;</span><br><span class="line">    hasMountedAtLeastOnce = <span class="literal">true</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 卸载函数</span></span><br><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">genUnmount</span>(<span class="params">mountElementId: string</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">async</span> (...args: any[]) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> container = <span class="built_in">document</span>.getElementById(mountElementId);</span><br><span class="line">    <span class="keyword">if</span> (container) &#123;</span><br><span class="line">      ReactDOM.unmountComponentAtNode(container);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> slaveRuntime = getSlaveRuntime();</span><br><span class="line">    <span class="keyword">if</span> (slaveRuntime.unmount) <span class="keyword">await</span> slaveRuntime.unmount(...args);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="应用间的数据共享"><a href="#应用间的数据共享" class="headerlink" title="应用间的数据共享"></a>应用间的数据共享</h2><p>如 umi-plugin-qiankun 文档中所述，应用间的数据共享可通过 props 实现（子应用注册方式采用运行时配置），其次可基于公共的 hooks 实现共享。基于 hooks 实现数据共享的流程为：</p>
<ol>
<li>开发者手动在主应用的工程目录下添加 src/rootExports.js 并导出 hooks；</li>
<li>由 qiankun-master 读取这些 hooks，并通过临时文件 qiankunRootExports.js 将其赋值到 window.g_rootExports 属性中；</li>
<li>由 qiankun-slave 创建 qiankunContext.js 临时文件，调用 React.createContext 生成上下文；</li>
<li>由 qiankun-slave 添加 rootContainer 类运行时脚本，以 qiankunContext 包裹原先的根节点，上下文中传入 window.g_rootExports 属性。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** qiankun-master *** index.ts ***/</span></span><br><span class="line"><span class="keyword">const</span> rootExportsFile = join(api.paths.absSrcPath, <span class="string">'rootExports.js'</span>);</span><br><span class="line">api.addPageWatcher(rootExportsFile);</span><br><span class="line"></span><br><span class="line">api.onGenerateFiles(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> rootExports = <span class="string">`</span></span><br><span class="line"><span class="string">window.g_rootExports = <span class="subst">$&#123;existsSync(rootExportsFile) ? <span class="string">`require('@/rootExports')`</span> : <span class="string">`&#123;&#125;`</span>&#125;</span>;</span></span><br><span class="line"><span class="string">  `</span>.trim();</span><br><span class="line">  api.writeTmpFile(<span class="string">'qiankunRootExports.js'</span>, rootExports);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** qiankun-slave *** index.ts ***/</span></span><br><span class="line">api.writeTmpFile(</span><br><span class="line">    <span class="string">'qiankunContext.js'</span>,</span><br><span class="line">    <span class="string">`</span></span><br><span class="line"><span class="string">import &#123; createContext, useContext &#125; from 'react';</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">export const Context = createContext(null);</span></span><br><span class="line"><span class="string">export function useRootExports() &#123;</span></span><br><span class="line"><span class="string">  return useContext(Context);</span></span><br><span class="line"><span class="string">&#125;;</span></span><br><span class="line"><span class="string">`</span>.trim(),</span><br><span class="line">);</span><br><span class="line">api.addUmiExports([</span><br><span class="line">  &#123;</span><br><span class="line">    specifiers: [<span class="string">'useRootExports'</span>],</span><br><span class="line">    source: <span class="string">'@tmp/qiankunContext'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">]);</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** qiankun-slave *** runtimePlguin.ts ***/</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rootContainer</span>(<span class="params">container: HTMLElement</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> value = (<span class="built_in">window</span> <span class="keyword">as</span> any).g_rootExports;</span><br><span class="line">  <span class="comment">// eslint-disable-next-line global-require</span></span><br><span class="line">  <span class="keyword">const</span> &#123; Context &#125; = <span class="built_in">require</span>(<span class="string">'@tmp/qiankunContext'</span>);</span><br><span class="line">  <span class="keyword">return</span> React.createElement(Context.Provider, &#123; value &#125;, container);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>稍稍厘清这个插件已觉费力，再看到 umi 团队规划中的任务项”子应用嵌套、公共依赖加载策略“，略感望尘莫及。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/16/frontend/qiankun 微服务/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/16/frontend/qiankun 微服务/" itemprop="url">qiankun 微服务</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-16T00:00:00+08:00">2020-02-16</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端/" itemprop="url" rel="index"><span itemprop="name">前端</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/02/16/frontend/qiankun 微服务/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/02/16/frontend/qiankun 微服务/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="https://qiankun.umijs.org/zh/" target="_blank" rel="noopener">qiankun</a> 基于 <a href="http://xzfyu.com/2020/02/15/frontend/single-spa%20%E5%AE%9E%E7%8E%B0%E5%89%8D%E7%AB%AF%E5%BE%AE%E6%9C%8D%E5%8A%A1/" target="_blank" rel="noopener">single-spa</a>、<a href="https://github.com/kuitos/import-html-entry" target="_blank" rel="noopener">import-html-entry</a> 实现。</p>
<h2 id="启动流程"><a href="#启动流程" class="headerlink" title="启动流程"></a>启动流程</h2><p>跟 single-spa 一样，qiankun 启动微服务的流程仅有两步：</p>
<ol>
<li>registerMicroApps(apps, lifeCycles?, opts?) 注册应用。</li>
<li>start(opts?) 启动。</li>
</ol>
<p>qiankun 提供了以下新特性：</p>
<ol>
<li>qiankun 微服务的渲染内容通过 html 脚本形式提供，render 渲染函数处理的就是 html 内容（引用）。html 中加载的 js 脚本同样需要透出 bootstrap、mount、unmount 等生命周期函数。多个应用不会在同一张 html 页面寻找 dom 节点，从而相互隔离。备注：import-html-entry 加载 html 时会将 js 处理成 execScripts 脚本加载器。</li>
<li>除了应用的 js 脚本提供 bootstrap、mount、unmount 等生命周期函数以外，qiankun 允许在 registerMicroApps 执行期间添加 beforeLoad(appName)、beforeMount、afterMount、beforeUnmount、afterUnmount 等钩子。</li>
<li>为应用的 js 脚本提供沙箱环境，隔离应用之间的全局变量。沙箱生命周期中调用的劫持器能自动解绑事件、影响应用的发布配置 publicPath 等。</li>
<li>静默加载其他应用，或者在首个应用 mount 完成后启动加载流程，或者在应用无变更的前提下启动加载流程。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">registerMicroApps</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">object</span> = </span>&#123;&#125;&gt;(</span><br><span class="line">  apps: <span class="built_in">Array</span>&lt;RegistrableApp&lt;T&gt;&gt;,</span><br><span class="line">  lifeCycles?: LifeCycles&lt;T&gt;,</span><br><span class="line">  opts?: RegisterMicroAppsOpts,</span><br><span class="line">) &#123;</span><br><span class="line">  <span class="built_in">window</span>.__POWERED_BY_QIANKUN__ = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123; beforeUnmount = [], afterUnmount = [], afterMount = [], beforeMount = [], beforeLoad = [] &#125; = lifeCycles || &#123;&#125;;</span><br><span class="line">  microApps = [...microApps, ...apps];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> prevAppUnmountedDeferred: Deferred&lt;<span class="keyword">void</span>&gt;;</span><br><span class="line"></span><br><span class="line">  apps.forEach(<span class="function"><span class="params">app</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; name, entry, render, activeRule, props = &#123;&#125; &#125; = app;</span><br><span class="line"></span><br><span class="line">    registerApplication(</span><br><span class="line">      name,</span><br><span class="line">      <span class="keyword">async</span> (&#123; <span class="attr">name</span>: appName &#125;) =&gt; &#123;</span><br><span class="line">        <span class="comment">// 加载应用须等待 start 执行结束</span></span><br><span class="line">        <span class="keyword">await</span> frameworkStartedDefer.promise;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 通过 import-html-entry 获取应用的入口 html 及 js 脚本加载器</span></span><br><span class="line">        <span class="keyword">const</span> &#123; <span class="attr">template</span>: appContent, execScripts, assetPublicPath &#125; = <span class="keyword">await</span> importEntry(entry, opts);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果微服务页面只挂载一个应用（单例模式），等待前一个应用 unmount 后，才予 load 当前应用</span></span><br><span class="line">        <span class="comment">// single-spa 会在前一个应用 unmount 的同时，处理当前应用的 load、bootstrap 流程 https://github.com/CanopyTax/single-spa/blob/master/src/navigation/reroute.js#L74</span></span><br><span class="line">        <span class="comment">// 单例模式在 start 执行期间制定，默认为单例模式</span></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">await</span> validateSingularMode(singularMode, app)) &#123;</span><br><span class="line">          <span class="keyword">await</span> (prevAppUnmountedDeferred &amp;&amp; prevAppUnmountedDeferred.promise);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 预先渲染微应用的 html 结构，等待 js 脚本 mount 内容</span></span><br><span class="line">        render(&#123; appContent, <span class="attr">loading</span>: <span class="literal">true</span> &#125;);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> jsSandbox: Window = <span class="built_in">window</span>;</span><br><span class="line">        <span class="keyword">let</span> mountSandbox = <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">Promise</span>.resolve();</span><br><span class="line">        <span class="keyword">let</span> unmountSandbox = <span class="function"><span class="params">()</span> =&gt;</span> <span class="built_in">Promise</span>.resolve();</span><br><span class="line">        <span class="keyword">if</span> (useJsSandbox) &#123;</span><br><span class="line">          <span class="keyword">const</span> sandbox = genSandbox(appName, assetPublicPath);</span><br><span class="line">          jsSandbox = sandbox.sandbox;</span><br><span class="line">          mountSandbox = sandbox.mount;</span><br><span class="line">          unmountSandbox = sandbox.unmount;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">await</span> execHooksChain(toArray(beforeLoad), app);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">let</span> &#123; <span class="attr">bootstrap</span>: bootstrapApp, mount, unmount &#125; = <span class="keyword">await</span> execScripts(jsSandbox);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果应用脚本没有导出 bootstrap、mount、unmount，使用 window[appName] 中的值替代</span></span><br><span class="line">        <span class="keyword">if</span> (!isFunction(bootstrapApp) || !isFunction(mount) || !isFunction(unmount)) &#123;</span><br><span class="line">          <span class="keyword">const</span> globalVariableExports = (<span class="built_in">window</span> <span class="keyword">as</span> any)[appName] || &#123;&#125;;</span><br><span class="line">          bootstrapApp = globalVariableExports.bootstrap;</span><br><span class="line">          mount = globalVariableExports.mount;</span><br><span class="line">          unmount = globalVariableExports.unmount;</span><br><span class="line">          <span class="keyword">if</span> (!isFunction(bootstrapApp) || !isFunction(mount) || !isFunction(unmount)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`You need to export the functional lifecycles in <span class="subst">$&#123;appName&#125;</span> entry`</span>);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">'development'</span>) &#123;</span><br><span class="line">            <span class="built_in">console</span>.warn(</span><br><span class="line">              <span class="string">`LifeCycles are not found from <span class="subst">$&#123;appName&#125;</span> entry exports, fallback to get them from window['<span class="subst">$&#123;appName&#125;</span>'] `</span>,</span><br><span class="line">            );</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> &#123;</span><br><span class="line">          <span class="comment">// 微应用的引导流程，使用 single-spa 添加多个生命周期函数</span></span><br><span class="line">          bootstrap: [bootstrapApp],</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 微应用的挂载流程</span></span><br><span class="line">          <span class="comment">// 1. 单例模式下，等待前一个应用卸载完成</span></span><br><span class="line">          <span class="comment">// 2. 预先渲染微应用的 html 结构，等待 js 脚本 mount 内容</span></span><br><span class="line">          <span class="comment">// 3. 执行 beforeMount 钩子</span></span><br><span class="line">          <span class="comment">// 4. 执行 sandbox.mount 钩子</span></span><br><span class="line">          <span class="comment">// 5. 执行微应用的 mount 钩子</span></span><br><span class="line">          <span class="comment">// 6. 将微应用的 html 结构置为非加载状态</span></span><br><span class="line">          <span class="comment">// 7. 执行 afterMount 钩子</span></span><br><span class="line">          <span class="comment">// 8. 设置 prevAppUnmountedDeferred，以满足微服务的单例模式机制</span></span><br><span class="line">          mount: [</span><br><span class="line">            <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">              <span class="keyword">if</span> ((<span class="keyword">await</span> validateSingularMode(singularMode, app)) &amp;&amp; prevAppUnmountedDeferred) &#123;</span><br><span class="line">                <span class="keyword">return</span> prevAppUnmountedDeferred.promise;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              <span class="keyword">return</span> <span class="literal">undefined</span>;</span><br><span class="line">            &#125;,</span><br><span class="line">            <span class="keyword">async</span> () =&gt; render(&#123; appContent, <span class="attr">loading</span>: <span class="literal">true</span> &#125;),</span><br><span class="line">            <span class="keyword">async</span> () =&gt; execHooksChain(toArray(beforeMount), app),</span><br><span class="line">            mountSandbox,</span><br><span class="line">            mount,</span><br><span class="line">            <span class="keyword">async</span> () =&gt; render(&#123; appContent, <span class="attr">loading</span>: <span class="literal">false</span> &#125;),</span><br><span class="line">            <span class="keyword">async</span> () =&gt; execHooksChain(toArray(afterMount), app),</span><br><span class="line">            <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">              <span class="keyword">if</span> (<span class="keyword">await</span> validateSingularMode(singularMode, app)) &#123;</span><br><span class="line">                prevAppUnmountedDeferred = <span class="keyword">new</span> Deferred&lt;<span class="keyword">void</span>&gt;();</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">          ],</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 微应用的挂载流程</span></span><br><span class="line">          <span class="comment">// 1. 执行 beforeUnmount 钩子</span></span><br><span class="line">          <span class="comment">// 2. 执行微应用的 unmount 钩子</span></span><br><span class="line">          <span class="comment">// 3. 执行 sandbox.unmount 钩子</span></span><br><span class="line">          <span class="comment">// 4. 执行 afterUnmount 钩子</span></span><br><span class="line">          <span class="comment">// 5. 将微应用的 html 结构置空</span></span><br><span class="line">          <span class="comment">// 7. 执行 prevAppUnmountedDeferred.resolve，以便 load 其他应用</span></span><br><span class="line">          unmount: [</span><br><span class="line">            <span class="keyword">async</span> () =&gt; execHooksChain(toArray(beforeUnmount), app),</span><br><span class="line">            unmount,</span><br><span class="line">            unmountSandbox,</span><br><span class="line">            <span class="keyword">async</span> () =&gt; execHooksChain(toArray(afterUnmount), app),</span><br><span class="line">            <span class="keyword">async</span> () =&gt; render(&#123; <span class="attr">appContent</span>: <span class="string">''</span>, <span class="attr">loading</span>: <span class="literal">false</span> &#125;),</span><br><span class="line">            <span class="keyword">async</span> () =&gt; &#123;</span><br><span class="line">              <span class="keyword">if</span> ((<span class="keyword">await</span> validateSingularMode(singularMode, app)) &amp;&amp; prevAppUnmountedDeferred) &#123;</span><br><span class="line">                prevAppUnmountedDeferred.resolve();</span><br><span class="line">              &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">          ],</span><br><span class="line">        &#125;;</span><br><span class="line">      &#125;,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 路由匹配策略</span></span><br><span class="line">      activeRule,</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 自定义属性</span></span><br><span class="line">      props,</span><br><span class="line">    );</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">start</span>(<span class="params">opts: StartOpts = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> &#123; prefetch = <span class="literal">true</span>, jsSandbox = <span class="literal">true</span>, singular = <span class="literal">true</span>, fetch &#125; = opts;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span> (prefetch) &#123;</span><br><span class="line">    <span class="comment">// 监听 single-spa:first-mount 事件，在非手机环境或网络较快时加载时，通过 window.requestIdleCallback 或 setTimeout 加载其他应用</span></span><br><span class="line">    <span class="keyword">case</span> <span class="literal">true</span>:</span><br><span class="line">      prefetchAfterFirstMounted(microApps, fetch);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 监听 single-spa:no-app-change 事件，静默加载其他应用</span></span><br><span class="line">    <span class="keyword">case</span> <span class="string">'all'</span>:</span><br><span class="line">      prefetchAll(microApps, fetch);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 默认应用沙箱</span></span><br><span class="line">  <span class="keyword">if</span> (jsSandbox) &#123;</span><br><span class="line">    useJsSandbox = jsSandbox;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 默认单例模式</span></span><br><span class="line">  <span class="keyword">if</span> (singular) &#123;</span><br><span class="line">    singularMode = singular;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  startSpa();</span><br><span class="line"></span><br><span class="line">  frameworkStartedDefer.resolve();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Deferred</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line">  promise: <span class="built_in">Promise</span>&lt;T&gt;;</span><br><span class="line"></span><br><span class="line">  resolve!: <span class="function">(<span class="params">value?: T | PromiseLike&lt;T&gt;</span>) =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line"></span><br><span class="line">  reject!: <span class="function">(<span class="params">reason?: any</span>) =&gt;</span> <span class="keyword">void</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>() &#123;</span><br><span class="line">    <span class="keyword">this</span>.promise = <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.resolve = resolve;</span><br><span class="line">      <span class="keyword">this</span>.reject = reject;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="沙箱"><a href="#沙箱" class="headerlink" title="沙箱"></a>沙箱</h2><p>在 single-spa 微服务项目中，多个应用会共用 window 的对象，一个应用设置的全局变量会影响到另一个应用。为了隔离，qiankun 设计了沙箱机制。首先，qiankun 使用 Proxy 生成 window 对象的代理，该代理会作为应用脚本的执行上下文。当应用脚本对该代理设置属性时，qiankun 会使用 addedPropsMapInSandbox 记录新增的全局变量、modifiedPropsOriginalValueMapInSandbox 记录变更前的全局变量、currentUpdatedPropsValueMap 记录当前应用设置的全局变量（作为快照），然后对原始的 window 对象赋值，取值时通过代理从原始的 window 获得应用中设置的值（特别的，获取方法时会绑定上原始的 window）。当沙箱 unmount（即应用 unmount 时），qiankun 会基于 addedPropsMapInSandbox、modifiedPropsOriginalValueMapInSandbox 恢复 window 对象的属性。当沙箱再次 mount（即应用再次 mount 时），qiankun 会基于 modifiedPropsOriginalValueMapInSandbox 将原始 window 对象置为快照值。</p>
<p>sandbox 沙箱代码的执行时机遵从应用的生命周期：</p>
<ol>
<li>当应用被 load 时，创建沙箱，即生成 window 对象的代理，同时调用 hijackAtBootstrapping 劫持 window 方法。这时 sandboxRunning 状态为 true。备注：因为没调用 single-spa 的 unloadApplication 方法，应用只会被 load 一次。</li>
<li>当应用被 bootstrap 时，沙箱被应用脚本实际使用，用于导出 bootstrap、mount、unmount 等生命周期函数。备注：因为没调用 single-spa 的 unloadApplication 方法，应用只会被 bootstrap 一次。</li>
<li>当应用首次被 mount 时，沙箱的 sandbox.mount 会先于应用脚本的 mount 生命周期执行，调用 hijackAtMounting 劫持 window 方法。</li>
<li>当应用被 unmount 时，沙箱的 sandbox.unmount 会后于应用脚本的 mount 生命周期执行，恢复 window 对象的属性和被劫持方法。sandboxRunning 置为 false.</li>
<li>当应用再次被 mount 时，load 阶段创建的沙箱会被复用，然后按照以下流程处理：首先恢复 hijackAtBootstrapping 阶段劫持方法的执行结果；其次因为 sandboxRunning 为 false，基于 modifiedPropsOriginalValueMapInSandbox 快照恢复 window 对象的历史数据；其次执行 hijackAtMounting 劫持 window 方法；其次恢复 hijackAtMounting 阶段劫持方法的执行结果；最后将 sandboxRunning 置为 true。</li>
</ol>
<p>官方将应用 load 阶段的沙箱称为 app 环境沙箱；应用 mount 阶段的沙箱称为 render 沙箱。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">export</span> <span class="function"><span class="keyword">function</span> <span class="title">genSandbox</span>(<span class="params">appName: string, assetPublicPath: string</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> addedPropsMapInSandbox = <span class="keyword">new</span> <span class="built_in">Map</span>&lt;PropertyKey, any&gt;();<span class="comment">// 记录新增变量</span></span><br><span class="line">  <span class="keyword">const</span> modifiedPropsOriginalValueMapInSandbox = <span class="keyword">new</span> <span class="built_in">Map</span>&lt;PropertyKey, any&gt;();<span class="comment">// 记录更新变量</span></span><br><span class="line">  <span class="keyword">const</span> currentUpdatedPropsValueMap = <span class="keyword">new</span> <span class="built_in">Map</span>&lt;PropertyKey, any&gt;();<span class="comment">// 记录新增或更新变量</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// mountingFreers 用于释放 hijackAtMounting 劫持的方法</span></span><br><span class="line">  <span class="keyword">let</span> mountingFreers: Freer[] = [];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sideEffectsRebuilders 用于恢复劫持方法的执行结果</span></span><br><span class="line">  <span class="keyword">let</span> sideEffectsRebuilders: Rebuilder[] = [];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> sandboxRunning = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> boundValueSymbol = <span class="built_in">Symbol</span>(<span class="string">'bound value'</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> rawWindow = <span class="built_in">window</span>;</span><br><span class="line">  <span class="keyword">const</span> fakeWindow = <span class="built_in">Object</span>.create(<span class="literal">null</span>) <span class="keyword">as</span> Window;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> sandbox: WindowProxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(fakeWindow, &#123;</span><br><span class="line">    <span class="keyword">set</span>(_: Window, p: PropertyKey, value: any): boolean &#123;</span><br><span class="line">      <span class="keyword">if</span> (sandboxRunning) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!rawWindow.hasOwnProperty(p)) &#123;</span><br><span class="line">          addedPropsMapInSandbox.set(p, value);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!modifiedPropsOriginalValueMapInSandbox.has(p)) &#123;</span><br><span class="line">          <span class="keyword">const</span> originalValue = (rawWindow <span class="keyword">as</span> any)[p];</span><br><span class="line">          modifiedPropsOriginalValueMapInSandbox.set(p, originalValue);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        currentUpdatedPropsValueMap.set(p, value);</span><br><span class="line">        </span><br><span class="line">        (rawWindow <span class="keyword">as</span> any)[p] = value;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">'development'</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.warn(<span class="string">`Try to set window.<span class="subst">$&#123;p.toString()&#125;</span> while js sandbox destroyed or not active in <span class="subst">$&#123;appName&#125;</span>!`</span>);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 在 strict-mode 下，Proxy 的 handler.set 返回 false 会抛出 TypeError，在沙箱卸载的情况下应该忽略错误</span></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">get</span>(_: Window, p: PropertyKey): any &#123;</span><br><span class="line">      <span class="comment">// 避免用户使用 window.top、window.window、window.self 绕过沙箱机制</span></span><br><span class="line">      <span class="comment">// https://github.com/eligrey/FileSaver.js/blob/master/src/FileSaver.js#L13</span></span><br><span class="line">      <span class="keyword">if</span> (p === <span class="string">'top'</span> || p === <span class="string">'window'</span> || p === <span class="string">'self'</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> sandbox;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> value = (rawWindow <span class="keyword">as</span> any)[p];</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 为纯函数（不是构造函数）绑定 rawWindow</span></span><br><span class="line">      <span class="comment">// qiankun 通过 prototype 中是否还有可枚举的拓展方法的方式来判断是否构造函数。检测方法不要随意替换，因为可能触发一些 edge case（比如在 lodash.isFunction 在 iframe 上下文中可能由于调用了 top window 对象触发的安全异常）</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> value === <span class="string">'function'</span> &amp;&amp; !isConstructable(value)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (value[boundValueSymbol]) &#123;<span class="comment">// 已绑定 rawWindow</span></span><br><span class="line">          <span class="keyword">return</span> value[boundValueSymbol];</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">const</span> boundValue = value.bind(rawWindow);</span><br><span class="line">        <span class="built_in">Object</span>.keys(value).forEach(<span class="function"><span class="params">key</span> =&gt;</span> (boundValue[key] = value[key]));</span><br><span class="line">        <span class="built_in">Object</span>.defineProperty(value, boundValueSymbol, &#123; <span class="attr">enumerable</span>: <span class="literal">false</span>, <span class="attr">value</span>: boundValue &#125;);</span><br><span class="line">        <span class="keyword">return</span> boundValue;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> value;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    has(_: Window, <span class="attr">p</span>: string | number | symbol): boolean &#123;</span><br><span class="line">      <span class="keyword">return</span> p <span class="keyword">in</span> rawWindow;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// bootstrappingFreers 用于释放 hijackAtBootstrapping 劫持的方法</span></span><br><span class="line">  <span class="keyword">const</span> bootstrappingFreers = hijackAtBootstrapping(appName, assetPublicPath, sandbox);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    sandbox,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> mount() &#123;</span><br><span class="line">      <span class="keyword">const</span> sideEffectsRebuildersAtBootstrapping = sideEffectsRebuilders.slice(<span class="number">0</span>, bootstrappingFreers.length);</span><br><span class="line">      <span class="keyword">const</span> sideEffectsRebuildersAtMounting = sideEffectsRebuilders.slice(bootstrappingFreers.length);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 恢复 hijackAtBootstrapping 阶段劫持方法的执行结果</span></span><br><span class="line">      <span class="keyword">if</span> (sideEffectsRebuildersAtBootstrapping.length) &#123;</span><br><span class="line">        sideEffectsRebuildersAtBootstrapping.forEach(<span class="function"><span class="params">rebuild</span> =&gt;</span> rebuild());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">/* ------ 因为有上下文依赖（window），以下代码执行顺序不能变 ------- */</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// 沙箱未启动说明为唤醒流程，此时需从之前的修改记录中恢复上下文</span></span><br><span class="line">      <span class="keyword">if</span> (!sandboxRunning) &#123;</span><br><span class="line">        currentUpdatedPropsValueMap.forEach(<span class="function">(<span class="params">v, p</span>) =&gt;</span> setWindowProp(p, v));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// render 沙箱启动时开始劫持各类全局监听，尽量不要在应用初始化阶段有 事件监听/定时器 等副作用</span></span><br><span class="line">      mountingFreers = hijackAtMounting(appName, sandbox);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 恢复 hijackAtMounting 阶段劫持方法的执行结果</span></span><br><span class="line">      <span class="keyword">if</span> (sideEffectsRebuildersAtMounting.length) &#123;</span><br><span class="line">        sideEffectsRebuildersAtMounting.forEach(<span class="function"><span class="params">rebuild</span> =&gt;</span> rebuild());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      sideEffectsRebuilders = [];</span><br><span class="line"></span><br><span class="line">      sandboxRunning = <span class="literal">true</span>;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">    <span class="keyword">async</span> unmount() &#123;</span><br><span class="line">      <span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">'development'</span>) &#123;</span><br><span class="line">        <span class="built_in">console</span>.info(<span class="string">`<span class="subst">$&#123;appName&#125;</span> modified global properties will be restore`</span>, [</span><br><span class="line">          ...addedPropsMapInSandbox.keys(),</span><br><span class="line">          ...modifiedPropsOriginalValueMapInSandbox.keys(),</span><br><span class="line">        ]);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 释放劫持处理</span></span><br><span class="line">      sideEffectsRebuilders = [...bootstrappingFreers, ...mountingFreers].map(<span class="function"><span class="params">free</span> =&gt;</span> free());</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 恢复 window 对象的属性</span></span><br><span class="line">      modifiedPropsOriginalValueMapInSandbox.forEach(<span class="function">(<span class="params">v, p</span>) =&gt;</span> setWindowProp(p, v));</span><br><span class="line">      addedPropsMapInSandbox.forEach(<span class="function">(<span class="params">_, p</span>) =&gt;</span> setWindowProp(p, <span class="literal">undefined</span>, <span class="literal">true</span>));</span><br><span class="line"></span><br><span class="line">      sandboxRunning = <span class="literal">false</span>;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="hijacker"><a href="#hijacker" class="headerlink" title="hijacker"></a>hijacker</h3><p>hijackPublicPath 在 hijackAtBootstrapping 阶段执行，意义是将 window.<strong>INJECTED_PUBLIC_PATH_BY_QIANKUN</strong> 设置为 assetPublicPath（用作 webpack 中的 publicPath），应用卸载时清空，挂载时恢复。</p>
<p>hijackTimer 在 hijackAtMounting 阶段执行，劫持 setInterval、setTimeout，意义是应用卸载时清空定时器。</p>
<p>hijackWindowListener 在 hijackAtMounting 阶段执行，劫持 window.addEventListener、 window.removeEventListener，意义是应用卸载时自动解绑绑定函数。</p>
<p>hijackHistoryListener 在 hijackAtMounting 阶段执行，使用 umi 时有效，意义是应用卸载自动解绑 window.g_history.listen 绑定的函数。</p>
<p>hijackDynamicHeadAppend 在 hijackAtBootstrapping、hijackAtMounting 阶段均会执行，劫持 HTMLHeadElement.prototype.appendChild 方法。当使用 HTMLHeadElement.prototype.appendChild 向 head 头部添加 link、style、script 节点行为（开发环境的实际表现就是应用脚本），script 节点内容需要在沙箱环境中运行。以下是 hijackDynamicHeadAppend 源码。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">hijack</span>(<span class="params">appName: string, proxy: Window</span>): <span class="title">Freer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> dynamicStyleSheetElements: <span class="built_in">Array</span>&lt;HTMLLinkElement | HTMLStyleElement&gt; = [];</span><br><span class="line"></span><br><span class="line">  HTMLHeadElement.prototype.appendChild = <span class="function"><span class="keyword">function</span> <span class="title">appendChild</span>&lt;<span class="title">T</span> <span class="title">extends</span> <span class="title">Node</span>&gt;(<span class="params">this: any, newChild: T</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> element = newChild <span class="keyword">as</span> any;</span><br><span class="line">    <span class="keyword">if</span> (element.tagName) &#123;</span><br><span class="line">      <span class="keyword">switch</span> (element.tagName) &#123;</span><br><span class="line">        <span class="keyword">case</span> LINK_TAG_NAME:</span><br><span class="line">        <span class="keyword">case</span> STYLE_TAG_NAME: &#123;</span><br><span class="line">          <span class="keyword">const</span> stylesheetElement: HTMLLinkElement | HTMLStyleElement = newChild <span class="keyword">as</span> any;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// check if the currently specified application is active</span></span><br><span class="line">          <span class="comment">// While we switch page from qiankun app to a normal react routing page, the normal one may load stylesheet dynamically while page rendering,</span></span><br><span class="line">          <span class="comment">// but the url change listener must to wait until the current call stack is flushed.</span></span><br><span class="line">          <span class="comment">// This scenario may cause we record the stylesheet from react routing page dynamic injection,</span></span><br><span class="line">          <span class="comment">// and remove them after the url change triggered and qiankun app is unmouting</span></span><br><span class="line">          <span class="comment">// see https://github.com/ReactTraining/history/blob/master/modules/createHashHistory.js#L222-L230</span></span><br><span class="line">          <span class="keyword">const</span> activated = checkActivityFunctions(<span class="built_in">window</span>.location).some(<span class="function"><span class="params">name</span> =&gt;</span> name === appName);</span><br><span class="line">          <span class="comment">// only hijack dynamic style injection when app activated</span></span><br><span class="line">          <span class="keyword">if</span> (activated) &#123;</span><br><span class="line">            dynamicStyleSheetElements.push(stylesheetElement);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 使用 import-html-entry 的 execScripts 执行 script 节点内容，使其运行在沙箱环境</span></span><br><span class="line">        <span class="keyword">case</span> SCRIPT_TAG_NAME: &#123;</span><br><span class="line">          <span class="keyword">const</span> &#123; src, text &#125; = element <span class="keyword">as</span> HTMLScriptElement;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (src) &#123;</span><br><span class="line">            execScripts(<span class="literal">null</span>, [src], proxy).then(</span><br><span class="line">              () =&gt; &#123;</span><br><span class="line">                <span class="keyword">const</span> loadEvent = <span class="keyword">new</span> CustomEvent(<span class="string">'load'</span>);</span><br><span class="line">                <span class="keyword">if</span> (isFunction(element.onload)) &#123;</span><br><span class="line">                  element.onload(loadEvent);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  element.dispatchEvent(loadEvent);</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">              () =&gt; &#123;</span><br><span class="line">                <span class="keyword">const</span> errorEvent = <span class="keyword">new</span> CustomEvent(<span class="string">'error'</span>);</span><br><span class="line">                <span class="keyword">if</span> (isFunction(element.onerror)) &#123;</span><br><span class="line">                  element.onerror(errorEvent);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  element.dispatchEvent(errorEvent);</span><br><span class="line">                &#125;</span><br><span class="line">              &#125;,</span><br><span class="line">            );</span><br><span class="line"></span><br><span class="line">            <span class="keyword">const</span> dynamicScriptCommentElement = <span class="built_in">document</span>.createComment(<span class="string">`dynamic script <span class="subst">$&#123;src&#125;</span> replaced by qiankun`</span>);</span><br><span class="line">            <span class="keyword">return</span> rawHtmlAppendChild.call(<span class="keyword">this</span>, dynamicScriptCommentElement) <span class="keyword">as</span> T;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          execScripts(<span class="literal">null</span>, [<span class="string">`&lt;script&gt;<span class="subst">$&#123;text&#125;</span>&lt;/script&gt;`</span>], proxy).then(element.onload, element.onerror);</span><br><span class="line">          <span class="keyword">const</span> dynamicInlineScriptCommentElement = <span class="built_in">document</span>.createComment(<span class="string">'dynamic inline script replaced by qiankun'</span>);</span><br><span class="line">          <span class="keyword">return</span> rawHtmlAppendChild.call(<span class="keyword">this</span>, dynamicInlineScriptCommentElement) <span class="keyword">as</span> T;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> rawHtmlAppendChild.call(<span class="keyword">this</span>, element) <span class="keyword">as</span> T;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">free</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    HTMLHeadElement.prototype.appendChild = rawHtmlAppendChild;</span><br><span class="line">    dynamicStyleSheetElements.forEach(<span class="function"><span class="params">stylesheetElement</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">document</span>.head.contains(stylesheetElement)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (stylesheetElement <span class="keyword">instanceof</span> HTMLStyleElement &amp;&amp; isStyledComponentsLike(stylesheetElement)) &#123;</span><br><span class="line">          <span class="keyword">if</span> (stylesheetElement.sheet) &#123;</span><br><span class="line">            <span class="comment">// 缓存样式内容</span></span><br><span class="line">            setCachedRules(stylesheetElement, (stylesheetElement.sheet <span class="keyword">as</span> CSSStyleSheet).cssRules);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 移除 style、link 节点</span></span><br><span class="line">        <span class="built_in">document</span>.head.removeChild(stylesheetElement);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">rebuild</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">      dynamicStyleSheetElements.forEach(<span class="function"><span class="params">stylesheetElement</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="comment">// 重新添加 style、link 节点</span></span><br><span class="line">        <span class="built_in">document</span>.head.appendChild(stylesheetElement);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 恢复 style 节点的样式内容</span></span><br><span class="line">        <span class="keyword">if</span> (stylesheetElement <span class="keyword">instanceof</span> HTMLStyleElement &amp;&amp; isStyledComponentsLike(stylesheetElement)) &#123;</span><br><span class="line">          <span class="keyword">const</span> cssRules = getCachedRules(stylesheetElement);</span><br><span class="line">          <span class="keyword">if</span> (cssRules) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; cssRules.length; i++) &#123;</span><br><span class="line">              <span class="keyword">const</span> cssRule = cssRules[i];</span><br><span class="line">              (stylesheetElement.sheet <span class="keyword">as</span> CSSStyleSheet).insertRule(cssRule.cssText);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>以下改写自 <a href="https://github.com/kuitos/qiankun" target="_blank" rel="noopener">qiankun</a> 官方示例：</p>
<ol>
<li>编写主应用，设定 html 页面、待渲染内容的布局（通常是菜单）。</li>
<li>编写子应用，子应用需使用 umd 方式打包，这样才能加载到导出的生命周期函数（如上文所述，子应用的 publicPath 可使用 assetPublicPath 配置）。</li>
<li>子应用独立部署，然后由主应用远程获取子应用的 html 页面；或者子应用与主应用以 monorepo 方式组织，如 qiankun 官方示例一样。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 主应用框架 html 内容</span></span><br><span class="line"><span class="comment">// &lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="comment">// &lt;html lang="en"&gt;</span></span><br><span class="line"><span class="comment">// &lt;head&gt;</span></span><br><span class="line"><span class="comment">//   &lt;meta charset="UTF-8"&gt;</span></span><br><span class="line"><span class="comment">//   &lt;title&gt;main framework&lt;/title&gt;</span></span><br><span class="line"><span class="comment">// &lt;/head&gt;</span></span><br><span class="line"><span class="comment">// &lt;body&gt;</span></span><br><span class="line"><span class="comment">// &lt;main id="container"&gt;&lt;/main&gt;</span></span><br><span class="line"><span class="comment">// &lt;script src="./index.js"&gt;&lt;/script&gt;</span></span><br><span class="line"><span class="comment">// &lt;/body&gt;</span></span><br><span class="line"><span class="comment">// &lt;/html&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 主应用 index.js 脚本</span></span><br><span class="line"><span class="keyword">import</span> React <span class="keyword">from</span> <span class="string">'react'</span>;</span><br><span class="line"><span class="keyword">import</span> ReactDOM <span class="keyword">from</span> <span class="string">'react-dom'</span>;</span><br><span class="line"><span class="keyword">import</span> &#123; registerMicroApps, setDefaultMountApp, start &#125; <span class="keyword">from</span> <span class="string">'../../es'</span>;</span><br><span class="line"><span class="keyword">import</span> Framework <span class="keyword">from</span> <span class="string">'./Framework'</span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">render</span>(<span class="params">&#123; appContent, loading &#125;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> container = <span class="built_in">document</span>.getElementById(<span class="string">'container'</span>);</span><br><span class="line">  ReactDOM.render(&lt;&gt;</span><br><span class="line">    &lt;header className=&#123;style.header&#125;&gt;</span><br><span class="line">      &lt;nav&gt;</span><br><span class="line">        &lt;ol&gt;</span><br><span class="line">          &lt;li&gt;&lt;a onClick=&#123;() =&gt; goto('home', '/')&#125;&gt;home&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">          &lt;li&gt;&lt;a onClick=&#123;() =&gt; goto('react15 app', '/15react15')&#125;&gt;react15 + antd2&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">          &lt;li&gt;&lt;a onClick=&#123;() =&gt; goto('vue app', '/vue')&#125;&gt;vue2 + element2&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">          &lt;li&gt;&lt;a onClick=&#123;() =&gt; goto('react app', '/react')&#125;&gt;react16 + antd3&lt;/a&gt;&lt;/li&gt;</span><br><span class="line">        &lt;/ol&gt;</span><br><span class="line">      &lt;/nav&gt;</span><br><span class="line">    &lt;/header&gt;</span><br><span class="line">    &#123;loading ? &lt;div&gt;loading...&lt;/div&gt; : null&#125;</span><br><span class="line">    &lt;div dangerouslySetInnerHTML=&#123;&#123; __html: appContent &#125;&#125; className=&#123;style.appContainer&#125;/&gt;</span><br><span class="line">  &lt;/&gt;, container);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function genActiveRule(routerPrefix) &#123;</span><br><span class="line">  return location =&gt; location.pathname.startsWith(routerPrefix);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function initApp() &#123;</span><br><span class="line">  render(&#123; appContent: '', loading: true &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">initApp();</span><br><span class="line"></span><br><span class="line">registerMicroApps(</span><br><span class="line">  [</span><br><span class="line">    &#123; name: 'react16-main', entry: '//localhost:7100', render, activeRule: genActiveRule('/react') &#125;,</span><br><span class="line">    &#123; name: 'react15 app', entry: '//localhost:7102', render, activeRule: genActiveRule('/15react15') &#125;,</span><br><span class="line">    &#123; name: 'vue app', entry: '//localhost:7101', render, activeRule: genActiveRule('/vue') &#125;,</span><br><span class="line">  ],</span><br><span class="line">  &#123;</span><br><span class="line">    beforeLoad: [</span><br><span class="line">      app =&gt; &#123;</span><br><span class="line">        console.log('before load', app);</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">    beforeMount: [</span><br><span class="line">      app =&gt; &#123;</span><br><span class="line">        console.log('before mount', app);</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">    afterUnmount: [</span><br><span class="line">      app =&gt; &#123;</span><br><span class="line">        console.log('after unload', app);</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">  &#125;,</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">setDefaultMountApp('/react');</span><br><span class="line"></span><br><span class="line">start(&#123; prefetch: true &#125;);</span><br><span class="line"></span><br><span class="line">// react16-main 应用脚本</span><br><span class="line">import React from 'react';</span><br><span class="line">import ReactDOM from 'react-dom';</span><br><span class="line">import App from './App';</span><br><span class="line"></span><br><span class="line">function render() &#123;</span><br><span class="line">  ReactDOM.render(&lt;App /&gt;, document.getElementById('root'));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 设置 publicPath</span><br><span class="line">if (window.__POWERED_BY_QIANKUN__) &#123;</span><br><span class="line">  __webpack_public_path__ = window.__INJECTED_PUBLIC_PATH_BY_QIANKUN__;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">if (!window.__POWERED_BY_QIANKUN__) &#123;</span><br><span class="line">  render();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export async function bootstrap() &#123;</span><br><span class="line">  console.log('react app bootstraped');</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export async function mount(props) &#123;</span><br><span class="line">  console.log(props);</span><br><span class="line">  render();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">export async function unmount() &#123;</span><br><span class="line">  ReactDOM.unmountComponentAtNode(document.getElementById('root'));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="备注"><a href="#备注" class="headerlink" title="备注"></a>备注</h2><h3 id="import-html-entry"><a href="#import-html-entry" class="headerlink" title="import-html-entry"></a>import-html-entry</h3><p><a href="https://github.com/kuitos/import-html-entry" target="_blank" rel="noopener">import-html-entry</a> 中的 importHTML 函数按以下流程处理：</p>
<ol>
<li>默认使用 window.fetch 远程获取 html 页面内容；</li>
<li>再通过 processTpl(html, domain) 将 html 内容解析成 { template, scripts, styles, entry    } 对象（通过正则表达式解析，entry 为入口文件 —— 默认取 entry 文件夹下脚本或最后一个 script 节点内容；scripts 脚本；styles 样式文件 —— 通过 link 节点加载的样式；template 移除脚本和样式后的 html 内容）；</li>
<li>再通过 getEmbedHTML 从远程拉取 link 节点内容，填充到 html 中；</li>
<li>最后返回 template（即 html）、assetPublicPath、getExternalScripts、getExternalStyleSheets、execScripts。execScripts(proxy) 会使用 window 代理执行 script 脚本；getExternalScripts、getExternalStyleSheets 均获取脚本内容。</li>
</ol>
<p>importEntry 在 importHTML 的基础上，提供了多态实现，既可以指定 html 的 url，又可以指定 html 的内容。</p>
<p>以下是 execScripts 函数的源码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">execScripts</span>(<span class="params">entry, scripts, proxy = window, opts = &#123;&#125;</span>) </span>&#123;</span><br><span class="line">	<span class="keyword">const</span> &#123; fetch = defaultFetch &#125; = opts;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> getExternalScripts(scripts, fetch)</span><br><span class="line">		.then(<span class="function"><span class="params">scriptsText</span> =&gt;</span> &#123;</span><br><span class="line"></span><br><span class="line">			<span class="built_in">window</span>.proxy = proxy;<span class="comment">// 沙箱</span></span><br><span class="line">			<span class="keyword">const</span> geval = <span class="built_in">eval</span>;</span><br><span class="line"></span><br><span class="line">			<span class="function"><span class="keyword">function</span> <span class="title">exec</span>(<span class="params">scriptSrc, inlineScript, resolve</span>) </span>&#123;</span><br><span class="line">				<span class="keyword">const</span> markName = <span class="string">`Evaluating script <span class="subst">$&#123;scriptSrc&#125;</span>`</span>;</span><br><span class="line">				<span class="keyword">const</span> measureName = <span class="string">`Evaluating Time Consuming: <span class="subst">$&#123;scriptSrc&#125;</span>`</span>;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">'development'</span>) &#123;</span><br><span class="line">					performance.mark(markName);</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 入口文件导出，入口文件默认由最后一个 script 节点加载</span></span><br><span class="line">				<span class="keyword">if</span> (scriptSrc === entry) &#123;</span><br><span class="line">					noteGlobalProps();<span class="comment">// 记录 global 之前导出属性</span></span><br><span class="line"></span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						<span class="comment">// bind window.proxy to change `this` reference in script</span></span><br><span class="line">						geval(<span class="string">`;(function(window)&#123;;<span class="subst">$&#123;inlineScript&#125;</span>\n&#125;).bind(window.proxy)(window.proxy);`</span>);</span><br><span class="line">					&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">						<span class="built_in">console</span>.error(<span class="string">`error occurs while executing the entry <span class="subst">$&#123;scriptSrc&#125;</span>`</span>);</span><br><span class="line">						<span class="keyword">throw</span> e;</span><br><span class="line">					&#125;</span><br><span class="line"></span><br><span class="line">					<span class="keyword">const</span> exports = proxy[getGlobalProp()] || &#123;&#125;;<span class="comment">// 拣选出执行入口文件后，global 的导出属性</span></span><br><span class="line">          resolve(exports);</span><br><span class="line">        <span class="comment">// 非入口文件执行</span></span><br><span class="line">				&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">					<span class="keyword">try</span> &#123;</span><br><span class="line">						<span class="comment">// bind window.proxy to change `this` reference in script</span></span><br><span class="line">						geval(<span class="string">`;(function(window)&#123;;<span class="subst">$&#123;inlineScript&#125;</span>\n&#125;).bind(window.proxy)(window.proxy);`</span>);</span><br><span class="line">					&#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">						<span class="built_in">console</span>.error(<span class="string">`error occurs while executing <span class="subst">$&#123;scriptSrc&#125;</span>`</span>);</span><br><span class="line">						<span class="keyword">throw</span> e;</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line"></span><br><span class="line">				<span class="keyword">if</span> (process.env.NODE_ENV === <span class="string">'development'</span>) &#123;</span><br><span class="line">					performance.measure(measureName, markName);</span><br><span class="line">					performance.clearMarks(markName);</span><br><span class="line">					performance.clearMeasures(measureName);</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="function"><span class="keyword">function</span> <span class="title">schedule</span>(<span class="params">i, resolvePromise</span>) </span>&#123;</span><br><span class="line">				<span class="keyword">if</span> (i &lt; scripts.length) &#123;</span><br><span class="line">					<span class="keyword">const</span> scriptSrc = scripts[i];</span><br><span class="line">					<span class="keyword">const</span> inlineScript = scriptsText[i];</span><br><span class="line"></span><br><span class="line">					exec(scriptSrc, inlineScript, resolvePromise);</span><br><span class="line">					<span class="comment">// resolve the promise while the last script executed and entry not provided</span></span><br><span class="line">					<span class="keyword">if</span> (!entry &amp;&amp; i === scripts.length - <span class="number">1</span>) &#123;</span><br><span class="line">						resolvePromise();</span><br><span class="line">					&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">						schedule(i + <span class="number">1</span>, resolvePromise);</span><br><span class="line">					&#125;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function"><span class="params">resolve</span> =&gt;</span> schedule(<span class="number">0</span>, resolve));</span><br><span class="line">		&#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="react-app-rewire"><a href="#react-app-rewire" class="headerlink" title="react-app-rewire"></a>react-app-rewire</h3><p>qiankun 使用 <a href="https://github.com/timarney/react-app-rewired" target="_blank" rel="noopener">react-app-rewire</a> 制作微应用。仅需配置 config-overrides.js 以及 .env 约定端口号，然后使用 react-app-rewired start 启动。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; name &#125; = <span class="built_in">require</span>(<span class="string">'./package'</span>);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  webpack: <span class="function"><span class="keyword">function</span> <span class="title">override</span>(<span class="params">config, env</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> copyConfig = &#123; ...config &#125;;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'env'</span>, env);</span><br><span class="line">    copyConfig.output.library = <span class="string">`<span class="subst">$&#123;name&#125;</span>-[name]`</span>;</span><br><span class="line">    copyConfig.output.libraryTarget = <span class="string">'umd'</span>;</span><br><span class="line">    copyConfig.output.jsonpFunction = <span class="string">`webpackJsonp_<span class="subst">$&#123;name&#125;</span>`</span>;</span><br><span class="line">    <span class="keyword">return</span> config;</span><br><span class="line">  &#125;,</span><br><span class="line">  devServer: <span class="function"><span class="keyword">function</span>(<span class="params">configFunction</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">proxy, allowedHost</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">const</span> config = configFunction(proxy, allowedHost);</span><br><span class="line">      config.open = <span class="literal">false</span>;</span><br><span class="line">      config.hot = <span class="literal">false</span>;</span><br><span class="line">      config.headers = &#123;</span><br><span class="line">        <span class="string">'Access-Control-Allow-Origin'</span>: <span class="string">'*'</span>,</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="comment">// Return your customised Webpack Development Server config.</span></span><br><span class="line">      <span class="keyword">return</span> config;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="vuepress"><a href="#vuepress" class="headerlink" title="vuepress"></a>vuepress</h3><p>qiankun 使用 <a href="https://vuepress.vuejs.org/" target="_blank" rel="noopener">vuepress</a> 制作文档。关于 vuepress，笔者将在后续的文章中加以介绍。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>望洋兴叹。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/02/16/工程化/umi 插件钩子机制/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2020/02/16/工程化/umi 插件钩子机制/" itemprop="url">umi 插件钩子机制（修正版）</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-02-16T00:00:00+08:00">2020-02-16</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端/" itemprop="url" rel="index"><span itemprop="name">前端</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2020/02/16/工程化/umi 插件钩子机制/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2020/02/16/工程化/umi 插件钩子机制/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>plugin hook 插件钩子在 umi 内部的表现一为 method 方法，一为 hook 钩子。简单而论，插件钩子运作机制分为两步：register 注册插件钩子、apply 执行插件钩子。插件钩子按 name 命名存入 pluginHooks[name] 中，执行期间以 reduce 机制依次执行并控制入参。以下为 umi 源码注册插件钩子、执行插件钩子的底层方法：</p>
<ul>
<li>register(hook, fn) 注册插件钩子，hook 插件钩子名，fn 插件钩子执行脚本。</li>
<li>applyPlugins(key, opts) 依次执行插件钩子，key 插件钩子名，opts.initialValue 插件钩子链执行首参，opts.args 插件钩子链内处理参数。</li>
<li>_applyPluginsAsync(key, opts) 异步方式依次执行插件钩子。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** umi-build-dev *** PluginAPI.js ***/</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将插件钩子执行脚本添加到 pluginHooks[hook] 中</span></span><br><span class="line"><span class="comment"> * @param &#123;string&#125; hook hook 名，对应 registerMethod 中的 name</span></span><br><span class="line"><span class="comment"> * @param &#123;function&#125; fn hook 处理函数，对应 registerMethod 中的插件钩子执行脚本</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">register(hook, fn) &#123;</span><br><span class="line">  assert(</span><br><span class="line">    <span class="keyword">typeof</span> hook === <span class="string">'string'</span>,</span><br><span class="line">    <span class="string">`The first argument of api.register() must be string, but got <span class="subst">$&#123;hook&#125;</span>`</span>,</span><br><span class="line">  );</span><br><span class="line">  assert(</span><br><span class="line">    <span class="keyword">typeof</span> fn === <span class="string">'function'</span>,</span><br><span class="line">    <span class="string">`The second argument of api.register() must be function, but got <span class="subst">$&#123;fn&#125;</span>`</span>,</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> &#123; pluginHooks &#125; = <span class="keyword">this</span>.service;</span><br><span class="line">  pluginHooks[hook] = pluginHooks[hook] || [];</span><br><span class="line">  pluginHooks[hook].push(&#123;</span><br><span class="line">    fn,</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*** umi-build-dev *** Service.js ***/</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 取出 pluginHooks[key] 中的 hook 脚本（对应 registerMethod 中的插件钩子执行脚本）并依次执行</span></span><br><span class="line"><span class="comment"> * @param &#123;string&#125; key hook 名，对应 registerMethod 中的 name</span></span><br><span class="line"><span class="comment"> * @param &#123;function&#125; opts 设置初始值 opts.initialValue 和传递参数 opts.args</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line">applyPlugins(key, opts = &#123;&#125;) &#123;</span><br><span class="line">  debug(<span class="string">`apply plugins <span class="subst">$&#123;key&#125;</span>`</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params"><span class="keyword">this</span>.pluginHooks[key] || []</span>).<span class="params">reduce</span>(<span class="params">(memo, &#123; fn &#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> fn(&#123;</span><br><span class="line">        memo,</span><br><span class="line">        args: opts.args,</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e) &#123;</span><br><span class="line">      <span class="built_in">console</span>.error(chalk.red(<span class="string">`Plugin apply failed: <span class="subst">$&#123;e.message&#125;</span>`</span>));</span><br><span class="line">      <span class="keyword">throw</span> e;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;, opts.initialValue);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 异步方式依次执行插件钩子</span></span><br><span class="line"><span class="comment"> */</span> </span><br><span class="line"><span class="keyword">async</span> _applyPluginsAsync(key, opts = &#123;&#125;) &#123;</span><br><span class="line">  debug(<span class="string">`apply plugins async <span class="subst">$&#123;key&#125;</span>`</span>);</span><br><span class="line">  <span class="keyword">const</span> hooks = <span class="keyword">this</span>.pluginHooks[key] || [];</span><br><span class="line">  <span class="keyword">let</span> memo = opts.initialValue;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">const</span> hook <span class="keyword">of</span> hooks) &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; fn &#125; = hook;</span><br><span class="line">    <span class="comment">// eslint-disable-next-line no-await-in-loop</span></span><br><span class="line">    memo = <span class="keyword">await</span> fn(&#123;</span><br><span class="line">      memo,</span><br><span class="line">      args: opts.args,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> memo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>为什么 umi 选用 reduce 机制执行插件钩子呢？那就要说一下 umi 插件钩子承担的职责了。其一，插件钩子可用于修改配置项（包含添加和修改）；第二，插件钩子可用于监听事件；第三，插件钩子可用于设置普通的处理流程。仅以 webpack 配置为例，多个下游（下一个插件钩子执行脚本）如果想修改 webpack 配置，那就需要一种缓存机制将修改后的 webpack 配置传入下游，reduce 天然具有这种能力。那为何 umi 不使用上游的返回值 memo 作为下游的入参呢？我们再以 webpack 配置为例，线上环境、日常环境的配置内容往往是不同的，因此在插件钩子执行期间需要一个环境标识加以区分，umi 往下游传递的 opts.args 正好可以放这个环境标识。这样就解释了 applyPlugins 采用上述实现的原委了。</p>
<p>至于 umi 插件钩子为什么要承担那么多职能？笔者也摸不清头脑。</p>
<p>umi 内部将插件钩子定义为如下四类：</p>
<ol>
<li>apply 类：注册时提供 apply 自定义钩子处理函数，实现定制的处理流程。没有具体的应用场景。</li>
<li>ADD 类：注册时 type 值设为 ADD，用于添加配置项，典型如往 html 页面上添加 script 节点。</li>
<li>MODIFY 类：注册时 type 值设为 MODIFY，用于修改配置项，典型如修改 webpack 配置。</li>
<li>EVENT 类：注册时 type 值设为 EVENT，用于作事件处理，典型如监听 webpack 编译成功事件。</li>
</ol>
<p>上述四种插件钩子的实际效用又是怎样的呢？</p>
<ol>
<li>apply 类：没有具体的应用场景。</li>
<li>ADD、MODIFY 类：applyPlugins 执行返回结果供使用，因此需要在 applyPlugins 执行结束后才能确切明白其功能。</li>
<li>EVENT 类：插件钩子执行脚本即为功能实现。</li>
</ol>
<p>registerMethod 用于创建多态注册插件钩子的方法，该方法存为 pluginMethods[name]（实际作为 umi-plugin-* 插件中所使用的接口，如 api.addRuntimePlugin 即是 pluginMethods.addRuntimePlugin）。如上所述，插件钩子函数在 apply 类型下都是 umi 内部约定的，即 pluginMethods.addRuntimePlugin(…args) 的调用结果在 applyPlugins 阶段的表现只有两种可能，一种意义，都是变更 opts.memo 的值：</p>
<ul>
<li>当 args[0] 非函数，将 args[0] 塞入 opts.memo 中。</li>
<li>当 args[0] 为函数，使用该函数处理 opts.memo、opts.args，其返回值作为新的 opts.memo。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** umi-build-dev *** PluginAPI.js ***/</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成插件钩子的注册函数 pluginMethods[name]</span></span><br><span class="line"><span class="comment"> * 同一个 name 名下可以挂多个插件钩子脚本，以 pluginHooks[name] 形式存储</span></span><br><span class="line"><span class="comment"> * 最终通过 applyPlugins 调用，以 reduce 方式依次执行，参数 opts = &#123; memo, args &#125; 以闭包形式向后传递</span></span><br><span class="line"><span class="comment"> * @param &#123;string&#125; name 插件钩子名</span></span><br><span class="line"><span class="comment"> * @param &#123;object&#125; opts = &#123; type, apply &#125;</span></span><br><span class="line"><span class="comment"> *    type 插件钩子类型，umi 将根据 type 类型生成插件钩子脚本</span></span><br><span class="line"><span class="comment"> *         ADD 类型，往 opts.memo 里塞值</span></span><br><span class="line"><span class="comment"> *         MODIFY 类型，修改 opts.memo</span></span><br><span class="line"><span class="comment"> *         EVENT 类型，首参绑定函数会消费 opts.args</span></span><br><span class="line"><span class="comment"> *    apply 自定义插件钩子执行脚本，由该脚本消费 opts = &#123; memo, args &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">registerMethod(name, opts) &#123;</span><br><span class="line">  assert(!<span class="keyword">this</span>[name], <span class="string">`api.<span class="subst">$&#123;name&#125;</span> exists.`</span>);</span><br><span class="line">  assert(opts, <span class="string">`opts must supplied`</span>);</span><br><span class="line">  <span class="keyword">const</span> &#123; type, apply &#125; = opts;</span><br><span class="line">  assert(!(type &amp;&amp; apply), <span class="string">`Only be one for type and apply.`</span>);</span><br><span class="line">  assert(type || apply, <span class="string">`One of type and apply must supplied.`</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.service.pluginMethods[name] = <span class="function">(<span class="params">...args</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (apply) &#123;</span><br><span class="line">      <span class="keyword">this</span>.register(name, opts =&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> apply(opts, ...args);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="keyword">this</span>.API_TYPE.ADD) &#123;</span><br><span class="line">      <span class="keyword">this</span>.register(name, opts =&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> (opts.memo || []).concat(</span><br><span class="line">          <span class="keyword">typeof</span> args[<span class="number">0</span>] === <span class="string">'function'</span> ? args[<span class="number">0</span>](opts.memo, opts.args) : args[<span class="number">0</span>],</span><br><span class="line">        );</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="keyword">this</span>.API_TYPE.MODIFY) &#123;</span><br><span class="line">      <span class="keyword">this</span>.register(name, opts =&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">typeof</span> args[<span class="number">0</span>] === <span class="string">'function'</span> ? args[<span class="number">0</span>](opts.memo, opts.args) : args[<span class="number">0</span>];</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="keyword">this</span>.API_TYPE.EVENT) &#123;</span><br><span class="line">      <span class="keyword">this</span>.register(name, opts =&gt; &#123;</span><br><span class="line">        <span class="keyword">return</span> args[<span class="number">0</span>](opts.args);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`unexpected api type <span class="subst">$&#123;type&#125;</span>`</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>综上，register 用于底层注册插件钩子；applyPlugins、_applyPluginsAsync 用于底层调用插件钩子；registerMethod 用于生成插件钩子的注册方法。这四个方法均不对外暴露，对外暴露的是通过 registerMethod 生成的 pluginMethods[name]。那么，umi 内部为 umi-plugin-* 插件提供了多少种插件钩子的注册方法呢？我们可以看一下如下方法：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*** umi-build-dev *** PluginAPI.js ***/</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 基于 registerMethod 生成插件钩子的注册方法 pluginMethods[name]</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">_addMethods() &#123;</span><br><span class="line">  [</span><br><span class="line">    [</span><br><span class="line">      <span class="string">'chainWebpackConfig'</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        type: <span class="keyword">this</span>.API_TYPE.EVENT,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">    [</span><br><span class="line">      <span class="string">'_registerConfig'</span>,</span><br><span class="line">      &#123;</span><br><span class="line">        type: <span class="keyword">this</span>.API_TYPE.ADD,</span><br><span class="line">      &#125;,</span><br><span class="line">    ],</span><br><span class="line">    <span class="string">'onStart'</span>,</span><br><span class="line">    <span class="string">'onExit'</span>,</span><br><span class="line">    <span class="string">'onStartAsync'</span>,</span><br><span class="line">    <span class="string">'onRouteChange'</span>,</span><br><span class="line">    <span class="string">'onDevCompileDone'</span>,</span><br><span class="line">    <span class="string">'onBuildSuccess'</span>,</span><br><span class="line">    <span class="string">'onBuildSuccessAsync'</span>,</span><br><span class="line">    <span class="string">'onBuildFail'</span>,</span><br><span class="line">    <span class="string">'onPrintUmiError'</span>,</span><br><span class="line">    <span class="string">'addPageWatcher'</span>,</span><br><span class="line">    <span class="string">'addEntryCode'</span>,</span><br><span class="line">    <span class="string">'addEntryCodeAhead'</span>,</span><br><span class="line">    <span class="string">'addEntryImport'</span>,</span><br><span class="line">    <span class="string">'addEntryImportAhead'</span>,</span><br><span class="line">    <span class="string">'addEntryPolyfillImports'</span>,</span><br><span class="line">    <span class="string">'addRendererWrapperWithComponent'</span>,</span><br><span class="line">    <span class="string">'addRendererWrapperWithModule'</span>,</span><br><span class="line">    <span class="string">'addRouterImport'</span>,</span><br><span class="line">    <span class="string">'addRouterImportAhead'</span>,</span><br><span class="line">    <span class="string">'addVersionInfo'</span>,</span><br><span class="line">    <span class="string">'addUIPlugin'</span>,</span><br><span class="line">    <span class="string">'onUISocket'</span>,</span><br><span class="line">    <span class="string">'modifyAFWebpackOpts'</span>,</span><br><span class="line">    <span class="string">'modifyEntryRender'</span>,</span><br><span class="line">    <span class="string">'modifyEntryHistory'</span>,</span><br><span class="line">    <span class="string">'modifyRouteComponent'</span>,</span><br><span class="line">    <span class="string">'modifyRouterRootComponent'</span>,</span><br><span class="line">    <span class="string">'modifyWebpackConfig'</span>,</span><br><span class="line">    <span class="string">'_beforeServerWithApp'</span>,</span><br><span class="line">    <span class="string">'beforeDevServer'</span>,</span><br><span class="line">    <span class="string">'_beforeDevServerAsync'</span>,</span><br><span class="line">    <span class="string">'afterDevServer'</span>,</span><br><span class="line">    <span class="string">'addMiddlewareAhead'</span>,</span><br><span class="line">    <span class="string">'addMiddleware'</span>,</span><br><span class="line">    <span class="string">'addMiddlewareBeforeMock'</span>,</span><br><span class="line">    <span class="string">'addMiddlewareAfterMock'</span>,</span><br><span class="line">    <span class="string">'modifyRoutes'</span>,</span><br><span class="line">    <span class="string">'onPatchRoute'</span>,</span><br><span class="line">    <span class="string">'modifyHTMLContext'</span>,</span><br><span class="line">    <span class="string">'modifyPublicPathStr'</span>,</span><br><span class="line">    <span class="string">'addHTMLMeta'</span>,</span><br><span class="line">    <span class="string">'addHTMLLink'</span>,</span><br><span class="line">    <span class="string">'addHTMLScript'</span>,</span><br><span class="line">    <span class="string">'addHTMLStyle'</span>,</span><br><span class="line">    <span class="string">'addHTMLHeadScript'</span>,</span><br><span class="line">    <span class="string">'addUmiExports'</span>,</span><br><span class="line">    <span class="string">'modifyHTMLChunks'</span>,</span><br><span class="line">    <span class="string">'onGenerateFiles'</span>,</span><br><span class="line">    <span class="string">'onHTMLRebuild'</span>,</span><br><span class="line">    <span class="string">'modifyDefaultConfig'</span>,</span><br><span class="line">    <span class="string">'_modifyConfig'</span>,</span><br><span class="line">    <span class="string">'modifyHTMLWithAST'</span>,</span><br><span class="line">    <span class="string">'_modifyHelpInfo'</span>,</span><br><span class="line">    <span class="string">'addRuntimePlugin'</span>,</span><br><span class="line">    <span class="string">'addRuntimePluginKey'</span>,</span><br><span class="line">    <span class="string">'beforeBlockWriting'</span>,</span><br><span class="line">    <span class="string">'addBlockUIResource'</span>,</span><br><span class="line">    <span class="string">'modifyBlockUIResources'</span>,</span><br><span class="line">    <span class="string">'_modifyBlockPackageJSONPath'</span>,</span><br><span class="line">    <span class="string">'_modifyBlockDependencies'</span>,</span><br><span class="line">    <span class="string">'_modifyBlockFile'</span>,</span><br><span class="line">    <span class="string">'_modifyBlockTarget'</span>,</span><br><span class="line">    <span class="string">'_modifyCommand'</span>,</span><br><span class="line">    <span class="string">'_modifyBlockNewRouteConfig'</span>,</span><br><span class="line">    <span class="string">'beforeBuildCompileAsync'</span>,</span><br><span class="line">  ].forEach(<span class="function"><span class="params">method</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(method)) &#123;</span><br><span class="line">      <span class="keyword">this</span>.registerMethod(...method);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">let</span> type;</span><br><span class="line">      <span class="keyword">const</span> isPrivate = method.charAt(<span class="number">0</span>) === <span class="string">'_'</span>;</span><br><span class="line">      <span class="keyword">const</span> slicedMethod = isPrivate ? method.slice(<span class="number">1</span>) : method;</span><br><span class="line">      <span class="keyword">if</span> (slicedMethod.indexOf(<span class="string">'modify'</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">        type = <span class="keyword">this</span>.API_TYPE.MODIFY;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (slicedMethod.indexOf(<span class="string">'add'</span>) === <span class="number">0</span>) &#123;</span><br><span class="line">        type = <span class="keyword">this</span>.API_TYPE.ADD;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">        slicedMethod.indexOf(<span class="string">'on'</span>) === <span class="number">0</span> ||</span><br><span class="line">        slicedMethod.indexOf(<span class="string">'before'</span>) === <span class="number">0</span> ||</span><br><span class="line">        slicedMethod.indexOf(<span class="string">'after'</span>) === <span class="number">0</span></span><br><span class="line">      ) &#123;</span><br><span class="line">        type = <span class="keyword">this</span>.API_TYPE.EVENT;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`unexpected method name <span class="subst">$&#123;method&#125;</span>`</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.registerMethod(method, &#123; type &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>上述代码即意味着 umi 为 umi-plugin-* 插件提供了 api.chainWebpackConfig 等 pluginMethods[name]。</p>
<p>在内部实现上，pluginMethods[name] 表现为注册插件钩子；在外部调用表现上，pluginMethods[name] 如其 name 名所示，或者添加配置项（如 addRuntimePlugin），或者修改配置项（如 modifyWebpackConfig），或者执行事件处理函数（如 onDevCompileDone），主要分为以下几类：</p>
<ul>
<li>apply 类：以 umi 内置的自定义钩子函数处理 opts = { memo, args } 以及调用时获得的其他参数。</li>
<li>ADD 类：当首参为函数，该函数以 opts.memo、opts.args 为参数，用于获取新的 opts.memo；当首参非函数，将首参填入 opts.memo 以制作新的 opts.memo（如 addRuntimePlugin）。</li>
<li>MODIFY 类：当首参为函数，该函数以 opts.memo、opts.args 为参数，用于获取新的 opts.memo；当首参非函数，以首参作为新的 opts.memo（如 modifyWebpackConfig）。</li>
<li>EVENT 类：首参只能为函数，作为事件的绑定函数，以该函数处理 opts.args 消息（如 onDevCompileDone）。</li>
</ul>
<p>在后续文章中，笔者将揭开这些方法的具体意义。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>每每回头看，以往行文的精准性老是让人心生惭愧。此前一度觉得 umi 的 plugin hooks 机制很绕，现在看来，依然觉得很绕，只是 api.addRuntimePlugin 等对外接口显得清晰了。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/14/">14</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpeg" alt="Alfred">
            
              <p class="site-author-name" itemprop="name">Alfred</p>
              <p class="site-description motion-element" itemprop="description">人苦不知足，既得陇，复望蜀</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">137</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    <span class="site-state-item-count">38</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    <span class="site-state-item-count">26</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Alfred-sg" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/xiu-fan-79/activities" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-globe"></i>知乎</a>
                  </span>
                
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Alfred</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Pisces</a> v6.0.2</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.0.2"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.2"></script>



  

  
    <script id="dsq-count-scr" src="https://alfred.disqus.com/count.js" async></script>
  

  





	





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->





  

  

  

  

  
  

  

  

  

  

</body>
</html>
