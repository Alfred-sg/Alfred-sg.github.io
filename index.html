<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=6.0.2" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.2">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.2" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.0.2',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="Hexo, NexT" />


<meta name="description" content="人苦不知足，既得陇，复望蜀">
<meta property="og:type" content="website">
<meta property="og:title" content="修子范语">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="修子范语">
<meta property="og:description" content="人苦不知足，既得陇，复望蜀">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="修子范语">
<meta name="twitter:description" content="人苦不知足，既得陇，复望蜀">






  <link rel="canonical" href="http://yoursite.com/"/>


  <title>修子范语</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <div class="container sidebar-position-left 
  page-home">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">修子范语</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Alfredo's Notes</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br />首页</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />标签</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br />分类</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />归档</a>
        </li>
      

      
    </ul>
  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/11/ant design/antd-Input 组件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/11/ant design/antd-Input 组件/" itemprop="url">antd-Form 组件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-11T00:00:00+08:00">2018-11-11</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/antd-组件库/" itemprop="url" rel="index"><span itemprop="name">antd 组件库</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/11/ant design/antd-Input 组件/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/11/11/ant design/antd-Input 组件/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Input-组件"><a href="#Input-组件" class="headerlink" title="Input 组件"></a>Input 组件</h2><p>Input 组件只关乎布局，其余均为常规处理。props.addonBefore 为前置标签，props.addonAfter 为后置标签，props.prefix 前缀图标，props.suffix 后缀图标。参看官方图例：</p>
<img src="/2018/11/11/ant%20design/antd-Input%20组件/Input组件布局.png">
<p>Input 组件在 render 方法执行阶段将绘制出 input 原生组件。鉴于 react 的实现机制，对于 input 原生组件的处理，有受控组件和非手空组件的区别。受控组件即根据组件的 state 变化渲染 input 节点的值，非受控组件只允许组件渲染出 input 节点的默认值，而其实时值将根据用户的操作行为加以改变。ant design 中的 Input 组件对于受控组件和非受控组件的处理，即是当开发者同时传入 props.value 和 props.defaultValue，props.value 的优先级高于 props.defaultValue，且当 props.value 为 undefined 或 null，均会以空字符串渲染 input 节点的值。</p>
<p>在事件的绑定函数方面，常规的绑定函数均会透传到 input 原生组件上，而 props.onPressEnter, props.onKeyDown 两个绑定函数均会以 inputInstance.handleKeyDown 方法的形式挂载为 input 原生组件的 onKeyDown 绑定函数（inputInstance 为 Input 组件的实例）。</p>
<p>此外，inputInstance 实例内置 focus, blur, select 方法，其功用如 inputInstance.focus 可以在校验表单时使校验失败的输入框组件获得焦点。inputInstance.input 属性用于访问 input 原生节点。</p>
<p>在样式处理方面，笔者将作专文加以阐述。</p>
<h2 id="TextArea-组件"><a href="#TextArea-组件" class="headerlink" title="TextArea 组件"></a>TextArea 组件</h2>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/11/工程化/http-proxy-middleware源码解读/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/11/工程化/http-proxy-middleware源码解读/" itemprop="url">http-proxy-middleware 源码解读</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-11T00:00:00+08:00">2018-11-11</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端工程化/" itemprop="url" rel="index"><span itemprop="name">前端工程化</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/11/工程化/http-proxy-middleware源码解读/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/11/11/工程化/http-proxy-middleware源码解读/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>http-proxy-middleware 库借助于 <a href="http://xzfyu.com/2018/11/09/%E5%B7%A5%E7%A8%8B%E5%8C%96/node-http-proxy%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" target="_blank" rel="noopener">node-http-proxy</a>，用于将 node 服务器接收到的请求转发到目标服务器，实现代理服务器的功能。</p>
<h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><p>可以推想，使用 node-http-proxy 创建代理服务器 proxyServer 后，通过全局注册的转发规则获取到客户端请求 req 需要发送到的目标地址，再通过调用 proxyServer.web, proxyServer.ws 方法转发请求。</p>
<h3 id="转发规则"><a href="#转发规则" class="headerlink" title="转发规则"></a>转发规则</h3><p>从原理层面简单的归纳转发规则，就是客户端请求路径到目标服务器地址的映射关系。node-http-proxy 库将转发规则分为两部分加以配置，context 用于匹配需要转发的客户端请求，options.target 用于设定目标服务器的 host；option.router 根据客户端请求重新设定目标服务器的 host（这样，根据不同的请求，可以设定多个目标服务器）；option.pathRewrite 用于辅助将客户端请求路径转化为目标服务器地址。</p>
<h4 id="context"><a href="#context" class="headerlink" title="context"></a>context</h4><p>context 表示待转发请求的目录名。当客户端请求以 context 起始时，则该请求将被转发。如 context 设置为 ‘/api’，客户端所有以 ‘/api’ 起始的请求都会被转发；默认值为 ‘/‘，意为客户端发送的所有请求都会被转发。node-http-proxy 库使用 createConfig 解析获得 context；matchContext 函数校验客户端请求是否需要转发。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析获取 context，需要代理的请求 url 前缀</span></span><br><span class="line"><span class="comment"> * @param &#123;string|object|function&#125; context 作为 HttpProxyMiddleware 接口传入 createConfig 函数的参数</span></span><br><span class="line"><span class="comment"> * @param &#123;undefined|object&#125; opts 作为 HttpProxyMiddleware 接口传入 createConfig 函数的参数</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createConfig</span> (<span class="params">context, opts</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> config = &#123;</span><br><span class="line">    context: <span class="literal">undefined</span>,</span><br><span class="line">    options: &#123;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// context 作为 opts 传入，config.context 使用默认值</span></span><br><span class="line">  <span class="keyword">if</span> (isContextless(context, opts)) &#123;</span><br><span class="line">    config.context = <span class="string">'/'</span></span><br><span class="line">    config.options = _.assign(config.options, context)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// context 以 url 形式配置，可同时配置 context, options.target</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (isStringShortHand(context)) &#123;</span><br><span class="line">    <span class="keyword">var</span> oUrl = url.parse(context)</span><br><span class="line">    <span class="keyword">var</span> target = [oUrl.protocol, <span class="string">'//'</span>, oUrl.host].join(<span class="string">''</span>)</span><br><span class="line"></span><br><span class="line">    config.context = oUrl.pathname || <span class="string">'/'</span></span><br><span class="line">    config.options = _.assign(config.options, &#123; <span class="attr">target</span>: target &#125;, opts)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (oUrl.protocol === <span class="string">'ws:'</span> || oUrl.protocol === <span class="string">'wss:'</span>) &#123;</span><br><span class="line">      config.options.ws = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    config.context = context</span><br><span class="line">    config.options = _.assign(config.options, opts)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 配置 Logger 实例</span></span><br><span class="line">  configureLogger(config.options)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!config.options.target) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(ERRORS.ERR_CONFIG_FACTORY_TARGET_MISSING)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> config</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 解析获取 context，需要代理的请求 url 前缀</span></span><br><span class="line"><span class="comment"> * @param &#123;string|function&#125; context 需要代理的请求 url 前缀</span></span><br><span class="line"><span class="comment"> * @param &#123;object&#125; uri 客户端请求的 uri，即 req.originalUrl 或 req.url</span></span><br><span class="line"><span class="comment"> * @param &#123;object&#125; req 客户端请求 req</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">matchContext</span> (<span class="params">context, uri, req</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// context 为字符串路径，校验 url 是否以 context 起始</span></span><br><span class="line">  <span class="keyword">if</span> (isStringPath(context)) &#123;</span><br><span class="line">    <span class="keyword">return</span> matchSingleStringPath(context, uri)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// context 为 glob 模式的字符串路径（通过 is-glob 模块判断），校验  url 是否匹配 context（通过 micromatch 判断）</span></span><br><span class="line">  <span class="comment">// [glob 介绍](https://blog.csdn.net/Free_Wind22/article/details/78344166)</span></span><br><span class="line">  <span class="keyword">if</span> (isGlobPath(context)) &#123;</span><br><span class="line">    <span class="keyword">return</span> matchSingleGlobPath(context, uri)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 遍历 context，调用 matchSingleStringPath, matchSingleGlobPath 作校验</span></span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(context)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (context.every(isStringPath)) &#123;</span><br><span class="line">      <span class="keyword">return</span> matchMultiPath(context, uri)</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (context.every(isGlobPath)) &#123;</span><br><span class="line">      <span class="keyword">return</span> matchMultiGlobPath(context, uri)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(ERRORS.ERR_CONTEXT_MATCHER_INVALID_ARRAY)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// context 自定义函数，用于校验客户端请求是否需要转发</span></span><br><span class="line">  <span class="keyword">if</span> (_.isFunction(context)) &#123;</span><br><span class="line">    <span class="keyword">var</span> pathname = getUrlPathName(uri)</span><br><span class="line">    <span class="keyword">return</span> context(pathname, req)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(ERRORS.ERR_CONTEXT_MATCHER_GENERIC)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="target"><a href="#target" class="headerlink" title="target"></a>target</h4><p>target 表示目标服务器的 host。在 createConfig 函数的源码中，可以看到，target 即能通过 url 形式的 context 设定，又能通过 options.target 选项设定。当然，这样是作为全局配置设定的；同 node-http-proxy 库，http-proxy-middleware 也可以在具体的请求发生时作特殊处理。这后半分的内容，是通过全局配置 options.router 达成的。在 http-proxy-middleware 处理客户端请求的过程中，getTarget 函数将通过 options.router 获取目标服务器的 host。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 获取目标服务器的 host</span></span><br><span class="line"><span class="comment"> * @param &#123;object&#125; req 客户端请求 req</span></span><br><span class="line"><span class="comment"> * @param &#123;object&#125; config 即 HttpProxyMiddleware 接口的 options 参数，获取 options.router</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTarget</span> (<span class="params">req, config</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> newTarget</span><br><span class="line">  <span class="keyword">var</span> router = config.router</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (_.isPlainObject(router)) &#123;</span><br><span class="line">    newTarget = getTargetFromProxyTable(req, router)</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (_.isFunction(router)) &#123;</span><br><span class="line">    newTarget = router(req)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> newTarget</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getTargetFromProxyTable</span> (<span class="params">req, table</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> result</span><br><span class="line">  <span class="keyword">var</span> host = req.headers.host</span><br><span class="line">  <span class="keyword">var</span> path = req.url</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> hostAndPath = host + path<span class="comment">// 客户端请求路径</span></span><br><span class="line"></span><br><span class="line">  _.forIn(table, <span class="function"><span class="keyword">function</span> (<span class="params">value, key</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// containsPath(str) 函数，判断 str 是否包含 '/'</span></span><br><span class="line">    <span class="keyword">if</span> (containsPath(key)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (hostAndPath.indexOf(key) &gt; <span class="number">-1</span>) &#123;</span><br><span class="line">        result = table[key]</span><br><span class="line">        logger.debug(<span class="string">'[HPM] Router table match: "%s"'</span>, key)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (key === host) &#123;</span><br><span class="line">        result = table[key]</span><br><span class="line">        logger.debug(<span class="string">'[HPM] Router table match: "%s"'</span>, host)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="pathRewrite"><a href="#pathRewrite" class="headerlink" title="pathRewrite"></a>pathRewrite</h4><p>在 http-proxy-middleware 库中，options.pathRewrite 用于将客户端请求路径转化为目标服务器的路径（pathname 部分），既可以是 map 映射，也可以函数。createPathRewriter 函数将根据 options.pathRewrite 生成路径转化器 pathRewriter 函数；而 pathRewriter 用于将实际的客户端请求地址转化为目标服务器的路径。当 options.pathRewrite 为对象 key-value 时，pathRewriter 将把匹配 key 的客户端请求转化为 value 路径；当 options.pathRewrite 为函数时，将由客户端请求 req.url 获取目标服务器路径。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成 pathRewriter 函数</span></span><br><span class="line"><span class="comment"> * @param &#123;object|function&#125; rewriteConfig 即 HttpProxyMiddleware 接口的 options.pathRewrite 配置项</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createPathRewriter</span> (<span class="params">rewriteConfig</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> rulesCache</span><br><span class="line"></span><br><span class="line">  <span class="comment">// isValidRewriteConfig 函数用于校验 options.pathRewrite</span></span><br><span class="line">  <span class="keyword">if</span> (!isValidRewriteConfig(rewriteConfig)) &#123;</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (_.isFunction(rewriteConfig)) &#123;</span><br><span class="line">    <span class="keyword">var</span> customRewriteFn = rewriteConfig</span><br><span class="line">    <span class="keyword">return</span> customRewriteFn</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    rulesCache = parsePathRewriteRules(rewriteConfig)</span><br><span class="line">    <span class="keyword">return</span> rewritePath</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 参数 path 为 req.url</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">rewritePath</span> (<span class="params">path</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = path</span><br><span class="line"></span><br><span class="line">    _.forEach(rulesCache, <span class="function"><span class="keyword">function</span> (<span class="params">rule</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (rule.regex.test(path)) &#123;</span><br><span class="line">        result = result.replace(rule.regex, rule.value)</span><br><span class="line">        logger.debug(<span class="string">'[HPM] Rewriting path from "%s" to "%s"'</span>, path, result)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">parsePathRewriteRules</span> (<span class="params">rewriteConfig</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> rules = []</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (_.isPlainObject(rewriteConfig)) &#123;</span><br><span class="line">    _.forIn(rewriteConfig, <span class="function"><span class="keyword">function</span> (<span class="params">value, key</span>) </span>&#123;</span><br><span class="line">      rules.push(&#123;</span><br><span class="line">        regex: <span class="keyword">new</span> <span class="built_in">RegExp</span>(key),</span><br><span class="line">        value: rewriteConfig[key]</span><br><span class="line">      &#125;)</span><br><span class="line">      logger.info(<span class="string">'[HPM] Proxy rewrite rule created: "%s" ~&gt; "%s"'</span>, key, rewriteConfig[key])</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> rules</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="整体流程"><a href="#整体流程" class="headerlink" title="整体流程"></a>整体流程</h3><p>这部分将串联转发规则的解析和应用，是为 http-proxy-middleware 库的整体工作流程。</p>
<ol>
<li>解析 context，options 配置，获得全局注册的 context, options.target；并配置 Logger 实例。</li>
<li>使用 node-http-proxy 库常见代理服务器 proxy。</li>
<li>根据 options.pathRewrite 生成路径转化器 pathRewriter。</li>
<li>为代理服务器绑定事件。</li>
<li>创建转发 http, https, websocket 请求的代理中间件。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">HttpProxyMiddleware</span> (<span class="params">context, opts</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// https://github.com/chimurai/http-proxy-middleware/issues/57</span></span><br><span class="line">  <span class="keyword">var</span> wsUpgradeDebounced = _.debounce(handleUpgrade)</span><br><span class="line">  <span class="keyword">var</span> wsInitialized = <span class="literal">false</span></span><br><span class="line">  <span class="keyword">var</span> config = configFactory.createConfig(context, opts)</span><br><span class="line">  <span class="keyword">var</span> proxyOptions = config.options</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> proxy = httpProxy.createProxyServer(&#123;&#125;)</span><br><span class="line">  logger.info(<span class="string">'[HPM] Proxy created:'</span>, config.context, <span class="string">' -&gt; '</span>, proxyOptions.target)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> pathRewriter = PathRewriter.create(proxyOptions.pathRewrite)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 为代理服务器绑定事件</span></span><br><span class="line">  handlers.init(proxy, proxyOptions)</span><br><span class="line"></span><br><span class="line">  proxy.on(<span class="string">'error'</span>, logError)</span><br><span class="line"></span><br><span class="line">  middleware.upgrade = wsUpgradeDebounced</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> middleware</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 实际的代理中间件</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">middleware</span> (<span class="params">req, res, next</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (shouldProxy(config.context, req)) &#123;</span><br><span class="line">      <span class="keyword">var</span> activeProxyOptions = prepareProxyRequest(req)</span><br><span class="line">      proxy.web(req, res, activeProxyOptions)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      next()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (proxyOptions.ws === <span class="literal">true</span>) &#123;</span><br><span class="line">      catchUpgradeRequest(req.connection.server)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">catchUpgradeRequest</span> (<span class="params">server</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!wsInitialized) &#123;</span><br><span class="line">      server.on(<span class="string">'upgrade'</span>, wsUpgradeDebounced)</span><br><span class="line">      wsInitialized = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 转发 websocket 请求</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">handleUpgrade</span> (<span class="params">req, socket, head</span>) </span>&#123;</span><br><span class="line">    wsInitialized = <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (shouldProxy(config.context, req)) &#123;</span><br><span class="line">      <span class="keyword">var</span> activeProxyOptions = prepareProxyRequest(req)</span><br><span class="line">      proxy.ws(req, socket, head, activeProxyOptions)</span><br><span class="line">      logger.info(<span class="string">'[HPM] Upgrading to WebSocket'</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 判断请求是否需要转发</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">shouldProxy</span> (<span class="params">context, req</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> path = (req.originalUrl || req.url)</span><br><span class="line">    <span class="keyword">return</span> contextMatcher.match(context, path, req)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 转发请求</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">prepareProxyRequest</span> (<span class="params">req</span>) </span>&#123;</span><br><span class="line">    req.url = (req.originalUrl || req.url)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> originalPath = req.url</span><br><span class="line">    <span class="keyword">var</span> newProxyOptions = _.assign(&#123;&#125;, proxyOptions)</span><br><span class="line"></span><br><span class="line">    __applyRouter(req, newProxyOptions)</span><br><span class="line">    __applyPathRewrite(req, pathRewriter)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (proxyOptions.logLevel === <span class="string">'debug'</span>) &#123;</span><br><span class="line">      <span class="comment">// getArrow 返回的标识，用于区分 options.router, options.pathRewrite 的作用与否</span></span><br><span class="line">      <span class="comment">// '-&gt;' options.router, options.pathRewrite 均未作用</span></span><br><span class="line">      <span class="comment">// '=&gt;' options.router 作用, options.pathRewrite 未作用</span></span><br><span class="line">      <span class="comment">// '~&gt;' options.router 未作用, options.pathRewrite 作用</span></span><br><span class="line">      <span class="comment">// '≈&gt;' options.router, options.pathRewrite 均作用</span></span><br><span class="line">      <span class="keyword">var</span> arrow = getArrow(originalPath, req.url, proxyOptions.target, newProxyOptions.target)</span><br><span class="line">      logger.debug(<span class="string">'[HPM] %s %s %s %s'</span>, req.method, originalPath, arrow, newProxyOptions.target)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> newProxyOptions</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 根据请求获取目标服务器的 host</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__applyRouter</span> (<span class="params">req, options</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> newTarget</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (options.router) &#123;</span><br><span class="line">      newTarget = Router.getTarget(req, options)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (newTarget) &#123;</span><br><span class="line">        logger.debug(<span class="string">'[HPM] Router new target: %s -&gt; "%s"'</span>, options.target, newTarget)</span><br><span class="line">        options.target = newTarget</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 将目标服务器路径写入 req.url</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">__applyPathRewrite</span> (<span class="params">req, pathRewriter</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (pathRewriter) &#123;</span><br><span class="line">      <span class="keyword">var</span> path = pathRewriter(req.url, req)</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> path === <span class="string">'string'</span>) &#123;</span><br><span class="line">        req.url = path</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        logger.info(<span class="string">'[HPM] pathRewrite: No rewritten path found. (%s)'</span>, req.url)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">logError</span> (<span class="params">err, req, res</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> hostname = (req.headers &amp;&amp; req.headers.host) || (req.hostname || req.host)</span><br><span class="line">    <span class="keyword">var</span> target = proxyOptions.target.host || proxyOptions.target</span><br><span class="line">    <span class="keyword">var</span> errorMessage = <span class="string">'[HPM] Error occurred while trying to proxy request %s from %s to %s (%s) (%s)'</span></span><br><span class="line">    <span class="keyword">var</span> errReference = <span class="string">'https://nodejs.org/api/errors.html#errors_common_system_errors'</span></span><br><span class="line"></span><br><span class="line">    logger.error(errorMessage, req.url, hostname, target, err.code, errReference)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><h4 id="logger"><a href="#logger" class="headerlink" title="logger"></a>logger</h4><p>http-proxy-middleware 库使用单例模式创建 Logger 实例，并提供 setProvider 函数切换打印日志的 console 函数；setLevel 方法用于设定日志级别；继而由 Logger 实例提供 log, error, info, warn, debug 方法，这些方法在调用过程都会校验当前执行的方法是否符合当前日志级别，同时会允许首参以 %s 设定占位符，以注入次参等。</p>
<p>因日志模块在 node 服务器中广为应用，这里贴出 http-proxy-middleware 库中的代码实现。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> loggerInstance</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> defaultProvider = &#123;</span><br><span class="line">  log: <span class="built_in">console</span>.log,</span><br><span class="line">  debug: <span class="built_in">console</span>.log, </span><br><span class="line">  info: <span class="built_in">console</span>.info,</span><br><span class="line">  warn: <span class="built_in">console</span>.warn,</span><br><span class="line">  error: <span class="built_in">console</span>.error</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> LEVELS = &#123;</span><br><span class="line">  debug: <span class="number">10</span>,</span><br><span class="line">  info: <span class="number">20</span>,</span><br><span class="line">  warn: <span class="number">30</span>,</span><br><span class="line">  error: <span class="number">50</span>,</span><br><span class="line">  silent: <span class="number">80</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">Logger</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> logLevel</span><br><span class="line">  <span class="keyword">var</span> provider</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> api = &#123;</span><br><span class="line">    log: log,</span><br><span class="line">    debug: debug,</span><br><span class="line">    info: info,</span><br><span class="line">    warn: warn,</span><br><span class="line">    error: error,</span><br><span class="line">    setLevel: <span class="function"><span class="keyword">function</span> (<span class="params">v</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (isValidLevel(v)) &#123;<span class="comment">// isValidLevel 校验 v 是否 debug, info, warn, error, slient 中的一个</span></span><br><span class="line">        logLevel = v</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    setProvider: <span class="function"><span class="keyword">function</span> (<span class="params">fn</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (fn &amp;&amp; isValidProvider(fn)) &#123;<span class="comment">// isValidProvider 校验 fn 是否函数</span></span><br><span class="line">        provider = fn(defaultProvider)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  init()</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> api</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">init</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    api.setLevel(<span class="string">'info'</span>)</span><br><span class="line">    api.setProvider(<span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> defaultProvider</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">log</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    provider.log(_interpolate.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">debug</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (_showLevel(<span class="string">'debug'</span>)) &#123;</span><br><span class="line">      provider.debug(_interpolate.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">info</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (_showLevel(<span class="string">'info'</span>)) &#123;</span><br><span class="line">      provider.info(_interpolate.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">warn</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (_showLevel(<span class="string">'warn'</span>)) &#123;</span><br><span class="line">      provider.warn(_interpolate.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">error</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (_showLevel(<span class="string">'error'</span>)) &#123;</span><br><span class="line">      provider.error(_interpolate.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 校验调用的方法是否在当前允许的日志级别下</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_showLevel</span> (<span class="params">showLevel</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> result = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">var</span> currentLogLevel = LEVELS[logLevel]</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (currentLogLevel &amp;&amp; (currentLogLevel &lt;= LEVELS[showLevel])) &#123;</span><br><span class="line">      result = <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 参数转化，允许首参以 %s 形式设置占位符</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">_interpolate</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> fn = _.spread(util.format)</span><br><span class="line">    <span class="keyword">var</span> result = fn(_.slice(<span class="built_in">arguments</span>))</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  getInstance: <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!loggerInstance) &#123;</span><br><span class="line">      loggerInstance = <span class="keyword">new</span> Logger()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> loggerInstance</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="事件绑定"><a href="#事件绑定" class="headerlink" title="事件绑定"></a>事件绑定</h4><p>解析 options.onError, options.onProxyReq, options.onProxyReqWs, options.onProxyRes, options.onOpen, options.onClose，并绑定为代理服务器的事件。</p>
<p>默认的绑定函数为：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// onError 绑定函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">defaultErrorHandler</span> (<span class="params">err, req, res</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> host = (req.headers &amp;&amp; req.headers.host)</span><br><span class="line">  <span class="keyword">var</span> code = err.code</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (res.writeHead &amp;&amp; !res.headersSent) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="regexp">/HPE_INVALID/</span>.test(code)) &#123;</span><br><span class="line">      res.writeHead(<span class="number">502</span>)</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">switch</span> (code) &#123;</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'ECONNRESET'</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'ENOTFOUND'</span>:</span><br><span class="line">        <span class="keyword">case</span> <span class="string">'ECONNREFUSED'</span>:</span><br><span class="line">          res.writeHead(<span class="number">504</span>)</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">default</span>: res.writeHead(<span class="number">500</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  res.end(<span class="string">'Error occured while trying to proxy to: '</span> + host + req.url)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// onClose 绑定函数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">logClose</span> (<span class="params">req, socket, head</span>) </span>&#123;</span><br><span class="line">  logger.info(<span class="string">'[HPM] Client disconnected'</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><h3 id="webpack-dev-server"><a href="#webpack-dev-server" class="headerlink" title="webpack-dev-server"></a>webpack-dev-server</h3><p>webpack-dev-server 库会创建 express 服务器，其服务器代理的实现就是解析配置项，并挂载 http-proxy-middleware 中间件。主要逻辑在 features.proxy 方法中实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> features = &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  proxy: <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (options.proxy) &#123;</span><br><span class="line">      <span class="comment">// 解析配置</span></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(options.proxy)) &#123;</span><br><span class="line">        options.proxy = <span class="built_in">Object</span>.keys(options.proxy).map(<span class="function">(<span class="params">context</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">let</span> proxyOptions;</span><br><span class="line">          <span class="keyword">const</span> correctedContext = context</span><br><span class="line">            .replace(<span class="regexp">/^\*$/</span>, <span class="string">'**'</span>)</span><br><span class="line">            .replace(<span class="regexp">/\/\*$/</span>, <span class="string">''</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">typeof</span> options.proxy[context] === <span class="string">'string'</span>) &#123;</span><br><span class="line">            proxyOptions = &#123;</span><br><span class="line">              context: correctedContext,</span><br><span class="line">              target: options.proxy[context]</span><br><span class="line">            &#125;;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            proxyOptions = <span class="built_in">Object</span>.assign(&#123;&#125;, options.proxy[context]);</span><br><span class="line">            proxyOptions.context = correctedContext;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 日志级别</span></span><br><span class="line">          proxyOptions.logLevel = proxyOptions.logLevel || <span class="string">'warn'</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">return</span> proxyOptions;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 获得 proxy 中间件</span></span><br><span class="line">      <span class="keyword">const</span> getProxyMiddleware = <span class="function">(<span class="params">proxyConfig</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> context = proxyConfig.context || proxyConfig.path;</span><br><span class="line">        <span class="keyword">if</span> (proxyConfig.target) &#123;</span><br><span class="line">          <span class="keyword">return</span> httpProxyMiddleware(context, proxyConfig);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// 以配置项挂载多个中间件</span></span><br><span class="line">      options.proxy.forEach(<span class="function">(<span class="params">proxyConfigOrCallback</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">let</span> proxyConfig;</span><br><span class="line">        <span class="keyword">let</span> proxyMiddleware;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> proxyConfigOrCallback === <span class="string">'function'</span>) &#123;</span><br><span class="line">          proxyConfig = proxyConfigOrCallback();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          proxyConfig = proxyConfigOrCallback;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        proxyMiddleware = getProxyMiddleware(proxyConfig);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (proxyConfig.ws) &#123;</span><br><span class="line">          websocketProxies.push(proxyMiddleware);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        app.use(<span class="function">(<span class="params">req, res, next</span>) =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (<span class="keyword">typeof</span> proxyConfigOrCallback === <span class="string">'function'</span>) &#123;</span><br><span class="line">            <span class="keyword">const</span> newProxyConfig = proxyConfigOrCallback();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (newProxyConfig !== proxyConfig) &#123;</span><br><span class="line">              proxyConfig = newProxyConfig;</span><br><span class="line">              proxyMiddleware = getProxyMiddleware(proxyConfig);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">const</span> bypass = <span class="keyword">typeof</span> proxyConfig.bypass === <span class="string">'function'</span>;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">const</span> bypassUrl = (bypass &amp;&amp; proxyConfig.bypass(req, res, proxyConfig)) || <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// 转发到本地服务器</span></span><br><span class="line">          <span class="keyword">if</span> (bypassUrl) &#123;</span><br><span class="line">            req.url = bypassUrl;</span><br><span class="line"></span><br><span class="line">            next();</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (proxyMiddleware) &#123;</span><br><span class="line">            <span class="keyword">return</span> proxyMiddleware(req, res, next);</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            next();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/11/设计模式/适配器模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/11/设计模式/适配器模式/" itemprop="url">适配器模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-11T00:00:00+08:00">2018-11-11</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/设计模式/" itemprop="url" rel="index"><span itemprop="name">设计模式</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/11/设计模式/适配器模式/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/11/11/设计模式/适配器模式/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/09/工程化/node-http-proxy源码解读/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/09/工程化/node-http-proxy源码解读/" itemprop="url">node-http-proxy 源码解读</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-09T00:00:00+08:00">2018-11-09</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端工程化/" itemprop="url" rel="index"><span itemprop="name">前端工程化</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/09/工程化/node-http-proxy源码解读/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/11/09/工程化/node-http-proxy源码解读/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>node-http-proxy 模块用于转发 http 请求，其实现的大致原理为使用 http 或 https 模块搭建 node 代理服务器，将客户端发送的请求数据转发到目标服务器，再将响应输送到客户端。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="整体流程"><a href="#整体流程" class="headerlink" title="整体流程"></a>整体流程</h3><p>同 koa 的中间件机制相仿，node-http-proxy 模块内部组装任务队列，在请求转发的过程中，将任务队列中的处理函数逐个执行。处理函数的意义通常是封装消息头，当然，最后一个处理函数用于转发请求、输出响应。</p>
<p>同常见的 ajax 模块，node-http-proxy 模块接受全局配置的 options，同时，在某个具体的请求中，又接受特定的配置项 opts。而客户端发送的请求可能是 http, https 请求，也可能是 websocket 请求，node-http-proxy 模块必须实现对这两类请求的不同处理。</p>
<p>上述三点，实际的代码体现在 createRightProxy 高阶函数中：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 参数 type 用于区分请求类型，'web' 为普通 http, https 请求，'ws' 为 websocket 请求</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createRightProxy</span>(<span class="params">type</span>) </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 参数 options 为全局配置项</span></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">req, res <span class="regexp">/*, [head], [opts] */</span></span>) </span>&#123;</span><br><span class="line">      <span class="comment">// passes 任务队列</span></span><br><span class="line">      <span class="keyword">var</span> passes = (type === <span class="string">'ws'</span>) ? <span class="keyword">this</span>.wsPasses : <span class="keyword">this</span>.webPasses,</span><br><span class="line">          args = [].slice.call(<span class="built_in">arguments</span>),</span><br><span class="line">          cntr = args.length - <span class="number">1</span>,</span><br><span class="line">          head, cbl;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 解析回调函数</span></span><br><span class="line">      <span class="keyword">if</span>(<span class="keyword">typeof</span> args[cntr] === <span class="string">'function'</span>) &#123;</span><br><span class="line">        cbl = args[cntr];</span><br><span class="line">        cntr--;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 混入该请求中特定的配置项 opts</span></span><br><span class="line">      <span class="keyword">var</span> requestOptions = options;</span><br><span class="line">      <span class="keyword">if</span>(</span><br><span class="line">        !(args[cntr] <span class="keyword">instanceof</span> Buffer) &amp;&amp;</span><br><span class="line">        args[cntr] !== res</span><br><span class="line">      ) &#123;</span><br><span class="line">        requestOptions = extend(&#123;&#125;, options);</span><br><span class="line">        extend(requestOptions, args[cntr]);</span><br><span class="line">        cntr--;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// head</span></span><br><span class="line">      <span class="keyword">if</span>(args[cntr] <span class="keyword">instanceof</span> Buffer) &#123;</span><br><span class="line">        head = args[cntr];</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 请求的目标地址</span></span><br><span class="line">      [<span class="string">'target'</span>, <span class="string">'forward'</span>].forEach(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">typeof</span> requestOptions[e] === <span class="string">'string'</span>)</span><br><span class="line">          requestOptions[e] = parse_url(requestOptions[e]);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!requestOptions.target &amp;&amp; !requestOptions.forward) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.emit(<span class="string">'error'</span>, <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Must provide a proper URL as target'</span>));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 挨个执行任务队列，处理消息头，转发请求</span></span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i &lt; passes.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(passes[i](req, res, requestOptions, head, <span class="keyword">this</span>, cbl)) &#123;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因此，createRightProxy(‘web’)(options), createRightProxy(‘ws’)(options) 就能用于创建实际的请求转发函数。在 node-http-proxy 模块中，这两个函数分别表现为 ProxyServer 实例的 web, ws 方法。其中，proxyServer.web 方法作为 http 或 https 服务器 listen 方法的回调函数，proxyServer.ws 方法作为 ‘upgrade’ 事件的绑定函数，从而能对接上客户端 ajax 请求、websocket 请求的执行时机。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProxyServer</span>(<span class="params">options</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建转发 http, https; websocket 请求的处理函数</span></span><br><span class="line">  <span class="keyword">this</span>.web = <span class="keyword">this</span>.proxyRequest           = createRightProxy(<span class="string">'web'</span>)(options);</span><br><span class="line">  <span class="keyword">this</span>.ws  = <span class="keyword">this</span>.proxyWebsocketRequest  = createRightProxy(<span class="string">'ws'</span>)(options);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 任务队列，用于处理消息头、转发请求</span></span><br><span class="line">  <span class="keyword">this</span>.webPasses = <span class="built_in">Object</span>.keys(web).map(<span class="function"><span class="keyword">function</span>(<span class="params">pass</span>) </span>&#123;<span class="comment">// this.web 方法执行过程中调用的任务队列</span></span><br><span class="line">    <span class="keyword">return</span> web[pass];</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">this</span>.wsPasses = <span class="built_in">Object</span>.keys(ws).map(<span class="function"><span class="keyword">function</span>(<span class="params">pass</span>) </span>&#123;<span class="comment">// this.ws 方法执行过程中调用的任务队列</span></span><br><span class="line">    <span class="keyword">return</span> ws[pass];</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ProxyServer.prototype.listen = <span class="function"><span class="keyword">function</span>(<span class="params">port, hostname</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> self    = <span class="keyword">this</span>,</span><br><span class="line">      closure = <span class="function"><span class="keyword">function</span>(<span class="params">req, res</span>) </span>&#123; self.web(req, res); &#125;;<span class="comment">// 转发 http, https 请求</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>._server  = <span class="keyword">this</span>.options.ssl ?</span><br><span class="line">    https.createServer(<span class="keyword">this</span>.options.ssl, closure) :</span><br><span class="line">    http.createServer(closure);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 转发 websocket 请求</span></span><br><span class="line">  <span class="keyword">if</span>(<span class="keyword">this</span>.options.ws) &#123;</span><br><span class="line">    <span class="keyword">this</span>._server.on(<span class="string">'upgrade'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">req, socket, head</span>) </span>&#123; self.ws(req, socket, head); &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>._server.listen(port, hostname);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>以上不涉及任务队列的具体实现，却构成了 node-http-proxy 模块整体处理流程。除外而外，ProxyServer 还提供 before(type, passName, callback), after(type, passName, callback) 原型方法，用于在任务队列的某个具体处理函数之前或之后插入一个处理函数 callback。</p>
<h3 id="http-https-请求"><a href="#http-https-请求" class="headerlink" title="http, https 请求"></a>http, https 请求</h3><p>this.webPasses 任务队列包含如下四种处理函数：deleteLength, timeout, XHeaders, stream。</p>
<ol>
<li>deleteLength 函数：针对 DELETE 或 OPTIONS，且 headers[‘content-length’] 未设置的情形，将 headers[‘content-length’] 置为 0，并删除 headers[‘transfer-encoding’] 消息头。</li>
<li>timeout 函数：若设置了 options.timeout，调用 req.socket.setTimeout(options.timeout) 设置超时时间。</li>
<li>XHeaders 函数：设置 ‘x-forwarded-for’, ‘x-forwarded-port’, ‘x-forwarded-proto’, ‘x-forwarded-host’ 消息头，包含客户端和代理服务器的地址、端口、协议等内容（以 ‘,’ 拼接 req.headers 同名属性即客户端内容、和代理服务器内容）。其中，’x-forwarded-host’ 消息头只包含 req.headers.host，即代理服务器的主机名。由配置项 options.xfwd 启用 ‘x-forwarded-*’ 消息头的设置。</li>
<li>stream 函数：实际转发请求的处理函数。下文将作详解。</li>
</ol>
<p>stream 函数的处理流程为：</p>
<ol>
<li>调用 common.setupOutgoing 方法生成代理请求的配置项。</li>
<li>通过 options.forward, options.target 区分 ‘forward’ 和 ‘target’ 两种模式。在 ‘forward’ 模式下，只通过代理请求转发到目标服务器，输送给客户端的仍是代理服务器的响应。’target’ 模式下，不只可以处理目标服务器的响应，且可监听许多事件对代理请求等作出处理。’forward’ 和 ‘target’ 模式可以并行存在，即同时指定 options.forward, options.target。</li>
</ol>
<p>首先，common.setupOutgoing 的实现如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 生成代理请求的配置项，将作为 http.request 的参数</span></span><br><span class="line"><span class="comment"> * @param &#123;object&#125; outgoing 即 options.ssl 或 &#123;&#125;</span></span><br><span class="line"><span class="comment"> * @param &#123;object&#125; options 即 options</span></span><br><span class="line"><span class="comment"> * @param &#123;object&#125; req 即实际的请求</span></span><br><span class="line"><span class="comment"> * @param &#123;string|undefined&#125; forward 用于区分 'forward' 和 'target' 模式。值为 'forward' 或 undefined</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">common.setupOutgoing = <span class="function"><span class="keyword">function</span>(<span class="params">outgoing, options, req, forward</span>) </span>&#123;</span><br><span class="line">  outgoing.port = options[forward || <span class="string">'target'</span>].port ||</span><br><span class="line">                  (isSSL.test(options[forward || <span class="string">'target'</span>].protocol) ? <span class="number">443</span> : <span class="number">80</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// http://nodejs.cn/api/http.html#http_http_request_options_callback</span></span><br><span class="line">  <span class="comment">// host, host: 目标服务器的域名或 IP 地址</span></span><br><span class="line">  <span class="comment">// socketPath: Unix 域 Socket（使用 host:port 或 socketPath）</span></span><br><span class="line">  <span class="comment">// ca: ca 证书</span></span><br><span class="line">  [<span class="string">'host'</span>, <span class="string">'hostname'</span>, <span class="string">'socketPath'</span>, <span class="string">'pfx'</span>, <span class="string">'key'</span>,</span><br><span class="line">    <span class="string">'passphrase'</span>, <span class="string">'cert'</span>, <span class="string">'ca'</span>, <span class="string">'ciphers'</span>, <span class="string">'secureProtocol'</span>].forEach(</span><br><span class="line">    <span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123; outgoing[e] = options[forward || <span class="string">'target'</span>][e]; &#125;</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 请求方法</span></span><br><span class="line">  outgoing.method = options.method || req.method;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 请求头</span></span><br><span class="line">  outgoing.headers = extend(&#123;&#125;, req.headers);</span><br><span class="line">  <span class="keyword">if</span> (options.headers)&#123;</span><br><span class="line">    extend(outgoing.headers, options.headers);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 基本身份验证，如 'user:password' 用来计算 Authorization 请求头</span></span><br><span class="line">  <span class="keyword">if</span> (options.auth) &#123;</span><br><span class="line">    outgoing.auth = options.auth;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (options.ca) &#123;</span><br><span class="line">    outgoing.ca = options.ca;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isSSL.test(options[forward || <span class="string">'target'</span>].protocol)) &#123;</span><br><span class="line">    outgoing.rejectUnauthorized = (<span class="keyword">typeof</span> options.secure === <span class="string">"undefined"</span>) ? <span class="literal">true</span> : options.secure;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// http://nodejs.cn/api/http.html#http_new_agent_options</span></span><br><span class="line">  <span class="comment">// 长连接时设置 options.agent = &#123; keepAlive, keepAliveMsecs &#125;</span></span><br><span class="line">  outgoing.agent = options.agent || <span class="literal">false</span>;</span><br><span class="line">  outgoing.localAddress = options.localAddress;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 不是长连接，设置 outgoing.headers.connection 请求头</span></span><br><span class="line">  <span class="keyword">if</span> (!outgoing.agent) &#123;</span><br><span class="line">    outgoing.headers = outgoing.headers || &#123;&#125;;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> outgoing.headers.connection !== <span class="string">'string'</span></span><br><span class="line">        || !upgradeHeader.test(outgoing.headers.connection)</span><br><span class="line">       ) &#123; outgoing.headers.connection = <span class="string">'close'</span>; &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 最终的请求路径由 options['forward'|'target'], req.url 拼接产生，可根据 options 配置设定某项是否启用</span></span><br><span class="line">  <span class="keyword">var</span> target = options[forward || <span class="string">'target'</span>];</span><br><span class="line">  <span class="keyword">var</span> targetPath = target &amp;&amp; options.prependPath !== <span class="literal">false</span></span><br><span class="line">    ? (target.path || <span class="string">''</span>) : <span class="string">''</span>;</span><br><span class="line">  <span class="keyword">var</span> outgoingPath = !options.toProxy</span><br><span class="line">    ? (url.parse(req.url).path || <span class="string">''</span>) : req.url;</span><br><span class="line">  outgoingPath = !options.ignorePath ? outgoingPath : <span class="string">''</span>;</span><br><span class="line">  outgoing.path = common.urlJoin(targetPath, outgoingPath);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (options.changeOrigin) &#123;</span><br><span class="line">    outgoing.headers.host =</span><br><span class="line">      <span class="comment">// 通过 requires-port 模块校验在使用某种协议的情况下，是否需要在 url 上拼接端口号</span></span><br><span class="line">      required(outgoing.port, options[forward || <span class="string">'target'</span>].protocol) &amp;&amp; !hasPort(outgoing.host)</span><br><span class="line">        ? outgoing.host + <span class="string">':'</span> + outgoing.port</span><br><span class="line">        : outgoing.host;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> outgoing;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>其次，stream 的实现如下：</p>
<ol>
<li>调用 [http|https].request(outgoing) 创建代理请求。outgoing 由 common.setupOutgoing 函数获得。</li>
<li>调用 (options.buffer || req).pipe(forwardReq) 方法转发代理请求。</li>
<li>target 模式下，调用 web-outgoing 模块中的函数处理代理响应。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stream</span>(<span class="params">req, res, options, _, server, clb</span>) </span>&#123;</span><br><span class="line">  server.emit(<span class="string">'start'</span>, req, res, options.target || options.forward);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// options.followRedirects 是否使用 follow-redirects 重定向</span></span><br><span class="line">  <span class="keyword">var</span> agents = options.followRedirects ? followRedirects : nativeAgents;</span><br><span class="line">  <span class="keyword">var</span> http = agents.http;</span><br><span class="line">  <span class="keyword">var</span> https = agents.https;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(options.forward) &#123;</span><br><span class="line">    <span class="comment">// 生成代理请求</span></span><br><span class="line">    <span class="keyword">var</span> forwardReq = (options.forward.protocol === <span class="string">'https:'</span> ? https : http).request(</span><br><span class="line">      common.setupOutgoing(options.ssl || &#123;&#125;, options, req, <span class="string">'forward'</span>)</span><br><span class="line">    );</span><br><span class="line"></span><br><span class="line">    <span class="keyword">var</span> forwardError = createErrorHandler(forwardReq, options.forward);</span><br><span class="line">    req.on(<span class="string">'error'</span>, forwardError);</span><br><span class="line">    forwardReq.on(<span class="string">'error'</span>, forwardError);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 转发代理请求</span></span><br><span class="line">    (options.buffer || req).pipe(forwardReq);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 非 target 模式，返回响应</span></span><br><span class="line">    <span class="keyword">if</span>(!options.target) &#123; <span class="keyword">return</span> res.end(); &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 生成代理请求</span></span><br><span class="line">  <span class="keyword">var</span> proxyReq = (options.target.protocol === <span class="string">'https:'</span> ? https : http).request(</span><br><span class="line">    common.setupOutgoing(options.ssl || &#123;&#125;, options, req)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  proxyReq.on(<span class="string">'socket'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">socket</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(server) &#123; server.emit(<span class="string">'proxyReq'</span>, proxyReq, req, res, options); &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(options.proxyTimeout) &#123;</span><br><span class="line">    proxyReq.setTimeout(options.proxyTimeout, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        proxyReq.abort();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  req.on(<span class="string">'aborted'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">    proxyReq.abort();</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> proxyError = createErrorHandler(proxyReq, options.target);</span><br><span class="line">  req.on(<span class="string">'error'</span>, proxyError);</span><br><span class="line">  proxyReq.on(<span class="string">'error'</span>, proxyError);</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">createErrorHandler</span>(<span class="params">proxyReq, url</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="title">proxyError</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (req.socket.destroyed &amp;&amp; err.code === <span class="string">'ECONNRESET'</span>) &#123;</span><br><span class="line">        server.emit(<span class="string">'econnreset'</span>, err, req, res, url);</span><br><span class="line">        <span class="keyword">return</span> proxyReq.abort();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (clb) &#123;</span><br><span class="line">        clb(err, req, res, url);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        server.emit(<span class="string">'error'</span>, err, req, res, url);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 转发代理请求</span></span><br><span class="line">  (options.buffer || req).pipe(proxyReq);</span><br><span class="line"></span><br><span class="line">  proxyReq.on(<span class="string">'response'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">proxyRes</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(server) &#123; server.emit(<span class="string">'proxyRes'</span>, proxyRes, req, res); &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 调用 web-outgoing 模块中的函数处理代理响应</span></span><br><span class="line">    <span class="keyword">if</span>(!res.headersSent &amp;&amp; !options.selfHandleResponse) &#123;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>; i &lt; web_o.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span>(web_o[i](req, res, proxyRes, options)) &#123; <span class="keyword">break</span>; &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// http://nodejs.cn/api/http.html#http_response_finished</span></span><br><span class="line">    <span class="keyword">if</span> (!res.finished) &#123;</span><br><span class="line">      <span class="comment">// 通过事件处理代理响应</span></span><br><span class="line">      proxyRes.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (server) server.emit(<span class="string">'end'</span>, req, res, proxyRes);</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 由 node-http-proxy 模块处理代理响应的情境下，返回响应</span></span><br><span class="line">      <span class="keyword">if</span> (!options.selfHandleResponse) proxyRes.pipe(res);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (server) server.emit(<span class="string">'end'</span>, req, res, proxyRes);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后，再来看一下 web-outgoing 模块对代理响应的处理（实现查看源码）：</p>
<ol>
<li>removeChunked 函数：当使用 http/1.0 时（通过 req.httpVersion === ‘1.0’ 判断，客户端决定），移除代理响应的 headers[‘transfer-encoding’]。</li>
<li>setConnection 函数：当使用 http/1.0 时，代理响应的 headers.connection 设为 req.headers.connection || ‘close’；当使用非 http/2.0 时，且 proxyRes.headers.connection 为否，将 代理响应的 headers.connection 设为 req.headers.connection || ‘keep-alive’。</li>
<li>setRedirectHostRewrite 函数：根据 options.hostRewrite 或 options.autoRewrite 或 options.protocolRewrite 重写重定向地址 proxyRes.headers.location。代理相应的状态码须匹配 /^201|30(1|2|7|8)$/ 正则，且 proxyRes.headers.location 须与目标服务器同域名。</li>
<li>writeHeaders 函数：将代理响应的消息头写入实际响应 res 的消息头中。下文将作详解。</li>
<li>writeStatusCode 函数：将代理响应的 statusCode, statusMessage 写入返回给客户端的响应 res 中。</li>
</ol>
<p>setRedirectHostRewrite 函数的代码实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">writeHeaders</span>(<span class="params">req, res, proxyRes, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> rewriteCookieDomainConfig = options.cookieDomainRewrite,</span><br><span class="line">      rewriteCookiePathConfig = options.cookiePathRewrite,</span><br><span class="line">      preserveHeaderKeyCase = options.preserveHeaderKeyCase,</span><br><span class="line">      rawHeaderKeyMap,</span><br><span class="line">      setHeader = <span class="function"><span class="keyword">function</span>(<span class="params">key, header</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (header == <span class="literal">undefined</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (rewriteCookieDomainConfig &amp;&amp; key.toLowerCase() === <span class="string">'set-cookie'</span>) &#123;</span><br><span class="line">          header = common.rewriteCookieProperty(header, rewriteCookieDomainConfig, <span class="string">'domain'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (rewriteCookiePathConfig &amp;&amp; key.toLowerCase() === <span class="string">'set-cookie'</span>) &#123;</span><br><span class="line">          header = common.rewriteCookieProperty(header, rewriteCookiePathConfig, <span class="string">'path'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        res.setHeader(<span class="built_in">String</span>(key).trim(), header);</span><br><span class="line">      &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> rewriteCookieDomainConfig === <span class="string">'string'</span>) &#123; <span class="comment">//also test for ''</span></span><br><span class="line">    rewriteCookieDomainConfig = &#123; <span class="string">'*'</span>: rewriteCookieDomainConfig &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">typeof</span> rewriteCookiePathConfig === <span class="string">'string'</span>) &#123; <span class="comment">//also test for ''</span></span><br><span class="line">    rewriteCookiePathConfig = &#123; <span class="string">'*'</span>: rewriteCookiePathConfig &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// http://nodejs.cn/api/http.html#http_message_rawheaders</span></span><br><span class="line">  <span class="keyword">if</span> (preserveHeaderKeyCase &amp;&amp; proxyRes.rawHeaders != <span class="literal">undefined</span>) &#123;</span><br><span class="line">    rawHeaderKeyMap = &#123;&#125;;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; proxyRes.rawHeaders.length; i += <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="keyword">var</span> key = proxyRes.rawHeaders[i];</span><br><span class="line">      rawHeaderKeyMap[key.toLowerCase()] = key;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">Object</span>.keys(proxyRes.headers).forEach(<span class="function"><span class="keyword">function</span>(<span class="params">key</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> header = proxyRes.headers[key];</span><br><span class="line">    <span class="keyword">if</span> (preserveHeaderKeyCase &amp;&amp; rawHeaderKeyMap) &#123;</span><br><span class="line">      key = rawHeaderKeyMap[key] || key;</span><br><span class="line">    &#125;</span><br><span class="line">    setHeader(key, header);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据 options.cookieDomainRewrite, options.cookiePathRewrite 重写 res.headers.cookie 中的 domain, path 属性</span></span><br><span class="line"><span class="comment">// cookie.domain 表示 cookie 所在的域</span></span><br><span class="line"><span class="comment">// cookie.path 表示 cookie 所在的目录</span></span><br><span class="line"><span class="comment">// 参考 [理解cookie的path和domain属性](https://www.cnblogs.com/chris-oil/p/3869803.html)</span></span><br><span class="line">common.rewriteCookieProperty = <span class="function"><span class="keyword">function</span> <span class="title">rewriteCookieProperty</span>(<span class="params">header, config, property</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Array</span>.isArray(header)) &#123;</span><br><span class="line">    <span class="keyword">return</span> header.map(<span class="function"><span class="keyword">function</span> (<span class="params">headerElement</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> rewriteCookieProperty(headerElement, config, property);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> header.replace(<span class="keyword">new</span> <span class="built_in">RegExp</span>(<span class="string">"(;\\s*"</span> + property + <span class="string">"=)([^;]+)"</span>, <span class="string">'i'</span>), <span class="function"><span class="keyword">function</span>(<span class="params">match, prefix, previousValue</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> newValue;</span><br><span class="line">    <span class="keyword">if</span> (previousValue <span class="keyword">in</span> config) &#123;</span><br><span class="line">      newValue = config[previousValue];</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">'*'</span> <span class="keyword">in</span> config) &#123;</span><br><span class="line">      newValue = config[<span class="string">'*'</span>];</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> match;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (newValue) &#123;</span><br><span class="line">      <span class="keyword">return</span> prefix + newValue;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="string">''</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h3 id="websocket-请求"><a href="#websocket-请求" class="headerlink" title="websocket 请求"></a>websocket 请求</h3><p>this.wsPasses 任务队列包含如下四种处理函数：checkMethodAndHeader, XHeaders, stream。</p>
<ol>
<li>checkMethodAndHeader 函数：websocket 请求的请求方式必须是 get，且 headers.upgrade 请求头必须是 ‘websocket’，checkMethodAndHeader 函数用于校验请求方式和 headers.upgrade 请求头。</li>
<li>XHeaders 函数：设置 ‘x-forwarded-for’, ‘x-forwarded-port’, ‘x-forwarded-proto’ 消息头，包含客户端和代理服务器的地址、端口、协议等内容（以 ‘,’ 拼接 req.headers 同名属性即客户端内容、和代理服务器内容）。由配置项 options.xfwd 启用 ‘x-forwarded-*’ 消息头的设置。</li>
<li>stream 函数：实际转发请求的处理函数。下文将作详解。</li>
</ol>
<p>stream 函数的处理流程为：</p>
<ol>
<li>调用 common.setupOutgoing 方法生成代理请求的配置项。</li>
<li>调用 [http|https].request(outgoing) 创建代理请求 proxyReq。</li>
<li>调用 proxyReq.end 发送代理请求。 </li>
<li>监听 response 事件，修改消息头后将响应发送给客户端。</li>
<li>监听 upgrade 事件，更换协议后，调用 proxySocket.pipe(socket).pipe(proxySocket) 再次发送代理请求。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line">common.setupSocket = <span class="function"><span class="keyword">function</span>(<span class="params">socket</span>) </span>&#123;</span><br><span class="line">  socket.setTimeout(<span class="number">0</span>);</span><br><span class="line">  socket.setNoDelay(<span class="literal">true</span>);</span><br><span class="line">  socket.setKeepAlive(<span class="literal">true</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> socket;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stream</span>(<span class="params">req, socket, options, head, server, clb</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// 添加请求头内容</span></span><br><span class="line">  <span class="keyword">var</span> createHttpHeader = <span class="function"><span class="keyword">function</span>(<span class="params">line, headers</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">Object</span>.keys(headers).reduce(<span class="function"><span class="keyword">function</span> (<span class="params">head, key</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">var</span> value = headers[key];</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (!<span class="built_in">Array</span>.isArray(value)) &#123;</span><br><span class="line">        head.push(key + <span class="string">': '</span> + value);</span><br><span class="line">        <span class="keyword">return</span> head;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; value.length; i++) &#123;</span><br><span class="line">        head.push(key + <span class="string">': '</span> + value[i]);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> head;</span><br><span class="line">    &#125;, [line])</span><br><span class="line">    .join(<span class="string">'\r\n'</span>) + <span class="string">'\r\n\r\n'</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  common.setupSocket(socket);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (head &amp;&amp; head.length) socket.unshift(head);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建代理请求</span></span><br><span class="line">  <span class="keyword">var</span> proxyReq = (common.isSSL.test(options.target.protocol) ? https : http).request(</span><br><span class="line">    common.setupOutgoing(options.ssl || &#123;&#125;, options, req)</span><br><span class="line">  );</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (server) &#123; server.emit(<span class="string">'proxyReqWs'</span>, proxyReq, req, socket, options, head); &#125;</span><br><span class="line"></span><br><span class="line">  proxyReq.on(<span class="string">'error'</span>, onOutgoingError);</span><br><span class="line">  proxyReq.on(<span class="string">'response'</span>, <span class="function"><span class="keyword">function</span> (<span class="params">res</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 属性响应到客户端</span></span><br><span class="line">    <span class="keyword">if</span> (!res.upgrade) &#123;</span><br><span class="line">      socket.write(createHttpHeader(<span class="string">'HTTP/'</span> + res.httpVersion + <span class="string">' '</span> + res.statusCode + <span class="string">' '</span> + res.statusMessage, res.headers));</span><br><span class="line">      res.pipe(socket);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  proxyReq.on(<span class="string">'upgrade'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">proxyRes, proxySocket, proxyHead</span>) </span>&#123;</span><br><span class="line">    proxySocket.on(<span class="string">'error'</span>, onOutgoingError);</span><br><span class="line"></span><br><span class="line">    proxySocket.on(<span class="string">'end'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      server.emit(<span class="string">'close'</span>, proxyRes, proxySocket, proxyHead);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    socket.on(<span class="string">'error'</span>, <span class="function"><span class="keyword">function</span> (<span class="params"></span>) </span>&#123;</span><br><span class="line">      proxySocket.end();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    common.setupSocket(proxySocket);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (proxyHead &amp;&amp; proxyHead.length) proxySocket.unshift(proxyHead);</span><br><span class="line"></span><br><span class="line">    socket.write(createHttpHeader(<span class="string">'HTTP/1.1 101 Switching Protocols'</span>, proxyRes.headers));</span><br><span class="line"></span><br><span class="line">    proxySocket.pipe(socket).pipe(proxySocket);<span class="comment">// 再次发送代理请求？</span></span><br><span class="line"></span><br><span class="line">    server.emit(<span class="string">'open'</span>, proxySocket);</span><br><span class="line">    server.emit(<span class="string">'proxySocket'</span>, proxySocket);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> proxyReq.end(); <span class="comment">// 发送代理请求</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">onOutgoingError</span>(<span class="params">err</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (clb) &#123;</span><br><span class="line">      clb(err, req, socket);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      server.emit(<span class="string">'error'</span>, err, req, socket);</span><br><span class="line">    &#125;</span><br><span class="line">    socket.end();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><h3 id="http-proxy-middleware"><a href="#http-proxy-middleware" class="headerlink" title="http-proxy-middleware"></a>http-proxy-middleware</h3><p>参见 <a href="http://xzfyu.com/2018/11/11/%E5%B7%A5%E7%A8%8B%E5%8C%96/http-proxy-middleware%E6%BA%90%E7%A0%81%E8%A7%A3%E8%AF%BB/" target="_blank" rel="noopener">http-proxy-middleware 源码解读</a>。</p>
<h3 id="nokit-filter-proxy"><a href="#nokit-filter-proxy" class="headerlink" title="nokit-filter-proxy"></a>nokit-filter-proxy</h3><p>nokit-filter-proxy 库用于为 <a href="https://github.com/nokitjs/nokit" target="_blank" rel="noopener">nokit</a> 服务器添加代理功能。鉴于前端构建工具 dawn 使用 nokit 搭建本地调试服务器，nokit-filter-proxy 库也用于为 dn-middleware-server 中间件实现代理功能。</p>
<p>同 http-proxy-middleware 库，nokit-filter-proxy 借助 node-http-proxy 实现服务器代理的都是先校验请求路径是否匹配转发策略，拦截并转发请求。nokit-filter-proxy 通过绑定 onRequest 事件函数，实现请求的拦截和转发。详见源码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> httpProxy = <span class="built_in">require</span>(<span class="string">"http-proxy"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">ProxyFilter</span>(<span class="params">server</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">var</span> utils = self.utils = server.require(<span class="string">"$./core/utils"</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// proxy 配置，作为请求路径转发规则</span></span><br><span class="line">  self.configs = server.configs.proxy || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 作为代理服务器的配置项</span></span><br><span class="line">  self.configs.options = self.configs.options || &#123;&#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 代理请求设置 'x-forwarded-for', 'x-forwarded-port', 'x-forwarded-proto', 'x-forwarded-host' 消息头</span></span><br><span class="line">  <span class="keyword">if</span> (utils.isNull(self.configs.options.xfwd)) &#123;</span><br><span class="line">    self.configs.options.xfwd = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 代理请求设置 headers.host 消息头</span></span><br><span class="line">  <span class="keyword">if</span> (utils.isNull(self.configs.options.changeOrigin)) &#123;</span><br><span class="line">    self.configs.options.changeOrigin = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 请求路径转发规则，key - value 形式，key 为客户端请求路径正则，value 为目标服务器路径</span></span><br><span class="line">  self.configs.rules = self.configs.rules || &#123;&#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 创建代理服务器  </span></span><br><span class="line">  self.proxy = httpProxy.createProxyServer(self.configs.options);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 转发代理请求前，使用 headers 配置修改代理请求的消息头</span></span><br><span class="line">  self.onProxyReqHandler = self.onProxyReqHandler.bind(self);</span><br><span class="line">  self.proxy.on(<span class="string">"proxyReq"</span>, self.onProxyReqHandler);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ProxyFilter.prototype.onProxyReqHandler = <span class="function"><span class="keyword">function</span>(<span class="params">proxyReq, req, res, options</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">if</span> (!self.configs.headers) <span class="keyword">return</span>;</span><br><span class="line">  self.utils.each(self.configs.headers, <span class="function"><span class="keyword">function</span>(<span class="params">name, value</span>) </span>&#123;</span><br><span class="line">    proxyReq.setHeader(name, value);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// self.matchRule 根据 rules 配置，解析出请求路径转发规则</span></span><br><span class="line">ProxyFilter.prototype.matchRule = <span class="function"><span class="keyword">function</span>(<span class="params">url</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">var</span> rule = <span class="literal">null</span>;</span><br><span class="line">  self.utils.each(self.configs.rules, <span class="function"><span class="keyword">function</span>(<span class="params">exprText, target</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> expr = <span class="keyword">new</span> <span class="built_in">RegExp</span>(exprText);</span><br><span class="line">    <span class="keyword">if</span> (expr.test(url)) &#123;</span><br><span class="line">      <span class="keyword">var</span> urlParts = expr.exec(url);</span><br><span class="line">      rule = &#123;</span><br><span class="line">        url: urlParts.length &gt; <span class="number">1</span> ? urlParts[<span class="number">1</span>] : url,</span><br><span class="line">        target: target</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  <span class="keyword">return</span> rule;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ProxyFilter.prototype.onRequest = <span class="function"><span class="keyword">function</span>(<span class="params">context, next</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> self = <span class="keyword">this</span>;</span><br><span class="line">  <span class="keyword">var</span> res = context.res,</span><br><span class="line">    req = context.req;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">var</span> rule = self.matchRule(req.url);</span><br><span class="line">  <span class="keyword">if</span> (!rule) <span class="keyword">return</span> next();</span><br><span class="line">  req.url = rule.url || <span class="string">"/"</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 转发代理请求</span></span><br><span class="line">  self.proxy.web(req, res, &#123;</span><br><span class="line">    <span class="string">"target"</span>: rule.target</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>这两篇文章都是在笔者整理完 proxy 设计模式后整理的。鉴于本人水平有限，文章难免错谬，仍望读者不吝赐教。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/06/设计模式/代理模式/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/06/设计模式/代理模式/" itemprop="url">代理模式</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-06T00:00:00+08:00">2018-11-06</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/设计模式/" itemprop="url" rel="index"><span itemprop="name">设计模式</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/06/设计模式/代理模式/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/11/06/设计模式/代理模式/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><p>代理模式(proxy pattern) 的主要处理逻辑为，构建代理对象以桥接对实际对象的访问。因此，可以在访问过程中构建附加的间接性操作如请求处理、权限校验、内务处理(housekeeping task)等，也可以为多种实际对象提供统一的接口。</p>
<p>《设计模式:可复用面向对象软件的基础》中的说法是：</p>
<blockquote class="blockquote-center"><p>Provide a surrogate or placeholder for another object to control access to it.</p>
</blockquote>
<p>维基百科的说法是：</p>
<blockquote class="blockquote-center"><p>A proxy, in its most general form, is a class functioning as an interface to something else. A proxy is a wrapper or agent object that is being called by the client to access the real serving object behind the scenes. Use of the proxy can simply be forwarding to the real object, or can provide additional logic. In the proxy extra functionality can be provided, for example caching when operations on the real object are resource intensive, or checking preconditions before operations on the real object are invoked.</p>
</blockquote>
<p>使用代理模式的场景：</p>
<ol>
<li>远程代理(remote proxy): 为一个远程服务对象提供本地表现，通过本地方法调用远程服务。</li>
<li>虚代理(virtual proxy): 在代理中延迟创建一个开销很大的对象。如在图片代理对象的实现过程中，draw 方法执行前才创建实际所需的图片对象。</li>
<li>保护代理(protection proxy): 访问对象前执行权限校验。</li>
<li>智能指引(smart reference): 访问实际的对象时执行附加操作，如对引用计数，当没被引用时，释放内存；首次引用时，将持久对象装入内存等。</li>
</ol>
<h2 id="结构"><a href="#结构" class="headerlink" title="结构"></a>结构</h2><img src="/2018/11/06/设计模式/代理模式/proxy.png">
<ul>
<li>Proxy: 以引用形式持有实体，接口与 Subject 相同，以便于使用代理对象替代实体，并控制对实体的访问。必要时，可以在代理对象中创建或删除实体。<ul>
<li>remote proxy 负责对请求及其参数进行编码，并向远程服务器发送请求。</li>
<li>virtual proxy 负责缓存实体的附加信息，以便延迟创建实体。</li>
<li>protection proxy 负责校验请求是否有特定的访问权限。</li>
</ul>
</li>
<li>Subject 定义 RealSubject, Proxy 的公共接口，因此在需要使用 RealSubject 的场景中都可以使用 Proxy 代替。</li>
<li>RealSubject 定义 Proxy 所代表的实体。</li>
</ul>
<h2 id="经典实现"><a href="#经典实现" class="headerlink" title="经典实现"></a>经典实现</h2><p>使用代理模式为多种类型的字段提供统一的接口，在 FieldProxy 实例 setValue 方法执行过程中，我们也能添加诸如数据校验等处理函数。这里只展示代理模式实现的一种方式，而不推敲代理模式在字段处理上的意义。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Field</span> </span>&#123;</span><br><span class="line">  type;<span class="comment">// 字段类型</span></span><br><span class="line">  name;<span class="comment">// 字段 code</span></span><br><span class="line">  title;<span class="comment">// 字段名</span></span><br><span class="line">  required;<span class="comment">// 字段是否必填</span></span><br><span class="line">  value;<span class="comment">// 字段的值</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(props)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; name, title, required &#125; = props;</span><br><span class="line">    <span class="keyword">this</span>.name = name;</span><br><span class="line">    <span class="keyword">this</span>.title = title;</span><br><span class="line">    <span class="keyword">this</span>.required = required;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setValue(value)&#123;</span><br><span class="line">    <span class="keyword">this</span>.value = value;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// input</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Input</span> <span class="keyword">extends</span> <span class="title">Field</span> </span>&#123;</span><br><span class="line">  type = <span class="string">'input'</span>;</span><br><span class="line">  placeholder;</span><br><span class="line">  maxLength;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(props)&#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">const</span> &#123; placeholder, maxLength &#125; = props;</span><br><span class="line">    <span class="keyword">this</span>.placeholder = placeholder;</span><br><span class="line">    <span class="keyword">this</span>.maxLength = maxLength;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// textarea</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Textarea</span> <span class="keyword">extends</span> <span class="title">Field</span> </span>&#123;</span><br><span class="line">  type = <span class="string">'textarea'</span>;</span><br><span class="line">  placeholder;</span><br><span class="line">  maxLength;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(props)&#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">const</span> &#123; placeholder, maxLength &#125; = props;</span><br><span class="line">    <span class="keyword">this</span>.placeholder = placeholder;</span><br><span class="line">    <span class="keyword">this</span>.maxLength = maxLength;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// radio</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Radio</span> <span class="keyword">extends</span> <span class="title">Field</span> </span>&#123;</span><br><span class="line">  type = <span class="string">'radio'</span>;</span><br><span class="line">  options;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(props)&#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">const</span> &#123; options &#125; = props;</span><br><span class="line">    <span class="keyword">this</span>.options = options;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// checkbox</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Checkbox</span> <span class="keyword">extends</span> <span class="title">Field</span> </span>&#123;</span><br><span class="line">  type = <span class="string">'checkbox'</span>;</span><br><span class="line">  options;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(props)&#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">const</span> &#123; options &#125; = props;</span><br><span class="line">    <span class="keyword">this</span>.options = options;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// select</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Select</span> <span class="keyword">extends</span> <span class="title">Field</span> </span>&#123;</span><br><span class="line">  type = <span class="string">'select'</span>;</span><br><span class="line">  placeholder;</span><br><span class="line">  options;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(props)&#123;</span><br><span class="line">    <span class="keyword">super</span>(props);</span><br><span class="line">    <span class="keyword">const</span> &#123; options &#125; = props;</span><br><span class="line">    <span class="keyword">this</span>.placeholder = placeholder;</span><br><span class="line">    <span class="keyword">this</span>.options = options;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> Fields = &#123;</span><br><span class="line">  <span class="string">'input'</span>: Input,</span><br><span class="line">  <span class="string">'textarea'</span>: Textarea,</span><br><span class="line">  <span class="string">'radio'</span>: Radio,</span><br><span class="line">  <span class="string">'checkbox'</span>: Checkbox,</span><br><span class="line">  <span class="string">'select'</span>: Select,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">FieldProxy</span> </span>&#123;</span><br><span class="line">  field;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(props)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; type, ...others &#125; = props;</span><br><span class="line">    <span class="keyword">this</span>.field = <span class="keyword">new</span> Fields[type](others);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  setValue(value)&#123;</span><br><span class="line">    <span class="keyword">this</span>.field.setValue(value);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="js中的代理模式"><a href="#js中的代理模式" class="headerlink" title="js中的代理模式"></a>js中的代理模式</h2><h3 id="图片缓存"><a href="#图片缓存" class="headerlink" title="图片缓存"></a>图片缓存</h3><p>图片缓存的目的是在远程图片加载的时延过程中，预先以本地图片或占位符代替；在远程图片加载完成之后，再使用 img 节点展示实际的图片。</p>
<p>备注：RealSubject 和 Proxy 使用相同的接口这种情况，在 js 中，可以在自调用匿名函数实现，实例属性可使用闭包缓存。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 实际加载图片</span></span><br><span class="line"><span class="keyword">const</span> loadImage = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">let</span> imgNode = <span class="built_in">document</span>.createElement(<span class="string">'img'</span>);</span><br><span class="line">  <span class="built_in">document</span>.body.appendChild(imgNode);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="keyword">function</span>(<span class="params">src</span>)</span>&#123;</span><br><span class="line">    imgNode.src = src;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;)();</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> handler = &#123;</span><br><span class="line">  apply: <span class="function"><span class="keyword">function</span>(<span class="params">target, thisBinding, args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> src = args[<span class="number">0</span>];</span><br><span class="line">    <span class="keyword">let</span> img = <span class="keyword">new</span> Image;</span><br><span class="line">    img.src = src;</span><br><span class="line">    img.onLoad = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      target(src);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    target(<span class="string">'local_image.gif'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 代理加载图片</span></span><br><span class="line"><span class="keyword">const</span> loadImageProxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(loadImage, handler);</span><br><span class="line"></span><br><span class="line">loadImageProxy(<span class="string">'remote_image.png'</span>);</span><br></pre></td></tr></table></figure>
<h3 id="惰性加载"><a href="#惰性加载" class="headerlink" title="惰性加载"></a>惰性加载</h3><p>跟代理图片类似，加载 js 脚本也会有一定的时延，这就会造成使用某个类库前，js 脚本还未加载完成，所使用的方法也是 undefined。这时，可使用虚拟代理模拟类库，缓存执行方法，等到 js 脚本加载完成之后，再使用缓存执行实际的方法。</p>
<p>曾探在《Javascript 设计模式与开发实践》一书中，以 minConsole 类库为例，按下 F2 键加载所需的 js 脚本，在此之前，使用代理。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> miniConsole = (<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">  <span class="keyword">let</span> cache = [];</span><br><span class="line">  <span class="keyword">let</span> handler = <span class="function"><span class="keyword">function</span>(<span class="params">e</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span> ( e.keyCode === <span class="number">113</span> )&#123;</span><br><span class="line">      <span class="keyword">let</span> script = <span class="built_in">document</span>.createElement(<span class="string">'script'</span>);</span><br><span class="line">      script.onLoad = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;<span class="comment">// 加载完成后，执行缓存的待执行函数</span></span><br><span class="line">        cache.forEach(<span class="function"><span class="params">fn</span> =&gt;</span> fn());</span><br><span class="line">      &#125;</span><br><span class="line">      script.src = <span class="string">'miniConsole.js'</span>;</span><br><span class="line">      <span class="built_in">document</span>.getElementByTagName(<span class="string">'head'</span>)[<span class="number">0</span>].appendChild(imgNode);</span><br><span class="line">      <span class="built_in">document</span>.body.removeEventListener(<span class="string">'keydown'</span>, handler);<span class="comment">// 单次加载</span></span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">document</span>.body.addEventListener(<span class="string">'keydown'</span>, handler, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 代理对象，缓存待执行函数</span></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    log(...args)&#123;</span><br><span class="line">      cache.push(miniConsole.bind(miniConsole, ...args));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)()</span><br></pre></td></tr></table></figure>
<h3 id="合并http请求"><a href="#合并http请求" class="headerlink" title="合并http请求"></a>合并http请求</h3><p>搜索组件每次改变值时都会调用远程接口，使用代理模式可延迟调用远程接口，以使交互请求不至频繁。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">doSearch</span>(<span class="params">content</span>)</span>&#123;</span><br><span class="line">  get(content);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> cache;</span><br><span class="line"><span class="keyword">let</span> timer = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> handler = &#123;</span><br><span class="line">  apply: <span class="function"><span class="keyword">function</span>(<span class="params">target, thisBinding, args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> content = args[<span class="number">0</span>];</span><br><span class="line">    cache = content;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ( timer ) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    timer = setTimeout(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">      doSearch(cache);</span><br><span class="line">      cache = <span class="literal">null</span>;</span><br><span class="line">      timer = <span class="literal">null</span>;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> doSearchProxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(doSearch, handler);</span><br></pre></td></tr></table></figure>
<h3 id="缓存代理"><a href="#缓存代理" class="headerlink" title="缓存代理"></a>缓存代理</h3><p>前端缓存代理包含：对于计算复杂的过程，在入参相同的情况下，可使用缓存的计算结果代替实际的执行计算；对于频繁的 ajax 调用，也可以使用缓存，避免远程调用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> cache;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">complexCompute</span>(<span class="params">...args</span>)</span>&#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> handler = &#123;</span><br><span class="line">  apply: <span class="function"><span class="keyword">function</span>(<span class="params">target, thisBinding, args</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">const</span> cacheKey = args.join(<span class="string">','</span>);</span><br><span class="line">    <span class="keyword">if</span> ( cache[cacheKey] ) <span class="keyword">return</span> cache[cacheKey];</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">const</span> result = complexCompute(...args);</span><br><span class="line">    cache[cacheKey] = result;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> complexComputeProxy = <span class="keyword">new</span> <span class="built_in">Proxy</span>(complexCompute, handler);</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>[设计模式:可复用面向对象软件的基础]<br>[Javascript 设计模式和开发实践 - 曾探]<br><a href="https://java-design-patterns.com/patterns/proxy/" target="_blank" rel="noopener">java-design-patterns: proxy</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/11/04/ant design/antd-Form 组件/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/11/04/ant design/antd-Form 组件/" itemprop="url">antd-Form 组件</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-11-04T00:00:00+08:00">2018-11-04</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/antd-组件库/" itemprop="url" rel="index"><span itemprop="name">antd 组件库</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/11/04/ant design/antd-Form 组件/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/11/04/ant design/antd-Form 组件/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>ant design 中的 Form 组件基于 rc-form 实现。本文第一部分将介绍 rc-form 库；第二部分再介绍 ant design 中的 Form 组件。</p>
<h2 id="rc-form"><a href="#rc-form" class="headerlink" title="rc-form"></a>rc-form</h2><p>常规收集表单数据并作校验，只需以 store 实时记录表单数据，校验后重绘表单。</p>
<p>在 rc-form 中，FieldsStore 用于存储表单数据及校验文案，并调用表单组件实例的 forceUpdate 方法强制重绘。FieldsStore 实例存储的实时数据包含字段的值 value、校验结果 errors、校验状态 validating、脏值标识 dirty（字段的值已作变更，但未作校验）、事件发生时字段值已作收集标识 touched（当触发事件为 onChange 时，touched 标识意味着数据已作变更。当然，字段的值也可以重新变作初始值，这时 touched 标识仍为真）。rc-form 使用 FieldsStore 实例的 fields[name] = { value, errors, validating, dirty, touched } 收集这些根据用户行为变动的值。</p>
<p>除了实时更新的数据以外，驱动校验需要校验规则、触发事件；字段的初始值（当字段的值还没存入 fields 中时，以初始值替代）；从 event 对象获取字段的值，也跟 dom 节点的类型相关，如 input, radio, checkbox 类型；注入到字段组件的值需要特定的转换处理；在某些场合下，存入 store 的表单数据需要经过特殊转换（antd 提供的案例是全选按钮）。rc-form 使用 FieldsStore 实例的 fieldsMeta[name] = { validate, initialValue, getValueFromEvent, valuePropName, getValueProps, normalize } 存储这些元数据。</p>
<p>FieldsStore 的意义仅止于缓存字段的元数据及值数据等，但并未关联到表单及字段组件。对于用户自定义表单组件，需要提供获取、更新及校验表单数据的方法，其次需要把校验文案注入到字段组件的外层容器中以便渲染。对于字段组件，校验规则等与字段组件强关联的配置项适合在引用字段组件时注入；同时，在字段组件的值变更的时候，需要收集该字段的值及完成校验，因此需要将特定的绑定函数注入到字段组件中。在 rc-form 中，BaseForm 用于实现这部分功能。</p>
<p>想要为用户自定义组件注入工具函数，可以使用 HOC 高阶组件将工具函数配置为自定义子组件的 props 形式实现。rc-form 中的 BaseForm 就是这样的高阶组件。BaseForm 以 props.form = { getFieldsValue, getFieldValue, getFieldInstance, setFieldsValue, setFields, setFieldsInitialValue, getFieldsError, getFieldError, isFieldValidating, isFieldsValidating, isFieldsTouched, isFieldTouched, validateFields, resetFields, getFieldProps, getFieldDecorator } 的形式为用户自定义表单组件注入操纵表单的工具函数集。特别的，getFieldProps 方法用于转换传入字段组件的 props 数据（包含特定的绑定函数），并收集字段组件的元数据。getFieldProps 用于装饰字段组件的 props，getFieldDecorator 直接装饰字段组件，以封装传入字段组件的 props.onChange 等方法。</p>
<p>以时序图的方式表达 rc-form 的工作流程为：<br><img src="/2018/11/04/ant%20design/antd-Form%20组件/rc-form时序图.png"></p>
<p>rc-form 的类图结构为：<br><img src="/2018/11/04/ant%20design/antd-Form%20组件/rc-form类图.png"></p>
<h3 id="FieldsStore"><a href="#FieldsStore" class="headerlink" title="FieldsStore"></a>FieldsStore</h3><p>FieldsStore 实例除用来存储表单的元数据及值数据等之外，还支持以 ‘.’, ‘[|]’ 分割定义字段名，便于在表单中编辑和收集嵌套结构的数据。rc-form 中嵌套字段名的实现，借助了 lodash 库提供的 set, get 方法，以及内部封装的一些工具函数，具体可以参见源码，这里不作详解。</p>
<p>实例属性和方法：</p>
<ol>
<li><p>fields = { [name]: { value, errors, validating, dirty, touched } } 属性，存储表单项的值、校验信息、校验状态、脏值标识等，可在初始化时设置，由 updateFields, setFields, getField 等提供交互接口。</p>
<ul>
<li>初始化 constructor(fields) 和 updateFields(fields) 方法执行阶段，只接受 Field 实例，为全量更新。</li>
<li>setFields(fields) 可混入新的字段，并更新字段的值，为部分更新。</li>
<li>resetFields(ns) 方法只输出空值，本身并不改变 fields 存储的数据。</li>
<li>getField(name) 获取 fields 中存储的数据并字段名。</li>
<li>getFieldMember(name, member) 方法基于 getField，用于辅助获取 fields[name] 的成员属性，如 isFieldValidating, isFieldTouched 方法。</li>
</ul>
</li>
<li><p>fieldsMeta = { [name] = { validate, hidden, getValueFromEvent, initialValue, valuePropName, getValueProps, normalize } } 属性，存储表单项的元数据，由 setFieldMeta(name, meta), getFieldMeta(name) 提供交互接口。</p>
<ul>
<li>setFieldsInitialValue(initialValues) 方法在 fieldsMeta 中混入初始值，且校验 fieldsMeta 数据在初始值之前创建。</li>
</ul>
</li>
<li><p>clearField(name) 方法用于清除 fieldsMeta, fields 中的数据。</p>
</li>
<li><p>辅助方法。</p>
<ul>
<li>getNestedFields(names, getter) 遍历剔除隐藏项后的字段名列表，使用 getter 作进一步处理，返回键值对。</li>
<li>getNestedField(name, getter) 遍历匹配的字段名列表，使用 getter 作进一步处理，返回键值对或数组。参数 name 可以是嵌套字段名的起始部分，即嵌套字段名中 ‘.’ 或 ‘[‘ 前的内容。</li>
<li>flattenRegisteredFields(fields) 将深度嵌套的数据结构转化以嵌套字段名为键的单层结构，同时，可校验传参字段是否已渲染。</li>
<li>isValidNestedFieldName 校验表单项的字段名不能使另一个字段名的成员。</li>
</ul>
</li>
<li><p>表单字段名获取。</p>
<ul>
<li>getValidFieldsName 剔除隐藏项后的字段名列表。</li>
<li>getAllFieldsName 全量字段名列表。</li>
<li>getValidFieldsFullName(maybePartialName) 获取所有以 maybePartialName 起始或完全等值的字段名，不包含隐藏项。</li>
</ul>
</li>
<li><p>表单数据赋值。</p>
<ul>
<li>setFieldsInitialValue(initialValues)，见上文。</li>
<li>setFields(fields)，见上文。</li>
</ul>
</li>
<li><p>表单数据获取。</p>
<ul>
<li>getFieldValuePropValue(fieldMeta) 根据 fieldMeta 以键值对输出字段的值（包含初始值），数据可由 fieldMeta.valuePropName 提供键或经 fieldMeta.getValueProps 转换，在 BaseForm 的 getFieldProps, getFieldDecorator 中使用。</li>
<li>getValueFromFields(name, fields) 从 fields 中获取字段的值 value（包含初始值）。</li>
<li>getFieldValue(name) 基于 getNestedField, getValueFromFields，获取匹配字段的值。</li>
<li>getFieldsValue(names) 基于 getNestedFields, getFieldValue 获取表单数据，不包含隐藏项。</li>
<li>getAllValues 根据 fieldsMeta 获取表单的全量数据，包含隐藏项。</li>
<li>getNotCollectedFields 剔除隐藏项后，获取 fields 尚未收集的字段数据。键值对形式，数据结构同 fields。</li>
<li>getNestedAllFields 剔除隐藏项后，获取 fields 中的字段数据。键值对形式，数据结构同 fields。</li>
</ul>
</li>
<li><p>错误信息获取。</p>
<ul>
<li>getFieldError(name) 基于 getNestedField, getFieldMember，获取校验文案。</li>
<li>getFieldsError(names) 基于 getNestedFields, getFieldError，获取校验文案。</li>
<li>isFieldValidating(name) 基于 getFieldMember，获取校验状态。</li>
<li>getFieldsError(names) 基于 getValidFieldsName, isFieldValidating，获取校验状态。</li>
<li>isFieldTouched(name) 基于 getFieldMember，获取 touched 状态。</li>
<li>isFieldsTouched(names) 基于 getValidFieldsName, isFieldTouched，获取 touched 状态。</li>
</ul>
</li>
</ol>
<h3 id="BaseForm"><a href="#BaseForm" class="headerlink" title="BaseForm"></a>BaseForm</h3><p>BaseForm 除了如上文指出的收集和校验表单数据以外，因在字段组件更新时，其实例化过程结束后，会调用两次 ref 引用函数，会导致通过 ref 引用设置的缓存数据丢失，BaseForm 提供 clearedFieldMetaCache 属性缓存待移除的字段数据（包含字段的元数据和实时更新数据，如值、校验文案等），便于在第二次执行 ref 引用的时候恢复 FieldsStore 实例中缓存的数据 field, fieldMeta。</p>
<ol>
<li><p>createBaseForm(option, mixins)，创建并返回装饰函数。如上文所说，装饰函数能为用户自定义表单组件提供 HOC 容器。参数 option 为 HOC 组件提供 validateMessages, onFieldsChange, onValuesChange, mapProps, mapPropsToFields, fieldNameProp, fieldMetaProp, fieldDataProp, formPropName, name 配置项，参数 mixins 为混入 HOC 组件的实例方法。</p>
</li>
<li><p>表单及字段组件生命周期相关。</p>
<ul>
<li>instances 属性缓存字段组件，cachedBind 属性缓存绑定函数，clearedFieldMetaCache 属性缓存待移除的字段数据，renderFields 属性缓存 getFieldProps 方法已执行标识，domFields 属性缓存字段组件的 dom 节点。</li>
<li>getInitialState 获取组件初始 state 阶段，调用 option.mapPropsToFields 以获得初始 fields（备注：在 componentWillReceiveProps 声明周期中，也将调用 option.mapPropsToFields 获取 fields，并使用 FieldsStore 实例的 updateFields 全量更新缓存数据），并创建 FieldsStore 实例；创建 instances, cachedBind, clearedFieldMetaCache, renderFields, domFields 缓存，并为 HOC 容器注入 getFieldsValue, getFieldValue, setFieldsInitialValue, getFieldsError, getFieldError, isFieldValidating, isFieldsValidating, isFieldsTouched, isFieldTouched 方法。</li>
<li>saveRef(name, _, component) 组件挂载、卸载、重绘阶段都会调用，根据参数 component 判断组件的渲染状态。要点是，重绘阶段会执行两次 ref 函数（移除在前，更新在后），getFieldProps 却只执行一次，这样就有可能会造成在移除过程中，缓存的 field, fieldMeta 数据丢失（同样在 ref 函数中清理缓存）。若 component 为空值，clearedFieldMetaCache[name] = { field, meta } 收集字段的元数据和表单数据，清除 FieldsStore 实例中的相关数据，清理 instances[name], cachedBind[name] 缓存；若 component 为组件实例，domFields[name] 缓存标记为真值，记录 instances[name] 字段组件实例，尝试使用 clearedFieldMetaCache 恢复 FieldsStore 实例中的相关数据。</li>
<li>recoverClearedField(name) 通过 clearedFieldMetaCache 缓存恢复 FieldsStore 实例存储的 fields, fieldsMeta 数据，完成后清除 clearedFieldMetaCache 缓存。</li>
<li>cleanUpUselessFields 根据 renderFields, domFields 缓存判断字段组件是否未作渲染，如未作渲染，调用 clearField 清理 fields, fieldsMeta 数据。在 HOC 容器的 componentDidMount, componentDidUpdate 生命周期执行。</li>
<li>clearField(name) 清除 FieldsStore 实例存储的 fields, fieldsMeta 数据，并删除 instances[name], cachedBind[name] 缓存。</li>
</ul>
</li>
<li><p>字段组件 props 处理及绑定函数。</p>
<ul>
<li>getFieldProps(name, usersFieldOption) 为 FieldsStore 实例收集元数据，如转换校验规则；并装饰字段组件的 props，如指定 ref 函数为 saveRef 实例方法、为字段组件实例绑定 onCollectValidate, onCollect 方法、元数据 fieldMeta 及表单数据 field。备注：getFieldProps 在字段组件实例化过程中执行，首先将清理 clearedFieldMetaCache 缓存，最后记录 renderFields 缓存，最终输出 props。</li>
<li>getFieldDecorator(name, fieldOption) 装饰字段组件，以获取字段组件实例的 ref 引用及 props，存储为 fieldMeta.ref, fieldMeta.originalProps，目的是在 BaseForm 内置的 saveRef 执行过程中调用字段组件的 ref 函数，以及以实例方法 onCollect, onCollectValidate 形式封装事件绑定方法；并写入初始值。</li>
<li>onCollect(name_, action, …args) 基于 onCollectCommon 方法，在事件触发时，实时更新 FieldsStore 实例存储的字段 field 数据。</li>
<li>onCollectValidate(name_, action, …args) 基于 onCollectCommon, validateFieldsInternal 方法，在事件触发时，实时校验字段。</li>
</ul>
</li>
<li><p>表单数据赋值和校验。</p>
<ul>
<li>setFields(maybeNestedFields, callback) 以参数 maybeNestedFields 部分更新 FieldsStore 实例中的 fileds 属性，并执行 option.onFieldsChange 方法，再调用 forceUpdate 重绘表单并执行回调。</li>
<li>setFieldsValue(changedValues, callback) 基于 setFields 方法，更新表单数据，并执行 option.onValuesChange 方法。若 changedValues 中相关的字段组件未作渲染，予以警告提示。</li>
<li>resetFields(ns) 基于 setFields 方法，重置表单数据，并清除相关 clearedFieldMetaCache 缓存。</li>
<li>validateFields(ns, opt, cb) 基于 validateFieldsInternal，校验表单数据。</li>
</ul>
</li>
<li><p>辅助方法。</p>
<ul>
<li>getCacheBind(name, action, fn) 以 cachedBind[name][action] = { fn, oriFn } 形式缓存 onCollect, onCollectValidate, saveRef 方法，便于以 name 值进行查找。</li>
<li>onCollectCommon(name, action, args) 在 action 事件触发时，调用自定义绑定函数 fieldMeta[action] 或 fieldMeta.originalProps[action]，通过 fieldMeta.getValueFromEvent 收集字段的值，并执行 option.onValuesChange 绑定函数，返回 { name, field, fieldMeta }。</li>
<li>getRules(fieldMeta, action) 获取匹配的校验规则。</li>
<li>validateFieldsInternal(fields, { fieldNames, action, options }, callback) 校验指定字段。可复用之前的校验结果，收集待校验的字段并予以校验，转化校验文案并执行 callback 回调。若异步校验期间字段的值发生改变，将得到校验已过期文案。在校验起始阶段，调用 setFields 记录校验中状态；校验结束阶段，调用 setFields 记录校验结果。</li>
<li>getFieldInstance(name)，获取字段组件实例。</li>
</ul>
</li>
</ol>
<p>相关源码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line">getFieldProps(name, usersFieldOption = &#123;&#125;) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!name) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'Must call `getFieldProps` with valid name string!'</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (process.env.NODE_ENV !== <span class="string">'production'</span>) &#123;</span><br><span class="line">    warning(</span><br><span class="line">      <span class="keyword">this</span>.fieldsStore.isValidNestedFieldName(name),</span><br><span class="line">      <span class="string">'One field name cannot be part of another, e.g. `a` and `a.b`.'</span></span><br><span class="line">    );</span><br><span class="line">    warning(</span><br><span class="line">      !(<span class="string">'exclusive'</span> <span class="keyword">in</span> usersFieldOption),</span><br><span class="line">      <span class="string">'`option.exclusive` of `getFieldProps`|`getFieldDecorator` had been remove.'</span></span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">delete</span> <span class="keyword">this</span>.clearedFieldMetaCache[name];</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> fieldOption = &#123;</span><br><span class="line">    name,</span><br><span class="line">    trigger: DEFAULT_TRIGGER,</span><br><span class="line">    valuePropName: <span class="string">'value'</span>,</span><br><span class="line">    validate: [],</span><br><span class="line">    ...usersFieldOption,</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> &#123;</span><br><span class="line">    rules,</span><br><span class="line">    trigger,</span><br><span class="line">    validateTrigger = trigger,</span><br><span class="line">    validate,</span><br><span class="line">  &#125; = fieldOption;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> fieldMeta = <span class="keyword">this</span>.fieldsStore.getFieldMeta(name);</span><br><span class="line">  <span class="keyword">if</span> (<span class="string">'initialValue'</span> <span class="keyword">in</span> fieldOption) &#123;</span><br><span class="line">    fieldMeta.initialValue = fieldOption.initialValue;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> inputProps = &#123;</span><br><span class="line">    ...this.fieldsStore.getFieldValuePropValue(fieldOption),</span><br><span class="line">    ref: <span class="keyword">this</span>.getCacheBind(name, <span class="string">`<span class="subst">$&#123;name&#125;</span>__ref`</span>, <span class="keyword">this</span>.saveRef),</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">if</span> (fieldNameProp) &#123;</span><br><span class="line">    inputProps[fieldNameProp] = formName ? <span class="string">`<span class="subst">$&#123;formName&#125;</span>_<span class="subst">$&#123;name&#125;</span>`</span> : name;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> validateRules = normalizeValidateRules(validate, rules, validateTrigger);</span><br><span class="line">  <span class="keyword">const</span> validateTriggers = getValidateTriggers(validateRules);</span><br><span class="line">  validateTriggers.forEach(<span class="function">(<span class="params">action</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (inputProps[action]) <span class="keyword">return</span>;</span><br><span class="line">    inputProps[action] = <span class="keyword">this</span>.getCacheBind(name, action, <span class="keyword">this</span>.onCollectValidate);</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// make sure that the value will be collect</span></span><br><span class="line">  <span class="keyword">if</span> (trigger &amp;&amp; validateTriggers.indexOf(trigger) === <span class="number">-1</span>) &#123;</span><br><span class="line">    inputProps[trigger] = <span class="keyword">this</span>.getCacheBind(name, trigger, <span class="keyword">this</span>.onCollect);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> meta = &#123;</span><br><span class="line">    ...fieldMeta,</span><br><span class="line">    ...fieldOption,</span><br><span class="line">    validate: validateRules,</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">this</span>.fieldsStore.setFieldMeta(name, meta);</span><br><span class="line">  <span class="keyword">if</span> (fieldMetaProp) &#123;</span><br><span class="line">    inputProps[fieldMetaProp] = meta;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fieldDataProp) &#123;</span><br><span class="line">    inputProps[fieldDataProp] = <span class="keyword">this</span>.fieldsStore.getField(name);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This field is rendered, record it</span></span><br><span class="line">  <span class="keyword">this</span>.renderFields[name] = <span class="literal">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> inputProps;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">saveRef(name, _, component) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!component) &#123;</span><br><span class="line">    <span class="comment">// after destroy, delete data</span></span><br><span class="line">    <span class="keyword">this</span>.clearedFieldMetaCache[name] = &#123;</span><br><span class="line">      field: <span class="keyword">this</span>.fieldsStore.getField(name),</span><br><span class="line">      meta: <span class="keyword">this</span>.fieldsStore.getFieldMeta(name),</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">this</span>.clearField(name);</span><br><span class="line">    <span class="keyword">delete</span> <span class="keyword">this</span>.domFields[name];</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.domFields[name] = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">this</span>.recoverClearedField(name);</span><br><span class="line">  <span class="keyword">const</span> fieldMeta = <span class="keyword">this</span>.fieldsStore.getFieldMeta(name);</span><br><span class="line">  <span class="keyword">if</span> (fieldMeta) &#123;</span><br><span class="line">    <span class="keyword">const</span> ref = fieldMeta.ref;</span><br><span class="line">    <span class="keyword">if</span> (ref) &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> ref === <span class="string">'string'</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">`can not set ref string for <span class="subst">$&#123;name&#125;</span>`</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      ref(component);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.instances[name] = component;</span><br><span class="line">&#125;,</span><br><span class="line"></span><br><span class="line">recoverClearedField(name) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="keyword">this</span>.clearedFieldMetaCache[name]) &#123;</span><br><span class="line">    <span class="keyword">this</span>.fieldsStore.setFields(&#123;</span><br><span class="line">      [name]: <span class="keyword">this</span>.clearedFieldMetaCache[name].field,</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="keyword">this</span>.fieldsStore.setFieldMeta(name, <span class="keyword">this</span>.clearedFieldMetaCache[name].meta);</span><br><span class="line">    <span class="keyword">delete</span> <span class="keyword">this</span>.clearedFieldMetaCache[name];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><ol>
<li><p>createForm(options) 基于 createBaseForm，为 HOC 组件注入默认的 getForm 方法，将 form 通过 props 注入到用户自定义表单组件中，以提供操纵表单的函数。</p>
</li>
<li><p>createDOMForm(option) 基于 createBaseForm，在传递给用户自定义表单组件的 props.form 混入 validateFieldsAndScroll 方法，校验失败时滚动到首个错误字段处。该方法引用了 react-dom，只适用于浏览器平台，不适用于手机端。</p>
<ul>
<li>validateFieldsAndScroll(ns, opt, cb) 基于 dom-scroll-into-view 库实现，首先通过 getBoundingClientRect 获得校验失败字段的 top 值，其次通过 getComputedStyle 或 style 属性获得字段节点首个滚动的父元素，最后调用 dom-scroll-into-view 库提供的 api 滚动页面。</li>
</ul>
</li>
<li><p>FormScope 以组件形式提供接口。option 配置项通过 props 传入，在 render 阶段调用 createDOMForm，并将 form 传入函数组件 children 中。</p>
</li>
<li><p>createFormField 生成 Field 实例。</p>
</li>
</ol>
<h2 id="antd-Form-组件"><a href="#antd-Form-组件" class="headerlink" title="antd-Form 组件"></a>antd-Form 组件</h2><h3 id="Form-组件"><a href="#Form-组件" class="headerlink" title="Form 组件"></a>Form 组件</h3><p>Form 组件本身并不承载逻辑，而是通过 props.className, props.prefixCls, props.layout, props.hideRequiredMark, props.onSubmit 设定注入 form 原生节点的类及绑定函数，以影响表单内部节点渲染时的样式。同时，Form 组件将为子组件传入 context.vertical。</p>
<p>Form 组件拥有 Item 静态属性指向 FormItem 组件；createFormField 静态方法指向 rc-form 提供的同名方法；createForm 静态方法调用 rc-form 提供的 createBaseForm 方法，用于装饰用户自定义表单组件。</p>
<h3 id="FormItem-组件"><a href="#FormItem-组件" class="headerlink" title="FormItem 组件"></a>FormItem 组件</h3><p>FormItem 组件用于设定表单项的布局，包含必填标记 requiredMark, 字段名 label, 校验文案 help, 额外内容 extra。实时的校验文案注入到 FormItem 组件中，并不是通过外层容器将相关 props, context 注入到 FormItem 组件中实现的，而是通过 FormItem 收集内部字段组件实例的 props 属性实现的。getFieldProp 方法执行阶段，字段的元数据 filedMeta 和实时数据 field 都将作为特殊的 props 属性传入到字段组件中，因此，FormItem 作为字段组件的容器，可以通过这些特殊的 props 属性判断子组件实例是不是一个字段组件的实例，并进一步收集实时的校验文案、校验状态和必填标记。同时，在这样的机制下，FormItem 只能包裹单个字段组件，而不能包裹多个字段组件。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取字段组件实例</span></span><br><span class="line">getControls(children: React.ReactNode, <span class="attr">recursively</span>: boolean) &#123;</span><br><span class="line">  <span class="keyword">let</span> controls: React.ReactElement&lt;any&gt;[] = [];</span><br><span class="line">  <span class="keyword">const</span> childrenArray = React.Children.toArray(children);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; childrenArray.length; i++) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!recursively &amp;&amp; controls.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> child = childrenArray[i] <span class="keyword">as</span> React.ReactElement&lt;any&gt;;</span><br><span class="line">    <span class="keyword">if</span> (child.type &amp;&amp;</span><br><span class="line">      (child.type <span class="keyword">as</span> any === FormItem || (child.type <span class="keyword">as</span> any).displayName === <span class="string">'FormItem'</span>)) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!child.props) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (FIELD_META_PROP <span class="keyword">in</span> child.props) &#123; <span class="comment">// And means FIELD_DATA_PROP in child.props, too.</span></span><br><span class="line">      controls.push(child);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (child.props.children) &#123;</span><br><span class="line">      controls = controls.concat(<span class="keyword">this</span>.getControls(child.props.children, recursively));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> controls;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获取到字段的实时校验数据和元数据后，绘制校验文案、反馈图标、按校验状态设定样式就能水到渠成地加以实现了。其余使用 Row, Col 组件、props.labelCol, props.wrapperCol 属性栅格化布局 label, field；在 label 元素上绑定聚焦函数，也是极为常规的处理手法，这里不作介绍。</p>
<p>当然，如果想在 FormItem 中渲染多个字段，就要放弃自动获得校验状态、校验文案的功能，而是通过 props.help, props.validateStatus, props.required, props.id（影响点击 label 时聚焦哪个字段元素） 主动注入，自建 store 存储这些实时数据。</p>
<p>以上就是 ant-desing 中 Form 组件的实现，如有纰漏或行文、思考路线上的问题，仍望海涵。</p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/10/react/react相关/react-jsonschema-form源码分析/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/10/react/react相关/react-jsonschema-form源码分析/" itemprop="url">react-jsonschema-form源码分析</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-10T00:00:00+08:00">2018-10-10</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/类库/" itemprop="url" rel="index"><span itemprop="name">类库</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/10/10/react/react相关/react-jsonschema-form源码分析/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/10/10/react/react相关/react-jsonschema-form源码分析/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            
          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/10/09/es6/Reflect, Proxy/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/10/09/es6/Reflect, Proxy/" itemprop="url">Reflect, Proxy</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-10-09T00:00:00+08:00">2018-10-09</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/es6/" itemprop="url" rel="index"><span itemprop="name">es6</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/10/09/es6/Reflect, Proxy/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/10/09/es6/Reflect, Proxy/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="Reflect"><a href="#Reflect" class="headerlink" title="Reflect"></a>Reflect</h2><p>ES6 提供的 API，集成语言层面的对象操作（操作与 Proxy 一一对应，且为函数形式）。</p>
<ul>
<li>Reflect.get(target, name, receiver): 获取属性。</li>
<li>Reflect.set(target, name, value, receiver): 对属性赋值。</li>
<li>Reflect.defineProperty(target, name, desc): 修改属性的描述符。</li>
<li>Reflect.deleteProperty(target, name): 删除属性。</li>
<li>Reflect.has(target, name): propKey in proxy 判断。</li>
<li>Reflect.ownKeys(target): 返回对象的自有属性。</li>
<li>Reflect.enumerate(target): 以迭代器形式获取对象的可枚举属性。</li>
<li>Reflect.isExtensible(target): 判断对象是否可扩展。</li>
<li>Reflect.preventExtensions(target): 使对象不可扩展。</li>
<li>Reflect.getOwnPropertyDescriptor(target, name): 获取属性的描述符。</li>
<li>Reflect.getPrototypeOf(target): 获取对象的 <strong>proto</strong> 属性。</li>
<li>Reflect.setPrototypeOf(target, prototype): 设置对象的原型。</li>
<li>Reflect.apply(target, thisArg, args): 以 thisArg 为上下文执行 target 函数。</li>
<li>Reflect.construct(target, args): 创建 target 实例。</li>
</ul>
<h2 id="Proxy"><a href="#Proxy" class="headerlink" title="Proxy"></a>Proxy</h2><p>Proxy 在语言层面，拦截针对对象的操作。ES6 原生提供 Proxy 构造函数，用来生成 Proxy 实例。</p>
<p>使用 let proxy = new Proxy(target, handler); 创建 Proxy 实例。参数 target 可以是对象，也可以是函数。handler 为设定拦截操作的集合。操作 proxy，将同时影响 target。</p>
<p>Proxy.revocable 方法返回一个可取消的 Proxy 实例。返回值中，proxy 属性即为 Proxy 实例，revoke 方法用于取消 Proxy 实例。</p>
<p>在 Proxy 代理的情况下，目标对象内的 this 关键字将指向 Proxy 实例。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> proto = <span class="keyword">new</span> <span class="built_in">Proxy</span>(&#123;&#125;, &#123;</span><br><span class="line">  get(target, propertyKey, receiver) &#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">'GET '</span> + propertyKey);</span><br><span class="line">    <span class="keyword">return</span> target[propertyKey];</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> obj = <span class="built_in">Object</span>.create(proto);</span><br><span class="line">obj.foo <span class="comment">// "GET foo"</span></span><br></pre></td></tr></table></figure>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> target = &#123;&#125;;</span><br><span class="line"><span class="keyword">let</span> handler = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">let</span> &#123;proxy, revoke&#125; = <span class="built_in">Proxy</span>.revocable(target, handler);</span><br><span class="line"></span><br><span class="line">proxy.foo = <span class="number">123</span>;</span><br><span class="line">proxy.foo <span class="comment">// 123</span></span><br><span class="line"></span><br><span class="line">revoke();</span><br><span class="line">proxy.foo <span class="comment">// TypeError: Revoked</span></span><br></pre></td></tr></table></figure>
<p>可拦截的操作包含：</p>
<ul>
<li>get(target, propKey, receiver): 拦截对象属性的读取。参数 reveiver 为操作行为所针对的对象，通常是 proxy 实例。</li>
<li>set(target, propKey, value): 拦截对象属性的设置，返回布尔值。</li>
<li>has(target, propKey): 拦截 propKey in proxy 操作，返回布尔值。</li>
<li>delete(target, propKey): 拦截 delete proxy[propKey] 的操作，返回布尔值。</li>
<li>ownKeys(target): 拦截 Object.getOwnPropertyNames(proxy)、Object.getOwnPropertySymbols(proxy)、Object.keys(proxy)、for…in 循环，返回目标对象自身所有的属性，Object.keys() 返回仅包括目标对象自身的可遍历属性。</li>
<li>getOwnPropertyDescriptor(target, propKey): 拦截 Object.getOwnPropertyDescriptor(proxy, propKey)，返回属性的描述对象。</li>
<li>defineProperty(target, propKey, propDesc): 拦截 Object.defineProperty(proxy, propKey, propDesc）、Object.defineProperties(proxy, propDescs)，返回布尔值。</li>
<li>preventExtensions(target): 拦截 Object.preventExtensions(proxy)，返回布尔值。</li>
<li>getPrototypeOf(target): 拦截 Object.getPrototypeOf(proxy)，返回对象。</li>
<li>isExtensible(target): 拦截 Object.isExtensible(proxy)，返回布尔值。</li>
<li>setPrototypeOf(target, proto): 拦截 Object.setPrototypeOf(proxy, proto)，返回布尔值。</li>
<li>apply(target, object, args): 拦截 Proxy 实例作为函数调用的操作，比如 proxy(…args)、proxy.call(object, …args)、proxy.apply(…)。</li>
<li>construct(target, args): 拦截 Proxy 实例作为构造函数调用的操作，比如 new proxy(…args)。</li>
</ul>
<h2 id="harmony-reflect"><a href="#harmony-reflect" class="headerlink" title="harmony-reflect"></a>harmony-reflect</h2><p>作为垫片，提供 Reflect 全局对象，扩展 Object 及 Proxy。</p>
<h3 id="Reflect-1"><a href="#Reflect-1" class="headerlink" title="Reflect"></a>Reflect</h3><p>扩展或提供平台提供的 Reflect 对象。</p>
<ul>
<li>Reflect.get(target, name, receiver) 方法实现: 首先，若 target 为 Proxy 实例，获取并调用 handler.get 方法；其次，若 target 不是 Proxy 实例，通过 Object.getOwnPropertyDescriptor 获取属性描述符，若属性描述符为 undefined，尝试通过 Object.getPrototypeOf 方法获取原型的 name 属性；其次，若属性描述符不是 undefined，尝试获取属性描述符中的 value 属性或执行 get 方法。</li>
<li>Reflect.set(target, name, value, receiver) 方法: 首先，若 target 为 Proxy 实例，获取并调用 handler.set 方法；其次，若 target 不是 Proxy 实例，通过 Object.getOwnPropertyDescriptor 获取属性描述符，若属性描述符为 undefined，尝试通过 Object.getPrototypeOf 方法调用原型的 set 方法；其次，若属性描述符不是 undefined，且访问器属性 set 为真值，尝试以 receiver 为上下文调用属性描述符中的 set 方法；其次，通过 Object.getOwnPropertyDescriptor 获取 receiver 对象的属性描述符，若属性描述符为 undefined，调用 Object.defineProperty 重新设置属性描述符，更新 value 值；其次，若 receiver 对象的属性描述符不是 undefined，校验 receiver 是否可扩展，若可扩展，调用 Object.defineProperty 重新设置属性描述符。</li>
<li>Reflect.defineProperty(target, name, desc) 方法: 首先，若 target 为 Proxy 实例，获取并调用 handler.defineProperty 方法；其次，若 target 不是 Proxy 实例，通过 Object.getOwnPropertyDescriptor 获取当前的属性描述符，当属性描述符的 configurable 属性为 false 时，运行原有的 Object.defineProperty 将报错，实现上将引起报错的情形全部以 return false 形式剔除，随后再调用 Object.defineProperty，重新设定属性描述符。</li>
<li>Reflect.deleteProperty(target, name) 方法: 首先，若 target 为 Proxy 实例，获取并调用 handler.deleteProperty 方法；其次，通过 Object.getOwnPropertyDescriptor 获取当前的属性描述符并判断其 configurable 属性，若属性为真，调用 delete target[name] 语句，否则返回 false。</li>
<li>Reflect.has(target, name) 方法: 执行 name in target 语句。</li>
<li>Reflect.ownKeys(target) 方法: 首先，若 target 为 Proxy 实例，获取并调用 handler.ownKeys 方法；其次，调用 Object.getOwnPropertyNames 方法。</li>
<li>Reflect.enumerate(target) 方法: 首先，若 target 为 Proxy 实例，获取并调用 handler.enumerate 方法；其次，通过 for…in 语句获取目标的可枚举属性集合，以迭代器形式输出。</li>
<li>Reflect.isExtensible(target) 方法: 直接调用 Object.isExtensible 方法。</li>
<li>Reflect.preventExtensions(target) 方法: 首先，若 target 为 Proxy 实例，获取并调用 handler.preventExtensions 方法；其次，调用 Object.preventExtensions 方法。</li>
<li>Reflect.getOwnPropertyDescriptor(target, name) 方法: 直接调用 Object.getOwnPropertyDescriptor 方法。</li>
<li>Reflect.getPrototypeOf(target) 方法: 直接调用 Object.getPrototypeOf 方法。</li>
<li>Reflect.setPrototypeOf(target, prototype): 首先，若 target 为 Proxy 实例，获取并调用 handler.setPrototypeOf 方法；其次，判断目标的可扩展性，若其可扩展，以 try-catch 语句执行 Object.setPrototypeOf 方法，以捕获错误。</li>
<li>Reflect.apply(target, thisArg, args): 调用 Function.prototype.apply.call(target, thisArg, args)。</li>
<li>Reflect.construct(target, args, newTarget): 首先，若 target 为 Proxy 实例，获取并调用 handler.construct 方法；其次，在 newTarget 为 undefined 或与 target 等值的基础上，基于 target 并以 null 为上下文生成构造函数；否则，Object.create(newTarget.prototype) 为上文生成构造函数。</li>
</ul>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> <span class="built_in">Reflect</span> = &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  enumerate: <span class="function"><span class="keyword">function</span>(<span class="params">target</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> handler = directProxies.get(target);</span><br><span class="line">    <span class="keyword">var</span> result;</span><br><span class="line">    <span class="keyword">if</span> (handler !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      result = handler.enumerate(handler.target);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      result = [];</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">var</span> name <span class="keyword">in</span> target) &#123; result.push(name); &#125;;      </span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">var</span> l = +result.length;</span><br><span class="line">    <span class="keyword">var</span> idx = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      next: <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (idx === l) <span class="keyword">return</span> &#123; <span class="attr">done</span>: <span class="literal">true</span> &#125;;</span><br><span class="line">        <span class="keyword">return</span> &#123; <span class="attr">done</span>: <span class="literal">false</span>, <span class="attr">value</span>: result[idx++] &#125;;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  construct: <span class="function"><span class="keyword">function</span>(<span class="params">target, args, newTarget</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> handler = directProxies.get(target);</span><br><span class="line">    <span class="keyword">if</span> (handler !== <span class="literal">undefined</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> handler.construct(handler.target, args, newTarget);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> target !== <span class="string">"function"</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">"target is not a function: "</span> + target);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (newTarget === <span class="literal">undefined</span> || newTarget === target) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> (<span class="built_in">Function</span>.prototype.bind.apply(target, [<span class="literal">null</span>].concat(args)));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">typeof</span> newTarget !== <span class="string">"function"</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">TypeError</span>(<span class="string">"newTarget is not a function: "</span> + target);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">var</span> proto = newTarget.prototype;</span><br><span class="line">      <span class="keyword">var</span> instance = (<span class="built_in">Object</span>(proto) === proto) ? <span class="built_in">Object</span>.create(proto) : &#123;&#125;;</span><br><span class="line">      <span class="keyword">var</span> result = <span class="built_in">Function</span>.prototype.apply.call(target, instance, args);</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Object</span>(result) === result ? result : instance;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="proxy"><a href="#proxy" class="headerlink" title="proxy"></a>proxy</h3><p>构建 const vHandler = function Validator(target, handler){} 构造函数，用于对象操作并作校验。当平台提供 Proxy api 时，vHandler 将作为 Proxy.create, Proxy.createFunction 的参数，以改写 global.Proxy(target, handler) 构造函数。生成的 proxy 实例将以 { [proxy]: vHandler } 的形式存入 WeakMap 实例 directProxies 中，用于使 Object 的部分原型方法先作代理处理，再作常规处理。</p>
<p>Validator 实例方法（proxy 为 new Proxy(target, handler) 实例）：</p>
<ul>
<li>proxy.get(receiver, propKey, receiver): 若没有设置 handler.get，调用 Reflect.get 方法；若设置，以 handler 为上下文调用 handler.get，并校验 target[propKey] 的 configurable, writable, get 属性或方法，特定条件下作报错处理。</li>
<li>proxy.set(receiver, propKey, value): 若没有设置 handler.set，调用 Reflect.set 方法；若设置，以 handler 为上下文调用 handler.set，并校验 target[propKey] 的 configurable, writable, get 属性或方法，特定条件下作报错处理。</li>
<li>proxy.has(propKey): 若没有设置 handler.has，调用 Reflect.has 方法；若设置，以 handler 为上下文调用 handler.has，当返回结果为 false 时，并校验 target[propKey] 的 configurable 属性, 及可扩展性，特定条件下作报错处理。</li>
<li>proxy.delete(propKey): 若没有设置 handler.deleteProperty，调用 Reflect.deleteProperty 方法；若设置，以 handler 为上下文调用 handler.deleteProperty，校验 target[propKey] 的可扩展性，特定条件下作报错处理。</li>
<li>proxy.ownKeys(): 若没有设置 handler.ownKeys，调用 Reflect.ownKeys 方法；若设置，以 handler 为上下文调用 handler.ownKeys，并校验 target 各属性的可扩展性，特定条件下作报错处理。</li>
<li>proxy.enumate(), proxy.iterate(): 若没有设置 handler.enumate，调用 Reflect.enumate 方法；若设置，以 handler 为上下文调用 handler.enumate，并校验 target 各属性的可扩展性，特定条件下作报错处理。返回迭代器。</li>
<li>proxy.getPropertyDescriptor(propKey): 若 proxy.has 返回否值，返回 undefined；否则以包装 proxy.set, proxy.get 形式返回属性描述符，且 enumerable, configurable 属性均为真值。</li>
<li>proxy.getOwnPropertyDescriptor(propKey): 若没有设置 handler.getOwnPropertyDescriptor，调用 Reflect.getOwnPropertyDescriptor 方法；若设置，以 handler 为上下文调用 handler.getOwnPropertyDescriptor，校验 target[propKey] 的可扩展性，特定条件下作报错处理。</li>
<li>proxy.defineProperty(propKey, propDesc): 若没有设置 handler.defineProperty，调用 Reflect.defineProperty 方法；若设置，以 handler 为上下文调用 handler.defineProperty，并校验 target[propKey] 的可扩展性，特定条件下作报错处理。</li>
<li>proxy.preventExtensions(): 若没有设置 handler.preventExtensions，调用 Reflect.preventExtensions 方法；若设置，以 handler 为上下文调用 handler.preventExtensions，并校验 target[propKey] 的可扩展性，特定条件下作报错处理。</li>
<li>proxy.getPrototypeOf(): 若没有设置 handler.getPrototypeOf，调用 Reflect.getPrototypeOf 方法；若设置，以 handler 为上下文调用 handler.getPrototypeOf，并校验 target[propKey] 的可扩展性，特定条件下作报错处理。</li>
<li>proxy.isExtensible(): 若没有设置 handler.isExtensible，调用 Reflect.isExtensible 方法；若设置，以 handler 为上下文调用 handler.isExtensible，并校验 target[propKey] 的可扩展性，特定条件下作报错处理。</li>
<li>proxy.setPrototypeOf(proto): 若没有设置 handler.setPrototypeOf，调用 Reflect.setPrototypeOf 方法；若设置，以 handler 为上下文调用 handler.setPrototypeOf，并校验 target[propKey] 的可扩展性，特定条件下作报错处理。</li>
<li>proxy.apply(target, thisBinding, args): 若没有设置 handler.apply，调用 Reflect.apply 方法；若设置，以 handler 为上下文调用 handler.apply。</li>
<li>proxy.construct(target, args, newTarget): 若没有设置 handler.construct，调用 Reflect.construct 方法；若设置，以 handler 为上下文调用 handler.construct。</li>
</ul>
<h3 id="Object-扩展"><a href="#Object-扩展" class="headerlink" title="Object 扩展"></a>Object 扩展</h3><ul>
<li>Object.preventExtensions(subject): 若 subject 为代理实例，从 directProxies 中获取代理对象的 vHandler，并调用代理对象的 preventExtensions 方法；其次尝试调用 Object.preventExtensions 原始方法。</li>
<li>Object.seal(subject): 密封对象，可改变现有属性，即将所有属性描述符的 configurable 置为否。</li>
<li>Object.freeze(subject): 冻结对象，即将所有属性描述符的 configurable, writable 置为否（访问器属性的状况下仅需处理 configurable 属性）。</li>
<li>Object.isExtensible(subject): 若 subject 为代理实例，从 directProxies 中获取代理对象的 vHandler，并调用代理对象的 isExtensible 方法；其次尝试调用 Object.isExtensible 原始方法。</li>
<li>Object.isSealed(subject): 判断是否密封。</li>
<li>Object.isFrozen(subject): 判断是否冻结。</li>
<li>Object.getOwnPropertyDescriptor(subject, name): 若 subject 为代理实例，从 directProxies 中获取代理对象的 vHandler，并调用代理对象的 getOwnPropertyDescriptor 方法；其次尝试调用 Object.getOwnPropertyDescriptor 原始方法。</li>
<li>Object.defineProperty(subject, name, desc): 若 subject 为代理实例，从 directProxies 中获取代理对象的 vHandler，并调用代理对象的 defineProperty 方法；其次尝试调用 Object.defineProperty 原始方法。</li>
<li>Object.defineProperties(subject, descs): 若 subject 为代理实例，从 directProxies 中获取代理对象的 vHandler，针对属性逐个调用代理对象的 defineProperty 方法；其次尝试调用 Object.defineProperties 原始方法。</li>
<li>Object.keys(subject): 若 subject 为代理实例，从 directProxies 中获取代理对象的 vHandler，并调用代理对象的 ownKeys 方法，剔除其中的不可枚举项；其次尝试调用 Object.keys 原始方法。</li>
<li>Object.getOwnPropertyNames(subject): 若 subject 为代理实例，从 directProxies 中获取代理对象的 vHandler，并调用代理对象的 ownKeys 方法；其次尝试调用 Object.getOwnPropertyNames 原始方法。</li>
<li>Object.getOwnPropertySymbols(subject): 平台提供 Object.getOwnPropertySymbols 原始方法的基础下封装。若 subject 为代理实例，从 directProxies 中获取代理对象的 vHandler，返回空数组；其次尝试调用 Object.getOwnPropertySymbols 原始方法。</li>
<li>Object.assign(target, …source): 平台提供 Object.assign 原始方法的基础下封装。若各参数均为代理对象，直接调用 Object.assign 原始方法；否则，遍历属性以拷贝。</li>
<li>Object.setPrototypeOf(target, proto): 若 target 为代理实例，从 directProxies 中获取代理对象的 vHandler，并调用代理对象的 setPrototypeOf 方法；其次尝试调用 Object.setPrototypeOf 原始方法；其次通过 Object.defineProperty 设置target 的 <strong>proto</strong> 属性。</li>
<li>Object.prototype.isPrototypeOf(arg): 若 arg 为代理实例，通过 vHandler.getPrototypeOf 方法向上逐层获取 arg 的原型，原型同 this 作等值比较；否则直接调用 Object.prototype.isPrototypeOf 作判断。</li>
<li>Object.prototype.valueOf(): 若 this 为代理实例，从 directProxies 中获取代理对象的 target，以 target 作为上下文执行 Object.prototype.valueOf；否则，直接执行 Object.prototype.valueOf。</li>
<li>Object.prototype.toString(): 若 this 为代理实例，从 directProxies 中获取代理对象的 target，以 target 作为上下文执行 Object.prototype.toString；否则，直接执行 Object.prototype.toString。</li>
<li>Function.prototype.toString(): 若 this 为代理实例，从 directProxies 中获取代理对象的 target，以 target 作为上下文执行 Function.prototype.toString；否则，直接执行 Function.prototype.toString。</li>
<li>Date.prototype.toString(): 若 this 为代理实例，从 directProxies 中获取代理对象的 target，以 target 作为上下文执行 Date.prototype.toString；否则，直接执行 Date.prototype.toString。</li>
<li>Object.prototype.hasOwnProperty(propKey): 若 this 为代理实例，从 directProxies 中获取代理对象的 vHandler，调动 vHandler.getOwnPropertyDescriptor，并判断返回值是否为 undefined；否则，直接执行 Object.prototype.hasOwnProperty。</li>
<li>Array.isArray(subject): 若 subject 为代理实例，从 directProxies 中获取代理对象的 target，并调用 Array.isArray 原始方法判断 target 是否为数组；其次尝试调用 Array.isArray 原始方法。</li>
<li>Array.prototype.concat(…args): 使用 Array.prototype.slice 方法将 args 数组项中的代理实例数组拆解为普通数组，随后使用 Array.prototype.concat 原始方法拼接数组。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/09/11/工程化/前端构建工具dawn/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/09/11/工程化/前端构建工具dawn/" itemprop="url">前端构建工具 dawn 不完全解密</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-09-11T00:00:00+08:00">2018-09-11</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/前端工程化/" itemprop="url" rel="index"><span itemprop="name">前端工程化</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/09/11/工程化/前端构建工具dawn/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/09/11/工程化/前端构建工具dawn/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="实现原理"><a href="#实现原理" class="headerlink" title="实现原理"></a>实现原理</h2><p>dawn 是一个采用中间件技术实现的轻量的任务流协调器，它和 gulp, grunt 有异曲同工之妙。dawn 本身并不处理任务，转而交由中间件承担这一职能，如同 gulp, grunt 插件。在实现上，dawn 是 webpack 出台后的产物，就不需要像 gulp, grunt 那样关注任务流的始点 —— 文件位置，而更容易聚焦于任务的分解，将编译、压缩作业交给 dn-middleware-webpack 中间件。若说 gulp 中的任务流是鱼跃似的，一个跟着另一个，那么，dawn 通过 ctx 上下文使得两个任务之间可以借助事件或实例属性进行通信。dawn 的中间件实现机制如同 koa，其一使用 next 引用下一个中间件串联任务流，其二以继承事件模型的 ctx 实例作为上下文。其核心代码如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Context</span> <span class="keyword">extends</span> <span class="title">EventEmitter</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> _execQueue(middlewares, args, onFail) &#123;</span><br><span class="line">    <span class="keyword">const</span> middleware = middlewares.shift();</span><br><span class="line">    <span class="keyword">if</span> (!middleware) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// this.load 安装中间件，并执行中间件的外层函数，获得实际的任务逻辑 handler</span></span><br><span class="line">    <span class="keyword">const</span> handler = <span class="keyword">await</span> <span class="keyword">this</span>.load(middleware);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> next = <span class="function">(<span class="params">args</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="comment">// 若返回真值，在 watch 状态下，也只执行一次</span></span><br><span class="line">      <span class="keyword">if</span> (next.__result) <span class="keyword">return</span> next.__result;</span><br><span class="line"></span><br><span class="line">      next.__result = <span class="keyword">this</span>._execQueue(middlewares, args, onFail)</span><br><span class="line">        .catch(<span class="function"><span class="params">err</span> =&gt;</span> onFail(err));</span><br><span class="line">      <span class="keyword">return</span> next.__result;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">return</span> handler.call(<span class="keyword">this</span>, next, <span class="keyword">this</span>, args);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为 dawn 是一个任务流协调器，使得它就像一架航母，其能力仰赖于战斗机群 —— 由丰富的中间件、模板构成的生态系统。第一，这样使得 dawn 更着眼于为开发团队提供服务（两者呈互为因果的关系）。dawn 内建了复合远程配置的功能。不少公司会有私有的 npm 仓库，开发的 dn 中间件、模板先期都会在这些私有仓库中发展成形。借助于 dn config registry <a href="http://your_server_url" target="_blank" rel="noopener">http://your_server_url</a> 命令，dawn 安装中间件时会从这些私有仓库中拉取中间件或模板。对于配置文件，借助于 dn config server <a href="http://your_server_url" target="_blank" rel="noopener">http://your_server_url</a> 命令，dawn 也会从私有服务器中拉取远程配置，并与本地配置合并。如此，既能保有模板的闭源特征，又能实现配置文件的复用。扯开一个话题，使用 .yml 文件配置选项、将配置文件存于远端，这和我稍有耳闻的 spring boot 项目有些相仿。</p>
<p>第二，为了开发中间件的方便，ctx 必然需要提供大而全的功能。以下简要地展示 ctx 提供的 api 列表：</p>
<ul>
<li>cli: 命令行 Command 实例。</li>
<li>command: 当前执行的命令，如 init, dev, build 等。</li>
<li>pipeline: 当前命令实际所用中间件列表。</li>
<li>cwd: 项目路径。</li>
<li>project: 项目 package.json 文件内容。</li>
<li>middlewareMgr: 中间件管理器，用于查询私有中心的中间件列表，或者安装中间件。</li>
<li>templateMgr: 模板管理器，用于查询私有中心的模板列表，或者文件重命名，或者下载模板。</li>
<li>conf: rc配置管理器，用于获取本地或远程 rc 配置，或者设置 rc 配置，默认获取 .dawnrc 文件。</li>
<li>console: 命令行编辑器 console。</li>
<li>inquirer, utils.inquirer : 命令行交互接口，即 inquirer 类库。</li>
<li>utils.exec(script, opts): 执行 script 命令，返回 promise；utils.exec.withResult(script, opts) 等待并返回执行结果。</li>
<li>utils.writeFile(filename, content): 写文件，返回 promise。</li>
<li>utils.readFile(filename): 读文件，返回 promise。</li>
<li>utils.del: 删除文件，返回 promise。</li>
<li>utils.mkdirp: 创建目录，返回 promise。</li>
<li>download: fetch 响应。</li>
<li>sleep: 延时执行。</li>
<li>prompt: 使用 inquirer.prompt 在命令行编辑器创建引导式交互界面。</li>
<li>utils.mod: 模块管理器，用于执行 npm 命令，或者安装依赖，或者下载模板（缓存在计算机的特定位置），或者获取 npm 包信息。</li>
<li>utils.open: 打开浏览器，即 react-dev-utils/openBrowser 模块。</li>
<li>utils.oneport: 获取一个空闲的端口，即 oneport 类库。</li>
<li>utils.fetch: fetch 响应。</li>
<li>utils.yaml: 通过 js-yaml 类库解析或编译 .yml 文件格式数据。</li>
<li>utils.globby: 通过匹配规则获取文件路径，即 <a href="https://github.com/sindresorhus/globby" target="_blank" rel="noopener">globby 类库</a>。</li>
<li>utils.confman: 配置文件加载器，即 <a href="https://github.com/Houfeng/confman" target="_blank" rel="noopener">confman 类库</a></li>
<li>utils.streamToBuffer, utils.stream2buffer: 将可读流转化成 字符串或 buffer，返回 promise。</li>
<li>utils.bufferToStream, utils.buffer2stream: 将字符串或 buffer 转化成可读流，返回 promise。</li>
<li>utils.copydir: 拷贝文件夹，返回 promise。</li>
<li>utils.findCommand(dirname, command): 获取执行脚本文件。</li>
<li>load(opts): 加载中间件，并执行外层函数。</li>
<li>exec(middlewares, initailArgs): 构建任务流，可用于在中间件中构建子任务流。</li>
</ul>
<h2 id="常用中间件"><a href="#常用中间件" class="headerlink" title="常用中间件"></a>常用中间件</h2><h3 id="dn-middleware-webpack"><a href="#dn-middleware-webpack" class="headerlink" title="dn-middleware-webpack"></a>dn-middleware-webpack</h3><p>概述：基于 webpack3 实现的中间件，打包模块。本地开发模式也将打包模块，而不是读取 webpack 缓存数据。</p>
<p>奥妙：</p>
<ol>
<li>dn-middleware-webpack 在回调中执行后续中间件的处理逻辑。</li>
<li>通过 vmodule-webpack-plugin 插件将 config.yml 类配置文件注入为可以 import 引入的虚拟模块。</li>
<li>ctx 中添加 webpack 属性，即 webpack 类库。</li>
</ol>
<p>选项：</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>意义</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>config</td>
<td>不同环境通过加载配置文件的模块名和文件路径，使用 <a href="https://github.com/Houfeng/vmodule-webpack-plugin" target="_blank" rel="noopener">vmodule-webpack-plugin</a> 创建虚拟模块</td>
<td>{ name: ‘$config’, path: ‘./config’ }</td>
</tr>
<tr>
<td>configFile</td>
<td>webpack 配置文件路径，配置文件导出函数有效</td>
<td>‘./webpack.config.js’</td>
</tr>
<tr>
<td>mode</td>
<td>模式</td>
<td>undefined</td>
</tr>
<tr>
<td>entry</td>
<td>入口文件</td>
<td>[‘./src/*.{js,jsx,ts,tsx}’]</td>
</tr>
<tr>
<td>inject</td>
<td>注入模板中的公用入口文件</td>
<td>[‘./src/*.{js,jsx,ts,tsx}’]</td>
</tr>
<tr>
<td>template</td>
<td>模板文件，模板会加载同名的入口文件</td>
<td>[‘./src/assets/*.html’]</td>
</tr>
<tr>
<td>output</td>
<td>打包文件目录</td>
<td>‘./build/‘</td>
</tr>
<tr>
<td>publicPath</td>
<td>浏览器端访问打包文件的路径</td>
<td>undefined</td>
</tr>
<tr>
<td>folders</td>
<td>不同文件类型的打包目录</td>
<td>{ js: ‘js’, css: ‘css’, img: ‘img’, font: ‘font’, html: ‘’ }</td>
</tr>
<tr>
<td>chunkFilename</td>
<td>懒加载模块名</td>
<td>‘chunks/[name]-[chunkhash].js’</td>
</tr>
<tr>
<td>umd</td>
<td>值为对象时，混合到 webpackConfig.output 配置中</td>
<td>undefined</td>
</tr>
<tr>
<td>external</td>
<td>是否使用外部扩展</td>
<td>undefined</td>
</tr>
<tr>
<td>externals</td>
<td>外部扩展</td>
<td>{ ‘jquery’: ‘jQuery’, ‘zepto’: ‘Zepto’, ‘react’: ‘React’, ‘react-dom’: ‘ReactDOM’ }</td>
</tr>
<tr>
<td>sourceMap</td>
<td>是否生成 source map，开发环境默认生成，false 时不生成；打包时置为 true 才生成</td>
<td>undefined</td>
</tr>
<tr>
<td>watch</td>
<td>是否使用 webpack 监听文件变更，执行 compiler.watch 或 compiler.run 的差别</td>
<td>undefined</td>
</tr>
<tr>
<td>watchOpts</td>
<td>watch 配置</td>
<td>{ aggregateTimeout: 600, ignored: /node_modules/ }</td>
</tr>
<tr>
<td>babel</td>
<td>babel-loader 选项相关，参见下文</td>
<td></td>
</tr>
<tr>
<td>rules</td>
<td>配置额外的加载器，默认加载器包含 babel-loader, vue-loader, json-loader, raw-loader, ejs-loader, url-loade, css-loader, less-loader, fast-sass-loader，可加载的文件可想而知</td>
<td>undefined</td>
</tr>
<tr>
<td>cssModules</td>
<td>是否使用 css modules</td>
<td>undefined</td>
</tr>
</tbody>
</table>
<p>babel 选项：</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>意义</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>presets</td>
<td>配置额外的 presets，默认包含 ‘babel-preset-env’, ‘babel-preset-react’, ‘babel-preset-stage-0’</td>
<td>undefined</td>
</tr>
<tr>
<td>plugins</td>
<td>配置额外的 plugins，默认包含 ‘babel-plugin-typecheck’, ‘babel-plugin-transform-decorators-legacy’, ‘babel-plugin-transform-runtime’</td>
<td>undefined</td>
</tr>
<tr>
<td>targets</td>
<td>作用于 ‘babel-preset-env’，设定编译后脚本的适配环境</td>
<td>undefined</td>
</tr>
<tr>
<td>browsers</td>
<td>适配的浏览器环境，默认适配 [ ‘last 2 versions’, ‘IE &gt;= 9’ ]</td>
<td>undefined</td>
</tr>
<tr>
<td>uglify</td>
<td>targets 中属性，使用 uglify.js 压缩脚本前是否已编译成 es5，默认是，false 为否</td>
<td>undefined</td>
</tr>
<tr>
<td>include</td>
<td>作用于 ‘babel-preset-env’，设定包含的插件</td>
<td>undefined</td>
</tr>
<tr>
<td>exclude</td>
<td>作用于 ‘babel-preset-env’，设定移除的插件</td>
<td>undefined</td>
</tr>
<tr>
<td>loose</td>
<td>作用于 ‘babel-preset-env’，是否允许插件启用 “loose” 转换，默认为否</td>
<td>undefined</td>
</tr>
<tr>
<td>modules</td>
<td>作用于 ‘babel-preset-env’，将es6模块语法转换为何种模块规范语法，默认为 ‘commonjs’</td>
<td>undefined</td>
</tr>
<tr>
<td>useBuiltIns</td>
<td>作用于 ‘babel-preset-env’，是否自动引入 ‘babel-ployfill’，默认使用时引入</td>
<td>undefined</td>
</tr>
<tr>
<td>spec</td>
<td>作用于 ‘babel-preset-env’，是否允许插件启用 “spec” 转换，更符合规范，编译较慢，默认为 false</td>
<td>undefined</td>
</tr>
<tr>
<td>debug</td>
<td>作用于 ‘babel-preset-env’</td>
<td>undefined</td>
</tr>
<tr>
<td>react</td>
<td>是否使用 ‘babel-preset-react’，默认使用，false 时不使用</td>
<td>undefined</td>
</tr>
<tr>
<td>transform</td>
<td>作用于 ‘babel-plugin-transform-runtime’</td>
<td>undefined</td>
</tr>
<tr>
<td>transform.helpers</td>
<td>是否内置 classCallCheck, extends 等，默认内置</td>
<td>undefined</td>
</tr>
<tr>
<td>transform.polyfill</td>
<td>是否内置 Promise, Set, Map, Symbol 等，默认内置</td>
<td>undefined</td>
</tr>
<tr>
<td>transform.regenerator</td>
<td>是否内置生成器函数，async 函数，默认内置</td>
<td>undefined</td>
</tr>
<tr>
<td>transform.moduleName</td>
<td>模块名，import 导入需要，默认为 ‘babel-runtime’</td>
<td>undefined</td>
</tr>
<tr>
<td>transform.useBuiltIns</td>
<td>默认自动引入</td>
<td>undefined</td>
</tr>
<tr>
<td>addExports</td>
<td>影响 ‘babel-plugin-add-module-exports’ 插件的使用（该插件可在模块转换成 common.js，无需从default 属性中取出模块导出内容），false 时不使用 ‘babel-plugin-add-module-exports’</td>
<td>undefined</td>
</tr>
<tr>
<td>strict</td>
<td>影响 ‘babel-plugin-transform-remove-strict-mode’ 插件的使用，true 时不使用</td>
<td>undefined</td>
</tr>
</tbody>
</table>
<p>事件：</p>
<ul>
<li>‘webpack.opts’，可用于修改 opts 配置项，参数 opts。</li>
<li>‘webpack.config’，可用于修改注入 webpack 的 config 配置，参数 config, webpack, opts。</li>
<li>‘webpack.compiler’，操纵 webpack 的编译器，参数 compiler。</li>
<li>‘webpack.stats’，可用于监控编译状态，参数 stats。</li>
</ul>
<h3 id="dn-middleware-server"><a href="#dn-middleware-server" class="headerlink" title="dn-middleware-server"></a>dn-middleware-server</h3><p>概述：基于 <a href="https://github.com/nokitjs/nokit" target="_blank" rel="noopener">nokit</a>，启动本地服务。首次执行时将在项目空间创建 server.yml 配置文件。</p>
<p>奥妙：</p>
<ol>
<li>在 nokit 服务器中设置拦截器，通过 <a href="https://github.com/nodejitsu/node-http-proxy" target="_blank" rel="noopener">httpProxy</a> 转发请求。</li>
<li>ctx 中添加 server 属性，即 nokit.Server 实例；以及 httpServer 属性，即 server.httpServer。</li>
</ol>
<p>选项：</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>意义</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>host</td>
<td>主机，影响自动访问的页面地址</td>
<td>‘<a href="http://localhost" target="_blank" rel="noopener">http://localhost</a>‘</td>
</tr>
<tr>
<td>config</td>
<td>配置文件路径，作为 nokit 服务器的配置文件路径，默认读取 server.yml</td>
<td>‘server’</td>
</tr>
<tr>
<td>public</td>
<td>浏览器端访问资源文件的路径</td>
<td>‘./build’</td>
</tr>
<tr>
<td>port</td>
<td>端口，默认使用 ctx.oneport 检测空闲的端口</td>
<td>undefined</td>
</tr>
<tr>
<td>autoOpen</td>
<td>是否自动访问网页，false 时为否</td>
<td>undefined</td>
</tr>
</tbody>
</table>
<p>server.yml 中 proxy 支持配置选项：</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>意义</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>rules</td>
<td>转发路径匹配规则，如 ^/api(.*): ‘<a href="https://www.aliyun.com/" target="_blank" rel="noopener">https://www.aliyun.com/</a>‘</td>
<td>{}</td>
</tr>
<tr>
<td>options</td>
<td>作为 Proxy Server 的选项</td>
<td>{ xfwd: true, changeOrigin: true }</td>
</tr>
<tr>
<td>headers</td>
<td>设置代理请求的 header 头，如 Referer: ‘<a href="https://www.aliyun.com/" target="_blank" rel="noopener">https://www.aliyun.com/</a>‘ 可携带 cookie</td>
<td>undefined</td>
</tr>
</tbody>
</table>
<p>事件：</p>
<ul>
<li>‘server.init’，服务未启动时事件，参数 server 实例。</li>
<li>‘server.start’，服务启动成功时事件，参数 server 实例。</li>
</ul>
<h3 id="dn-middleware-dll"><a href="#dn-middleware-dll" class="headerlink" title="dn-middleware-dll"></a>dn-middleware-dll</h3><p>概述：独立构建项目依赖，节省打包时间。</p>
<p>奥妙：</p>
<ol>
<li>借助 ctx.exec 方法执行 webpack 中间件，打包项目的依赖，默认存放在工程目录 .cache 文件夹内。子文件夹名基于项目所使用的依赖通过 md5 生成散列，以便在依赖更新时重新打包。再借助 ctx.exec 方法执行 copy 中间件，将打包文件拷贝到 build/js 文件夹内。</li>
<li>通过 ‘webpack.config’ 事件，在 webpackConfig 插件中注入 webpack.DllReferencePlugin 插件。</li>
</ol>
<p>选项：</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>意义</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>output</td>
<td>打包文件输出位置</td>
<td>‘build/js’</td>
</tr>
<tr>
<td>libName</td>
<td>打包文件名</td>
<td>‘lib’</td>
</tr>
<tr>
<td>compress</td>
<td>是否压缩打包文件，默认压缩，false 时不压缩</td>
<td>undefined</td>
</tr>
<tr>
<td>vendors</td>
<td>待打包模块列表，默认为 package.json 中依赖</td>
<td>undefined</td>
</tr>
</tbody>
</table>
<h3 id="dn-middleware-faked"><a href="#dn-middleware-faked" class="headerlink" title="dn-middleware-faked"></a>dn-middleware-faked</h3><p>概述：基于 <a href="https://github.com/Houfeng/faked" target="_blank" rel="noopener">faked</a> 提供数据模拟服务。</p>
<p>奥妙：</p>
<ol>
<li>基于 faked 创建 gui server 服务器，配置的模拟数据将输出到工程目录 mock 文件夹中 index.js, gui.data.json。</li>
<li>模拟数据文件最终将作为 webpack 入口文件，以此实现远程请求的拦截，并实现热更新。</li>
<li>执行逻辑被封装为 ctx.faked.apply 方法，在 dn-middleware-webpack 中执行，两个中间件耦合度较高。</li>
</ol>
<p>选项：</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>意义</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>dir</td>
<td>打包文件输出位置</td>
<td>‘mock’</td>
</tr>
<tr>
<td>port</td>
<td>gui server 服务启动的端口号，默认使用 this.utils.oneport 检出</td>
<td>undefined</td>
</tr>
<tr>
<td>gui</td>
<td>禁用 gui server 服务</td>
<td>‘build/js’</td>
</tr>
</tbody>
</table>
<h3 id="dn-middleware-i18n"><a href="#dn-middleware-i18n" class="headerlink" title="dn-middleware-i18n"></a>dn-middleware-i18n</h3><p>概述：将工程目录中 locales 语言包加载为 $locales 模块，通过 $i18n 获取指定模块，实现国际化。</p>
<p>奥妙：</p>
<ol>
<li>使用 confman.webpackPlugin 方法将工程目录中的语言包输出为 $locales 虚拟模块。</li>
<li>使用 vmodule-webpack-plugin 类库输出 $i18n 虚拟模块，以获取指定文案。</li>
</ol>
<p>选项：</p>
<table>
<thead>
<tr>
<th>选项</th>
<th>意义</th>
<th>默认值</th>
</tr>
</thead>
<tbody>
<tr>
<td>dir</td>
<td>语言包所在位置</td>
<td>‘./locales’</td>
</tr>
<tr>
<td>extract</td>
<td>指定将语言包输出为单独的 js 资源的文件夹路径，默认不输出单独的脚本</td>
<td>null</td>
</tr>
</tbody>
</table>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><ul>
<li>dn-middleware-clean，清理文件或目录，可用 opts.target 加以配置，默认清理 ‘./build/<em>*/</em>.*’。</li>
<li>dn-middleware-copy，复制文件。选项 from 查询源文件的文件夹路径，默认 ‘./from’; to 目标文件夹路径; log 是否打印日志; dot 源文件匹配规则是否支持 ‘.’ 起始; direction 影响映射 key 键指代源文件还是目标文件; files 源文件和目标文件映射，目标文件路径支持占位符 {index} 替换（index 自右而左），或使用源文件路径（映射中，目标文件以 ‘/‘ 结尾）。</li>
<li>dn-middleware-browser-sync 基于 ‘browser-sync’ 监听打包文件变更，借助 ‘connect-browser-sync’ express中间件实现热更新。选项 files 配置监听的文件，默认 [‘./build/<em>*/</em>.*’]；port 为 ‘browser-sync’ 服务启动端口，默认 5001。</li>
<li>dn-middleware-git-sync，git 操作，包含 commit, push 动作（push 又区分日常和预发环境）。</li>
<li>dn-middleware-jcs，在 babel-loader 中添加 ‘jsx-control-statements’ 插件，以使 jsx 可使用结构控制语句，同时 lint 阶段也会作代码检查，参考 <a href="https://zhuanlan.zhihu.com/p/28519304" target="_blank" rel="noopener">通过 JSX Control Statements 编写 JSX</a>。</li>
<li>dn-middleware-lint，使用 eslint 命令作语法检查。</li>
<li>dn-middleware-tslint，对 typescript 进行语法检查。</li>
<li>dn-middleware-typedoc，使用 typedoc 为 typescript 项目生成文档。</li>
<li>dn-middleware-typescript，在 webpackConfig 中添加 awesome-typescript-loader，支持编译 tsx 模块。选项 declaration 是否分离 ts, js 文件，默认分离，false 时不分离。</li>
<li>dn-middleware-pkginfo，更新项目 package.json 中的 name, version, description 信息。</li>
<li>dn-middleware-prepush，在 .git/hooks/pre-push 添加 shell 命令，推送前执行 dn build 命令。</li>
<li>dn-middleware-sensitive-path，在 webpackConfig 中添加 ‘case-sensitive-paths-webpack-plugin’ 插件，使 mac, windows 引入模块时严格区分模块的大小写。</li>
<li>dn-middleware-shell，调用 ctx.utils.exec 执行 shell 命令。选项 script 命令内容；wscript 为 windows 系统下命令内容；async 是否异步执行，默认同步。</li>
<li>dn-middleware-watch，基于 ‘chokidar’ 监听执行文件变更。选项 match 匹配的文件，默认为 ‘./src/<em>*/</em>.*’；event 监听的事件类型；script 事件发生后执行的脚本；onChange 事件发生后执行的动作。</li>
<li>dn-middleware-unit，基于 ‘mocha’ 对 ./test/unit 文件夹中内容作单元测试。</li>
</ul>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
      

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2018/08/22/react/react相关/mobx使用探微/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
                
                <a class="post-title-link" href="/2018/08/22/react/react相关/mobx使用探微/" itemprop="url">mobx使用探微</a></h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2018-08-22T00:00:00+08:00">2018-08-22</time>
            

            
            

            
          </span>

          
            <span class="post-category" >
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/状态管理/" itemprop="url" rel="index"><span itemprop="name">状态管理</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/08/22/react/react相关/mobx使用探微/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2018/08/22/react/react相关/mobx使用探微/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>写作这篇文章的起因是我有感于实际项目中所遇到的问题。因此，这篇文章只算是摸索的产物，远未臻于完美。在这里，我谨期望阅读这篇文章的同学能够见仁见智，各洒江海。</p>
<p>我所遇到的问题，总结如下：</p>
<ol>
<li>项目采用分层设计，pages 为视图层，stores 为模型层，services 为服务层。从某种意义上讲，代码是按功能单元进行划分的，而不是业务单元。需要分别从 pages, stores, services 层取出相应的模块，才能构成一个完整的业务单元。分层设计的优点在于代码组织的清晰性，但是降低了可移植性。当需要向第三方应用输出某个业务单元时，就不得不另起炉灶，需要重新为特定的视图组件串联 stores。</li>
<li>无论 stores 层，还是 services 层，代码设计大都以视图为出发点，比如 services 层多次对同一个后台接口实现了调用，比如 stores 混杂着特定页面的视图状态，不利于复用。通过这一点，所能感知的症结是，stores 层中的模块称不上是对数据模型的精要抽象。除此以外，这个病症所体现的另一个特征是，stores 层中的模块常常仅作为视图组件和 ajax 接口的桥接层，即简单地将接口数据灌入到视图中、或者将视图数据提交到远端。这样做的好处是 store 极为轻量，但是，其一，远没有挖掘 mobx 用于组织数据模型的价值（近于使用 redux 处理纯数据），其二，store 没法涵盖数据特征，数据在视图层消费时才能展现其意义。事实上，数据处理中的 value - text 转换也常常会落在视图层。这样，在另一张需要消费同一份数据的视图页面中，就仍需要重做一份数据转换处理。</li>
</ol>
<p>以上种种，促使我在业余时间着意摸索 mobx 的使用。很显然的，需求是技术提升的动力。离开项目环境，仅凭有限的知识和经验储备，我没办法复现实际项目的业务复杂度。相形之下，我所思忖的案例是较为简单的。因此，由这篇文章引出的种种观点无疑都是可商榷的。不过，有什么是一成不变的呢？譬如武侠小说中提到的，“剑招是死的，人是活的”。我再次期望阅读这篇文章的同学对本文所引出的命题有所意会、有所领悟，而对形式上的糟粕持宽容的态度；若是能以丰富的开发经验对我有所指教，那就再好不过了。</p>
<p>备注：示例代码通过自制的 <a href="https://github.com/Alfred-sg/plutarch" target="_blank" rel="noopener">plutarch 脚手架</a> 实现，托管仓库地址为 <a href="https://github.com/Alfred-sg/mobx-demo" target="_blank" rel="noopener">mobx-demo</a> 。</p>
<h2 id="案例前情"><a href="#案例前情" class="headerlink" title="案例前情"></a>案例前情</h2><p>案例将提取商城系统中的产品配置环节，绘制的页面仅包含产品列表页、产品编辑页和产品详情页。介于案例旨在于探讨 mobx 的使用，势必会使业务屈从于所要考量的功能点，一反业务引导开发的常态。我个人的一些看法，在开发已集大成的前提下，由开发引导业务也未尝不是一种选项；系统设计的舵手譬如指挥官，所需的是纵览全局的能力，不扭于认知、经验和职司。假使一位富于远见的开发对多个商城系统的设计和实现已经了然于胸，他又怎不能称为建站工作的主导者呢？只不过这一点对大多数人来说，都过于理想化，很能达成。毕竟职业、天赋和精力的限制，会让我们的成长道路都有所局限。当然，这是题外话。言归正传，本案例涵盖的考察要点包括：</p>
<ol>
<li>适用于多个页面的 Product 商品模型。</li>
<li>互为关联的 Product, Attribute 商品属性模型。</li>
</ol>
<p>以上两点，都是以数据模型为导向的，而不是着眼于页面绘制。从职责来看，前端的工作内容是绘制页面，页面逻辑在部分人眼里只是个子内容。但从整体来看，数据才是内容，视图只是表现。mobx 所提供的强大能力不止于像 redux 那样单纯处理数据流，而在于它通过代理提供了数据建模的可能。如果说 redux 是面向过程编程，那么 mobx 就是面向对象编程。附着的那层响应式操作不改变原有类的特征，使我们能更大程度地使用这个类。这是在响应式之外，使用 mobx 编程时尤其需要有所发现的点。下文将作深入探讨。</p>
<p>当前端的开发工作以数据模型为导向时，就更能契合后端的表结构设计、模型层实现，抽象程度也更高，自然能加深对业务的理解。另外，数据处理也不至于散落在视图层。</p>
<p>对于考察要点中的第二项，所需说明的是案例持有的业务特征。当我们访问淘宝，会发现手机从属于“家电 / 数码 / 手机”这一大类，“手机”这一小类；对于“手机”这一小类，还有诸如”机身内存ROM”，“手机类型”，“网络类型”，“附加功能”，“摄像头类型”，“分辨率”等特有属性。可以料想的是，这些特有属性和“手机”这个小类呈联动关系，即 Attribute 有单独的表设计（特征量和特征值双表）。特别说明这一点，既是为了剖析案例所有的业务特征，也是为了表明案例更大程度上植根于猜想，我并没有参与商城开发的十足经验，错谬也在所难免，期望阅读这篇文章的同学海涵。</p>
<p>简易的表结构设计如下（参考淘宝开放平台的商品接口设计）：</p>
<p><em>图 1，简要表结构</em><br><img src="/2018/08/22/react/react相关/mobx使用探微/database.png"></p>
<p>如上图所示，Product 产品表包含 cids 字段指向 Category 分类表，attrs 字段用于聚合 Attribute 属性特征量表和 Attr_Value 属性特征值表。贴图的表结构虽然难免会有差池，但不妨碍本文用于探讨 mobx 的使用。为了简化案列的复杂度，本文也约定 Category, Attribute, Attr_Value 表中的数据不需要另行制作配置页面注入数据。</p>
<p>基于以上，相应接口如下，相关代码参考托管仓库中的 plutarch.mock.js 文件：</p>
<ol>
<li>get api/category 接口用于获取产品类目，传参 level 用于区分检索大类还是小类，cid 用于锁定产品类目。</li>
<li>get api/attributes 接口用于获取与类目相关的属性，传参 cid 用于锁定产品类目。</li>
<li>post api/product 接口用于保存或更新产品。</li>
<li>get api/product 接口用于获取产品。</li>
<li>get api/products 接口用于获取产品列表。</li>
<li>delete api/product 用于删除产品。</li>
</ol>
<h2 id="案列实现"><a href="#案列实现" class="headerlink" title="案列实现"></a>案列实现</h2><p>案例仍采用分层架构（如何以业务单元形式组织代码暂留作后续的思考命题）：</p>
<p><em>图 2，整体架构</em><br><img src="/2018/08/22/react/react相关/mobx使用探微/architecture.png"></p>
<ol>
<li>requset 模块：基于 aioxs 类库处理 ajax 请求，使用拦截器诊断错误的响应，并使用 antd/message 组件在页面中显示错误内容（该组件能同时展现多个请求错误）。</li>
<li>services 层：使用 class 语法构造，便于继承，同时也继承了 Cache 类，用于缓存比较稳定的接口数据。同时，utils 工具包提供了 mixinStaticProperty 装饰器，用于将 services 层输出类的原型方法注入为 model 类的静态方法，参见 stores/models/Product 类的实现。services 层也可以用于拆分接口，如 services/category 将 getCategory 接口拆分为 getCategoryByCid, getCategoryByLevel 两个接口。这样便于更细微的控制，当然，拆分接口的稳定性另当别论。</li>
<li>stores/models 基本数据模型：数据模型分为两类，一类需要深入数据库或后台模型的数据特征，如 Product 类拥有诸多的可观察属性，便于以方法的形式操作这些属性值的变更，而列表也是由这些类自底而上构成的；另一类则采用数目不多的属性批量更新的机制实现，不需要微操数据的变更，所包含的方法通常也只跟远程请求相关，如 Category, Attribute 类。</li>
<li>stores 层其余衍生数据模型：基于 models 实现，与页面实际交互的模型，如由 Product 类衍生出 ProductInEdit, ProductInDetail, ProductList 三个类，即分别应用于编辑页、详情页和列表页。编辑页和详情页所使用的模型均可拓展 Product 类实现，案列出于职责分离的考虑，将其细分为多个子类。当然，也可以像案列中 Category 类的实现那样，在该类中聚合多种只能，比如全量拉取产品分类数据，以及只拉取针对某个产品的分类数据。同时，为了更好地实现数据处理，Category, Attribute 类均输出实例作为 Product 的实例属性，这样能聚合该产品的分类、属性数据处理操作。</li>
<li>pages 层：当 stores 层通过数据模型承担数据处理操作时，pages 理论上只承担了展示职能。介于 mobx 实现代理数组的特殊性，改变数组项的内部属性只能通过观察该数组项完成，列表操作又需要调用代理数组的方法，才能启动重绘。因此，使用 mobx 注入可观察数据时，首先，组件的颗粒度需要得到细化处理，其次，在删除某个数组项如某个产品时，不禁需要调用 product.delete 方法，也需要调用调用 products.splice 方法，使列表得到重绘。</li>
<li>locales 层：提供国际化文案，使用命名空间拆分成 action, model,text 三大类。action 包含操作类文案，model 包含数据模型相关文案，text 包含标题、消息和普通文本。国际化文案可直接注入视图层，或者经由 model 作转化处理后注入视图层，后者作为 model 的静态属性注入视图层。</li>
</ol>
<p>以下内容将通过代码展示部分实现。</p>
<h3 id="数据缓存"><a href="#数据缓存" class="headerlink" title="数据缓存"></a>数据缓存</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">let</span> caches = &#123;&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 设置数据缓存</span></span><br><span class="line">  setCache(actionName, key, value)&#123;</span><br><span class="line">    <span class="keyword">if</span> ( !caches[actionName] ) caches[actionName] = &#123;&#125;;</span><br><span class="line">    caches[actionName][key] = value;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取数据缓存</span></span><br><span class="line">  getCache(actionName, key)&#123;</span><br><span class="line">    <span class="keyword">const</span> cache = caches[actionName];</span><br><span class="line">    <span class="keyword">return</span> cache &amp;&amp; key !== <span class="literal">undefined</span> ? cache[key] : cache;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 清除数据缓存</span></span><br><span class="line">  clearCache(actionName)&#123;</span><br><span class="line">    caches[actionName] = <span class="literal">undefined</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryService</span> <span class="keyword">extends</span> <span class="title">Cache</span> </span>&#123;</span><br><span class="line">  <span class="keyword">async</span> getCategory(params)&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; cid, level &#125; = params;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> ( level !== <span class="literal">undefined</span> ) </span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.getCategoryByLevel(level);</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ( cid !== <span class="literal">undefined</span> ) </span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">this</span>.getCategoryByCid(cid);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 在 service 层将 getCategory 拆分成多个针对请求的微处理接口</span></span><br><span class="line">  <span class="comment">// 必要时使用缓存数据</span></span><br><span class="line">  <span class="keyword">async</span> getCategoryByLevel(level)&#123;</span><br><span class="line">    <span class="keyword">let</span> res = <span class="keyword">this</span>.getCache(<span class="string">'getCategoryByLevel'</span>, level);</span><br><span class="line">    <span class="keyword">if</span> ( res ) <span class="keyword">return</span> res;</span><br><span class="line">    </span><br><span class="line">    res = <span class="keyword">await</span> get(<span class="string">'/api/category'</span>, &#123; level &#125;);</span><br><span class="line">    <span class="keyword">this</span>.setCache(<span class="string">'getCategoryByLevel'</span>, level, res);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> getCategoryByCid(cid)&#123;</span><br><span class="line">    <span class="keyword">let</span> res = <span class="keyword">this</span>.getCache(<span class="string">'getCategoryByCid'</span>, cid);</span><br><span class="line">    <span class="keyword">if</span> ( res ) <span class="keyword">return</span> res;</span><br><span class="line"></span><br><span class="line">    res = <span class="keyword">await</span> get(<span class="string">'/api/category'</span>, &#123; cid &#125;);</span><br><span class="line">    <span class="keyword">this</span>.setCache(<span class="string">'getCategoryByCid'</span>, cid, res);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码通过 Cache 类实现数据缓存功能，CategoryService 类继承后，将根据请求内容、原型方法名缓存 ‘/api/category’ 接口的响应数据。同时，getCategory 接口也视页面中的调用情况拆分为 getCategoryByLevel, getCategoryByCid 两个原型方法，也许这是画蛇添足的一个举动，既会使代码不够简易，在后台接口变动时，又会增加额外的修改量，不过却暗含着一种可能，利弊交由阅读这篇文章的同学自行判断。</p>
<p>以上代码存在的优化点：</p>
<ol>
<li>缓存 key 键的兼容度，Cache 类实现上仅能处理有请求参数的情形，而有些可以作缓存的接口没有请求参数。</li>
<li>缓存的时效问题，Cache 类的缓存机制在当前访问过程中均有效，在该时间段无法拉取数据库中已作更改的最新值。</li>
</ol>
<h3 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h3><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 可采用继承的方式将远程请求方法混入到 Product 类中，此处使用 mixinStaticProperty 装饰器混入静态方法</span></span><br><span class="line">@mixinStaticProperty(ProductService)</span><br><span class="line"><span class="keyword">export</span> <span class="keyword">default</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line">  @observable id;<span class="comment">// 商品id</span></span><br><span class="line">  @observable name;<span class="comment">// 商品名称</span></span><br><span class="line">  @observable cids;<span class="comment">// 商品分类</span></span><br><span class="line">  @observable attrValues = &#123;&#125;;<span class="comment">// 商品属性</span></span><br><span class="line">  @observable num;<span class="comment">// 库存</span></span><br><span class="line">  @observable price;<span class="comment">// 价格</span></span><br><span class="line">  @observable desc;<span class="comment">// 描述</span></span><br><span class="line">  @observable status;<span class="comment">// 状态</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">constructor</span>(props)&#123;</span><br><span class="line">    <span class="keyword">this</span>.setValues(props);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 后台交互数据全量更新；部分更新可直接使用赋值语句；重置可传空</span></span><br><span class="line">  @action</span><br><span class="line">  setValues(data = &#123;&#125;)&#123;</span><br><span class="line">    <span class="keyword">this</span>.id = data.id;</span><br><span class="line">    <span class="keyword">this</span>.name = data.name;</span><br><span class="line">    <span class="keyword">this</span>.cids = data.cids;</span><br><span class="line">    <span class="keyword">this</span>.attrValues = data.attrValues || &#123;&#125;;</span><br><span class="line">    <span class="keyword">this</span>.num = data.num;</span><br><span class="line">    <span class="keyword">this</span>.price = data.price;</span><br><span class="line">    <span class="keyword">this</span>.desc = data.desc;</span><br><span class="line">    <span class="keyword">this</span>.status = data.status;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取后台交互数据</span></span><br><span class="line">  getValues()&#123;</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      id: <span class="keyword">this</span>.id,</span><br><span class="line">      name: <span class="keyword">this</span>.name,</span><br><span class="line">      cids: <span class="keyword">this</span>.cids,</span><br><span class="line">      attrValues: <span class="keyword">this</span>.attrValues,</span><br><span class="line">      num: <span class="keyword">this</span>.num,</span><br><span class="line">      price: <span class="keyword">this</span>.price,</span><br><span class="line">      desc: <span class="keyword">this</span>.desc,</span><br><span class="line">      status: <span class="keyword">this</span>.status</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  @action</span><br><span class="line">  <span class="keyword">async</span> getProduct(id)&#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> Product.get(&#123; id &#125;);</span><br><span class="line">    <span class="keyword">if</span> ( res ) <span class="keyword">this</span>.setValues(res);</span><br><span class="line">    <span class="keyword">return</span> res || <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  @action</span><br><span class="line">  <span class="keyword">async</span> saveProduct()&#123;</span><br><span class="line">    <span class="keyword">const</span> params = <span class="keyword">this</span>.getValues();</span><br><span class="line">    <span class="keyword">const</span> res = params.id ? <span class="keyword">await</span> Product.update(params) : <span class="keyword">await</span> Product.save(params);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  @action</span><br><span class="line">  <span class="keyword">async</span> deleteProduct()&#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> Product.del(&#123; <span class="attr">id</span>: <span class="keyword">this</span>.id &#125;);</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码为 Product 基类，可以看出，实现上同后台提供的接口和数据模型均强关联，其一通过 observable 装饰器将后台提供的字段全部转化为可观察属性，并提供 setValues, getValues 批量赋值和取值（通常在提交数据前、获取数据后，需要调用这两个方法）；其二以原型方法实现 ajax 调用，这里既可以继承 services 层中的类，也可以使用 mixinStaticProperty 装饰器注入静态方法。</p>
<p>Product 基类化用了 backbone 模型特征，可以优化的点：</p>
<ol>
<li>代码自动生成。通过 Product 基类也能发现，该类数据模型拥有很高的类同点，基于后台数据模型及接口实现 mobx 数据模型基类，如果能根据 jar 包和配置文件，自动生成这些基类文件，那就再好不过了。当然，这对我来说，也是短期内没法办到的事。需要走的路还长着呢。</li>
<li>案列中没有考虑两份提交数据，多个接口调用，比如产品状态更新，就需要多一份产品状态提交数据，再调用状态更新的接口。因此，我的一些想法还没经过实践沉淀，合理性和稳定性势必存疑，比如前一条优化建议。</li>
</ol>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductInDetail</span> <span class="keyword">extends</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line">  attribute = <span class="keyword">new</span> Attribute();</span><br><span class="line">  category = <span class="keyword">new</span> Category();</span><br><span class="line"></span><br><span class="line">  @observable categories = [];<span class="comment">// 商品分类全量信息</span></span><br><span class="line">  @observable attributes = [];<span class="comment">// 商品属性全量信息</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 备注，改变单个数组项的属性不会引起视图重绘，必须在数组中改变整个数组项</span></span><br><span class="line">  <span class="comment">// 在 product 实例初始化过程中调用 getCategories 方法，不会引起 Table 视图的重绘</span></span><br><span class="line">  @action</span><br><span class="line">  <span class="keyword">async</span> getCategories(cids)&#123;</span><br><span class="line">    <span class="keyword">this</span>.categories = [];</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">this</span>.category.getCategoryByCids(cids);</span><br><span class="line">    <span class="keyword">if</span> ( res ) <span class="keyword">this</span>.categories = res;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取商品分类文案</span></span><br><span class="line">  @computed</span><br><span class="line">  get categoryTexts()&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>.categories.map(<span class="function"><span class="params">item</span> =&gt;</span> item.name).join(<span class="string">', '</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取属性</span></span><br><span class="line">  @action</span><br><span class="line">  <span class="keyword">async</span> getAttributes(cid)&#123;</span><br><span class="line">    <span class="keyword">this</span>.attributes = [];</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">this</span>.attribute.getAttributes(&#123; cid  &#125;);</span><br><span class="line">    <span class="keyword">if</span> ( res ) <span class="keyword">this</span>.attributes = res;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @computed</span><br><span class="line">  get attributeTexts()&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; attrValues, attributes &#125; = <span class="keyword">this</span>;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="built_in">Object</span>.keys(attrValues).length || !attributes.length ) <span class="keyword">return</span> [];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> result = [];</span><br><span class="line"></span><br><span class="line">    <span class="built_in">Object</span>.keys(attrValues).map(<span class="function"><span class="params">key</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> attr = attributes.find(<span class="function"><span class="params">attr</span> =&gt;</span> attr.id == key);</span><br><span class="line">      <span class="keyword">const</span> name = attr.name;</span><br><span class="line">      <span class="keyword">let</span> value = attrValues[key].map(<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> attr.options.find(<span class="function"><span class="params">item</span> =&gt;</span> item.id == val).name;</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      result.push(&#123;</span><br><span class="line">        name,</span><br><span class="line">        value</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取商品状态文案</span></span><br><span class="line">  @computed</span><br><span class="line">  get statusText()&#123;</span><br><span class="line">    <span class="keyword">let</span> text = StatusList.filter(<span class="function"><span class="params">item</span> =&gt;</span> item.value === <span class="keyword">this</span>.status)[<span class="number">0</span>].text;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> text;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductInEdit</span> <span class="keyword">extends</span> <span class="title">Product</span> </span>&#123;</span><br><span class="line">  attribute = <span class="keyword">new</span> Attribute();</span><br><span class="line"></span><br><span class="line">  @observable attributes = [];<span class="comment">// 商品属性全量信息</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取属性</span></span><br><span class="line">  @action</span><br><span class="line">  <span class="keyword">async</span> getAttributes(cid)&#123;</span><br><span class="line">    <span class="keyword">this</span>.attributes = [];</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">this</span>.attribute.getAttributes(&#123; cid  &#125;);</span><br><span class="line">    <span class="keyword">if</span> ( res ) <span class="keyword">this</span>.attributes = res;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 编辑页显示数据</span></span><br><span class="line">  @computed</span><br><span class="line">  get pageValues()&#123;</span><br><span class="line">    <span class="keyword">let</span> attrValues = &#123;&#125;;</span><br><span class="line">    <span class="built_in">Object</span>.keys(<span class="keyword">this</span>.attrValues).map(<span class="function"><span class="params">attrId</span> =&gt;</span> &#123;</span><br><span class="line">      attrValues[<span class="string">`attrId<span class="subst">$&#123;attrId&#125;</span>`</span>] = <span class="keyword">this</span>.attrValues[attrId];</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">      name: <span class="keyword">this</span>.name,</span><br><span class="line">      cids: <span class="keyword">this</span>.cids,</span><br><span class="line">      attrs: attrValues,</span><br><span class="line">      num: <span class="keyword">this</span>.num,</span><br><span class="line">      price: <span class="keyword">this</span>.price,</span><br><span class="line">      desc: <span class="keyword">this</span>.desc</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上代码基于 Product 类实现详情页、编辑页专用的数据模型，无非获取远程数据，进行 value - name 值转换。在获取远程数据时，可以将另一个数据模型以实例属性的方式注入到当前数据模型中，以便于在当前模型中作数据转换处理，同时增加了模型之间的耦合度。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductList</span> </span>&#123;</span><br><span class="line">  @observable products = [];</span><br><span class="line">  </span><br><span class="line">  @action</span><br><span class="line">  <span class="keyword">async</span> getProducts()&#123;</span><br><span class="line">    <span class="keyword">this</span>.products = [];</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> Product.query();</span><br><span class="line">    (res || []).map(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.products.push(<span class="keyword">new</span> Product(item));<span class="comment">// 此处 Product 为 ProductInDetail</span></span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>ProductList 类基于 ProductInDetail 实例构建数组项，以便于在视图层绘制列表时直接绘制 ProductInDetail 实例的计算属性或者调用其远程请求接口。</p>
<h3 id="并行请求"><a href="#并行请求" class="headerlink" title="并行请求"></a>并行请求</h3><p>并行请求可以在视图层通过 Promise.all 加以组织，也可以在模型层组织同一类并行请求接口，如 Category 模型中通过 getCategoryByCids 方法获取产品的多个类目信息。当然，这部分内容通常由后端同学帮忙完成，这里仅展示前端代码实现上的一种可能。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Category</span> <span class="keyword">extends</span> <span class="title">CategoryService</span> </span>&#123;</span><br><span class="line">  @observable categories = [];</span><br><span class="line"></span><br><span class="line">  @action</span><br><span class="line">  insertToCategories = <span class="function">(<span class="params">category = &#123;&#125;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !<span class="keyword">this</span>.categories.some(<span class="function"><span class="params">item</span> =&gt;</span> item.id == category.id) )&#123;</span><br><span class="line">      <span class="keyword">this</span>.categories.push(category);</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">async</span> getCategory(params)&#123;</span><br><span class="line">    <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">super</span>.getCategory(params);</span><br><span class="line">    <span class="keyword">if</span> ( res )&#123;</span><br><span class="line">      <span class="comment">// 将多次数据变更合成一个事务，减少重绘的次数</span></span><br><span class="line">      transaction(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        res.map(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">          <span class="keyword">this</span>.insertToCategories(item);</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 处理并行请求</span></span><br><span class="line">  getCategoryByCids(cids)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.categories = [];</span><br><span class="line">  </span><br><span class="line">      cids.map(<span class="keyword">async</span> cid =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">this</span>.getCategory(&#123; cid &#125;);</span><br><span class="line">        <span class="keyword">if</span> ( !res ) reject(res);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 最后一个请求，响应通过 insertToCategories 方法收集到 categories 属性中</span></span><br><span class="line">        <span class="keyword">if</span> ( cids.length == <span class="keyword">this</span>.categories.length ) </span><br><span class="line">          resolve(<span class="keyword">this</span>.categories);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 传入 cids，便于并行请求</span></span><br><span class="line">  getCategoryByLevels(cids)&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="built_in">Promise</span>(<span class="function">(<span class="params">resolve, reject</span>) =&gt;</span> &#123;</span><br><span class="line">      cids.map(<span class="keyword">async</span> (cid, index) =&gt; &#123;</span><br><span class="line">        <span class="keyword">const</span> res = <span class="keyword">await</span> <span class="keyword">this</span>.getCategory(&#123; <span class="attr">level</span>: index + <span class="number">1</span> &#125;);</span><br><span class="line">        <span class="keyword">if</span> ( !res ) reject(res);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( index + <span class="number">1</span> === cids.length ) resolve(<span class="keyword">this</span>.categories);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  @computed</span><br><span class="line">  get categoriesTree()&#123;</span><br><span class="line">    <span class="keyword">let</span> tree = [];</span><br><span class="line">    <span class="keyword">this</span>.categories.toJS().sort(<span class="function">(<span class="params">a, b</span>) =&gt;</span> a.level - b.level).filter(<span class="function"><span class="params">item</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> ( item.level == <span class="number">1</span> )&#123;</span><br><span class="line">        tree.push(&#123;</span><br><span class="line">          value: item.id,</span><br><span class="line">          label: item.name,</span><br><span class="line">          isLeaf: <span class="literal">false</span></span><br><span class="line">        &#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> ( item.level == <span class="number">2</span> )&#123;</span><br><span class="line">        <span class="keyword">let</span> parent = tree.filter(<span class="function"><span class="params">it</span> =&gt;</span> it.value == item.parentId)[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">if</span> ( !parent.children ) parent.children = [];</span><br><span class="line">        parent.children.push(&#123;</span><br><span class="line">          value: item.id,</span><br><span class="line">          label: item.name</span><br><span class="line">        &#125;);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> tree;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="视图组件"><a href="#视图组件" class="headerlink" title="视图组件"></a>视图组件</h3><p>组件层即如上文所说的，所需注意的是 mobx 中数组的特殊性，单纯赋值数组项的属性不会引起观察数组的组件重绘，而需要将组件的颗粒度锁定为观察数组项，如下方代码的 CategoryText 组件。删除数组项时，也需要调用代理数组的 splice 方法，才能引起列表组件重绘，如 ProductList 组件内 deleteProduct 方法的实现。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">@observer</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CategoryText</span> <span class="keyword">extends</span> <span class="title">Component</span></span>&#123;</span><br><span class="line">  componentDidMount()&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; product, loadCategory &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">if</span> ( loadCategory ) product.getCategories(product.cids);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render()&#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; product &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">return</span> product.categoryTexts;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">@inject(<span class="string">'productList'</span>)</span><br><span class="line">@observer</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ProductList</span> <span class="keyword">extends</span> <span class="title">Component</span> </span>&#123;</span><br><span class="line">  columns = [&#123;</span><br><span class="line">    title: $i18n(<span class="string">'model.product.id'</span>),</span><br><span class="line">    dataIndex: <span class="string">'id'</span>,</span><br><span class="line">    key: <span class="string">'id'</span></span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    title: $i18n(<span class="string">'model.product.name'</span>),</span><br><span class="line">    dataIndex: <span class="string">'name'</span>,</span><br><span class="line">    key: <span class="string">'name'</span>,</span><br><span class="line">  &#125;, &#123;</span><br><span class="line">    title: $i18n(<span class="string">'model.product.categories'</span>),</span><br><span class="line">    dataIndex: <span class="string">'categories'</span>,</span><br><span class="line">    key: <span class="string">'categories'</span>,</span><br><span class="line">    render: <span class="function">(<span class="params">categories, product</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="xml"><span class="tag">&lt;<span class="name">CategoryText</span> <span class="attr">product</span>=<span class="string">&#123;product&#125;</span> <span class="attr">loadCategory</span>=<span class="string">&#123;true&#125;</span> /&gt;</span></span></span><br><span class="line"><span class="xml">    &#125;</span></span><br><span class="line"><span class="xml">  &#125;, &#123;</span></span><br><span class="line"><span class="xml">    title: $i18n('model.product.price'),</span></span><br><span class="line"><span class="xml">    dataIndex: 'price',</span></span><br><span class="line"><span class="xml">    key: 'price'</span></span><br><span class="line"><span class="xml">  &#125;, &#123;</span></span><br><span class="line"><span class="xml">    title: $i18n('model.product.num'),</span></span><br><span class="line"><span class="xml">    dataIndex: 'num',</span></span><br><span class="line"><span class="xml">    key: 'num'</span></span><br><span class="line"><span class="xml">  &#125;, &#123;</span></span><br><span class="line"><span class="xml">    title: $i18n('model.product.status'),</span></span><br><span class="line"><span class="xml">    dataIndex: 'statusText',</span></span><br><span class="line"><span class="xml">    key: 'statusText'</span></span><br><span class="line"><span class="xml">  &#125;, &#123;</span></span><br><span class="line"><span class="xml">    title: $i18n('model.product.desc'),</span></span><br><span class="line"><span class="xml">    dataIndex: 'desc',</span></span><br><span class="line"><span class="xml">    key: 'desc'</span></span><br><span class="line"><span class="xml">  &#125;, &#123;</span></span><br><span class="line"><span class="xml">    title: $i18n('action.handle'),</span></span><br><span class="line"><span class="xml">    key: 'action',</span></span><br><span class="line"><span class="xml">    render: (text, product, index) =&gt; (</span></span><br><span class="line">      &lt;span&gt;</span><br><span class="line">        &lt;Link to=&#123;`/detail/$&#123;product.id&#125;`&#125; style=&#123;&#123;marginRight: '10px'&#125;&#125;&gt;&#123;$i18n('text.detail')&#125;&lt;/Link&gt;</span><br><span class="line">        &lt;Link to=&#123;`/edit/$&#123;product.id&#125;`&#125; style=&#123;&#123;marginRight: '10px'&#125;&#125;&gt;&#123;$i18n('action.edit')&#125;&lt;/Link&gt;</span><br><span class="line">        &lt;Popconfirm title=&#123;$i18n('text.product.delete_confirm')&#125; </span><br><span class="line">          onConfirm=&#123;() =&gt; &#123; this.deleteProduct(product, index) &#125;&#125; </span><br><span class="line">          okText=&#123;$i18n('action.ok')&#125; cancelText=&#123;$i18n('action.cancel')&#125;&gt;</span><br><span class="line">          &lt;a href="javascript:;"&gt;&#123;$i18n('action.delete')&#125;&lt;/a&gt;</span><br><span class="line">        &lt;/Popconfirm&gt;</span><br><span class="line"><span class="xml">      <span class="tag">&lt;/<span class="name">span</span>&gt;</span></span></span><br><span class="line"><span class="xml">    ),</span></span><br><span class="line"><span class="xml">  &#125;];</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  componentDidMount()&#123;</span></span><br><span class="line"><span class="xml">    this.props.productList.getProducts();</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  // 删除商品</span></span><br><span class="line"><span class="xml">  deleteProduct = async (product, index) =&gt; &#123;</span></span><br><span class="line"><span class="xml">    const &#123; products &#125; = this.props.productList;</span></span><br><span class="line"><span class="xml">    const res = await product.deleteProduct();</span></span><br><span class="line"><span class="xml">    if ( res )&#123;</span></span><br><span class="line"><span class="xml">      products.splice(index);</span></span><br><span class="line"><span class="xml">      message.success($i18n('text.product.delete_success'));</span></span><br><span class="line"><span class="xml">    &#125;;</span></span><br><span class="line"><span class="xml">  &#125;</span></span><br><span class="line"><span class="xml"></span></span><br><span class="line"><span class="xml">  render()&#123;</span></span><br><span class="line"><span class="xml">    const &#123; products &#125; = this.props.productList;</span></span><br><span class="line"><span class="xml">    </span></span><br><span class="line"><span class="xml">    return (</span></span><br><span class="line">      &lt;div&gt;</span><br><span class="line">        &lt;Button style=&#123;&#123;marginBottom: '15px'&#125;&#125; type='primary'&gt;</span><br><span class="line">          &lt;Link to=&#123;'/create'&#125;&gt;&#123;`$&#123;$i18n('action.create')&#125;$&#123;$i18n('text.product')&#125;`&#125;&lt;/Link&gt;</span><br><span class="line">        &lt;/Button&gt;</span><br><span class="line">        &lt;Table size="small" rowKey='id' columns=&#123;this.columns&#125; dataSource=&#123;products.toJS()&#125; /&gt;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>更多代码，请参考 <a href="https://github.com/Alfred-sg/mobx-demo" target="_blank" rel="noopener">mobx-demo</a>，也许阅读这篇文章的同学能有额外的发现呢。</p>
<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>《唐李问对》褒扬诸葛亮而贬低曹操，因为曹操的《孟德新书》适合于照章办事的生手，诸葛亮的《兵法二十篇》适合于独立思考的老手。其中的事理，和吴军博士在《数学之美》中论述道与术一样，浮于浅层的形式抵不过深入的理解。这是一篇富有探索气质的文章，更多地旨在于引发思考，而不是妄下定论。何况这篇文章对于 mobx 的使用及其实现内核的化用，也只是迈出了小小的一两步。要走的路还长着呢。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="http://open.taobao.com/doc.htm?docId=73&amp;docType=1" target="_blank" rel="noopener">淘宝开放平台 - 文档中心</a><br><a href="https://blog.csdn.net/crazzy0727/article/details/59576713" target="_blank" rel="noopener">淘宝商品数据库设计</a></p>

          
        
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </div>
  
  
  
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      

      <section class="site-overview-wrap sidebar-panel sidebar-panel-active">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/avatar.jpeg"
                alt="Alfred" />
            
              <p class="site-author-name" itemprop="name">Alfred</p>
              <p class="site-description motion-element" itemprop="description">人苦不知足，既得陇，复望蜀</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">36</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    <span class="site-state-item-count">17</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    <span class="site-state-item-count">18</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Alfred-sg" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/xiu-fan-79/activities" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-globe"></i>知乎</a>
                  </span>
                
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2018</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Alfred</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Pisces</a> v6.0.2</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.0.2"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.2"></script>



  

  
    <script id="dsq-count-scr" src="https://alfred.disqus.com/count.js" async></script>
  

  





	





  












  





  

  

  

  

  
  

  

  

  

  

</body>
</html>
