<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.0.2" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.2">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.2" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.0.2',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="analyst,react,antd,">


<meta name="description" content="rc-animate 同 react-transition-group，都用于实现元素的移入移出动效。rc-animate 提供两种动效处理方式，Animate 组件用于处理多元素的移入移出动效，包含 css 和 js 动效；CSSMotion 用于处理单元素的动效，只能处理 css 动效。本文第一部分将介绍 Animate 组件；第二部分将介绍 CSSMotion 组件。 Animate 上图即">
<meta name="keywords" content="analyst,react,antd">
<meta property="og:type" content="article">
<meta property="og:title" content="rc-animate">
<meta property="og:url" content="http://yoursite.com/2019/01/01/antd/react-component/rc-animate/index.html">
<meta property="og:site_name" content="修子范语">
<meta property="og:description" content="rc-animate 同 react-transition-group，都用于实现元素的移入移出动效。rc-animate 提供两种动效处理方式，Animate 组件用于处理多元素的移入移出动效，包含 css 和 js 动效；CSSMotion 用于处理单元素的动效，只能处理 css 动效。本文第一部分将介绍 Animate 组件；第二部分将介绍 CSSMotion 组件。 Animate 上图即">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/2019/01/01/antd/react-component/rc-animate/动效视图特征.png">
<meta property="og:image" content="http://yoursite.com/2019/01/01/antd/react-component/rc-animate/rc-animate时序图.png">
<meta property="og:updated_time" content="2019-01-01T12:01:31.622Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="rc-animate">
<meta name="twitter:description" content="rc-animate 同 react-transition-group，都用于实现元素的移入移出动效。rc-animate 提供两种动效处理方式，Animate 组件用于处理多元素的移入移出动效，包含 css 和 js 动效；CSSMotion 用于处理单元素的动效，只能处理 css 动效。本文第一部分将介绍 Animate 组件；第二部分将介绍 CSSMotion 组件。 Animate 上图即">
<meta name="twitter:image" content="http://yoursite.com/2019/01/01/antd/react-component/rc-animate/动效视图特征.png">






  <link rel="canonical" href="http://yoursite.com/2019/01/01/antd/react-component/rc-animate/">


  <title>rc-animate | 修子范语</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">修子范语</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Alfredo's Notes</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>
        </li>
      

      
    </ul>
  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/01/01/antd/react-component/rc-animate/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">rc-animate</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-01-01T00:00:00+08:00">2019-01-01</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/antd-组件库/" itemprop="url" rel="index"><span itemprop="name">antd 组件库</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/01/01/antd/react-component/rc-animate/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/01/01/antd/react-component/rc-animate/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>rc-animate 同 <a href="https://github.com/reactjs/react-transition-group" target="_blank" rel="noopener">react-transition-group</a>，都用于实现元素的移入移出动效。rc-animate 提供两种动效处理方式，Animate 组件用于处理多元素的移入移出动效，包含 css 和 js 动效；CSSMotion 用于处理单元素的动效，只能处理 css 动效。本文第一部分将介绍 Animate 组件；第二部分将介绍 CSSMotion 组件。</p>
<h2 id="Animate"><a href="#Animate" class="headerlink" title="Animate"></a>Animate</h2><img src="/2019/01/01/antd/react-component/rc-animate/动效视图特征.png">
<p>上图即为多元素移入移出动效的视图特征：</p>
<ol>
<li>child1, child3 元素初始化即显现在视图中，该过程将呈现 appear 动效。</li>
<li>child2 元素在下一个渲染过程中将移入视图，该过程将呈现 enter 动效。</li>
<li>child3 元素在下一个渲染过程中将移出视图，该过程将呈现 leave 动效。</li>
</ol>
<p>因为动效有时延，我们需要致力于解决如下问题：</p>
<ol>
<li>若 child2 在 child1 元素的 appear 动效还未完成时移入，child1 需要继续执行 appear 动效。对此，我们可以用内部状态记录动效执行中的元素，从而不打断动效的执行过程。若 child2 元素的 enter 动效执行期间，视图中再添加 child4, child5，也作相同处理。</li>
<li>若 child3 即将移出视图，先将 child3 保存在内部状态中，等 leave 动效执行完成后，再移除 child3。</li>
</ol>
<p>在 rc-animate 中，上述两个状态表现为 Animate 组件的 currentlyAnimatingKeys 实例属性和 state.children。在 Animate 的 componentWillReceiveProps 生命周期中，将通过 currentlyAnimatingKeys 判断动效是否还在执行阶段，以便在 state.children 中保留该元素。当然，在 componentWillReceiveProps 生命周期，主要的处理逻辑为：根据元素移入移出视图情况更新 state.children，并使用 keysToEnter, keysToLeave 属性记录哪些元素需要执行 enter 或者 leave 动效。对问题 2 的解答也就是在动效完成后更新 state.children。</p>
<p>我们可以将 Animate 看成是动效调节器。不计 enter 动效，Animate 首先将在 componentWillReceiveProps 生命周期计算 child 元素需要执行何种动效，然后在 componentDidUpdate 生命周期执行该动效。实际执行的动效与 child 元素挂钩，那样就可以支持不同元素的展示动效多样化。在 rc-animate 中，AnimateChild 就可以理解成不同元素的动效驱动器。通过 props 定义 child 待执行的动效，由 AnimateChild 提供 componentWillAppear, componentWillEnter, componentWillLeave 方法执行具体的动效，且与 Animate 完成对接。AnimateChild 和 Animate 对接表现为，在 Animate 的 componentDidUpdate 生命周期，最终将调用 AnimateChild 的上述方法。下图是 rc-animate 动效执行的时序图。</p>
<img src="/2019/01/01/antd/react-component/rc-animate/rc-animate时序图.png">
<h3 id="Animate-1"><a href="#Animate-1" class="headerlink" title="Animate"></a>Animate</h3><p>作为动效调节器，Animate 组件用于控制全局层面的动效特征。Animate 以 currentlyAnimatingKeys 实例属性记录正在执行动效的元素；keysToEnter, keysToLeave 实例属性记录待显示隐藏的元素；并在动效执行前后通过更新 state.children 的方式控制子元素的渲染状况；在此过程中，将在动效完成后的回调中执行全局意义的绑定函数，如 props.onAppear, props.onEnter, prop.onLeave, props.onEnd 方法。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animate</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * didMount 生命周期执行子元素的 appear 动效</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  componentDidMount() &#123;</span><br><span class="line">    <span class="keyword">const</span> showProp = <span class="keyword">this</span>.props.showProp;</span><br><span class="line">    <span class="keyword">let</span> children = <span class="keyword">this</span>.state.children;</span><br><span class="line">    <span class="keyword">if</span> (showProp) &#123;</span><br><span class="line">      children = children.filter(<span class="function">(<span class="params">child</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> !!child.props[showProp];</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    children.forEach(<span class="function">(<span class="params">child</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (child) &#123;</span><br><span class="line">        <span class="keyword">this</span>.performAppear(child.key);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * componentWillReceiveProps 生命周期感知子元素的显示状态变更</span></span><br><span class="line"><span class="comment">   *  1. 更新 state.children 显示子元素以执行 enter, leave 动效</span></span><br><span class="line"><span class="comment">   *  2. 以 this.keysToEnter, this.keysToLeave 收集待执行 enter, leave 动效的元素</span></span><br><span class="line"><span class="comment">   *     以便在 componentDidUpdate 实际执行动效；在动效执行完成后，触发回调显示或移除视图上的子元素</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  componentWillReceiveProps(nextProps) &#123;</span><br><span class="line">    <span class="keyword">this</span>.nextProps = nextProps;</span><br><span class="line">    <span class="keyword">const</span> nextChildren = toArrayChildren(getChildrenFromProps(nextProps));</span><br><span class="line">    <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="comment">// exclusive needs immediate response</span></span><br><span class="line">    <span class="keyword">if</span> (props.exclusive) &#123;</span><br><span class="line">      <span class="built_in">Object</span>.keys(<span class="keyword">this</span>.currentlyAnimatingKeys).forEach(<span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.stop(key);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> showProp = props.showProp;</span><br><span class="line">    <span class="keyword">const</span> currentlyAnimatingKeys = <span class="keyword">this</span>.currentlyAnimatingKeys;</span><br><span class="line">    <span class="comment">// last props children if exclusive</span></span><br><span class="line">    <span class="keyword">const</span> currentChildren = props.exclusive ?</span><br><span class="line">      toArrayChildren(getChildrenFromProps(props)) :</span><br><span class="line">      <span class="keyword">this</span>.state.children;</span><br><span class="line">    <span class="comment">// in case destroy in showProp mode</span></span><br><span class="line">    <span class="keyword">let</span> newChildren = [];</span><br><span class="line">    <span class="keyword">if</span> (showProp) &#123;</span><br><span class="line">      currentChildren.forEach(<span class="function">(<span class="params">currentChild</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">const</span> nextChild = currentChild &amp;&amp; findChildInChildrenByKey(nextChildren, currentChild.key);</span><br><span class="line">        <span class="keyword">let</span> newChild;</span><br><span class="line">        <span class="keyword">if</span> ((!nextChild || !nextChild.props[showProp]) &amp;&amp; currentChild.props[showProp]) &#123;</span><br><span class="line">          newChild = React.cloneElement(nextChild || currentChild, &#123;</span><br><span class="line">            [showProp]: <span class="literal">true</span>,</span><br><span class="line">          &#125;);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          newChild = nextChild;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (newChild) &#123;</span><br><span class="line">          newChildren.push(newChild);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      nextChildren.forEach(<span class="function">(<span class="params">nextChild</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!nextChild || !findChildInChildrenByKey(currentChildren, nextChild.key)) &#123;</span><br><span class="line">          newChildren.push(nextChild);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      newChildren = mergeChildren(</span><br><span class="line">        currentChildren,</span><br><span class="line">        nextChildren</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// need render to avoid update</span></span><br><span class="line">    <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">      children: newChildren,</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    nextChildren.forEach(<span class="function">(<span class="params">child</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> key = child &amp;&amp; child.key;</span><br><span class="line">      <span class="keyword">if</span> (child &amp;&amp; currentlyAnimatingKeys[key]) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> hasPrev = child &amp;&amp; findChildInChildrenByKey(currentChildren, key);</span><br><span class="line">      <span class="keyword">if</span> (showProp) &#123;</span><br><span class="line">        <span class="keyword">const</span> showInNext = child.props[showProp];</span><br><span class="line">        <span class="keyword">if</span> (hasPrev) &#123;</span><br><span class="line">          <span class="keyword">const</span> showInNow = findShownChildInChildrenByKey(currentChildren, key, showProp);</span><br><span class="line">          <span class="keyword">if</span> (!showInNow &amp;&amp; showInNext) &#123;</span><br><span class="line">            <span class="keyword">this</span>.keysToEnter.push(key);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (showInNext) &#123;</span><br><span class="line">          <span class="keyword">this</span>.keysToEnter.push(key);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!hasPrev) &#123;</span><br><span class="line">        <span class="keyword">this</span>.keysToEnter.push(key);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    currentChildren.forEach(<span class="function">(<span class="params">child</span>) =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> key = child &amp;&amp; child.key;</span><br><span class="line">      <span class="keyword">if</span> (child &amp;&amp; currentlyAnimatingKeys[key]) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">const</span> hasNext = child &amp;&amp; findChildInChildrenByKey(nextChildren, key);</span><br><span class="line">      <span class="keyword">if</span> (showProp) &#123;</span><br><span class="line">        <span class="keyword">const</span> showInNow = child.props[showProp];</span><br><span class="line">        <span class="keyword">if</span> (hasNext) &#123;</span><br><span class="line">          <span class="keyword">const</span> showInNext = findShownChildInChildrenByKey(nextChildren, key, showProp);</span><br><span class="line">          <span class="keyword">if</span> (!showInNext &amp;&amp; showInNow) &#123;</span><br><span class="line">            <span class="keyword">this</span>.keysToLeave.push(key);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (showInNow) &#123;</span><br><span class="line">          <span class="keyword">this</span>.keysToLeave.push(key);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!hasNext) &#123;</span><br><span class="line">        <span class="keyword">this</span>.keysToLeave.push(key);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * componentDidUpdate 生命周期执行子元素的 enter, leave 动效</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  componentDidUpdate() &#123;</span><br><span class="line">    <span class="keyword">const</span> keysToEnter = <span class="keyword">this</span>.keysToEnter;</span><br><span class="line">    <span class="keyword">this</span>.keysToEnter = [];</span><br><span class="line">    keysToEnter.forEach(<span class="keyword">this</span>.performEnter);</span><br><span class="line">    <span class="keyword">const</span> keysToLeave = <span class="keyword">this</span>.keysToLeave;</span><br><span class="line">    <span class="keyword">this</span>.keysToLeave = [];</span><br><span class="line">    keysToLeave.forEach(<span class="keyword">this</span>.performLeave);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 实际调用 AnimateChild 组件的 componentWillEnter 方法执行动效</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  performEnter = <span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// may already remove by exclusive</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.childrenRefs[key]) &#123;</span><br><span class="line">      <span class="keyword">this</span>.currentlyAnimatingKeys[key] = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">this</span>.childrenRefs[key].componentWillEnter(</span><br><span class="line">        <span class="keyword">this</span>.handleDoneAdding.bind(<span class="keyword">this</span>, key, <span class="string">'enter'</span>)</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  performAppear = <span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.childrenRefs[key]) &#123;</span><br><span class="line">      <span class="keyword">this</span>.currentlyAnimatingKeys[key] = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">this</span>.childrenRefs[key].componentWillAppear(</span><br><span class="line">        <span class="keyword">this</span>.handleDoneAdding.bind(<span class="keyword">this</span>, key, <span class="string">'appear'</span>)</span><br><span class="line">      );</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * enter, appear 动效执行完成后的回调</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  handleDoneAdding = <span class="function">(<span class="params">key, type</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">delete</span> <span class="keyword">this</span>.currentlyAnimatingKeys[key];</span><br><span class="line">    <span class="comment">// if update on exclusive mode, skip check</span></span><br><span class="line">    <span class="keyword">if</span> (props.exclusive &amp;&amp; props !== <span class="keyword">this</span>.nextProps) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> currentChildren = toArrayChildren(getChildrenFromProps(props));</span><br><span class="line">    <span class="keyword">if</span> (!<span class="keyword">this</span>.isValidChildByKey(currentChildren, key)) &#123;</span><br><span class="line">      <span class="comment">// exclusive will not need this</span></span><br><span class="line">      <span class="keyword">this</span>.performLeave(key);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (type === <span class="string">'appear'</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (animUtil.allowAppearCallback(props)) &#123;</span><br><span class="line">        props.onAppear(key);</span><br><span class="line">        props.onEnd(key, <span class="literal">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (animUtil.allowEnterCallback(props)) &#123;</span><br><span class="line">      props.onEnter(key);</span><br><span class="line">      props.onEnd(key, <span class="literal">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  performLeave = <span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// may already remove by exclusive</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.childrenRefs[key]) &#123;</span><br><span class="line">      <span class="keyword">this</span>.currentlyAnimatingKeys[key] = <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">this</span>.childrenRefs[key].componentWillLeave(<span class="keyword">this</span>.handleDoneLeaving.bind(<span class="keyword">this</span>, key));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  handleDoneLeaving = <span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">delete</span> <span class="keyword">this</span>.currentlyAnimatingKeys[key];</span><br><span class="line">    <span class="comment">// if update on exclusive mode, skip check</span></span><br><span class="line">    <span class="keyword">if</span> (props.exclusive &amp;&amp; props !== <span class="keyword">this</span>.nextProps) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> currentChildren = toArrayChildren(getChildrenFromProps(props));</span><br><span class="line">    <span class="comment">// in case state change is too fast</span></span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.isValidChildByKey(currentChildren, key)) &#123;</span><br><span class="line">      <span class="keyword">this</span>.performEnter(key);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> end = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (animUtil.allowLeaveCallback(props)) &#123;</span><br><span class="line">          props.onLeave(key);</span><br><span class="line">          props.onEnd(key, <span class="literal">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;;</span><br><span class="line">      <span class="keyword">if</span> (!isSameChildren(<span class="keyword">this</span>.state.children,</span><br><span class="line">        currentChildren, props.showProp)) &#123;</span><br><span class="line">        <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">          children: currentChildren,</span><br><span class="line">        &#125;, end);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        end();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">this</span>.nextProps = props;</span><br><span class="line">    <span class="keyword">const</span> stateChildren = <span class="keyword">this</span>.state.children;</span><br><span class="line">    <span class="keyword">let</span> children = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (stateChildren) &#123;</span><br><span class="line">      children = stateChildren.map(<span class="function">(<span class="params">child</span>) =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (child === <span class="literal">null</span> || child === <span class="literal">undefined</span>) &#123;</span><br><span class="line">          <span class="keyword">return</span> child;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!child.key) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="built_in">Error</span>(<span class="string">'must set key for &lt;rc-animate&gt; children'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> (</span><br><span class="line">          &lt;AnimateChild</span><br><span class="line">            key=&#123;child.key&#125;</span><br><span class="line">            ref=&#123;node =&gt; &#123; <span class="keyword">this</span>.childrenRefs[child.key] = node &#125;&#125;</span><br><span class="line">            animation=&#123;props.animation&#125;</span><br><span class="line">            transitionName=&#123;props.transitionName&#125;</span><br><span class="line">            transitionEnter=&#123;props.transitionEnter&#125;</span><br><span class="line">            transitionAppear=&#123;props.transitionAppear&#125;</span><br><span class="line">            transitionLeave=&#123;props.transitionLeave&#125;</span><br><span class="line">          &gt;</span><br><span class="line">            &#123;child&#125;</span><br><span class="line">          &lt;<span class="regexp">/AnimateChild&gt;</span></span><br><span class="line"><span class="regexp">        );</span></span><br><span class="line"><span class="regexp">      &#125;);</span></span><br><span class="line"><span class="regexp">    &#125;</span></span><br><span class="line"><span class="regexp">    const Component = props.component;</span></span><br><span class="line"><span class="regexp">    if (Component) &#123;</span></span><br><span class="line"><span class="regexp">      let passedProps = props;</span></span><br><span class="line"><span class="regexp">      if (typeof Component === 'string') &#123;</span></span><br><span class="line"><span class="regexp">        passedProps = &#123;</span></span><br><span class="line"><span class="regexp">          className: props.className,</span></span><br><span class="line"><span class="regexp">          style: props.style,</span></span><br><span class="line"><span class="regexp">          ...props.componentProps,</span></span><br><span class="line"><span class="regexp">        &#125;;</span></span><br><span class="line"><span class="regexp">      &#125;</span></span><br><span class="line"><span class="regexp">      return &lt;Component &#123;...passedProps&#125;&gt;&#123;children&#125;&lt;/</span>Component&gt;;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> children[<span class="number">0</span>] || <span class="literal">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="AnimateChild"><a href="#AnimateChild" class="headerlink" title="AnimateChild"></a>AnimateChild</h3><p>如上文所说，AnimateChild 组件用于实现元素的具体动效。支持的动效包含 css3 动效和 js 动效。其中，css3 动效通过 props.transitionName, props.transitionEnter, props.transitionAppear, props.transitionLeave 属性加以配置；js 动效通过 props.animation 动效方法集 { appear?, enter?, leave? } 加以配置，动效可使用 jQuery 操作节点的方式实现。AnimateChild 组件接受的 props 属性均由用户端通过 Animate 动效调节器注入。在 AnimateChild 组件中，驱动动效的方法直接表现为 transition 实例方法，而 stop 实例方法用于中止动效。</p>
<p>通过源码，我们可以发现，当用户以字符串配置 props.transitionName 属性时，执行 appear 动效的节点将获得的样式类为 <code>${transitionName}-appear</code>, <code>${transitionName}-appear-active</code> 形式。当以对象配置 props.transitionName 属性时，节点获得的样式类前缀 <code>${transitionName}-appear</code> 将被替换为 <code>${transitionName.appear}</code>。props.transitionEnter, props.transitionAppear, props.transitionLeave 属性用于启动或关闭动效。在 css 动效的优先级后，节点将执行 props.animate.appear 动效。以下是动效的实现源码，AnimateChild 组件的 componentWillEnter, componentWillAppear, componentWillLeave 实例方法均基于 transition 方法实现。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">AnimateChild</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 实际执行 css 或 js 动效</span></span><br><span class="line"><span class="comment">   * @param &#123;string&#125; animationType 动效类型，值为 'appear', 'enter', 'leave' 中的一个</span></span><br><span class="line"><span class="comment">   * @param &#123;function&#125; finishCallback 回调函数，在动效完成后执行</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  transition(animationType, finishCallback) &#123;</span><br><span class="line">    <span class="keyword">const</span> node = ReactDOM.findDOMNode(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">const</span> props = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">const</span> transitionName = props.transitionName;</span><br><span class="line">    <span class="keyword">const</span> nameIsObj = <span class="keyword">typeof</span> transitionName === <span class="string">'object'</span>;</span><br><span class="line">    <span class="keyword">this</span>.stop();</span><br><span class="line">    <span class="keyword">const</span> end = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.stopper = <span class="literal">null</span>;</span><br><span class="line">      finishCallback();</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="keyword">if</span> ((isCssAnimationSupported || !props.animation[animationType]) &amp;&amp;</span><br><span class="line">      transitionName &amp;&amp; props[transitionMap[animationType]]) &#123;</span><br><span class="line">      <span class="keyword">const</span> name = nameIsObj ? transitionName[animationType] : <span class="string">`<span class="subst">$&#123;transitionName&#125;</span>-<span class="subst">$&#123;animationType&#125;</span>`</span>;</span><br><span class="line">      <span class="keyword">let</span> activeName = <span class="string">`<span class="subst">$&#123;name&#125;</span>-active`</span>;</span><br><span class="line">      <span class="keyword">if</span> (nameIsObj &amp;&amp; transitionName[<span class="string">`<span class="subst">$&#123;animationType&#125;</span>Active`</span>]) &#123;</span><br><span class="line">        activeName = transitionName[<span class="string">`<span class="subst">$&#123;animationType&#125;</span>Active`</span>];</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.stopper = cssAnimate(node, &#123;</span><br><span class="line">        name,</span><br><span class="line">        active: activeName,</span><br><span class="line">      &#125;, end);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">this</span>.stopper = props.animation[animationType](node, end);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 关闭动效</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  stop() &#123;</span><br><span class="line">    <span class="keyword">const</span> stopper = <span class="keyword">this</span>.stopper;</span><br><span class="line">    <span class="keyword">if</span> (stopper) &#123;</span><br><span class="line">      <span class="keyword">this</span>.stopper = <span class="literal">null</span>;</span><br><span class="line">      stopper.stop();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="css-动效"><a href="#css-动效" class="headerlink" title="css 动效"></a>css 动效</h3><p>rc-animate 库的 css 动效通过 css-animation 库实现，其直接构成 AnimateChild 组件中使用的 cssAnimate 函数。</p>
<p>css-animation 库先行侦测浏览器环境支持的 transition, animate 事件（webkit 等前缀）。若支持这两类事件，直接对节点绑定这两类事件的处理函数；若不支持，使用 setTimeout 构造虚拟事件。以下是 css-animation 库侦测浏览器支持事件的源码实现：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> START_EVENT_NAME_MAP = &#123;</span><br><span class="line">  transitionstart: &#123;</span><br><span class="line">    transition: <span class="string">'transitionstart'</span>,</span><br><span class="line">    WebkitTransition: <span class="string">'webkitTransitionStart'</span>,</span><br><span class="line">    MozTransition: <span class="string">'mozTransitionStart'</span>,</span><br><span class="line">    OTransition: <span class="string">'oTransitionStart'</span>,</span><br><span class="line">    msTransition: <span class="string">'MSTransitionStart'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  animationstart: &#123;</span><br><span class="line">    animation: <span class="string">'animationstart'</span>,</span><br><span class="line">    WebkitAnimation: <span class="string">'webkitAnimationStart'</span>,</span><br><span class="line">    MozAnimation: <span class="string">'mozAnimationStart'</span>,</span><br><span class="line">    OAnimation: <span class="string">'oAnimationStart'</span>,</span><br><span class="line">    msAnimation: <span class="string">'MSAnimationStart'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> END_EVENT_NAME_MAP = &#123;</span><br><span class="line">  transitionend: &#123;</span><br><span class="line">    transition: <span class="string">'transitionend'</span>,</span><br><span class="line">    WebkitTransition: <span class="string">'webkitTransitionEnd'</span>,</span><br><span class="line">    MozTransition: <span class="string">'mozTransitionEnd'</span>,</span><br><span class="line">    OTransition: <span class="string">'oTransitionEnd'</span>,</span><br><span class="line">    msTransition: <span class="string">'MSTransitionEnd'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line"></span><br><span class="line">  animationend: &#123;</span><br><span class="line">    animation: <span class="string">'animationend'</span>,</span><br><span class="line">    WebkitAnimation: <span class="string">'webkitAnimationEnd'</span>,</span><br><span class="line">    MozAnimation: <span class="string">'mozAnimationEnd'</span>,</span><br><span class="line">    OAnimation: <span class="string">'oAnimationEnd'</span>,</span><br><span class="line">    msAnimation: <span class="string">'MSAnimationEnd'</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> startEvents = [];</span><br><span class="line"><span class="keyword">const</span> endEvents = [];</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">detectEvents</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> testEl = <span class="built_in">document</span>.createElement(<span class="string">'div'</span>);</span><br><span class="line">  <span class="keyword">const</span> style = testEl.style;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!(<span class="string">'AnimationEvent'</span> <span class="keyword">in</span> <span class="built_in">window</span>)) &#123;</span><br><span class="line">    <span class="keyword">delete</span> START_EVENT_NAME_MAP.animationstart.animation;</span><br><span class="line">    <span class="keyword">delete</span> END_EVENT_NAME_MAP.animationend.animation;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!(<span class="string">'TransitionEvent'</span> <span class="keyword">in</span> <span class="built_in">window</span>)) &#123;</span><br><span class="line">    <span class="keyword">delete</span> START_EVENT_NAME_MAP.transitionstart.transition;</span><br><span class="line">    <span class="keyword">delete</span> END_EVENT_NAME_MAP.transitionend.transition;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">process</span>(<span class="params">EVENT_NAME_MAP, events</span>) </span>&#123;</span><br><span class="line">    <span class="comment">// 遍历 transition, animate 类目</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> baseEventName <span class="keyword">in</span> EVENT_NAME_MAP) &#123;</span><br><span class="line">      <span class="keyword">if</span> (EVENT_NAME_MAP.hasOwnProperty(baseEventName)) &#123;</span><br><span class="line">        <span class="keyword">const</span> baseEvents = EVENT_NAME_MAP[baseEventName];</span><br><span class="line">        <span class="comment">// 遍历特定浏览器的事件前缀名，将支持的事件存入 startEvents, endEvents 数组中</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">const</span> styleName <span class="keyword">in</span> baseEvents) &#123;</span><br><span class="line">          <span class="keyword">if</span> (styleName <span class="keyword">in</span> style) &#123;</span><br><span class="line">            events.push(baseEvents[styleName]);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  process(START_EVENT_NAME_MAP, startEvents);</span><br><span class="line">  process(END_EVENT_NAME_MAP, endEvents);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">typeof</span> <span class="built_in">window</span> !== <span class="string">'undefined'</span> &amp;&amp; <span class="keyword">typeof</span> <span class="built_in">document</span> !== <span class="string">'undefined'</span>) &#123;</span><br><span class="line">  detectEvents();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>同常见的 css 动效实现，css-animation 库首先为节点添加 transitionName 样式类；30 ms 后又为节点添加 <code>${transitionName}-active</code> 样式类；并在动效执行完成后，通过绑定事件为节点移除前两个样式类；若事件无效，css-animation 将使用定时器移除样式类。以下是这段逻辑的实现代码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> cssAnimation = <span class="function">(<span class="params">node, transitionName, endCallback</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> nameIsObj = <span class="keyword">typeof</span> transitionName === <span class="string">'object'</span>;</span><br><span class="line">  <span class="keyword">const</span> className = nameIsObj ? transitionName.name : transitionName;</span><br><span class="line">  <span class="keyword">const</span> activeClassName = nameIsObj ? transitionName.active : <span class="string">`<span class="subst">$&#123;transitionName&#125;</span>-active`</span>;</span><br><span class="line">  <span class="keyword">let</span> end = endCallback;</span><br><span class="line">  <span class="keyword">let</span> start;</span><br><span class="line">  <span class="keyword">let</span> active;</span><br><span class="line">  <span class="comment">// 函数 classes 由 component-classes 提供，针对多平台处理样式类列表</span></span><br><span class="line">  <span class="keyword">const</span> nodeClasses = classes(node);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (endCallback &amp;&amp; <span class="built_in">Object</span>.prototype.toString.call(endCallback) === <span class="string">'[object Object]'</span>) &#123;</span><br><span class="line">    end = endCallback.end;</span><br><span class="line">    start = endCallback.start;</span><br><span class="line">    active = endCallback.active;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (node.rcEndListener) &#123;</span><br><span class="line">    node.rcEndListener();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 回调中移除样式类</span></span><br><span class="line">  node.rcEndListener = <span class="function">(<span class="params">e</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (e &amp;&amp; e.target !== node) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (node.rcAnimTimeout) &#123;</span><br><span class="line">      clearTimeout(node.rcAnimTimeout);</span><br><span class="line">      node.rcAnimTimeout = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// clearBrowserBugTimeout 函数用于清除 fixBrowserByTimeout 函数设置的定时器</span></span><br><span class="line">    clearBrowserBugTimeout(node);</span><br><span class="line"></span><br><span class="line">    nodeClasses.remove(className);</span><br><span class="line">    nodeClasses.remove(activeClassName);</span><br><span class="line"></span><br><span class="line">    Event.removeEndEventListener(node, node.rcEndListener);</span><br><span class="line">    node.rcEndListener = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (end) &#123;</span><br><span class="line">      end();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  Event.addEndEventListener(node, node.rcEndListener);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (start) &#123;</span><br><span class="line">    start();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 添加样式类，执行动效</span></span><br><span class="line">  nodeClasses.add(className);</span><br><span class="line"></span><br><span class="line">  node.rcAnimTimeout = setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    node.rcAnimTimeout = <span class="literal">null</span>;</span><br><span class="line">    nodeClasses.add(activeClassName);</span><br><span class="line">    <span class="keyword">if</span> (active) &#123;</span><br><span class="line">      setTimeout(active, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// fixBrowserByTimeout 函数使用定时器执行 node.rcEndListener 方法，以清除动效相关的样式类</span></span><br><span class="line">    <span class="comment">// 常态下使用绑定事件清除样式类，fixBrowserByTimeout 用于针对浏览器在绑定事件上的 bug</span></span><br><span class="line">    fixBrowserByTimeout(node);</span><br><span class="line">  &#125;, <span class="number">30</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    stop() &#123;</span><br><span class="line">      <span class="keyword">if</span> (node.rcEndListener) &#123;</span><br><span class="line">        node.rcEndListener();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="CSSMotion"><a href="#CSSMotion" class="headerlink" title="CSSMotion"></a>CSSMotion</h2><p>CSSMotion 组件实现 css 动效的处理逻辑如同上文所说，即在元素显现时添加 <code>${transitionName}-appear</code>, <code>${transitionName}-appear-active</code> 样式类，在动效完成后，再移除这两个样式类；enter, leave 动效同此。在 CSSMotion 组件中，变量 props.transitionName 实际表现为配置项 props.motionName。</p>
<p>在处理样式类变更逻辑上，CSSMotion 组件内部使用 state.status 状态表示动效的类型，state.statusActive 状态表示动效是否在执行阶段，state.newStatus 状态表示是否需要执行新的动效，state.statusStyle 状态表示动效执行期间附加的样式。父子组件交互层面，CSSMotion 组件通过接受 props 属性影响内部子组件的显示动效：初始化 props.visible 和 props.motionAppear 均为真值时执行 appear 动效；当 props.visible 由 false 转为 true 且 props.motionEnter 为真值时执行 enter 动效；当 props.visible 由 true 转为 false 且 props.motionLeave 为真值时执行 leave 动效。state.statusStyle 样式由 props.onAppearStart, props.onEnterStart, props.onLeaveStart, props.onAppearActive, props.onEnterActive, props.onLeaveActive, props.onAppearEnd, props.onEnterEnd, props.onLeaveEnd 监听函数计算获得，顾名思义，这些函数的执行时机分别为动效起始、执行和结束阶段。state.status, state.statusActive, state.statusStyle 最终将影响函数式子组件获得的 props 参数。</p>
<p>CSSMotion 组件的处理流程为：</p>
<ol>
<li>通过 getDerivedStateFromProps 静态方法计算 state.status，划定元素将执行何种动效；同时将 state.newStatus 置为真值，表示元素将执行新的动效；且将 state.statusActive 置为否值，表示动效处于等待执行状态。</li>
<li>componentDidMount, componentDidUpdate 生命周期调用 onDomUpdate 实例方法，为元素绑定动效完成后的回调函数，并启动动效的实际处理逻辑。</li>
<li>动效的实际处理逻辑通过 updateStatus 实例方法启动，以 appear 动效为例，首先调用 props.onAppearStart 方法计算元素的样式，以更新注入子组件的 state.statusStyle，将 state.newStatus 置为否值；其次在回调中调用 updateActiveStatus 实例方法，在下一帧渲染过程调用 props.onAppearActive 方法更新 state.statusStyle 样式，且将 state.statusActive 置为真值，以启动 css 动效；当动效执行完成后，通过绑定函数执行 onMotionEnd 实例方法，即通过 props.onAppearEnd 计算 state.statusStyle 样式，且重置 state.status 状态，以指示子组件动效已执行完成。</li>
<li>componentWillUnmount 生命周期解绑监听函数。</li>
</ol>
<p>以下 CSSMotion 组件的源码：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CSSMotion</span> <span class="keyword">extends</span> <span class="title">React</span>.<span class="title">Component</span> </span>&#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 通过更新 state.status 状态指定子组件需要执行哪种动效</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">static</span> getDerivedStateFromProps(props, &#123; prevProps &#125;) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isSupportTransition(props)) <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">      visible, motionAppear, motionEnter, motionLeave,</span><br><span class="line">      motionLeaveImmediately,</span><br><span class="line">    &#125; = props;</span><br><span class="line">    <span class="keyword">const</span> newState = &#123;</span><br><span class="line">      prevProps: props,</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Appear</span></span><br><span class="line">    <span class="keyword">if</span> (!prevProps &amp;&amp; visible &amp;&amp; motionAppear) &#123;</span><br><span class="line">      newState.status = STATUS_APPEAR;</span><br><span class="line">      newState.statusActive = <span class="literal">false</span>;</span><br><span class="line">      newState.newStatus = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Enter</span></span><br><span class="line">    <span class="keyword">if</span> (prevProps &amp;&amp; !prevProps.visible &amp;&amp; visible &amp;&amp; motionEnter) &#123;</span><br><span class="line">      newState.status = STATUS_ENTER;</span><br><span class="line">      newState.statusActive = <span class="literal">false</span>;</span><br><span class="line">      newState.newStatus = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Leave</span></span><br><span class="line">    <span class="keyword">if</span> (</span><br><span class="line">      (prevProps &amp;&amp; prevProps.visible &amp;&amp; !visible &amp;&amp; motionLeave) ||</span><br><span class="line">      (!prevProps &amp;&amp; motionLeaveImmediately &amp;&amp; !visible &amp;&amp; motionLeave)</span><br><span class="line">    ) &#123;</span><br><span class="line">      newState.status = STATUS_LEAVE;</span><br><span class="line">      newState.statusActive = <span class="literal">false</span>;</span><br><span class="line">      newState.newStatus = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> newState;</span><br><span class="line">  &#125;;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * componentDidMount, componentDidUpdate 生命周期驱动动效的实际处理逻辑</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  onDomUpdate = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; status, newStatus &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">    <span class="keyword">const</span> &#123;</span><br><span class="line">      onAppearStart, onEnterStart, onLeaveStart,</span><br><span class="line">      onAppearActive, onEnterActive, onLeaveActive,</span><br><span class="line">      motionAppear, motionEnter, motionLeave,</span><br><span class="line">    &#125; = <span class="keyword">this</span>.props;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!isSupportTransition(<span class="keyword">this</span>.props)) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 绑定 onMotionEnd 回调函数；动效完成后，执行 onMotionEnd 实例方法</span></span><br><span class="line">    <span class="keyword">const</span> $ele = ReactDOM.findDOMNode(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.$ele !== $ele) &#123;</span><br><span class="line">      <span class="keyword">this</span>.removeEventListener(<span class="keyword">this</span>.$ele);</span><br><span class="line">      <span class="keyword">this</span>.addEventListener($ele);</span><br><span class="line">      <span class="keyword">this</span>.$ele = $ele;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 首次执行 updateStatus 实例方法将通过 props.onAppearStart 计算注入子元素的样式</span></span><br><span class="line">    <span class="comment">// 其次执行 updateActiveStatus 实例方法将 state.statusActive 以启动动效</span></span><br><span class="line">    <span class="keyword">if</span> (newStatus &amp;&amp; status === STATUS_APPEAR &amp;&amp; motionAppear) &#123;</span><br><span class="line">      <span class="keyword">this</span>.updateStatus(onAppearStart, <span class="literal">null</span>, <span class="literal">null</span>, () =&gt; &#123;</span><br><span class="line">        <span class="keyword">this</span>.updateActiveStatus(onAppearActive, STATUS_APPEAR);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newStatus &amp;&amp; status === STATUS_ENTER &amp;&amp; motionEnter) &#123;</span><br><span class="line">      <span class="keyword">this</span>.updateStatus(onEnterStart, <span class="literal">null</span>, <span class="literal">null</span>, () =&gt; &#123;</span><br><span class="line">        <span class="keyword">this</span>.updateActiveStatus(onEnterActive, STATUS_ENTER);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newStatus &amp;&amp; status === STATUS_LEAVE &amp;&amp; motionLeave) &#123;</span><br><span class="line">      <span class="keyword">this</span>.updateStatus(onLeaveStart, <span class="literal">null</span>, <span class="literal">null</span>, () =&gt; &#123;</span><br><span class="line">        <span class="keyword">this</span>.updateActiveStatus(onLeaveActive, STATUS_LEAVE);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 调用 props.onAppearStart 等方法计算注入子元素的样式，并在下一帧渲染时调用 callback</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  updateStatus = <span class="function">(<span class="params">styleFunc, additionalState, event, callback</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> statusStyle = styleFunc ? styleFunc(ReactDOM.findDOMNode(<span class="keyword">this</span>), event) : <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (statusStyle === <span class="literal">false</span> || <span class="keyword">this</span>._destroyed) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">let</span> nextStep;</span><br><span class="line">    <span class="keyword">if</span> (callback) &#123;</span><br><span class="line">      nextStep = <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.nextFrame(callback);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.setState(&#123;</span><br><span class="line">      statusStyle: <span class="keyword">typeof</span> statusStyle === <span class="string">'object'</span> ? statusStyle : <span class="literal">null</span>,</span><br><span class="line">      newStatus: <span class="literal">false</span>,</span><br><span class="line">      ...additionalState,</span><br><span class="line">    &#125;, nextStep); <span class="comment">// Trigger before next frame &amp; after `componentDidMount`</span></span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 将 state.statusActive 置为真值，以启动 css 动效</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  updateActiveStatus = <span class="function">(<span class="params">styleFunc, currentStatus</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// this.nextFrame 使用 raf 库实现下一帧渲染</span></span><br><span class="line">    <span class="keyword">this</span>.nextFrame(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> &#123; status &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">      <span class="keyword">if</span> (status !== currentStatus) <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.updateStatus(styleFunc, &#123; <span class="attr">statusActive</span>: <span class="literal">true</span> &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * 动效执行完成后回调，更新 state.status 以清除注入子元素的样式</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  onMotionEnd = <span class="function">(<span class="params">event</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; status, statusActive &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">    <span class="keyword">const</span> &#123; onAppearEnd, onEnterEnd, onLeaveEnd &#125; = <span class="keyword">this</span>.props;</span><br><span class="line">    <span class="keyword">if</span> (status === STATUS_APPEAR &amp;&amp; statusActive) &#123;</span><br><span class="line">      <span class="keyword">this</span>.updateStatus(onAppearEnd, &#123; <span class="attr">status</span>: STATUS_NONE &#125;, event);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (status === STATUS_ENTER &amp;&amp; statusActive) &#123;</span><br><span class="line">      <span class="keyword">this</span>.updateStatus(onEnterEnd, &#123; <span class="attr">status</span>: STATUS_NONE &#125;, event);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (status === STATUS_LEAVE &amp;&amp; statusActive) &#123;</span><br><span class="line">      <span class="keyword">this</span>.updateStatus(onLeaveEnd, &#123; <span class="attr">status</span>: STATUS_NONE &#125;, event);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  render() &#123;</span><br><span class="line">    <span class="keyword">const</span> &#123; status, statusActive, statusStyle &#125; = <span class="keyword">this</span>.state;</span><br><span class="line">    <span class="keyword">const</span> &#123; children, motionName, visible, removeOnLeave, leavedClassName &#125; = <span class="keyword">this</span>.props;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!children) <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (status === STATUS_NONE || !isSupportTransition(<span class="keyword">this</span>.props)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (visible) &#123;</span><br><span class="line">        <span class="keyword">return</span> children(&#123;&#125;);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!removeOnLeave) &#123;</span><br><span class="line">        <span class="keyword">return</span> children(&#123; <span class="attr">className</span>: leavedClassName &#125;);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 子组件以函数式组价形式接受样式类和样式</span></span><br><span class="line">    <span class="keyword">return</span> children(&#123;</span><br><span class="line">      className: classNames(&#123;</span><br><span class="line">        [getTransitionName(motionName, status)]: status !== STATUS_NONE,</span><br><span class="line">        [getTransitionName(motionName, <span class="string">`<span class="subst">$&#123;status&#125;</span>-active`</span>)]: status !== STATUS_NONE &amp;&amp; statusActive,</span><br><span class="line">        [motionName]: <span class="keyword">typeof</span> motionName === <span class="string">'string'</span>,</span><br><span class="line">      &#125;),</span><br><span class="line">      style: statusStyle,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/analyst/" rel="tag"># analyst</a>
          
            <a href="/tags/react/" rel="tag"># react</a>
          
            <a href="/tags/antd/" rel="tag"># antd</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/12/10/antd/Menu/" rel="next" title="Menu">
                <i class="fa fa-chevron-left"></i> Menu
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/01/08/antd/react-component/rc-utils/" rel="prev" title="rc-utils">
                rc-utils <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpeg" alt="Alfred">
            
              <p class="site-author-name" itemprop="name">Alfred</p>
              <p class="site-description motion-element" itemprop="description">人苦不知足，既得陇，复望蜀</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">89</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    <span class="site-state-item-count">30</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    <span class="site-state-item-count">26</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Alfred-sg" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/xiu-fan-79/activities" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-globe"></i>知乎</a>
                  </span>
                
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#Animate"><span class="nav-number">1.</span> <span class="nav-text">Animate</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Animate-1"><span class="nav-number">1.1.</span> <span class="nav-text">Animate</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AnimateChild"><span class="nav-number">1.2.</span> <span class="nav-text">AnimateChild</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#css-动效"><span class="nav-number">1.3.</span> <span class="nav-text">css 动效</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#CSSMotion"><span class="nav-number">2.</span> <span class="nav-text">CSSMotion</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Alfred</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Pisces</a> v6.0.2</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.0.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.0.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.0.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.2"></script>



  

  
    <script id="dsq-count-scr" src="https://alfred.disqus.com/count.js" async></script>
  

  
    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = 'http://yoursite.com/2019/01/01/antd/react-component/rc-animate/';
        this.page.identifier = '2019/01/01/antd/react-component/rc-animate/';
        this.page.title = 'rc-animate';
      };
      function loadComments () {
        var d = document, s = d.createElement('script');
        s.src = 'https://alfred.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      }
      
        loadComments();
      
    </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  





	





  












  





  

  

  

  

  
  

  

  

  

  

</body>
</html>
