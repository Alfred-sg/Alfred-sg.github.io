<!DOCTYPE html>



  


<html class="theme-next pisces use-motion" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <!-- hexo-inject:begin --><!-- hexo-inject:end --><meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta name="theme-color" content="#222">












<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">






















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.0.2" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=6.0.2">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.0.2">


  <link rel="mask-icon" href="/images/logo.svg?v=6.0.2" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.0.2',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  
  <meta name="keywords" content="analyst,">


<meta name="description" content="这篇文章仅整理蚂蚁金服的 umi-hooks、hox 的大致实现原理，以说明 react-hooks 的探索空间和实践场景。循着蚂蚁金服体验技术部的足迹，自觉很能开拓眼界和思路。 umi-hooksuseAsyncuseAsync 用于处理异步请求，它支持的功能点包含暂停、撤销、重启、轮询。 在实现上，umi-hooks 首先构造 Timer 类以定时器方式执行指定函数，timer.stop、ti">
<meta name="keywords" content="analyst">
<meta property="og:type" content="article">
<meta property="og:title" content="umi-hooks、hox">
<meta property="og:url" content="http://yoursite.com/2019/11/02/react/react相关/umi-hooks、hox/index.html">
<meta property="og:site_name" content="修子范语">
<meta property="og:description" content="这篇文章仅整理蚂蚁金服的 umi-hooks、hox 的大致实现原理，以说明 react-hooks 的探索空间和实践场景。循着蚂蚁金服体验技术部的足迹，自觉很能开拓眼界和思路。 umi-hooksuseAsyncuseAsync 用于处理异步请求，它支持的功能点包含暂停、撤销、重启、轮询。 在实现上，umi-hooks 首先构造 Timer 类以定时器方式执行指定函数，timer.stop、ti">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="http://yoursite.com/2019/11/02/react/react相关/umi-hooks、hox/hox.png">
<meta property="og:updated_time" content="2019-11-02T15:17:00.018Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="umi-hooks、hox">
<meta name="twitter:description" content="这篇文章仅整理蚂蚁金服的 umi-hooks、hox 的大致实现原理，以说明 react-hooks 的探索空间和实践场景。循着蚂蚁金服体验技术部的足迹，自觉很能开拓眼界和思路。 umi-hooksuseAsyncuseAsync 用于处理异步请求，它支持的功能点包含暂停、撤销、重启、轮询。 在实现上，umi-hooks 首先构造 Timer 类以定时器方式执行指定函数，timer.stop、ti">
<meta name="twitter:image" content="http://yoursite.com/2019/11/02/react/react相关/umi-hooks、hox/hox.png">






  <link rel="canonical" href="http://yoursite.com/2019/11/02/react/react相关/umi-hooks、hox/">


  <title>umi-hooks、hox | 修子范语</title>
  









  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript><!-- hexo-inject:begin --><!-- hexo-inject:end -->

</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">

  
  
    
  

  <!-- hexo-inject:begin --><!-- hexo-inject:end --><div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"> <div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">修子范语</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Alfredo's Notes</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签</a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类</a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            <i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档</a>
        </li>
      

      
    </ul>
  

  
</nav>


  



 </div>
    </header>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2019/11/02/react/react相关/umi-hooks、hox/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="Alfred">
      <meta itemprop="description" content>
      <meta itemprop="image" content="/images/avatar.jpeg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="修子范语">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">umi-hooks、hox</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2019-11-02T00:00:00+08:00">2019-11-02</time>
            

            
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing"><a href="/categories/react/" itemprop="url" rel="index"><span itemprop="name">react</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2019/11/02/react/react相关/umi-hooks、hox/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count" data-disqus-identifier="2019/11/02/react/react相关/umi-hooks、hox/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>这篇文章仅整理蚂蚁金服的 umi-hooks、hox 的大致实现原理，以说明 react-hooks 的探索空间和实践场景。循着蚂蚁金服体验技术部的足迹，自觉很能开拓眼界和思路。</p>
<h2 id="umi-hooks"><a href="#umi-hooks" class="headerlink" title="umi-hooks"></a>umi-hooks</h2><h3 id="useAsync"><a href="#useAsync" class="headerlink" title="useAsync"></a>useAsync</h3><p>useAsync 用于处理异步请求，它支持的功能点包含暂停、撤销、重启、轮询。</p>
<p>在实现上，umi-hooks 首先构造 Timer 类以定时器方式执行指定函数，timer.stop、timer.pause、timer.resume 方法可用于终止、暂停、重启定时器（初次启动也通过 resume 方法执行）。以定时器处理异步请求一方面能便于实现轮询，另一方面也是由于请求库未必都实现撤销功能。因为定时器并不能真正打断异步请求，所以 useAsync 只是不去处理响应，而不是撤销请求。另外，对于已卸载的组件，也不需要处理响应。因此是否处理响应的状态标识通过 useEffect 处理，在组件卸载时使其失效，通过 timer.stop 终止时也使其失效。这个状态标识通过 useRef 构造：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 是否处理响应标识</span></span><br><span class="line"><span class="comment">// 1. 在异步流程前首先将 count.current 赋值给 runCount 变量</span></span><br><span class="line"><span class="comment">// 2. 异步流程后再判断再判断 count.current 与 runCount 是否等值</span></span><br><span class="line"><span class="comment">// 3. 组件卸载、终止、撤销处理时均将 count.current 自增 1</span></span><br><span class="line"><span class="keyword">const</span> count = useRef(<span class="number">0</span>);</span><br><span class="line"><span class="keyword">const</span> init = useRef(<span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  count.current += <span class="number">1</span>;</span><br><span class="line">  init.current = <span class="literal">true</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    count.current += <span class="number">1</span>;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;, _deps);</span><br></pre></td></tr></table></figure>
<p>umi-hooks 在 useAsync 函数内部首先通过 useCallback 实现了 run、stop、pause、resume、start 等基础功能（其中，run 方法只是单纯地调用用户传入的异步请求函数 fn）；其次构造 intervalAsync 作为定时器的回调，实现轮询逻辑；其次实现 reload 方法用于重启请求或轮询，cancel 方法取消；最后使用 useEffect 判断选项，分别启用单次请求或轮询功能。以下仅贴示 intervalAsync 的实现：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> intervalAsync = useCallback(</span><br><span class="line">  <span class="keyword">async</span> (...args: <span class="built_in">any</span>[]) =&gt; &#123;</span><br><span class="line">    <span class="keyword">const</span> runCount = count.current;</span><br><span class="line">    <span class="keyword">let</span> ret: Result | <span class="literal">undefined</span>;</span><br><span class="line">    <span class="keyword">if</span> (!_options.manual || !init.current) &#123;</span><br><span class="line">      ret = <span class="keyword">await</span> run(...(args || []));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (count.current === runCount) &#123;</span><br><span class="line">      <span class="comment">// 只初始化定时器，不开始计时</span></span><br><span class="line">      timer.current = <span class="keyword">new</span> Timer&lt;Result&gt;(</span><br><span class="line">        () =&gt; intervalAsync(...args),</span><br><span class="line">        _options.pollingInterval <span class="keyword">as</span> <span class="built_in">number</span>,</span><br><span class="line">      );</span><br><span class="line">      <span class="comment">// 如果设置了 manual，则默认不开始计时</span></span><br><span class="line">      <span class="keyword">if</span> (init.current &amp;&amp; _options.manual) &#123;</span><br><span class="line">        <span class="comment">// await run(...(args || []));</span></span><br><span class="line">        init.current = <span class="literal">false</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 开始计时</span></span><br><span class="line">        ret = <span class="keyword">await</span> timer.current.resume(...(args || []));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">  &#125;,</span><br><span class="line">  [_options.pollingInterval, _options.manual, run],</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="useAPI"><a href="#useAPI" class="headerlink" title="useAPI"></a>useAPI</h3><p>useAPI 在 useAsync 的基础上，以选项指定了远程请求的 url 等参数、异步调用方法。如果没有指定 opt.method 异步调用方法，也可以使用 configRequest 指定或直接使用 window.fetch 方法。</p>
<h3 id="useEventEmitter"><a href="#useEventEmitter" class="headerlink" title="useEventEmitter"></a>useEventEmitter</h3><p>useEventEmitter 用于组织多个组件间的通信逻辑。在实现上，useEventEmitter 基于事件模型。但是绑定事件随着组件的卸载，需要得到解绑，因此 useEventEmitter 使用 useEffect 处理这一逻辑。以下是其源码：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> EventEmitter&lt;T&gt; &#123;</span><br><span class="line">  <span class="keyword">private</span> subscriptions = <span class="keyword">new</span> Set&lt;Subscription&lt;T&gt;&gt;();</span><br><span class="line"></span><br><span class="line">  emit = <span class="function">(<span class="params">val: T</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> subscription of <span class="keyword">this</span>.subscriptions) &#123;</span><br><span class="line">      subscription(val);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  useSubscription = <span class="function">(<span class="params">callback: Subscription&lt;T&gt;</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> callbackRef = useRef&lt;Subscription&lt;T&gt;&gt;();</span><br><span class="line">    callbackRef.current = callback;</span><br><span class="line">    useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="function"><span class="keyword">function</span> <span class="title">subscription</span>(<span class="params">val: T</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (callbackRef.current) &#123;</span><br><span class="line">          callbackRef.current(val);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.subscriptions.add(subscription);</span><br><span class="line">      <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.subscriptions.delete(subscription);</span><br><span class="line">      &#125;;</span><br><span class="line">    &#125;, []);</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">useEventEmitter</span>&lt;<span class="title">T</span>&gt;(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> ref = useRef&lt;EventEmitter&lt;T&gt;&gt;();</span><br><span class="line">  <span class="keyword">if</span> (!ref.current) &#123;</span><br><span class="line">    ref.current = <span class="keyword">new</span> EventEmitter();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ref.current;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="useUpdateEffect"><a href="#useUpdateEffect" class="headerlink" title="useUpdateEffect"></a>useUpdateEffect</h3><p>useUpdateEffect 效果等同 useEffect，只是执行阶段在 didMount 之后（即更新阶段）。</p>
<h3 id="useLocalStorageState"><a href="#useLocalStorageState" class="headerlink" title="useLocalStorageState"></a>useLocalStorageState</h3><p>useLocalStorageState 用于实时从 localStorage 读写值，又借助 useState 实时更新视图层。</p>
<h3 id="useControllableValue"><a href="#useControllableValue" class="headerlink" title="useControllableValue"></a>useControllableValue</h3><p>useControllableValue 用于处理受控值，它首先通过 props 属性读取初始值和实时值（实时值通过 useUpdateEffect 存入 state 中），随后输出 state、handleSetState 以供视图层使用。在 handleSetState 方法执行期间，useControllableValue 还允许执行 props.onChange 等方法。</p>
<h3 id="useSelections"><a href="#useSelections" class="headerlink" title="useSelections"></a>useSelections</h3><p>useSelections 借助 Set 类以及 useMemo 实现，用于处理选择逻辑。</p>
<h3 id="useDynamicList"><a href="#useDynamicList" class="headerlink" title="useDynamicList"></a>useDynamicList</h3><p>useDynamicList 用于管理列表的增删改查逻辑，除了使用 setState 维护列表元素外，还维护了 key 键列表（用于存储原数组元素在 state 中的新的索引）。</p>
<h3 id="usePagination"><a href="#usePagination" class="headerlink" title="usePagination"></a>usePagination</h3><p>usePagination 在 useAsync 的基础上，用于处理分页逻辑。</p>
<h3 id="useSearch"><a href="#useSearch" class="headerlink" title="useSearch"></a>useSearch</h3><p>useSearch 在 useAsync 的基础上，用于在表单或字段内容改变时，自动或手动发送请求获取相应。这一过程通过定时器防抖（避免频繁请求）。</p>
<h3 id="useLoadMore"><a href="#useLoadMore" class="headerlink" title="useLoadMore"></a>useLoadMore</h3><p>useLoadMore 在 useAsync 的基础上，实现了下拉或点击加载更多的处理逻辑。其 reload 逻辑的实现是，使用 state 记录加载次数 count，当这个 count 变更时，再使用 useEffect 远程获取数据。</p>
<h3 id="useAntdTable"><a href="#useAntdTable" class="headerlink" title="useAntdTable"></a>useAntdTable</h3><p>useAntdTable 用于组织 antd-table 表格的逻辑，支持远程请求、分页、筛选、排序、搜索表单等功能。在实现上，useAntdTable 使用 useReducer 管理状态。当表格页面切换时，为了重新加载之前访问的页面数据，useAntdTable 使用 cacheData 缓存数据。在状态变更后，useAntdTable 借助 useUpdateEffect 重新发起请求。当表单数据改变时，useAntdTable 使用定时器获取表单数据，随后更新 state.count 值，最后通过 useUpdateEffect 重新发起请求。以下是部分方法的实现：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">  <span class="comment">// 如果存在 options.id，在切换页面时缓存页面数据，切回表格页面时重新加载</span></span><br><span class="line">  <span class="keyword">if</span> (id &amp;&amp; cacheData[id]) &#123;</span><br><span class="line">    <span class="keyword">const</span> cache = cacheData[id];</span><br><span class="line">    <span class="comment">/* 修改完 formData 和 searchType 之后，会触发 useUpdateEffect，给当前表单赋值 */</span></span><br><span class="line">    dispatch(&#123;</span><br><span class="line">      <span class="keyword">type</span>: <span class="string">'updateState'</span>,</span><br><span class="line">      payload: &#123;</span><br><span class="line">        current: cache.current,</span><br><span class="line">        pageSize: cache.pageSize,</span><br><span class="line">        searchType: cache.searchType,</span><br><span class="line">        activeFormData: cache.activeFormData,</span><br><span class="line">        formData: cache.formData,</span><br><span class="line">        filters: cache.filters,</span><br><span class="line">        sorter: cache.sorter,</span><br><span class="line">        count: state.count + <span class="number">1</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (form) &#123;</span><br><span class="line">    <span class="comment">/* 如果有 form，需要走 searchSubmit，为了初始化的时候，拿到 initialValue */</span></span><br><span class="line">    searchSubmit();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    refresh();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (id) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      cacheData[id] = stateRef.current;</span><br><span class="line">    &#125;;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="function"><span class="params">()</span> =&gt;</span> &#123;&#125;;</span><br><span class="line">&#125;, []);</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> searchSubmit = useCallback(</span><br><span class="line">  (e?: <span class="built_in">string</span> | React.MouseEvent&lt;HTMLElement&gt; | React.KeyboardEvent&lt;HTMLInputElement&gt;) =&gt; &#123;</span><br><span class="line">    <span class="keyword">if</span> (!form) &#123;</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (e &amp;&amp; (e <span class="keyword">as</span> React.MouseEvent&lt;HTMLElement&gt;).preventDefault) &#123;</span><br><span class="line">      (e <span class="keyword">as</span> React.MouseEvent&lt;HTMLElement&gt;).preventDefault();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    setTimeout(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">      <span class="keyword">const</span> activeFormData = getCurrentFieldsValues();</span><br><span class="line">      dispatch(&#123;</span><br><span class="line">        <span class="keyword">type</span>: <span class="string">'updateState'</span>,</span><br><span class="line">        payload: &#123;</span><br><span class="line">          activeFormData,</span><br><span class="line">          formData: &#123; ...state.formData, ...activeFormData &#125;,</span><br><span class="line">        &#125;,</span><br><span class="line">      &#125;);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// reload 更新 state 中的 current、count</span></span><br><span class="line">      reload();</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;,</span><br><span class="line">  [form, reload],</span><br><span class="line">);</span><br></pre></td></tr></table></figure>
<h3 id="useResponsive"><a href="#useResponsive" class="headerlink" title="useResponsive"></a>useResponsive</h3><p>useResponsive 通过监听 resize 事件，及时更新屏幕尺寸状态（屏幕尺寸分为 xs、sm、md、lg、xl 五种），提供一种绘制响应式视图的能力。</p>
<h3 id="useSize"><a href="#useSize" class="headerlink" title="useSize"></a>useSize</h3><p>useSize 借助 resize-observer-polyfill 库，实时获取 dom 节点的尺寸大小变更。useSize 监听的 dom 节点可以通过首参传入；在不传入首参的情况下，umi-hooks 可以通过 useRef 设置 dom 节点。</p>
<h3 id="useVirtualList"><a href="#useVirtualList" class="headerlink" title="useVirtualList"></a>useVirtualList</h3><p>useVirtualList 用于解决展示海量数据渲染时首屏渲染缓慢和滚动卡顿问题，采用的方式是逐屏滚动。在实现上，useVirtualList 使用滚动容器包裹列表，列表全量展示，通过 onScroll 事件实时设置 scrollTop 设置偏移量。以下是 useVirtualList 的实现：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">&lt;T = <span class="built_in">any</span>&gt;<span class="function">(<span class="params">list: T[], options: OptionType</span>) =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">const</span> [size, containerRef] = useSize&lt;HTMLElement&gt;();</span><br><span class="line">  <span class="comment">// 暂时禁止 cache</span></span><br><span class="line">  <span class="comment">// const distanceCache = useRef&lt;&#123; [key: number]: number &#125;&gt;(&#123;&#125;);</span></span><br><span class="line">  <span class="keyword">const</span> [state, setState] = useState(&#123; start: <span class="number">0</span>, end: <span class="number">10</span> &#125;);</span><br><span class="line">  <span class="keyword">const</span> &#123; itemHeight, overscan = <span class="number">5</span> &#125; = options;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!itemHeight) &#123;</span><br><span class="line">    <span class="built_in">console</span>.warn(<span class="string">'please enter a valid itemHeight'</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取滚动容器能展示的元素数</span></span><br><span class="line">  <span class="keyword">const</span> getViewCapacity = <span class="function">(<span class="params">containerHeight: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> itemHeight === <span class="string">'number'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Math</span>.ceil(containerHeight / itemHeight);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> &#123; start = <span class="number">0</span> &#125; = state;</span><br><span class="line">    <span class="keyword">let</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> capacity = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = start; i &lt; list.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> height = <span class="function">(<span class="params">itemHeight <span class="keyword">as</span> (<span class="params">(<span class="params">index: <span class="built_in">number</span></span>) =&gt; <span class="built_in">number</span></span>)</span>)(<span class="params">i</span>);</span></span><br><span class="line"><span class="function">      <span class="params">sum</span> += <span class="params">height</span>;</span></span><br><span class="line"><span class="function">      <span class="params">if</span> (<span class="params">sum &gt;= containerHeight</span>) &#123;</span></span><br><span class="line"><span class="function">        <span class="params">capacity</span> = <span class="params">i</span>;</span></span><br><span class="line"><span class="function">        <span class="params">break</span>;</span></span><br><span class="line"><span class="function">      &#125;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">    <span class="params">return</span> <span class="params">capacity</span> - <span class="params">start</span>;</span></span><br><span class="line"><span class="function">  &#125;;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // 计算滚动隐藏内容的元素数</span></span><br><span class="line"><span class="function">  <span class="params">const</span> <span class="params">getOffset</span> = (<span class="params">scrollTop: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> itemHeight === <span class="string">'number'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">Math</span>.floor(scrollTop / itemHeight) + <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">let</span> sum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">let</span> offset = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> i = <span class="number">0</span>; i &lt; list.length; i++) &#123;</span><br><span class="line">      <span class="keyword">const</span> height = <span class="function">(<span class="params">itemHeight <span class="keyword">as</span> (<span class="params">(<span class="params">index: <span class="built_in">number</span></span>) =&gt; <span class="built_in">number</span></span>)</span>)(<span class="params">i</span>);</span></span><br><span class="line"><span class="function">      <span class="params">sum</span> += <span class="params">height</span>;</span></span><br><span class="line"><span class="function">      <span class="params">if</span> (<span class="params">sum &gt;= scrollTop</span>) &#123;</span></span><br><span class="line"><span class="function">        <span class="params">offset</span> = <span class="params">i</span>;</span></span><br><span class="line"><span class="function">        <span class="params">break</span>;</span></span><br><span class="line"><span class="function">      &#125;</span></span><br><span class="line"><span class="function">    &#125;</span></span><br><span class="line"><span class="function">    <span class="params">return</span> <span class="params">offset</span> + 1;</span></span><br><span class="line"><span class="function">  &#125;;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function">  // 计算列表的起止元素</span></span><br><span class="line"><span class="function">  <span class="params">const</span> <span class="params">calculateRange</span> = <span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> element = containerRef.current;</span><br><span class="line">    <span class="keyword">if</span> (element) &#123;</span><br><span class="line">      <span class="keyword">const</span> offset = getOffset(element.scrollTop);</span><br><span class="line">      <span class="keyword">const</span> viewCapacity = getViewCapacity(element.clientHeight);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">const</span> <span class="keyword">from</span> = offset - overscan;</span><br><span class="line">      <span class="keyword">const</span> to = offset + viewCapacity + overscan;</span><br><span class="line">      setState(&#123; start: <span class="keyword">from</span> &lt; <span class="number">0</span> ? <span class="number">0</span> : <span class="keyword">from</span>, end: to &gt; list.length ? list.length : to &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 在滚动容器变更时，重新计算列表的起止元素</span></span><br><span class="line">  useEffect(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    calculateRange();</span><br><span class="line">  &#125;, [size.width, size.height]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 计算列表总高度</span></span><br><span class="line">  <span class="keyword">const</span> totalHeight = useMemo(<span class="function"><span class="params">()</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> itemHeight === <span class="string">'number'</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> list.length * itemHeight;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> list.reduce(<span class="function">(<span class="params">sum, _, index</span>) =&gt;</span> sum + itemHeight(index), <span class="number">0</span>);</span><br><span class="line">  &#125;, [list.length]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 获取 index 元素与顶部的距离</span></span><br><span class="line">  <span class="keyword">const</span> getDistanceTop = <span class="function">(<span class="params">index: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> itemHeight === <span class="string">'number'</span>) &#123;</span><br><span class="line">      <span class="keyword">const</span> height = index * itemHeight;</span><br><span class="line">      <span class="keyword">return</span> height;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">const</span> height = list.slice(<span class="number">0</span>, index).reduce(<span class="function">(<span class="params">sum, _, i</span>) =&gt;</span> sum + itemHeight(i), <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> height;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">const</span> scrollTo = <span class="function">(<span class="params">index: <span class="built_in">number</span></span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (containerRef.current) &#123;</span><br><span class="line">      containerRef.current.scrollTop = getDistanceTop(index);</span><br><span class="line">      calculateRange();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> &#123;</span><br><span class="line">    <span class="comment">// 通过 state 待展示的元素</span></span><br><span class="line">    list: list.slice(state.start, state.end).map(<span class="function">(<span class="params">ele, index</span>) =&gt;</span> (&#123;</span><br><span class="line">      data: ele,</span><br><span class="line">      index: index + state.start,</span><br><span class="line">    &#125;)),</span><br><span class="line">    scrollTo,</span><br><span class="line">    containerProps: &#123;</span><br><span class="line">      ref: <span class="function">(<span class="params">ele: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">        containerRef.current = ele;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="comment">// 通过滚动事件重新设置偏移量</span></span><br><span class="line">      onScroll: <span class="function">(<span class="params">e: <span class="built_in">any</span></span>) =&gt;</span> &#123;</span><br><span class="line">        e.preventDefault();</span><br><span class="line">        calculateRange();</span><br><span class="line">      &#125;,</span><br><span class="line">      style: &#123; overflowY: <span class="string">'auto'</span> &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">    wrapperProps: &#123;</span><br><span class="line">      style: &#123; width: <span class="string">'100%'</span>, height: totalHeight, paddingTop: getDistanceTop(state.start) &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<h2 id="hox"><a href="#hox" class="headerlink" title="hox"></a>hox</h2><p>hox 号称“下一代状态管理器”，因此它的意图还是在于使用 hooks 抽象 ViewModel 层，将 hooks 的使用过程从与视图组件的强关联中解放出来，同时支持在类组件中也能使用 hooks。那么，它是怎么做到的呢？它的代码逻辑很简单，即使用 Exector 虚拟组件来运作 hooks 逻辑，hooks 返回值通过绑定事件的方式通知到 Exector 虚拟组件外层，然后使用 setState 接值，传入实际渲染的视图组件中。</p>
<img src="/2019/11/02/react/react相关/umi-hooks、hox/hox.png">
<p>以下是其实现逻辑：</p>
<figure class="highlight typescript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">createModel</span>&lt;<span class="title">T</span>&gt;(<span class="params">hook: ModelHook&lt;T&gt;</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> element = <span class="built_in">document</span>.createElement(<span class="string">"div"</span>);</span><br><span class="line">  <span class="comment">// Container 提供事件绑定、触发的机制</span></span><br><span class="line">  <span class="keyword">const</span> container = <span class="keyword">new</span> Container(hook);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 通过虚拟组件承载 hooks 执行逻辑，每次重绘时执行 hooks 并 onUpdate 钩子</span></span><br><span class="line">  ReactDOM.render(</span><br><span class="line">    &lt;Executor</span><br><span class="line">      onUpdate=&#123;<span class="function"><span class="params">val</span> =&gt;</span> &#123;</span><br><span class="line">        container.data = val;</span><br><span class="line">        container.notify();</span><br><span class="line">      &#125;&#125;</span><br><span class="line">      hook=&#123;hook&#125;</span><br><span class="line">    /&gt;,</span><br><span class="line">    element</span><br><span class="line">  );</span><br><span class="line">  <span class="keyword">const</span> useModel: UseModel&lt;T&gt; = <span class="function"><span class="params">depsFn</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> [state, setState] = useState&lt;T | <span class="literal">undefined</span>&gt;<span class="function">(<span class="params">(<span class="params"></span>) =&gt;</span></span></span><br><span class="line"><span class="function"><span class="params">      container ? (<span class="params">container.data <span class="keyword">as</span> T</span>) : <span class="literal">undefined</span></span></span></span><br><span class="line"><span class="function"><span class="params">    </span>);</span></span><br><span class="line"><span class="function">    <span class="params">const</span> <span class="params">depsFnRef</span> = <span class="params">useRef</span>(<span class="params">depsFn</span>);</span></span><br><span class="line"><span class="function">    <span class="params">depsFnRef</span>.<span class="params">current</span> = <span class="params">depsFn</span>;</span></span><br><span class="line"><span class="function">    <span class="params">const</span> <span class="params">depsRef</span> = <span class="params">useRef</span>&lt;<span class="params">unknown</span>[]&gt;(<span class="params">[]</span>);</span></span><br><span class="line"><span class="function">    <span class="params">useEffect</span>(<span class="params">(<span class="params"></span>) =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">if</span> (<span class="params">!container</span>) <span class="keyword">return</span>;</span></span></span><br><span class="line"><span class="function"><span class="params"></span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="comment">// 作为绑定函数，承接 hooks 返回值，并使用 useState 机制传给实际的视图组件</span></span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">function</span> subscriber(<span class="params">val: T</span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">        <span class="keyword">if</span> (<span class="params">!depsFnRef.current</span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">          setState(<span class="params">val</span>);</span></span></span><br><span class="line"><span class="function"><span class="params">        &#125; <span class="keyword">else</span> &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">const</span> oldDeps = depsRef.current;</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">const</span> newDeps = depsFnRef.current(<span class="params">val</span>);</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">if</span> (<span class="params">compare(<span class="params">oldDeps, newDeps</span>)</span>) &#123;<span class="comment">// 比较依赖</span></span></span></span><br><span class="line"><span class="function"><span class="params">            setState(<span class="params">val</span>);</span></span></span><br><span class="line"><span class="function"><span class="params">          &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">          depsRef.current = newDeps;</span></span></span><br><span class="line"><span class="function"><span class="params">        &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">      &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">      container.subscribers.add(<span class="params">subscriber</span>);</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">return</span> (<span class="params"></span>) =&gt; &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">        container.subscribers.<span class="keyword">delete</span>(<span class="params">subscriber</span>);</span></span></span><br><span class="line"><span class="function"><span class="params">      &#125;;</span></span></span><br><span class="line"><span class="function"><span class="params">    &#125;, [container]</span>);</span></span><br><span class="line"><span class="function">    <span class="params">return</span> <span class="params">state</span>!;</span></span><br><span class="line"><span class="function">  &#125;;</span></span><br><span class="line"><span class="function">  <span class="params">Object</span>.<span class="params">defineProperty</span>(<span class="params">useModel, "data", &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">    <span class="keyword">get</span>: <span class="keyword">function</span>(<span class="params"></span>) &#123;</span></span></span><br><span class="line"><span class="function"><span class="params">      <span class="keyword">return</span> container.data;</span></span></span><br><span class="line"><span class="function"><span class="params">    &#125;</span></span></span><br><span class="line"><span class="function"><span class="params">  &#125;</span>);</span></span><br><span class="line"><span class="function">  <span class="params">return</span> <span class="params">useModel</span>;</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<p>当一个视图组件需要多个 model 时，hox 像 redux 一样提供了 withModel 方法用于将多个 model 内容传输给类组件的 props。</p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/analyst/" rel="tag"># analyst</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2019/10/29/frontend/hybird app/" rel="next" title="hybird app">
                <i class="fa fa-chevron-left"></i> hybird app
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2019/11/03/frontend/前端埋点/" rel="prev" title="前端埋点">
                前端埋点 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          

  
    <div class="comments" id="comments">
      <div id="disqus_thread">
        <noscript>
          Please enable JavaScript to view the
          <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a>
        </noscript>
      </div>
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/avatar.jpeg" alt="Alfred">
            
              <p class="site-author-name" itemprop="name">Alfred</p>
              <p class="site-description motion-element" itemprop="description">人苦不知足，既得陇，复望蜀</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">106</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    <span class="site-state-item-count">35</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    <span class="site-state-item-count">26</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/Alfred-sg" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="https://www.zhihu.com/people/xiu-fan-79/activities" target="_blank" title="知乎">
                      
                        <i class="fa fa-fw fa-globe"></i>知乎</a>
                  </span>
                
            </div>
          

          
          

          
          

          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#umi-hooks"><span class="nav-number">1.</span> <span class="nav-text">umi-hooks</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#useAsync"><span class="nav-number">1.1.</span> <span class="nav-text">useAsync</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#useAPI"><span class="nav-number">1.2.</span> <span class="nav-text">useAPI</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#useEventEmitter"><span class="nav-number">1.3.</span> <span class="nav-text">useEventEmitter</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#useUpdateEffect"><span class="nav-number">1.4.</span> <span class="nav-text">useUpdateEffect</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#useLocalStorageState"><span class="nav-number">1.5.</span> <span class="nav-text">useLocalStorageState</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#useControllableValue"><span class="nav-number">1.6.</span> <span class="nav-text">useControllableValue</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#useSelections"><span class="nav-number">1.7.</span> <span class="nav-text">useSelections</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#useDynamicList"><span class="nav-number">1.8.</span> <span class="nav-text">useDynamicList</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#usePagination"><span class="nav-number">1.9.</span> <span class="nav-text">usePagination</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#useSearch"><span class="nav-number">1.10.</span> <span class="nav-text">useSearch</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#useLoadMore"><span class="nav-number">1.11.</span> <span class="nav-text">useLoadMore</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#useAntdTable"><span class="nav-number">1.12.</span> <span class="nav-text">useAntdTable</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#useResponsive"><span class="nav-number">1.13.</span> <span class="nav-text">useResponsive</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#useSize"><span class="nav-number">1.14.</span> <span class="nav-text">useSize</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#useVirtualList"><span class="nav-number">1.15.</span> <span class="nav-text">useVirtualList</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#hox"><span class="nav-number">2.</span> <span class="nav-text">hox</span></a></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 &mdash; <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Alfred</span>

  

  
</div>




  <div class="powered-by">由 <a class="theme-link" target="_blank" href="https://hexo.io">Hexo</a> 强力驱动</div>



  <span class="post-meta-divider">|</span>



  <div class="theme-info">主题 &mdash; <a class="theme-link" target="_blank" href="https://github.com/theme-next/hexo-theme-next">NexT.Pisces</a> v6.0.2</div>




        







        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>


























  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.0.2"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.0.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.0.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.0.2"></script>



  

  
    <script id="dsq-count-scr" src="https://alfred.disqus.com/count.js" async></script>
  

  
    <script type="text/javascript">
      var disqus_config = function () {
        this.page.url = 'http://yoursite.com/2019/11/02/react/react相关/umi-hooks、hox/';
        this.page.identifier = '2019/11/02/react/react相关/umi-hooks、hox/';
        this.page.title = 'umi-hooks、hox';
      };
      function loadComments () {
        var d = document, s = d.createElement('script');
        s.src = 'https://alfred.disqus.com/embed.js';
        s.setAttribute('data-timestamp', '' + +new Date());
        (d.head || d.body).appendChild(s);
      }
      
        loadComments();
      
    </script><!-- hexo-inject:begin --><!-- hexo-inject:end -->
  





	





  












  





  

  

  

  

  
  

  

  

  

  

</body>
</html>
